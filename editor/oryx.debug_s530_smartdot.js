ORYX.Utils={getParamFromUrl:function(b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return null;}else{return c[1];}},rgbToHsl:function(a,k,n){a/=255;k/=255;n/=255;var o=Math.max(a,k,n),e=Math.min(a,k,n);var f,p,c=(o+e)/2;if(o==e){f=p=0;}else{var m=o-e;p=c>0.5?m/(2-o-e):m/(o+e);switch(o){case a:f=(k-n)/m+(k<n?6:0);break;case k:f=(n-a)/m+2;break;case n:f=(a-k)/m+4;break;}f/=6;}return[f,p,c];},hslToRgb:function(k,o,f){var a,m,n;if(o==0){a=m=n=f;}else{function e(h,g,b){if(b<0){b+=1;}if(b>1){b-=1;}if(b<1/6){return h+(g-h)*6*b;}if(b<1/2){return g;}if(b<2/3){return h+(g-h)*(2/3-b)*6;}return h;}var c=f<0.5?f*(1+o):f+o-f*o;var d=2*f-c;a=e(d,c,k+1/3);m=e(d,c,k);n=e(d,c,k-1/3);}return[Math.round(a*255),Math.round(m*255),Math.round(n*255)];},adjustLightness:function(d,k){if(!d){return"";}else{if(k===1){return d;}else{if(k===0){return"#ffffff";}}}d=d.length===7&&d[0]==="#"?d:"#ffffff";var a=Math.min(255,parseInt(d[1]+d[2],16));var e=Math.min(255,parseInt(d[3]+d[4],16));var h=Math.min(255,parseInt(d[5]+d[6],16));var l=ORYX.Utils.rgbToHsl(a,e,h);var c=l[2];l[2]=0.15*Math.tan(2.4*l[2]+1.8)+0.8;var f=ORYX.Utils.hslToRgb(l[0],l[1],(l[2]>1?c:l[2]));var m=[parseInt(Math.min(255,f[0])),parseInt(Math.min(255,f[1])),parseInt(Math.min(255,f[2]))].map(function(b){return(b<16?"0":"")+b.toString(16);});return"#"+m.join("");},adjustGradient:function(l,d){if(!l){return;}var c=d.getAttributeNS(null,"stop-color")||"#ffffff";c=c.length===7&&c[0]==="#"?c:"#ffffff";var a=Math.min(255,parseInt(c[1]+c[2],16));var f=Math.min(255,parseInt(c[3]+c[4],16));var k=Math.min(255,parseInt(c[5]+c[6],16));var e=ORYX.Utils.rgbToHsl(a,f,k);e[2]=Math.min(e[2]+(0.9*e[2])+(e[2]<=0.2?(2-e[2])*0.2:0),1);var h=ORYX.Utils.hslToRgb(e[0],e[1],e[2]);var m=function(g){var b=[Math.min(255,h[0]),Math.min(255,h[1]),Math.min(255,h[2])].map(function(n){return(n<16?"0":"")+n.toString(16);});return"#"+b.join("");};$A(l.getElementsByTagName("stop")).each(function(b,g){if(g==b||(g.getAttributeNS(null,"class")||"").include("ignore-adjust")){return;}g.setAttributeNS(null,"stop-color",m("#FFFFFF"));}.bind(this,d));},isGlossaryEntry:function(a){return typeof a==="string"&&(this.isOldGlossarySchema(a)||a.startsWith("/glossary/"));},isOldGlossarySchema:function(a){return typeof a==="string"&&!!a.match(/\glossary\:\/\/.+\/[\w\W]+\;\;/g);},getGlossaryId:function(a){if(ORYX.Utils.isOldGlossarySchema(a)){return(a||"").split(";;").invoke("replace",/\glossary\:\/\//g,"").invoke("replace",/\/[\w\W]+/g,"").first();}return"";},glossaryTitle:function(a){if(ORYX.Utils.isOldGlossarySchema(a)){return(a||"").replace(/;;$/,"").replace(/\glossary\:\/\/.+?\//g,"");}return"";},getInGlossarySchema:function(b,a){b=(b||"").replace(/([\/]|glossary)/g,"");return"glossary://"+b+"/"+a+";;";},isIPad:function(){return !!Ext.isIPad;},getBrowserVersion:function(){return(Ext.getBrowserVersion()||0).toFixed(1);},isMetaKey:function(a){return !!(a.shiftKey||a.ctrlKey||a.metaKey);},buildGetColorForLabel:function(a){return ORYX.Utils.createGenericPropertyCheck(a,"color","value","");},buildIsRichtextForLabel:function(a){return ORYX.Utils.createGenericPropertyCheck(a,"string","richtextEnabled",false);},createGenericPropertyCheck:function(e,d,c,a){var b=e.properties().select(function(f){return f.type().toLowerCase()===d.toLowerCase();});if(b.length===0){return function(){return a;};}return function(f){var h=f.id;var g=b.find(function(k){return k.refToView().find(function(l){return h.endsWith(l);});});if(g&&g[c] instanceof Function){return g[c]();}return a;};}};XMLNS={ATOM:"http://www.w3.org/2005/Atom",XHTML:"http://www.w3.org/1999/xhtml",ERDF:"http://purl.org/NET/erdf/profile",RDFS:"http://www.w3.org/2000/01/rdf-schema#",RDF:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",RAZIEL:"http://b3mn.org/Raziel",SCHEMA:""};var Kickstart={started:false,callbacks:[],alreadyLoaded:[],PATH:"",load:function(){Kickstart.kick();},kick:function(){if(!Kickstart.started){Kickstart.started=true;Kickstart.callbacks.each(function(a){window.setTimeout(a,1);});}},register:function(callback){with(Kickstart){if(started){window.setTimeout(callback,1);}else{Kickstart.callbacks.push(callback);}}},require:function(a){if(Kickstart.alreadyLoaded.member(a)){return false;}return Kickstart.include(a);},include:function(a){var b=document.getElementsByTagNameNS(XMLNS.XHTML,"head")[0];var c=document.createElementNS(XMLNS.XHTML,"script");c.setAttributeNS(XMLNS.XHTML,"type","text/javascript");c.src=Kickstart.PATH+a;b.appendChild(c);Kickstart.alreadyLoaded.push(a);return true;}};Event.observe(window,"load",Kickstart.load);var ERDF={LITERAL:1,RESOURCE:2,DELIMITERS:[".","-"],HASH:"#",HYPHEN:"-",schemas:[],callback:undefined,log:undefined,init:function(a){ERDF.callback=a;ERDF.registerSchema("schema",XMLNS.SCHEMA);ERDF.registerSchema("rdfs",XMLNS.RDFS);},run:function(){return ERDF._checkProfile()&&ERDF.parse();},parse:function(){ERDF.__startTime=new Date();var b=document.getElementsByTagNameNS(XMLNS.XHTML,"body");var c={type:ERDF.RESOURCE,value:""};var a=ERDF._parseDocumentMetadata()&&ERDF._parseFromTag(b[0],c);ERDF.__stopTime=new Date();var d=(ERDF.__stopTime-ERDF.__startTime)/1000;return a;},_parseDocumentMetadata:function(){var b=document.getElementsByTagNameNS(XMLNS.XHTML,"head");var a=b[0].getElementsByTagNameNS(XMLNS.XHTML,"link");var c=b[0].getElementsByTagNameNS(XMLNS.XHTML,"meta");$A(a).each(function(e){var d=e.getAttribute("rel");var g=e.getAttribute("rev");var f=e.getAttribute("href");ERDF._parseTriplesFrom(ERDF.RESOURCE,"",d,ERDF.RESOURCE,f);ERDF._parseTriplesFrom(ERDF.RESOURCE,f,g,ERDF.RESOURCE,"");});$A(c).each(function(f){var e=f.getAttribute("name");var d=f.getAttribute("content");ERDF._parseTriplesFrom(ERDF.RESOURCE,"",e,ERDF.LITERAL,d);});return true;},_parseFromTag:function(c,k,d){if(c.namespaceURI!=XMLNS.XHTML){return;}if(!d){d=0;}var a=c.getAttribute("id");if(c.nodeName.endsWith(":a")||c.nodeName=="a"){var h=c.getAttribute("rel");var e=c.getAttribute("rev");var n=c.getAttribute("href");var m=c.getAttribute("title");var g=c.textContent;ERDF._parseTriplesFrom(k.type,k.value,h,ERDF.RESOURCE,n,function(p){var o=m?m:g;ERDF._parseTriplesFrom(p.object.type,p.object.value,"rdfs.label",ERDF.LITERAL,o);});ERDF._parseTriplesFrom(k.type,k.value,e,ERDF.RESOURCE,"");ERDF._parseTypeTriplesFrom(k.type,k.value,h);}else{if(c.nodeName.endsWith(":img")||c.nodeName=="img"){var h=c.getAttribute("class");var n=c.getAttribute("src");var f=c.getAttribute("alt");ERDF._parseTriplesFrom(k.type,k.value,h,ERDF.RESOURCE,n,function(p){var o=f;ERDF._parseTriplesFrom(p.object.type,p.object.value,"rdfs.label",ERDF.LITERAL,o);});}}var h=c.getAttribute("class");var m=c.getAttribute("title");var g=c.textContent;var l=m?m:g;ERDF._parseTriplesFrom(k.type,k.value,h,ERDF.LITERAL,l);if(a){k={type:ERDF.RESOURCE,value:ERDF.HASH+a};}ERDF._parseTypeTriplesFrom(k.type,k.value,h);var b=c.childNodes;if(b){$A(b).each(function(o){if(o.nodeType==o.ELEMENT_NODE){ERDF._parseFromTag(o,k,d+1);}});}},_parseTriplesFrom:function(c,e,d,a,b,f){if(!d){return;}d.toLowerCase().split(" ").each(function(h){var g=ERDF.schemas.find(function(l){return false||ERDF.DELIMITERS.find(function(m){return h.startsWith(l.prefix+m);});});if(g&&b){h=h.substring(g.prefix.length+1,h.length);var k=ERDF.registerTriple(new ERDF.Resource(e),{prefix:g.prefix,name:h},(a==ERDF.RESOURCE)?new ERDF.Resource(b):new ERDF.Literal(b));if(f){f(k);}}});},_parseTypeTriplesFrom:function(a,c,b,d){if(!b){return;}b.toLowerCase().split(" ").each(function(f){var e=ERDF.schemas.find(function(h){return false||ERDF.DELIMITERS.find(function(k){return f.startsWith(ERDF.HYPHEN+h.prefix+k);});});if(e&&c){f=f.substring(e.prefix.length+2,f.length);var g=ERDF.registerTriple((a==ERDF.RESOURCE)?new ERDF.Resource(c):new ERDF.Literal(c),{prefix:"rdf",name:"type"},new ERDF.Resource(e.namespace+f));if(d){d(g);}}});},_checkProfile:function(){var b=document.getElementsByTagNameNS(XMLNS.XHTML,"head");var a=b[0].getAttribute("profile");var c=false;if(a&&a.split(" ").member(XMLNS.ERDF)){return true;}else{return false;}},__stripHashes:function(a){return(a&&a.substring(0,1)=="#")?a.substring(1,a.length):a;},registerSchema:function(b,a){ERDF.schemas.push({prefix:b,namespace:a});},registerTriple:function(c,a,b){if(a.prefix.toLowerCase()=="schema"){this.registerSchema(a.name,b.value);}var d=new ERDF.Triple(c,a,b);ERDF.callback(d);return d;},__enhanceObject:function(){this.isResource=function(){return this.type==ERDF.RESOURCE;};this.isLocal=function(){return this.isResource()&&this.value.startsWith("#");};this.isCurrentDocument=function(){return this.isResource()&&(this.value=="");};this.getId=function(){return this.isLocal()?ERDF.__stripHashes(this.value):false;};this.isLiteral=function(){return this.type==ERDF.LIITERAL;};},serialize:function(a){if(!a){return"";}else{if(a.constructor==String){return a;}else{if(a.constructor==Boolean){return a?"true":"false";}else{return a.toString();}}}}};ERDF.Triple=function(c,a,b){this.subject=c;this.predicate=a;this.object=b;this.toString=function(){return"[ERDF.Triple] "+this.subject.toString()+" "+this.predicate.prefix+":"+this.predicate.name+" "+this.object.toString();};};ERDF.Resource=function(a){this.type=ERDF.RESOURCE;this.value=a;ERDF.__enhanceObject.apply(this);this.toString=function(){return"&lt;"+this.value+"&gt;";};};ERDF.Literal=function(a){this.type=ERDF.LITERAL;this.value=ERDF.serialize(a);ERDF.__enhanceObject.apply(this);this.toString=function(){return'"'+this.value+'"';};};var USE_ASYNCHRONOUS_REQUESTS=true;var DISCARD_UNUSED_TRIPLES=true;var PREFER_SPANS_OVER_DIVS=true;var PREFER_TITLE_OVER_TEXTNODE=false;var RESOURCE_ID_PREFIX="resource";var SHOW_DEBUG_ALERTS_WHEN_SAVING=false;var SHOW_EXTENDED_DEBUG_INFORMATION=false;var USE_ARESS_WORKAROUNDS=true;var RESOURCE_CREATED=1;var RESOURCE_REMOVED=2;var RESOURCE_SAVED=4;var RESOURCE_RELOADED=8;var RESOURCE_SYNCHRONIZED=16;var TRIPLE_REMOVE=1;var TRIPLE_ADD=2;var TRIPLE_RELOAD=4;var TRIPLE_SAVE=8;var PROCESSDATA_REF="processdata";var DataManager={init:function(){ERDF.init(DataManager._registerTriple);DataManager.__synclocal();},_triples:[],_registerTriple:function(a){DataManager._triples.push(a);},__synclocal:function(){DataManager._triples=[];ERDF.run();},__synchronizeShape:function(a){var c=ResourceManager.getResource(a.resourceId);var b=a.serialize();b.each(function(d){var f=(d.type=="resource");var e=new ERDF.Triple(new ERDF.Resource(a.resourceId),{prefix:d.prefix,name:d.name},f?new ERDF.Resource(d.value):new ERDF.Literal(d.value));DataManager.setObject(e);});return c;},__storeShape:function(a){var b=DataManager.__synchronizeShape(a);b.save();},__forceExistance:function(a){if(!$(a.resourceId)){if(!$$("."+PROCESSDATA_REF)[0]){DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,"body").item(0),["div",{"class":PROCESSDATA_REF,"style":"display:none;"}]);}DataManager.graft(XMLNS.XHTML,$$("."+PROCESSDATA_REF)[0],["div",{"id":a.resourceId,"class":(a instanceof ORYX.Core.Canvas)?"-oryx-canvas":undefined}]);}else{var c=$(a.resourceId);var b=$A(c.childNodes);b.each(function(d){c.removeChild(d);});}},__persistShape:function(b){var d=b.serialize();var a=[];var c=new ERDF.Resource(b.resourceId);DataManager.removeTriples(DataManager.query(c,undefined,undefined));d.each(function(f){var e=(f.type=="resource")?new ERDF.Resource(f.value):new ERDF.Literal(f.value);DataManager.addTriple(new ERDF.Triple(c,{prefix:f.prefix,name:f.name},e));});},__persistDOM:function(d){var c=d.getCanvas();var b=c.getChildShapes(true);var a="";b.each(function(e){DataManager.__forceExistance(e);});DataManager.__renderCanvas(d);a+=DataManager.serialize($(ERDF.__stripHashes(d.getCanvas().resourceId)),true);b.each(function(e){DataManager.__persistShape(e);a+=DataManager.serialize($(ERDF.__stripHashes(e.resourceId)),true);});return a;},__renderCanvas:function(e){var b=e.getCanvas();var d=e.getStencilSets();var a=b.getChildShapes(true);DataManager.__forceExistance(b);DataManager.__persistShape(b);var c=new ERDF.Resource(b.resourceId);DataManager.removeTriples(DataManager.query(c,undefined,undefined));DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"mode"},new ERDF.Literal("writable")));DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"mode"},new ERDF.Literal("fullscreen")));d.values().each(function(f){DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"stencilset"},new ERDF.Resource(f.source().replace(/&/g,"%26"))));DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"ssnamespace"},new ERDF.Resource(f.namespace())));f.extensions().keys().each(function(g){DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"ssextension"},new ERDF.Literal(g)));});});a.each(function(f){DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"render"},new ERDF.Resource("#"+f.resourceId)));});},__counter:0,__provideId:function(){while($(RESOURCE_ID_PREFIX+DataManager.__counter)){DataManager.__counter++;}return RESOURCE_ID_PREFIX+DataManager.__counter;},serializeDOM:function(a){return DataManager.__persistDOM(a);},syncGlobal:function(a){return DataManager.__syncglobal(a);},__syncglobal:function(c){var b=c.getCanvas();var a=b.getChildShapes(true);a.select(function(d){return !($(d.resourceId));}).each(function(d){if(USE_ARESS_WORKAROUNDS){var e=d.properties["raziel-type"];var g='<div xmlns="http://www.w3.org/1999/xhtml">'+'<span class="raziel-type">'+e+"</span></div>";var f=ResourceManager.__createResource(g);d.resourceId=f.id();}else{var f=ResourceManager.__createResource();d.resourceId=f.id();}});a.each(function(d){DataManager.__storeShape(d);});},serialize:function(f,b){if(f.nodeType==f.ELEMENT_NODE){var e=$A(f.childNodes);var c=$A(f.attributes);var d=new String(f.getAttribute("class"));var g=d.split(" ").member("transient");if(g){return"";}var a="<"+f.nodeName;if(!b){a+=' xmlns="'+(f.namespaceURI?f.namespaceURI:XMLNS.XHTML)+'" xmlns:oryx="http://oryx-editor.org"';}c.each(function(k){var l=k.nodeName,h=String(k.nodeValue||"");if(Ext.isIE){if(l.toLowerCase()=="preserveaspectratio"){return;}if(l.toLowerCase()=="transform"&&!h.trim()){return;}if(Ext.isIE9&&l.toLowerCase()=="opacity"&&parseFloat(h)===Signavio.CONFIG.IE9_PATH_OPACITY_FIX_VALUE){return;}h=h.replace(/"/g,"'");}a+=" "+l+'="'+h+'"';});if(e.length==0){a+="/>";}else{a+=">";e.each(function(h){a+=DataManager.serialize(h,true);});a+="</"+f.nodeName+">";}return a;}else{if(f.nodeType==f.TEXT_NODE){return String(f.nodeValue).blank()?"":f.nodeValue;}}return"";},addTriple:function(c){if(!c.subject.type==ERDF.LITERAL){throw"Cannot add the triple "+c.toString()+" because the subject is not a resource.";}var a=ERDF.__stripHashes(c.subject.value);var b=$(a);if(!b){throw"Cannot add the triple "+c.toString()+' because the subject "'+a+'" is not in the document.';}if(c.object.type==ERDF.LITERAL){DataManager.graft(XMLNS.XHTML,b,["span",{"class":(c.predicate.prefix+"-"+c.predicate.name)},c.object.value.escapeHTML()]);}else{DataManager.graft(XMLNS.XHTML,b,["a",{"rel":(c.predicate.prefix+"-"+c.predicate.name),"href":c.object.value}]);}return true;},removeTriples:function(b){var a=b.select(function(c){return DataManager.__removeTriple(c);});return a;},removeTriple:function(b){var a=DataManager.__removeTriple(b);return a;},__removeTriple:function(d){if(!d.subject.type==ERDF.LITERAL){throw"Cannot remove the triple "+d.toString()+" because the subject is not a resource.";}var b=ERDF.__stripHashes(d.subject.value);var c=$(b);if(!c){throw"Cannot remove the triple "+d.toString()+" because the subject is not in the document.";}if(d.object.type==ERDF.LITERAL){var a=DataManager.__removeTripleRecursively(d,c);return a;}},__removeTripleRecursively:function(e,d){if(d.nodeType!=d.ELEMENT_NODE){return false;}var b=new String(d.getAttribute("class"));var a=$A(d.childNodes);if(b.include(e.predicate.prefix+"-"+e.predicate.name)){var c=d.textContent;if((e.object.type==ERDF.LITERAL)&&(e.object.value==c)){d.parentNode.removeChild(d);}return true;}else{a.each(function(f){DataManager.__removeTripleRecursively(e,f);});return false;}},graft:function(g,f,d,l){l=(l||(f&&f.ownerDocument)||document);var h;if(d===undefined){echo("Can't graft an undefined value");}else{if(d.constructor==String){h=l.createTextNode(d);}else{for(var c=0;c<d.length;c++){if(c===0&&d[c].constructor==String){var a=d[c].match(/^([a-z][a-z0-9]*)\.([^\s\.]+)$/i);if(a){h=l.createElementNS(g,a[1]);h.setAttributeNS(null,"class",a[2]);continue;}a=d[c].match(/^([a-z][a-z0-9]*)$/i);if(a){h=l.createElementNS(g,a[1]);continue;}h=l.createElementNS(g,"span");h.setAttribute(null,"class","namelessFromLOL");}if(d[c]===undefined){echo("Can't graft an undefined value in a list!");}else{if(d[c].constructor==String||d[c].constructor==Array){this.graft(g,h,d[c],l);}else{if(d[c].constructor==Number){this.graft(g,h,d[c].toString(),l);}else{if(d[c].constructor==Object){for(var b in d[c]){h.setAttributeNS(null,b,d[c][b]);}}else{if(d[c].constructor==Boolean){this.graft(g,h,d[c]?"true":"false",l);}else{throw"Object "+d[c]+" is inscrutable as an graft arglet.";}}}}}}}}if(f){f.appendChild(h);}return Element.extend(h);},setObject:function(a){var b=DataManager.query(a.subject,a.predicate,undefined);DataManager.removeTriples(b);DataManager.addTriple(a);return true;},query:function(c,a,b){return DataManager._triples.select(function(e){var d=((c)?(e.subject.type==c.type)&&(e.subject.value==c.value):true);if(a){d=d&&((a.prefix)?(e.predicate.prefix==a.prefix):true);d=d&&((a.name)?(e.predicate.name==a.name):true);}d=d&&((b)?(e.object.type==b.type)&&(e.object.value==b.value):true);return d;});}};Kickstart.register(DataManager.init);function assert(b,a){if(!b){throw a;}}function DMCommand(a,b){this.action=a;this.triple=b;this.toString=function(){return"Command("+a+", "+b+")";};}function DMCommandHandler(a){this.__setNext=function(c){var b=this.__next;this.__next=a;return b?b:true;};this.__setNext(a);this.__invokeNext=function(b){return this.__next?this.__next.handle(b):false;};this.handle=function(b){return this.process(b)?true:this.__invokeNext(b);};this.process=function(b){return false;};}function MetaTagHandler(next){DMCommandHandler.apply(this,[next]);this.process=function(command){with(command.triple){if(!((subject instanceof ERDF.Resource)&&(subject.isCurrentDocument())&&(object instanceof ERDF.Literal))){return false;}}};}var chain=new MetaTagHandler();var command=new DMCommand(TRIPLE_ADD,new ERDF.Triple(new ERDF.Resource(""),"rdf:tool",new ERDF.Literal("")));ResourceManager={__corrupt:false,__latelyCreatedResource:undefined,__listeners:$H(),__token:1,addListener:function(d,b){if(!(d instanceof Function)){throw"Resource event listener is not a function!";}if(!(b)){throw"Invalid mask for resource event listener registration.";}var a={listener:d,mask:b};var c=ResourceManager.__token++;ResourceManager.__listeners[c]=a;return c;},removeListener:function(a){return ResourceManager.__listners.remove(a);},__Event:function(a,b){this.action=a;this.resourceId=b;},__dispatchEvent:function(a){ResourceManager.__listeners.values().each(function(b){if(a.action&b.mask){return b.listener(a);}});},getResource:function(c){c=ERDF.__stripHashes(c);var b=DataManager.query(new ERDF.Resource("#"+c),{prefix:"raziel",name:"entry"},undefined);if((b.length==1)&&(b[0].object.isResource())){var a=b[0].object.value;return new ResourceManager.__Resource(c,a);}throw ("Resource with id "+c+" not recognized as such. "+((b.length>1)?" There is more than one raziel:entry URL.":" There is no raziel:entry URL."));return false;},__createResource:function(e){var d=DataManager.query(new ERDF.Resource(""),{prefix:"raziel",name:"collection"},undefined);if((d.length==1)&&(d[0].object.isResource())){var b=d[0].object.value;var c=undefined;var a=e?e:'<div xmlns="http://www.w3.org/1999/xhtml"></div>';ResourceManager.__request("POST",b,a,function(){var f=(this.responseXML);var h=f.childNodes[0];var g=h.getAttribute("id");if(!$$("."+PROCESSDATA_REF)[0]){DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,"body").item(0),["div",{"class":PROCESSDATA_REF,"style":"display:none;"}]);}$$("."+PROCESSDATA_REF)[0].appendChild(h.cloneNode(true));DataManager.__synclocal();c=new ResourceManager.getResource(g);ResourceManager.__resourceActionSucceeded(this,RESOURCE_CREATED,undefined);},function(){ResourceManager.__resourceActionFailed(this,RESOURCE_CREATED,undefined);},false);return c;}throw"Could not create resource! raziel:collection URL is missing!";return false;},__Resource:function(b,a){this.__id=b;this.__url=a;this.id=function(){return this.__id;};this.url=function(){return this.__url;};this.reload=function(){var d=this.__url;var c=this.__id;ResourceManager.__request("GET",d,null,function(){ResourceManager.__resourceActionSucceeded(this,RESOURCE_RELOADED,c);},function(){ResourceManager.__resourceActionFailed(this,RESURCE_RELOADED,c);},USE_ASYNCHRONOUS_REQUESTS);};this.save=function(e){var d=this.__url;var c=this.__id;data=DataManager.serialize($(c));ResourceManager.__request("PUT",d,data,function(){ResourceManager.__resourceActionSucceeded(this,e?RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:RESOURCE_SAVED,c);},function(){ResourceManager.__resourceActionFailed(this,e?RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:RESOURCE.SAVED,c);},USE_ASYNCHRONOUS_REQUESTS);};this.remove=function(){var d=this.__url;var c=this.__id;ResourceManager.__request("DELETE",d,null,function(){ResourceManager.__resourceActionSucceeded(this,RESOURCE_REMOVED,c);},function(){ResourceManager.__resourceActionFailed(this,RESOURCE_REMOVED,c);},USE_ASYNCHRONOUS_REQUESTS);};},request:function(c,a){var b={method:"get",asynchronous:true,parameters:{}};Object.extend(b,a||{});var d=Hash.toQueryString(b.parameters);if(d){c+=(c.include("?")?"&":"?")+d;}return ResourceManager.__request(b.method,c,b.data,(b.onSuccess instanceof Function?function(){b.onSuccess(this);}:undefined),(b.onFailure instanceof Function?function(){b.onFailure(this);}:undefined),b.asynchronous&&USE_ASYNCHRONOUS_REQUESTS,b.headers);},__request:function(a,b,f,n,m,d,c){var g=Try.these(function(){return new XMLHttpRequest();},function(){return new ActiveXObject("Msxml2.XMLHTTP");},function(){return new ActiveXObject("Microsoft.XMLHTTP");});if(!g){if(!this.__corrupt){throw"This browser does not provide any AJAX functionality. You will not be able to use the software provided with the page you are viewing. Please consider installing appropriate extensions.";}this.__corrupt=true;return false;}if(n instanceof Function){g.onload=n;}if(m instanceof Function){g.onerror=m;}var k=$H(c);k.keys().each(function(e){g.setRequestHeader(e,k[e]);});try{if(SHOW_DEBUG_ALERTS_WHEN_SAVING){alert(a+" "+b+"\n"+SHOW_EXTENDED_DEBUG_INFORMATION?f:"");}g.open(a,b,!d?false:true);g.send(f);}catch(l){return false;}return true;},__resourceActionSucceeded:function(g,c,f){var a=g.status;var b=g.responseText;if(SHOW_DEBUG_ALERTS_WHEN_SAVING){alert(a+" "+url+"\n"+SHOW_EXTENDED_DEBUG_INFORMATION?data:"");}if(a>=300){throw"The server responded with an error: "+a+"\n"+(SHOW_EXTENDED_DEBUG_INFORMATION?+data:"If you need additional information here, including the data sent by the server, consider setting SHOW_EXTENDED_DEBUG_INFORMATION to true.");}switch(c){case RESOURCE_REMOVED:var b=(g.responseXML);var e=b.childNodes[0];var f=e.getAttribute("id");var d=document.getElementById(f);d.parentNode.removeChild(d);break;case RESOURCE_CREATED:break;case RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:DataManager.__synclocal();case RESOURCE_SAVED:break;case RESOURCE_RELOADED:var b=(g.responseXML);var e=b.childNodes[0];var f=e.getAttribute("id");var d=document.getElementById(f);d.parentNode.removeChild(d);if(!$$(PROCESSDATA_REF)[0]){DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,"body").item(0),["div",{"class":PROCESSDATA_REF,"style":"display:none;"}]);}$$(PROCESSDATA_REF)[0].appendChild(e.cloneNode(true));DataManager.__synclocal();break;default:DataManager.__synclocal();}ResourceManager.__dispatchEvent(new ResourceManager.__Event(c,f));},__resourceActionFailed:function(c,a,b){throw"Fatal: Resource action failed. There is something horribly "+"wrong with either the server, the transport protocol or your "+"online status. Sure you're online?";}};var Clazz=function(){};Clazz.prototype.construct=function(){};Clazz.extend=function(e){var a=function(){if(arguments[0]!==Clazz){this.construct.apply(this,arguments);}};var d=new this(Clazz);var b=this.prototype;for(var f in e){var c=e[f];if(c instanceof Function){c.$=b;}d[f]=c;}a.prototype=d;a.extend=this.extend;return a;};if(!ORYX){var ORYX={};}if(!ORYX.CONFIG){ORYX.CONFIG={};}ORYX_LOGLEVEL=4;ORYX.CONFIG.BACKEND_SWITCH=false;ORYX.CONFIG.PANEL_LEFT_WIDTH=170;ORYX.CONFIG.PANEL_RIGHT_COLLAPSED=true;ORYX.CONFIG.PANEL_RIGHT_WIDTH=300;ORYX.CONFIG.APPNAME="Signavio";ORYX.CONFIG.WEB_URL="explorer";ORYX.CONFIG.ROOT_PATH="/v5designer/editor/";ORYX.CONFIG.EXPLORER_PATH="/v5designer/explorer";ORYX.CONFIG.LIBS_PATH="/v5designer/libs";ORYX.CONFIG.HELP_START_URL="../help/en/index.html";ORYX.CONFIG.HELP_START_URL_DE="../help/de/index.html";ORYX.CONFIG.DIAGRAMS_IMAGE_PATH=ORYX.CONFIG.EXPLORER_PATH+"/src/img";ORYX.CONFIG.GLOSSARY_PROPERTY_SUFFIX="_glossary";ORYX.CONFIG.GLOSSARY_PROPERTY_DIRTY_SUFFIX="_glossary_dirty";ORYX.CONFIG.BLANK_IMAGE=ORYX.CONFIG.LIBS_PATH+"/ext-2.0.2/resources/images/default/s.gif";ORYX.CONFIG.SHOW_GRIDLINE=true;ORYX.CONFIG.SHOW_SIZEGUIDES=true;ORYX.CONFIG.CONTAIN_AUTOMATICALY=true;ORYX.CONFIG.SHOW_ID_IN_PROPERTYWINDOW=true;ORYX.CONFIG.RICHTEXT_2_ENABLED=false;ORYX.CONFIG.VERSION_URL="/VERSION";ORYX.CONFIG.LICENSE_URL="/LICENSE";ORYX.CONFIG.SERVER_HANDLER_ROOT="";ORYX.CONFIG.SERVER_EDITOR_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editor";ORYX.CONFIG.SERVER_MODEL_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/model";ORYX.CONFIG.STENCILSET_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editor_stencilset?embedsvg=true&url=true&namespace=";ORYX.CONFIG.STENCIL_SETS_URL=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editor_stencilset";ORYX.CONFIG.SERVER_PUBLISHER_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/publisher";ORYX.CONFIG.SERVER_GLOSSARY_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/glossary";ORYX.CONFIG.SERVER_GLOSSARY_PREFIX=ORYX.CONFIG.SERVER_GLOSSARY_HANDLER+"#gitem=";ORYX.CONFIG.SERVER_DOWNLOAD_HANDLER="/p/downloadla0932ukjpa09092345qfnsaisig";ORYX.CONFIG.SERVER_EDITOR_DATA_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editordata";ORYX.CONFIG.SERVER_EDITOR_CREATE_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/editorcreate";ORYX.CONFIG.MODE_READONLY="readonly";ORYX.CONFIG.MODE_FULLSCREEN="fullscreen";ORYX.CONFIG.WINDOW_HEIGHT=400;ORYX.CONFIG.PREVENT_LOADINGMASK_AT_READY=false;ORYX.CONFIG.MAX_DIAGRAM_TITLE_LENGTH=200;ORYX.CONFIG.QUERYEVAL_URL=ORYX.CONFIG.ROOT_PATH+"query";ORYX.CONFIG.PLUGINS_ENABLED=true;ORYX.CONFIG.PLUGINS_CONFIG=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/v5designer/editor/config/plugins_s530_smartdot.xml";ORYX.CONFIG.PLUGINS_FOLDER="Plugins/";ORYX.CONFIG.PDF_EXPORT_URL="/p/pdf";ORYX.CONFIG.LOLA_PN_CHECKER="/p/lolapnsoundchecker";ORYX.CONFIG.PN_CHECKER="/p/pnchecksoundness";ORYX.CONFIG.PNML_EXPORT_URL="/p/pnml";ORYX.CONFIG.SIMPLE_PNML_EXPORT_URL="/p/simplepnmlexporter";ORYX.CONFIG.DESYNCHRONIZABILITY_URL="/p/desynchronizability";ORYX.CONFIG.IBPMN2BPMN_URL="/p/ibpmn2bpmn";ORYX.CONFIG.DIAGRAM_PRINTER_URL="/printsvg";ORYX.CONFIG.PLAUSIBILITYCHECKER_REQ=[{stencilSet:"http://b3mn.org/stencilset/epc#"},{stencilSet:"http://b3mn.org/stencilset/bpmn1.1#",requiredExtension:"http://oryx-editor.org/stencilsets/extensions/timjpdl3#"}];ORYX.CONFIG.PROCESSMAP_DEFAULT_ARROW_WIDTH=24;ORYX.CONFIG.PLAUSIBILITYCHECKER_URL=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/plausibilitychecker";ORYX.CONFIG.VALIDATOR_URL="/p/validator";ORYX.CONFIG.AUTO_LAYOUTER_URL=ORYX.CONFIG.ROOT_PATH+"layouter";ORYX.CONFIG.SS_EXTENSIONS_FOLDER=ORYX.CONFIG.ROOT_PATH+"stencilsets/extensions/";ORYX.CONFIG.SS_EXTENSIONS_CONFIG="/v5designer/editor/config/extensions.json";ORYX.CONFIG.ORYX_NEW_URL="/v5designer/index.html";ORYX.CONFIG.STEP_THROUGH="/p/stepthrough";ORYX.CONFIG.STEP_THROUGH_CHECKER=ORYX.CONFIG.ROOT_PATH+"stepthroughchecker";ORYX.CONFIG.XFORMS_EXPORT_URL="/p/xformsexport";ORYX.CONFIG.XFORMS_EXPORT_ORBEON_URL="/p/xformsexport-orbeon";ORYX.CONFIG.XFORMS_IMPORT_URL="/p/xformsimport";ORYX.CONFIG.BPEL_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"bpelexporter";ORYX.CONFIG.BPEL4CHOR_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"bpel4chorexporter";ORYX.CONFIG.TREEGRAPH_SUPPORT=ORYX.CONFIG.ROOT_PATH+"treegraphsupport";ORYX.CONFIG.XPDL4CHOR2BPEL4CHOR_TRANSFORMATION_URL=ORYX.CONFIG.ROOT_PATH+"xpdl4chor2bpel4chor";ORYX.CONFIG.RESOURCE_LIST=ORYX.CONFIG.ROOT_PATH+"resourceList";ORYX.CONFIG.BPMN_LAYOUTER="/v5designer/p/bpmnlayouter";ORYX.CONFIG.BPMN2MIGRATION=ORYX.CONFIG.ROOT_PATH+"bpmn2migration";ORYX.CONFIG.SYNTAXCHECKER_URL=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/syntaxchecker";ORYX.CONFIG.BPMN20_SCHEMA_VALIDATION_ON=true;ORYX.CONFIG.BPMN20_SHAPEREPOSITORY_HIDE_POOLS_LANES=false;ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS=20;ORYX.CONFIG.BPMN20_ENABLE_LANE_MOVE_BUTTONS=false;ORYX.CONFIG.LAYOUTER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/layouter";ORYX.CONFIG.NAMESPACE_ORYX="http://www.b3mn.org/oryx";ORYX.CONFIG.NAMESPACE_SVG="http://www.w3.org/2000/svg";ORYX.CONFIG.CANVAS_WIDTH=1485;ORYX.CONFIG.CANVAS_HEIGHT=1050;ORYX.CONFIG.CANVAS_RESIZE_INTERVAL=300;ORYX.CONFIG.SELECTED_AREA_PADDING=4;ORYX.CONFIG.CANVAS_BACKGROUND_COLOR="none";ORYX.CONFIG.GRID_DISTANCE=30;ORYX.CONFIG.GRID_ENABLED=true;ORYX.CONFIG.ZOOM_OFFSET=0.1;ORYX.CONFIG.DEFAULT_SHAPE_MARGIN=60;ORYX.CONFIG.SCALERS_SIZE=7;ORYX.CONFIG.MINIMUM_SIZE=20;ORYX.CONFIG.MAXIMUM_SIZE=20000;ORYX.CONFIG.OFFSET_MAGNET=15;ORYX.CONFIG.OFFSET_EDGE_LABEL_TOP=8;ORYX.CONFIG.OFFSET_EDGE_LABEL_BOTTOM=8;ORYX.CONFIG.OFFSET_EDGE_BOUNDS=Ext.isIPad?15:5;ORYX.CONFIG.COPY_MOVE_OFFSET=30;ORYX.CONFIG.BORDER_OFFSET=14;ORYX.CONFIG.MAX_NUM_SHAPES_NO_GROUP=15;ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER=30;ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET=45;ORYX.CONFIG.SHAPEMENU_RIGHT="Oryx_Right";ORYX.CONFIG.SHAPEMENU_BOTTOM="Oryx_Bottom";ORYX.CONFIG.SHAPEMENU_LEFT="Oryx_Left";ORYX.CONFIG.SHAPEMENU_TOP="Oryx_Top";ORYX.CONFIG.MORPHITEM_DISABLED="Oryx_MorphItem_disabled";ORYX.CONFIG.TYPE_STRING="string";ORYX.CONFIG.TYPE_BOOLEAN="boolean";ORYX.CONFIG.TYPE_INTEGER="integer";ORYX.CONFIG.TYPE_FLOAT="float";ORYX.CONFIG.TYPE_COLOR="color";ORYX.CONFIG.TYPE_DATE="date";ORYX.CONFIG.TYPE_CHOICE="choice";ORYX.CONFIG.TYPE_URL="url";ORYX.CONFIG.TYPE_DIAGRAM_LINK="diagramlink";ORYX.CONFIG.TYPE_COMPLEX="complex";ORYX.CONFIG.TYPE_TEXT="text";ORYX.CONFIG.TYPE_EPC_FREQ="epcfrequency";ORYX.CONFIG.TYPE_GLOSSARY_LINK="glossarylink";ORYX.CONFIG.TYPE_RADIOBUTTON="radiobutton";ORYX.CONFIG.LABEL_LINE_DISTANCE=1.5;ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT=12;ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER=false;ORYX.CONFIG.EDITOR_ALIGN_BOTTOM=1;ORYX.CONFIG.EDITOR_ALIGN_MIDDLE=2;ORYX.CONFIG.EDITOR_ALIGN_TOP=4;ORYX.CONFIG.EDITOR_ALIGN_LEFT=8;ORYX.CONFIG.EDITOR_ALIGN_CENTER=16;ORYX.CONFIG.EDITOR_ALIGN_RIGHT=32;ORYX.CONFIG.EDITOR_ALIGN_SIZE=48;ORYX.CONFIG.EVENT_MOUSEDOWN="mousedown";ORYX.CONFIG.EVENT_MOUSEUP="mouseup";ORYX.CONFIG.EVENT_MOUSEOVER="mouseover";ORYX.CONFIG.EVENT_MOUSEOUT="mouseout";ORYX.CONFIG.EVENT_MOUSEMOVE="mousemove";ORYX.CONFIG.EVENT_DBLCLICK="dblclick";ORYX.CONFIG.EVENT_KEYDOWN="keydown";ORYX.CONFIG.EVENT_KEYUP="keyup";ORYX.CONFIG.EVENT_LOADED="editorloaded";ORYX.CONFIG.EVENT_EXECUTE_COMMANDS="executeCommands";ORYX.CONFIG.EVENT_LAST_EXECUTE_COMMANDS="lastCommandExecuted";ORYX.CONFIG.EVENT_STENCIL_SET_LOADED="stencilSetLoaded";ORYX.CONFIG.EVENT_SELECTION_CHANGED="selectionchanged";ORYX.CONFIG.EVENT_SHAPEADDED="shapeadded";ORYX.CONFIG.EVENT_BEFORE_REMOVE="beforeremove";ORYX.CONFIG.EVENT_SHAPEREMOVED="shaperemoved";ORYX.CONFIG.EVENT_PROPERTY_CHANGED="propertyChanged";ORYX.CONFIG.EVENT_DRAGDROP_START="dragdrop.start";ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE="shape.menu.close";ORYX.CONFIG.EVENT_DRAGDROP_END="dragdrop.end";ORYX.CONFIG.EVENT_RESIZE_START="resize.start";ORYX.CONFIG.EVENT_RESIZE_END="resize.end";ORYX.CONFIG.EVENT_CANVAS_RESIZE="canvas.resize";ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED="dragDocker.docked";ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW="highlight.showHighlight";ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE="highlight.hideHighlight";ORYX.CONFIG.EVENT_POOLDOCKING_SHOW="poollanecreation.over";ORYX.CONFIG.EVENT_POOLDOCKING_HIDE="poollanecreation.out";ORYX.CONFIG.EVENT_LOADING_ENABLE="loading.enable";ORYX.CONFIG.EVENT_LOADING_DISABLE="loading.disable";ORYX.CONFIG.EVENT_LOADING_STATUS="loading.status";ORYX.CONFIG.EVENT_OVERLAY_SHOW="overlay.show";ORYX.CONFIG.EVENT_OVERLAY_HIDE="overlay.hide";ORYX.CONFIG.EVENT_ARRANGEMENT_TOP="arrangement.setToTop";ORYX.CONFIG.EVENT_ARRANGEMENT_BACK="arrangement.setToBack";ORYX.CONFIG.EVENT_ARRANGEMENT_FORWARD="arrangement.setForward";ORYX.CONFIG.EVENT_ARRANGEMENT_BACKWARD="arrangement.setBackward";ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED="propertyWindow.propertyChanged";ORYX.CONFIG.EVENT_LAYOUT_ROWS="layout.rows";ORYX.CONFIG.EVENT_LAYOUT_BPEL="layout.BPEL";ORYX.CONFIG.EVENT_LAYOUT_BPEL_VERTICAL="layout.BPEL.vertical";ORYX.CONFIG.EVENT_LAYOUT_BPEL_HORIZONTAL="layout.BPEL.horizontal";ORYX.CONFIG.EVENT_LAYOUT_BPEL_SINGLECHILD="layout.BPEL.singlechild";ORYX.CONFIG.EVENT_LAYOUT_BPEL_AUTORESIZE="layout.BPEL.autoresize";ORYX.CONFIG.EVENT_AUTOLAYOUT_LAYOUT="autolayout.layout";ORYX.CONFIG.EVENT_UNDO_EXECUTE="undo.execute";ORYX.CONFIG.EVENT_UNDO_ROLLBACK="undo.rollback";ORYX.CONFIG.EVENT_UNDO_BEFORE_EXECUTE="undo.before.execute";ORYX.CONFIG.EVENT_UNDO_BEFORE_ROLLBACK="undo.before.rollback";ORYX.CONFIG.EVENT_BUTTON_UPDATE="toolbar.button.update";ORYX.CONFIG.EVENT_LAYOUT="layout.dolayout";ORYX.CONFIG.EVENT_GLOSSARY_LINK_EDIT="glossary.link.edit";ORYX.CONFIG.EVENT_GLOSSARY_SHOW="glossary.show.info";ORYX.CONFIG.EVENT_GLOSSARY_NEW="glossary.show.new";ORYX.CONFIG.EVENT_DOCKERDRAG="dragTheDocker";ORYX.CONFIG.EVENT_ZOOM="view.zoom";ORYX.CONFIG.EVENT_BPMN20_HASHCHILD="layout.bpmn20subprocess.hashchild";ORYX.CONFIG.EVENT_BPMN20_DELETE_HASH="layout.bpmn20poollane.deletehash";ORYX.CONFIG.EVENT_BPMN20_ADJUST_LANES="layout.bpmn20poollane.adjustlanes";ORYX.CONFIG.EVENT_BPMN20_DIAGRAM_ORIENTATION_CHANGED="layout.bpmn20diagram.orientation.changed";ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW="propertywindow.show";ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW_DIALOG="propertywindow.show.dialog";ORYX.CONFIG.EVENT_ABOUT_TO_SAVE="file.aboutToSave";ORYX.CONFIG.EVENT_SAVED="file.saved";ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE=5;ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR="#4444FF";ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR2="#9999FF";ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_CORNER="corner";ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE="rectangle";ORYX.CONFIG.SELECTION_VALID_COLOR="#00FF00";ORYX.CONFIG.SELECTION_INVALID_COLOR="#FF0000";ORYX.CONFIG.DOCKER_DOCKED_COLOR="#00FF00";ORYX.CONFIG.DOCKER_UNDOCKED_COLOR="#FF0000";ORYX.CONFIG.DOCKER_SNAP_OFFSET=10;ORYX.CONFIG.EDIT_OFFSET_PASTE=10;ORYX.CONFIG.KEY_CODE_X=88;ORYX.CONFIG.KEY_CODE_C=67;ORYX.CONFIG.KEY_CODE_V=86;ORYX.CONFIG.KEY_CODE_DELETE=46;ORYX.CONFIG.KEY_CODE_META=224;ORYX.CONFIG.KEY_CODE_BACKSPACE=8;ORYX.CONFIG.KEY_CODE_LEFT=37;ORYX.CONFIG.KEY_CODE_RIGHT=39;ORYX.CONFIG.KEY_CODE_UP=38;ORYX.CONFIG.KEY_CODE_DOWN=40;ORYX.CONFIG.KEY_Code_enter=12;ORYX.CONFIG.KEY_Code_left=37;ORYX.CONFIG.KEY_Code_right=39;ORYX.CONFIG.KEY_Code_top=38;ORYX.CONFIG.KEY_Code_bottom=40;ORYX.CONFIG.META_KEY_META_CTRL="metactrl";ORYX.CONFIG.META_KEY_ALT="alt";ORYX.CONFIG.META_KEY_SHIFT="shift";ORYX.CONFIG.KEY_ACTION_DOWN="down";ORYX.CONFIG.KEY_ACTION_UP="up";ORYX.CONFIG.MULTI_LANGUAGES_ENABLED=false;ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT="de";ORYX.CONFIG.MULTI_LANGUAGES={de:"de.png",eng:"gb.png"};ORYX.CONFIG.CANVAS_ORIENTATION="horizontal";ORYX.CONFIG.SIGNAVIO_BRANDING_CONFIGURABEL=false;if(!ORYX.I18N){ORYX.I18N={};}if(!ORYX.I18N.Help){ORYX.I18N.Help={};}ORYX.I18N.Help.group="Help";if(!ORYX.I18N.AddDocker){ORYX.I18N.AddDocker={};}ORYX.I18N.AddDocker.group="Docker";if(!ORYX.I18N.Arrangement){ORYX.I18N.Arrangement={};}ORYX.I18N.Arrangement.groupZ="Z-Order";ORYX.I18N.Arrangement.groupA="Alignment";if(!ORYX.I18N.Edit){ORYX.I18N.Edit={};}ORYX.I18N.Edit.group="Edit";if(!ORYX.I18N.File){ORYX.I18N.File={};}ORYX.I18N.File.group="File";if(!ORYX.I18N.Save){ORYX.I18N.Save={};}ORYX.I18N.Save.group="File";if(!ORYX.I18N.Grouping){ORYX.I18N.Grouping={};}ORYX.I18N.Grouping.group="Group";if(!ORYX.I18N.Undo){ORYX.I18N.Undo={};}ORYX.I18N.Undo.group="Undo";if(!ORYX.I18N.View){ORYX.I18N.View={};}ORYX.I18N.View.group="Zoom";if(!ORYX.I18N.SyntaxChecker){ORYX.I18N.SyntaxChecker={};}ORYX.I18N.SyntaxChecker.group="Verification";if(!Signavio){var Signavio={};}if(!Signavio.I18N){Signavio.I18N={};}if(!Signavio.I18N.Migration){Signavio.I18N.Migration={};}Signavio.I18N.Migration.group="Export";if(!Signavio.I18N.ViewsEditor){Signavio.I18N.ViewsEditor={};}Signavio.I18N.ViewsEditor.group="Views";if(!Signavio.I18N.PlausibilityChecker){Signavio.I18N.PlausibilityChecker={};}Signavio.I18N.PlausibilityChecker.group="Verification";if(!Signavio.CONFIG){Signavio.CONFIG={};}if(!Signavio.CONFIG.PROPERTY){Signavio.CONFIG.PROPERTY={};}Signavio.CONFIG.IE9_PATH_OPACITY_FIX_VALUE=0.9999;function printf(){var a=arguments[0];for(var b=1;b<arguments.length;b++){a=a.replace("%"+(b-1),arguments[b]);}return a;}var ORYX_LOGLEVEL_TRACE=5;var ORYX_LOGLEVEL_DEBUG=4;var ORYX_LOGLEVEL_INFO=3;var ORYX_LOGLEVEL_WARN=2;var ORYX_LOGLEVEL_ERROR=1;var ORYX_LOGLEVEL_FATAL=0;var ORYX_LOGLEVEL=0;var ORYX_CONFIGURATION_DELAY=100;var ORYX_CONFIGURATION_WAIT_ATTEMPTS=10;if(!ORYX){var ORYX={};}ORYX=Object.extend(ORYX,{PATH:ORYX.CONFIG.ROOT_PATH,URLS:[],alreadyLoaded:[],configrationRetries:0,Version:"0.1.1",availablePlugins:[],Log:{__appenders:[{append:function(a){console.log(a);}}],trace:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_TRACE){ORYX.Log.__log("TRACE",arguments);}},debug:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_DEBUG){ORYX.Log.__log("DEBUG",arguments);}},info:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_INFO){ORYX.Log.__log("INFO",arguments);}},warn:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_WARN){ORYX.Log.__log("WARN",arguments);}},error:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_ERROR){ORYX.Log.__log("ERROR",arguments);}},fatal:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_FATAL){ORYX.Log.__log("FATAL",arguments);}},__log:function(c,a){a[0]=(new Date()).getTime()+" "+c+" "+a[0];var b=printf.apply(null,a);ORYX.Log.__appenders.each(function(d){d.append(b);});},addAppender:function(a){ORYX.Log.__appenders.push(a);}},load:function(){if(ORYX.CONFIG.PREVENT_LOADINGMASK_AT_READY!==true){var a=new Ext.Window({renderTo:Ext.getBody(),id:"oryx-loading-panel",bodyStyle:"padding: 8px;background:white",title:ORYX.I18N.Oryx.title,width:"auto",height:"auto",modal:true,resizable:false,closable:false,html:'<span style="font-size:11px;">'+ORYX.I18N.Oryx.pleaseWait+"</span>"});a.show();}ORYX.Log.debug("Oryx begins loading procedure.");if((typeof Prototype=="undefined")||(typeof Element=="undefined")||(typeof Element.Methods=="undefined")||parseFloat(Prototype.Version.split(".")[0]+"."+Prototype.Version.split(".")[1])<1.5){throw ("Application requires the Prototype JavaScript framework >= 1.5.3");}ORYX.Log.debug("Prototype > 1.5 found.");(function(){Ext.Ajax.getSecurityToken=function(){var d=Signavio.Helper.getCookie("token");return(d&&32==d.length&&d)||"-null-";};Ext.Ajax.getSecurityParameter=function(){return{"signavio-id":Ext.Ajax.getSecurityToken()};};Ext.Ajax.defaultHeaders=Ext.apply({},Ext.Ajax.defaultHeaders||{});var c=Ext.Ajax.request;Ext.Ajax.request=function(){var d=Ext.Ajax.getSecurityToken();if(d){this.defaultHeaders["x-signavio-id"]=d;}else{delete this.defaultHeaders["x-signavio-id"];}return c.apply(this,arguments);};var b=Ajax.Request.prototype.setRequestHeaders;Ajax.Request.prototype.setRequestHeaders=function(){b.apply(this,arguments);this.transport.setRequestHeader("x-signavio-id",Ext.Ajax.getSecurityToken());};}());ORYX._load();},_load:function(){ORYX.loadPlugins();},loadPlugins:function(){if(ORYX.CONFIG.PLUGINS_ENABLED){ORYX._loadPlugins();}else{ORYX.Log.warn("Ignoring plugins, loading Core only.");}init();},_loadPlugins:function(){var a=ORYX.CONFIG.PLUGINS_CONFIG;ORYX.Log.debug("Loading plugin configuration from '%0'.",a);new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:function(c){ORYX.Log.info("Plugin configuration file loaded.");var f=c.responseXML;var b=[];var d=$A(f.getElementsByTagName("properties"));d.each(function(h){var g=$A(h.childNodes);g.each(function(m){var l=new Hash();var k=$A(m.attributes);k.each(function(n){l[n.nodeName]=n.nodeValue;});if(k.length>0){b.push(l);}});});var e=f.getElementsByTagName("plugin");$A(e).each(function(n){var g=new Hash();$A(n.attributes).each(function(q){g[q.nodeName]=q.nodeValue;});if(!g["name"]){ORYX.Log.error("A plugin is not providing a name. Ingnoring this plugin.");return;}var o=n.getElementsByTagName("property");var l=[];$A(o).each(function(s){var r=new Hash();var q=$A(s.attributes);q.each(function(t){r[t.nodeName]=t.nodeValue;});if(q.length>0){l.push(r);}});l=l.concat(b);g["properties"]=l;var p=n.getElementsByTagName("requires");var m;$A(p).each(function(r){var q=$A(r.attributes).find(function(s){return s.name=="namespace";});if(q&&q.nodeValue){if(!m){m={namespaces:[]};}m.namespaces.push(q.nodeValue);}});if(m){g["requires"]=m;}var k=n.getElementsByTagName("notUsesIn");var h;$A(k).each(function(r){var q=$A(r.attributes).find(function(s){return s.name=="namespace";});if(q&&q.nodeValue){if(!h){h={namespaces:[]};}h.namespaces.push(q.nodeValue);}});if(h){g["notUsesIn"]=h;}ORYX.Log.info("Plugin '%0' successfully loaded.",g["name"]);ORYX.availablePlugins.push(g);});},onFailure:this._loadPluginsOnFails});},_loadPluginsOnFails:function(a){ORYX.Log.error("Plugin configuration file not available.");}});ORYX.Log.debug("Registering Oryx with Kickstart");Kickstart.register(ORYX.load);if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.SVG){ORYX.Core.SVG={};}ORYX.Core.SVG.EditPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.x=0;this.y=0;this.oldX=0;this.oldY=0;this.deltaWidth=1;this.deltaHeight=1;this.d="";},init:function(a,f,d,b,c,e){this.x=a;this.y=f;this.oldX=d;this.oldY=b;this.deltaWidth=c;this.deltaHeight=e;this.d="";},editPointsAbs:function(c){if(c instanceof Array){var d=[];var a,e;for(var b=0;b<c.length;b++){a=(parseFloat(c[b])-this.oldX)*this.deltaWidth+this.x;b++;e=(parseFloat(c[b])-this.oldY)*this.deltaHeight+this.y;d.push(a);d.push(e);}return d;}else{}},editPointsRel:function(c){if(c instanceof Array){var d=[];var a,e;for(var b=0;b<c.length;b++){a=parseFloat(c[b])*this.deltaWidth;b++;e=parseFloat(c[b])*this.deltaHeight;d.push(a);d.push(e);}return d;}else{}},arcAbs:function(e,c,k,b,f,h,g){var d=this.editPointsAbs([h,g]);var a=this.editPointsRel([e,c]);this.d=this.d.concat(" A"+a[0]+" "+a[1]+" "+k+" "+b+" "+f+" "+d[0]+" "+d[1]+" ");},arcRel:function(f,d,b,e,c,a,h){var g=this.editPointsRel([f,d,a,h]);this.d=this.d.concat(" a"+g[0]+" "+g[1]+" "+b+" "+e+" "+c+" "+g[2]+" "+g[3]+" ");},curvetoCubicAbs:function(c,e,b,d,a,g){var f=this.editPointsAbs([c,e,b,d,a,g]);this.d=this.d.concat(" C"+f[0]+" "+f[1]+" "+f[2]+" "+f[3]+" "+f[4]+" "+f[5]+" ");},curvetoCubicRel:function(c,e,b,d,a,g){var f=this.editPointsRel([c,e,b,d,a,g]);this.d=this.d.concat(" c"+f[0]+" "+f[1]+" "+f[2]+" "+f[3]+" "+f[4]+" "+f[5]+" ");},linetoHorizontalAbs:function(a){var b=this.editPointsAbs([a,0]);this.d=this.d.concat(" H"+b[0]+" ");},linetoHorizontalRel:function(a){var b=this.editPointsRel([a,0]);this.d=this.d.concat(" h"+b[0]+" ");},linetoAbs:function(a,c){var b=this.editPointsAbs([a,c]);this.d=this.d.concat(" L"+b[0]+" "+b[1]+" ");},linetoRel:function(a,c){var b=this.editPointsRel([a,c]);this.d=this.d.concat(" l"+b[0]+" "+b[1]+" ");},movetoAbs:function(a,c){var b=this.editPointsAbs([a,c]);this.d=this.d.concat(" M"+b[0]+" "+b[1]+" ");},movetoRel:function(a,c){var b;if(this.d===""){b=this.editPointsAbs([a,c]);}else{b=this.editPointsRel([a,c]);}this.d=this.d.concat(" m"+b[0]+" "+b[1]+" ");},curvetoQuadraticAbs:function(b,c,a,e){var d=this.editPointsAbs([b,c,a,e]);this.d=this.d.concat(" Q"+d[0]+" "+d[1]+" "+d[2]+" "+d[3]+" ");},curvetoQuadraticRel:function(b,c,a,e){var d=this.editPointsRel([b,c,a,e]);this.d=this.d.concat(" q"+d[0]+" "+d[1]+" "+d[2]+" "+d[3]+" ");},curvetoCubicSmoothAbs:function(b,c,a,e){var d=this.editPointsAbs([b,c,a,e]);this.d=this.d.concat(" S"+d[0]+" "+d[1]+" "+d[2]+" "+d[3]+" ");},curvetoCubicSmoothRel:function(b,c,a,e){var d=this.editPointsRel([b,c,a,e]);this.d=this.d.concat(" s"+d[0]+" "+d[1]+" "+d[2]+" "+d[3]+" ");},curvetoQuadraticSmoothAbs:function(a,c){var b=this.editPointsAbs([a,c]);this.d=this.d.concat(" T"+b[0]+" "+b[1]+" ");},curvetoQuadraticSmoothRel:function(a,c){var b=this.editPointsRel([a,c]);this.d=this.d.concat(" t"+b[0]+" "+b[1]+" ");},linetoVerticalAbs:function(b){var a=this.editPointsAbs([0,b]);this.d=this.d.concat(" V"+a[1]+" ");},linetoVerticalRel:function(b){var a=this.editPointsRel([0,b]);this.d=this.d.concat(" v"+a[1]+" ");},closePath:function(){this.d=this.d.concat(" z");}});if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.SVG){ORYX.Core.SVG={};}ORYX.Core.SVG.MinMaxPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.minX=undefined;this.minY=undefined;this.maxX=undefined;this.maxY=undefined;this._lastAbsX=undefined;this._lastAbsY=undefined;},calculateMinMax:function(c){if(c instanceof Array){var a,d;for(var b=0;b<c.length;b++){a=parseFloat(c[b]);b++;d=parseFloat(c[b]);this.minX=(this.minX!==undefined)?Math.min(this.minX,a):a;this.maxX=(this.maxX!==undefined)?Math.max(this.maxX,a):a;this.minY=(this.minY!==undefined)?Math.min(this.minY,d):d;this.maxY=(this.maxY!==undefined)?Math.max(this.maxY,d):d;this._lastAbsX=a;this._lastAbsY=d;}}else{}},arcAbs:function(f,d,b,e,c,a,g){this.calculateMinMax([a,g]);},arcRel:function(f,d,b,e,c,a,g){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+g]);},curvetoCubicAbs:function(c,e,b,d,a,f){this.calculateMinMax([c,e,b,d,a,f]);},curvetoCubicRel:function(c,e,b,d,a,f){this.calculateMinMax([this._lastAbsX+c,this._lastAbsY+e,this._lastAbsX+b,this._lastAbsY+d,this._lastAbsX+a,this._lastAbsY+f]);},linetoHorizontalAbs:function(a){this.calculateMinMax([a,this._lastAbsY]);},linetoHorizontalRel:function(a){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY]);},linetoAbs:function(a,b){this.calculateMinMax([a,b]);},linetoRel:function(a,b){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+b]);},movetoAbs:function(a,b){this.calculateMinMax([a,b]);},movetoRel:function(a,b){if(this._lastAbsX&&this._lastAbsY){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+b]);}else{this.calculateMinMax([a,b]);}},curvetoQuadraticAbs:function(b,c,a,d){this.calculateMinMax([b,c,a,d]);},curvetoQuadraticRel:function(b,c,a,d){this.calculateMinMax([this._lastAbsX+b,this._lastAbsY+c,this._lastAbsX+a,this._lastAbsY+d]);},curvetoCubicSmoothAbs:function(b,c,a,d){this.calculateMinMax([b,c,a,d]);},curvetoCubicSmoothRel:function(b,c,a,d){this.calculateMinMax([this._lastAbsX+b,this._lastAbsY+c,this._lastAbsX+a,this._lastAbsY+d]);},curvetoQuadraticSmoothAbs:function(a,b){this.calculateMinMax([a,b]);},curvetoQuadraticSmoothRel:function(a,b){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+b]);},linetoVerticalAbs:function(a){this.calculateMinMax([this._lastAbsX,a]);},linetoVerticalRel:function(a){this.calculateMinMax([this._lastAbsX,this._lastAbsY+a]);},closePath:function(){return;}});if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.SVG){ORYX.Core.SVG={};}ORYX.Core.SVG.PointsPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.points=[];this._lastAbsX=undefined;this._lastAbsY=undefined;},addPoints:function(c){if(c instanceof Array){var a,d;for(var b=0;b<c.length;b++){a=parseFloat(c[b]);b++;d=parseFloat(c[b]);this.points.push(a);this.points.push(d);this._lastAbsX=a;this._lastAbsY=d;}}else{}},arcAbs:function(f,d,b,e,c,a,g){this.addPoints([a,g]);},arcRel:function(f,d,b,e,c,a,g){this.addPoints([this._lastAbsX+a,this._lastAbsY+g]);},curvetoCubicAbs:function(c,e,b,d,a,f){this.addPoints([a,f]);},curvetoCubicRel:function(c,e,b,d,a,f){this.addPoints([this._lastAbsX+a,this._lastAbsY+f]);},linetoHorizontalAbs:function(a){this.addPoints([a,this._lastAbsY]);},linetoHorizontalRel:function(a){this.addPoints([this._lastAbsX+a,this._lastAbsY]);},linetoAbs:function(a,b){this.addPoints([a,b]);},linetoRel:function(a,b){this.addPoints([this._lastAbsX+a,this._lastAbsY+b]);},movetoAbs:function(a,b){this.addPoints([a,b]);},movetoRel:function(a,b){if(this._lastAbsX&&this._lastAbsY){this.addPoints([this._lastAbsX+a,this._lastAbsY+b]);}else{this.addPoints([a,b]);}},curvetoQuadraticAbs:function(b,c,a,d){this.addPoints([a,d]);},curvetoQuadraticRel:function(b,c,a,d){this.addPoints([this._lastAbsX+a,this._lastAbsY+d]);},curvetoCubicSmoothAbs:function(b,c,a,d){this.addPoints([a,d]);},curvetoCubicSmoothRel:function(b,c,a,d){this.addPoints([this._lastAbsX+a,this._lastAbsY+d]);},curvetoQuadraticSmoothAbs:function(a,b){this.addPoints([a,b]);},curvetoQuadraticSmoothRel:function(a,b){this.addPoints([this._lastAbsX+a,this._lastAbsY+b]);},linetoVerticalAbs:function(a){this.addPoints([this._lastAbsX,a]);},linetoVerticalRel:function(a){this.addPoints([this._lastAbsX,this._lastAbsY+a]);},closePath:function(){return;}});NAMESPACE_ORYX="http://www.b3mn.org/oryx";NAMESPACE_SVG="http://www.w3.org/2000/svg/";if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.SVG){ORYX.Core.SVG={};}ORYX.Core.SVG.SVGMarker=Clazz.extend({construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.id=undefined;this.element=a;this.refX=undefined;this.refY=undefined;this.markerWidth=undefined;this.markerHeight=undefined;this.oldRefX=undefined;this.oldRefY=undefined;this.oldMarkerWidth=undefined;this.oldMarkerHeight=undefined;this.optional=false;this.enabled=true;this.minimumLength=undefined;this.resize=false;this.svgShapes=[];this._init();},_init:function(){if(!(this.element=="[object SVGMarkerElement]")){throw"SVGMarker: Argument is not an instance of SVGMarkerElement.";}this.id=this.element.getAttributeNS(null,"id");var a=this.element.getAttributeNS(null,"refX");if(a){this.refX=parseFloat(a);}else{this.refX=0;}var h=this.element.getAttributeNS(null,"refY");if(h){this.refY=parseFloat(h);}else{this.refY=0;}var f=this.element.getAttributeNS(null,"markerWidth");if(f){this.markerWidth=parseFloat(f);}else{this.markerWidth=3;}var c=this.element.getAttributeNS(null,"markerHeight");if(c){this.markerHeight=parseFloat(c);}else{this.markerHeight=3;}this.oldRefX=this.refX;this.oldRefY=this.refY;this.oldMarkerWidth=this.markerWidth;this.oldMarkerHeight=this.markerHeight;var g=this.element.getAttributeNS(NAMESPACE_ORYX,"optional");if(g){g=g.strip();this.optional=(g.toLowerCase()==="yes");}else{this.optional=false;}var e=this.element.getAttributeNS(NAMESPACE_ORYX,"enabled");if(e){e=e.strip();this.enabled=!(e.toLowerCase()==="no");}else{this.enabled=true;}var d=this.element.getAttributeNS(NAMESPACE_ORYX,"minimumLength");if(d){this.minimumLength=parseFloat(d);}var b=this.element.getAttributeNS(NAMESPACE_ORYX,"resize");if(b){b=b.strip();this.resize=(b.toLowerCase()==="yes");}else{this.resize=false;}},_getSVGShapes:function(c){if(c.hasChildNodes){var a=[];var b=this;$A(c.childNodes).each(function(d){try{var g=new ORYX.Core.SVG.SVGShape(d);a.push(g);}catch(f){a=a.concat(b._getSVGShapes(d));}});return a;}},update:function(){this.oldRefX=this.refX;this.oldRefY=this.refY;this.oldMarkerWidth=this.markerWidth;this.oldMarkerHeight=this.markerHeight;},toString:function(){return(this.element)?"SVGMarker "+this.element.id:"SVGMarker "+this.element;}});NAMESPACE_ORYX="http://www.b3mn.org/oryx";NAMESPACE_SVG="http://www.w3.org/2000/svg/";if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.SVG){ORYX.Core.SVG={};}ORYX.Core.SVG.SVGShape=Clazz.extend({construct:function(b,a){arguments.callee.$.construct.apply(this,arguments);this.type;this.element=b;this.parent=a;this.x=undefined;this.y=undefined;this.width=undefined;this.height=undefined;this.oldX=undefined;this.oldY=undefined;this.oldWidth=undefined;this.oldHeight=undefined;this.radiusX=undefined;this.radiusY=undefined;this.isHorizontallyResizable=false;this.isVerticallyResizable=false;this.anchorLeft=false;this.anchorRight=false;this.anchorTop=false;this.anchorBottom=false;this.allowDockers=true;this.resizeMarkerMid=false;this.editPathParser;this.editPathHandler;this.init();},init:function(){if(ORYX.Editor.checkClassType(this.element,SVGRectElement)||ORYX.Editor.checkClassType(this.element,SVGImageElement)){this.type="Rect";var J=this.element.getAttributeNS(null,"x");if(J){this.oldX=parseFloat(J);}else{throw"Missing attribute in element "+this.element;}var p=this.element.getAttributeNS(null,"y");if(p){this.oldY=parseFloat(p);}else{throw"Missing attribute in element "+this.element;}var r=this.element.getAttributeNS(null,"width");if(r){this.oldWidth=parseFloat(r);}else{throw"Missing attribute in element "+this.element;}var u=this.element.getAttributeNS(null,"height");if(u){this.oldHeight=parseFloat(u);}else{throw"Missing attribute in element "+this.element;}}else{if(ORYX.Editor.checkClassType(this.element,SVGCircleElement)){this.type="Circle";var h=undefined;var e=undefined;var a=this.element.getAttributeNS(null,"cx");if(a){h=parseFloat(a);}else{throw"Missing attribute in element "+this.element;}var x=this.element.getAttributeNS(null,"cy");if(x){e=parseFloat(x);}else{throw"Missing attribute in element "+this.element;}var k=this.element.getAttributeNS(null,"r");if(k){this.radiusX=parseFloat(k);}else{throw"Missing attribute in element "+this.element;}this.oldX=h-this.radiusX;this.oldY=e-this.radiusX;this.oldWidth=2*this.radiusX;this.oldHeight=2*this.radiusX;}else{if(ORYX.Editor.checkClassType(this.element,SVGEllipseElement)){this.type="Ellipse";var h=undefined;var e=undefined;var a=this.element.getAttributeNS(null,"cx");if(a){h=parseFloat(a);}else{throw"Missing attribute in element "+this.element;}var x=this.element.getAttributeNS(null,"cy");if(x){e=parseFloat(x);}else{throw"Missing attribute in element "+this.element;}var K=this.element.getAttributeNS(null,"rx");if(K){this.radiusX=parseFloat(K);}else{throw"Missing attribute in element "+this.element;}var q=this.element.getAttributeNS(null,"ry");if(q){this.radiusY=parseFloat(q);}else{throw"Missing attribute in element "+this.element;}this.oldX=h-this.radiusX;this.oldY=e-this.radiusY;this.oldWidth=2*this.radiusX;this.oldHeight=2*this.radiusY;}else{if(ORYX.Editor.checkClassType(this.element,SVGLineElement)){this.type="Line";var D=undefined;var g=undefined;var B=undefined;var d=undefined;var I=this.element.getAttributeNS(null,"x1");if(I){D=parseFloat(I);}else{throw"Missing attribute in element "+this.element;}var b=this.element.getAttributeNS(null,"y1");if(b){g=parseFloat(b);}else{throw"Missing attribute in element "+this.element;}var m=this.element.getAttributeNS(null,"x2");if(m){B=parseFloat(m);}else{throw"Missing attribute in element "+this.element;}var v=this.element.getAttributeNS(null,"y2");if(v){d=parseFloat(v);}else{throw"Missing attribute in element "+this.element;}this.oldX=Math.min(D,B);this.oldY=Math.min(g,d);this.oldWidth=Math.abs(D-B);this.oldHeight=Math.abs(g-d);}else{if(ORYX.Editor.checkClassType(this.element,SVGPolylineElement)||ORYX.Editor.checkClassType(this.element,SVGPolygonElement)){this.type="Polyline";var n=[];if(this.element.points&&this.element.points.numberOfItems){for(var A=0,s=this.element.points.numberOfItems;A<s;A++){n.push(this.element.points.getItem(A).x);n.push(this.element.points.getItem(A).y);}}else{var z=this.element.getAttributeNS(null,"points");if(z){z=z.replace(/,/g," ");n=z.split(" ");n=n.without("");}else{throw"Missing attribute in element "+this.element;}}if(n&&n.length&&n.length>1){var H=parseFloat(n[0]);var G=parseFloat(n[1]);var F=parseFloat(n[0]);var E=parseFloat(n[1]);for(var A=0;A<n.length;A++){H=Math.min(H,parseFloat(n[A]));F=Math.max(F,parseFloat(n[A]));A++;G=Math.min(G,parseFloat(n[A]));E=Math.max(E,parseFloat(n[A]));}this.oldX=H;this.oldY=G;this.oldWidth=F-H;this.oldHeight=E-G;}else{throw"Missing attribute in element "+this.element;}}else{if(ORYX.Editor.checkClassType(this.element,SVGPathElement)){this.type="Path";this.editPathParser=new PathParser();this.editPathHandler=new ORYX.Core.SVG.EditPathHandler();this.editPathParser.setHandler(this.editPathHandler);var f=new PathParser();var c=new ORYX.Core.SVG.MinMaxPathHandler();f.setHandler(c);f.parsePath(this.element);this.oldX=c.minX;this.oldY=c.minY;this.oldWidth=c.maxX-c.minX;this.oldHeight=c.maxY-c.minY;delete f;delete c;}else{if(ORYX.Editor.checkClassType(this.element,SVGGElement)){this.type="G";throw"Element is not a shape.";}else{throw"Element is not a shape.";}}}}}}}var t=this.element.getAttributeNS(NAMESPACE_ORYX,"resize");if(t){t=t.toLowerCase();if(t.match(/horizontal/)){this.isHorizontallyResizable=true;}else{this.isHorizontallyResizable=false;}if(t.match(/vertical/)){this.isVerticallyResizable=true;}else{this.isVerticallyResizable=false;}}else{this.isHorizontallyResizable=false;this.isVerticallyResizable=false;}var y=this.element.getAttributeNS(NAMESPACE_ORYX,"anchors");if(y){y=y.replace("/,/g"," ");var o=y.split(" ").without("");for(var A=0;A<o.length;A++){switch(o[A].toLowerCase()){case"left":this.anchorLeft=true;break;case"right":this.anchorRight=true;break;case"top":this.anchorTop=true;break;case"bottom":this.anchorBottom=true;break;}}}if(ORYX.Editor.checkClassType(this.element,SVGPathElement)){var l=this.element.getAttributeNS(NAMESPACE_ORYX,"allowDockers");if(l){if(l.toLowerCase()==="no"){this.allowDockers=false;}else{this.allowDockers=true;}}var C=this.element.getAttributeNS(NAMESPACE_ORYX,"resizeMarker-mid");if(C){if(C.toLowerCase()==="yes"){this.resizeMarkerMid=true;}else{this.resizeMarkerMid=false;}}}this.x=this.oldX;this.y=this.oldY;this.width=this.oldWidth;this.height=this.oldHeight;this.id=this.element.id;},update:function(){if(this.x!==this.oldX||this.y!==this.oldY||this.width!==this.oldWidth||this.height!==this.oldHeight){switch(this.type){case"Rect":if(this.x!==this.oldX){this.element.setAttributeNS(null,"x",this.x);}if(this.y!==this.oldY){this.element.setAttributeNS(null,"y",this.y);}if(this.width!==this.oldWidth){this.element.setAttributeNS(null,"width",this.width);}if(this.height!==this.oldHeight){this.element.setAttributeNS(null,"height",this.height);}break;case"Circle":this.radiusX=((this.width<this.height)?this.width:this.height)/2;this.element.setAttributeNS(null,"cx",this.x+this.width/2);this.element.setAttributeNS(null,"cy",this.y+this.height/2);this.element.setAttributeNS(null,"r",this.radiusX);break;case"Ellipse":this.radiusX=this.width/2;this.radiusY=this.height/2;this.element.setAttributeNS(null,"cx",this.x+this.radiusX);this.element.setAttributeNS(null,"cy",this.y+this.radiusY);this.element.setAttributeNS(null,"rx",this.radiusX);this.element.setAttributeNS(null,"ry",this.radiusY);break;case"Line":if(this.x!==this.oldX){this.element.setAttributeNS(null,"x1",this.x);}if(this.y!==this.oldY){this.element.setAttributeNS(null,"y1",this.y);}if(this.x!==this.oldX||this.width!==this.oldWidth){this.element.setAttributeNS(null,"x2",this.x+this.width);}if(this.y!==this.oldY||this.height!==this.oldHeight){this.element.setAttributeNS(null,"y2",this.y+this.height);}break;case"Polyline":var d=this.element.getAttributeNS(null,"points");if(d){d=d.replace(/,/g," ").split(" ").without("");if(d&&d.length&&d.length>1){var g=(this.oldWidth===0)?0:this.width/this.oldWidth;var e=(this.oldHeight===0)?0:this.height/this.oldHeight;var b="";for(var c=0;c<d.length;c++){var a=(parseFloat(d[c])-this.oldX)*g+this.x;c++;var f=(parseFloat(d[c])-this.oldY)*e+this.y;b+=a+" "+f+" ";}this.element.setAttributeNS(null,"points",b);}else{}}else{}break;case"Path":var g=(this.oldWidth===0)?0:this.width/this.oldWidth;var e=(this.oldHeight===0)?0:this.height/this.oldHeight;this.editPathHandler.init(this.x,this.y,this.oldX,this.oldY,g,e);this.editPathParser.parsePath(this.element);this.element.setAttributeNS(null,"d",this.editPathHandler.d);break;}this.oldX=this.x;this.oldY=this.y;this.oldWidth=this.width;this.oldHeight=this.height;}delete this.visible;delete this.handler;},isPointIncluded:function(d,b){if(!d||!b||!this.isVisible()){return false;}switch(this.type){case"Rect":return(d>=this.x&&d<=this.x+this.width&&b>=this.y&&b<=this.y+this.height);break;case"Circle":return ORYX.Core.Math.isPointInEllipse(d,b,this.x+this.width/2,this.y+this.height/2,this.radiusX,this.radiusX);break;case"Ellipse":return ORYX.Core.Math.isPointInEllipse(d,b,this.x+this.radiusX,this.y+this.radiusY,this.radiusX,this.radiusY);break;case"Line":return ORYX.Core.Math.isPointInLine(d,b,this.x,this.y,this.x+this.width,this.y+this.height);break;case"Polyline":var a=this.element.getAttributeNS(null,"points");if(a){a=a.replace(/,/g," ").split(" ").without("");a=a.collect(function(e){return parseFloat(e);});return ORYX.Core.Math.isPointInPolygone(d,b,a);}else{return false;}break;case"Path":if(!this.handler){var c=new PathParser();this.handler=new ORYX.Core.SVG.PointsPathHandler();c.setHandler(this.handler);c.parsePath(this.element);}return ORYX.Core.Math.isPointInPolygone(d,b,this.handler.points);break;default:return false;}},isVisible:function(c){if(this.visible!==undefined){return this.visible;}if(!c){c=this.element;}var b=false;try{b=!!c.ownerSVGElement;}catch(g){}if(b){if(ORYX.Editor.checkClassType(c,SVGGElement)){if(c.className&&c.className.baseVal=="me"){this.visible=true;return this.visible;}}var f=c.getAttributeNS(null,"fill");var d=c.getAttributeNS(null,"stroke");if(f&&f=="none"&&d&&d=="none"){this.visible=false;}else{var a=c.getAttributeNS(null,"display");if(!a){this.visible=this.isVisible(c.parentNode);}else{if(a=="none"){this.visible=false;}else{this.visible=true;}}}}else{this.visible=true;}return this.visible;},hide:function(){if(this.hidden){return;}if(!this.parent){this.parent=this.node.parentNode;}this.visible=this.hidden=false;this.parent.removeChild(this.node);},show:function(){if(!this.hidden){return;}this.parent.appendChild(this.node);delete this.visible;delete this.hidden;},toString:function(){return(this.element)?"SVGShape "+this.element.id:"SVGShape "+this.element;}});if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.SVG){ORYX.Core.SVG={};}ORYX.Core.SVG.Label=Clazz.extend({_characterSets:["%W","@","m","wDGMOQ?#+=<>~^","ABCHKNRSUVXZ?&","bdghnopqux?ETY1234567890?_${}*`","aeksvyz?FLP?23","c-",'rtJ"/()[]:;!|\\',"fjI., ","'","il"],_characterSetValues:[15,14,13,11,10,9,8,7,6,5,4,3],construct:function(m){arguments.callee.$.construct.apply(this,arguments);this.isInitializing=true;if(!m.textElement){throw"Label: No parameter textElement.";}else{if(!ORYX.Editor.checkClassType(m.textElement,SVGTextElement)){throw"Label: Parameter textElement is not an SVGTextElement.";}}this.invisibleRenderPoint=-5000;this.node=m.textElement;this.styles={};this.defaultStyles={"font-family":"Verdana","font-size":this.node.getAttributeNS(null,"font-size")||"12","font-weight":"normal","font-style":"normal","fill":"#000000"};if(m.color){this.setFill(m.color);}this.node.setAttributeNS(null,"stroke-width","0pt");this.node.setAttributeNS(null,"letter-spacing","-0.01px");this.shapeId=m.shapeId;this.id;this.fitToElemId;this.edgePosition;this.x;this.y;this.oldX;this.oldY;this.css="";this.cssprefix=this.node.getAttributeNS(null,"class");this.isVisible=true;this.isRichtext=m.richtext;this._text;this._verticalAlign;this._horizontalAlign;this._rotate;this._rotationPoint;this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this._isChanged=true;var k=this.node.getAttributeNS(null,"id");if(k){this.id=k;}this.fitToElemId=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"fittoelem");if(this.fitToElemId){this.fitToElemId=this.shapeId+this.fitToElemId;}var f=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"align");if(f){f=f.replace(/,/g," ");f=f.split(" ");f=f.without("");f.each((function(e){switch(e){case"top":case"middle":case"bottom":if(!this._verticalAlign){this._originVerticalAlign=this._verticalAlign=e;}break;case"left":case"center":case"right":if(!this._horizontalAlign){this._originHorizontalAlign=this._horizontalAlign=e;}break;}}).bind(this));}this.edgePosition=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"edgePosition");if(this.edgePosition){this.originEdgePosition=this.edgePosition=this.edgePosition.toLowerCase();}this.offsetTop=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"offsetTop")||ORYX.CONFIG.OFFSET_EDGE_LABEL_TOP;if(this.offsetTop){this.offsetTop=parseInt(this.offsetTop);}this.offsetBottom=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"offsetBottom")||ORYX.CONFIG.OFFSET_EDGE_LABEL_BOTTOM;if(this.offsetBottom){this.offsetBottom=parseInt(this.offsetBottom);}var l=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"rotate");if(l){try{this._rotate=parseFloat(l);}catch(g){this._rotate=0;}}else{this._rotate=0;}var b=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(b){b=b.replace("/,/g"," ");var a=b.split(" ").without("");for(var d=0;d<a.length;d++){switch(a[d].toLowerCase()){case"left":this.originAnchorLeft=this.anchorLeft=true;break;case"right":this.originAnchorRight=this.anchorRight=true;break;case"top":this.originAnchorTop=this.anchorTop=true;break;case"bottom":this.originAnchorBottom=this.anchorBottom=true;break;}}}if(!this._verticalAlign){this._verticalAlign="bottom";}if(!this._horizontalAlign){this._horizontalAlign="left";}var c=this.node.getAttributeNS(null,"x");if(c){this.oldX=this.x=parseFloat(c);}else{}var h=this.node.getAttributeNS(null,"y");if(h){this.oldY=this.y=parseFloat(h);}else{}this.text(this.node.textContent);delete this.isInitializing;},resetAnchorPosition:function(){this.anchorLeft=this.originAnchorLeft||false;this.anchorRight=this.originAnchorRight||false;this.anchorTop=this.originAnchorTop||false;this.anchorBottom=this.originAnchorBottom||false;},isOriginAnchorLeft:function(){return this.originAnchorLeft||false;},isOriginAnchorRight:function(){return this.originAnchorRight||false;},isOriginAnchorTop:function(){return this.originAnchorTop||false;},isOriginAnchorBottom:function(){return this.originAnchorBottom||false;},isAnchorLeft:function(){return this.anchorLeft||false;},isAnchorRight:function(){return this.anchorRight||false;},isAnchorTop:function(){return this.anchorTop||false;},isAnchorBottom:function(){return this.anchorBottom||false;},getX:function(){try{var a=this.node.x.baseVal.getItem(0).value;switch(this.horizontalAlign()){case"left":return a;case"center":return a-(this.getWidth()/2);case"right":return a-this.getWidth();}return this.node.getBBox().x;}catch(b){return this.x;}},setX:function(a){if(this.position){this.position.x=a;}else{this.setOriginX(a);}},getY:function(){try{return this.node.getBBox().y;}catch(a){return this.y;}},setY:function(a){if(this.position){this.position.y=a;}else{this.setOriginY(a);}},setOriginX:function(a){this.x=a;},setOriginY:function(a){this.y=a;},getWidth:function(){try{try{var f,h=this.node.childNodes;if(h.length==0||!Ext.isGecko){f=this.node.getBBox().width;}else{for(var d=0,c=h.length;d<c;++d){var b=h[d].getComputedTextLength();if("undefined"==typeof f||f<b){f=b;}}}return f+(f%2==0?0:1);}catch(a){return this.node.getBBox().width;}}catch(g){return 0;}},getOriginUpperLeft:function(){var a=this.x,b=this.y;switch(this._horizontalAlign){case"center":a-=this.getWidth()/2;break;case"right":a-=this.getWidth();break;}switch(this._verticalAlign){case"middle":b-=this.getHeight()/2;break;case"bottom":b-=this.getHeight();break;}return{x:a,y:b};},getHeight:function(){try{return this.node.getBBox().height;}catch(a){return 0;}},getCenter:function(){var a={x:this.getX(),y:this.getY()};a.x+=this.getWidth()/2;a.y+=this.getHeight()/2;return a;},setPosition:function(a){if(!a||a.x===undefined||a.y===undefined){delete this.position;}else{this.position=a;}if(this.position){delete this._referencePoint;delete this.edgePosition;}this._isChanged=true;this.update();},getPosition:function(){return this.position;},setReferencePoint:function(a){if(a){this._referencePoint=a;}else{delete this._referencePoint;}if(this._referencePoint){delete this.position;}},getReferencePoint:function(){return this._referencePoint||undefined;},changed:function(){this._isChanged=true;},registerOnChange:function(a){if(!this.changeCallbacks){this.changeCallbacks=[];}if(a instanceof Function&&!this.changeCallbacks.include(a)){this.changeCallbacks.push(a);}},removeAllListeners:function(){delete this.changeCallbacks;},unregisterOnChange:function(a){if(this.changeCallbacks&&a instanceof Function&&this.changeCallbacks.include(a)){this.changeCallbacks=this.changeCallbacks.without(a);}},isUpdating:function(){return !!this._isUpdating;},getOriginEdgePosition:function(){return this.originEdgePosition;},getEdgePosition:function(){return this.edgePosition||null;},setEdgePosition:function(a){if(["starttop","startmiddle","startbottom","midtop","midbottom","endtop","endbottom"].include(a)){this.edgePosition=a;delete this.position;delete this._referencePoint;}else{delete this.edgePosition;}},strip:function(a){return a.replace(/\n/g,"<br />").replace(/<br>/g,"<br />").replace(/&nbsp;/g," ");},setBold:function(a){if(!this.isRichtext&&!this.isInitializing){return;}if(a){this.styles.bold=true;}else{delete this.styles.bold;}},getBold:function(){return !!this.styles.bold;},setItalic:function(a){if(!this.isRichtext&&!this.isInitializing){return;}if(a){this.styles.italic=true;}else{delete this.styles.italic;}},getItalic:function(){return !!this.styles.italic;},setFill:function(a){if(!this.isRichtext&&!this.isInitializing){return;}if(typeof a==="string"&&a!==this.defaultStyles["fill"]){this.styles.fill=a;}else{delete this.styles.fill;}},getFill:function(){return this.styles.fill||this.defaultStyles["fill"];},setFont:function(a){if(!this.isRichtext&&!this.isInitializing){return;}if(typeof a==="string"&&a!==this.defaultStyles["font-family"]){this.styles.font=a;}else{delete this.styles.font;}},getFont:function(){return this.styles.font||this.defaultStyles["font-family"];},setFontSize:function(a){if(!this.isRichtext&&!this.isInitializing){return;}if(typeof a==="string"&&a!==this.defaultStyles["font-size"]){this.styles.size=a;}else{delete this.styles.size;}},setStyle:function(a){if(typeof a==="object"){this.styles=Object.clone(a);}},getStyle:function(){return this.styles;},getCurrentMinValue:function(){try{if(this.node.ownerSVGElement){var c=this.node.parentNode.getScreenCTM(),a=this.node.nearestViewportElement.getScreenCTM();return{x:(a.e-c.e)+10,y:(a.f-c.f)+10};}}catch(b){}return{x:undefined,y:undefined};},update:function(f){var a=this.x,h=this.y,c=this.getCurrentMinValue();if(this.position){a=this.position.x;h=this.position.y;}a=Math.max.apply(Math,[Math.floor(a),c.x].compact());h=Math.max.apply(Math,[Math.floor(h),c.y].compact());if(this._isChanged||a!==this.oldX||h!==this.oldY||f===true){if(this.isVisible){this._isChanged=false;this._isUpdating=true;this.node.setAttributeNS(null,"x",a);this.node.setAttributeNS(null,"y",h);this.node.removeAttributeNS(null,"fill-opacity");var b=(this.cssprefix||"")+(this.css?" "+this.css:"");this.node[(b?"set":"remove")+"AttributeNS"](null,"class",b||undefined);if(this.styles.bold){this.node.setAttributeNS(null,"font-weight","bold");}else{if(this.node.hasAttributeNS(null,"font-weight")){this.node.removeAttributeNS(null,"font-weight");}}if(this.styles.italic){this.node.setAttributeNS(null,"font-style","italic");}else{if(this.node.hasAttributeNS(null,"font-style")){this.node.removeAttributeNS(null,"font-style");}}if(this.styles.fill){this.node.setAttributeNS(null,"fill",this.styles.fill);}else{if(this.node.hasAttributeNS(null,"fill")){this.node.removeAttributeNS(null,"fill");}}if(this.styles.size){this.node.setAttributeNS(null,"font-size",this.styles.size);}else{this.node.setAttributeNS(null,"font-size",this.defaultStyles["font-size"]);}this.oldX=a;this.oldY=h;if(!this.position&&!this.getReferencePoint()){if(this._rotate!==undefined){if(this._rotationPoint){this.node.setAttributeNS(null,"transform","rotate("+this._rotate+" "+Math.floor(this._rotationPoint.x)+" "+Math.floor(this._rotationPoint.y)+")");}else{this.node.setAttributeNS(null,"transform","rotate("+this._rotate+" "+Math.floor(a)+" "+Math.floor(h)+")");}}}else{this.node.setAttributeNS(null,"transform","rotate(0)");}var d=this._text.split("\n");while(d.last()==""){d.pop();}if(this.node.ownerDocument){if(this.fitToElemId||this._textHasChanged){this.node.textContent="";d.each((function(k,e){var m=this.node.ownerDocument.createElementNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");m.textContent=k.trim();if(this.fitToElemId){m.setAttributeNS(null,"x",this.invisibleRenderPoint);m.setAttributeNS(null,"y",this.invisibleRenderPoint);}var l=Ext.isChrome&&parseInt(window.navigator.userAgent.match("Chrome/([0-9]+)")[1])>=18;if(m.textContent===""&&!l){m.textContent=" ";}this.node.appendChild(m);}).bind(this));delete this._textHasChanged;delete this.indices;}if(this.isVisible&&this.fitToElemId){this.node.setAttributeNS(null,"visibility","hidden");}if(this.fitToElemId){window.setTimeout(this._checkFittingToReferencedElem.bind(this),0);}else{try{if(this.node.ownerSVGElement){this._positionText();}else{throw"Label must be appended to an SVG Element";}}catch(g){window.setTimeout(this._positionText.bind(this),1);}}}}else{this.node.setAttributeNS(null,"fill-opacity","0.2");}}else{(this.updateCallbacks||[]).each(function(e){e.apply(e);});}},registerUpdateCallback:function(a){if(!this.updateCallbacks){this.updateCallbacks=[];}if(!this.updateCallbacks.include(a)){this.updateCallbacks.push(a);}},unregisterUpdateCallback:function(a){if(this.updateCallbacks){this.updateCallbacks.remove(a);}},visible:function(){var a=this.isVisible;return a&&this.node.getAttributeNS(null,"display")!=="none";},_checkFittingToReferencedElem:function(){try{var b=$A(this.node.getElementsByTagNameNS(Ext.isChrome?"*":ORYX.CONFIG.NAMESPACE_SVG,"tspan"));var d=[];var l=this.node.ownerDocument.getElementById(this.fitToElemId)||Ext.fly(this.node).child("[id="+this.fitToElemId+"]",true);if(l){var k=l.getBBox();var s=this.getFontSize();for(var f=0;f<b.length;f++){var p=b[f];var t=this._getRenderedTextLength(p,undefined,undefined,s);var h=(this._rotate!=0&&this._rotate%180!=0&&this._rotate%90==0?k.height:k.width);this.node.setAttribute("oryx:textWidth",h);if(t>h){var q=0;var n=0;var o=this.getTrimmedTextLength(p.textContent);for(var g=0;g<o;g++){var r=this._getRenderedTextLength(p,q,g-q,s);if(r>h-2){var c=this.node.ownerDocument.createElementNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");if(n<=q){n=(g==0)?g:g-1;c.textContent=p.textContent.slice(q,n).trim();}else{c.textContent=p.textContent.slice(q,++n).trim();}c.setAttributeNS(null,"x",this.invisibleRenderPoint);c.setAttributeNS(null,"y",this.invisibleRenderPoint);d.push(c);q=n;}else{var a=p.textContent.charAt(g);if(a==" "||a=="-"||a=="."||a==","||a==";"||a==":"){n=g;}}}p.textContent=p.textContent.slice(q).trim();}d.push(p);}while(this.node.hasChildNodes()){this.node.removeChild(this.node.childNodes[0]);}while(d.length>0){this.node.appendChild(d.shift());}}}catch(m){}window.setTimeout(this._positionText.bind(this),0);},_getMaxFontSize:function(a){var b=0;a.each(function(c){b=Math.max(b,this._getAttribute("font-size",c));}.bind(this));return b>0?b:this.defaultStyles["font-size"];},_positionText:function(){try{var d=this.node.getElementsByTagNameNS(Ext.isChrome?"*":ORYX.CONFIG.NAMESPACE_SVG,"tspan");var t=this.getFontSize(d[0]);var b=[];var q=this.x,p=this.y,h=this.getCurrentMinValue();if(this.position){q=this.position.x;p=this.position.y;}q=Math.max.apply(Math,[Math.floor(q),h.x].compact());p=Math.max.apply(Math,[Math.floor(p),h.y].compact());var k=0,a=[];var m=(this.indices||$R(0,d.length-1).toArray());var c=m.length;var o=this.getFont();var f={arial:0.95,courier_new:0.82,helvetica:0.95,tahoma:1,times_new_roman:0.93,verdana:1};var s=(f[o.toLowerCase().replace(/( +)+/g,"_")]||1);m.each((function(u){if("undefined"==typeof u){return;}var v=d[k++];if(v.textContent.trim()===""){b.push(v);}else{var e=0;switch(this._verticalAlign){case"bottom":e=-(c-u-1)*(t);break;case"middle":e=t/2*(s-ORYX.CONFIG.LABEL_LINE_DISTANCE/6-(c-1)+2*u);break;case"top":e=u*(t);e+=t;break;}v.setAttributeNS(null,"dy",Math.floor(e));v.setAttributeNS(null,"x",q);v.setAttributeNS(null,"y",p);a.push(u);}}).bind(this));a.length=d.length;this.indices=this.indices||a;b.each(function(e){this.node.removeChild(e);}.bind(this));switch(this._horizontalAlign){case"left":this.node.setAttributeNS(null,"text-anchor","start");break;case"center":this.node.setAttributeNS(null,"text-anchor","middle");break;case"right":this.node.setAttributeNS(null,"text-anchor","end");break;}}catch(n){this._isChanged=true;}if(this.isVisible){this.node.removeAttributeNS(null,"visibility");}if(Ext.isChrome||Ext.isSafari){var g=this.node,r=g.parentNode,l=g.nextSibling;r.removeChild(g);r[l?"insertBefore":"appendChild"](g,l);if(g.textContent===""){g.style.display="none";}else{g.style.display="";}}(this.updateCallbacks||[]).each(function(e){e();});delete this._isUpdating;if(!this.eventsSuspended){(this.changeCallbacks||[]).each(function(e){e.apply(e);});if(this.resumeAfterUpdate){this.resumeEvents();}}},isDirty:function(){var a=this.x,c=this.y,b=this.getCurrentMinValue();if(this.position){a=this.position.x;c=this.position.y;}a=Math.max.apply(Math,[Math.floor(a),b.x].compact());c=Math.max.apply(Math,[Math.floor(c),b.y].compact());return(this._isChanged||a!==this.oldX||c!==this.oldY)&&this.isVisible;},suspendEvents:function(a){this.eventsSuspended=true;this.resumeAfterUpdate=a===true;},resumeEvents:function(){delete this.eventsSuspended;delete this.resumeAfterUpdate;},_getRenderedTextLength:function(c,d,b,a){if(/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)&&new Number(RegExp.$1)>=3){if(d===undefined){return c.getComputedTextLength();}else{return c.getSubStringLength(d,b);}}else{if(d===undefined){return this._estimateTextWidth(c.textContent.trim(),a);}else{return this._estimateTextWidth(c.textContent.substr(d,b).trim(),a);}}},_estimateTextWidth:function(d,c){var b=0;for(var a=0;a<d.length;a++){b+=this._estimateCharacterWidth(d.charAt(a));}return b*(c/14);},_estimateCharacterWidth:function(b){for(var a=0;a<this._characterSets.length;a++){if(this._characterSets[a].indexOf(b)>=0){return((this.styles.bold||this.styles.size<12)?1.2:1)*this._characterSetValues[a];}}return 9;},getReferencedElementWidth:function(){var a=this.node.ownerDocument.getElementById(this.fitToElemId)||Ext.fly(this.node.parentNode||this.node).child("[id="+this.fitToElemId+"]",true);if(a){try{var b=a.getBBox();if(b){return(this._rotate!=0&&this._rotate%180!=0&&this._rotate%90==0?b.height:b.width);}}catch(c){return(this._rotate!=0&&this._rotate%180!=0&&this._rotate%90==0?(a.height?a.height.baseVal.value:undefined):(a.width?a.width.baseVal.value:undefined))||undefined;}}return undefined;},text:function(){switch(arguments.length){case 0:return this._text;break;case 1:var a=this._text,b=String(arguments[0]);if(b){this._text=b;}else{this._text="";}if(a!==this._text){this._isChanged=true;this._textHasChanged=true;}break;default:break;}},getOriginVerticalAlign:function(){return this._originVerticalAlign;},verticalAlign:function(){switch(arguments.length){case 0:return this._verticalAlign;case 1:if(["top","middle","bottom"].member(arguments[0])){var a=this._verticalAlign;this._verticalAlign=arguments[0];if(this._verticalAlign!==a){this._isChanged=true;}}break;default:break;}},getOriginHorizontalAlign:function(){return this._originHorizontalAlign;},horizontalAlign:function(){switch(arguments.length){case 0:return this._horizontalAlign;case 1:if(["left","center","right"].member(arguments[0])){var a=this._horizontalAlign;this._horizontalAlign=arguments[0];if(this._horizontalAlign!==a){this._isChanged=true;}}break;default:break;}},rotate:function(){switch(arguments.length){case 0:return this._rotate;case 1:if(this._rotate!=arguments[0]){this._rotate=arguments[0];this._rotationPoint=undefined;this._isChanged=true;}case 2:if(this._rotate!=arguments[0]||!this._rotationPoint||this._rotationPoint.x!=arguments[1].x||this._rotationPoint.y!=arguments[1].y){this._rotate=arguments[0];this._rotationPoint=arguments[1];this._isChanged=true;}}},hide:function(){if(this.isVisible){this.isVisible=false;this._isChanged=true;}},show:function(){if(!this.isVisible){this.isVisible=true;this._isChanged=true;}},getInheritedFontSize:function(b){if(!b||!b.getAttributeNS){return;}var a=b.getAttributeNS(null,"font-size");if(a){return parseFloat(a);}else{if(!ORYX.Editor.checkClassType(b,SVGSVGElement)){return this.getInheritedFontSize(b.parentNode);}}},getFontSize:function(b){var a=this.node.getElementsByTagNameNS(Ext.isChrome?"*":ORYX.CONFIG.NAMESPACE_SVG,"tspan");var c=this.getInheritedFontSize(this.node);if(!c){if(a[0]&&/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)&&new Number(RegExp.$1)>=3){try{c=a[0].getExtentOfChar(0).height;}catch(d){}}else{c=ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT;}if(c<=0){c=ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT;}}if(c){this.node.setAttribute("oryx:fontSize",c);}return c;},getTrimmedTextLength:function(b){b=b.strip().gsub("  "," ");var a;do{a=b.length;b=b.gsub("  "," ");}while(a>b.length);return b.length;},getOffsetBottom:function(){return this.offsetBottom;},getOffsetTop:function(){return this.offsetTop;},hasStyles:function(a){return $H(a||this.styles).keys().length>0;},deserialize:function(c,a){if(c&&"undefined"!=typeof c.x&&"undefined"!=typeof c.y){this.setPosition({x:Number(c.x)||0,y:Number(c.y)||0});if("undefined"!=typeof c.distance){var e=a.dockers[c.from];var d=a.dockers[c.to];if(e&&d){this.setReferencePoint({dirty:true,distance:Number(c.distance)||0,intersection:{x:Number(c.x)||0,y:Number(c.y)||0},orientation:c.orientation,segment:{from:e,fromIndex:c.from,fromPosition:e.bounds.center(),to:d,toIndex:c.to,toPosition:d.bounds.center()}});}}if(c.left){this.anchorLeft=true;}if(c.right){this.anchorRight=true;}if(c.top){this.anchorTop=true;}if(c.bottom){this.anchorBottom=true;}if(c.valign){this.verticalAlign(c.valign);}if(c.align){this.horizontalAlign(c.align);}this.updated=true;}else{if(c&&"undefined"!=typeof c.edge){this.setEdgePosition(c.edge);this.updated=true;}}if(c&&c.styles&&this.hasStyles(c.styles)){var b=c.styles;if(b.bold){this.setBold(true);}if(b.italic){this.setItalic(true);}if(b.fill){this.setFill(b.fill);}if(b.font){this.setFont(b.font);}if(b.size){this.setFontSize(b.size);}}},serialize:function(){var c={},a={};if(this.hasStyles()){c={styles:this.styles};}else{c=null;}if(this.getEdgePosition()){if(this.getOriginEdgePosition()!==this.getEdgePosition()){return Ext.apply(a,{edge:this.getEdgePosition()},c);}else{return c?Ext.apply(a,null,c):null;}}if(this.position){var d={x:this.position.x,y:this.position.y};if(this.isAnchorLeft()&&this.isAnchorLeft()!==this.isOriginAnchorLeft()){d.left=true;}if(this.isAnchorRight()&&this.isAnchorRight()!==this.isOriginAnchorRight()){d.right=true;}if(this.isAnchorTop()&&this.isAnchorTop()!==this.isOriginAnchorTop()){d.top=true;}if(this.isAnchorBottom()&&this.isAnchorBottom()!==this.isOriginAnchorBottom()){d.bottom=true;}if(this.getOriginVerticalAlign()!==this.verticalAlign()){d.valign=this.verticalAlign();}if(this.getOriginHorizontalAlign()!==this.horizontalAlign()){d.align=this.horizontalAlign();}return Ext.apply(a,d,c);}if(this.getReferencePoint()){var b=this.getReferencePoint();return Ext.apply(a,{distance:b.distance,x:b.intersection.x,y:b.intersection.y,from:b.segment.fromIndex,to:b.segment.toIndex,orientation:b.iorientation||b.orientation,valign:this.verticalAlign(),align:this.horizontalAlign()},c);}return c?Ext.apply(a,null,c):null;},toString:function(){return"Label "+this.id;}});if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.Math){ORYX.Core.Math={};}ORYX.Core.Math.midPoint=function(b,a){return{x:(b.x+a.x)/2,y:(b.y+a.y)/2};};ORYX.Core.Math.isPointInLine=function(h,f,g,e,b,a,d){d=d?Math.abs(d):1;if(Math.abs(g-b)<=d&&Math.abs(h-g)<=d&&f-Math.max(e,a)<=d&&Math.min(e,a)-f<=d){return true;}if(Math.abs(e-a)<=d&&Math.abs(f-e)<=d&&h-Math.max(g,b)<=d&&Math.min(g,b)-h<=d){return true;}if(h>Math.max(g,b)||h<Math.min(g,b)){return false;}if(f>Math.max(e,a)||f<Math.min(e,a)){return false;}var c=(e-a)/(g-b);return Math.abs(f-((c*h)+e-c*g))<d;};ORYX.Core.Math.isPointInEllipse=function(h,f,b,g,e,d){if(b===undefined||g===undefined||e===undefined||d===undefined){throw"ORYX.Core.Math.isPointInEllipse needs a ellipse with these properties: x, y, radiusX, radiusY";}var c=(h-b)/e;var a=(f-g)/d;return c*c+a*a<1;};ORYX.Core.Math.isPointInPolygone=function(a,n,e){if(arguments.length<3){throw"ORYX.Core.Math.isPointInPolygone needs two arguments";}var g=e.length-1;if(e[0]!==e[g-1]||e[1]!==e[g]){e.push(e[0]);e.push(e[1]);}var h=0;var c,m,b,l,k;for(var f=0;f<e.length-3;){c=e[f];m=e[++f];b=e[++f];l=e[f+1];k=(n-m)*(b-c)-(a-c)*(l-m);if((m>=n)!=(l>=n)){h+=l-m>=0?k>=0:k<=0;}if(!k&&Math.min(c,b)<=a&&a<=Math.max(c,b)&&Math.min(m,l)<=n&&n<=Math.max(m,l)){return true;}}return(h%2)?true:false;};ORYX.Core.Math.distancePointLinie=function(e,d,a,b){var c=ORYX.Core.Math.getPointOfIntersectionPointLine(e,d,a,b);if(!c){return null;}return ORYX.Core.Math.getDistancePointToPoint(a,c);};ORYX.Core.Math.getDistancePointToPoint=function(b,a){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2));};ORYX.Core.Math.getDistanceBetweenTwoPoints=function(c,b,a){return ORYX.Core.Math.getDistancePointToPoint(a,c)/ORYX.Core.Math.getDistancePointToPoint(c,b);};ORYX.Core.Math.pointIsLeftOfLine=function(e,d,a){var c=ORYX.Core.Math.getVector(e,d);var b=ORYX.Core.Math.getVector(e,a);return((c.x*b.y)-(b.x*c.y))>0;};ORYX.Core.Math.getPointBetweenTwoPoints=function(b,a,c){c=Math.max(Math.min(c||0,1),0);if(c===0){return b;}else{if(c===1){return a;}}return{x:b.x+((a.x-b.x)*c),y:b.y+((a.y-b.y)*c)};};ORYX.Core.Math.getVector=function(b,a){return{x:a.x-b.x,y:a.y-b.y};};ORYX.Core.Math.getIdentityVector=function(a){if(arguments.length==2){a=ORYX.Core.Math.getVector(arguments[0],arguments[1]);}var b=Math.sqrt((a.x*a.x)+(a.y*a.y));return{x:a.x/(b||1),y:a.y/(b||1)};};ORYX.Core.Math.getOrthogonalIdentityVector=function(c,b){var a=arguments.length==1?c:ORYX.Core.Math.getIdentityVector(c,b);return{x:a.y,y:-a.x};};ORYX.Core.Math.getPointOfIntersectionPointLine=function(f,c,a,e){var d=Math.pow(c.x-f.x,2)+Math.pow(c.y-f.y,2);if(d==0){return undefined;}var b=((a.x-f.x)*(c.x-f.x)+(a.y-f.y)*(c.y-f.y))/d;if(e){if(!(0<=b&&b<=1)){return undefined;}}pointOfIntersection=new Object();pointOfIntersection.x=f.x+b*(c.x-f.x);pointOfIntersection.y=f.y+b*(c.y-f.y);return pointOfIntersection;};ORYX.Core.Math.getTranslatedPoint=function(b,c){var a=c.a*b.x+c.c*b.y+c.e*1;var d=c.b*b.x+c.d*b.y+c.f*1;return{x:a,y:d};};ORYX.Core.Math.getInverseMatrix=function(b){var c=ORYX.Core.Math.getDeterminant(b),a=b;return{a:c*((a.d*1)-(a.f*0)),b:c*((a.f*0)-(a.b*1)),c:c*((a.e*0)-(a.c*1)),d:c*((a.a*1)-(a.e*0)),e:c*((a.c*a.f)-(a.e*a.d)),f:c*((a.e*a.b)-(a.a*a.f))};};ORYX.Core.Math.getDeterminant=function(a){return(a.a*a.d*1)+(a.c*a.f*0)+(a.e*a.b*0)-(a.e*a.d*0)-(a.c*a.b*1)-(a.a*a.f*0);};ORYX.Core.Math.getTranslatedBoundingBox=function(a){var h=a.getCTM();var f=a.getBBox();var e=ORYX.Core.Math.getTranslatedPoint({x:f.x,y:f.y},h);var g=ORYX.Core.Math.getTranslatedPoint({x:f.x,y:f.y+f.height},h);var b=ORYX.Core.Math.getTranslatedPoint({x:f.x+f.width,y:f.y},h);var c=ORYX.Core.Math.getTranslatedPoint({x:f.x+f.width,y:f.y+f.height},h);var k={x:Math.min(e.x,g.x,b.x,c.x),y:Math.min(e.y,g.y,b.y,c.y)};var d={x:Math.max(e.x,g.x,b.x,c.x),y:Math.max(e.y,g.y,b.y,c.y)};return{x:k.x,y:k.y,width:d.x-k.x,height:d.y-k.y};};ORYX.Core.Math.getAngle=function(c,a){if(c.x==a.x&&c.y==a.y){return 0;}var b=Math.asin(Math.sqrt(Math.pow(c.y-a.y,2))/(Math.sqrt(Math.pow(a.x-c.x,2)+Math.pow(c.y-a.y,2))))*180/Math.PI;if(a.x>=c.x&&a.y<=c.y){return b;}else{if(a.x<c.x&&a.y<=c.y){return 180-b;}else{if(a.x<c.x&&a.y>c.y){return 180+b;}else{return 360-b;}}}};new function(){var b=2,c=8,e=4,a=1;function d(g,n,m,k,h,f){var l=0;if(n>f){l|=c;}else{if(n<k){l|=e;}}if(g>h){l|=b;}else{if(g<m){l|=a;}}return l;}ORYX.Core.Math.isRectOverLine=function(k,n,g,m,o,l,h,f){return !!ORYX.Core.Math.clipLineOnRect.apply(ORYX.Core.Math,arguments);};ORYX.Core.Math.getIntersectionPointOfRect=function(h,n,g,m,f,o,l,k){var p=ORYX.Core.Math.clipLineOnRect(h,n,g,m,f,o,l,k);if(p){if((p.a.x==h&&p.a.y==n)||(p.a.x==g&&p.a.y==m)){return p.b;}else{if(p.b.x==h&&p.b.y==n||(p.b.x==g&&p.b.y==m)){return p.a;}}}return null;};ORYX.Core.Math.clipLineOnRect=function(h,u,g,s,f,v,q,l){var m,k,p,z=0;var n=false,o=false;m=d(h,u,f,v,q,l);k=d(g,s,f,v,q,l);do{if((m|k)==0){n=true;o=true;}else{if((m&k)>0){o=true;}else{var t=0,r=0;p=m!=0?m:k;if((p&c)>0){t=h+(g-h)*(l-u)/(s-u);r=l;}else{if((p&e)>0){t=h+(g-h)*(v-u)/(s-u);r=v;}else{if((p&b)>0){r=u+(s-u)*(q-h)/(g-h);t=q;}else{if((p&a)>0){r=u+(s-u)*(f-h)/(g-h);t=f;}}}}if(p==m){h=t;u=r;m=d(h,u,f,v,q,l);}else{g=t;s=r;k=d(g,s,f,v,q,l);}}}z++;}while(o!=true&&z<5000);if(n){return{a:{x:h,y:u},b:{x:g,y:s}};}return null;};}();if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}ORYX.Core.StencilSet.Stencil={construct:function(d,e,a,l,k,h){arguments.callee.$.construct.apply(this,arguments);if(!d){throw"Stencilset seems corrupt.";}if(!e){throw"Stencil does not provide namespace.";}if(!a){throw"Stencil does not provide SVG source.";}if(!l){throw"Fatal internal error loading stencilset.";}this._source=a;this._jsonStencil=Object.clone(d);this._stencilSet=l;this._namespace=e;this._propertyPackages=k;if(h&&!this._jsonStencil.position){this._jsonStencil.position=h;}this._view;this._properties=new Hash();this._overwrittenProperties=new Hash();if(!this._jsonStencil.type||!(this._jsonStencil.type==="edge"||this._jsonStencil.type==="node")){throw"ORYX.Core.StencilSet.Stencil(construct): Type is not defined.";}if(!this._jsonStencil.id||this._jsonStencil.id===""){throw"ORYX.Core.StencilSet.Stencil(construct): Id is not defined.";}if(!this._jsonStencil.title||this._jsonStencil.title===""){throw"ORYX.Core.StencilSet.Stencil(construct): Title is not defined.";}if(!this._jsonStencil.description){this._jsonStencil.description="";}if(!this._jsonStencil.groups){this._jsonStencil.groups=[];}if(!this._jsonStencil.roles){this._jsonStencil.roles=[];}this._jsonStencil.roles.push(this._jsonStencil.id);this._jsonStencil.roles.each((function(n,m){this._jsonStencil.roles[m]=e+n;}).bind(this));this._jsonStencil.roles=this._jsonStencil.roles.uniq();this._jsonStencil.id=e+this._jsonStencil.id;this.postProcessProperties();if(!this._jsonStencil.serialize){this._jsonStencil.serialize={};}if(!this._jsonStencil.deserialize){this._jsonStencil.deserialize={};}if(!this._jsonStencil.layout){this._jsonStencil.layout=[];}if(!this._jsonStencil.keepState){this._jsonStencil.keepState=false;}if(!this._jsonStencil.hide){this._jsonStencil.hide=false;}var c=a+"view/"+d.view;if(this._jsonStencil.view.trim().match(/</)){var b=new DOMParser();var f=b.parseFromString(this._jsonStencil.view,"text/xml");if(ORYX.Editor.checkClassType(f.documentElement,SVGSVGElement)){this._view=f.documentElement;var g=this._view.getElementsByTagNameNS("http://www.w3.org/2000/svg","image");$A(g).each((function(n){var m=n.getAttributeNodeNS("http://www.w3.org/1999/xlink","href");if(m&&m.value.indexOf("://")==-1){m.textContent=this._source+"view/"+m.value;}}).bind(this));}else{throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnSuccess): The response is not a SVG document.";}}else{new Ajax.Request(c,{asynchronous:false,method:"get",onSuccess:this._loadSVGOnSuccess.bind(this),onFailure:this._loadSVGOnFailure.bind(this)});}},postProcessProperties:function(){if(this._jsonStencil.icon&&this._jsonStencil.icon.indexOf("://")===-1){this._jsonStencil.icon=this._source+"icons/"+this._jsonStencil.icon;}else{this._jsonStencil.icon="";}if(this._jsonStencil.propertyPackages&&this._jsonStencil.propertyPackages instanceof Array){this._jsonStencil.propertyPackages.each((function(b){var a=this._propertyPackages[b];if(a){a.each((function(c){this.addProperty(c,this._namespace);}).bind(this));}}).bind(this));}if(this._jsonStencil.properties&&this._jsonStencil.properties instanceof Array){this._jsonStencil.properties.each((function(a){this.addProperty(a,this._namespace);}).bind(this));}},equals:function(a){return(this.id()===a.id());},stencilSet:function(){return this._stencilSet;},type:function(){return this._jsonStencil.type;},namespace:function(){return this._namespace;},id:function(){return this._jsonStencil.id;},idWithoutNs:function(){return this.id().replace(this.namespace(),"");},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"title");},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"description");},groups:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"groups");},position:function(){return(isNaN(this._jsonStencil.position)?0:this._jsonStencil.position);},view:function(){return this._view.cloneNode(true)||this._view;},icon:function(){return this._jsonStencil.icon;},fixedAspectRatio:function(){return this._jsonStencil.fixedAspectRatio===true;},hasMultipleRepositoryEntries:function(){return(this.getRepositoryEntries().length>0);},getRepositoryEntries:function(){return(this._jsonStencil.repositoryEntries)?$A(this._jsonStencil.repositoryEntries):$A([]);},properties:function(){return this._properties.values();},property:function(a){return this._properties[a];},overwrittenProperty:function(a){return this._overwrittenProperties[a]||undefined;},roles:function(){return this._jsonStencil.roles;},hide:function(){return this._jsonStencil.hide;},index:function(){return this._jsonStencil.index||null;},defaultAlign:function(f){if(f instanceof ORYX.Core.Shape){var l=f.getParentShape();var g=this._defaultAlignHasParentDefinition();while(l&&!(l instanceof ORYX.Core.Canvas)){var e=l.getStencil().idWithoutNs();var h=(g?this._getAlignForParent(e):undefined);if(h&&h.align){return h.align;}var b=this._getChildrenDefaultAlign(l);if(b){return b;}l=l.getParentShape();}}var c=f.getCanvas().getOrientation();var k=this._getDefaultAlignment(c);if(k){return k;}if(f instanceof ORYX.Core.Shape){var d={horizontal:"east",vertical:"south"};if(d[c]){return d[c];}}return"east";},_getDefaultAlignment:function(c){if(this._isDefaultAlignDefined()){var b=(c?this._getAlignForOrientation(c):undefined);if(b&&b.align){return b.align;}var d=this._jsonStencil.defaultAlign.find(function(e){return !e.parentRole&&!e.orientation&&e.align;});return(d?d.align:undefined);}if(typeof this._jsonStencil.defaultAlign==="string"){return this._jsonStencil.defaultAlign;}},_getAlignForParent:function(a){return this._jsonStencil.defaultAlign.find(function(b){return b.parentRole===a;});},_getAlignForOrientation:function(a){return this._jsonStencil.defaultAlign.find(function(b){return b.orientation===a;});},_getChildrenDefaultAlign:function(a){if(!(a instanceof ORYX.Core.Shape)){return;}if(!a.getStencil()._isDefaultAlignDefined()){return;}var b=a.getStencil()._jsonStencil.defaultAlign.find(function(c){return !!c.childrenDefaultAlign;});return(b?b.childrenDefaultAlign:undefined);},_isDefaultAlignDefined:function(){return this._jsonStencil.defaultAlign instanceof Array;},_defaultAlignHasParentDefinition:function(){return this._isDefaultAlignDefined()&&this._jsonStencil.defaultAlign.any(function(a){return !!a.parentRole;});},serialize:function(a,b){return this._jsonStencil.serialize;},deserialize:function(a,b){return this._jsonStencil.deserialize;},layout:function(a){return this._jsonStencil.layout;},keepState:function(){return this._jsonStencil.keepState;},addProperty:function(c,b,g){if(c instanceof ORYX.Core.StencilSet.Property){b=c.namespace();c=c._jsonProp;}if(c&&b){var a=new ORYX.Core.StencilSet.Property(c,b,this);var f=a.prefix()+"-"+a.id();if(this._properties[f]){if(!this._overwrittenProperties[f]){this._overwrittenProperties[f]=this._properties[f];}delete this._properties[f];}this._properties[f]=a;if(g!==true&&$H(ORYX.CONFIG.MULTI_LANGUAGES||{}).size()>0&&[ORYX.CONFIG.TYPE_TEXT,ORYX.CONFIG.TYPE_STRING].include(a.type())){var d=$H(ORYX.CONFIG.MULTI_LANGUAGES||{}),e=ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT||d.keys()[0];d.keys().each(function(h){if(h===e){a._jsonProp.language=String(h).toLowerCase();}else{var k=Object.clone(c);k.language=String(h).toLowerCase();k.id=k.id+"_"+k.language;k.origin=a;this.addProperty(k,b,true);}}.bind(this));}}},removeProperty:function(b){if(b){var a=this._properties.values().find(function(c){return(b==c.id());});if(a){delete this._properties[a.prefix()+"-"+a.id()];}}},_loadSVGOnSuccess:function(a){var b=null;b=a.responseXML;if(!ORYX.Editor.checkClassType(b.documentElement,SVGSVGElement)){var d=new DOMParser();b=d.parseFromString(a.responseText,"text/xml");}if(ORYX.Editor.checkClassType(b.documentElement,SVGSVGElement)){this._view=b.documentElement;var c=this._view.getElementsByTagNameNS("http://www.w3.org/2000/svg","image");$A(c).each((function(f){var e=f.getAttributeNodeNS("http://www.w3.org/1999/xlink","href");if(e&&e.value.indexOf("://")==-1){e.textContent=this._source+"view/"+e.value;}}).bind(this));}else{throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnSuccess): The response is not a SVG document.";}},_loadSVGOnFailure:function(a){throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnFailure): Loading SVG document failed.";},toString:function(){return"Stencil "+this.title()+" ("+this.id()+")";}};ORYX.Core.StencilSet.Stencil=Clazz.extend(ORYX.Core.StencilSet.Stencil);function _evenMoreEvilHack(c,e){if(window.ActiveXObject){var b=new ActiveXObject("MSXML.DomDocument");b.loadXML(c);return b;}else{if(window.XMLHttpRequest){var a=new XMLHttpRequest;a.open("GET","data:"+(e||"application/xml")+";charset=utf-8,"+encodeURIComponent(c),false);if(a.overrideMimeType){a.overrideMimeType(e);}a.send(null);return a.responseXML;}}}function _evilSafariHack(d){var b=d;var a="data:text/xml;charset=utf-8,"+encodeURIComponent(b);var e=null;var c=new XMLHttpRequest();c.open("GET",a);c.onload=function(){e=c.responseXML;};c.send(null);return e;}if("undefined"==typeof ORYX){var ORYX={};}if("undefined"==typeof ORYX.Core){ORYX.Core={};}if("undefined"==typeof ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}new function(){ORYX.Core.StencilSet.Property=Clazz.extend({construct:function(d,b,c){arguments.callee.$.construct.apply(this,arguments);this._jsonProp=d||ORYX.Log.error("Parameter jsonProp is not defined.");this._namespace=b||ORYX.Log.error("Parameter namespace is not defined.");this._stencil=c||ORYX.Log.error("Parameter stencil is not defined.");this._items={};this._complexItems={};d.id=d.id||ORYX.Log.error("ORYX.Core.StencilSet.Property(construct): Id is not defined.");d.id=d.id.toLowerCase();if(!d.type){ORYX.Log.info("Type is not defined for stencil '%0', id '%1'. Falling back to 'String'.",c,d.id);d.type="string";}else{d.type=d.type.toLowerCase();}d.prefix=d.prefix||"oryx";d.title=d.title||"";d.value=d.value||"";d.description=d.description||"";d.readonly=d.readonly||false;d.optional=d.optional!==false;if(this._jsonProp.refToView){if(!(this._jsonProp.refToView instanceof Array)){this._jsonProp.refToView=[this._jsonProp.refToView];}}else{this._jsonProp.refToView=[];}var a=this.getMinForType(d.type);if(d.min===undefined||d.min===null){d.min=a;}else{if(d.min<a){d.min=a;}}var e=this.getMaxForType(d.type);if(d.max===undefined||d.max===null){d.max=e;}else{if(d.max>e){d.min=e;}}if(!d.fillOpacity){d.fillOpacity=false;}if("number"!=typeof d.lightness){d.lightness=1;}else{d.lightness=Math.max(0,Math.min(1,d.lightness));}if(!d.strokeOpacity){d.strokeOpacity=false;}if(d.length===undefined||d.length===null){d.length=Number.MAX_VALUE;}if(!d.wrapLines){d.wrapLines=false;}if(!d.dateFormat){d.dateFormat=ORYX.I18N.PropertyWindow.dateFormat||"m/d/y";}if(!d.fill){d.fill=false;}if(!d.stroke){d.stroke=false;}if(!d.inverseBoolean){d.inverseBoolean=false;}if(!d.directlyEditable&&d.directlyEditable!=false){d.directlyEditable=true;}if(d.visible!==false){d.visible=true;}if(d.isList!==true){d.isList=false;if(!d.list||!(d.list instanceof Array)){d.list=[];}}if(!d.category){if(d.popular){d.category="popular";}}if(!d.alwaysAppearInMultiselect){d.alwaysAppearInMultiselect=false;}if(!d.allowCustomValue){d.allowCustomValue=false;}d.dependsOn=$H(d.dependsOn||{});d.hasDependencies=d.dependsOn.size()>0;d.autocomplete=d.autocomplete&&d.autocomplete.url?d.autocomplete:false;if(d.type===ORYX.CONFIG.TYPE_CHOICE){if(d.items&&d.items instanceof Array){d.items.each((function(f){var g=(f.value||f.id).toLowerCase();if(g){this._items[g]=new ORYX.Core.StencilSet.PropertyItem(f,b,this);}}).bind(this));}else{throw"ORYX.Core.StencilSet.Property(construct): No property items defined.";}}else{if(d.type===ORYX.CONFIG.TYPE_COMPLEX){if(d.complexItems&&d.complexItems instanceof Array){d.complexItems.each((function(f){this._complexItems[f.id.toLowerCase()]=new ORYX.Core.StencilSet.ComplexPropertyItem(f,b,this);}).bind(this));}else{throw"ORYX.Core.StencilSet.Property(construct): No complex property items defined.";}}}},getMinForType:function(a){if(a.toLowerCase()==ORYX.CONFIG.TYPE_INTEGER){return -Math.pow(2,31);}else{return -Number.MAX_VALUE+1;}},getMaxForType:function(a){if(a.toLowerCase()==ORYX.CONFIG.TYPE_INTEGER){return Math.pow(2,31)-1;}else{return Number.MAX_VALUE;}},equals:function(a){return(this._namespace===a.namespace()&&this.id()===a.id())?true:false;},namespace:function(){return this._namespace;},stencil:function(){return this._stencil;},id:function(){return this._jsonProp.id;},prefix:function(){return this._jsonProp.prefix;},type:function(){return this._jsonProp.type;},inverseBoolean:function(){return this._jsonProp.inverseBoolean;},category:function(){return this._jsonProp.category;},config:function(){return this._jsonProp.config||{};},setCategory:function(a){this._jsonProp.category=a;},directlyEditable:function(){return this._jsonProp.directlyEditable;},visible:function(){return this._jsonProp.visible;},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"title");},value:function(){return this._jsonProp.value;},readonly:function(){return this._jsonProp.readonly;},optional:function(){return this._jsonProp.optional;},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"description");},refToView:function(){return this._jsonProp.refToView;},min:function(){return this._jsonProp.min;},max:function(){return this._jsonProp.max;},fillOpacity:function(){return this._jsonProp.fillOpacity;},strokeOpacity:function(){return this._jsonProp.strokeOpacity;},length:function(){return this._jsonProp.length?this._jsonProp.length:Number.MAX_VALUE;},wrapLines:function(){return this._jsonProp.wrapLines;},dateFormat:function(){return this._jsonProp.dateFormat;},fill:function(){return this._jsonProp.fill;},lightness:function(){return this._jsonProp.lightness;},stroke:function(){return this._jsonProp.stroke;},items:function(){return $H(this._items).values();},item:function(a){if(a){return this._items[a.toLowerCase()];}else{return null;}},toString:function(){return"Property "+this.title()+" ("+this.id()+")";},complexItems:function(){return $H(this._complexItems).values();},complexItem:function(a){if(a){return this._complexItems[a.toLowerCase()];}else{return null;}},complexAttributeToView:function(){return this._jsonProp.complexAttributeToView||"";},isList:function(){return !!this._jsonProp.isList;},getListItems:function(){return this._jsonProp.list;},linkableType:function(){return this._jsonProp.linkableType||"";},alwaysAppearInMultiselect:function(){return this._jsonProp.alwaysAppearInMultiselect;},allowCustomValue:function(){return !this._jsonProp.allowCustomValue;},dependsOn:function(){return this._jsonProp.dependsOn;},dependentProperties:function(){if(!this._dependentProperties){var a=this.id();this._dependentProperties=this.stencil().properties().findAll(function(b){return !!b.dependsOn()[a];});}return this._dependentProperties;},hasValidDependency:function(a){if(this._jsonProp.hasDependencies){var c=this._jsonProp.dependsOn,b=this.prefix();return c.keys().all(function(d){return a[b+"-"+d]==c[d];});}return true;},autocomplete:function(){return this._jsonProp.autocomplete;},language:function(){return this._jsonProp.language||undefined;},origin:function(){return this._jsonProp.origin||this;},isBackgroundColor:function(){return this._jsonProp.type==="color"&&this._jsonProp.fill&&!this._jsonProp.stroke&&this._jsonProp.refToView;},isBorderColor:function(){return this._jsonProp.type==="color"&&this._jsonProp.stroke&&this._jsonProp.refToView;},defaultValueReadOnly:function(){return this._jsonProp.defaultValueReadOnly===true;}});}();if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}ORYX.Core.StencilSet.PropertyItem=Clazz.extend({construct:function(a,b,c){arguments.callee.$.construct.apply(this,arguments);if(!a){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter jsonItem is not defined.";}if(!b){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter namespace is not defined.";}if(!c){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter property is not defined.";}this._jsonItem=a;this._namespace=b;this._property=c;if(!a.value){throw"ORYX.Core.StencilSet.PropertyItem(construct): Value is not defined.";}if(this._jsonItem.refToView){if(!(this._jsonItem.refToView instanceof Array)){this._jsonItem.refToView=[this._jsonItem.refToView];}}else{this._jsonItem.refToView=[];}},equals:function(a){return(this.property().equals(a.property())&&this.value()===a.value());},namespace:function(){return this._namespace;},property:function(){return this._property;},value:function(){return this._jsonItem.value;},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"title");},refToView:function(){return this._jsonItem.refToView;},icon:function(){return(this._jsonItem.icon)?this.property().stencil()._source+"icons/"+this._jsonItem.icon:"";},toString:function(){return"PropertyItem "+this.property()+" ("+this.value()+")";}});if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}ORYX.Core.StencilSet.ComplexPropertyItem=Clazz.extend({construct:function(a,b,c){arguments.callee.$.construct.apply(this,arguments);if(!a){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter jsonItem is not defined.";}if(!b){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter namespace is not defined.";}if(!c){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter property is not defined.";}this._jsonItem=a;this._namespace=b;this._property=c;this._items=new Hash();if(!a.name){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Name is not defined.";}if(!a.type){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Type is not defined.";}else{a.type=a.type.toLowerCase();}if(a.type===ORYX.CONFIG.TYPE_CHOICE){if(a.items&&a.items instanceof Array){a.items.each((function(d){this._items[d.value]=new ORYX.Core.StencilSet.PropertyItem(d,b,this);}).bind(this));}else{throw"ORYX.Core.StencilSet.Property(construct): No property items defined.";}}},equals:function(a){return(this.property().equals(a.property())&&this.name()===a.name());},namespace:function(){return this._namespace;},property:function(){return this._property;},title:function(){return this.name();},name:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"name");},id:function(){return this._jsonItem.id;},type:function(){return this._jsonItem.type;},optional:function(){return this._jsonItem.optional;},isList:function(){return !!this._jsonItem.isList;},allowCustomValue:function(){if("undefined"===typeof this._jsonItem.allowCustomValue){return false;}else{return this._jsonItem.allowCustomValue;}},width:function(){return this._jsonItem.width;},value:function(){return this._jsonItem.value;},items:function(){return this._items.values();},disable:function(){return this._jsonItem.disable;}});if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}ORYX.Core.StencilSet.Rules={construct:function(){arguments.callee.$.construct.apply(this,arguments);this._stencilSets=[];this._stencils=[];this._containerStencils=[];this._cachedConnectSET=new Hash();this._cachedConnectSE=new Hash();this._cachedConnectTE=new Hash();this._cachedCardSE=new Hash();this._cachedCardTE=new Hash();this._cachedContainPC=new Hash();this._cachedMorphRS=new Hash();this._connectionRules=new Hash();this._cardinalityRules=new Hash();this._containmentRules=new Hash();this._containmentRulesExcludes=[];this._morphingRules=new Hash();this._layoutRules=new Hash();},initializeRules:function(l){var k=this._stencilSets.find(function(p){return(p.namespace()==l.namespace());});if(k){var f=this._stencilSets.clone();f=f.without(k);f.push(l);this._stencilSets=[];this._stencils=[];this._containerStencils=[];this._cachedConnectSET=new Hash();this._cachedConnectSE=new Hash();this._cachedConnectTE=new Hash();this._cachedCardSE=new Hash();this._cachedCardTE=new Hash();this._cachedContainPC=new Hash();this._cachedMorphRS=new Hash();this._connectionRules=new Hash();this._cardinalityRules=new Hash();this._containmentRules=new Hash();this._containmentRulesExcludes=[];this._morphingRules=new Hash();this._layoutRules=new Hash();f.each(function(p){this.initializeRules(p);}.bind(this));return;}else{this._stencilSets.push(l);var m=new Hash(l.jsonRules());var e=l.namespace();var b=l.stencils();l.extensions().values().each(function(q){if(q.rules){if(q.rules.connectionRules){m.connectionRules=m.connectionRules.concat(q.rules.connectionRules);}if(q.rules.cardinalityRules){m.cardinalityRules=m.cardinalityRules.concat(q.rules.cardinalityRules);}if(q.rules.containmentRules){m.containmentRules=m.containmentRules.concat(q.rules.containmentRules);}if(q.rules.morphingRules){var p=[].concat(q.rules.morphingRules).pluck("role");m.morphingRules=[].concat(q.rules.morphingRules,m.morphingRules.findAll(function(r){return !p.include(r.role);}));}}if(q.stencils){b=b.concat(q.stencils);}});this._stencils=this._stencils.concat(l.stencils());var g=this._connectionRules;if(m.connectionRules){m.connectionRules.each((function(p){if(this._isRoleOfOtherNamespace(p.role)){if(!g[p.role]){g[p.role]=new Hash();}}else{if(!g[e+p.role]){g[e+p.role]=new Hash();}}p.connects.each((function(q){var t=[];if(q.to){if(!(q.to instanceof Array)){q.to=[q.to];}q.to.each((function(u){if(this._isRoleOfOtherNamespace(u)){t.push(u);}else{t.push(e+u);}}).bind(this));}var s,r;if(this._isRoleOfOtherNamespace(p.role)){s=p.role;}else{s=e+p.role;}if(this._isRoleOfOtherNamespace(q.from)){r=q.from;}else{r=e+q.from;}if(!g[s][r]){g[s][r]=t;}else{g[s][r]=g[s][r].concat(t);}}).bind(this));}).bind(this));}var c=this._cardinalityRules;if(m.cardinalityRules){m.cardinalityRules.each((function(r){var p;if(this._isRoleOfOtherNamespace(r.role)){p=r.role;}else{p=e+r.role;}if(!c[p]){c[p]={};for(i in r){c[p][i]=r[i];}}var s=new Hash();if(r.outgoingEdges){r.outgoingEdges.each((function(t){if(this._isRoleOfOtherNamespace(t.role)){s[t.role]=t;}else{s[e+t.role]=t;}}).bind(this));}c[p].outgoingEdges=s;var q=new Hash();if(r.incomingEdges){r.incomingEdges.each((function(t){if(this._isRoleOfOtherNamespace(t.role)){q[t.role]=t;}else{q[e+t.role]=t;}}).bind(this));}c[p].incomingEdges=q;}).bind(this));}var a=this._containmentRules,n=this._containmentRulesExcludes;if(m.containmentRules){m.containmentRules.each((function(q){var p;if(!q.role||(!q.contains&&!q.exclude)){return;}if(this._isRoleOfOtherNamespace(q.role)){p=q.role;}else{this._containerStencils.push(e+q.role);p=e+q.role;}if(q.exclude===true){n.push(p);return;}if(!a[p]){a[p]=[];}q.contains.each((function(r){if(this._isRoleOfOtherNamespace(r)){a[p].push(r);}else{a[p].push(e+r);}}).bind(this));}).bind(this));}var d=this._morphingRules;if(m.morphingRules){m.morphingRules.each((function(q){var p;if(this._isRoleOfOtherNamespace(q.role)){p=q.role;}else{p=e+q.role;}if(!d[p]){d[p]=[];}if(!q.preserveBounds){q.preserveBounds=false;}q.baseMorphs.each((function(s){var r=this._getStencilById(e+s);if(r){d[p].push(r);}}).bind(this));}).bind(this));}var h=this._layoutRules;if(m.layoutRules){var o=function(p){return{"edgeRole":p.edgeRole||undefined,"orientation":p.orientation||undefined,"t":p["t"]||1,"r":p["r"]||1,"b":p["b"]||1,"l":p["l"]||1};};m.layoutRules.each(function(q){var p;if(this._isRoleOfOtherNamespace(q.role)){p=q.role;}else{p=e+q.role;}if(!h[p]){h[p]={};}if(q["in"]){h[p]["in"]=o(q["in"]);}if(q["ins"]){h[p]["ins"]=(q["ins"]||[]).map(function(r){return o(r);});}if(q["out"]){h[p]["out"]=o(q["out"]);}if(q["outs"]){h[p]["outs"]=(q["outs"]||[]).map(function(r){return o(r);});}}.bind(this));}}},_getStencilById:function(a){return this._stencils.find(function(b){return b&&b.id()==a;});},_cacheConnect:function(a){result=this._canConnect(a);if(a.sourceStencil&&a.targetStencil){var c=this._cachedConnectSET[a.sourceStencil.id()];if(!c){c=new Hash();this._cachedConnectSET[a.sourceStencil.id()]=c;}var b=c[a.edgeStencil.id()];if(!b){b=new Hash();c[a.edgeStencil.id()]=b;}b[a.targetStencil.id()]=result;}else{if(a.sourceStencil){var c=this._cachedConnectSE[a.sourceStencil.id()];if(!c){c=new Hash();this._cachedConnectSE[a.sourceStencil.id()]=c;}c[a.edgeStencil.id()]=result;}else{var d=this._cachedConnectTE[a.targetStencil.id()];if(!d){d=new Hash();this._cachedConnectTE[a.targetStencil.id()]=d;}d[a.edgeStencil.id()]=result;}}return result;},_cacheCard:function(b){if(b.sourceStencil){var c=this._cachedCardSE[b.sourceStencil.id()];if(!c){c=new Hash();this._cachedCardSE[b.sourceStencil.id()]=c;}var a=this._getMaximumNumberOfOutgoingEdge(b);if(a==undefined){a=-1;}c[b.edgeStencil.id()]=a;}if(b.targetStencil){var d=this._cachedCardTE[b.targetStencil.id()];if(!d){d=new Hash();this._cachedCardTE[b.targetStencil.id()]=d;}var a=this._getMaximumNumberOfIncomingEdge(b);if(a==undefined){a=-1;}d[b.edgeStencil.id()]=a;}},_cacheContain:function(b){var a=[this._canContain(b),this._getMaximumOccurrence(b.containingStencil,b.containedStencil)];if(a[1]==undefined){a[1]=-1;}var c=this._cachedContainPC[b.containingStencil.id()];if(!c){c=new Hash();this._cachedContainPC[b.containingStencil.id()]=c;}c[b.containedStencil.id()]=a;return a;},_cacheMorph:function(b){var a=this._cachedMorphRS[b];if(!a){a=[];if(this._morphingRules.keys().include(b)){a=this._stencils.select(function(c){return c.roles().include(b);});}this._cachedMorphRS[b]=a;}return a;},outgoingEdgeStencils:function(a){if(!a.sourceShape&&!a.sourceStencil){return[];}if(a.sourceShape){a.sourceStencil=a.sourceShape.getStencil();}var b=[];this._stencils.each((function(d){if(d.type()==="edge"){var c=Object.clone(a);c.edgeStencil=d;if(this.canConnect(c)){b.push(d);}}}).bind(this));return b;},incomingEdgeStencils:function(a){if(!a.targetShape&&!a.targetStencil){return[];}if(a.targetShape){a.targetStencil=a.targetShape.getStencil();}var b=[];this._stencils.each((function(d){if(d.type()==="edge"){var c=Object.clone(a);c.edgeStencil=d;if(this.canConnect(c)){b.push(d);}}}).bind(this));return b;},sourceStencils:function(b){if(!b||!b.edgeShape&&!b.edgeStencil){return[];}if(b.targetShape){b.targetStencil=b.targetShape.getStencil();}if(b.edgeShape){b.edgeStencil=b.edgeShape.getStencil();}var a=[];this._stencils.each((function(d){var c=Object.clone(b);c.sourceStencil=d;if(this.canConnect(c)){a.push(d);}}).bind(this));return a;},targetStencils:function(a){if(!a||!a.edgeShape&&!a.edgeStencil){return[];}if(a.sourceShape){a.sourceStencil=a.sourceShape.getStencil();}if(a.edgeShape){a.edgeStencil=a.edgeShape.getStencil();}var b=[];this._stencils.each((function(d){var c=Object.clone(a);c.targetStencil=d;if(this.canConnect(c)){b.push(d);}}).bind(this));return b;},canConnect:function(c){if(!c||(!c.sourceShape&&!c.sourceStencil&&!c.targetShape&&!c.targetStencil)||!c.edgeShape&&!c.edgeStencil){return false;}if(c.sourceShape){c.sourceStencil=c.sourceShape.getStencil();}if(c.targetShape){c.targetStencil=c.targetShape.getStencil();}if(c.edgeShape){c.edgeStencil=c.edgeShape.getStencil();}var b;if(c.sourceStencil&&c.targetStencil){var e=this._cachedConnectSET[c.sourceStencil.id()];if(!e){b=this._cacheConnect(c);}else{var d=e[c.edgeStencil.id()];if(!d){b=this._cacheConnect(c);}else{var f=d[c.targetStencil.id()];if(f==undefined){b=this._cacheConnect(c);}else{b=f;}}}}else{if(c.sourceStencil){var e=this._cachedConnectSE[c.sourceStencil.id()];if(!e){b=this._cacheConnect(c);}else{var d=e[c.edgeStencil.id()];if(d==undefined){b=this._cacheConnect(c);}else{b=d;}}}else{var f=this._cachedConnectTE[c.targetStencil.id()];if(!f){b=this._cacheConnect(c);}else{var d=f[c.edgeStencil.id()];if(d==undefined){b=this._cacheConnect(c);}else{b=d;}}}}if(b){if(c.sourceShape){var e=this._cachedCardSE[c.sourceStencil.id()];if(!e){this._cacheCard(c);e=this._cachedCardSE[c.sourceStencil.id()];}var a=e[c.edgeStencil.id()];if(a==undefined){this._cacheCard(c);}a=e[c.edgeStencil.id()];if(a!=-1){b=c.sourceShape.getOutgoingShapes().all(function(g){if((g.getStencil().id()===c.edgeStencil.id())&&((c.edgeShape)?g!==c.edgeShape:true)){a--;return(a>0)?true:false;}else{return true;}});}}if(c.targetShape){var f=this._cachedCardTE[c.targetStencil.id()];if(!f){this._cacheCard(c);f=this._cachedCardTE[c.targetStencil.id()];}var a=f[c.edgeStencil.id()];if(a==undefined){this._cacheCard(c);}a=f[c.edgeStencil.id()];if(a!=-1){b=c.targetShape.getIncomingShapes().all(function(g){if((g.getStencil().id()===c.edgeStencil.id())&&((c.edgeShape)?g!==c.edgeShape:true)){a--;return(a>0)?true:false;}else{return true;}});}}}return b;},_canConnect:function(b){if(!b||(!b.sourceShape&&!b.sourceStencil&&!b.targetShape&&!b.targetStencil)||!b.edgeShape&&!b.edgeStencil){return false;}if(b.sourceShape){b.sourceStencil=b.sourceShape.getStencil();}if(b.targetShape){b.targetStencil=b.targetShape.getStencil();}if(b.edgeShape){b.edgeStencil=b.edgeShape.getStencil();}var c;var a=this._getConnectionRulesOfEdgeStencil(b.edgeStencil);if(a.keys().length===0){c=false;}else{if(b.sourceStencil){c=b.sourceStencil.roles().any(function(e){var d=a[e];if(!d){return false;}if(b.targetStencil){return(d.any(function(f){return b.targetStencil.roles().member(f);}));}else{return true;}});}else{c=a.values().any(function(d){return b.targetStencil.roles().any(function(e){return d.member(e);});});}}return c;},isContainer:function(a){return this._containerStencils.member(a.getStencil().id());},isContainable:function(a){if(this._containmentRulesExcludes.length===0){return true;}if(a instanceof ORYX.Core.Shape){a=a.getStencil();}if(!(a instanceof ORYX.Core.StencilSet.Stencil)){return true;}var b=a.roles();return !this._containmentRulesExcludes.any(function(c){return b.include(c);});},canContain:function(c){if(!c||!c.containingStencil&&!c.containingShape||!c.containedStencil&&!c.containedShape){return false;}if(c.containedShape){c.containedStencil=c.containedShape.getStencil();}if(c.containingShape){c.containingStencil=c.containingShape.getStencil();}if(c.containedStencil.type()=="edge"){return false;}var b;var d=this._cachedContainPC[c.containingStencil.id()];if(!d){b=this._cacheContain(c);}else{b=d[c.containedStencil.id()];if(!b){b=this._cacheContain(c);}}if(!b[0]){return false;}else{if(b[1]==-1){return true;}else{if(c.containingShape){var a=b[1];return c.containingShape.getChildShapes(false).all(function(e){if(e.getStencil().id()===c.containedStencil.id()){a--;return(a>0)?true:false;}else{return true;}});}else{return true;}}}},_canContain:function(b){if(!b||!b.containingStencil&&!b.containingShape||!b.containedStencil&&!b.containedShape){return false;}if(b.containedShape){b.containedStencil=b.containedShape.getStencil();}if(b.containingShape){b.containingStencil=b.containingShape.getStencil();}var a;a=b.containingStencil.roles().any((function(d){var c=this._containmentRules[d];if(c){return c.any(function(e){return b.containedStencil.roles().member(e);});}else{return false;}}).bind(this));return a;},morphStencils:function(b){if(!b.stencil&&!b.shape){return[];}if(b.shape){b.stencil=b.shape.getStencil();}var a=[];b.stencil.roles().each(function(d){this._cacheMorph(d).each(function(e){a.push(e);});}.bind(this));var c=this.baseMorphs();a=a.uniq().sortBy(function(d){return c.indexOf(d)>=0?c.indexOf(d):1000;});return a;},baseMorphs:function(){var a=[];this._morphingRules.each(function(b){b.value.each(function(c){a.push(c);});});return a;},containsMorphingRules:function(){return this._stencilSets.any(function(a){return !!a.jsonRules().morphingRules;});},connectMorph:function(e){if(!e||(!e.sourceShape&&!e.sourceStencil&&!e.targetShape&&!e.targetStencil)){return false;}if(e.sourceShape){e.sourceStencil=e.sourceShape.getStencil();}if(e.targetShape){e.targetStencil=e.targetShape.getStencil();}var a=this.incomingEdgeStencils(e);var d=this.outgoingEdgeStencils(e);var c=a.select(function(f){return d.member(f);});var b=this.baseMorphs().select(function(f){return c.member(f);});if(b.size()>0){return b[0];}else{if(c.size()>0){return c[0];}}return null;},showInShapeMenu:function(a){return this._stencilSets.any(function(b){return b.jsonRules().morphingRules.any(function(c){return a.roles().include(b.namespace()+c.role)&&c.showInShapeMenu!==false;});});},preserveBounds:function(a){return this._stencilSets.any(function(b){return b.jsonRules().morphingRules.any(function(c){return a.roles().include(b.namespace()+c.role)&&c.preserveBounds;});});},getLayoutingRules:function(c,e,b){if(!c||!(c instanceof ORYX.Core.Shape)){return;}var d={"in":{},"out":{}};var a=function(h,g,f){if(h&&h[g]){["t","r","b","l"].each(function(k){d[g][k]=Math.max(h[g][k],d[g][k]||0);});}if(h&&h[g+"s"] instanceof Array){["t","r","b","l"].each(function(m){var k=undefined;if(f){k=h[g+"s"].find(function(n){return !n.edgeRole&&f===n.orientation;});}if(!k){k=h[g+"s"].find(function(n){return !n.edgeRole&&!n.orientation;});}var l=undefined;if(f&&e instanceof ORYX.Core.Edge){l=h[g+"s"].find(function(n){return this._hasRole(e,n.edgeRole)&&f===n.orientation;}.bind(this));}if(!l){l=h[g+"s"].find(function(n){return this._hasRole(e,n.edgeRole)&&!n.orientation;}.bind(this));}d[g][m]=Math.max(l?l[m]:k[m],d[g][m]||0);}.bind(this));}}.bind(this);c.getStencil().roles().each(function(f){if(this._layoutRules[f]){a(this._layoutRules[f],"in",b);a(this._layoutRules[f],"out",b);}}.bind(this));["in","out"].each(function(f){["t","r","b","l"].each(function(g){d[f][g]=d[f][g]!==undefined?d[f][g]:1;});});return d;},_hasRole:function(b,c){if(!(b instanceof ORYX.Core.Shape)||!c){return;}var a=b.getStencil().roles().any(function(d){return d==c;});return a||b.getStencil().id()==(b.getStencil().namespace()+c);},_stencilsWithRole:function(a){return this._stencils.findAll(function(b){return(b.roles().member(a))?true:false;});},_edgesWithRole:function(a){return this._stencils.findAll(function(b){return(b.roles().member(a)&&b.type()==="edge")?true:false;});},_nodesWithRole:function(a){return this._stencils.findAll(function(b){return(b.roles().member(a)&&b.type()==="node")?true:false;});},_getMaximumOccurrence:function(b,c){var a;c.roles().each((function(e){var d=this._cardinalityRules[e];if(d&&d.maximumOccurrence){if(a){a=Math.min(a,d.maximumOccurrence);}else{a=d.maximumOccurrence;}}}).bind(this));return a;},_getMaximumNumberOfOutgoingEdge:function(b){if(!b||!b.sourceStencil||!b.edgeStencil){return false;}var a;b.sourceStencil.roles().each((function(d){var c=this._cardinalityRules[d];if(c&&c.outgoingEdges){b.edgeStencil.roles().each(function(e){var f=c.outgoingEdges[e];if(f&&f.maximum){if(a){a=Math.min(a,f.maximum);}else{a=f.maximum;}}});}}).bind(this));return a;},_getMaximumNumberOfIncomingEdge:function(b){if(!b||!b.targetStencil||!b.edgeStencil){return false;}var a;b.targetStencil.roles().each((function(d){var c=this._cardinalityRules[d];if(c&&c.incomingEdges){b.edgeStencil.roles().each(function(e){var f=c.incomingEdges[e];if(f&&f.maximum){if(a){a=Math.min(a,f.maximum);}else{a=f.maximum;}}});}}).bind(this));return a;},_getConnectionRulesOfEdgeStencil:function(b){var a=new Hash();b.roles().each((function(c){if(this._connectionRules[c]){this._connectionRules[c].each(function(d){if(a[d.key]){a[d.key]=a[d.key].concat(d.value);}else{a[d.key]=d.value;}});}}).bind(this));return a;},_isRoleOfOtherNamespace:function(a){return(a.indexOf("#")>0);},toString:function(){return"Rules";}};ORYX.Core.StencilSet.Rules=Clazz.extend(ORYX.Core.StencilSet.Rules);if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}ORYX.Core.StencilSet.StencilSet=Clazz.extend({construct:function(a){arguments.callee.$.construct.apply(this,arguments);if(!a){throw"ORYX.Core.StencilSet.StencilSet(construct): Parameter 'source' is not defined.";}if(a.endsWith("/")){a=a.substr(0,a.length-1);}this._extensions=new Hash();this._source=a;this._baseUrl=a.substring(0,a.lastIndexOf("/")+1);this._jsonObject={};this._stencils=new Hash();this._availableStencils=new Hash();if(ORYX.CONFIG.BACKEND_SWITCH){new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:this._getJSONURL.bind(this),onFailure:this._cancelInit.bind(this)});}else{new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:this._init.bind(this),onFailure:this._cancelInit.bind(this)});}if(this.errornous){throw"Loading stencil set "+a+" failed.";}},findRootStencilName:function(){var a=this._stencils.values().find(function(b){return b._jsonStencil.mayBeRoot;});if(!a){ORYX.Log.warn("Did not find any stencil that may be root. Taking a guess.");a=this._stencils.values()[0];}return a.id();},equals:function(a){return(this.namespace()===a.namespace());},stencils:function(k,l,h){if(k&&l){var a=this._availableStencils.values();var e=[k];var d=[];var m=[];while(e.size()>0){var b=e.pop();d.push(b);var c=a.findAll(function(o){var n={containingStencil:b,containedStencil:o};return l.canContain(n);});for(var g=0;g<c.size();g++){if(!d.member(c[g])){e.push(c[g]);}}m=m.concat(c).uniq();}m=m.sortBy(function(n){return a.indexOf(n);});if(h){m=m.sortBy(function(n){return n.groups().first();});}var f=a.findAll(function(n){return n.type()=="edge";});m=m.concat(f);return m;}else{if(h){return this._availableStencils.values().sortBy(function(n){return n.groups().first();});}else{return this._availableStencils.values();}}},nodes:function(){return this._availableStencils.values().findAll(function(a){return(a.type()==="node");});},edges:function(){return this._availableStencils.values().findAll(function(a){return(a.type()==="edge");});},stencil:function(a){return this._stencils[a];},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonObject,"title");},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonObject,"description");},namespace:function(){return this._jsonObject?this._jsonObject.namespace:null;},jsonRules:function(){return this._jsonObject?this._jsonObject.rules:null;},source:function(){return this._source;},extensions:function(){return this._extensions;},addExtension:function(a){new Ajax.Request(a,{method:"GET",asynchronous:false,onSuccess:(function(b){this.addExtensionDirectly(b.responseText);}).bind(this),onFailure:(function(b){ORYX.Log.debug("Loading stencil set extension file failed. The request returned an error."+b);}).bind(this),onException:(function(b){ORYX.Log.debug("Loading stencil set extension file failed. The request returned an error."+b);}).bind(this)});},_isStencilAlreadyRemoved:function(a,b){return this._extensions.values().any(function(d){if(d["extends"]!==this.namespace()){return false;}if(b instanceof Array){var c=b.any(function(e){return d.namespace===e;});if(c){return false;}}if(d.removestencils){return $A(d.removestencils).any(function(e){return e===a;});}}.bind(this));},addExtensionDirectly:function(str){try{eval("var jsonExtension = "+str);if(jsonExtension["extends"] instanceof Array&&jsonExtension["extends"].include(this.namespace())){jsonExtension["extends"]=this.namespace();}if(!(jsonExtension["extends"].endsWith("#"))){jsonExtension["extends"]+="#";}if(jsonExtension["extends"]==this.namespace()){this._extensions[jsonExtension.namespace]=jsonExtension;var defaultPosition=this._stencils.keys().size();if(jsonExtension.stencils){$A(jsonExtension.stencils).each(function(stencil){defaultPosition++;var oStencil=new ORYX.Core.StencilSet.Stencil(stencil,this.namespace(),this._baseUrl,this,undefined,defaultPosition);this._stencils[oStencil.id()]=oStencil;if(!this._isStencilAlreadyRemoved(oStencil.idWithoutNs())){this._availableStencils[oStencil.id()]=oStencil;}}.bind(this));}if(jsonExtension.properties){var stencils=this._stencils.values();stencils.each(function(stencil){var roles=stencil.roles();jsonExtension.properties.each(function(prop){prop.roles.any(function(role){role=jsonExtension["extends"]+role;if(roles.member(role)){prop.properties.each(function(property){stencil.addProperty(property,jsonExtension.namespace);});return true;}else{return false;}});});}.bind(this));}if(jsonExtension.removeproperties){jsonExtension.removeproperties.each(function(remprop){var stencil=this.stencil(jsonExtension["extends"]+remprop.stencil);if(stencil){remprop.properties.each(function(propId){stencil.removeProperty(propId);});}}.bind(this));}if(jsonExtension.removestencils){$A(jsonExtension.removestencils).each(function(remstencil){delete this._availableStencils[jsonExtension["extends"]+remstencil];}.bind(this));}}}catch(e){ORYX.Log.debug("StencilSet.addExtension: Something went wrong when initialising the stencil set extension. "+e);}},removeExtension:function(a){var b=this._extensions[a];if(b){if(b.stencils){$A(b.stencils).each(function(e){var d=new ORYX.Core.StencilSet.Stencil(e,this.namespace(),this._baseUrl,this);delete this._stencils[d.id()];delete this._availableStencils[d.id()];}.bind(this));}if(b.properties){var c=this._stencils.values();c.each(function(e){var d=e.roles();b.properties.each(function(f){f.roles.any(function(g){g=b["extends"]+g;if(d.member(g)){f.properties.each(function(h){e.removeProperty(h.id);if(e.overwrittenProperty(h.prefix+"-"+h.id)){e.addProperty(e.overwrittenProperty(h.prefix+"-"+h.id));}});return true;}else{return false;}});});}.bind(this));}if(b.removeproperties){b.removeproperties.each(function(f){var e=this.stencil(b["extends"]+f.stencil);if(e){var d=$A(this._jsonObject.stencils).find(function(g){return g.id==e.id();});f.properties.each(function(h){var g=$A(d.properties).find(function(k){return k.id==h;});e.addProperty(g,this.namespace());}.bind(this));}}.bind(this));}if(b.removestencils){$A(b.removestencils).each(function(d){var e=b["extends"]+d;if("undefined"!=typeof this._stencils[e]&&this._stencils[e]&&!this._isStencilAlreadyRemoved(this._stencils[e].idWithoutNs(),[b.namespace])){this._availableStencils[e]=this._stencils[e];}}.bind(this));}}delete this._extensions[a];},__handleStencilset:function(response){try{eval("this._jsonObject ="+response.responseText);}catch(e){throw"Stenciset corrupt: "+e;}if(!this._jsonObject){throw"Error evaluating stencilset. It may be corrupt.";}with(this._jsonObject){if(!namespace||namespace===""){throw"Namespace definition missing in stencilset.";}if(!(stencils instanceof Array)){throw"Stencilset corrupt.";}if(!namespace.endsWith("#")){namespace=namespace+"#";}if(!title){title="";}if(!description){description="";}}},_getJSONURL:function(a){this._baseUrl=a.responseText.substring(0,a.responseText.lastIndexOf("/")+1);this._source=a.responseText;new Ajax.Request(a.responseText,{asynchronous:false,method:"get",onSuccess:this._init.bind(this),onFailure:this._cancelInit.bind(this)});},_init:function(c){this.__handleStencilset(c);var b=new Hash();if(this._jsonObject.propertyPackages){$A(this._jsonObject.propertyPackages).each((function(d){b[d.name]=d.properties;}).bind(this));}var a=0;$A(this._jsonObject.stencils).each((function(e){a++;var d=new ORYX.Core.StencilSet.Stencil(e,this.namespace(),this._baseUrl,this,b,a);this._stencils[d.id()]=d;this._availableStencils[d.id()]=d;}).bind(this));},_cancelInit:function(a){this.errornous=true;},toString:function(){return"StencilSet "+this.title()+" ("+this.namespace()+")";}});if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={};}ORYX.Core.StencilSet._stencilSetsByNamespace=new Hash();ORYX.Core.StencilSet._stencilSetsByUrl=new Hash();ORYX.Core.StencilSet._StencilSetNSByEditorInstance=new Hash();ORYX.Core.StencilSet._rulesByEditorInstance=new Hash();ORYX.Core.StencilSet.stencilSets=function(b){var c=ORYX.Core.StencilSet._StencilSetNSByEditorInstance[b];var a=new Hash();if(c){c.each(function(e){var d=ORYX.Core.StencilSet.stencilSet(e);a[d.namespace()]=d;});}return a;};ORYX.Core.StencilSet.stencilSet=function(a){ORYX.Log.trace("Getting stencil set %0",a);var b=a.split("#",1);if(b.length===1){ORYX.Log.trace("Getting stencil set %0",b[0]);return ORYX.Core.StencilSet._stencilSetsByNamespace[b[0]+"#"];}else{return undefined;}};ORYX.Core.StencilSet.stencil=function(b){ORYX.Log.trace("Getting stencil for %0",b);var a=ORYX.Core.StencilSet.stencilSet(b);if(a){return a.stencil(b);}else{ORYX.Log.trace("Cannot fild stencil for %0",b);return undefined;}};ORYX.Core.StencilSet.rules=function(a){if(!ORYX.Core.StencilSet._rulesByEditorInstance[a]){ORYX.Core.StencilSet._rulesByEditorInstance[a]=new ORYX.Core.StencilSet.Rules();}return ORYX.Core.StencilSet._rulesByEditorInstance[a];};ORYX.Core.StencilSet.loadStencilSet=function(a,c){var d=ORYX.Core.StencilSet._stencilSetsByUrl[a];if(!d){d=new ORYX.Core.StencilSet.StencilSet(a);ORYX.Core.StencilSet._stencilSetsByNamespace[d.namespace()]=d;ORYX.Core.StencilSet._stencilSetsByUrl[a]=d;}var b=d.namespace();if(ORYX.Core.StencilSet._StencilSetNSByEditorInstance[c]){ORYX.Core.StencilSet._StencilSetNSByEditorInstance[c].push(b);}else{ORYX.Core.StencilSet._StencilSetNSByEditorInstance[c]=[b];}if(ORYX.Core.StencilSet._rulesByEditorInstance[c]){ORYX.Core.StencilSet._rulesByEditorInstance[c].initializeRules(d);}else{var e=new ORYX.Core.StencilSet.Rules();e.initializeRules(d);ORYX.Core.StencilSet._rulesByEditorInstance[c]=e;}};ORYX.Core.StencilSet.getTranslation=function(c,b){var d=ORYX.I18N.Language.toLowerCase();var a=c[b+"_"+d];if(a){return a;}a=c[b+"_"+d.substr(0,2)];if(a){return a;}return c[b];};if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}ORYX.Core.Command=Clazz.extend({construct:function(){},execute:function(){throw"Command.execute() has to be implemented!";},rollback:function(){throw"Command.rollback() has to be implemented!";}});if("undefined"==typeof ORYX){var ORYX={};}if("undefined"==typeof ORYX.Core){ORYX.Core={};}new function(){ORYX.Core.Bounds=Clazz.extend({construct:function(){this._changedCallbacks=[];this.a={};this.b={};this.set.apply(this,arguments);this.suspendChange=false;this.changedWhileSuspend=false;},_changed:function(a){if(!this.suspendChange){this._changedCallbacks.each(function(b){b(this,a);}.bind(this));this.changedWhileSuspend=false;}else{this.changedWhileSuspend=true;}},registerCallback:function(a){if(!this._changedCallbacks.member(a)){this._changedCallbacks.push(a);}},unregisterCallback:function(a){this._changedCallbacks=this._changedCallbacks.without(a);},set:function(){var e=false;switch(arguments.length){case 1:if(this.a.x!==arguments[0].a.x){e=true;this.a.x=arguments[0].a.x;}if(this.a.y!==arguments[0].a.y){e=true;this.a.y=arguments[0].a.y;}if(this.b.x!==arguments[0].b.x){e=true;this.b.x=arguments[0].b.x;}if(this.b.y!==arguments[0].b.y){e=true;this.b.y=arguments[0].b.y;}break;case 2:var b=Math.min(arguments[0].x,arguments[1].x);var a=Math.min(arguments[0].y,arguments[1].y);var d=Math.max(arguments[0].x,arguments[1].x);var c=Math.max(arguments[0].y,arguments[1].y);if(this.a.x!==b){e=true;this.a.x=b;}if(this.a.y!==a){e=true;this.a.y=a;}if(this.b.x!==d){e=true;this.b.x=d;}if(this.b.y!==c){e=true;this.b.y=c;}break;case 4:var b=Math.min(arguments[0],arguments[2]);var a=Math.min(arguments[1],arguments[3]);var d=Math.max(arguments[0],arguments[2]);var c=Math.max(arguments[1],arguments[3]);if(this.a.x!==b){e=true;this.a.x=b;}if(this.a.y!==a){e=true;this.a.y=a;}if(this.b.x!==d){e=true;this.b.x=d;}if(this.b.y!==c){e=true;this.b.y=c;}break;}if(e){this._changed(true);}},moveTo:function(){var a=this.upperLeft();switch(arguments.length){case 1:this.moveBy({x:arguments[0].x-a.x,y:arguments[0].y-a.y});break;case 2:this.moveBy({x:arguments[0]-a.x,y:arguments[1]-a.y});break;default:}},moveBy:function(){var c=false;switch(arguments.length){case 1:var b=arguments[0];if(b.x!==0||b.y!==0){c=true;this.a.x+=b.x;this.b.x+=b.x;this.a.y+=b.y;this.b.y+=b.y;}break;case 2:var a=arguments[0];var d=arguments[1];if(a!==0||d!==0){c=true;this.a.x+=a;this.b.x+=a;this.a.y+=d;this.b.y+=d;}break;default:}if(c){this._changed();}},include:function(c){if((this.a.x===undefined)&&(this.a.y===undefined)&&(this.b.x===undefined)&&(this.b.y===undefined)){return c;}var a=Math.min(this.a.x,c.a.x);var f=Math.min(this.a.y,c.a.y);var e=Math.max(this.b.x,c.b.x);var d=Math.max(this.b.y,c.b.y);this.set(a,f,e,d);},extend:function(a){if(a.x!==0||a.y!==0){this.b.x+=a.x;this.b.y+=a.y;this._changed(true);}},widen:function(a){if(a!==0){this.suspendChange=true;this.moveBy({x:-a,y:-a});this.extend({x:2*a,y:2*a});this.suspendChange=false;if(this.changedWhileSuspend){this._changed(true);}}},upperLeft:function(){return{x:this.a.x,y:this.a.y};},lowerRight:function(){return{x:this.b.x,y:this.b.y};},width:function(){return this.b.x-this.a.x;},height:function(){return this.b.y-this.a.y;},center:function(){return{x:(this.a.x+this.b.x)/2,y:(this.a.y+this.b.y)/2};},midPoint:function(){return{x:(this.b.x-this.a.x)/2,y:(this.b.y-this.a.y)/2};},centerMoveTo:function(){var a=this.center();switch(arguments.length){case 1:this.moveBy(arguments[0].x-a.x,arguments[0].y-a.y);break;case 2:this.moveBy(arguments[0]-a.x,arguments[1]-a.y);break;}},isIncluded:function(a,e){var f,d,e;switch(arguments.length){case 1:f=arguments[0].x;d=arguments[0].y;e=0;break;case 2:if(arguments[0].x&&arguments[0].y){f=arguments[0].x;d=arguments[0].y;e=Math.abs(arguments[1]);}else{f=arguments[0];d=arguments[1];e=0;}break;case 3:f=arguments[0];d=arguments[1];e=Math.abs(arguments[2]);break;default:throw"isIncluded needs one, two or three arguments";}var c=this.upperLeft();var b=this.lowerRight();if(f>=c.x-e&&f<=b.x+e&&d>=c.y-e&&d<=b.y+e){return true;}else{return false;}},getSide:function(a){var g=this.upperLeft();var f=this.lowerRight();var e={x:g.x,y:f.y};var c={x:f.x,y:g.y};var d=ORYX.Core.Math.pointIsLeftOfLine(e,c,a);var b=ORYX.Core.Math.pointIsLeftOfLine(g,f,a);if(d&&b){return("bottom");}if(d&&!b){return("right");}if(!d&&b){return("left");}if(!d&&!b){return("top");}},clone:function(){return new ORYX.Core.Bounds(this);},toString:function(){return"( "+this.a.x+" | "+this.a.y+" )/( "+this.b.x+" | "+this.b.y+" )";},serializeForERDF:function(){return this.a.x+","+this.a.y+","+this.b.x+","+this.b.y;}});}();if(!ORYX){var ORYX={};}if("undefined"==typeof ORYX.Core){ORYX.Core={};}ORYX.Core.UIObject={construct:function(a){this.isChanged=true;this.isResized=true;this.isVisible=true;this.isSelectable=false;this.isResizable=false;this.isMovable=false;this.id=ORYX.Editor.provideId();this.parent=undefined;this.node=undefined;this.children=[];this.bounds=new ORYX.Core.Bounds();this._changedCallback=this._changed.bind(this);this.bounds.registerCallback(this._changedCallback);if(a&&a.eventHandlerCallback){this.eventHandlerCallback=a.eventHandlerCallback;}},_changed:function(b,a){this.isChanged=true;if(this.bounds==b){this.isResized=a||this.isResized;}},update:function(){if(this.isChanged){this.refresh();this.isChanged=false;this.children.each(function(a){a.update();});}},refresh:function(){},getChildren:function(){return this.children.clone();},getParents:function(){var a=[];var b=this.parent;while(b){a.push(b);b=b.parent;}return a;},isParent:function(a){var b=this;while(b){if(b===a){return true;}b=b.parent;}return false;},getId:function(){return this.id;},getChildById:function(b,a){return this.children.find(function(c){if(c.getId()===b){return c;}else{if(a){var d=c.getChildById(b,a);if(d){return d;}}}});},add:function(a){if(!(this.children.member(a))){if(a.parent){a.remove(a);}this.children.push(a);a.parent=this;a.node=this.node.appendChild(a.node);a.bounds.registerCallback(this._changedCallback);}else{ORYX.Log.info("add: ORYX.Core.UIObject is already a child of this object.");}},remove:function(a){if(this.children.member(a)){this.children=this._uiObjects.without(a);a.parent=undefined;a.node=this.node.removeChild(a.node);a.bounds.unregisterCallback(this._changedCallback);}else{ORYX.Log.info("remove: ORYX.Core.UIObject is not a child of this object.");}},absoluteBounds:function(){if(this.parent){var a=this.absoluteXY();return new ORYX.Core.Bounds(a.x,a.y,a.x+this.bounds.width(),a.y+this.bounds.height());}else{return this.bounds.clone();}},absoluteXY:function(){if(this.parent&&this!==this.parent){var a=this.parent.absoluteXY();return{x:a.x+this.bounds.upperLeft().x,y:a.y+this.bounds.upperLeft().y};}else{return{x:this.bounds.upperLeft().x,y:this.bounds.upperLeft().y};}},absoluteCenterXY:function(){if(this.parent){var a=this.parent.absoluteXY();return{x:a.x+this.bounds.center().x,y:a.y+this.bounds.center().y};}else{return{x:this.bounds.center().x,y:this.bounds.center().y};}},hide:function(){this.node.setAttributeNS(null,"display","none");this.isVisible=false;this.children.each(function(a){a.hide();});},show:function(){this.node.setAttributeNS(null,"display","inherit");this.isVisible=true;this.children.each(function(a){a.show();});},addEventHandlers:function(a){a.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this._delegateEvent.bind(this),false);a.addEventListener("click",this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_DBLCLICK,this._delegateEvent.bind(this),false);},_delegateEvent:function(a){if(this.eventHandlerCallback){this.eventHandlerCallback(a,this);}},toString:function(){return"UIObject "+this.id;}};ORYX.Core.UIObject=Clazz.extend(ORYX.Core.UIObject);if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}ORYX.Core.AbstractShape=ORYX.Core.UIObject.extend({construct:function(a,b){arguments.callee.$.construct.apply(this,arguments);this.resourceId=ORYX.Editor.provideId();this._stencil=b;if(this._stencil._jsonStencil.superId){stencilId=this._stencil.id();superStencilId=stencilId.substring(0,stencilId.indexOf("#")+1)+b._jsonStencil.superId;stencilSet=this._stencil.stencilSet();this._stencil=stencilSet.stencil(superStencilId);}this.properties=new Hash();this.propertiesChanged=new Hash();this.formats=new Hash();this.hiddenProperties=new Hash();this._stencil.properties().each((function(d){var c=d.prefix()+"-"+d.id();this.properties[c]=d.value();this.propertiesChanged[c]=true;}).bind(this));if(b._jsonStencil.superId){b.properties().each((function(f){var d=f.prefix()+"-"+f.id();var e=f.value();var c=this.properties[d];this.properties[d]=e;this.propertiesChanged[d]=true;this._delegateEvent({type:ORYX.CONFIG.EVENT_PROPERTY_CHANGED,name:d,value:e,oldValue:c});}).bind(this));}},setResourceId:function(a){this.resourceId=a;this.node.id="svg-"+a;},layout:function(){},getStencil:function(){return this._stencil;},getChildShapeByResourceId:function(a){a=ERDF.__stripHashes(a);return this.getChildShapes(true).find(function(b){return b.resourceId==a;});},getChildShapes:function(b,c){var a=[];this.children.each(function(d){if(d instanceof ORYX.Core.Shape&&d.isVisible){if(c){c(d);}a.push(d);if(b){a=a.concat(d.getChildShapes(b,c));}}});return a;},hasChildShape:function(a){return this.getChildShapes().any(function(b){return(b===a)||b.hasChildShape(a);});},isParent:function(a){if(a instanceof ORYX.Core.Canvas){return true;}var b=this;while(b&&a){if(b===a){return true;}b=b.parent;}return false;},getChildNodes:function(b,c){var a=[];this.children.each(function(d){if(d instanceof ORYX.Core.Node&&d.isVisible){if(c){c(d);}a.push(d);}if(d instanceof ORYX.Core.Shape){if(b){a=a.concat(d.getChildNodes(b,c));}}});return a;},getChildEdges:function(b,c){var a=[];this.children.each(function(d){if(d instanceof ORYX.Core.Edge&&d.isVisible){if(c){c(d);}a.push(d);}if(d instanceof ORYX.Core.Shape){if(b){a=a.concat(d.getChildEdges(b,c));}}});return a;},getAbstractShapesAtPosition:function(){var b,e;switch(arguments.length){case 1:b=arguments[0].x;e=arguments[0].y;break;case 2:b=arguments[0];e=arguments[1];break;default:throw"getAbstractShapesAtPosition needs 1 or 2 arguments!";}if(this.isPointIncluded(b,e)){var a=[];a.push(this);var d=this.getChildNodes();var c=this.getChildEdges();[d,c].each(function(f){var g=new Hash();f.each(function(h){if(!h.isVisible){return;}var l=h.getAbstractShapesAtPosition(b,e);if(l.length>0){var k=$A(h.node.parentNode.childNodes);var m=k.indexOf(h.node);g[m]=l;}});g.keys().sort().each(function(h){a=a.concat(g[h]);});});return a;}else{return[];}},setProperty:function(b,d,c){b=(b||"").toLowerCase();if(!b.startsWith("oryx-")){b="oryx-"+b;}var a=this.properties[b];if(a!==d||c===true){if("string"==typeof d){d=d.replace(/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,"");}this.properties[b]=d;this.propertiesChanged[b]=true;this._changed();if(!this._isInSetProperty){this._isInSetProperty=true;this._delegateEvent({type:ORYX.CONFIG.EVENT_PROPERTY_CHANGED,elements:[this],name:b,value:d,oldValue:a});delete this._isInSetProperty;}}},getProperty:function(a){a=(a||"").toLowerCase();if(!a.startsWith("oryx-")){a="oryx-"+a;}return this.properties[a];},hasProperty:function(a){a=(a||"").toLowerCase();if(!a.startsWith("oryx-")){a="oryx-"+a;}return $H(this.properties).keys().include(a);},setFormat:function(b,c){var a=this.formats[b];if(c instanceof Array){if(c.length>0){this.formats[b]=c;}else{delete this.formats[b];}this.propertiesChanged[b]=true;this._changed();}},getFormat:function(a){return this.formats[a];},isPropertyChanged:function(){return this.propertiesChanged.any(function(a){return a.value;});},setHiddenProperty:function(b,c){if(c===undefined){delete this.hiddenProperties[b];return;}var a=this.hiddenProperties[b];if(a!==c){this.hiddenProperties[b]=c;}},isPointIncluded:function(d,c,b){var a=b?b:this.absoluteBounds();return a.isIncluded(d,c);},serialize:function(){var a=[];a.push({name:"type",prefix:"oryx",value:this.getStencil().id(),type:"literal"});this.hiddenProperties.each(function(b){a.push({name:b.key.replace("oryx-",""),prefix:"oryx",value:b.value,type:"literal"});}.bind(this));this.getStencil().properties().each((function(d){var c=d.prefix();var b=d.id();a.push({name:b,prefix:c,value:this.properties[c+"-"+b],type:"literal"});}).bind(this));return a;},deserialize:function(c,a){var b=0;c=c.sortBy(function(d){var e=this.properties.keys().indexOf(d.prefix+"-"+d.name);return e>=0?e:2000;}.bind(this));c.each((function(k){var d=k.name;var g=k.prefix;var f=k.value;var h=a&&a.formats&&a.formats[d]||k.format||[];if(typeof h==="string"&&h.length>0){h=Ext.decode(h);}if(Ext.type(f)==="object"){f=Ext.encode(f);}switch(g+"-"+d){case"raziel-parent":if(!this.parent){break;}var e=this.getCanvas().getChildShapeByResourceId(f);if(e){e.add(this);}break;default:var l=this.getStencil().property(g+"-"+d);if(l&&l.isList()&&typeof f==="string"){if((f||"").strip()&&!f.startsWith("[")&&!f.startsWith("]")){f='["'+f.strip()+'"]';}f=((f||"").strip()||"[]").evalJSON();}if(h instanceof Array&&h.length>0){this.formats[g+"-"+d]=h;}if(this.properties.keys().member(g+"-"+d)){this.setProperty(g+"-"+d,f);}else{if(!(d==="bounds"||d==="parent"||d==="target"||d==="dockers"||d==="docker"||d==="outgoing"||d==="incoming")){this.setHiddenProperty(g+"-"+d,f);}}}}).bind(this));},toString:function(){return"ORYX.Core.AbstractShape "+this.id;},toJSON:function(){var b={resourceId:this.resourceId,properties:Ext.apply({},this.properties,this.hiddenProperties).inject({},function(f,l){var d=l.key,h=l.value,g=this.getStencil().property(d);if(g&&g.type()===ORYX.CONFIG.TYPE_COMPLEX&&Ext.type(h)==="string"){try{h=Ext.decode(h);}catch(c){}}else{if(h instanceof Date&&g){try{h=h.format(g.dateFormat());}catch(k){}}}if(!g||!g.language()||g.language()===ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT||g.value()!==h){d=d.replace(/^[\w_]+-/,"");f[d]=h;}return f;}.bind(this)),stencil:{id:this.getStencil().idWithoutNs()},childShapes:this.getChildShapes().map(function(c){return c.toJSON();})};var a=Ext.apply({},this.formats).inject({},function(d,f){var c=f.key,e=f.value||[];if(e.length>0){c=c.replace(/^[\w_]+-/,"");d[c]=e;}return d;});if($H(a).keys().length>0){b.formats=a;}if(this.getOutgoingShapes){b.outgoing=this.getOutgoingShapes().map(function(c){return{resourceId:c.resourceId};});}if(this.bounds){b.bounds={lowerRight:this.bounds.lowerRight(),upperLeft:this.bounds.upperLeft()};}if(this.dockers){b.dockers=this.dockers.map(function(c){var e=c.getDockedShape()&&c.referencePoint?c.referencePoint:c.bounds.center();e.getDocker=function(){return c;};return e;});}Ext.apply(b,ORYX.Core.AbstractShape.JSONHelper);b.getShape=function(){return this;}.bind(this);return b;}});ORYX.Core.AbstractShape.JSONHelper={eachChild:function(c,b,d){if(!this.childShapes){return;}var a=[];this.childShapes.each(function(e){if(!(e.eachChild instanceof Function)){Ext.apply(e,ORYX.Core.AbstractShape.JSONHelper);}var f=c(e,this);if(f){a.push(f);}if(b){e.eachChild(c,b,d);}}.bind(this));if(d){this.childShapes=a;}},getShape:function(){return null;},getChildShapes:function(a){var b=this.childShapes;if(a){this.eachChild(function(c){if(!(c.getChildShapes instanceof Function)){Ext.apply(c,ORYX.Core.AbstractShape.JSONHelper);}b=b.concat(c.getChildShapes(a));},true);}return b;},serialize:function(){return Ext.encode(this);}};if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}ORYX.Core.Canvas=ORYX.Core.AbstractShape.extend({zoomLevel:1,useAnimation:false,construct:function(a){arguments.callee.$.construct.apply(this,arguments);if(!(a&&a.width&&a.height)){ORYX.Log.fatal("Canvas is missing mandatory parameters options.width and options.height.");return;}this.resourceId=a.id;this.nodes=[];this.edges=[];this.rootNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",a.parentNode,["svg",{id:this.id,width:a.width,height:a.height},["defs",{}]]);this.rootNode.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");this.rootNode.setAttribute("xmlns:svg","http://www.w3.org/2000/svg");this._htmlContainer=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",a.parentNode,["div",{id:"oryx_canvas_htmlContainer",style:"position:absolute; top:"+(Ext.isIPad?-1:5)+"px"}]);this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.rootNode,["g",{},["g",{"class":"stencils"},["g",{"class":"me"}],["g",{"class":"children"}],["g",{"class":"edge"}]],["g",{"class":"svgcontainer"}]]);this.node.setAttributeNS(null,"stroke","black");this.node.setAttributeNS(null,"font-family","Verdana, , sans-serif");this.node.setAttributeNS(null,"font-size-adjust","none");this.node.setAttributeNS(null,"font-style","normal");this.node.setAttributeNS(null,"font-variant","normal");this.node.setAttributeNS(null,"font-weight","normal");this.node.setAttributeNS(null,"line-heigth","normal");this.node.setAttributeNS(null,"font-size",ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT);this.bounds.set(0,0,a.width,a.height);this.addEventHandlers(this.rootNode.parentNode);this.rootNode.oncontextmenu=function(){return false;};},getScrollNode:function(){return Ext.get(this.rootNode).parent("div{overflow=auto}",true);},getScrollPosition:function(){var a=this.getScrollNode().firstChild;if(Ext.isIPad&&a.style.webkitTransform){try{var c=(a.style.webkitTransform||"").replace(/(.*translate.+?)([-0-9\.]+)(.*?)([-0-9\.]+)(.*)/i,"{left:$2, top:$4}");c=c.startsWith("{")?c.evalJSON():{};if(c&&"undefined"!=typeof c.left&&"undefined"!=typeof c.top){c.left*=-1;c.top*=-1;return c;}}catch(b){}}return{left:a.parentNode.scrollLeft,top:a.parentNode.scrollTop};},setScrollPosition:function(e,d){var h=arguments.length===1?(e||{}).left:e,g=arguments.length===1?(e||{}).top:d;if("number"!==typeof h||"number"!==typeof g){return;}var c=this.getScrollNode();if(!Ext.isIPad){c.scrollLeft=h;c.scrollTop=g;}else{var f=c.firstChild;if(this.useAnimation){f.style.webkitTransitionProperty="-webkit-transform";f.style.webkitTransitionTimingFunction="cubic-bezier(0,0,0.25,1)";f.style.webkitTransitionDuration="300ms";}f.style.webkitTransform=(f.style.webkitTransform||"").replace(/translate.*?\)/,"").replace(/\s+/g," ").trim()+" translate("+-(Math.min(f.scrollWidth-f.parentNode.offsetWidth,Math.max(h,0)))+"px, "+-(Math.min(f.scrollHeight-f.parentNode.offsetHeight,Math.max(g,0)))+"px)";}},getZoom:function(){return this.zoomLevel;},setZoom:function(a){if(!Ext.isIPad||!this.useAnimation||true){this.node.setAttributeNS(null,"transform","scale("+a+")");}else{var b=function(c,d){c.style.webkitTransitionProperty="-webkit-transform";c.style.webkitTransitionTimingFunction="cubic-bezier(0,0,0.25,1)";c.style.webkitTransitionDuration="300ms";c.style.webkitTransform="scale("+d+")";};b(this.node.parentNode.parentNode,a);b(this.getHTMLContainer(),1/a);}this.zoomLevel=a;},focus:function(){try{if(!this.focusEl){this.focusEl=Ext.getBody().createChild({tag:"a",href:"#",cls:"x-grid3-focus x-grid3-focus-canvas",tabIndex:"-1"});this.focusEl.swallowEvent("click",true);}if(Ext.isGecko){this.focusEl.focus();}else{this.focusEl.focus.defer(1,this.focusEl);}this.focusEl.blur.defer(3,this.focusEl);}catch(a){}},update:function(){this.nodes.each(function(b){this._traverseForUpdate(b);}.bind(this));var a=this.getStencil().layout();if(a){a.each(function(b){b.shape=this;b.forceExecution=true;b.target=this.rootNode;this._delegateEvent(b);}.bind(this));}this.nodes.invoke("_update");this.edges.invoke("_update",true);},_traverseForUpdate:function(a){var b=a.isChanged;a.getChildNodes(false,function(c){if(this._traverseForUpdate(c)){b=true;}}.bind(this));if(b){a.layout();return true;}else{return false;}},layout:function(){},getChildNodes:function(b,c){if(!b&&!c){return this.nodes.clone();}else{var a=[];this.nodes.each(function(d){if(c){c(d);}a.push(d);if(b&&d instanceof ORYX.Core.Shape){a=a.concat(d.getChildNodes(b,c));}});return a;}},add:function(a,d,b){if(a instanceof ORYX.Core.UIObject){if(!(this.children.member(a))){if(a.parent){a.parent.remove(a,true);}var g=ORYX.Core.StencilSet.rules(this.resourceId);var f=function(k,h){if(k instanceof ORYX.Core.Node&&h instanceof Array){if(!g.isContainable(k)){return h.length;}else{if(!g.isContainable(h.last())){var m=[].concat(h),l;while((l=m.pop())&&!g.isContainable(l)){}return Math.min.apply(Math,[d,l?m.length+1:0].compact());}}}return d;};var c=f(a,this.children);if(c!=undefined){this.children.splice(c,0,a);}else{this.children.push(a);}a.parent=this;if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge){a.addMarkers(this.rootNode.getElementsByTagNameNS(NAMESPACE_SVG,"defs")[0]);this.edges.push(a);}else{var e=this.node.childNodes[0].childNodes[1];var c=f(a,this.nodes);if("number"==typeof c){this.nodes.splice(c,0,a);}else{this.nodes.push(a);}}}else{a.node=this.node.appendChild(a.node);}a.bounds.registerCallback(this._changedCallback);if(this.eventHandlerCallback&&b!==true){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:a});}}else{ORYX.Log.warn("add: ORYX.Core.UIObject is already a child of this object.");}}else{ORYX.Log.fatal("add: Parameter is not of type ORYX.Core.UIObject.");}},remove:function(a,b){if(this.children.member(a)){var c=a.parent;this.children=this.children.without(a);a.parent=undefined;if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge){a.removeMarkers();if($A(this.node.childNodes[0].childNodes[2].childNodes).include(a.node)){a.node=this.node.childNodes[0].childNodes[2].removeChild(a.node);}this.edges=this.edges.without(a);}else{if($A(this.node.childNodes[0].childNodes[1].childNodes).include(a.node)){a.node=this.node.childNodes[0].childNodes[1].removeChild(a.node);}this.nodes=this.nodes.without(a);}}else{if($A(this.node.childNodes).include(a.node)){a.node=this.node.removeChild(a.node);}}if(this.eventHandlerCallback&&b!==true){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEREMOVED,shape:a,parent:c});}a.bounds.unregisterCallback(this._changedCallback);}else{ORYX.Log.warn("remove: ORYX.Core.UIObject is not a child of this object.");}},addShapeObjects:function(d,c){if(!d){return;}this.initializingShapes=true;var b=function(f,k){var l=ORYX.Core.StencilSet.stencil(this.getStencil().namespace()+f.stencil.id);if(!l){try{throw new Error(this.getStencil().namespace()+f.stencil.id+" is undefined.");}catch(m){if(window.console&&console.log){console.log(m);}}return;}var h=(l.type()=="node")?ORYX.Core.Node:ORYX.Core.Edge;var g=new h({"eventHandlerCallback":c},l);g.setResourceId(f.resourceId);f.parent="#"+((f.parent&&f.parent.resourceId)||k.resourceId);this.add(g);return{json:f,object:g};}.bind(this);var e=function(f){var g=[];f.childShapes.each(function(h){g.push(b(h,f));g=g.concat(e(h));});return g;}.bind(this);var a=e({childShapes:d,resourceId:this.resourceId}).compact();a.each(function(f){var g=[];for(field in f.json.properties){g.push({prefix:"oryx",name:field,value:f.json.properties[field]});}f.json.outgoing.each(function(k){if(k){g.push({prefix:"raziel",name:"outgoing",value:"#"+k.resourceId});}});if(f.object instanceof ORYX.Core.Edge){var h=f.json.target||f.json.outgoing[0];if(h){g.push({prefix:"raziel",name:"target",value:"#"+h.resourceId});}}if(f.json.bounds&&f.json.bounds.upperLeft&&f.json.bounds.lowerRight&&[f.json.bounds.upperLeft.x,f.json.bounds.upperLeft.y,f.json.bounds.lowerRight.x,f.json.bounds.lowerRight.y].all(function(k){return"number"==typeof k;})){g.push({prefix:"oryx",name:"bounds",value:f.json.bounds.upperLeft.x+","+f.json.bounds.upperLeft.y+","+f.json.bounds.lowerRight.x+","+f.json.bounds.lowerRight.y});}if(f.json.dockers){g.push({prefix:"oryx",name:"dockers",value:f.json.dockers.inject("",function(l,k){return l+k.x+" "+k.y+" ";})+" #"});}g.push({prefix:"raziel",name:"parent",value:f.json.parent});f.__properties=g;}.bind(this));a.each(function(f){if(f.object instanceof ORYX.Core.Node){f.object.deserialize(f.__properties,f.json);}});a.each(function(f){if(f.object instanceof ORYX.Core.Edge){f.object.deserialize(f.__properties,f.json);f.object._oldBounds=f.object.bounds.clone();f.object._update();}});delete this.initializingShapes;return a.pluck("object");},updateSize:function(){var b=0;var a=0;var c=100;this.getChildShapes(true,function(e){var d=e.bounds;b=Math.max(b,d.lowerRight().x+c);a=Math.max(a,d.lowerRight().y+c);});if(this.bounds.width()<b||this.bounds.height()<a){this.setSize({width:Math.max(this.bounds.width(),b),height:Math.max(this.bounds.height(),a)});}},getRootNode:function(){return this.rootNode;},getSvgContainer:function(){return this.node.childNodes[1];},getChildContainer:function(){return this.node.childNodes[0].childNodes[1];},getEdgeContainer:function(){return this.node.childNodes[0].childNodes[2];},getHTMLContainer:function(){return this._htmlContainer;},getShapesWithSharedParent:function(a){if(!a||a.length<1){return[];}if(a.length==1){return a;}return a.findAll(function(c){var b=c.parent;while(b){if(a.member(b)){return false;}b=b.parent;}return true;});},setSize:function(b,a){if(!b||!b.width||!b.height){return;}if(this.rootNode.parentNode){this.rootNode.parentNode.style.width=b.width+"px";this.rootNode.parentNode.style.height=b.height+"px";}this.rootNode.setAttributeNS(null,"width",b.width);this.rootNode.setAttributeNS(null,"height",b.height);this.updateScrollArea();if(!a){this.bounds.set({a:{x:0,y:0},b:{x:b.width/this.getZoom(),y:b.height/this.getZoom()}});}},updateScrollArea:function(){if(Ext.isIPad&&"undefined"!==window.iScroll&&this.iscroll){this.iscroll.destroy();this.iscroll=new iScroll(this.rootNode.parentNode,{touchCount:2});}},getShapeSize:function(){var c,m,b,l;var d=false;if(Ext.isChrome){try{var p=this.getRootNode().childNodes[1].childNodes[0].childNodes[1].getBBox();if(p.x===0||p.y===0){var a;this.getChildShapes(true).each(function(e){var q=e.absoluteBounds();if(!a){a=q.clone();}else{a.include(q);}e.getLabels().each(function(r){if(r.node.textContent){if(Ext.isChrome){if(r.node.getAttributeNS(null,"display")==="none"){return;}}var s=ORYX.Core.Math.getTranslatedBoundingBox(r.node);a.include(new ORYX.Core.Bounds(s.x,s.y,s.x+s.width,s.y+s.height));}});});return a||new ORYX.Core.Bounds(0,0,0,0);}}catch(g){}}if(Ext.isIE9){d=true;}if(d){var k=this.getRootNode().childNodes[1].childNodes[0].childNodes[1].getBBox();c=k.x;m=k.y;b=k.x+k.width;l=k.y+k.height;var o=function(q,s,e,r){if(!q&&!s&&!e&&!r){return;}c=Math.min(c,q);m=Math.min(m,s);b=Math.max(b,e);l=Math.max(l,r);};this.getChildShapes(false).each(function(e){if(e instanceof ORYX.Core.Edge){o(e.bounds.a.x,e.bounds.a.y,e.bounds.b.x,e.bounds.b.y);e.getLabels().each(function(q){var r=q.node.getBBox();o(r.x,r.y,r.x+r.width,r.y+r.height);});}});}else{try{var h=9;var f=this.getRootNode().childNodes[1].childNodes[0].childNodes[1].getBBox();var n=this.getRootNode().childNodes[1].childNodes[0].childNodes[2].getBBox();if(!f.x&&!f.y&&!f.width&&!f.height){f=n;}if(!n.x&&!n.y&&!n.width&&!n.height){n=f;}c=Math.min(f.x,n.x+h);m=Math.min(f.y,n.y+h);b=Math.max(f.x+f.width,n.x+n.width-h);l=Math.max(f.y+f.height,n.y+n.height-h);}catch(g){return this.getShapeBounds();}}return new ORYX.Core.Bounds(c,m,b,l);},getShapeBounds:function(){var a;this.getChildShapes().each(function(b){var c=b.absoluteBounds();if(!a){a=c.clone();}else{a.include(c);}});return a||new ORYX.Core.Bounds(0,0,0,0);},getSVGRepresentation:function(k){var f=this.getRootNode().cloneNode(true);this._removeInvisibleElements(f);var m=this.getShapeSize(),c=50;var b=m.width(),l=m.height(),g=-m.upperLeft().x+(this.children.length?(c/2):0),d=-m.upperLeft().y+(this.children.length?(c/2):0);f.setAttributeNS(null,"width",b+c);f.setAttributeNS(null,"height",l+c);f.childNodes[1].firstChild.setAttributeNS(null,"transform","translate("+g+", "+d+")");f.childNodes[1].setAttributeNS(null,"transform","scale(1)");f.childNodes[1].setAttributeNS(null,"transform","");f.childNodes[1].removeAttributeNS(null,"transform");try{var a=f.childNodes[1].childNodes[1];a.parentNode.removeChild(a);}catch(h){}if(k){$A(f.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan")).each(function(e){e.textContent=e.textContent.escapeHTML();});$A(f.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"text")).each(function(e){if(e.childNodes.length==0){e.textContent=e.textContent.escapeHTML();}});}$A(f.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"image")).each(function(n){var e=n.getAttributeNS("http://www.w3.org/1999/xlink","href");if(!e.match("^(http|https)://")){e=window.location.protocol+"//"+window.location.host+e;n.setAttributeNS("http://www.w3.org/1999/xlink","href",e);}});$A(f.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"a")).each(function(e){e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",(e.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").escapeHTML());});return f;},_removeInvisibleElements:function(d){var b=0,a=d.childNodes,c=a.length;while(b<c){var e=a[b];if(e.getAttributeNS&&(e.getAttributeNS(null,"visibility")==="hidden"||e.getAttributeNS(null,"display")==="none"||(e.getAttribute("stroke")==="none"&&e.getAttribute("fill")==="none"))){d.removeChild(e);--c;}else{this._removeInvisibleElements(e);++b;}}},_delegateEvent:function(a){if(this.eventHandlerCallback&&(!a.target||a.target==this.rootNode||a.target==this.rootNode.parentNode)){this.eventHandlerCallback(a,this);}},setLanguage:function(a){if(a==this.getLanguage()){return false;}this.language=a;this.getChildShapes(true).each(function(b){if(b.getStencil().properties().findAll(function(c){if(c.language()===a&&c.refToView().length>0){b.propertiesChanged[c.prefix()+"-"+c.id()]=true;return true;}return false;}).length>0){b._changed();}});this.update();},getLanguage:function(){return this.language||ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT;},setOrientation:function(a){if(a!=="horizontal"&&a!=="vertical"){return;}this.orientation=undefined;this.setProperty("oryx-orientation",a);},getOrientation:function(){return this.orientation||this.properties["oryx-orientation"];},toString:function(){return"Canvas "+this.id;},toJSON:function(){var a=arguments.callee.$.toJSON.apply(this,arguments);if(this.language&&this.language!==ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT){a.language=this.language;}a.stencilset={url:this.getStencil().stencilSet().source(),namespace:this.getStencil().stencilSet().namespace()};return a;}});var idCounter=0;var ID_PREFIX="resource";function init(){Ext.BLANK_IMAGE_URL=(ORYX.CONFIG.BLANK_IMAGE)||(ORYX.CONFIG.LIBS_PATH+"/ext-2.0.2/resources/images/default/s.gif");var d=ORYX.I18N.Language;document.documentElement.className+=" "+d.split("_").concat(d).uniq().join(" ");var b=Ext.isIE7?"x-ie x-ie7":(Ext.isIE?"x-ie":(Ext.isGecko?"x-gecko":(ORYX.Utils.isIPad()?"x-ipad":"x-other")));var a=ORYX.Utils.getBrowserVersion();document.documentElement.className+=" "+b+" "+b+"-"+a.replace(/\./g,"-");ORYX.Log.debug("Querying editor instances");ORYX.Editor.setMissingClasses();if(window.onOryxResourcesLoaded){window.onOryxResourcesLoaded();}else{if(window.location.pathname.include(ORYX.CONFIG.ORYX_NEW_URL)){new ORYX.Editor({id:"oryx-canvas123",fullscreen:true,stencilset:{url:"/v5designer/editor/"+ORYX.Utils.getParamFromUrl("stencilset")}});}else{var c=window.location.href.replace(/#.*/g,"");if(c.endsWith("/self")){c=c.replace("/self","/json");}else{c=c.replace(ORYX.CONFIG.SERVER_EDITOR_HANDLER.replace("..",""),ORYX.CONFIG.SERVER_EDITOR_DATA_HANDLER.replace("..",""));}c=c+"&data";ORYX.Editor.createByUrl(c,{id:c});}}}if(!ORYX){var ORYX={};}ORYX.Editor={DOMEventListeners:new Hash(),selection:[],zoomLevel:1,construct:function(d){this._eventsQueue=[];this.loadedPlugins=[];this.pluginsData=[];this.modelMetaData=d;var c=d;if(d.model){c=d.model;}this.id=c.resourceId;if(!this.id){this.id=c.id;if(!this.id){this.id=ORYX.Editor.provideId();}}this.fullscreen=d.fullscreen!==false;this._initEventListener();if(ORYX.CONFIG.BACKEND_SWITCH){var b=(c.stencilset.namespace||c.stencilset.url).replace("#","%23");ORYX.Core.StencilSet.loadStencilSet(ORYX.CONFIG.STENCILSET_HANDLER+b,this.id);}else{var b=c.stencilset.url;b=ORYX.CONFIG.SERVER_HANDLER_ROOT+b;ORYX.Core.StencilSet.loadStencilSet(b,this.id);}this._loadStencilSetExtensionConfig();if(!!ORYX.CONFIG.SSEXTS){ORYX.CONFIG.SSEXTS.each(function(g){this.loadSSExtension(g.namespace);}.bind(this));}this._createCanvas(c.stencil?c.stencil.id:null,c);this._generateGUI();var f=false;var e=false;var a=function(){if(!f||!e){return;}this._finishedLoading();}.bind(this);ORYX.Editor.makeExtModalWindowKeysave(this._getPluginFacade());window.setTimeout(function(){this.loadPlugins();f=true;a();}.bind(this),100);window.setTimeout(function(){this.loadSerialized(c,true);this.getCanvas().update();e=true;a();}.bind(this),200);},_finishedLoading:function(){if(Ext.getCmp("oryx-loading-panel")){Ext.getCmp("oryx-loading-panel").hide();}this.layout.doLayout();new Ext.dd.DropTarget(this.getCanvas().rootNode.parentNode);Ext.Component.prototype.stateful=false;if(ORYX.CONFIG.PANEL_RIGHT_COLLAPSED===true){this.layout_regions.east.collapse();}if(ORYX.CONFIG.PANEL_LEFT_COLLAPSED===true){this.layout_regions.west.collapse();}if(String(window.navigator.userAgent).include("Firefox/3.5 Prism")&&"function"==typeof this.layout.fireResize){window.setTimeout(function(a){this.layout.fireResize(a.getWidth(),a.getHeight());}.bind(this,Ext.getBody()),100);}this.handleEvents({type:ORYX.CONFIG.EVENT_LOADED});},_initEventListener:function(){document.documentElement.addEventListener(ORYX.CONFIG.EVENT_KEYDOWN,this.catchKeyDownEvents.bind(this),false);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_KEYUP,this.catchKeyUpEvents.bind(this),false);this._keydownEnabled=true;this._keyupEnabled=true;this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEDOWN]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEUP]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEOVER]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEOUT]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_SELECTION_CHANGED]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEMOVE]=[];},_generateGUI:function(){var b=ORYX.CONFIG.WINDOW_HEIGHT;var d=this.getCanvas().rootNode.parentNode;var a=Ext.layout.BorderLayout.Region.prototype.getCollapsedEl;Ext.layout.BorderLayout.Region.prototype.getCollapsedEl=function(){a.apply(this,arguments);if(this.collapseMode!=="mini"&&this.floatable===false&&this.expandTriggerAll===true){this.collapsedEl.addClassOnOver("x-layout-collapsed-over");this.collapsedEl.on("mouseover",this.collapsedEl.addClass.bind(this.collapsedEl,"x-layout-collapsed-over"));this.collapsedEl.on("click",this.onExpandClick,this);}if(this.collapseTitle){var e=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.collapsedEl.dom,["svg",{style:"position:relative;left:"+(this.position==="west"?4:6)+"px;top:"+(this.position==="west"?2:5)+"px;"},["text",{transform:"rotate(90)",x:0,y:0,"stroke-width":"0px",fill:"#EEEEEE",style:"font-weight:bold;","font-size":"11"},this.collapseTitle]]);var f=e.childNodes[0];e.setAttribute("xmlns:svg","http://www.w3.org/2000/svg");if(this.position==="west"&&f.getComputedTextLength instanceof Function){window.setTimeout(function(){var g=f.getComputedTextLength();f.setAttributeNS(null,"transform","rotate(-90, "+((g/2)+7)+", "+((g/2)-3)+")");},1);}delete this.collapseTitle;}return this.collapsedEl;};this.layout_regions={north:new Ext.Panel({region:"north",cls:"x-panel-editor-north",autoEl:"div",border:false}),east:new Ext.Panel({region:"east",layout:"fit",cls:"x-panel-editor-east",autoEl:"div",collapseTitle:ORYX.I18N.View.East,titleCollapse:true,border:false,cmargins:{left:0,right:0},floatable:false,expandTriggerAll:true,collapsible:true,width:ORYX.CONFIG.PANEL_RIGHT_WIDTH||200,split:true,title:"East"}),south:new Ext.Panel({region:"south",cls:"x-panel-editor-south",autoEl:"div",border:false}),west:new Ext.Panel({region:"west",layout:"anchor",autoEl:"div",cls:"x-panel-editor-west",collapsible:true,titleCollapse:true,collapseTitle:ORYX.I18N.View.West,width:ORYX.CONFIG.PANEL_LEFT_WIDTH||200,autoScroll:Ext.isIPad?false:true,cmargins:{left:0,right:0},floatable:false,expandTriggerAll:true,split:true,title:"West"}),center:new Ext.Panel({region:"center",cls:"x-panel-editor-center",autoScroll:true,items:{layout:"fit",autoHeight:true,el:d}})};for(region in this.layout_regions){if(region!="center"){}}var c={layout:"border",items:[this.layout_regions.north,this.layout_regions.east,this.layout_regions.south,this.layout_regions.west,this.layout_regions.center]};if(this.fullscreen){this.layout=new Ext.Viewport(c);}else{c.renderTo=this.id;c.height=b;this.layout=new Ext.Panel(c);}if(Ext.isIPad&&"undefined"!=typeof iScroll){this.getCanvas().iscroll=new iScroll(this.layout_regions.center.body.dom.firstChild,{touchCount:2});}this._generateHeader();d.parentNode.setAttributeNS(null,"align","center");d.setAttributeNS(null,"align","left");this.getCanvas().setSize({width:ORYX.CONFIG.CANVAS_WIDTH,height:ORYX.CONFIG.CANVAS_HEIGHT});},_generateHeader:function(){var e=function(){var n=this.getModelMetaData();if(n["new"]){return ORYX.CONFIG.WEB_URL+"#"+n.parent;}else{return ORYX.CONFIG.WEB_URL+"#/model/"+n.modelId;}}.bind(this);var b=ORYX.Core.Command.extend({construct:function(p,q,n,o){this.editor=p;this.value=q;this.oldValue=n;this.modelMetaData=o;},execute:function(){this.modelMetaData.name=this.value;this.editor.boundEl.dom.textContent=this.value;},rollback:function(){this.modelMetaData.name=this.oldValue;this.editor.boundEl.dom.textContent=this.oldValue;}});var a=new Ext.Editor(new Ext.form.TextField({cls:"y-header-document-name-editor",allowBlank:false}),{cancelOnEsc:true,completeOnEnter:true,updateEl:true,autoSize:"width",shadow:"drop",listeners:{beforecomplete:function(o,p,n){if(p!==n){this._getPluginFacade().executeCommands([new b(o,p,n,this.getModelMetaData())]);}o.editing=false;o.hide();return false;}.bind(this)}});var m=new Ext.Panel({height:30,autoHeight:false,border:false,html:"<div id='oryx_editor_header'>"+'<a href="'+(e())+'" target="_blank">'+"<img src='"+ORYX.PATH+'images/oryx.small.gif\' border="0" />'+"</a>"+"</div>",listeners:{bodyresize:function(){this.updateDocumentNameEditor(a,$("header-document-name"));}.bind(this)}});var g=ORYX.MashupAPI&&ORYX.MashupAPI.isUsed;var d=g?ORYX.MashupAPI.key:"";var k=g?ORYX.MashupAPI.canRun:false;var c=g?ORYX.MashupAPI.isModelRemote:true;var l=c?"<img src='"+ORYX.PATH+"images/page_white_put.png'/>":"";var f=g?"<span class='mashupinfo'><img src='"+ORYX.PATH+"images/"+(k?"plugin_error":"plugin")+".png'/>"+l+"</span>":"";var h=function(q){q=q||ORYX.Editor.Cookie.getParams();var p=ORYX.I18N.Oryx.notLoggedOn;var n=q&&q.identifier&&q.identifier!="public"?decodeURI(q.identifier.gsub('"',"")).replace(/\+/g," "):"";if(n.length<=0){n=p;}var o="<div id='oryx_editor_header'>"+'<a href="'+(e())+'" target="_blank">'+"<img src='"+ORYX.PATH+'images/oryx.small.gif\' border="0" />'+"</a>"+"<span class='openid "+(p==n?"not":"")+"'>"+"<span class='y-header-document-name' id='header-document-name'></span>"+(unescape(n))+f+"</span>"+"<div style='clear: both;'/>"+"</div>";if(m.body){m.body.dom.innerHTML=o;}else{m.html=o;}this.updateDocumentNameEditor(a,$("header-document-name"));}.bind(this);ORYX.Editor.Cookie.onChange(h);h(ORYX.Editor.Cookie.getParams());this.registerOnEvent(ORYX.CONFIG.EVENT_SAVED,h.bind(this,undefined));this.addToRegion("north",m);},updateDocumentNameEditor:function(c,b){if(c&&b){var a=(this.getModelMetaData()["name"]||ORYX.I18N.Save.newProcess||"");a=a.truncate(ORYX.CONFIG.MAX_DIAGRAM_TITLE_LENGTH,"...").toString();b.textContent=Signavio.Utils.unescapeHTML(a);b.addEventListener("click",function(d){c.startEdit(d.currentTarget,Signavio.Utils.unescapeHTML(d.currentTarget.textContent));}.bind(this),false);}},addToRegion:function(d,a,e){if(d.toLowerCase&&this.layout_regions[d.toLowerCase()]){var b=this.layout_regions[d.toLowerCase()];b.add(a);ORYX.Log.debug("original dimensions of region %0: %1 x %2",b.region,b.width,b.height);if(!b.width&&a.initialConfig&&a.initialConfig.width){ORYX.Log.debug("resizing width of region %0: %1",b.region,a.initialConfig.width);b.setWidth(a.initialConfig.width);}if(a.initialConfig&&a.initialConfig.height){ORYX.Log.debug("resizing height of region %0: %1",b.region,a.initialConfig.height);var c=b.height||0;b.height=a.initialConfig.height+c;b.setHeight(a.initialConfig.height+c);}if(typeof e=="string"){b.setTitle(e);}b.ownerCt.doLayout();b.show();if(Ext.isMac){ORYX.Editor.resizeFix();}return b;}return null;},getAvailablePlugins:function(){var a=ORYX.availablePlugins.clone();a.each(function(b){if(this.loadedPlugins.find(function(c){return c.type==this.name;}.bind(b))){b.engaged=true;}else{b.engaged=false;}}.bind(this));return a;},loadScript:function(b,c){var a=document.createElement("script");a.type="text/javascript";if(a.readyState){a.onreadystatechange=function(){if(a.readyState=="loaded"||a.readyState=="complete"){a.onreadystatechange=null;c();}};}else{a.onload=function(){c();};}a.src=b;document.getElementsByTagName("head")[0].appendChild(a);},activatePluginByName:function(name,callback,loadTry){var match=this.getAvailablePlugins().find(function(value){return value.name==name;});if(match&&(!match.engaged||(match.engaged==="false"))){var loadedStencilSetsNamespaces=this.getStencilSets().keys();var facade=this._getPluginFacade();var newPlugin;var me=this;ORYX.Log.debug("Initializing plugin '%0'",match.name);if(!match.requires||!match.requires.namespaces||match.requires.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0;})){if(!match.notUsesIn||!match.notUsesIn.namespaces||!match.notUsesIn.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0;})){try{var className=eval(match.name);var newPlugin=new className(facade,match);newPlugin.type=match.name;if(newPlugin.registryChanged){newPlugin.registryChanged(me.pluginsData);}if(newPlugin.onSelectionChanged){me.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,newPlugin.onSelectionChanged.bind(newPlugin));}this.loadedPlugins.push(newPlugin);this.loadedPlugins.each(function(loaded){if(loaded.registryChanged){loaded.registryChanged(this.pluginsData);}}.bind(me));callback(true);}catch(e){ORYX.Log.warn("Plugin %0 is not available",match.name);if(!!loadTry){callback(false,"INITFAILED");return;}this.loadScript("plugins/scripts/"+match.source,this.activatePluginByName.bind(this,match.name,callback,true));}}else{callback(false,"NOTUSEINSTENCILSET");ORYX.Log.info("Plugin need a stencilset which is not loaded'",match.name);}}else{callback(false,"REQUIRESTENCILSET");ORYX.Log.info("Plugin need a stencilset which is not loaded'",match.name);}}else{callback(false,match?"NOTFOUND":"YETACTIVATED");}},loadPlugins:function(){var me=this;var newPlugins=[];var loadedStencilSetsNamespaces=this.getStencilSets().keys();var facade=this._getPluginFacade();if(ORYX.MashupAPI&&ORYX.MashupAPI.loadablePlugins&&ORYX.MashupAPI.loadablePlugins instanceof Array){ORYX.availablePlugins=$A(ORYX.availablePlugins).findAll(function(value){return ORYX.MashupAPI.loadablePlugins.include(value.name);});ORYX.MashupAPI.loadablePlugins.each(function(className){if(!(ORYX.availablePlugins.find(function(val){return val.name==className;}))){ORYX.availablePlugins.push({name:className});}});}ORYX.availablePlugins.each(function(value){ORYX.Log.debug("Initializing plugin '%0'",value.name);if((!value.requires||!value.requires.namespaces||value.requires.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0;}))&&(!value.notUsesIn||!value.notUsesIn.namespaces||!value.notUsesIn.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0;}))&&(value.engaged||(value.engaged===undefined))){try{var className=eval(value.name);if(className){var plugin=new className(facade,value);plugin.type=value.name;newPlugins.push(plugin);plugin.engaged=true;}}catch(e){ORYX.Log.warn("Plugin %0 is not available",value.name);}}else{ORYX.Log.info("Plugin need a stencilset which is not loaded'",value.name);}});newPlugins.each(function(value){if(value.registryChanged){value.registryChanged(me.pluginsData);}if(value.onSelectionChanged){me.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,value.onSelectionChanged.bind(value));}});this.loadedPlugins=newPlugins;if(Ext.isMac){ORYX.Editor.resizeFix();}this.registerPluginsOnKeyEvents();this.setSelection();},_loadStencilSetExtensionConfig:function(){new Ajax.Request(ORYX.CONFIG.SS_EXTENSIONS_CONFIG,{method:"GET",asynchronous:false,onSuccess:(function(b){var a=Ext.decode(b.responseText);this.ss_extensions_def=a;}).bind(this),onFailure:(function(a){ORYX.Log.error("Editor._loadStencilSetExtensionConfig: Loading stencil set extension configuration file failed."+a);}).bind(this)});},_createCanvas:function(d,b){if(d){if(d.search(/^http/)===-1){d=this.getStencilSets().values()[0].namespace()+d;}}else{d=this.getStencilSets().values()[0].findRootStencilName();}var a=ORYX.Core.StencilSet.stencil(d);if(!a){ORYX.Log.fatal("Initialisation failed, because the stencil with the type %0 is not part of one of the loaded stencil sets.",d);}var e=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,["div"]);e.addClassName("ORYX_Editor");this._canvas=new ORYX.Core.Canvas({width:ORYX.CONFIG.CANVAS_WIDTH,height:ORYX.CONFIG.CANVAS_HEIGHT,"eventHandlerCallback":this.handleEvents.bind(this),id:this.id,parentNode:e},a);if(b&&b.properties){var c=[];for(field in b.properties){c.push({prefix:"oryx",name:field,value:b.properties[field],format:(b.formats?b.formats[field]:[])});}this._canvas.deserialize(c);if(this.modelMetaData.model&&this.modelMetaData.model.language){this._canvas.setLanguage(this.modelMetaData.model.language);}if(this.modelMetaData.model&&this.modelMetaData.model.orientation){this._canvas.setOrientation(this.modelMetaData.model.orientation);}}},_getPluginFacade:function(){if(!(this._pluginFacade)){this._pluginFacade={activatePluginByName:this.activatePluginByName.bind(this),getAvailablePlugins:this.getAvailablePlugins.bind(this),offer:this.offer.bind(this),getStencilSets:this.getStencilSets.bind(this),getStencilSetExtensionDefinition:function(){return Object.clone(this.ss_extensions_def||{});}.bind(this),getRules:this.getRules.bind(this),loadStencilSet:this.loadStencilSet.bind(this),createShape:this.createShape.bind(this),deleteShape:this.deleteShape.bind(this),getSelection:this.getSelection.bind(this),setSelection:this.setSelection.bind(this),updateSelection:this.updateSelection.bind(this),getCanvas:this.getCanvas.bind(this),importJSON:this.importJSON.bind(this),importERDF:this.importERDF.bind(this),getERDF:this.getERDF.bind(this),getJSON:this.getJSON.bind(this),getSerializedJSON:this.getSerializedJSON.bind(this),executeCommands:this.executeCommands.bind(this),isExecutingCommands:this.isExecutingCommands.bind(this),registerOnEvent:this.registerOnEvent.bind(this),unregisterOnEvent:this.unregisterOnEvent.bind(this),raiseEvent:this.handleEvents.bind(this),enableEvent:this.enableEvent.bind(this),disableEvent:this.disableEvent.bind(this),eventCoordinates:this.eventCoordinates.bind(this),addToRegion:this.addToRegion.bind(this),getModelMetaData:this.getModelMetaData.bind(this)};}return this._pluginFacade;},isExecutingCommands:function(){return !!this.commandExecuting;},executeCommands:function(a){if(!this.commandStack){this.commandStack=[];}if(!this.commandStackExecuted){this.commandStackExecuted=[];}this.commandStack=[].concat(this.commandStack).concat(a).compact();if(this.commandExecuting){return;}this.commandExecuting=true;while(this.commandStack.length>0){var b=this.commandStack.shift();b.execute();this.commandStackExecuted.push(b);if(this.commandStack.length==0){this.handleEvents({type:ORYX.CONFIG.EVENT_LAST_EXECUTE_COMMANDS,commands:this.commandStackExecuted});this.getCanvas().update();this.updateSelection();}}this.handleEvents({type:ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,commands:this.commandStackExecuted});delete this.commandStack;delete this.commandStackExecuted;delete this.commandExecuting;this.updateSelection();},getJSON:function(){var a=this.getCanvas().toJSON();a.ssextensions=this.getStencilSets().values()[0].extensions().keys().findAll(function(b){return !b.endsWith("/meta#");});return a;},getSerializedJSON:function(){return Ext.encode(this.getJSON());},getERDF:function(){var a=DataManager.serializeDOM(this._getPluginFacade());a='<?xml version="1.0" encoding="utf-8"?>'+'<html xmlns="http://www.w3.org/1999/xhtml" '+'xmlns:b3mn="http://b3mn.org/2007/b3mn" '+'xmlns:ext="http://b3mn.org/2007/ext" '+'xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" '+'xmlns:atom="http://b3mn.org/2007/atom+xhtml">'+'<head profile="http://purl.org/NET/erdf/profile">'+'<link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" />'+'<link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " />'+'<link rel="schema.b3mn" href="http://b3mn.org" />'+'<link rel="schema.oryx" href="http://oryx-editor.org/" />'+'<link rel="schema.raziel" href="http://raziel.org/" />'+'<base href="'+location.href.split("?")[0]+'" />'+"</head><body>"+a+"</body></html>";return a;},importJSON:function(d,c){try{d=this.renewResourceIds(d);}catch(b){throw b;}if(d.stencilset.namespace&&d.stencilset.namespace!==this.getCanvas().getStencil().stencilSet().namespace()){Ext.Msg.alert(ORYX.I18N.JSONImport.title,String.format(ORYX.I18N.JSONImport.wrongSS,d.stencilset.namespace,this.getCanvas().getStencil().stencilSet().namespace()));return null;}else{var a=ORYX.Core.Command.extend({construct:function(g,k,f,h){this.jsonObject=g;this.noSelection=f;this.facade=h;this.shapes;this.connections=[];this.parents=new Hash();this.selection=this.facade.getSelection();this.loadSerialized=k;},execute:function(){if(!this.shapes){this.shapes=this.loadSerialized(this.jsonObject);this.shapes.each(function(g){if(g.getDockers){var f=g.getDockers();if(f){if(f.length>0){this.connections.push([f.first(),f.first().getDockedShape(),f.first().referencePoint]);}if(f.length>1){this.connections.push([f.last(),f.last().getDockedShape(),f.last().referencePoint]);}}}this.parents[g.id]=g.parent;}.bind(this));}else{this.shapes.each(function(f){this.parents[f.id].add(f);}.bind(this));this.connections.each(function(f){f[0].setDockedShape(f[1]);f[0].setReferencePoint(f[2]);f[0].update();});}this.facade.getCanvas().update();if(!this.noSelection){this.facade.setSelection(this.shapes);}else{this.facade.updateSelection();}this.facade.getCanvas().updateSize();},rollback:function(){var f=this.facade.getSelection();this.shapes.each(function(g){f=f.without(g);this.facade.deleteShape(g);}.bind(this));this.facade.getCanvas().update();this.facade.setSelection(f);}});var e=new a(d,this.loadSerialized.bind(this),c,this._getPluginFacade());this.executeCommands([e]);return e.shapes.clone();}},renewResourceIds:function(b){if(Ext.type(b)==="string"){try{var d=b;b=Ext.decode(b);}catch(a){throw new SyntaxError(a.message);}}else{var d=Ext.encode(b);}var e=function(f){if(!f){return[];}return f.map(function(g){return e(g.childShapes).concat(g.resourceId);}).flatten();};var c=e(b.childShapes);c.each(function(f){var g=ORYX.Editor.provideId();d=d.gsub('"'+f+'"','"'+g+'"');});return Ext.decode(d);},importERDF:function(a){var b=this.parseToSerializeObjects(a);if(b){return this.importJSON(b,true);}},parseToSerializeObjects:function(c){if(c.normalize){c.normalize();}try{var d="";var a=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:function(e){d=e.responseText;}.bind(this),onFailure:(function(e){ORYX.Log.error("XSL load failed"+e);}).bind(this)});var m=new DOMParser();var g=c;var f=m.parseFromString(d,"text/xml");var h=new XSLTProcessor();var n=document.implementation.createDocument("","",null);h.importStylesheet(f);var o=h.transformToFragment(g,document);var b=(new XMLSerializer()).serializeToString(o);}catch(k){Ext.Msg.alert("Oryx",error);var b="";}b=!b.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+b:b;var l=new Ajax.Request("/p/rdf2json",{method:"POST",asynchronous:false,onSuccess:function(e){Ext.decode(e.responseText);},parameters:{rdf:b}});return Ext.decode(l.transport.responseText);},loadSerialized:function(d,e){var c=this.getCanvas();this.loadSSExtensions(d.ssextensions);if(e===true){var b=this.getExtensionForMetaData();if(b){this.loadSSExtension(b);}}var a=this.getCanvas().addShapeObjects(d.childShapes,this.handleEvents.bind(this));if(d.properties){for(key in d.properties){var f=d.properties[key];var g=this.getCanvas().getStencil().property("oryx-"+key);if(!(typeof f==="string")&&(!g||!g.isList())){f=Ext.encode(f);}this.getCanvas().setProperty("oryx-"+key,f);}}this.getCanvas().updateSize();this.selection=[null];this.setSelection([]);return a;},getExtensionForMetaData:function(){if(!this.ss_extensions_def||!(this.ss_extensions_def.extensions instanceof Array)){return null;}var a=this.getStencilSets();var b=this.ss_extensions_def.extensions.find(function(c){return !!a[c["extends"]]&&c.namespace.endsWith("/meta#");});return b?b.namespace||null:null;},loadSSExtensions:function(a){if(!a){return;}a.each(function(b){this.loadSSExtension(b);}.bind(this));},loadSSExtension:function(b){if(this.ss_extensions_def){var c=this.getStencilSets();var d=this.ss_extensions_def.extensions.find(function(e){return e.namespace===b&&c[e["extends"]];});if(!d){return;}var a=c[d["extends"]];if(!a){return;}if((d["definition"]||"").startsWith("/")){a.addExtension(d["definition"]);}else{a.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+d["definition"]);}this.getRules().initializeRules(a);this._getPluginFacade().raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});}},disableEvent:function(a){if(a==ORYX.CONFIG.EVENT_KEYDOWN){this._keydownEnabled=false;}if(a==ORYX.CONFIG.EVENT_KEYUP){this._keyupEnabled=false;}if(this.DOMEventListeners.keys().member(a)){var b=this.DOMEventListeners.remove(a);this.DOMEventListeners["disable_"+a]=b;}},enableEvent:function(a){if(a==ORYX.CONFIG.EVENT_KEYDOWN){this._keydownEnabled=true;}if(a==ORYX.CONFIG.EVENT_KEYUP){this._keyupEnabled=true;}if(this.DOMEventListeners.keys().member("disable_"+a)){var b=this.DOMEventListeners.remove("disable_"+a);this.DOMEventListeners[a]=b;}},registerOnEvent:function(a,b){if(!(this.DOMEventListeners.keys().member(a))){this.DOMEventListeners[a]=[];}if(!this.DOMEventListeners[a].include(b)){this.DOMEventListeners[a].push(b);}},unregisterOnEvent:function(a,b){if(this.DOMEventListeners.keys().member(a)){this.DOMEventListeners[a]=this.DOMEventListeners[a].without(b);}else{}},getSelection:function(){return this.selection||[];},getStencilSets:function(){return ORYX.Core.StencilSet.stencilSets(this.id);},getRules:function(){return ORYX.Core.StencilSet.rules(this.id);},loadStencilSet:function(a){try{ORYX.Core.StencilSet.loadStencilSet(a,this.id);this.handleEvents({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});}catch(b){ORYX.Log.warn("Requesting stencil set file failed. ("+b+")");}},offer:function(a){if(!this.pluginsData.member(a)){this.pluginsData.push(a);}},registerPluginsOnKeyEvents:function(){this.pluginsData.each(function(a){if(a.keyCodes){a.keyCodes.each(function(c){var b="key.event";b+="."+c.keyAction;if(c.metaKeys){if(c.metaKeys.indexOf(ORYX.CONFIG.META_KEY_META_CTRL)>-1){b+="."+ORYX.CONFIG.META_KEY_META_CTRL;}if(c.metaKeys.indexOf(ORYX.CONFIG.META_KEY_ALT)>-1){b+="."+ORYX.CONFIG.META_KEY_ALT;}if(c.metaKeys.indexOf(ORYX.CONFIG.META_KEY_SHIFT)>-1){b+="."+ORYX.CONFIG.META_KEY_SHIFT;}}if(c.keyCode){b+="."+c.keyCode;}ORYX.Log.debug("Register Plugin on Key Event: %0",b);if(a.toggle===true&&a.buttonInstance){this.registerOnEvent(b,function(){a.buttonInstance.toggle(!a.buttonInstance.pressed);a.functionality.call(a,a.buttonInstance,a.buttonInstance.pressed);});}else{this.registerOnEvent(b,a.functionality);}}.bind(this));}}.bind(this));},isEqual:function(d,c){return d===c||(d.length===c.length&&d.all(function(a){return c.include(a);}));},isDirty:function(b){return b.any(function(a){return a.isPropertyChanged();});},setSelection:function(c,a,b){if(!c){c=[];}if(!(c instanceof Array)){c=[c];}c=c.findAll(function(d){return d&&d instanceof ORYX.Core.Shape;});if(c[0] instanceof ORYX.Core.Canvas){c=[];}if(!b&&this.isEqual(this.selection,c)&&!this.isDirty(c)){return;}this.selection=c;this._subSelection=a;this.handleEvents({type:ORYX.CONFIG.EVENT_SELECTION_CHANGED,elements:c,subSelection:a,force:!!b});},updateSelection:function(){this.setSelection(this.selection,this._subSelection,true);},getCanvas:function(){return this._canvas;},createShape:function(f){if(f&&f.serialize&&f.serialize instanceof Array){var k=f.serialize.find(function(b){return(b.prefix+"-"+b.name)=="oryx-type";});var p=ORYX.Core.StencilSet.stencil(k.value);if(p.type()=="node"){var h=new ORYX.Core.Node({"eventHandlerCallback":this.handleEvents.bind(this)},p);}else{var h=new ORYX.Core.Edge({"eventHandlerCallback":this.handleEvents.bind(this)},p);}this.getCanvas().add(h);h.deserialize(f.serialize);return h;}if(!f||!f.type||!f.namespace){throw"To create a new shape you have to give an argument with type and namespace";}var e=this.getCanvas();var h;var a=f.type;var m=ORYX.Core.StencilSet.stencilSet(f.namespace);if(m.stencil(a).type()=="node"){h=new ORYX.Core.Node({"eventHandlerCallback":this.handleEvents.bind(this)},m.stencil(a));}else{h=new ORYX.Core.Edge({"eventHandlerCallback":this.handleEvents.bind(this)},m.stencil(a));}if(f.template){h._jsonStencil.properties=f.template._jsonStencil.properties;h.postProcessProperties();}if(f.parent&&h instanceof ORYX.Core.Node){f.parent.add(h);}else{e.add(h);}var n=f.position?f.position:{x:100,y:200};var c;if(f.connectingType&&f.connectedShape&&!(h instanceof ORYX.Core.Edge)){c=new ORYX.Core.Edge({"eventHandlerCallback":this.handleEvents.bind(this)},m.stencil(f.connectingType));c.dockers.first().setDockedShape(f.connectedShape);var o=f.connectedShape.getDefaultMagnet();var q=o?o.bounds.center():f.connectedShape.bounds.midPoint();c.dockers.first().setReferencePoint(q);c.dockers.last().setDockedShape(h);c.dockers.last().setReferencePoint(h.getDefaultMagnet().bounds.center());e.add(c);this.handleEvents({type:SMARTDOT.CONFIG.EVENT_AFTER_CREATE_SHAPE,shape:h});}if(h instanceof ORYX.Core.Edge&&f.connectedShape){h.dockers.first().setDockedShape(f.connectedShape);if(f.connectedShape instanceof ORYX.Core.Node){h.dockers.first().setReferencePoint(f.connectedShape.getDefaultMagnet().bounds.center());h.dockers.last().bounds.centerMoveTo(n);}else{h.dockers.first().setReferencePoint(f.connectedShape.bounds.midPoint());}}else{var l=h.bounds;if(h instanceof ORYX.Core.Node&&h.dockers.length==1){l=h.dockers.first().bounds;}if(h instanceof ORYX.Core.Edge){l.extend({x:0,y:1});n.x-=8;n.y-=8;}l.centerMoveTo(n);var d=l.upperLeft();l.moveBy(-Math.min(d.x,0),-Math.min(d.y,0));var g=l.lowerRight();l.moveBy(-Math.max(g.x-e.bounds.width(),0),-Math.max(g.y-e.bounds.height(),0));}if(h instanceof ORYX.Core.Edge){h._update(false);}if(!(h instanceof ORYX.Core.Edge)&&!(f.dontUpdateSelection)){this.setSelection([h]);}if(c&&c.alignDockers){c.alignDockers();}if(h.alignDockers){h.alignDockers();}this.handleEvents({type:SMARTDOT.CONFIG.EVENT_AFTER_CREATE_SHAPE,shape:h});return h;},deleteShape:function(a){if(!a||!a.parent){return;}a.parent.remove(a);a.getOutgoingShapes().each(function(c){var b=c.getDockers().first();if(b&&b.getDockedShape()==a){b.setDockedShape(undefined);}});a.getIncomingShapes().each(function(b){var c=b.getDockers().last();if(c&&c.getDockedShape()==a){c.setDockedShape(undefined);}});a.getDockers().each(function(b){b.setDockedShape(undefined);});},getModelMetaData:function(){return this.modelMetaData;},_executeEventImmediately:function(a){if(this.DOMEventListeners.keys().member(a.event.type)){this.DOMEventListeners[a.event.type].each((function(b){b(a.event,a.arg);}).bind(this));}},_executeEvents:function(){this._queueRunning=true;while(this._eventsQueue.length>0){var a=this._eventsQueue.shift();this._executeEventImmediately(a);}this._queueRunning=false;},handleEvents:function(b,a){ORYX.Log.trace("Dispatching event type %0 on %1",b.type,a);switch(b.type){case ORYX.CONFIG.EVENT_MOUSEDOWN:this._handleMouseDown(b,a);break;case ORYX.CONFIG.EVENT_MOUSEMOVE:this._handleMouseMove(b,a);break;case ORYX.CONFIG.EVENT_MOUSEUP:this._handleMouseUp(b,a);break;case ORYX.CONFIG.EVENT_MOUSEOVER:this._handleMouseHover(b,a);break;case ORYX.CONFIG.EVENT_MOUSEOUT:this._handleMouseOut(b,a);break;}if(b.forceExecution){this._executeEventImmediately({event:b,arg:a});}else{this._eventsQueue.push({event:b,arg:a});}if(!this._queueRunning){this._executeEvents();}return false;},isValidEvent:function(c){try{var a=["INPUT","TEXTAREA"].include(c.target.tagName.toUpperCase());var b=c.target.className.include("x-grid3-focus")&&!c.target.className.include("x-grid3-focus-canvas");return !a&&!b;}catch(c){return false;}},catchKeyUpEvents:function(b){if(!this._keyupEnabled){return;}if(!b){b=window.event;}if(!this.isValidEvent(b)){return;}var a=this.createKeyCombEvent(b,ORYX.CONFIG.KEY_ACTION_UP);ORYX.Log.debug("Key Event to handle: %0",a);this.handleEvents({type:a,event:b});},catchKeyDownEvents:function(b){if(!this._keydownEnabled){return;}if(!b){b=window.event;}if(!this.isValidEvent(b)){return;}var a=this.createKeyCombEvent(b,ORYX.CONFIG.KEY_ACTION_DOWN);ORYX.Log.debug("Key Event to handle: %0",a);this.handleEvents({type:a,event:b});},createKeyCombEvent:function(c,b){var d=c.which||c.keyCode;var a="key.event";if(b){a+="."+b;}if(c.ctrlKey||c.metaKey){a+="."+ORYX.CONFIG.META_KEY_META_CTRL;}if(c.altKey){a+="."+ORYX.CONFIG.META_KEY_ALT;}if(c.shiftKey){a+="."+ORYX.CONFIG.META_KEY_SHIFT;}return a+"."+d;},_handleMouseDown:function(a,l){var b=this.getCanvas();b.focus();var d=a.currentTarget;var c=l;var g=(c!==null)&&(c!==undefined)&&(c.isSelectable);var m=(c!==null)&&(c!==undefined)&&(c.isMovable);var k=a.shiftKey||a.ctrlKey;var h=this.selection.length===0;var e=this.selection.member(c);if(g&&h){this.setSelection([c]);ORYX.Log.trace("Rule #1 applied for mouse down on %0",d.id);}else{if(g&&!h&&!k&&!e){this.setSelection([c]);ORYX.Log.trace("Rule #3 applied for mouse down on %0",d.id);}else{if(g&&k&&!e){var f=this.selection.clone();f.push(c);this.setSelection(f);ORYX.Log.trace("Rule #4 applied for mouse down on %0",d.id);}else{if(g&&e&&k){var f=this.selection.clone();this.setSelection(f.without(c));ORYX.Log.trace("Rule #6 applied for mouse down on %0",c.id);}else{if(!g&&!m){this.setSelection([]);ORYX.Log.trace("Rule #2 applied for mouse down on %0",d.id);return;}else{if(!g&&m&&!(c instanceof ORYX.Core.Controls.Docker)){ORYX.Log.trace("Rule #7 applied for mouse down on %0",d.id);}else{if(g&&e&&!k){this._subSelection=this._subSelection!=c?c:undefined;this.setSelection(this.selection,this._subSelection);ORYX.Log.trace("Rule #8 applied for mouse down on %0",d.id);}}}}}}}return;},_handleMouseMove:function(b,a){return;},_handleMouseUp:function(d,c){var a=this.getCanvas();var e=c;var b=this.eventCoordinates(d);},_handleMouseHover:function(b,a){return;},_handleMouseOut:function(b,a){return;},eventCoordinates:function(c){var b=this.getCanvas();var d=b.node.ownerSVGElement.createSVGPoint();d.x=c.clientX;d.y=c.clientY;var a=b.node.getScreenCTM();if(Ext.isIE9){var e=Ext.fly(b.getScrollNode().firstChild);a.e=e.getLeft()+4;a.f=e.getTop()+4;}return d.matrixTransform(a.inverse());}};ORYX.Editor=Clazz.extend(ORYX.Editor);ORYX.Editor.createByUrl=function(b,a){if(!a){a={};}new Ajax.Request(b,{method:"GET",onSuccess:function(d){var c=Ext.decode(d.responseText);c=Ext.applyIf(c,a);new ORYX.Editor(c);}.bind(this)});};ORYX.Editor.graft=function(g,f,d,l){l=(l||(f&&f.ownerDocument)||document);var h;if(d===undefined){throw"Can't graft an undefined value";}else{if(d.constructor==String){h=l.createTextNode(d);}else{for(var c=0;c<d.length;c++){if(c===0&&d[c].constructor==String){var a;a=d[c].match(/^([a-z][a-z0-9]*)\.([^\s\.]+)$/i);if(a){h=l.createElementNS(g,a[1]);h.setAttributeNS(null,"class",a[2]);continue;}a=d[c].match(/^([a-z][a-z0-9]*)$/i);if(a){h=l.createElementNS(g,a[1]);continue;}h=l.createElementNS(g,"span");h.setAttribute(null,"class","namelessFromLOL");}if(d[c]===undefined){throw"Can't graft an undefined value in a list!";}else{if(d[c].constructor==String||d[c].constructor==Array){this.graft(g,h,d[c],l);}else{if(d[c].constructor==Number){this.graft(g,h,d[c].toString(),l);}else{if(d[c].constructor==Object){for(var b in d[c]){h.setAttributeNS(null,b,d[c][b]);}}else{}}}}}}}if(f){f.appendChild(h);}else{}return h;};ORYX.Editor.provideId=function(){var b=[],c="0123456789ABCDEF";for(var a=0;a<36;a++){b[a]=Math.floor(Math.random()*16);}b[14]=4;b[19]=(b[19]&3)|8;for(var a=0;a<36;a++){b[a]=c[b[a]];}b[8]=b[13]=b[18]=b[23]="-";return"oryx_"+b.join("");};ORYX.Editor.resizeFix=function(){if(!ORYX.Editor._resizeFixTimeout){ORYX.Editor._resizeFixTimeout=window.setTimeout(function(){window.resizeBy(1,1);window.resizeBy(-1,-1);ORYX.Editor._resizefixTimeout=null;},100);}};ORYX.Editor.Cookie={callbacks:[],onChange:function(b,a){this.callbacks.push(b);this.start(a);},start:function(a){if(this.pe){return;}var b=document.cookie;this.pe=new PeriodicalExecuter(function(){if(b!=document.cookie){b=document.cookie;this.callbacks.each(function(c){c(this.getParams());}.bind(this));}}.bind(this),(a||10000)/1000);},stop:function(){if(this.pe){this.pe.stop();this.pe=null;}},getParams:function(){var a={};var b=document.cookie;b.split("; ").each(function(c){a[c.split("=")[0]]=c.split("=")[1];});return a;},toString:function(){return document.cookie;}};ORYX.Editor.SVGClassElementsAreAvailable=true;ORYX.Editor.setMissingClasses=function(){try{SVGElement;}catch(a){ORYX.Editor.SVGClassElementsAreAvailable=false;SVGSVGElement=document.createElementNS("http://www.w3.org/2000/svg","svg").toString();SVGGElement=document.createElementNS("http://www.w3.org/2000/svg","g").toString();SVGPathElement=document.createElementNS("http://www.w3.org/2000/svg","path").toString();SVGTextElement=document.createElementNS("http://www.w3.org/2000/svg","text").toString();SVGRectElement=document.createElementNS("http://www.w3.org/2000/svg","rect").toString();SVGImageElement=document.createElementNS("http://www.w3.org/2000/svg","image").toString();SVGCircleElement=document.createElementNS("http://www.w3.org/2000/svg","circle").toString();SVGEllipseElement=document.createElementNS("http://www.w3.org/2000/svg","ellipse").toString();SVGLineElement=document.createElementNS("http://www.w3.org/2000/svg","line").toString();SVGPolylineElement=document.createElementNS("http://www.w3.org/2000/svg","polyline").toString();SVGPolygonElement=document.createElementNS("http://www.w3.org/2000/svg","polygon").toString();}};ORYX.Editor.checkClassType=function(b,a){if(ORYX.Editor.SVGClassElementsAreAvailable){return b instanceof a;}else{return b==a;}};ORYX.Editor.makeExtModalWindowKeysave=function(a){Ext.override(Ext.Window,{beforeShow:function(){delete this.el.lastXY;delete this.el.lastLT;if(this.x===undefined||this.y===undefined){var b=this.el.getAlignToXY(this.container,"c-c");var c=this.el.translatePoints(b[0],b[1]);this.x=this.x===undefined?c.left:this.x;this.y=this.y===undefined?c.top:this.y;}this.el.setLeftTop(this.x,this.y);if(this.expandOnShow){this.expand(false);}if(this.modal){a.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);Ext.getBody().addClass("x-body-masked");this.mask.setSize(Ext.lib.Dom.getViewWidth(true),Ext.lib.Dom.getViewHeight(true));this.mask.show();}},afterHide:function(){this.proxy.hide();if(this.monitorResize||this.modal||this.constrain||this.constrainHeader){Ext.EventManager.removeResizeListener(this.onWindowResize,this);}if(this.modal){this.mask.hide();a.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);Ext.getBody().removeClass("x-body-masked");}if(this.keyMap){this.keyMap.disable();}this.fireEvent("hide",this);},beforeDestroy:function(){if(this.modal){a.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}Ext.destroy(this.resizer,this.dd,this.proxy,this.mask);Ext.Window.superclass.beforeDestroy.call(this);}});};if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}new function(){ORYX.Core.UIEnableDrag=function(e,d,c){ORYX.Core.UIDisableDrag(e);this.uiObj=d;var f=d.bounds.upperLeft();var b=d.node.getScreenCTM();this.faktorXY={x:b.a,y:b.d};this.scrollNode=d.node.ownerSVGElement.parentNode.parentNode;this.offSetPosition={x:Event.pointerX(e)-(f.x*this.faktorXY.x),y:Event.pointerY(e)-(f.y*this.faktorXY.y)};this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};this.dragCallback=ORYX.Core.UIDragCallback.bind(this);this.disableCallback=ORYX.Core.UIDisableDrag.bind(this);this.movedCallback=c?c.movedCallback:undefined;this.upCallback=c?c.upCallback:undefined;document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,false);};ORYX.Core.UIDragCallback=function(b){var a={x:Event.pointerX(b)-this.offSetPosition.x,y:Event.pointerY(b)-this.offSetPosition.y};a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;a.x/=this.faktorXY.x;a.y/=this.faktorXY.y;this.uiObj.bounds.moveTo(a);if(this.movedCallback){this.movedCallback(b);}Event.stop(b);};ORYX.Core.UIDisableDrag=function(a){document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,false);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);if(this.upCallback){this.upCallback(a);}this.upCallback=undefined;this.movedCallback=undefined;Event.stop(a);};ORYX.Core.SVGEnableDrag=function(b,d,k){ORYX.Core.SVGDisableDrag(b);var o={x:Event.pointerX(b),y:Event.pointerY(b)};this.node=d;var c;try{var g=d.getCTM();var m=d.getBBox();var h=ORYX.Core.Math.getTranslatedPoint(m,g);if(Math.abs(g.b)<0.000001&&Math.abs(g.c)<0.000001){c=h;}else{var f=d.getScreenCTM();c={x:o.x-(f.e-g.e)-(m.width/2),y:o.y-(f.f-g.f)-(m.height/2)};}c.x-=d.parentNode.getCTM().e;c.y-=d.parentNode.getCTM().f;}catch(l){c=d.getBBox();}var n=d.parentNode.getCTM();this.faktorXY={x:n.a,y:n.d};this.scrollNode=d.ownerSVGElement.parentNode.parentNode;this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};this.offSetPosition={x:o.x-(c.x),y:o.y-(c.y)};this.dragCallback=ORYX.Core.SVGDragCallback.bind(this);this.disableCallback=ORYX.Core.SVGDisableDrag.bind(this);this.movedCallback=k?k.movedCallback:undefined;this.upCallback=k?k.upCallback:undefined;this.adjustPosition=(k?k.adjustPosition:undefined)||function(a){return a;};document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);};ORYX.Core.SVGDragCallback=function(b){Event.stop(b);var a={x:Event.pointerX(b)-this.offSetPosition.x,y:Event.pointerY(b)-this.offSetPosition.y};a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;a.x/=this.faktorXY.x;a.y/=this.faktorXY.y;a.x=Math.floor(a.x);a.y=Math.floor(a.y);a=this.adjustPosition(a,b);if(a===false){return;}this.node.setAttribute("transform",["translate(",Math.floor(a.x),", ",Math.floor(a.y),")"].join(""));if(this.movedCallback){this.movedCallback(b,a);}this.lastPosition=a;};ORYX.Core.SVGDisableDrag=function(a){document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,true);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);if(this.upCallback){this.upCallback(a,this.lastPosition);}delete this.upCallback;delete this.movedCallback;delete this.lastPosition;};}();new function(){Ext.dd.DragDropMgr.getLocation=function(m){if(!this.isTypeOfDD(m)){return null;}var g=m.getEl(),p,f,d,s,q,x,c,o,h;try{p=Ext.lib.Dom.getXY(g);}catch(n){}if(!p){return null;}var v=Ext.get(g).parent("div{overflow=auto}");if(v){p[0]+=v.dom.scrollLeft;p[1]+=v.dom.scrollTop;var u=v.dom.firstChild;if(u&&(u.style.MozTransform||u.style.webkitTransform)){try{var k=(u.style.MozTransform||u.style.webkitTransform||"").replace(/(.*translate.+?)([-0-9]+)(.*?)([-0-9]+)(.*)/i,"{x:$2, y:$4}");k=k.startsWith("{")?k.evalJSON():{};if(k&&"undefined"!=typeof k.x&&"undefined"!=typeof k.y){p[0]-=k.x;p[1]-=k.y;}}catch(n){}}}f=p[0];d=f+g.offsetWidth;s=p[1];q=s+g.offsetHeight;x=s-m.padding[0];c=d+m.padding[1];o=q+m.padding[2];h=f-m.padding[3];return new Ext.lib.Region(x,c,o,h);};ORYX.Core.DragZone=function(c,b){this.facade=b;ORYX.Core.DragZone.superclass.constructor.call(this,c,{shadow:!Ext.isMac});this.snap=new ORYX.Core.SnapToGrid(b);this.rectangle=new ORYX.Core.SelectedRect(this.facade.getCanvas().getSvgContainer(),{"stroke-opacity":0.5});if(ORYX.CONFIG.SHOW_GRIDLINE){this.vLine=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_VERTICAL);this.hLine=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_HORIZONTAL);}};ORYX.Core.DragZone.HIGHLIGHT_ATTACH="shaperepositoy.attach";ORYX.Core.DragZone.HIGHLIGHT_ADD="shaperepositoy.add";ORYX.Core.DragZone.HIGHLIGHT_CONNECTBETWEEN="shaperepositoy.connect";ORYX.Core.DragZone.OVERLAY_POOLDOCKING="poollanecreation.overlay";Ext.extend(ORYX.Core.DragZone,Ext.dd.DragZone,{validBoundaries:["node","edge"],afterDragDrop:function(){},afterDragOver:function(){},afterDragEnter:function(){},afterValidDrop:function(){},canAttach:function(b,c){return this.facade.getRules().canConnect({sourceShape:b[0],edgeStencil:c,targetStencil:c});},canContain:function(b,c){return this.facade.getRules().canContain({containingShape:b[0],containedStencil:c});},canConnectBetween:function(b,c){return this.facade.getRules().canConnect({sourceShape:b[0].getSource(),edgeShape:b[0],targetStencil:c})&&this.facade.getRules().canConnect({sourceStencil:c,edgeShape:b[0],targetShape:b[0].getTarget()})&&this.facade.getRules().canContain({containingShape:b[1],containedStencil:c});},canConnect:function(){return undefined;},onInitDrag:function(){this.bounds=this.getBounds()||false;if(this.bounds){this.snap.setScale(this.getScale());this.snap.setReferenceBounds(this.bounds);this.snap.setReferenceShapes();if(this.snapTimer){window.clearTimeout(this.snapTimer);}this.snapTimer=window.setTimeout(function(){this.snap.setReferenceShapes(this.getSnapReferencedShapes(),true);}.bind(this),1);}delete this.cachedTarget;delete this._canAttach;delete this._canContain;delete this._canConnectBetween;delete this._canConnect;delete this._lastOverElement;delete this._lastOverElements;delete this.isDragOver;this.initIntervalDragOver=true;return ORYX.Core.DragZone.superclass.onInitDrag.apply(this,arguments);},onDrag:function(d){if(this.rectangle){this.rectangle.scrollIntoView(d,this.onDrag.bind(this),this.initIntervalDragOver);}if(!this.rectangle||!this.bounds||this.rectangle.hidden){return;}var b=this.getNormalizedXY(d);var c=d.altKey||d.ctrlKey;if(!c){b=this.snapPosition(b);}var e=this.getScale();this.bounds.moveTo(b.x/e,b.y/e);if(this._lastOverElement){this.rectangle.resize(this.bounds);}},onDragOver:function(c,d){var b=this.cachedTarget||Ext.dd.DragDropMgr.getDDById(d);if(this.beforeDragOver(b,c,d)!==false){this.isDragOver=true;window.setTimeout(function(){delete this.initIntervalDragOver;}.bind(this),1000);if(this._canAttach||this._canContain||this._canConnectBetween||this._canConnect){this.setAllowed();}else{this.setNotAllowed();}this.updateHighlight(c);if(this.afterDragOver){this.afterDragOver(b,c,d);}}},hide:function(){this.rectangle.hide();this.highlightShape();if(this.vLine){this.vLine.hide();}if(this.hLine){this.hLine.hide();}},show:function(){this.rectangle.show();},setAllowed:function(){var b=this.getProxy();b.setStatus(b.dropAllowed);b.sync();},setNotAllowed:function(){var b=this.getProxy();b.setStatus(b.dropNotAllowed);b.sync();},getDraggedStencil:function(d){var b=Ext.dd.Registry.getHandle(d.DDM.currentTarget);var c=this.facade.getStencilSets()[b.namespace];return c.stencil(b.type);},highlightShape:function(f,c,d,b,e){if(f!==undefined){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:f,elements:[c],style:d,color:b,coords:e});}[ORYX.Core.DragZone.HIGHLIGHT_ATTACH,ORYX.Core.DragZone.HIGHLIGHT_ADD,ORYX.Core.DragZone.HIGHLIGHT_CONNECTBETWEEN,ORYX.Core.DragZone.OVERLAY_POOLDOCKING].each(function(g){if(g!==f){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_POOLDOCKING_HIDE,highlightId:g});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:g});}}.bind(this));},updateHighlight:function(b){if(this._lastOverElement&&this._lastOverElement instanceof ORYX.Core.Canvas){this.highlightShape();}else{if(this._canAttach===true&&this._lastOverElement){this.highlightShape(ORYX.Core.DragZone.HIGHLIGHT_ATTACH,this._lastOverElement,ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,ORYX.CONFIG.SELECTION_VALID_COLOR);}else{if(this._canContain!==undefined||this._canConnectBetween!==undefined||this._canConnect!==undefined&&this._lastOverElement){this.highlightShape(ORYX.Core.DragZone.HIGHLIGHT_ADD,this._lastOverElement,undefined,this._canContain||this._canConnectBetween||this._canConnect?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR);}else{this.highlightShape();}}}},setOptions:function(b){Ext.apply(Ext.dd.Registry.getHandle(this.DDM.currentTarget),b);},getOptions:function(){return Ext.dd.Registry.getHandle(this.DDM.currentTarget);},updateOptions:function(c,d){c.canContain=!!this._canContain;c.canAttach=!!this._canAttach;c.canConnectBetween=!!this._canConnectBetween;c.canConnect=!!this._canConnect;var h;try{h=this.bounds.center();}catch(f){h=this.getNormalizedXY(d);}if(this._canContain&&!this._canAttach&&!this._canConnectBetween&&this._lastOverElement){c.parent=this._lastOverElement;}else{delete c.parent;}if(this._canConnectBetween&&!this._canAttach&&this._lastOverElement){c.parent=this.getCandidatesAtPosition(h)[1];var b=this._lastOverElement.findSegment(h);if(b){h=ORYX.Core.Math.getPointOfIntersectionPointLine(b.fromDocker.bounds.center(),b.toDocker.bounds.center(),h);}}if(c.parent){var g=c.parent.absoluteXY();h.x-=g.x;h.y-=g.y;}if(this._canConnect){c.parent=this._lastOverElement;}c.position=h;return c;},beforeDragDrop:function(){},beforeDragEnter:function(){if(!this.rectangle||!this.bounds){return;}this.show();},beforeDragOut:function(){delete this._lastOverElement;delete this.isDragOver;this.initIntervalDragOver=true;if(!this.rectangle||!this.bounds){return;}this.hide();},getCandidatesAtPosition:function(d){var b=this.facade.getCanvas().getAbstractShapesAtPosition(d),c=this;return b.reverse().findAll(function(e){return(e instanceof ORYX.Core.Canvas||e instanceof ORYX.Core.Node||e instanceof ORYX.Core.Edge)&&c.facade.getRules().isContainable(e);});},beforeDragOver:function(f,d){var g=this.facade.eventCoordinates(d.browserEvent);var e=this.getCandidatesAtPosition(g);if(e.length===0){return;}var c=this.getDraggedStencil(f);if(!this.facade.getRules().isContainable(c)){e=[e.last()];}var b=e.first();if(b!==this._lastOverElement||this._lastOverElements.length!==e.length||this._lastOverElements.any(function(h){return !e.include(h);})){delete this._canAttach;delete this._canContain;delete this._canConnectBetween;delete this._canConnect;this._lastOverElement=b;this._lastOverElements=e;}else{if(b===this._lastOverElement&&(c.type()==="edge"||this._canAttach===false)){return;}}if(!b){this.updateHighlight();this.setNotAllowed();return;}if(c.type()==="node"){if(b instanceof ORYX.Core.Node&&b.isPointOverOffset(g.x,g.y)&&this._canAttach===undefined){this._canAttach=this.canAttach(e,c);delete this._canContain;}if(this._canContain===undefined&&(!this._canAttach||(b instanceof ORYX.Core.Node&&!b.isPointOverOffset(g.x,g.y)))){this._canContain=this.canContain(e,c);delete this._canAttach;}if(b instanceof ORYX.Core.Edge&&this._canConnectBetween===undefined&&this._canContain!==true&&this._canAttach!==true){this._canConnectBetween=this.canConnectBetween(e,c);}}else{if(this._canConnect===undefined){this._canConnect=this.canConnect(e,c);}if(this._canConnect===undefined){this._canContain=true;this._lastOverElement=this.facade.getCanvas();}}},onDragDrop:function(d,f){var c=this.cachedTarget||Ext.dd.DragDropMgr.getDDById(f);this.cachedTarget=false;this.proxy.hide();var b=this.updateOptions(Ext.dd.Registry.getHandle(c.DDM.currentTarget),d);b=Object.clone(b);if(this.beforeDragDrop(c,d,f)!==false){if(c.isNotifyTarget){if(this.getProxy().dropStatus===this.getProxy().dropAllowed&&this._lastOverElement){this.onValidDrop(b,this._lastOverElement,d);}else{this.hide();this.onInvalidDrop(c,d,f);}}else{this.onValidDrop(c,d,f);}if(this.afterDragDrop){this.afterDragDrop(c,d,f);}}delete this.cachedTarget;delete this._canAttach;delete this._canContain;delete this._canConnectBetween;delete this._canConnect;delete this._lastOverElement;delete this._lastOverElements;},onValidDrop:function(c,b,d){this.hideProxy();if(this.afterValidDrop){window.setTimeout(function(){this.afterValidDrop.apply(this,arguments);this.hide();}.bind(this,c,b,d),1);}},afterRepair:function(){this.dragging=false;},getSnapReferencedShapes:function(){return this.facade.getCanvas().getChildShapes(true);},getNormalizedXY:function(d){var f=d.getXY();var l={x:f[0],y:f[1]};var b=this.facade.getCanvas().node.getScreenCTM();if(Ext.isIE9){var h=Ext.fly(this.facade.getCanvas().getScrollNode().firstChild);b.e=h.getLeft()+4;b.f=h.getTop()+4;}l.x-=b.e;l.y-=b.f;var g=this.getScale();var e=this.bounds?this.bounds.midPoint():{x:0,y:0};l.x=Math.max(e.x*g,l.x);l.y=Math.max(e.y*g,l.y);var k=this.facade.getCanvas();l.x=Math.min((k.bounds.width()-e.x)*g,l.x);l.y=Math.min((k.bounds.height()-e.y)*g,l.y);return l;},snapPosition:function(h){var f=this.getScale();var e=this.bounds.midPoint();h.x-=e.x*f;h.y-=e.y*f;var g,b;var c=function(k){g=k;}.bind(this);var d=function(k){b=k;}.bind(this);h=this.snap.adjustPoint(h,c,d);if(this.hLine&&this.vLine){if(g===undefined){this.hLine.hide();}else{this.hLine.update(g);}if(b===undefined){this.vLine.hide();}else{this.vLine.update(b);}}return h;},getScale:function(){try{return this.facade.getCanvas().node.transform.baseVal.getItem(0).matrix.a;}catch(b){return 1;}},getBounds:function(){var b=Ext.dd.Registry.getHandle(this.DDM.currentTarget);var c=this.facade.getStencilSets()[b.namespace].stencil(b.type);if(!this.validBoundaries.include(c.type())){return;}return new ORYX.Core.Node({},c).bounds.clone();}});var a=new Hash();a["http://b3mn.org/stencilset/bpmn2.0#"]=[["Task","CollapsedSubprocess","Subprocess","CollapsedEventSubprocess","EventSubprocess"],["Pool","VerticalPool","CollapsedPool","CollapsedVerticalPool"],["Lane","VerticalLane"],["Group"],["DataObject"]];a["http://b3mn.org/stencilset/bpmn2.0choreography#"]=[["ChoreographyTask","ChoreographySubprocessCollapsed","ChoreographySubprocessExpanded"],["ChoreographyParticipant"],["Group"]];a["http://www.signavio.com/stencilsets/processmap#"]=[["Process","ProcessCollapsed"],["TextNote"],["Group"]];a["http://b3mn.org/stencilset/epc#"]=[["Event","Function","ProcessInterface"],["Organization","Position","Data","System"],["TextNote"]];a["http://www.signavio.com/stencilsets/organigram#"]=[["TextNote"]];ORYX.Core.SnapToGrid=Clazz.extend({construct:function(b){this.points=[];this.scale=1;this.bounds=undefined;this.facade=b;this.ulThres=6;this.cThres=16;this.lrThres=6;},setReferenceShapes:function(c,b,f){if(this.timer){window.clearTimeout(this.timer);}this.points=[];this.widths=new Hash();this.heights=new Hash();if(!(c instanceof Array)||c.length==0){return;}var e=this.facade?this.facade.getSelection():[];var d=function(){var k=function(m){if(e.size()!=1){return false;}if(!m.isResizable){return false;}var n=a[m.getStencil().namespace()];if(!n){return true;}return n.any(function(o){return o.include(m.getStencil().idWithoutNs())&&o.include(e[0].getStencil().idWithoutNs());})||n.all(function(o){return !o.include(m.getStencil().idWithoutNs())&&!o.include(e[0].getStencil().idWithoutNs());});};var h=new Hash();var l=new Hash();c.each((function(p){if(!(p instanceof ORYX.Core.Edge)){var n=p.absoluteXY();var o=p.bounds.width();var m=p.bounds.height();if(!e.include(p)||b){this.points.push({ul:{x:n.x,y:n.y},c:{x:n.x+Math.round(o/2),y:n.y+Math.round(m/2)},lr:{x:n.x+o,y:n.y+m}});}if(!e.include(p)&&k(p)){var q=ORYX.Core.Math.getDistancePointToPoint(p.absoluteCenterXY(),e[0].absoluteCenterXY());if("undefined"==typeof h[o]||q<h[o]){h[o]=q;this.widths[o]=[p];}if("undefined"==typeof l[m]||q<l[m]){l[m]=q;this.heights[m]=[p];}}}}).bind(this));};if(!f){this.timer=window.setTimeout(d.bind(this),1);}else{var g=d.bind(this);g();}},setReferenceBounds:function(b){this.bounds=b||undefined;},setScale:function(b){this.scale=b||1;},adjustPoint:function(q,s,d){var b=this.bounds;if(!b){return;}var p=this.ulThres;var n=this.cThres;var r=this.lrThres;var e=this.scale;var m={x:(q.x/e),y:(q.y/e)};var o={x:(q.x/e)+(b.width()/2),y:(q.y/e)+(b.height()/2)};var k={x:(q.x/e)+(b.width()),y:(q.y/e)+(b.height())};var h,f;var l,g;this.points.each(function(u){var c,z,v,t;if(Math.abs(u.c.x-o.x)<n){c=u.c.x-o.x;v=u.c.x;}if(Math.abs(u.c.y-o.y)<n){z=u.c.y-o.y;t=u.c.y;}if(c!==undefined){h=h===undefined?c:(Math.abs(c)<Math.abs(h)?c:h);if(h===c){l=v;}}if(z!==undefined){f=f===undefined?z:(Math.abs(z)<Math.abs(f)?z:f);if(f===z){g=t;}}});if(h!==undefined){m.x+=h;m.x*=e;if(l!==undefined&&d instanceof Function){d(l);}}else{m.x=(q.x-(q.x%(ORYX.CONFIG.GRID_DISTANCE/2)));}if(f!==undefined){m.y+=f;m.y*=e;if(g!==undefined&&s instanceof Function){s(g);}}else{m.y=(q.y-(q.y%(ORYX.CONFIG.GRID_DISTANCE/2)));}return m;},adjustBounds:function(h,f,b,m,l,k,u){h=h.clone();var B=12;var c=12;var d=12;var C=this.scale;var x,v;var z,y;this.widths.each(function(E){var p,D;if(Math.abs(h.width()-E.key)<B){p=E.key-h.width();}if(p!==undefined){x=x===undefined?p:(Math.abs(p)<Math.abs(x)?p:x);}});this.heights.each(function(p){var D;if(Math.abs(h.height()-p.key)<c){D=p.key-h.height();}if(D!==undefined){v=v===undefined?D:(Math.abs(D)<Math.abs(v)?D:v);}});var q=false;var t=(f=="northwest")?h.upperLeft():h.lowerRight();var s={ul:{x:k.upperLeft().x,y:k.upperLeft().y},c:{x:k.center().x,y:k.center().y},lr:{x:k.lowerRight().x,y:k.lowerRight().y}};this.points.concat([s]).each(function(G){var D,I,H,F;var E=(f=="northwest")?G.ul:G.lr;var p=true;if(G.ul.x==k.upperLeft().x&&G.ul.y==k.upperLeft().y&&G.lr.x==k.lowerRight().x&&G.lr.y==k.lowerRight().y){if(!q){q=true;p=false;}}if(Math.abs(E.x-t.x)<d){D=(f=="northwest")?(t.x-E.x):(E.x-t.x);H=E.x;}if(Math.abs(E.y-t.y)<d){I=(f=="northwest")?(t.y-E.y):(E.y-t.y);F=E.y;}if(D!==undefined){if(u){D=2*D;}x=x===undefined?D:(Math.abs(D)<=Math.abs(x)?D:x);if(x==D&&p){z=H;}}if(I!==undefined){if(u){I=2*I;}v=v===undefined?I:(Math.abs(I)<=Math.abs(v)?I:v);if(v==I&&p){y=F;}}});var g,e;var r,A;if(b){var o,n;if(x!==undefined&&v!==undefined){if(v<x){o=(this.orientation==="northwest")?-(b*(h.height()-v)-h.width()):(b*(h.height()+v)-h.width());n=v;}else{o=x;n=(this.orientation==="northwest")?-((h.width()-x)/b-h.height()):((h.width()+x)/b-h.height());}g=true;e=true;}else{if(x!==undefined&&v===undefined&&z){o=x;n=(this.orientation==="northwest")?-((h.width()-x)/b-h.height()):((h.width()+x)/b-h.height());g=true;}else{if(x===undefined&&v!==undefined&&y){o=(this.orientation==="northwest")?-(b*(h.height()-v)-h.width()):(b*(h.height()+v)-h.width());n=v;e=true;}else{o=0;n=0;}}}h.extend({x:o,y:n});if(u&&f=="southeast"){h.moveBy({x:-(o/2),y:-(n/2)});}else{if(u&&f=="northwest"){h.moveBy({x:-(o/2),y:-(n/2)});}else{if(f=="northwest"){h.moveBy({x:-o,y:-n});}}}if(this.widths.keys().include(h.width())){r=this.widths[h.width()];}if(this.heights.keys().include(h.height())){A=this.heights[h.height()];}}else{if(x!==undefined){h.extend({x:x,y:0});if(u&&f=="southeast"){h.moveBy({x:-(x/2),y:0});}else{if(u&&f=="northwest"){h.moveBy({x:-(x/2),y:0});}else{if(f=="northwest"){h.moveBy({x:-x,y:0});}}}if(this.widths.keys().include(h.width())){r=this.widths[h.width()];}g=true;}if(v!==undefined){h.extend({x:0,y:v});if(u&&f=="southeast"){h.moveBy({x:0,y:-(v/2)});}else{if(u&&f=="northwest"){h.moveBy({x:0,y:-(v/2)});}else{if(f=="northwest"){h.moveBy({x:0,y:-v});}}}if(this.heights.keys().include(h.height())){A=this.heights[h.height()];}e=true;}}if(g&&(m instanceof Function)){m(h,r,z);}if(e&&(l instanceof Function)){l(h,A,y);}return h;}});}();new function(){var a;ORYX.Core.SelectedRect=Clazz.extend({construct:function(c,b){this.parentId=c;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",$(c),["g"]);this.dashedArea=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["rect",Ext.apply({x:0,y:0,"fill":"none","stroke":"#777777","stroke-width":1,"stroke-dasharray":"3,3","shape-rendering":"crispEdges","pointer-events":"none"},b||{})]);this.hide();this.extNode=Ext.get(this.node);this.scrollElement=Ext.get(this.node).parent(".x-panel-body");document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,function(){window.clearTimeout(a);},true);},hide:function(){this.node.setAttributeNS(null,"display","none");this.hidden=true;},show:function(){this.node.setAttributeNS(null,"display","");this.hidden=false;this.dashedArea.setAttributeNS(null,"stroke-width",Math.max(0.2,(1/this.getScale())||1));},getScale:function(){return this.node.getScreenCTM().a||1;},resize:function(b){var d=b.upperLeft();var c=ORYX.CONFIG.SELECTED_AREA_PADDING;if(Ext.isGecko&&Number(ORYX.Utils.getBrowserVersion())>=4){d.x+=1;d.y+=1;}this.dashedArea.setAttributeNS(null,"width",(b.width()+2*c)+1);this.dashedArea.setAttributeNS(null,"height",(b.height()+2*c)+1);this.node.setAttributeNS(null,"transform","translate("+(d.x-c-1)+", "+(d.y-c-1)+")");},getScrollerBounds:function(){var d=this.scrollElement.getRegion();var c=new ORYX.Core.Bounds(d.left,d.top,d.right,d.bottom);return c;},getPosition:function(b){b=b.browserEvent||b;return{x:Event.pointerX(b),y:Event.pointerY(b)};},scrollIntoView:function(b,r,l){var m=22;var u=this.scrollElement.dom;var p=this.getScrollerBounds();var q=this.getPosition(b);window.clearTimeout(a);p.widen(-5);p.extend({x:u.offsetHeight!==u.scrollHeight?-m:0,y:u.offsetWidth!==u.scrollWidth?-m:0});if(p.isIncluded(q)){return;}var o=u.scrollLeft;var t=u.scrollTop;var k=u.offsetHeight;var d=u.offsetWidth;var c=t,g=o;k-=(u.offsetHeight!==u.scrollHeight?m:0);d-=(u.offsetWidth!==u.scrollWidth?m:0);var f=5;if(q.x<p.a.x&&!l){g-=f*Math.max(1,Math.min(((p.a.x-q.x)/50)+1,3));}else{if(q.x>p.b.x){g+=f*Math.max(1,Math.min(((q.x-p.b.x)/50)+1,3));}}if(q.y<p.a.y){c-=f*Math.max(1,Math.min(((p.a.y-q.y)/50)+1,3));}else{if(q.y>p.b.y){c+=f*Math.max(1,Math.min(((q.y-p.b.y)/50)+1,3));}}c=Math.min(u.scrollHeight-k-5,Math.max(0,c));g=Math.min(u.scrollWidth-d-5,Math.max(0,g));var s={scrollTop:u.scrollTop,scrollLeft:u.scrollLeft};if(Ext.isIPad&&(u.style.MozTransform||u.style.webkitTransform)){try{var h=(u.style.MozTransform||u.style.webkitTransform||"").replace(/(.*translate.+?)([-0-9\.]+)(.*?)([-0-9\.]+)(.*)/i,"{x:$2, y:$4}");h=h.startsWith("{")?h.evalJSON():{};if(h&&"undefined"!=typeof h.x&&"undefined"!=typeof h.y){s.scrollLeft=h.x;s.scrollTop=h.y;}}catch(n){}}if(s.scrollTop!==c||s.scrollLeft!==g){if(Ext.isIPad){u.style.webkitTransform="translate("+g+"px, "+c+"px)";}else{u.scrollTop=c;u.scrollLeft=g;}a=window.setTimeout(function(){if(r instanceof Function){}this.scrollIntoView(b,r,l);}.bind(this),10);}},refreshView:function(c){if(!c||false){return;}try{c=c.browserEvent||c;if(document.createEvent){var b=document.createEvent("MouseEvents");b.initMouseEvent(c.type,true,true,window,0,c.screenX,c.screenY,c.clientX,c.clientY,c.ctrlKey,c.altKey,c.shiftKey,c.metaKey,0,null);return(c.target||document.documentElement).dispatchEvent(b);}}catch(d){}}});}();new function(){ORYX.Core.GridLine=Clazz.extend({construct:function(c,b){if(ORYX.Core.GridLine.DIR_HORIZONTAL!==b&&ORYX.Core.GridLine.DIR_VERTICAL!==b){b=ORYX.Plugins.GridLine.DIR_HORIZONTAL;}this.parent=$(c);this.direction=b;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parent,["g"]);this.line=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"fill":"none","stroke":"silver","stroke-width":1,"stroke-dasharray":"5,5","shape-rendering":"crispEdges","pointer-events":"none"}]);this.hide();},hide:function(){this.node.setAttributeNS(null,"display","none");},show:function(){this.node.setAttributeNS(null,"display","");this.line.setAttributeNS(null,"stroke-width",Math.max(1,(1/this.getScale())||1));},getScale:function(){try{return this.node.getScreenCTM().a||1;}catch(b){return 1;}},update:function(f){if(this.direction===ORYX.Core.GridLine.DIR_HORIZONTAL){var e=f instanceof Object?f.y:f;var d=this.parent.parentNode.parentNode.width.baseVal.value/this.getScale();this.line.setAttributeNS(null,"d","M 0 "+e+" L "+d+" "+e);}else{var b=f instanceof Object?f.x:f;var c=this.parent.parentNode.parentNode.height.baseVal.value/this.getScale();this.line.setAttributeNS(null,"d","M"+b+" 0 L "+b+" "+c);}this.show();}});ORYX.Core.GridLine.DIR_HORIZONTAL="hor";ORYX.Core.GridLine.DIR_VERTICAL="ver";var a={};a.def=null;ORYX.Core.SizeGuide=Clazz.extend({construct:function(c,b){if(ORYX.Core.SizeGuide.DIR_HORIZONTAL!==b&&ORYX.Core.SizeGuide.DIR_VERTICAL!==b){b=ORYX.Core.SizeGuide.DIR_HORIZONTAL;}this.parent=$(c);this.direction=b;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parent,["g"]);if(!a.def){a.def=[ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parent.ownerSVGElement.firstChild,["marker",{"id":"sizeGuide-start","refX":0,"refY":5,"markerUnits":"userSpaceOnUse","markerWidth":6,"markerHeight":20,"orient":"auto"},["path",{"d":"M 6 2 L 1 5 L 6 8 M 0 0 L 0 20","fill":"none","stroke":"silver"}]]),ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parent.ownerSVGElement.firstChild,["marker",{"id":"sizeGuide-end","refX":6,"refY":5,"markerUnits":"userSpaceOnUse","markerWidth":6,"markerHeight":20,"orient":"auto"},["path",{"d":"M 0 2 L 5 5 L 0 8 M 6 0 L 6 20","fill":"none","stroke":"silver"}]])];}this.line=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"fill":"none","stroke":"silver","stroke-dasharray":"5,5","shape-rendering":"geometricPrecision","pointer-events":"none","marker-start":"url(#sizeGuide-start)","marker-end":"url(#sizeGuide-end)"}]);this.hide();},hide:function(){if(!this.hidden){this.node.setAttributeNS(null,"display","none");this.hidden=true;}},show:function(){if(this.hidden){this.node.setAttributeNS(null,"display","");this.line.setAttributeNS(null,"stroke-width",Math.max(1,(1/this.getScale())||1));delete this.hidden;}},getScale:function(){try{return this.node.getScreenCTM().a||1;}catch(b){return 1;}},update:function(e){var d=e.upperLeft();var c=e.lowerRight();offset=20;if(this.direction===ORYX.Core.SizeGuide.DIR_HORIZONTAL){var f=0;this.line.setAttributeNS(null,"d","M "+d.x+" "+(d.y-offset)+" L "+c.x+" "+(d.y-offset));}else{var b=0;this.line.setAttributeNS(null,"d","M"+(c.x+offset)+" "+d.y+" L "+(c.x+offset)+" "+c.y);}this.show();}});ORYX.Core.SizeGuide.DIR_HORIZONTAL="hor";ORYX.Core.SizeGuide.DIR_VERTICAL="ver";ORYX.Core.EnsureChildCommand=ORYX.Core.Command.extend({construct:function(c,b,d){this.shapes=b instanceof Array?b:[b];this.facade=c;this.alsoRemove=d===true;this.changes;},execute:function(){if(!ORYX.CONFIG.CONTAIN_AUTOMATICALY){return;}if(this.changes){this.exectueAgain();return;}var c=[].concat(this.facade.getCanvas().getChildNodes());this.shapes.each(function(e){if(!(e.parent instanceof ORYX.Core.Canvas)){c=c.concat(e.parent.getChildNodes());}});c=c.uniq().findAll(function(e){return e.getDockers().length===0||!e.getDockers()[0].getDockedShape();});var b=[];this.shapes.each(function(f){var e=f;while(e&&!(e.parent instanceof ORYX.Core.Canvas)){e=e.parent;}if(e&&!b.include(e)){var g=e.getChildNodes(true).reverse();g=g.findAll(function(h){return this.facade.getRules().isContainer(h);}.bind(this));b=b.concat(f,e,g);}}.bind(this));b=b.uniq();var d={};this.changes=$H({});if(this.alsoRemove){b.each(function(e){if(!d[e.getId()]){d[e.getId()]=e.absoluteBounds();}var f=d[e.getId()];var g=e.getChildNodes();g.each(function(m){if(m.getDockers().length===1&&m.getDockers()[0].getDockedShape()){return;}var k=m.absoluteXY();var h={x:k.x+m.bounds.width(),y:k.y+m.bounds.height()};if(!f.isIncluded(k,2)&&!f.isIncluded(h,2)){var l=this.getContainerParent(e.parent,m);if(l){this.add(l,m,d[l.getId()]||l.absoluteBounds());c.push(m);}}}.bind(this));}.bind(this));}c.each(function(g){var f=g.absoluteXY();var e={x:f.x+g.bounds.width(),y:f.y+g.bounds.height()};b.any(function(h){var l=g;while(l&&!(l instanceof ORYX.Core.Canvas)){if(l===h){return false;}l=l.parent;}var l=h;while(l&&!(l instanceof ORYX.Core.Canvas)){if(l===g){return false;}l=l.parent;}if(!d[h.getId()]){d[h.getId()]=h.absoluteBounds();}var k=d[h.getId()];if(k.isIncluded(f,-2)&&k.isIncluded(e,-2)){if(this.facade.getRules().canContain({containingShape:h,containedShape:g})){this.add(h,g,k);return true;}}return false;}.bind(this));}.bind(this));this.facade.getCanvas().update();},add:function(d,k,f){var e=k.absoluteXY();var g=f?f.upperLeft():{x:0,y:0};var h={x:e.x-g.x,y:e.y-g.y};var b=this.changes[k.getId()]?this.changes[k.getId()].oldParent:k.parent;var c=this.changes[k.getId()]?this.changes[k.getId()].oldPosition:k.bounds.upperLeft();this.changes[k.getId()]={shape:k,oldParent:b,oldPosition:c,newParent:d,newPosition:f?h:c};d.add(k);if(f){k.bounds.moveTo(h);}k.getOutgoingNodes(function(l){this.add(d,l);}.bind(this));},getContainerParent:function(c,b){while(c&&!this.facade.getRules().canContain({containingShape:c,containedShape:b})){c=c.parent;}return c;},exectueAgain:function(){this.changes.each(function(d){var c=d.value.newParent;var b=d.value.shape;c.add(b);b.bounds.moveTo(d.value.newPosition);}.bind(this));},rollback:function(){if(!ORYX.CONFIG.CONTAIN_AUTOMATICALY){return;}this.changes.each(function(d){var c=d.value.oldParent;var b=d.value.shape;c.add(b);b.bounds.moveTo(d.value.oldPosition);}.bind(this));}});ORYX.Core.MoveDockersCommand=ORYX.Core.Command.extend({construct:function(b){this.dockers=$H(b);this.edges=$H({});},execute:function(){if(this.changes){this.executeAgain();return;}else{this.changes=$H({});}this.dockers.values().each(function(c){var b=c.docker.parent;if(!b){return;}if(!this.changes[b.getId()]){this.changes[b.getId()]={edge:b,oldDockerPositions:b.dockers.map(function(d){return d.bounds.center();})};}c.docker.bounds.moveBy(c.offset);this.edges[b.getId()]=b;c.docker.update();}.bind(this));this.edges.each(function(b){this.updateEdge(b.value);if(this.changes[b.value.getId()]){this.changes[b.value.getId()].dockerPositions=b.value.dockers.map(function(c){return c.bounds.center();});}}.bind(this));},updateEdge:function(b){b._update(true);[b.getOutgoingShapes(),b.getIncomingShapes()].flatten().invoke("_update",[true]);},executeAgain:function(){this.changes.values().each(function(b){b.dockerPositions.each(function(d,c){if(c==0||c==b.dockerPositions.length-1){return;}b.edge.dockers[c].bounds.centerMoveTo(d);b.edge.dockers[c].update();}.bind(this));this.updateEdge(b.edge);}.bind(this));},rollback:function(){this.changes.values().each(function(b){b.oldDockerPositions.each(function(d,c){if(c==0||c==b.oldDockerPositions.length-1){return;}b.edge.dockers[c].bounds.centerMoveTo(d);b.edge.dockers[c].update();}.bind(this));this.updateEdge(b.edge);}.bind(this));},removeAllDocker:function(b){b.dockers.slice(1,b.dockers.length-1).each(function(c){b.removeDocker(c);});}});ORYX.Core.CreateShapeCommand=ORYX.Core.Command.extend({construct:function(d,c,b,e){this.option=d;this.position=b;this.element=c;this.plugin=e;this.facade=e.facade;this.selection=this.facade.getSelection();this.adjustChild;this.shape;this.parent;},execute:function(){if(!this.shape){this.shape=this.facade.createShape(this.option);this.parent=this.shape.parent;}else{if(this.parent){this.parent.add(this.shape);}}var e=this.option;if(e.canAttach&&this.element instanceof ORYX.Core.Node&&this.shape.dockers.length>0){var d=this.shape.dockers[0];if(this.element.parent instanceof ORYX.Core.Node){this.element.parent.add(this.shape);}d.bounds.centerMoveTo(this.position);d.setDockedShape(this.element);}if(e.canConnectBetween&&this.element instanceof ORYX.Core.Edge){var h=this.element.getSource();var k=this.element.getTarget();var b;if(this.edge){b=this.edge;this.facade.getCanvas().add(this.edge);}else{b=this.facade.createShape({namespace:this.element.getStencil().namespace(),type:this.element.getStencil().id()});}var c=false,n=this.shape.absoluteBounds();this.element.getDockers().each(function(q){var p=q.getAbsoluteReferencePoint()||q.bounds.center();if(n.isIncluded(p)){c=true;throw $break;}}.bind(this));var l={x:this.shape.bounds.width()/2,y:this.shape.bounds.height()/2};if(this.shape.getDefaultMagnet()){l=this.shape.getDefaultMagnet().bounds.center();}var m=this.element.getDockers().last().referencePoint;var f=this.element.findSegment(this.shape.absoluteCenterXY());var o=this.element.dockers.slice(this.element.dockers.indexOf(f.toDocker),this.element.dockers.length-1);this.element.getDockers().last().setDockedShape(this.shape);this.element.getDockers().last().setReferencePoint(l);b.getDockers().first().setDockedShape(this.shape);b.getDockers().first().setReferencePoint(l);b.getDockers().last().setDockedShape(k);b.getDockers().last().setReferencePoint(m);this.dockerPosition=this.element.getDockers().map(function(p){return p.bounds.center();});var g=0;o.each(function(p){this.element.removeDocker(p);if(!c&&!this.edge){b.createDocker(1+g,p.bounds.center());}g++;}.bind(this));if(c){this.plugin.doLayout(this.element);this.plugin.doLayout(b);}this.edge=b;}this.facade.setSelection([this.shape]);this.facade.getCanvas().update();if(!this.adjustChild){this.adjustChild=new ORYX.Core.EnsureChildCommand(this.facade,this.shape);}this.adjustChild.execute();this.facade.updateSelection();},rollback:function(){this.adjustChild.rollback();this.facade.deleteShape(this.shape);if(this.edge){this.removeAllDocker(this.element);this.dockerPosition.each(function(d,b){if(b==0||b==this.dockerPosition.length-1){return;}var c=this.element.createDocker(undefined,d);c.bounds.centerMoveTo(d);}.bind(this));this.element.getDockers().last().setDockedShape(this.edge.getTarget());this.element.getDockers().last().setReferencePoint(this.edge.dockers.last().referencePoint);this.facade.deleteShape(this.edge);}this.facade.setSelection(this.selection.without(this.shape));},removeAllDocker:function(b){b.dockers.slice(1,b.dockers.length-1).each(function(c){b.removeDocker(c);});}});}();if("undefined"==typeof ORYX){var ORYX={};}if("undefined"==typeof ORYX.Core){ORYX.Core={};}new function(){ORYX.Core.Shape=ORYX.Core.AbstractShape.extend({construct:function(a,b){arguments.callee.$.construct.apply(this,arguments);this.dockers=[];this.magnets=[];this._defaultMagnet;this.incoming=[];this.outgoing=[];this.nodes=[];this._dockerChangedCallback=this._dockerChanged.bind(this);this._labels=new Hash();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{id:"svg-"+this.resourceId},["g",{"class":"stencils"},["g",{"class":"me"}],["g",{"class":"children"}],["g",{"class":"edge"}]],["g",{"class":"controls"},["g",{"class":"dockers"}],["g",{"class":"magnets"}]]]);this.fillButStroke={"http://b3mn.org/stencilset/bpmn2.0#Task":["sendTaskpath","sendTaskpath2"],"http://b3mn.org/stencilset/epc#Mail":["atText"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateMessageEventThrowing":["path1","path2"],"http://b3mn.org/stencilset/bpmn2.0#EndMessageEvent":["path1","path2"]};this.strokeAndFill={"http://b3mn.org/stencilset/bpmn2.0#Task":["userTaskcircle"],"http://b3mn.org/stencilset/bpmn2.0#Subprocess":["adhocpath"],"http://b3mn.org/stencilset/bpmn2.0#EventSubprocess":["adhocpath"],"http://b3mn.org/stencilset/bpmn2.0#CollapsedSubprocess":["adhocpath"],"http://b3mn.org/stencilset/bpmn2.0#CollapsedEventSubprocess":["adhocpath"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateSignalEventThrowing":["signalThrowing"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateCompensationEventThrowing":["poly1","poly2"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateEscalationEventThrowing":["path9"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateMultipleEventThrowing":["middlePolygonThrowing"],"http://b3mn.org/stencilset/bpmn2.0#IntermediateLinkEventThrowing":["poly1"],"http://b3mn.org/stencilset/bpmn2.0#EndCompensationEvent":["poly1","poly2"],"http://b3mn.org/stencilset/bpmn2.0#EndCancelEvent":["path1"],"http://b3mn.org/stencilset/bpmn2.0#EndMultipleEvent":["middlepolygon"],"http://b3mn.org/stencilset/bpmn2.0#EndErrorEvent":["errorPolygon"],"http://b3mn.org/stencilset/bpmn2.0#EndEscalationEvent":["path9"],"http://b3mn.org/stencilset/bpmn2.0#EndSignalEvent":["signalThrowing"],"http://b3mn.org/stencilset/bpmn2.0#EndTerminateEvent":["circle1"],"http://b3mn.org/stencilset/bpmn2.0#processparticipant":["path1","path2","circle1"],"http://b3mn.org/stencilset/bpmn2.0#Exclusive_Databased_Gateway":["crosspath","crosspath2"],"http://b3mn.org/stencilset/bpmn2.0#SequenceFlow":["arrowhead"],"http://b3mn.org/stencilset/bpmn2.0#DataObject":["output"],"http://b3mn.org/stencilset/bpmn2.0conversation#SequenceFlow":["arrowhead"],"http://b3mn.org/stencilset/bpmn2.0choreography#IntermediateEscalationEventThrowing":["path9"],"http://b3mn.org/stencilset/bpmn2.0choreography#IntermediateLinkEventThrowing":["poly1"],"http://b3mn.org/stencilset/bpmn2.0choreography#EndTerminateEvent":["circle1"],"http://b3mn.org/stencilset/bpmn2.0choreography#Exclusive_Databased_Gateway":["crosspath","crosspath2"],"http://b3mn.org/stencilset/bpmn2.0choreography#SequenceFlow":["arrowhead"],"http://b3mn.org/stencilset/epc#Fax":["opening"]};},getMeContainer:function(){return this.node.childNodes[0].childNodes[0];},getChildContainer:function(){return this.node.childNodes[0].childNodes[1];},getEdgeContainer:function(){return this.node.childNodes[0].childNodes[2];},update:function(){},_update:function(){},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);if(this.node.ownerDocument){var c=function(e){return this.node.ownerDocument.getElementById(e)||Ext.fly(this.node).child("[id="+e+"]",true);}.bind(this);var b=function(e){return[].concat($A(this.node.ownerDocument.getElementsByTagNameNS("http://www.w3.org/2000/svg",e)),$A(this.node.getElementsByTagNameNS("http://www.w3.org/2000/svg",e))).compact();}.bind(this);var a=this.getStencil().id();var d=this;this.propertiesChanged.each((function(e){if(e.value){var h=this.properties[e.key];var g=this.getStencil().property(e.key);this.propertiesChanged[e.key]=false;if(g.language()&&g.language()!==d.getCanvas().getLanguage()){return;}if(g.type()==ORYX.CONFIG.TYPE_CHOICE){g.refToView().each((function(l){if(l!==""){var k=this._labels[this.id+l];if(k&&g.item(h)){k.text(g.item(h).title());}}}).bind(this));var f=new Hash();g.items().each((function(k){k.refToView().each((function(l){if(l==""){return;}var m;m=c(this.id+l);if(!m){return;}if(!f[m.id]||h==k.value()){if(Ext.isOpera){m.setAttributeNS(null,"visibility",((h==k.value())?"visible":"hidden"));}m.setAttributeNS(null,"display",((h==k.value())?"inherit":"none"));f[m.id]=m;}if(ORYX.Editor.checkClassType(m,SVGImageElement)){m.setAttributeNS("http://www.w3.org/1999/xlink","href",m.getAttributeNS("http://www.w3.org/1999/xlink","href"));}}).bind(this));}).bind(this));}else{g.refToView().each((function(n){if(n===""){return;}var m=this.id+n;var o=c(m);var l=false;try{containsInDOM=this.node.parentNode&&!(o.ownerSVGElement);}catch(r){containsInDOM=false;}if(!o||containsInDOM){if(g.type()===ORYX.CONFIG.TYPE_URL||g.type()===ORYX.CONFIG.TYPE_DIAGRAM_LINK){var t=b("a");o=$A(t).find(function(x){return x.getAttributeNS(null,"id")===m;});if(!o){return;}}else{return;}}if(g.complexAttributeToView()){var s=this._labels[m];if(s){try{propJson=h.evalJSON();var u=propJson[g.complexAttributeToView()];s.text(("undefined"===typeof u)?h:u);}catch(r){s.text(h);}}}else{switch(g.type()){case ORYX.CONFIG.TYPE_BOOLEAN:if(typeof h=="string"){h=h==="true";}if(Ext.isOpera){o.setAttributeNS(null,"visibility",(!(h===g.inverseBoolean())?"visible":"hidden"));}o.setAttributeNS(null,"display",(!(h===g.inverseBoolean()))?"inherit":"none");break;case ORYX.CONFIG.TYPE_COLOR:if(g.fill()){if(o.tagName.toLowerCase()==="stop"){if(h){if(g.lightness()&&g.lightness()!==1){h=ORYX.Utils.adjustLightness(h,g.lightness());}o.setAttributeNS(null,"stop-color",h);if(o.parentNode.tagName.toLowerCase()==="radialgradient"){ORYX.Utils.adjustGradient(o.parentNode,o);}}if(o.parentNode.tagName.toLowerCase()==="radialgradient"){$A(o.parentNode.getElementsByTagName("stop")).each(function(x){x.setAttributeNS(null,"stop-opacity",h?x.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"default-stop-opacity")||1:0);}.bind(this));}var v=this.getMeContainer().childNodes[0];if(v&&v.nodeType==1){if(h&&String(v.getAttributeNS(null,"pointer-events")).toLowerCase()=="stroke"){v.setAttributeNS(null,"pointer-events","all");}else{if(!h&&String(v.getAttributeNS(null,"pointer-events")).toLowerCase()=="all"){v.setAttributeNS(null,"pointer-events","stroke");}}}}else{o.setAttributeNS(null,"fill",h||"none");}}if(g.stroke()){if(this.fillButStroke[a]&&this.fillButStroke[a].include(n)){o.setAttributeNS(null,"fill",h||"none");}else{o.setAttributeNS(null,"stroke",h);if(this.strokeAndFill[a]&&this.strokeAndFill[a].include(n)){o.setAttributeNS(null,"fill",h||"none");}}}break;case ORYX.CONFIG.TYPE_STRING:var s=this._labels[m];if(s){if(ORYX.CONFIG.MULTI_LANGUAGES_ENABLED&&g.language()&&g.value()==(h||"")){var u=h,q=g.origin(),p=$H(ORYX.CONFIG.MULTI_LANGUAGES||{}).keys().find(function(y){var x=q.prefix()+"-"+q.id()+(y==ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT?"":"_"+y);if((this.properties[x]||"")!=q.value()){u=this.properties[x]||"";return true;}return false;}.bind(this));if(p&&u!==h){u+=" ("+(Signavio.I18N.Multilanguage[String(p).toUpperCase()+"_Short"]||p)+")";s.text(u);s.css="x-label-invalid";break;}}s.text(h);s.css="";}break;case ORYX.CONFIG.TYPE_INTEGER:var s=this._labels[m];if(s){s.text(h);}break;case ORYX.CONFIG.TYPE_FLOAT:if(g.fillOpacity()){o.setAttributeNS(null,"fill-opacity",h);}if(g.strokeOpacity()){o.setAttributeNS(null,"stroke-opacity",h);}if(!g.fillOpacity()&&!g.strokeOpacity()){var s=this._labels[m];if(s){s.text(h);}}break;case ORYX.CONFIG.TYPE_URL:case ORYX.CONFIG.TYPE_DIAGRAM_LINK:var k=o.getAttributeNodeNS("http://www.w3.org/1999/xlink","xlink:href");if(k){k.textContent=h;}else{o.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",h);}break;}}}).bind(this));}}}).bind(this));this._labels.values().each(function(e){e.update();});}},layout:function(){var a=this.getStencil().layout();if(a){a.each(function(b){b.shape=this;b.forceExecution=true;this._delegateEvent(b);}.bind(this));}},getLabels:function(){return this._labels.values();},getLabel:function(a){if(!a){return null;}return(this._labels.find(function(b){return b.key.endsWith(a);})||{}).value||null;},hideLabels:function(){this.getLabels().invoke("hide");},showLabels:function(){var a=this.getLabels();a.invoke("show");a.each(function(b){b.update();});},setOpacity:function(b,a){b=Math.max(Math.min((typeof b=="number"?b:1),1),0);if(b!==1){b=String(b);this.node.setAttributeNS(null,"fill-opacity",b);this.node.setAttributeNS(null,"stroke-opacity",b);}else{this.node.removeAttributeNS(null,"fill-opacity");this.node.removeAttributeNS(null,"stroke-opacity");}},getDockers:function(){return this.dockers;},getMagnets:function(){return this.magnets;},getDefaultMagnet:function(){if(this._defaultMagnet){return this._defaultMagnet;}else{if(this.magnets.length>0){return this.magnets[0];}else{return undefined;}}},getParentShape:function(){return this.parent;},getIncomingShapes:function(a){if(a){this.incoming.each(a);}return this.incoming;},getIncomingNodes:function(a){return this.incoming.select(function(b){var c=(b instanceof ORYX.Core.Node);if(c&&a){a(b);}return c;});},getOutgoingShapes:function(a){if(a){this.outgoing.each(a);}return this.outgoing;},getOutgoingNodes:function(a){return this.outgoing.select(function(b){var c=(b instanceof ORYX.Core.Node);if(c&&a){a(b);}return c;});},getAllDockedShapes:function(b){var a=this.incoming.concat(this.outgoing);if(b){a.each(b);}return a;},getCanvas:function(){if("undefined"!=typeof this.canvas){return this.canvas;}if(this.parent instanceof ORYX.Core.Canvas){this.canvas=this.parent;}else{if(this.parent instanceof ORYX.Core.Shape){this.canvas=this.parent.getCanvas();}else{this.canvas=null;}}return this.canvas;},getChildNodes:function(b,c){if(!b&&!c){return this.nodes.clone();}else{var a=[];this.nodes.each(function(d){if(!d.isVisible){return;}if(c){c(d);}a.push(d);if(b&&d instanceof ORYX.Core.Shape){a=a.concat(d.getChildNodes(b,c));}});return a;}},add:function(b,d,c){if(b instanceof ORYX.Core.UIObject&&!(b instanceof ORYX.Core.Edge)){if(!(this.children.member(b))){if(b.parent){b.parent.remove(b,true);}if(d!=undefined){this.children.splice(d,0,b);}else{this.children.push(b);}b.parent=this;var e;if(b instanceof ORYX.Core.Node){e=this.node.childNodes[0].childNodes[1];if(d!=undefined){this.nodes.splice(d,0,b);}else{this.nodes.push(b);}}else{if(b instanceof ORYX.Core.Controls.Control){var a=this.node.childNodes[1];if(b instanceof ORYX.Core.Controls.Docker){e=a.childNodes[0];if(this.dockers.length>=2){this.dockers.splice(d!==undefined?Math.min(d,this.dockers.length-1):this.dockers.length-1,0,b);}else{this.dockers.push(b);}}else{if(b instanceof ORYX.Core.Controls.Magnet){e=a.childNodes[1];this.magnets.push(b);}else{e=a;}}}else{e=this.node;}}if(!(b instanceof ORYX.Core.Shape)){if(d!=undefined&&d<e.childNodes.length){b.node=e.insertBefore(b.node,e.childNodes[d]);}else{b.node=e.appendChild(b.node);}}this._changed();if(b instanceof ORYX.Core.Shape&&this.eventHandlerCallback&&c!==true){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:b});}}else{ORYX.Log.warn("add: ORYX.Core.UIObject is already a child of this object.");}}else{ORYX.Log.warn("add: Parameter is not of type ORYX.Core.UIObject.");}},remove:function(a,b){if(this.children.member(a)){var c=a.parent;this.children=this.children.without(a);a.parent=undefined;if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge){a.removeMarkers();if($A(this.node.childNodes[0].childNodes[2].childNodes).include(a.node)){a.node=this.node.childNodes[0].childNodes[2].removeChild(a.node);}}else{if($A(this.node.childNodes[0].childNodes[1].childNodes).include(a.node)){a.node=this.node.childNodes[0].childNodes[1].removeChild(a.node);}this.nodes=this.nodes.without(a);}}else{if(a instanceof ORYX.Core.Controls.Control){if(a instanceof ORYX.Core.Controls.Docker){if($A(this.node.childNodes[1].childNodes[0].childNodes).include(a.node)){a.node=this.node.childNodes[1].childNodes[0].removeChild(a.node);}this.dockers=this.dockers.without(a);}else{if(a instanceof ORYX.Core.Controls.Magnet){if($A(this.node.childNodes[1].childNodes[1].childNodes).include(a.node)){a.node=this.node.childNodes[1].childNodes[1].removeChild(a.node);}this.magnets=this.magnets.without(a);}else{if($A(this.node.childNodes[1].childNodes).include(a.node)){a.node=this.node.childNodes[1].removeChild(a.node);}}}}}if(this.eventHandlerCallback&&b!==true){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEREMOVED,shape:a,parent:c});}this._changed();}else{ORYX.Log.warn("remove: ORYX.Core.UIObject is not a child of this object.");}},getIntersectionPoint:function(){var q,p,k,h;switch(arguments.length){case 2:q=arguments[0].x;p=arguments[0].y;k=arguments[1].x;h=arguments[1].y;break;case 4:q=arguments[0];p=arguments[1];k=arguments[2];h=arguments[3];break;default:throw"getIntersectionPoints needs two or four arguments";}var e,b,f,d;var a=this.absoluteBounds();if(this.isPointIncluded(q,p,a)){e=q;b=p;}else{f=q;d=p;}if(this.isPointIncluded(k,h,a)){e=k;b=h;}else{f=k;d=h;}if(!e||!b||!f||!d){return undefined;}var o=0;var n=0;var s,r;var m=1;var c=ORYX.Core.Math.getIntersectionPointOfRect(f,d,e,b,a.upperLeft().x,a.upperLeft().y,a.lowerRight().x,a.lowerRight().y);if(c&&this.isPointIncluded(c.x,c.y,a)){return c;}var l=0;while(true){var o=Math.min(e,f)+((Math.max(e,f)-Math.min(e,f))/2);var n=Math.min(b,d)+((Math.max(b,d)-Math.min(b,d))/2);if(this.isPointIncluded(o,n,a)){e=o;b=n;}else{f=o;d=n;}var g=Math.sqrt(Math.pow(e-f,2)+Math.pow(b-d,2));s=e+((f-e)/g);r=b+((d-b)/g);if(!this.isPointIncluded(s,r,a)){break;}if(Math.abs(g)<1){break;}}return{x:s,y:r};},isPointIncluded:function(){return false;},containsNode:function(b){var a=this.node.firstChild.firstChild;while(b){if(b==a){return true;}b=b.parentNode;}return false;},isPointOverOffset:function(){return this.isPointIncluded.apply(this,arguments);},getOverlap:function(a){var h=this;var g=h.absoluteBounds().upperLeft();var e=h.absoluteBounds().lowerRight();var c=a.absoluteBounds().upperLeft();var b=a.absoluteBounds().lowerRight();var l=Math.min(e.x,b.x)-Math.max(g.x,c.x);var k=Math.min(e.y,b.y)-Math.max(g.y,c.y);if(l>0||k>0){var f={x:Math.max(g.x,c.x),y:Math.min(e.y,b.y)};var d={x:Math.min(e.x,b.x),y:Math.max(g.y,c.y)};return new ORYX.Core.Bounds(f,d);}else{return false;}},_dockerChanged:function(){},createDocker:function(b,a){var c=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});c.bounds.registerCallback(this._dockerChangedCallback);if(a){c.bounds.centerMoveTo(a);}this.add(c,b);return c;},serialize:function(){var a=arguments.callee.$.serialize.apply(this);a.push({name:"bounds",prefix:"oryx",value:this.bounds.serializeForERDF(),type:"literal"});this.getOutgoingShapes().each((function(b){a.push({name:"outgoing",prefix:"raziel",value:"#"+ERDF.__stripHashes(b.resourceId),type:"resource"});}).bind(this));a.push({name:"parent",prefix:"raziel",value:"#"+ERDF.__stripHashes(this.parent.resourceId),type:"resource"});return a;},deserialize:function(d,c){arguments.callee.$.deserialize.apply(this,arguments);var e=d.find(function(b){return"oryx-bounds"===(b.prefix+"-"+b.name);});if(e){var a=e.value.replace(/,/g," ").split(" ").without("");if(this instanceof ORYX.Core.Edge){if(!this.dockers.first().isChanged){this.dockers.first().bounds.centerMoveTo(parseFloat(a[0]),parseFloat(a[1]));}if(!this.dockers.last().isChanged){this.dockers.last().bounds.centerMoveTo(parseFloat(a[2]),parseFloat(a[3]));}}else{this.bounds.set(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]));}}if(c&&c.labels instanceof Array){c.labels.each(function(b){var f=this.getLabel(b.ref);if(f){f.deserialize(b,this);}}.bind(this));}},toJSON:function(){var a=arguments.callee.$.toJSON.apply(this,arguments);var c=[],b=this.id;this._labels.each(function(e){var d=e.value.serialize();if(d){d.ref=e.key.replace(b,"");c.push(d);}});if(c.length>0){a.labels=c;}return a;},_init:function(a){this._adjustIds(a,0);},_adjustIds:function(c,f){if(c instanceof Element){var a=c.getAttributeNS(null,"id");if(a&&a!==""){c.setAttributeNS(null,"id",this.id+a);}else{c.setAttributeNS(null,"id",this.id+"_"+this.id+"_"+f);f++;}var e=c.getAttributeNS(null,"fill");if(e&&e.include("url(#")){e=e.replace(/url\(#/g,"url(#"+this.id);c.setAttributeNS(null,"fill",e);}var d=c.getAttributeNS(null,"filter");if(d&&d.include("url(#")){d=d.replace(/url\(#/g,"url(#"+this.id);c.setAttributeNS(null,"filter",d);}if(c.hasChildNodes()){for(var b=0;b<c.childNodes.length;b++){f=this._adjustIds(c.childNodes[b],f);}}}return f;},toString:function(){return"ORYX.Core.Shape "+this.getId();}});}();if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.Controls){ORYX.Core.Controls={};}ORYX.Core.Controls.Control=ORYX.Core.UIObject.extend({toString:function(){return"Control "+this.id;}});if("undefined"==typeof ORYX){var ORYX={};}if("undefined"==typeof ORYX.Core){ORYX.Core={};}if("undefined"==typeof ORYX.Core.Controls){ORYX.Core.Controls={};}new function(){ORYX.Core.Controls.Docker=ORYX.Core.Controls.Control.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);var a=Ext.isIPad?12:8;this.isMovable=true;this.bounds.set(0,0,a*2,a*2);this.referencePoint=undefined;this._dockedShapeBounds=undefined;this._dockedShape=undefined;this._oldRefPoint1=undefined;this._oldRefPoint2=undefined;this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g"]);this._dockerNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["g",{"pointer-events":"all"},["circle",{cx:a,cy:a,r:a,stroke:"none",fill:"none"}],["circle",{cx:a,cy:a,r:a-5,stroke:"black",fill:"red","stroke-width":"1","fill-opacity":Ext.isIPad?0.5:1,"stroke-opacity":Ext.isIPad?0.5:1}]]);this._referencePointNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["g",{"pointer-events":"none"},["circle",{cx:this.bounds.upperLeft().x,cy:this.bounds.upperLeft().y,r:3,fill:"red","fill-opacity":0.4,style:Ext.isIPad?"visibility:hidden;":""}]]);this.hide();this.addEventHandlers(this._dockerNode);this._updateCallback=this._changed.bind(this);},update:function(){if(this._dockedShape){if(this._dockedShapeBounds&&this._dockedShape instanceof ORYX.Core.Node){var g=this._dockedShapeBounds.width();var d=this._dockedShapeBounds.height();if(!g){g=1;}if(!d){d=1;}var o=this._dockedShape.bounds.width()/g;var m=this._dockedShape.bounds.height()/d;if(o!==1||m!==1){this.referencePoint.x*=o;this.referencePoint.y*=m;}this._dockedShapeBounds=this._dockedShape.bounds.clone();}var b=this.parent.dockers.indexOf(this);var f=this;var e=this.parent.dockers.length>1?(b===0?this.parent.dockers[b+1]:this.parent.dockers[b-1]):undefined;var n=f.getDockedShape()&&!f._connectsEdgeOnEdge()?f.getAbsoluteReferencePoint():f.bounds.center();var k=e&&e.getDockedShape()&&!e._connectsEdgeOnEdge()?e.getAbsoluteReferencePoint():e?e.bounds.center():undefined;if(!k){var a=this._dockedShape.absoluteCenterXY();var l=this._dockedShape.bounds.width()*this._dockedShape.bounds.height();k={x:n.x+(a.x-n.x)*-l,y:n.y+(a.y-n.y)*-l};}var c=undefined;c=this._dockedShape.getIntersectionPoint(n,k);if(!c){c=this.getAbsoluteReferencePoint();}if(this.parent&&this.parent.parent){var h=this.parent.parent.absoluteXY();c.x-=h.x;c.y-=h.y;}this.bounds.centerMoveTo(c);this._oldRefPoint1=n;this._oldRefPoint2=k;}arguments.callee.$.update.apply(this,arguments);},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var a=this.bounds.upperLeft();this._dockerNode.setAttributeNS(null,"transform","translate("+a.x+", "+a.y+")");a=Object.clone(this.referencePoint);if(a&&this._dockedShape){var b;if(this.parent instanceof ORYX.Core.Edge){b=this._dockedShape.absoluteXY();}else{b=this._dockedShape.bounds.upperLeft();}a.x+=b.x;a.y+=b.y;}else{a=this.bounds.center();}this._referencePointNode.setAttributeNS(null,"transform","translate("+a.x+", "+a.y+")");},setReferencePoint:function(a){if(this.referencePoint!==a&&(!this.referencePoint||!a||this.referencePoint.x!==a.x||this.referencePoint.y!==a.y)){var b=this.getDockedShape();if(b){a.x=Math.max(0,Math.min(b.bounds.width(),a.x));a.y=Math.max(0,Math.min(b.bounds.height(),a.y));}this.referencePoint=a;this._changed();}},getAbsoluteReferencePoint:function(){if(!this.referencePoint||!this._dockedShape){return undefined;}else{var a=this._dockedShape.absoluteXY();return{x:this.referencePoint.x+a.x,y:this.referencePoint.y+a.y};}},setDockedShape:function(b){if(this._dockedShape){this._dockedShape.bounds.unregisterCallback(this._updateCallback);if(this===this.parent.dockers.first()){this.parent.incoming=this.parent.incoming.without(this._dockedShape);this._dockedShape.outgoing=this._dockedShape.outgoing.without(this.parent);}else{if(this===this.parent.dockers.last()){this.parent.outgoing=this.parent.outgoing.without(this._dockedShape);this._dockedShape.incoming=this._dockedShape.incoming.without(this.parent);}}}this._dockedShape=b;this._dockedShapeBounds=undefined;var a=undefined;if(this._dockedShape){if(this===this.parent.dockers.first()){this.parent.incoming.push(b);b.outgoing.push(this.parent);}else{if(this===this.parent.dockers.last()){this.parent.outgoing.push(b);b.incoming.push(this.parent);}}var c=this.bounds;var d=b.absoluteXY();a={x:c.center().x-d.x,y:c.center().y-d.y};this._dockedShapeBounds=this._dockedShape.bounds.clone();this._dockedShape.bounds.registerCallback(this._updateCallback);this.setDockerColor(ORYX.CONFIG.DOCKER_DOCKED_COLOR);}else{this.setDockerColor(ORYX.CONFIG.DOCKER_UNDOCKED_COLOR);}this.setReferencePoint(a);this._changed();},getDockedShape:function(){return this._dockedShape;},isDocked:function(){return !!this._dockedShape;},setDockerColor:function(a){this._dockerNode.lastChild.setAttributeNS(null,"fill",a);},preventHiding:function(a){this._preventHiding=Math.max(0,(this._preventHiding||0)+(a?1:-1));},hide:function(){if(this._preventHiding){return false;}this.node.setAttributeNS(null,"visibility","hidden");this._referencePointNode.setAttributeNS(null,"visibility","hidden");this.children.each(function(a){a.hide();});},show:function(){this.node.setAttributeNS(null,"visibility","visible");if(this.getDockedShape() instanceof ORYX.Core.Edge){this._referencePointNode.setAttributeNS(null,"visibility","hidden");}else{this._referencePointNode.setAttributeNS(null,"visibility","visible");}this.children.each(function(a){a.show();});},absoluteBounds:function(){return this.bounds.clone();},_connectsEdgeOnEdge:function(){return(this.parent instanceof ORYX.Core.Edge&&this.getDockedShape() instanceof ORYX.Core.Edge);},toString:function(){return"Docker "+this.id;}});}();if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}if(!ORYX.Core.Controls){ORYX.Core.Controls={};}ORYX.Core.Controls.Magnet=ORYX.Core.Controls.Control.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this.bounds.set(0,0,16,16);this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{"pointer-events":"all"},["circle",{cx:"8",cy:"8",r:"4",stroke:"none",fill:"red","fill-opacity":"0.3"}]]);this.hide();},update:function(){arguments.callee.$.update.apply(this,arguments);},_update:function(){arguments.callee.$.update.apply(this,arguments);},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var a=this.bounds.upperLeft();this.node.setAttributeNS(null,"transform","translate("+a.x+", "+a.y+")");},show:function(){arguments.callee.$.show.apply(this,arguments);},toString:function(){return"Magnet "+this.id;}});if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}ORYX.Core.Node={construct:function(a,b){arguments.callee.$.construct.apply(this,arguments);this.isSelectable=true;this.isMovable=true;this._dockerUpdated=false;this._oldBounds=new ORYX.Core.Bounds();this._svgShapes=[];this.minimumSize=undefined;this.maximumSize=undefined;this.isHorizontallyResizable=false;this.isVerticallyResizable=false;this.dataId=undefined;this._init(this._stencil.view());},_update:function(){this.dockers.invoke("update");if(this.isChanged){var c=this.bounds;var d=this._oldBounds;if(this.isResized){var r=c.width()/d.width();var q=c.height()/d.height();this._svgShapes.each(function(z){if(z.isHorizontallyResizable){z.width=z.oldWidth*r;}if(z.isVerticallyResizable){z.height=z.oldHeight*q;}var y;var u=z.anchorLeft;var x=z.anchorRight;if(x){y=d.width()-(z.oldX+z.oldWidth);if(u){z.width=c.width()-z.x-y;}else{z.x=c.width()-(y+z.width);}}else{if(!u){z.x=r*z.oldX;if(!z.isHorizontallyResizable){z.x=z.x+z.width*r/2-z.width/2;}}}var p=z.anchorTop;var v=z.anchorBottom;if(v){y=d.height()-(z.oldY+z.oldHeight);if(p){z.height=c.height()-z.y-y;}else{if(!z._isYLocked){z.y=c.height()-(y+z.height);}}}else{if(!p){z.y=q*z.oldY;if(!z.isVerticallyResizable){z.y=z.y+z.height*q/2-z.height/2;}}}});var g={x:0,y:0};if(!this.isHorizontallyResizable&&c.width()!==d.width()){g.x=d.width()-c.width();}if(!this.isVerticallyResizable&&c.height()!==d.height()){g.y=d.height()-c.height();}if(g.x!==0||g.y!==0){c.extend(g);}g={x:0,y:0};var e,k;if(this.minimumSize){ORYX.Log.debug("Shape (%0)'s min size: (%1x%2)",this,this.minimumSize.width,this.minimumSize.height);e=this.minimumSize.width-c.width();if(e>0){g.x+=e;}k=this.minimumSize.height-c.height();if(k>0){g.y+=k;}}if(this.maximumSize){ORYX.Log.debug("Shape (%0)'s max size: (%1x%2)",this,this.maximumSize.width,this.maximumSize.height);e=c.width()-this.maximumSize.width;if(e>0){g.x-=e;}k=c.height()-this.maximumSize.height;if(k>0){g.y-=k;}}if(g.x!==0||g.y!==0){c.extend(g);}var r=c.width()/d.width();var q=c.height()/d.height();var n,m,s,f,b,a,t;this.magnets.each(function(p){n=p.anchorLeft;m=p.anchorRight;s=p.anchorTop;f=p.anchorBottom;b=p.bounds.center();if(n){a=b.x;}else{if(m){a=c.width()-(d.width()-b.x);}else{a=b.x*r;}}if(s){t=b.y;}else{if(f){t=c.height()-(d.height()-b.y);}else{t=b.y*q;}}if(b.x!==a||b.y!==t){p.bounds.centerMoveTo(a,t);}});this.getLabels().each(function(p){if(p.updated){delete p.updated;return;}if(!p.isAnchorLeft()){if(p.isAnchorRight()){p.setX(c.width()-(d.width()-p.oldX));}else{p.setX((p.position?p.position.x:p.x)*r);}}if(!p.isAnchorTop()){if(p.isAnchorBottom()){p.setY(c.height()-(d.height()-p.oldY));}else{p.setY((p.position?p.position.y:p.y)*q);}}if(p.position){if(!p.isOriginAnchorLeft()){if(p.isOriginAnchorRight()){p.setOriginX(c.width()-(d.width()-p.oldX));}else{p.setOriginX(p.x*r);}}if(!p.isOriginAnchorTop()){if(p.isOriginAnchorBottom()){p.setOriginY(c.height()-(d.height()-p.oldY));}else{p.setOriginY(p.y*q);}}}});var h=this.dockers[0];if(h){h.bounds.unregisterCallback(this._dockerChangedCallback);if(!this._dockerUpdated){h.bounds.centerMoveTo(this.bounds.center());this._dockerUpdated=false;}h.update();h.bounds.registerCallback(this._dockerChangedCallback);}this.isResized=false;}this.refresh();this.isChanged=false;this._oldBounds=this.bounds.clone();}this.children.each(function(p){if(!(p instanceof ORYX.Core.Controls.Docker)){p._update();}});if(this.dockers.length>0&&!this.dockers.first().getDockedShape()){this.dockers.each(function(p){p.bounds.centerMoveTo(this.bounds.center());}.bind(this));}if(this.parent&&!this.node.parentNode){var l=this.parent.nodes.indexOf(this);var o=this.parent.getChildContainer();if(l<o.childNodes.length){o.insertBefore(this.node,o.childNodes[l]);}else{o.appendChild(this.node);}}},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var a=this.bounds.upperLeft().x;var b=this.bounds.upperLeft().y;this.node.firstChild.setAttributeNS(null,"transform","translate("+a+", "+b+")");this.node.childNodes[1].childNodes[1].setAttributeNS(null,"transform","translate("+a+", "+b+")");this._svgShapes.each(function(c){c.update();});},_dockerChanged:function(){var a=this.dockers[0];this.bounds.centerMoveTo(a.bounds.center());this._dockerUpdated=true;},_initSVGShapes:function(d,c){var a=[],g;try{g=new ORYX.Core.SVG.SVGShape(d,c);a.push(g);}catch(f){}if(d.hasChildNodes()){for(var b=0;b<d.childNodes.length;b++){a=a.concat(this._initSVGShapes(d.childNodes[b],g));}}return a;},isPointIncluded:function(a,k,c){var h=c&&c instanceof ORYX.Core.Bounds?c:this.absoluteBounds();if(!h.isIncluded(a,k)){return false;}else{}var e=h.upperLeft();var g=a-e.x;var f=k-e.y;var d=0;do{var b=this._svgShapes[d++].isPointIncluded(g,f);}while(!b&&d<this._svgShapes.length);return b;},isPointOverOffset:function(d,c){var b=arguments.callee.$.isPointOverOffset.apply(this,arguments);if(b){var a=this.absoluteBounds();a.widen(-ORYX.CONFIG.BORDER_OFFSET);if(!a.isIncluded(d,c)){return true;}}return false;},serialize:function(){var a=arguments.callee.$.serialize.apply(this);this.dockers.each((function(e){if(e.getDockedShape()){var d=e.referencePoint;d=d?d:e.bounds.center();a.push({name:"docker",prefix:"oryx",value:$H(d).values().join(","),type:"literal"});}}).bind(this));try{var b=this.getStencil().serialize();if(b.type){b.shape=this;b.data=a;b.result=undefined;b.forceExecution=true;this._delegateEvent(b);if(b.result){a=b.result;}}}catch(c){}return a;},deserialize:function(f){arguments.callee.$.deserialize.apply(this,arguments);try{var a=this.getStencil().deserialize();if(a.type){a.shape=this;a.data=f;a.result=undefined;a.forceExecution=true;this._delegateEvent(a);if(a.result){f=a.result;}}}catch(g){}var b=f.findAll(function(e){return(e.prefix+"-"+e.name)=="raziel-outgoing";});b.each((function(l){if(!this.parent){return;}var k=this.getCanvas().getChildShapeByResourceId(l.value);if(k){if(k instanceof ORYX.Core.Edge){var h=k.dockers.first().referencePoint||k.dockers.first().bounds.center();var e={x:h.x,y:h.y};k.dockers.first().setDockedShape(this);k.dockers.first().setReferencePoint(e);}else{if(k.dockers.length>0){k.dockers.first().setDockedShape(this);}}}}).bind(this));if(this.dockers.length===1){var d;d=f.find(function(e){return(e.prefix+"-"+e.name==="oryx-dockers");});if(d){var c=d.value.replace(/,/g," ").split(" ").without("").without("#");if(c.length===2&&this.dockers[0].getDockedShape()){this.dockers[0].setReferencePoint({x:parseFloat(c[0]),y:parseFloat(c[1])});}else{this.dockers[0].bounds.centerMoveTo(parseFloat(c[0]),parseFloat(c[1]));}}}},_init:function(n){arguments.callee.$._init.apply(this,arguments);var o=n.getElementsByTagName("g")[0];var r=n.ownerDocument.createAttributeNS(null,"title");r.nodeValue=this.getStencil().title();o.setAttributeNode(r);var u=n.ownerDocument.createAttributeNS(null,"id");u.nodeValue=this.id;o.setAttributeNode(u);var b=this.node.childNodes[0].childNodes[0];var t=o.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"minimumSize");if(t){t=t.replace("/,/g"," ");var k=t.split(" ");k=k.without("");if(k.length>1){this.minimumSize={width:parseFloat(k[0]),height:parseFloat(k[1])};}else{this.minimumSize={width:1,height:1};}}var g=o.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"maximumSize");if(g){g=g.replace("/,/g"," ");var l=g.split(" ");l=l.without("");if(l.length>1){this.maximumSize={width:parseFloat(l[0]),height:parseFloat(l[1])};}}if(this.minimumSize&&this.maximumSize&&(this.minimumSize.width>this.maximumSize.width||this.minimumSize.height>this.maximumSize.height)){throw this+": Minimum Size must be greater than maxiumSize.";}this._svgShapes=this._initSVGShapes(o);var a={x:undefined,y:undefined};var d={x:undefined,y:undefined};var z=this;this._svgShapes.each(function(A){a.x=(a.x!==undefined)?Math.min(a.x,A.x):A.x;a.y=(a.y!==undefined)?Math.min(a.y,A.y):A.y;d.x=(d.x!==undefined)?Math.max(d.x,A.x+A.width):A.x+A.width;d.y=(d.y!==undefined)?Math.max(d.y,A.y+A.height):A.y+A.height;if(A.isHorizontallyResizable){z.isHorizontallyResizable=true;z.isResizable=true;}if(A.isVerticallyResizable){z.isVerticallyResizable=true;z.isResizable=true;}if(A.anchorTop&&A.anchorBottom){z.isVerticallyResizable=true;z.isResizable=true;}if(A.anchorLeft&&A.anchorRight){z.isHorizontallyResizable=true;z.isResizable=true;}});this._svgShapes.each(function(A){A.x-=a.x;A.y-=a.y;A.update();});var y=a.x;var x=a.y;d.x-=y;d.y-=x;a.x=0;a.y=0;if(d.x===0){d.x=1;}if(d.y===0){d.y=1;}this._oldBounds.set(a,d);this.bounds.set(a,d);var f=n.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"magnets");if(f&&f.length>0){f=$A(f[0].getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"magnet"));var z=this;f.each(function(B){var F=new ORYX.Core.Controls.Magnet({eventHandlerCallback:z.eventHandlerCallback});var A=parseFloat(B.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cx"));var G=parseFloat(B.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cy"));F.bounds.centerMoveTo({x:A-y,y:G-x});var E=B.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(E){E=E.replace("/,/g"," ");E=E.split(" ").without("");for(var C=0;C<E.length;C++){switch(E[C].toLowerCase()){case"left":F.anchorLeft=true;break;case"right":F.anchorRight=true;break;case"top":F.anchorTop=true;break;case"bottom":F.anchorBottom=true;break;}}}z.add(F);if(!this._defaultMagnet){var D=B.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"default");if(D&&D.toLowerCase()==="yes"){z._defaultMagnet=F;}}});}else{var h=new ORYX.Core.Controls.Magnet();h.bounds.centerMoveTo(this.bounds.width()/2,this.bounds.height()/2);this.add(h);}var s=n.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"docker");if(s&&s.length>0){s=s[0];var q=this.createDocker();var e=parseFloat(s.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cx"));var c=parseFloat(s.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cy"));q.bounds.centerMoveTo({x:e-y,y:c-x});var p=s.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(p){p=p.replace("/,/g"," ");p=p.split(" ").without("");for(var v=0;v<p.length;v++){switch(p[v].toLowerCase()){case"left":q.anchorLeft=true;break;case"right":q.anchorRight=true;break;case"top":q.anchorTop=true;break;case"bottom":q.anchorBottom=true;break;}}}}var m=o.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"text");$A(m).each((function(B){var A=new ORYX.Core.SVG.Label({textElement:B,shapeId:this.id,richtext:true});A.x-=y;A.y-=x;this._labels[A.id]=A;A.registerOnChange(this.layout.bind(this));}).bind(this));b.appendChild(o);this.addEventHandlers(b);},createDocker:function(){var a=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});a.bounds.registerCallback(this._dockerChangedCallback);this.dockers.push(a);a.parent=this;a.bounds.registerCallback(this._changedCallback);return a;},getSVGShape:function(a){return this._svgShapes.find(function(b){return b===a||b.node===a||b.id.endsWith(String(a));});},toString:function(){return this._stencil.title()+" "+this.id;}};ORYX.Core.Node=ORYX.Core.Shape.extend(ORYX.Core.Node);NAMESPACE_SVG="http://www.w3.org/2000/svg";NAMESPACE_ORYX="http://www.b3mn.org/oryx";if(!ORYX){var ORYX={};}if(!ORYX.Core){ORYX.Core={};}ORYX.Core.Edge={construct:function(a,c){arguments.callee.$.construct.apply(this,arguments);this.isMovable=true;this.isSelectable=true;this._dockerUpdated=false;this._markers=new Hash();this._paths=[];this._interactionPaths=[];this._shadowPaths=[];this._dockersByPath=new Hash();this._markersByPath=new Hash();this.attachedNodePositionData=new Hash();var b=this.node.childNodes[0].childNodes[0];b=ORYX.Editor.graft("http://www.w3.org/2000/svg",b,["g",{"pointer-events":"painted"}]);this.addEventHandlers(b.parentNode);this._oldBounds=this.bounds.clone();this._init(this._stencil.view());if(c instanceof Array){this.deserialize(c);}},_update:function(c){if(this._dockerUpdated||this.isChanged||c){this.dockers.invoke("update");if(false&&(this.bounds.width()===0||this.bounds.height()===0)){var d=this.bounds.width();var q=this.bounds.height();this.bounds.extend({x:d===0?2:0,y:q===0?2:0});this.bounds.moveBy({x:d===0?-1:0,y:q===0?-1:0});}var e=this.bounds.upperLeft();var n=this._oldBounds.upperLeft();var f=this._oldBounds.width()===0?this.bounds.width():this._oldBounds.width();var p=this._oldBounds.height()===0?this.bounds.height():this._oldBounds.height();var m=e.x-n.x;var k=e.y-n.y;var o=(this.bounds.width()/f)||1;var g=(this.bounds.height()/p)||1;this.dockers.each((function(b){b.bounds.unregisterCallback(this._dockerChangedCallback);if(!this._dockerUpdated){b.bounds.moveBy(m,k);if(o!==1||g!==1){var r=b.bounds.upperLeft().x-e.x;var a=b.bounds.upperLeft().y-e.y;b.bounds.moveTo(e.x+r*o,e.y+a*g);}}b.update();b.bounds.registerCallback(this._dockerChangedCallback);}).bind(this));if(this._dockerUpdated){var l=this.dockers.first().bounds.center();var h=this.dockers.first().bounds.center();this.dockers.each((function(b){var a=b.bounds.center();l.x=Math.min(l.x,a.x);l.y=Math.min(l.y,a.y);h.x=Math.max(h.x,a.x);h.y=Math.max(h.y,a.y);}).bind(this));this.bounds.set(Object.clone(l),Object.clone(h));}e=this.bounds.upperLeft();n=this._oldBounds.upperLeft();o=(this.bounds.width()/(f||this.bounds.width()));g=(this.bounds.height()/(p||this.bounds.height()));m=e.x-n.x;k=e.y-n.y;this.getLabels().each(function(C){if(C.getReferencePoint()){var v=C.getReferencePoint();var K=v.segment.from,b=v.segment.to;if(!K||!K.parent||!b||!b.parent){return;}var J=K.bounds.center(),B=b.bounds.center();if(J.x===v.segment.fromPosition.x&&J.y===v.segment.fromPosition.y&&B.x===v.segment.toPosition.x&&B.y===v.segment.toPosition.y&&!v.dirty){return;}if(!this.parent.initializingShapes){var L=ORYX.Core.Math.getDistanceBetweenTwoPoints(v.segment.fromPosition,v.segment.toPosition,v.intersection);var M=ORYX.Core.Math.getPointBetweenTwoPoints(J,B,isNaN(L)?0.5:L);var I=ORYX.Core.Math.getOrthogonalIdentityVector(J,B);var a=Math.abs(I.y)===1,F=Math.abs(I.x)===1;I.x*=v.distance;I.y*=v.distance;I.x+=M.x;I.y+=M.y;var H=a&&v.orientation&&(v.iorientation||v.orientation).endsWith("r")?-C.getWidth():0;var G=F&&v.orientation&&(v.iorientation||v.orientation).startsWith("l")?-C.getHeight()+2:0;C.setX(I.x+H);C.setY(I.y+G);this.updateReferencePointOfLabel(C,M,K,b);}else{var I=ORYX.Core.Math.getOrthogonalIdentityVector(J,B);I.x*=v.distance;I.y*=v.distance;I.x+=v.intersection.x;I.y+=v.intersection.y;C.setX(I.x);C.setY(I.y);v.segment.fromPosition=J;v.segment.toPosition=B;}return;}if(C.position&&!this.parent.initializingShapes){var E=C.position.x+(m*(o||1));if(E>this.bounds.lowerRight().x){E+=this.bounds.width()-(this.bounds.width()/(o||1));}var D=C.position.y+(k*(g||1));if(D>this.bounds.lowerRight().y){D+=this.bounds.height()-(this.bounds.height()/(g||1));}C.setX(E);C.setY(D);return;}switch(C.getEdgePosition()){case"starttop":var N=this._getAngle(this.dockers[0],this.dockers[1]);var z=this.dockers.first().bounds.center();if(N<=90||N>270){C.horizontalAlign("left");C.verticalAlign("bottom");C.x=z.x+C.getOffsetTop();C.y=z.y-C.getOffsetTop();C.rotate(360-N,z);}else{C.horizontalAlign("right");C.verticalAlign("bottom");C.x=z.x-C.getOffsetTop();C.y=z.y-C.getOffsetTop();C.rotate(180-N,z);}break;case"startmiddle":var N=this._getAngle(this.dockers[0],this.dockers[1]);var z=this.dockers.first().bounds.center();if(N<=90||N>270){C.horizontalAlign("left");C.verticalAlign("bottom");C.x=z.x+2;C.y=z.y+4;C.rotate(360-N,z);}else{C.horizontalAlign("right");C.verticalAlign("bottom");C.x=z.x+1;C.y=z.y+4;C.rotate(180-N,z);}break;case"startbottom":var N=this._getAngle(this.dockers[0],this.dockers[1]);var z=this.dockers.first().bounds.center();if(N<=90||N>270){C.horizontalAlign("left");C.verticalAlign("top");C.x=z.x+C.getOffsetBottom();C.y=z.y+C.getOffsetBottom();C.rotate(360-N,z);}else{C.horizontalAlign("right");C.verticalAlign("top");C.x=z.x-C.getOffsetBottom();C.y=z.y+C.getOffsetBottom();C.rotate(180-N,z);}break;case"midtop":var u=this.dockers.length;if(u%2==0){var N=this._getAngle(this.dockers[u/2-1],this.dockers[u/2]);var t=this.dockers[u/2-1].bounds.center();var r=this.dockers[u/2].bounds.center();var z={x:(t.x+r.x)/2,y:(t.y+r.y)/2};C.horizontalAlign("center");C.verticalAlign("bottom");C.x=z.x;C.y=z.y-C.getOffsetTop();if(N<=90||N>270){C.rotate(360-N,z);}else{C.rotate(180-N,z);}}else{var A=parseInt(u/2);var N=this._getAngle(this.dockers[A],this.dockers[A+1]);var z=this.dockers[A].bounds.center();if(N<=90||N>270){C.horizontalAlign("left");C.verticalAlign("bottom");C.x=z.x+C.getOffsetTop();C.y=z.y-C.getOffsetTop();C.rotate(360-N,z);}else{C.horizontalAlign("right");C.verticalAlign("bottom");C.x=z.x-C.getOffsetTop();C.y=z.y-C.getOffsetTop();C.rotate(180-N,z);}}break;case"midbottom":var u=this.dockers.length;if(u%2==0){var N=this._getAngle(this.dockers[u/2-1],this.dockers[u/2]);var t=this.dockers[u/2-1].bounds.center();var r=this.dockers[u/2].bounds.center();var z={x:(t.x+r.x)/2,y:(t.y+r.y)/2};C.horizontalAlign("center");C.verticalAlign("top");C.x=z.x;C.y=z.y+C.getOffsetTop();if(N<=90||N>270){C.rotate(360-N,z);}else{C.rotate(180-N,z);}}else{var A=parseInt(u/2);var N=this._getAngle(this.dockers[A],this.dockers[A+1]);var z=this.dockers[A].bounds.center();if(N<=90||N>270){C.horizontalAlign("left");C.verticalAlign("top");C.x=z.x+C.getOffsetBottom();C.y=z.y+C.getOffsetBottom();C.rotate(360-N,z);}else{C.horizontalAlign("right");C.verticalAlign("top");C.x=z.x-C.getOffsetBottom();C.y=z.y+C.getOffsetBottom();C.rotate(180-N,z);}}break;case"endtop":var s=this.dockers.length;var N=this._getAngle(this.dockers[s-2],this.dockers[s-1]);var z=this.dockers.last().bounds.center();if(N<=90||N>270){C.horizontalAlign("right");C.verticalAlign("bottom");C.x=z.x-C.getOffsetTop();C.y=z.y-C.getOffsetTop();C.rotate(360-N,z);}else{C.horizontalAlign("left");C.verticalAlign("bottom");C.x=z.x+C.getOffsetTop();C.y=z.y-C.getOffsetTop();C.rotate(180-N,z);}break;case"endbottom":var s=this.dockers.length;var N=this._getAngle(this.dockers[s-2],this.dockers[s-1]);var z=this.dockers.last().bounds.center();if(N<=90||N>270){C.horizontalAlign("right");C.verticalAlign("top");C.x=z.x-C.getOffsetBottom();C.y=z.y+C.getOffsetBottom();C.rotate(360-N,z);}else{C.horizontalAlign("left");C.verticalAlign("top");C.x=z.x+C.getOffsetBottom();C.y=z.y+C.getOffsetBottom();C.rotate(180-N,z);}break;}}.bind(this));this.children.each(function(a){if(a instanceof ORYX.Core.Node){this.calculatePositionOfAttachedChildNode.call(this,a);}}.bind(this));this.refreshAttachedNodes();this.refresh();this.isChanged=false;this._dockerUpdated=false;this._oldBounds=this.bounds.clone();}if(this.parent&&!this.node.parentNode){this.parent.getEdgeContainer().appendChild(this.node);}},movePointToUpperLeftOfNode:function(a,b){a.x-=b.width()/2;a.y-=b.height()/2;},refreshAttachedNodes:function(){this.attachedNodePositionData.values().each(function(a){var d=a.segment.docker1.bounds.center();var b=a.segment.docker2.bounds.center();this.relativizePoint(d);this.relativizePoint(b);var c=new Object();c.x=d.x+a.relativDistanceFromDocker1*(b.x-d.x);c.y=d.y+a.relativDistanceFromDocker1*(b.y-d.y);this.movePointToUpperLeftOfNode(c,a.node.bounds);a.node.bounds.moveTo(c);a.node._update();}.bind(this));},calculatePositionOfAttachedChildNode:function(b){var a=new Object();a.x=0;a.y=0;if(!this.attachedNodePositionData[b.getId()]){this.attachedNodePositionData[b.getId()]=new Object();this.attachedNodePositionData[b.getId()].relativDistanceFromDocker1=0;this.attachedNodePositionData[b.getId()].node=b;this.attachedNodePositionData[b.getId()].segment=new Object();this.findEdgeSegmentForNode(b);}else{if(b.isChanged){this.findEdgeSegmentForNode(b);}}},findEdgeSegmentForNode:function(c){var b=this.dockers.length;var a=undefined;for(i=1;i<b;i++){var g=this.dockers[i-1].bounds.center();var e=this.dockers[i].bounds.center();this.relativizePoint(g);this.relativizePoint(e);var d=c.bounds.center();var f=ORYX.Core.Math.distancePointLinie(g,e,d,true);if((f||f==0)&&((!a&&a!=0)||f<a)){a=f;this.attachedNodePositionData[c.getId()].segment.docker1=this.dockers[i-1];this.attachedNodePositionData[c.getId()].segment.docker2=this.dockers[i];}if(!f&&!a&&a!=0){(ORYX.Core.Math.getDistancePointToPoint(d,g)<ORYX.Core.Math.getDistancePointToPoint(d,e))?this.attachedNodePositionData[c.getId()].relativDistanceFromDocker1=0:this.attachedNodePositionData[c.getId()].relativDistanceFromDocker1=1;this.attachedNodePositionData[c.getId()].segment.docker1=this.dockers[i-1];this.attachedNodePositionData[c.getId()].segment.docker2=this.dockers[i];}}if(a||a==0){this.attachedNodePositionData[c.getId()].relativDistanceFromDocker1=this.getLineParameterForPosition(this.attachedNodePositionData[c.getId()].segment.docker1,this.attachedNodePositionData[c.getId()].segment.docker2,c);}},findSegment:function(c){var b=this.dockers.length;var a;var d=c instanceof ORYX.Core.UIObject?c.bounds.center():c;for(i=1;i<b;i++){var g=this.dockers[i-1].bounds.center();var e=this.dockers[i].bounds.center();var f=ORYX.Core.Math.distancePointLinie(g,e,d,true);if(typeof f=="number"&&(a===undefined||f<a.distance)){a={distance:f,fromDocker:this.dockers[i-1],toDocker:this.dockers[i]};}}return a;},getLineParameterForPosition:function(b,g,d){var f=b.bounds.center();var e=g.bounds.center();this.relativizePoint(f);this.relativizePoint(e);var c=ORYX.Core.Math.getPointOfIntersectionPointLine(f,e,d.bounds.center(),true);if(!c){return 0;}var a=ORYX.Core.Math.getDistancePointToPoint(c,f)/ORYX.Core.Math.getDistancePointToPoint(f,e);return a;},relativizePoint:function(a){a.x-=this.bounds.upperLeft().x;a.y-=this.bounds.upperLeft().y;},optimizedUpdate:function(){var a=function(b){if(!b._dockedShape||!b._dockedShapeBounds){return;}var c={x:b._dockedShape.bounds.a.x-b._dockedShapeBounds.a.x,y:b._dockedShape.bounds.a.y-b._dockedShapeBounds.a.y};b.bounds.moveBy(c);b._dockedShapeBounds.moveBy(c);};a(this.dockers.first());a(this.dockers.last());this.refresh();},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);this._paths.each((function(k,f){var h=undefined;var e=this._dockersByPath.values()[0];var n=undefined;var l=undefined;if(h){l="M"+h.x+" "+h.y;}else{n=e[0].bounds.center();h=n;l="M"+n.x+" "+n.y;}for(var g=1;g<e.length;g++){n=e[g].bounds.center();l=l+"L"+n.x+" "+n.y+" ";h=n;}k.setAttributeNS(null,"d",l);this._interactionPaths[f].setAttributeNS(null,"d",l);var m=this._shadowPaths[f];if(m){m.setAttributeNS(null,"d",l);}if(Ext.isIE10||Ext.isIE11){k.parentNode.insertBefore(k,k);if(m){m.parentNode.insertBefore(m,m);}}}).bind(this));if(this.getChildNodes().length>0){var a=this.bounds.upperLeft().x;var b=this.bounds.upperLeft().y;this.node.firstChild.childNodes[1].setAttributeNS(null,"transform","translate("+a+", "+b+")");}},getIntersectionPoint:function(){var a=Math.floor(this.dockers.length/2);return ORYX.Core.Math.midPoint(this.dockers[a-1].bounds.center(),this.dockers[a].bounds.center());},isBoundsIncluded:function(c){var a=this.dockers,b=a.length;return a.any(function(g,f){if(f==b-1){return false;}var e=g.bounds.center();var d=a[f+1].bounds.center();return ORYX.Core.Math.isRectOverLine(e.x,e.y,d.x,d.y,c.a.x,c.a.y,c.b.x,c.b.y);});},isPointIncluded:function(g,f){var a=this.absoluteBounds().isIncluded(g,f,ORYX.CONFIG.OFFSET_EDGE_BOUNDS);var e=undefined;if(a&&this.dockers.length>0){var c=0;var d,b;do{d=this.dockers[c].bounds.center();b=this.dockers[++c].bounds.center();e=ORYX.Core.Math.isPointInLine(g,f,d.x,d.y,b.x,b.y,ORYX.CONFIG.OFFSET_EDGE_BOUNDS);}while(!e&&c<this.dockers.length-1);}return e;},isPointOverOffset:function(){return false;},containsNode:function(a){if(this._paths.include(a)||this._interactionPaths.include(a)||this._shadowPaths.include(a)){return true;}return false;},_getAngle:function(a,d){var c=a instanceof ORYX.Core.Controls.Docker?a.absoluteCenterXY():a;var b=d instanceof ORYX.Core.Controls.Docker?d.absoluteCenterXY():d;return ORYX.Core.Math.getAngle(c,b);},alignDockers:function(){this._update(true);var e=this.dockers.first().bounds.center();var d=this.dockers.last().bounds.center();var c=d.x-e.x;var a=d.y-e.y;var b=this.dockers.length-1;this.dockers.each((function(h,g){var f=g/b;h.bounds.unregisterCallback(this._dockerChangedCallback);h.bounds.moveTo(e.x+f*c,e.y+f*a);h.bounds.registerCallback(this._dockerChangedCallback);}).bind(this));this._dockerChanged();},add:function(a){arguments.callee.$.add.apply(this,arguments);if(a instanceof ORYX.Core.Controls.Docker&&this.dockers.include(a)){var b=this._dockersByPath.values()[0];if(b){b.splice(this.dockers.indexOf(a),0,a);}this.handleChildShapesAfterAddDocker(a);}},handleChildShapesAfterAddDocker:function(f){if(!f instanceof ORYX.Core.Controls.Docker){return undefined;}var d=this.dockers.indexOf(f);if(!(0<d&&d<this.dockers.length-1)){return undefined;}var e=this.dockers[d-1];var b=this.dockers[d+1];var c=this.getAttachedNodePositionDataForSegment(e,b);var a=ORYX.Core.Math.getDistancePointToPoint(e.bounds.center(),f.bounds.center());var h=ORYX.Core.Math.getDistancePointToPoint(b.bounds.center(),f.bounds.center());if(!(a+h)){return;}var g=a/(a+h);c.each(function(m){if(m.value.relativDistanceFromDocker1<g){m.value.segment.docker2=f;m.value.relativDistanceFromDocker1=m.value.relativDistanceFromDocker1/g;}else{m.value.segment.docker1=f;var l=1-g;var k=m.value.relativDistanceFromDocker1-g;m.value.relativDistanceFromDocker1=k/l;}});this.getLabels().each(function(m){var o=m.getReferencePoint();if(!o||!o.intersection){return;}var l=this.dockers.indexOf(f);if(l>=o.segment.fromIndex&&l<=o.segment.toIndex){var n=this.findSegment(o.intersection);if(!n){n.fromDocker=o.segment.fromIndex>=(this.dockers.length/2)?this.dockers[0]:this.dockers[this.dockers.length-2];n.toDocker=this.dockers[this.dockers.indexOf(from)+1];}var k=n.fromDocker.bounds.center(),p=n.toDocker.bounds.center();var q=ORYX.Core.Math.getPointOfIntersectionPointLine(k,p,o.intersection,true);this.updateReferencePointOfLabel(m,q,n.fromDocker,n.toDocker,true);}}.bind(this));this.refreshAttachedNodes();},getAttachedNodePositionDataForSegment:function(c,a){if(!((c instanceof ORYX.Core.Controls.Docker)&&(a instanceof ORYX.Core.Controls.Docker))){return[];}var b=this.attachedNodePositionData.findAll(function(d){return d.value.segment.docker1===c&&d.value.segment.docker2===a;});if(!b){return[];}return b;},remove:function(a){arguments.callee.$.remove.apply(this,arguments);if(this.attachedNodePositionData[a.getId()]){delete this.attachedNodePositionData[a.getId()];}if(a instanceof ORYX.Core.Controls.Docker){var b=this._dockersByPath[this._paths[0].id];if(b&&b.include(a)){this._dockersByPath[this._paths[0].id]=b.without(a);}this.handleChildShapesAfterRemoveDocker(a);}},updateReferencePointOfLabel:function(a,g,f,e,b){if(!a.getReferencePoint()||!a.isVisible||!g){return;}var c=a.getReferencePoint();if(c.orientation&&c.orientation!=="ce"){var d=this._getAngle(f,e);if(c.distance>=0){if(d==0){a.horizontalAlign("left");a.verticalAlign("bottom");}else{if(d>0&&d<90){a.horizontalAlign("right");a.verticalAlign("bottom");}else{if(d==90){a.horizontalAlign("right");a.verticalAlign("top");}else{if(d>90&&d<180){a.horizontalAlign("right");a.verticalAlign("top");}else{if(d==180){a.horizontalAlign("left");a.verticalAlign("top");}else{if(d>180&&d<270){a.horizontalAlign("left");a.verticalAlign("top");}else{if(d==270){a.horizontalAlign("left");a.verticalAlign("top");}else{if(d>270&&d<=360){a.horizontalAlign("left");a.verticalAlign("bottom");}}}}}}}}}else{if(d==0){a.horizontalAlign("left");a.verticalAlign("top");}else{if(d>0&&d<90){a.horizontalAlign("left");a.verticalAlign("top");}else{if(d==90){a.horizontalAlign("left");a.verticalAlign("top");}else{if(d>90&&d<180){a.horizontalAlign("left");a.verticalAlign("bottom");}else{if(d==180){a.horizontalAlign("left");a.verticalAlign("bottom");}else{if(d>180&&d<270){a.horizontalAlign("right");a.verticalAlign("bottom");}else{if(d==270){a.horizontalAlign("right");a.verticalAlign("top");}else{if(d>270&&d<=360){a.horizontalAlign("right");a.verticalAlign("top");}}}}}}}}}c.iorientation=c.iorientation||c.orientation;c.orientation=(a.verticalAlign()=="top"?"u":"l")+(a.horizontalAlign()=="left"?"l":"r");}a.setReferencePoint(Ext.apply({},{intersection:g,segment:{from:f,fromIndex:this.dockers.indexOf(f),fromPosition:f.bounds.center(),to:e,toIndex:this.dockers.indexOf(e),toPosition:e.bounds.center()},dirty:b||false},c));},handleChildShapesAfterRemoveDocker:function(a){if(!(a instanceof ORYX.Core.Controls.Docker)){return;}this.attachedNodePositionData.each(function(c){if(c.value.segment.docker1===a){var b=this.dockers.indexOf(c.value.segment.docker2);if(b==-1){return;}c.value.segment.docker1=this.dockers[b-1];}else{if(c.value.segment.docker2===a){var b=this.dockers.indexOf(c.value.segment.docker1);if(b==-1){return;}c.value.segment.docker2=this.dockers[b+1];}}}.bind(this));this.getLabels().each(function(b){var d=b.getReferencePoint();if(!d||!d.intersection){return;}var g=d.segment.from;var f=d.segment.to;if(g!==a&&f!==a){return;}var c=this.findSegment(d.intersection);if(c){g=c.fromDocker;f=c.toDocker;}else{g=g===a?this.dockers[this.dockers.indexOf(f)-1]:g;f=this.dockers[this.dockers.indexOf(g)+1];}var e=ORYX.Core.Math.getPointOfIntersectionPointLine(g.bounds.center(),f.bounds.center(),d.intersection,true);this.updateReferencePointOfLabel(b,e,g,f,true);}.bind(this));this.refreshAttachedNodes();},addDocker:function(b,d){var c;var a;this._dockersByPath.any((function(e){return e.value.any((function(k,f){if(!c){c=k;return false;}else{var h=c.bounds.center();var g=k.bounds.center();if(ORYX.Core.Math.isPointInLine(b.x,b.y,h.x,h.y,g.x,g.y,10)){var m=this._paths.find(function(o){return o.id===e.key;});if(m){var n=m.getAttributeNS(NAMESPACE_ORYX,"allowDockers");if(n&&n.toLowerCase()==="no"){return true;}}var l=(d)?d:this.createDocker(this.dockers.indexOf(c)+1,b);l.bounds.centerMoveTo(b);if(d){this.add(l,this.dockers.indexOf(c)+1);}a=l;return true;}else{c=k;return false;}}}).bind(this));}).bind(this));return a;},removeDocker:function(a){if(this.dockers.length>2&&!(this.dockers.first()===a)){this._dockersByPath.any((function(b){if(b.value.member(a)){if(a===b.value.last()){return true;}else{this.remove(a);this._dockersByPath[b.key]=b.value.without(a);this.isChanged=true;this._dockerChanged();return true;}}return false;}).bind(this));}},removeUnusedDockers:function(){var a=$H({});this.dockers.each(function(e,b){if(b==0||b==this.dockers.length-1){return;}var d=this.dockers[b-1];if(a.values().indexOf(d)!=-1&&this.dockers[b-2]){d=this.dockers[b-2];}var c=this.dockers[b+1];var f=d.getDockedShape()&&d.referencePoint?d.getAbsoluteReferencePoint():d.bounds.center();var h=c.getDockedShape()&&c.referencePoint?c.getAbsoluteReferencePoint():c.bounds.center();var g=e.bounds.center();if(ORYX.Core.Math.distancePointLinie(f,h,g,false)<=1){a[b]=e;}}.bind(this));a.each(function(b){this.remove(b.value);}.bind(this));if(a.values().length>0){this._update(true);}return a;},_init:function(h){arguments.callee.$._init.apply(this,arguments);var f,c,t,r;var d=ORYX.Utils.buildIsRichtextForLabel(this.getStencil());var l=h.getElementsByTagNameNS(NAMESPACE_SVG,"defs");if(l.length>0){l=l[0];var e=$A(l.getElementsByTagNameNS(NAMESPACE_SVG,"marker"));var m;var p=this;e.each(function(u){try{m=new ORYX.Core.SVG.SVGMarker(u.cloneNode(true));p._markers[m.id]=m;var v=$A(m.element.getElementsByTagNameNS(NAMESPACE_SVG,"text"));var g;v.each(function(y){g=new ORYX.Core.SVG.Label({textElement:y,shapeId:this.id,richtext:d(textElem)});p._labels[g.id]=g;});}catch(x){}});}var b=h.getElementsByTagNameNS(NAMESPACE_SVG,"g");if(b.length<=0){throw"Edge: No g element found.";}var n=b[0];n.setAttributeNS(null,"id",null);var k=true;$A(n.childNodes).each((function(J,D){if(ORYX.Editor.checkClassType(J,SVGPathElement)){J=J.cloneNode(false);if(Ext.isIE9){J.setAttributeNS(null,"opacity",Signavio.CONFIG.IE9_PATH_OPACITY_FIX_VALUE);}var g=J.getAttributeNS(null,"id")||"";var C=(g)?g:this.id+"_"+D;J.setAttributeNS(null,"id",C);this._paths.push(J);var F=[];var K=J.getAttributeNS(null,"marker-start");if(K&&K!==""){K=K.strip();K=K.replace(/^url\(.*#(.*?)["'\)].*/,"$1");var B=this.id.concat(K);J.setAttributeNS(null,"marker-start","url(#"+B+")");F.push(this._markers[B]);}K=J.getAttributeNS(null,"marker-mid");if(K&&K!==""){K=K.strip();K=K.replace(/^url\(.*#(.*?)["'\)].*/,"$1");var v=this.id.concat(K);J.setAttributeNS(null,"marker-mid","url(#"+v+")");F.push(this._markers[v]);}K=J.getAttributeNS(null,"marker-end");if(K&&K!==""){K=K.strip();K=K.replace(/^url\(.*#(.*?)["'\)].*/,"$1");var E=this.id.concat(K);J.setAttributeNS(null,"marker-end","url(#"+E+")");F.push(this._markers[E]);}this._markersByPath[C]=F;var u=new PathParser();var I=new ORYX.Core.SVG.PointsPathHandler();u.setHandler(I);u.parsePath(J);if(I.points.length<4){throw"Edge: Path has to have two or more points specified.";}this._dockersByPath[C]=[];for(var A=0;A<I.points.length;A+=2){var H=I.points[A];var G=I.points[A+1];if(k){var z=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});z.bounds.centerMoveTo(H,G);z.bounds.registerCallback(this._dockerChangedCallback);this.add(z,this.dockers.length);if(f){f=Math.min(H,f);c=Math.min(G,c);}else{f=H;c=G;}if(t){t=Math.max(H,t);r=Math.max(G,r);}else{t=H;r=G;}}}k=false;}}).bind(this));this.bounds.set(f,c,t,r);if(false&&(this.bounds.width()===0||this.bounds.height()===0)){var a=this.bounds.width();var q=this.bounds.height();this.bounds.extend({x:a===0?2:0,y:q===0?2:0});this.bounds.moveBy({x:a===0?-1:0,y:q===0?-1:0});}this._oldBounds=this.bounds.clone();this._paths.reverse();var s=[];this._paths.each((function(g){s.push(this.node.childNodes[0].childNodes[0].childNodes[0].appendChild(g));}).bind(this));this._paths=s;this._paths.each((function(v){var g=this.node.childNodes[0].childNodes[0].childNodes[0];if(ORYX.CONFIG.EDGE_SHADOWS_ENABLED&&!v.getAttributeNS(null,"stroke-dasharray")){var x=this._buildShadowPathForPath(v,h,l);this._shadowPaths.push(g.insertBefore(x,g.firstChild));}var u=this._buildInteractionPathForPath(v,h);this._interactionPaths.push(g.appendChild(u));}).bind(this));this._paths.reverse();this._interactionPaths.reverse();this._shadowPaths.reverse();var o=h.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"text");$A(o).each((function(u){var g=new ORYX.Core.SVG.Label({textElement:u,shapeId:this.id,richtext:d(u)});this.node.childNodes[0].childNodes[0].appendChild(g.node);this._labels[g.id]=g;g.registerOnChange(this.layout.bind(this));}).bind(this));this.propertiesChanged.each(function(g){g.value=true;});},_buildShadowPathForPath:function(l,c,e){var b=l.cloneNode(false);var g=b.getAttributeNS(null,"id")||"";b.setAttributeNS(null,"id",(g+Signavio.CONFIG.SVG_SHADOW_ID_SUFFIX));b.setAttributeNS(null,"stroke-width",5);b.setAttributeNS(null,"stroke-opacity",0.7);b.setAttributeNS(null,"stroke-linecap","butt");b.setAttributeNS(null,"stroke","white");var h=l.getAttributeNS(null,"id");var f=l.getAttributeNS(null,"marker-start");var a=l.getAttributeNS(null,"marker-mid");var k=l.getAttributeNS(null,"marker-end");var d=this._markersByPath[h];if(d){d.each(function(o){if(o&&o.element&&o.element.childNodes){var n=o.element.childNodes;var r;var m=o.element.cloneNode(false);m.setAttributeNS(null,"id",o.id+Signavio.CONFIG.SVG_SHADOW_ID_SUFFIX);if(f&&f.indexOf(o.id)>=0){b.setAttributeNS(null,"marker-start","url(#"+o.id+Signavio.CONFIG.SVG_SHADOW_ID_SUFFIX+")");}else{if(a&&a.indexOf(o.id)>=0){b.setAttributeNS(null,"marker-mid","url(#"+o.id+Signavio.CONFIG.SVG_SHADOW_ID_SUFFIX+")");}else{if(k&&k.indexOf(o.id)>=0){b.setAttributeNS(null,"marker-end","url(#"+o.id+Signavio.CONFIG.SVG_SHADOW_ID_SUFFIX+")");}}}for(r=0;r<n.length;r++){var q=n[r];if(q.nodeType!==q.ELEMENT_NODE){continue;}var p=q.getAttributeNS(null,"id");var s=q.cloneNode(false);s.setAttributeNS(null,"id",(p+Signavio.CONFIG.SVG_SHADOW_ID_SUFFIX));s.setAttributeNS(null,"stroke-width",5);s.setAttributeNS(null,"stroke-opacity",0.7);s.setAttributeNS(null,"stroke-linecap","butt");s.setAttributeNS(null,"stroke","white");m.appendChild(s);e.appendChild(m);var o=new ORYX.Core.SVG.SVGMarker(m.cloneNode(true));this._markers[o.id]=o;}}}.bind(this));}return b;},_buildInteractionPathForPath:function(d,a){var c=d.cloneNode(false);c.setAttributeNS(null,"id",(c.getAttributeNS(null,"id")||"")+"_z");c.setAttributeNS(null,"stroke-width",ORYX.CONFIG.OFFSET_EDGE_BOUNDS*2);c.setAttributeNS(null,"visibility","hidden");c.setAttributeNS(null,"stroke-dasharray",null);c.setAttributeNS(null,"stroke","black");c.setAttributeNS(null,"fill","none");c.setAttributeNS(null,"title",this.getStencil().title());var b=a.ownerDocument.createElementNS(ORYX.CONFIG.NAMESPACE_SVG,"title");b.textContent=this.getStencil().title();c.appendChild(b);return c;},addMarkers:function(a){this._markers.each(function(b){if(!a.ownerDocument.getElementById(b.value.id)){b.value.element=a.appendChild(b.value.element);}});},removeMarkers:function(){var b=this.node.ownerSVGElement;if(b){var a=b.getElementsByTagNameNS(NAMESPACE_SVG,"defs");if(a.length>0){a=a[0];this._markers.each(function(c){var d=a.ownerDocument.getElementById(c.value.id);if(d){c.value.element=a.removeChild(c.value.element);}});}}},_dockerChanged:function(){this._dockerUpdated=true;},serialize:function(){var a=arguments.callee.$.serialize.apply(this);var d="";this._dockersByPath.each((function(e){e.value.each(function(k){var h=k.getDockedShape()&&k.referencePoint?k.referencePoint:k.bounds.center();d=d.concat(h.x+" "+h.y+" ");});d+=" # ";}).bind(this));a.push({name:"dockers",prefix:"oryx",value:d,type:"literal"});var b=this.dockers.last();var g=b.getDockedShape();if(g){a.push({name:"target",prefix:"raziel",value:"#"+ERDF.__stripHashes(g.resourceId),type:"resource"});}try{var c=this.getStencil().serialize();if(c.type){c.shape=this;c.data=a;c.result=undefined;c.forceExecution=true;this._delegateEvent(c);if(c.result){a=c.result;}}}catch(f){}return a;},deserialize:function(f){try{var c=this.getStencil().deserialize();if(c.type){c.shape=this;c.data=f;c.result=undefined;c.forceExecution=true;this._delegateEvent(c);if(c.result){f=c.result;}}}catch(h){}var g=f.find(function(e){return(e.prefix+"-"+e.name)=="raziel-target";});var a;if(g){a=this.getCanvas().getChildShapeByResourceId(g.value);}var d=f.findAll(function(e){return(e.prefix+"-"+e.name)=="raziel-outgoing";});d.each((function(l){if(!this.parent){return;}var e=this.getCanvas().getChildShapeByResourceId(l.value);if(e){if(e==a){this.dockers.last().setDockedShape(e);this.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});}else{if(e instanceof ORYX.Core.Edge){e.dockers.first().setDockedShape(this);}}}}).bind(this));var b=f.find(function(e){return(e.prefix==="oryx"&&e.name==="dockers");});if(b){var k=b.value.split("#").without("").without(" ");k.each((function(l,o){var r=l.replace(/,/g," ").split(" ").without("");if(r.length%2===0){var s=this._paths[o];if(s){if(o===0){while(this._dockersByPath[s.id].length>2){this.removeDocker(this._dockersByPath[s.id][1]);}}else{while(this._dockersByPath[s.id].length>1){this.removeDocker(this._dockersByPath[s.id][0]);}}var e=this._dockersByPath[s.id];if(o===0){var q=parseFloat(r.shift());var p=parseFloat(r.shift());q=q||q===0?q:10;p=p||p===0?p:10;if(e.first().getDockedShape()){e.first().setReferencePoint({x:q,y:p});}else{e.first().bounds.centerMoveTo(q,p);}}p=parseFloat(r.pop());q=parseFloat(r.pop());q=q||q===0?q:10;p=p||p===0?p:10;if(e.last().getDockedShape()){e.last().setReferencePoint({x:q,y:p});}else{e.last().bounds.centerMoveTo(q,p);}for(var m=0;m<r.length;m++){q=parseFloat(r[m]);p=parseFloat(r[++m]);var n=this.createDocker();n.bounds.centerMoveTo(q,p);}}}}).bind(this));}else{this.alignDockers();}arguments.callee.$.deserialize.apply(this,arguments);this._changed();},toString:function(){return this.getStencil().title()+" "+this.id;},getTarget:function(){return this.dockers.last()?this.dockers.last().getDockedShape():null;},getSource:function(){return this.dockers.first()?this.dockers.first().getDockedShape():null;},isDocked:function(){var a=false;this.dockers.each(function(b){if(b.isDocked()){a=true;throw $break;}});return a;},toJSON:function(){var a=arguments.callee.$.toJSON.apply(this,arguments);if(this.getTarget()){a.target={resourceId:this.getTarget().resourceId};}return a;}};ORYX.Core.Edge=ORYX.Core.Shape.extend(ORYX.Core.Edge);if("undefined"==typeof ORYX){var ORYX={};}if("undefined"==typeof ORYX.Plugins){ORYX.Plugins={};}new function(){ORYX.Plugins.AbstractPlugin=Clazz.extend({facade:null,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.onLoaded.bind(this));},onLoaded:function(){},onSelectionChanged:function(){},showOverlay:function(a,b,d,c){if(!(a instanceof Array)){a=[a];}a=a.map(function(e){var f=e;if(typeof e=="string"){f=this.facade.getCanvas().getChildShapeByResourceId(e);f=f||this.facade.getCanvas().getChildById(e,true);}return f;}.bind(this)).compact();if(!this.overlayID){this.overlayID=this.type+ORYX.Editor.provideId();}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:this.overlayID,shapes:a,attributes:b,node:d,nodePosition:c||"NW"});},hideOverlay:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:this.overlayID});},doTransform:function(d,a){if(!a||!d){return"";}var c=new DOMParser();var k=c.parseFromString(d,"text/xml");source=a;new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(m){xsl=m.responseText;}.bind(this),onFailure:(function(m){ORYX.Log.error("XSL load failed"+m);}).bind(this)});var f=new XSLTProcessor();var h=new DOMParser();var e=h.parseFromString(xsl,"text/xml");f.importStylesheet(e);try{var l=f.transformToFragment(k,document);var b=(new XMLSerializer()).serializeToString(l);b=!b.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+b:b;return b;}catch(g){return -1;}},openXMLWindow:function(a){var b=window.open("data:application/xml,"+encodeURIComponent(a),"_blank","resizable=yes,width=600,height=600,toolbar=0,scrollbars=yes");},openDownloadWindow:function(b,c){var d=window.open("");if(d!=null){d.document.open();d.document.write("<html><body>");var a=d.document.createElement("form");d.document.body.appendChild(a);var e=function(f,g){var h=document.createElement("input");h.name=f;h.type="hidden";h.value=g;return h;};a.appendChild(e("download",c));a.appendChild(e("file",b));$H(Ext.Ajax.getSecurityParameter()).each(function(f){if(f.value instanceof Array){f.value.each(function(g){a.appendChild(e(f.key,g));});}else{a.appendChild(e(f.key,f.value));}});a.method="POST";d.document.write("</body></html>");d.document.close();a.action=ORYX.CONFIG.SERVER_DOWNLOAD_HANDLER;a.submit();}},getSerializedDOM:function(){var a=DataManager.serializeDOM(this.facade);a='<?xml version="1.0" encoding="utf-8"?>'+'<html xmlns="http://www.w3.org/1999/xhtml" '+'xmlns:b3mn="http://b3mn.org/2007/b3mn" '+'xmlns:ext="http://b3mn.org/2007/ext" '+'xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" '+'xmlns:atom="http://b3mn.org/2007/atom+xhtml">'+'<head profile="http://purl.org/NET/erdf/profile">'+'<link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" />'+'<link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " />'+'<link rel="schema.b3mn" href="http://b3mn.org" />'+'<link rel="schema.oryx" href="http://oryx-editor.org/" />'+'<link rel="schema.raziel" href="http://raziel.org/" />'+'<base href="'+location.href.split("?")[0]+'" />'+"</head><body>"+a+"</body></html>";return a;},enableReadOnlyMode:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);this._stopSelectionChange=function(){if(this.facade.getSelection().length>0){this.facade.setSelection([]);}};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this._stopSelectionChange.bind(this));},disableReadOnlyMode:function(){this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);if(this._stopSelectionChange){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this._stopSelectionChange.bind(this));this._stopSelectionChange=undefined;}},getRDFFromDOM:function(){try{var c="";source=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(e){c=e.responseText;}.bind(this),onFailure:(function(e){ORYX.Log.error("XSL load failed"+e);}).bind(this)});var k=new DOMParser();var h=k.parseFromString(this.getSerializedDOM(),"text/xml");var f=k.parseFromString(c,"text/xml");var b=new XSLTProcessor();b.importStylesheet(f);var a=b.transformToFragment(h,document);var d=new XMLSerializer();return d.serializeToString(a);}catch(g){Ext.Msg.alert("Oryx",error);return"";}},isStencilSetExtensionLoaded:function(a){return this.facade.getStencilSets().values().any(function(b){return b.extensions().keys().any(function(c){return c==a;}.bind(this));}.bind(this));},doLayout:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LAYOUT,shapes:a});},layoutEdges:function(b,a,d){if(!this.facade.isExecutingCommands()||a.length===0){return;}var c=ORYX.Core.Command.extend({smallShapeSize:200,allInside:[],positionChanged:false,oldOrder:{},removedDockers:[],construct:function(f,k,l,h){this.edges=f;this.node=k;this.plugin=h;this.offset=l;var e=k.absoluteXY();this.ulo={x:e.x-l.x,y:e.y-l.y};this.nodeBounds=this.node.absoluteBounds();this.oldBounds=this.nodeBounds.clone();var g={x:(this.nodeBounds.upperLeft().x)-this.offset.x,y:(this.nodeBounds.upperLeft().y)-this.offset.y};this.oldBounds.set(g,{x:g.x+(this.nodeBounds.width()/(this.offset.xs||1)),y:g.y+(this.nodeBounds.height()/(this.offset.ys||1))});},execute:function(){if(this.changes){this.executeAgain();return;}else{this.changes=[];this.edges.each(function(k){this.changes.push({edge:k,oldDockerPositions:k.dockers.map(function(l){return l.isDocked()?l.referencePoint:l.bounds.center();})});}.bind(this));}this.edges.each(function(k){if(k.getStencil().keepState()){this.prepareEdgeForLayout(k);}}.bind(this));this.edges.each(function(o,k){if(o.getStencil().keepState()==false){if(this.offset.xs||this.offset.ys){this.plugin.doLayout(o);return;}else{this.layoutOldStyle(o);return;}}var x=false;var r=this.getDataObject(o,k);if(!r){return;}var t=12;var u=this.nodeBounds.getSide(r.foreignBounds.center())!==r.side;var l=this.wasAligned(r.first,r.second);if(r.overlap&&!u&&r.overlap.width()>t&&o.dockers.length<=3&&(this.allInside[r.newSide]===false||!this.allEdgesInside(this.node,(this.isSmallShapeInvolved(r)?this.nodeBounds:this.oldBounds),this.getRelevantEdges(this.node,this.oldBounds,r.side,r.edge),r.side))){this.moveToOverlap(r,o.dockers.length,true,true,l);}else{if(o.dockers.length===2){if(this.isSmallShapeInvolved(r)&&r.overlap&&r.overlap.width()>t){this.moveToOverlap(r,o.dockers.length,true);}else{x=this.moveEdge(r,o.dockers.length);}}else{if(o.dockers.length===3){if(r.overlap&&!u&&r.overlap.width()>t&&this.isInsideOverlap(r)){this.removedDockers=this.removedDockers.concat(this.removeAllDocker(o));if(this.isSmallShapeInvolved(r)){this.moveToOverlap(r,o.dockers.length,true);}else{x=this.moveEdge(r,o.dockers.length);}}else{var n=this.layoutOldStyle(o,r);if(n){r=n;r.edge._update(true);}if(this.isBendPointIncluded(o)){var q=this.removeAllDocker(o);this.removedDockers=this.removedDockers.concat(q);if(q.length==1){var p=q.first();var z=o.dockers.first().getDockedShape().absoluteBounds();if(o.dockers.first().getDockedShape()&&z.isIncluded(p.bounds.center())){var y=p.bounds.clone();y.moveBy(-z.a.x,-z.a.y);o.dockers.first().setReferencePoint(y.center());}else{if(o.dockers.last().getDockedShape()){var v=o.dockers.last().getDockedShape().absoluteBounds();var y=p.bounds.clone();y.moveBy(-v.a.x,-v.a.y);o.dockers.last().setReferencePoint(y.center());}}}}if(!this.isAligned(r.first,r.second)&&l){x=this.moveEdge(r,o.dockers.length);}}}else{if(o.dockers.length>3){this.layoutOldStyle(o,r);}}}}o._update(true);o.removeUnusedDockers();var s=r.first;var m=r.edge.dockers[(s===r.edge.dockers[0]?1:r.edge.dockers.length-2)];if(this.isBendPointIncluded(o)||x===true||(!this.isAligned(s,m)&&l)){this.plugin.doLayout(o);return;}}.bind(this));var f=12;var g=this.getSidesToManage(f);var h;var e;g.each(function(l){h=[];var k=this.edges.findAll(function(m){var n=(m.dockers[0].getDockedShape()===this.node?m.dockers[0]:m.dockers[m.dockers.length-1]);return this.node.absoluteBounds().getSide(n.bounds.center())===l;}.bind(this));k.each(function(m,o){var n=this.getDataObject(m,o);if(n&&n.overlap&&(["top","bottom"].include(l)&&n.overlap.width()||["left","right"].include(l)&&n.overlap.height())<f*(k.length+1)){if(!h.include(m)){h.push(m);}}}.bind(this));if(h.length>0){this.handleSmallOverlap(h,f);}else{this.redistributeEdges(l,f);}}.bind(this));this.edges.each(function(l,k){this.changes[k].dockerPositions=l.dockers.map(function(m){return m.isDocked()?m.referencePoint:m.bounds.center();});}.bind(this));},getSidesToManage:function(f){var e=[];var g=[];this.edges.each(function(h){e.push(h.dockers[0].getDockedShape()===this.node?h.dockers[0]:h.dockers[h.dockers.length-1]);}.bind(this));e.each(function(k){var h=this.nodeBounds.getSide(k.bounds.center());if(k.parent.getStencil().keepState()&&(["top","bottom"].include(h)&&(Math.abs(k.bounds.center().x-this.nodeBounds.upperLeft().x)<f||Math.abs(k.bounds.center().x-this.nodeBounds.lowerRight().x)<f)||["left","right"].include(h)&&(Math.abs(k.bounds.center().y-this.nodeBounds.upperLeft().y)<f||Math.abs(k.bounds.center().y-this.nodeBounds.lowerRight().y)<f))&&!g.include(h)){g.push(h);}else{e.each(function(l){if(l!==k&&l.parent.getStencil().keepState()&&(((["top","bottom"].include(h)&&this.nodeBounds.width()<this.smallShapeSize||["left","right"].include(h)&&this.nodeBounds.height()<this.smallShapeSize)&&this.nodeBounds.getSide(l.bounds.center())===h)||(Math.abs(l.bounds.center().x-k.bounds.center().x)<f&&Math.abs(l.bounds.center().y-k.bounds.center().y)<f))&&!g.include(h)){g.push(h);}}.bind(this));}}.bind(this));return g;},handleSmallOverlap:function(o,l){var f=o.length;if(f===1){this.plugin.doLayout(o[0]);}else{var h=this.getDataObject(o[0],0);if(!h){return;}o=this.getRelevantEdges(h.node,this.nodeBounds,h.newSide,o[0],true);var s=o.first();var t=o.last();var r=["top","bottom"].include(h.newSide)?this.nodeBounds.center().x<h.foreignBounds.center().x?h.node:h.foreignNode:this.nodeBounds.center().y<h.foreignBounds.center().y?h.node:h.foreignNode;var g=(r===h.node?h.foreignNode:h.node);var m=s.dockers[0].getDockedShape()===r?s.dockers.first():s.dockers.last();var e=t.dockers[0].getDockedShape()===g?t.dockers.first():t.dockers.last();var q=this.xOverlap(h);var p=this.yOverlap(h);var k=m.referencePoint;m.setReferencePoint({x:q>0?(k.x-l*3):m.referencePoint.x,y:p>0?(k.y-l*3):m.referencePoint.y});var n=e.referencePoint;e.setReferencePoint({x:q>0?(n.x+l*3):e.referencePoint.x,y:p>0?(n.y+l*3):e.referencePoint.y});s.addDocker(s.bounds.center());t.addDocker(t.bounds.center());s.dockers[1].bounds.centerMoveTo({x:s.dockers[0].getAbsoluteReferencePoint().x,y:(s.dockers[2].isDocked()?s.dockers[2].getAbsoluteReferencePoint().y:s.dockers[2].bounds.center().y)});if(r.absoluteBounds().isIncluded(s.dockers[1].bounds.center())){s.dockers[1].bounds.centerMoveTo({x:(s.dockers[2].isDocked()?s.dockers[2].getAbsoluteReferencePoint().x:s.dockers[2].bounds.center().x),y:s.dockers[0].getAbsoluteReferencePoint().y});}t.dockers[1].bounds.centerMoveTo({x:(t.dockers[2].isDocked()?t.dockers[2].getAbsoluteReferencePoint().x:t.dockers[2].bounds.center().x),y:t.dockers[0].getAbsoluteReferencePoint().y});if(g.absoluteBounds().isIncluded(t.dockers[1].bounds.center())){t.dockers[1].bounds.centerMoveTo({x:t.dockers[0].getAbsoluteReferencePoint().x,y:(t.dockers[2].isDocked()?t.dockers[2].getAbsoluteReferencePoint().y:t.dockers[2].bounds.center().y)});}}},prepareEdgeForLayout:function(o){var p,D,q,r;var g;var k=o.dockers.length;if(o.dockers[0].getDockedShape()===this.node){p=o.dockers[0];D=o.dockers[1];q=o.dockers[k-1];}else{if(o.dockers[k-1].getDockedShape()===this.node){p=o.dockers[k-1];D=o.dockers[k-2];q=o.dockers[0];}}var r=q.getDockedShape();if(!r||this.node===r){return;}var B=r.absoluteBounds();if(o.dockers.all(function(F){return this.nodeBounds.isIncluded(F.bounds.center())||B.isIncluded(F.bounds.center());}.bind(this))){return;}if(this.offset.xs||this.offset.ys){var n=p.referencePoint;var E=p.getAbsoluteReferencePoint();p.setReferencePoint({x:(!(this.offset.xs&&n.x/this.offset.xs>this.nodeBounds.width())?n.x/(this.offset.xs||1):n.x),y:(!(this.offset.ys&&n.y/this.offset.ys>this.nodeBounds.height())?n.y/(this.offset.ys||1):n.y)});D.bounds.centerMoveTo({x:(this.offset.xs&&n.x/this.offset.xs>this.nodeBounds.width()?E.x:D.bounds.center().x),y:(this.offset.ys&&n.y/this.offset.ys>this.nodeBounds.height()?E.y:D.bounds.center().y)});o._update(true);}var f=this.node.getOverlap(r);var y=this.nodeBounds.clone();var s=B.clone();y.widen(1);s.widen(1);if(o.dockers.length===3&&o.dockers.all(function(F){F=F.bounds.center();return(f?f.isIncluded(F):false)||y.isIncluded(F)||s.isIncluded(F);})){g=this.nodeBounds.getSide(q.bounds.center());this.removedDockers=this.getDockersToRemove(o);this.removedDockers.each(function(F){o.remove(F);});if(this.removedDockers.length>0){var z=this.removedDockers.first().bounds.center();p.setReferencePoint({x:z.x-this.nodeBounds.upperLeft().x,y:z.y-this.nodeBounds.upperLeft().y});q.setReferencePoint({x:["top","bottom"].include(g)?p.getAbsoluteReferencePoint().x-B.upperLeft().x:q.referencePoint.x,y:["top","bottom"].include(g)?q.referencePoint.y:p.getAbsoluteReferencePoint().y-B.upperLeft().y});o._update(true);}this.oldOrder[o.id]=this.getRelevantEdges(this.node,this.oldBounds,g,o);if(this.allEdgesInside(this.node,this.nodeBounds,this.oldOrder[o.id],g)){this.allInside[g]=true;}else{this.allInside[g]=false;}return g;}else{this.removedDockers=this.getDockersToRemove(o);this.removedDockers.each(function(F){o.remove(F);});if(this.removedDockers.include(D)){var z=this.removedDockers.first().bounds.center();p.setReferencePoint({x:z.x-this.nodeBounds.upperLeft().x,y:z.y-this.nodeBounds.upperLeft().y});var x=Object.clone(D);D=(o.dockers[0]===p?o.dockers[1]:o.dockers[o.dockers.length-2]);var u=this.nodeBounds.getSide(D.bounds.center());var E=p.getAbsoluteReferencePoint();if(this.wasAligned(p,x)){D.bounds.centerMoveTo({x:(["left","right"].include(u)?D.bounds.center().x:E.x),y:(["left","right"].include(u)?E.y:D.bounds.center().y)});}}if(o.dockers.length>=3){g=this.oldBounds.getSide(D.bounds.center());}else{g=this.nodeBounds.getSide(q.bounds.center());}var C=Math.min(this.nodeBounds.width(),B.width());var A=Math.max(this.nodeBounds.width(),B.width());var m=Math.min(this.nodeBounds.height(),B.height());var l=Math.max(this.nodeBounds.height(),B.height());var e=Math.min(this.nodeBounds.lowerRight().x,B.lowerRight().x)-Math.max(this.nodeBounds.upperLeft().x,B.upperLeft().x);var t=Math.min(this.nodeBounds.lowerRight().y,B.lowerRight().y)-Math.max(this.nodeBounds.upperLeft().y,B.upperLeft().y);this.oldOrder[o.id]=this.getRelevantEdges(this.node,this.oldBounds,g,o);if(this.allEdgesInside(this.node,this.nodeBounds,this.oldOrder[o.id],g)){this.allInside[g]=true;}else{this.allInside[g]=false;}var v=this.oldBounds.getSide(B.center());var h=this.nodeBounds.getSide(B.center());if(v!==h){this.positionChanged=true;}return g;}},align:function(k,f){var h=f.getAbsoluteReferencePoint()||f.bounds.center();var l=k.center().x-h.x;var g=k.center().y-h.y;if(Math.abs(-Math.abs(l)+Math.abs(this.offset.x))<3&&this.offset.xs===undefined){k.moveBy({x:-l,y:0});}if(Math.abs(-Math.abs(g)+Math.abs(this.offset.y))<3&&this.offset.ys===undefined){k.moveBy({y:-g,x:0});}if(this.offset.xs!==undefined||this.offset.ys!==undefined){var e=f.getDockedShape().absoluteXY();l=k.center().x-(e.x+((h.x-e.x)/this.offset.xs));g=k.center().y-(e.y+((h.y-e.y)/this.offset.ys));if(Math.abs(-Math.abs(l)+Math.abs(this.offset.x))<3){k.moveBy({x:-(k.center().x-h.x),y:0});}if(Math.abs(-Math.abs(g)+Math.abs(this.offset.y))<3){k.moveBy({y:-(k.center().y-h.y),x:0});}}},isAligned:function(f,e){return Math.abs(f.bounds.center().x-e.bounds.center().x)<1||Math.abs(f.bounds.center().y-e.bounds.center().y)<1;},wasAligned:function(g,e){var f=g.getAbsoluteReferencePoint();return(Math.abs((f.x-this.offset.x)-e.bounds.center().x)<5||Math.abs((f.y-this.offset.y)-e.bounds.center().y)<5);},containsReference:function(e,g,f){switch(f){case"top":return g.isIncluded({x:e.x,y:g.center().y});case"bottom":return g.isIncluded({x:e.x,y:g.center().y});case"left":return g.isIncluded({x:g.center().x,y:e.y});case"right":return g.isIncluded({x:g.center().x,y:e.y});}},xOverlap:function(e){return Math.min(e.nodeLR.x,e.foreignLR.x)-Math.max(e.nodeUL.x,e.foreignUL.x);},yOverlap:function(e){return Math.min(e.nodeLR.y,e.foreignLR.y)-Math.max(e.nodeUL.y,e.foreignUL.y);},isInsideOverlap:function(e,f){return !f&&e.edge.dockers.all(function(g){g=g.bounds.center();return(e.overlap?e.overlap.isIncluded(g):false)||this.nodeBounds.isIncluded(g)||e.foreignBounds.isIncluded(g);}.bind(this))||f&&e.edge.dockers.length>3&&e.overlap.isIncluded(e.secCenter);},isSmallShapeInvolved:function(e){if(["top","bottom"].include(this.nodeBounds.getSide(e.first))&&(this.nodeBounds.width()<this.smallShapeSize||e.foreignBounds.width()<this.smallShapeSize)||["left","right"].include(this.nodeBounds.getSide(e.first))&&(this.nodeBounds.height()<this.smallShapeSize||e.foreignBounds.height()<this.smallShapeSize)){return true;}else{return false;}},isBendPointIncluded:function(f,e){var g=f.dockers.first().getDockedShape();var h=f.dockers.last().getDockedShape();if(g){g=g.absoluteBounds();if(e){g.widen(5);}}if(h){h=h.absoluteBounds();if(e){h.widen(20);}}return f.dockers.any(function(l,k){var m=l.bounds.center();return k!=0&&k!=f.dockers.length-1&&((g&&g.isIncluded(m))||(h&&h.isIncluded(m)));});},getDockersToRemove:function(f){var g=f.dockers.first().getDockedShape();var h=f.dockers.last().getDockedShape();if(g){g=g.absoluteBounds();g.widen(5);}if(h){h=h.absoluteBounds();}var e=f.dockers.findAll(function(l,k){var m=l.bounds.center();return k!=0&&k!=f.dockers.length-1&&((g&&g.isIncluded(m))||(h&&h.isIncluded(m)));});if(g===this.node){return e;}return e._reverse();},moveEdge:function(k,f){var h=false;if(f===3){var g=this.oldBounds.getSide(k.second.bounds.center());var e=this.nodeBounds.getSide(k.last.bounds.center());}else{var g=this.oldBounds.getSide(k.second.bounds.center());var e=this.nodeBounds.getSide(k.second.bounds.center());}if(f===3&&this.containsReference(k.absLastRef,this.nodeBounds,e)){k.first.setReferencePoint({x:(["top","bottom"].include(e)?(k.absLastRef.x-k.nodeUL.x)/(this.offset.xs||1):k.firstRef.x/(this.offset.xs||1)),y:(["top","bottom"].include(e)?k.firstRef.y/(this.offset.ys||1):(k.absLastRef.y-k.nodeUL.y)/(this.offset.ys||1))});}else{if(g===e){if(this.containsReference((f>3?k.secCenter:k.absLastRef),this.nodeBounds,e)){k.first.setReferencePoint({x:k.firstRef.x/(["top","bottom"].include(k.side)?(this.offset.xs||1):1)-(k.orientation!="horizontal"?this.offset.x:0),y:k.firstRef.y/(["left","right"].include(k.side)?(this.offset.ys||1):1)-(k.orientation!="vertical"?this.offset.y:0)});}else{if(f===2&&this.containsReference(k.absFirstRef,k.foreignBounds,e)){k.last.setReferencePoint({x:k.lastRef.x/(["top","bottom"].include(k.side)?(this.offset.xs||1):1)+(k.orientation!="horizontal"?this.offset.x:0),y:k.lastRef.y/(["left","right"].include(k.side)?(this.offset.ys||1):1)+(k.orientation!="vertical"?this.offset.y:0)});}else{h=true;}}}else{this.layoutOldStyle(k.edge,k);}}return h;},moveToOverlap:function(m,e,f,h,g){if(m.edge.dockers[0].getDockedShape()===this.node){m.second=m.edge.dockers[1];}else{m.second=m.edge.dockers[m.edge.dockers.length-2];}var r=this.oldBounds.getSide(m.second.bounds.center());var l=this.nodeBounds.getSide(m.second.bounds.center());if(!h){r=this.nodeBounds.getSide(m.second.bounds.center());}var k=this.getRelevantEdges(this.node,this.nodeBounds,r,m.edge,true);if(this.oldOrder[m.edge.id]){k=k.sortBy(function(t){return this.oldOrder[m.edge.id].indexOf(t);}.bind(this));}var p=k.indexOf(m.edge);var s=this.xOverlap(m);var q=this.yOverlap(m);var o=this.nodeBounds.getSide(m.foreignBounds.center())!==r;if(this.positionChanged||(["top","bottom"].include(r)?s>12:q>12)&&(this.removedDockers.length>0||e<=3)){m.first.setReferencePoint({x:s>0&&(f||m.orientation!="horizontal")?(m.overlap.upperLeft().x-m.nodeUL.x)+(p+1)/(k.length+1)*m.overlap.width():m.firstRef.x,y:q>0&&(f||m.orientation!="vertical")?(m.overlap.upperLeft().y-m.nodeUL.y)+(p+1)/(k.length+1)*m.overlap.height():m.firstRef.y});var n=m.first.getAbsoluteReferencePoint();if(m.second.isDocked()){m.second.setReferencePoint({x:s>0&&(f||m.orientation!="horizontal")?n.x-m.foreignUL.x:m.lastRef.x,y:q>0&&(f||m.orientation!="vertical")?n.y-m.foreignUL.y:m.lastRef.y});}else{m.second.bounds.centerMoveTo({x:(["left","right"].include(r)?m.second.bounds.center().x:m.first.getAbsoluteReferencePoint().x),y:(["left","right"].include(r)?m.first.getAbsoluteReferencePoint().y:m.second.bounds.center().y)});}}else{if(!this.isAligned((m.edge.dockers[0].getDockedShape()===this.node?m.edge.dockers[0]:m.edge.dockers[m.edge.dockers.length-1]),(m.edge.dockers[0].getDockedShape()===this.node?m.edge.dockers[1]:m.edge.dockers[m.edge.dockers.length-2]))&&(this.removedDockers.length>0)){if(m.second.isDocked()){m.second.setReferencePoint({x:(["top","bottom"].include(m.foreignBounds.getSide(m.second.bounds.center()))?m.first.getAbsoluteReferencePoint().x-m.foreignUL.x:m.lastRef.x),y:(["left","right"].include(m.foreignBounds.getSide(m.second.bounds.center()))?m.first.getAbsoluteReferencePoint().y-m.foreignUL.y:m.lastRef.y)});}else{if(g||this.removedDockers.length>0){m.second.bounds.centerMoveTo({x:(["left","right"].include(r)?m.secCenter.x:m.first.getAbsoluteReferencePoint().x),y:(["left","right"].include(r)?m.first.getAbsoluteReferencePoint().y:m.secCenter.y)});}}}}if(this.isBendPointIncluded(m.edge)&&m.edge.dockers.length>2){this.removedDockers=this.removedDockers.concat(this.removeAllDocker(m.edge));if(g&&!this.isAligned(m.first,m.second)){this.plugin.doLayout(m.edge);return;}}},removeAllDocker:function(f){var e=[];f.dockers.slice(1,f.dockers.length-1).each(function(g){e.push(g);f.removeDocker(g);});if(f.dockers[0].getDockedShape()===this.node){return e;}return e._reverse();},redistributeEdges:function(k,f){var l=[];var h=false;var m=true;var e=[];var g=this.edges.findAll(function(n){var o=(n.dockers[0].getDockedShape()===this.node?n.dockers[0]:n.dockers[n.dockers.length-1]);e.push(o);return this.node.absoluteBounds().getSide(o.bounds.center())===k;}.bind(this));g.each(function(p,n){var q=this.getDataObject(p,n);if(!q){return;}var u=[];if(m){u=this.getRelevantEdges(this.node,this.nodeBounds,q.newSide,q.edge);}var t=(m?u.indexOf(q.edge):n);var v=this.isAligned(q.first,q.second);var r=this.nodeBounds.getSide(q.foreignBounds.center())!==k;q.first.setReferencePoint({x:["top","bottom"].include(q.newSide)?(q.overlap&&!r?q.overlap.upperLeft().x-this.nodeBounds.upperLeft().x:0)+(t+1)/(g.length+1)*(q.overlap&&!r?q.overlap.width():this.nodeBounds.width()):q.firstRef.x,y:["left","right"].include(q.newSide)?(q.overlap&&!r?q.overlap.upperLeft().y-this.nodeBounds.upperLeft().y:0)+(t+1)/(g.length+1)*(q.overlap&&!r?q.overlap.height():this.nodeBounds.height()):q.firstRef.y});var s=q.first.getAbsoluteReferencePoint();if(v){if(q.second.isDocked()){q.second.setReferencePoint({x:["top","bottom"].include(q.newSide)?s.x-q.foreignUL.x:q.last.referencePoint.x,y:["left","right"].include(q.newSide)?s.y-q.foreignUL.y:q.last.referencePoint.y});if(!this.isAligned(q.first,q.second)){this.plugin.doLayout(p);}var o=q.foreignBounds.getSide(q.second.bounds.center());if(!this.containsReference(q.second.getAbsoluteReferencePoint(),q.foreignBounds,o)){this.plugin.doLayout(p);}}else{q.second.bounds.centerMoveTo({x:(["left","right"].include(q.newSide)?q.second.bounds.center().x:s.x),y:(["left","right"].include(q.newSide)?s.y:q.second.bounds.center().y)});}}}.bind(this));},getRelevantEdges:function(f,l,g,h,k){var m=h?[h.getSource(),h.getTarget()].compact():[];var e=f.getAllDockedShapes().findAll(function(o){if(!(o instanceof ORYX.Core.Edge)){return false;}if(o.dockers[0].getDockedShape()===f){var n=o.dockers[1];}else{var n=o.dockers[o.dockers.length-2];}if(k&&!(m.include(o.getSource())&&m.include(o.getTarget()))){return false;}return l.getSide(n.bounds.center())===g;}.bind(this));if(h instanceof ORYX.Core.Edge&&!e.include(h)){e.push(h);}return e.sort(function(o,n){if(o.dockers[0].getDockedShape()===f){var q=o.dockers[0];var p=o.dockers[1];}else{var q=o.dockers[o.dockers.length-1];var p=o.dockers[o.dockers.length-2];}if(n.dockers[0].getDockedShape()===f){var s=n.dockers[0];var r=n.dockers[1];}else{var s=n.dockers[n.dockers.length-1];var r=n.dockers[n.dockers.length-2];}q=q.bounds.center();p=p.bounds.center();s=s.bounds.center();r=r.bounds.center();return g==="top"||g==="bottom"?Math.round(q.x-s.x)<0?-1:(Math.round(q.x-s.x)>0?1:0):Math.round(q.y-s.y)<0?-1:(Math.round(q.y-s.y)>0?1:0);});},allEdgesInside:function(f,h,e,g){return e.all(function(n){var k=(n.dockers[0].getDockedShape()===f?n.dockers[1]:n.dockers[n.dockers.length-2]);var m=(k.isDocked()?k.getAbsoluteReferencePoint():k.bounds.center());var l=20;if(h.getSide(m)===g){return(g==="top"||g==="bottom"?m.x>h.upperLeft().x+l&&m.x<h.lowerRight().x-l:m.y>h.upperLeft().y+l&&m.y<h.lowerRight().y-l);}});},layoutOldStyle:function(g,h){if(g.dockers.length===2){var l=g.dockers.first().getAbsoluteReferencePoint()||g.dockers.first().bounds.center();var k=g.dockers.last().getAbsoluteReferencePoint()||g.dockers.first().bounds.center();if(Math.abs(-Math.abs(l.x-k.x)+Math.abs(this.offset.x))<2||Math.abs(-Math.abs(l.y-k.y)+Math.abs(this.offset.y))<2){this.plugin.doLayout(g);}}else{if(g.dockers.length>2){if(g.dockers.first().getDockedShape()===this.node){var f=g.dockers[1];if(this.align(f.bounds,g.dockers.first())){f.update();}}else{if(g.dockers.last().getDockedShape()===this.node){var e=g.dockers[g.dockers.length-2];if(this.align(e.bounds,g.dockers.last())){e.update();}}}g._update(true);g.removeUnusedDockers();if(this.isBendPointIncluded(g,true)){this.plugin.doLayout(g);return;}return h;}}},getDataObject:function(o,A){var F=o.dockers;var n=F.length;var r;var p,E,q;if(F[0].getDockedShape()===this.node){p=F[0];E=F[1];q=F[n-1];r=q.getDockedShape();}else{if(F[n-1].getDockedShape()===this.node){p=F[n-1];E=F[n-2];q=F[0];r=q.getDockedShape();}}if(!p||!r){this.layoutOldStyle(o);return;}var e=this.node.getOverlap(r);var h=p.bounds;var z=h.center();var v=E.bounds;var m=v.center();var t=q.bounds;var k=t.center();var x=p.getAbsoluteReferencePoint();var H=p.referencePoint;var I=q.getAbsoluteReferencePoint();var y=q.referencePoint;var f=this.nodeBounds.upperLeft();var C=this.nodeBounds.lowerRight();var D=r.absoluteBounds();var B=D.upperLeft();var u=D.lowerRight();var g=this.oldBounds.getSide(E.bounds.center());var s=this.nodeBounds.getSide(E.bounds.center());var l=D.isIncluded({x:x.x-this.offset.x,y:x.y-this.offset.y})||this.nodeBounds.isIncluded({x:I.x+this.offset.x,y:I.y+this.offset.y})?"skew":Math.round(x.y-this.offset.y)===(E.isDocked?Math.round(I.y):m.y)?"horizontal":Math.round(x.x-this.offset.x)===(E.isDocked?Math.round(I.x):m.x)?"vertical":"skew";var G={first:p,second:E,last:q,firstBounds:h,firstCenter:z,secBounds:v,secCenter:m,lastBounds:t,lastCenter:k,absFirstRef:x,firstRef:H,absLastRef:I,lastRef:y,node:b,foreignNode:r,overlap:e,nodeUL:f,nodeLR:C,foreignBounds:D,foreignUL:B,foreignLR:u,orientation:l,edge:o,edgeIndex:A,side:g,newSide:s};return G;},executeAgain:function(){this.changes.each(function(e){this.removeAllDocker(e.edge);e.dockerPositions.each(function(h,f){if(f==0||f==e.dockerPositions.length-1){e.edge.dockers[f].setReferencePoint(h);return;}var g=e.edge.createDocker(undefined,h);g.bounds.centerMoveTo(h);g.update();}.bind(this));e.edge._update(true);}.bind(this));},rollback:function(){this.changes.each(function(e){this.removeAllDocker(e.edge);e.oldDockerPositions.each(function(h,f){if(f==0||f==e.oldDockerPositions.length-1){e.edge.dockers[f].setReferencePoint(h);return;}var g=e.edge.createDocker(undefined,h);g.bounds.centerMoveTo(h);g.update();}.bind(this));e.edge._update(true);}.bind(this));}});this.facade.executeCommands([new c(a,b,d,this)]);}});}();if(!ORYX){var ORYX={};}if(!ORYX.Plugins){ORYX.Plugins={};}ORYX.Plugins.AbstractLayouter=ORYX.Plugins.AbstractPlugin.extend({layouted:[],construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT,this._initLayout.bind(this));},isIncludedInLayout:function(a){if(!(this.layouted instanceof Array)){this.layouted=[this.layouted].compact();}if(this.layouted.length<=0){return true;}return this.layouted.any(function(b){if(typeof b=="string"){return a.getStencil().id().include(b);}else{return a instanceof b;}});},_initLayout:function(c){var b=[c.shapes].flatten().compact();var a=b.findAll(function(d){return this.isIncludedInLayout(d);}.bind(this));if(a.length>0){this.layout(a);}},layout:function(a){throw new Error("Layouter has to implement the layout function.");}});if(!Signavio){var Signavio={};}if(!Signavio.Core){Signavio.Core={};}Signavio.Core.Version="5.3.0";if(!Signavio){var Signavio=new Object();}if(!Signavio.Plugins){Signavio.Plugins=new Object();}if(!Signavio.Plugins.Utils){Signavio.Plugins.Utils=new Object();}if(!Signavio.Helper){Signavio.Helper=new Object();}new function(){var a;Signavio.Plugins.Utils.getFFVersion=function(){try{return Number(window.navigator.userAgent.match("Firefox.([0-9]+[.][0-9]+)")[1])||0;}catch(b){return 0;}};Signavio.Helper.ShowMask=function(c,f){if(!c&&ORYX.CONFIG.PREVENT_LOADINGMASK_AT_READY===true){return;}if(a){return;}var k="background:white;bottom:0;height:100%;left:0;position:absolute;right:0;top:0;width:100%;z-index:100000;";var l="left:50%;margin-left:-200px;margin-top:-90px;position:absolute;top:50%;display:none;width:391px;";var g="color:#ad0f5b;padding-right:10px;font-family:tahoma,arial,san-serif;font-size:12px;";var h="display:block;position:relative;text-align:right;top:0;width:100%;";var b="color:#ad0f5b;font-weight:bold;padding-right:10px;font-family:tahoma,arial,san-serif;font-size:12px;";var e="height:16px;width:16px;margin-bottom:-4px;background: transparent url(../libs/ext-2.0.2/resources/images/default/tree/loading.gif) no-repeat center;";var d="padding-bottom:10px;border-bottom:1px solid #ad0f5b;";f=(f?Ext.get(f):null)||Ext.getBody();if(f!==Ext.getBody()){f.setStyle("position","relative");}a=Ext.get(document.createElement("div"));f.appendChild(a);a.dom.setAttribute("style",k);a.dom.innerHTML="<div class='mask-logo' style='"+l+"'>"+"<div>"+"<img style='"+d+"' src='"+ORYX.CONFIG.EXPLORER_PATH+"/src/img/signavio/signavio_logo.jpg' />"+"</div>"+"<span class='mask-text' style='"+h+"'>"+"<span class='mask-title' style='"+b+"'>Editor</span>"+"<span class='mask-version' style='"+g+"'>Version "+Signavio.Core.Version+"</span>"+"<img style='"+e+"' src='"+(ORYX.CONFIG.BLANK_IMAGE||Ext.BLANK_IMAGE_URL)+"'/>"+"</span>"+"</div>";a.first().show({duration:0.3});};Signavio.Helper.HideMask=function(){window.setTimeout(function(){if(a){try{a.first().hide({duration:0.4,remove:true,block:true});a.hide({duration:0.3,remove:true,block:true});delete a;}catch(b){}}}.bind(this),2000);};Signavio.Plugins.Loading={facade:undefined,construct:function(b){this.facade=b;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,Signavio.Helper.HideMask);var c=this;new function(){var d=ORYX.Core.Canvas.prototype.toJSON;ORYX.Core.Canvas.prototype.toJSON=function(){var e=d.call(this);e.stencilset.namespace=c.facade.getModelMetaData().model.stencilset.namespace;return e;};}();}};Signavio.Plugins.Loading=Clazz.extend(Signavio.Plugins.Loading);ORYX.Editor.provideId=function(){var c=[],d="0123456789ABCDEF";for(var b=0;b<36;b++){c[b]=Math.floor(Math.random()*16);}c[14]=4;c[19]=(c[19]&3)|8;for(var b=0;b<36;b++){c[b]=d[c[b]];}c[8]=c[13]=c[18]=c[23]="-";return"sid-"+c.join("");};}();new function(){Ext.LinkButton=Ext.extend(Ext.BoxComponent,{click:null,image:null,imageStyle:null,toggle:false,toggleStyle:null,selected:false,href:false,el:null,onRender:function(b,a){if(this.el==null){this.el=document.createElement("a");if(this.tabIndex){this.el.setAttribute("tabindex",this.tabIndex);}this.el.id=this.getId();this.el.className=this.cls||"x-link-button";if(!this.disabled){this.el.href=this.href?this.href:"#"+this.text;}if(!this.disabled){Element.observe(this.el,"click",this.onClick.bind(this));}if(this.image){this.el.innerHTML='<img src="'+this.image+'" title="'+this.text+'"'+(this.imageStyle?' style="'+this.imageStyle+'"/>':"/>");}else{this.el.innerHTML=this.text?Ext.util.Format.htmlEncode(this.text):(this.html||"");}if(this.forId){this.el.setAttribute("htmlFor",this.forId);}}Ext.LinkButton.superclass.onRender.call(this,b,a);},onClick:function(a){if(this.disabled){Event.stop(a);return;}if(this.toggle){this.selected=!this.selected;if(this.toggleStyle){this._setStyle(this.el.dom,"");this.el.dom.setAttribute("style","");if(this.selected){this.el.applyStyles(this.toggleStyle);}else{this.el.applyStyles(this.initialConfig.style);}}}if(this.click instanceof Function){this.click.apply(this.click,[this,a]);}Event.stop(a);},setText:function(a,b){this.text=a;if(this.rendered){this.el.dom.innerHTML=b!==false?Ext.util.Format.htmlEncode(a):a;}return this;},_setStyle:function(b,a){if(Ext.isIE){b.style.setAttribute("cssText",a);}else{b.setAttribute("style",a);}}});Ext.reg("linkbutton",Ext.LinkButton);}();new function(){Signavio.Helper.RecordReader=function(meta){meta=meta||{};this.rels=meta.rels||this.rels;Signavio.Helper.RecordReader.superclass.constructor.call(this,meta,["rep","href","rel"]);};Ext.extend(Signavio.Helper.RecordReader,Ext.data.JsonReader,{rels:["gitem"],read:function(response){var json=response.responseText;var o=eval("("+json+")");if(!o){throw {message:"JsonReader.read: Json object not found"};}var Record=this.recordType;var records=[],total=0;o.each(function(rec){if(this.rels.include(rec.rel)){records.push(new Record(rec));}if(rec.rel=="info"&&rec.rep.size){total=rec.rep.size;}}.bind(this));return{success:true,records:records,totalRecords:total||records.length};}});Signavio.Helper.createRecord=function(rel,href,rep){var Rec=Ext.data.Record.create(["rel","href","rep"]);var record=new Rec({rel:rel,href:href,rep:rep});return record;};Signavio.Helper.getCookie=function(check_name){var a_all_cookies=document.cookie.split(";");var a_temp_cookie="";var cookie_name="";var cookie_value="";var b_cookie_found=false;for(var i=0;i<a_all_cookies.length;i++){a_temp_cookie=a_all_cookies[i].split("=");cookie_name=a_temp_cookie[0].replace(/^\s+|\s+$/g,"");if(cookie_name==check_name){b_cookie_found=true;if(a_temp_cookie.length>1){cookie_value=unescape(a_temp_cookie[1].replace(/^\s+|\s+$/g,""));}return cookie_value;break;}a_temp_cookie=null;cookie_name="";}if(!b_cookie_found){return null;}};Signavio.Helper.BusinessObjectSortingFunction=function(a,b){if(!a||!b){return 0;}var comparator=function(a,b){var as=a.match(/([0-9]+|[^0-9]+)/g),bs=b.match(/([0-9]+|[^0-9]+)/g),ca,cb;while((ca=as.shift())&&(cb=bs.shift())){if(ca.match(/^([0-9]+)$/)){ca=parseInt(ca);}if(cb.match(/^([0-9]+)$/)){cb=parseInt(cb);}if(ca!==cb){if(typeof ca!==typeof cb){return"number"==typeof ca?-1:1;}else{return(ca<cb?-1:(ca>cb?1:0));}}}return"undefined"==typeof ca&&"undefined"==typeof cb?0:("undefined"==typeof ca?-1:("undefined"==typeof cb?1:0));};try{var relA=a.rel.toLowerCase();var relB=b.rel.toLowerCase();if(relA==relB){if(relA=="dir"&&a.rep.type=="public"){return -1;}if(relB=="dir"&&b.rep.type=="public"){return 1;}var tA=(a.rep.name||a.rep.title||a.rep.username||-a.rep.rev||"");var tB=(b.rep.name||b.rep.title||b.rep.username||-b.rep.rev||"");tA="string"==typeof tA?tA.toLowerCase().gsub("?","a").gsub("?","o").gsub("","u").replace(/([ ][ ]*)/g," ").trim():tA;tB="string"==typeof tB?tB.toLowerCase().gsub("?","a").gsub("?","o").gsub("","u").replace(/([ ][ ]*)/g," ").trim():tB;if("string"==typeof tA&&"string"==typeof tB){return comparator(tA,tB);}else{return(tA<tB?-1:(tA>tB?1:0));}}else{return(relA<relB?-1:(relA>relB?1:0));}}catch(e){return 0;}};}();if(!Signavio){var Signavio=new Object();}if(!Signavio.Plugins){Signavio.Plugins=new Object();}new function(){var d={"http://b3mn.org/stencilset/bpmn1.1#":{"Task":["oryx-name"],"CollapsedSubprocess":["oryx-name"],"Subprocess":["oryx-name"],"Pool":["oryx-name"],"CollapsedPool":["oryx-name"],"Lane":["oryx-name"],"DataObject":["oryx-name"],"StartEvent":["oryx-name"],"StartMessageEvent":["oryx-name"],"StartTimerEvent":["oryx-name"],"StartConditionalEvent":["oryx-name"],"StartSignalEvent":["oryx-name"],"StartMultipleEvent":["oryx-name"],"IntermediateEvent":["oryx-name"],"IntermediateMessageEventCatching":["oryx-name"],"IntermediateMessageEventThrowing":["oryx-name"],"IntermediateTimerEvent":["oryx-name"],"IntermediateErrorEvent":["oryx-name"],"IntermediateCancelEvent":["oryx-name"],"IntermediateCompensationEventCatching":["oryx-name"],"IntermediateCompensationEventThrowing":["oryx-name"],"IntermediateConditionalEvent":["oryx-name"],"IntermediateSignalEventCatching":["oryx-name"],"IntermediateSignalEventThrowing":["oryx-name"],"IntermediateMultipleEventCatching":["oryx-name"],"IntermediateMultipleEventThrowing":["oryx-name"],"IntermediateLinkEventCatching":["oryx-name"],"IntermediateLinkEventThrowing":["oryx-name"],"EndEvent":["oryx-name"],"EndMessageEvent":["oryx-name"],"EndErrorEvent":["oryx-name"],"EndCancelEvent":["oryx-name"],"EndCompensationEvent":["oryx-name"],"EndSignalEvent":["oryx-name"],"EndMultipleEvent":["oryx-name"],"EndTerminateEvent":["oryx-name"],"SequenceFlow":["oryx-conditionexpression"],"MessageFlow":["oryx-name"],"Exclusive_Databased_Gateway":["oryx-name"],"Exclusive_Eventbased_Gateway":["oryx-name"],"AND_Gateway":["oryx-name"],"OR_Gateway":["oryx-name"],"Complex_Gateway":["oryx-name"]},"http://b3mn.org/stencilset/jbpm4#":{"Task":["oryx-name"],"Pool":["oryx-name"],"Lane":["oryx-name"],"StartEvent":["oryx-name"],"EndEvent":["oryx-name"],"SequenceFlow":["oryx-conditionexpression"],"Exclusive_Databased_Gateway":["oryx-name"],"AND_Gateway":["oryx-name"]},"http://b3mn.org/stencilset/timjpdl3#":{"Task":["oryx-name"],"Pool":["oryx-name"],"Lane":["oryx-name"],"StartEvent":["oryx-name"],"EndEvent":["oryx-name"],"SequenceFlow":["oryx-conditionexpression"],"Exclusive_Databased_Gateway":["oryx-name"],"AND_Gateway":["oryx-name"]},"http://b3mn.org/stencilset/bpmn2.0#":{"Task":["oryx-name"],"CollapsedSubprocess":["oryx-name"],"Subprocess":["oryx-name"],"CollapsedEventSubprocess":["oryx-name"],"EventSubprocess":["oryx-name"],"Exclusive_Databased_Gateway":["oryx-name"],"EventbasedGateway":["oryx-name"],"ParallelGateway":["oryx-name"],"InclusiveGateway":["oryx-name"],"ComplexGateway":["oryx-name"],"Pool":["oryx-name"],"CollapsedPool":["oryx-name"],"VerticalPool":["oryx-name"],"CollapsedVerticalPool":["oryx-name"],"processparticipant":["oryx-name"],"Lane":["oryx-name"],"VerticalLane":["oryx-name"],"DataObject":["oryx-name"],"DataStore":["oryx-name"],"Message":["oryx-name"],"StartNoneEvent":["oryx-name"],"StartMessageEvent":["oryx-name"],"StartTimerEvent":["oryx-name"],"StartEscalationEvent":["oryx-name"],"StartConditionalEvent":["oryx-name"],"StartErrorEvent":["oryx-name"],"StartCompensationEvent":["oryx-name"],"StartSignalEvent":["oryx-name"],"StartMultipleEvent":["oryx-name"],"StartParallelMultipleEvent":["oryx-name"],"IntermediateEvent":["oryx-name"],"IntermediateMessageEventCatching":["oryx-name"],"IntermediateTimerEvent":["oryx-name"],"IntermediateEscalationEvent":["oryx-name"],"IntermediateConditionalEvent":["oryx-name"],"IntermediateLinkEventCatching":["oryx-name"],"IntermediateErrorEvent":["oryx-name"],"IntermediateCancelEvent":["oryx-name"],"IntermediateCompensationEventCatching":["oryx-name"],"IntermediateSignalEventCatching":["oryx-name"],"IntermediateMultipleEventCatching":["oryx-name"],"IntermediateParallelMultipleEventCatching":["oryx-name"],"IntermediateMessageEventThrowing":["oryx-name"],"IntermediateEscalationEventThrowing":["oryx-name"],"IntermediateLinkEventThrowing":["oryx-name"],"IntermediateCompensationEventThrowing":["oryx-name"],"IntermediateSignalEventThrowing":["oryx-name"],"IntermediateMultipleEventThrowing":["oryx-name"],"EndNoneEvent":["oryx-name"],"EndMessageEvent":["oryx-name"],"EndEscalationEvent":["oryx-name"],"EndErrorEvent":["oryx-name"],"EndCancelEvent":["oryx-name"],"EndCompensationEvent":["oryx-name"],"EndSignalEvent":["oryx-name"],"EndMultipleEvent":["oryx-name"],"EndTerminateEvent":["oryx-name"],"SequenceFlow":["oryx-conditionexpression"],"MessageFlow":["oryx-name"],"ChoreographyTask":["oryx-name"],"ChoreographySubprocessCollapsed":["oryx-name"],"ChoreographySubprocessExpanded":["oryx-name"],"ChoreographyParticipant":["oryx-name"],"ITSystem":["oryx-name"],"processparticipant":["oryx-name"]},"http://b3mn.org/stencilset/bpmn2.0choreography#":{"Task":["oryx-name"],"CollapsedSubprocess":["oryx-name"],"Subprocess":["oryx-name"],"CollapsedEventSubprocess":["oryx-name"],"EventSubprocess":["oryx-name"],"Exclusive_Databased_Gateway":["oryx-name"],"EventbasedGateway":["oryx-name"],"ParallelGateway":["oryx-name"],"InclusiveGateway":["oryx-name"],"ComplexGateway":["oryx-name"],"Pool":["oryx-name"],"CollapsedPool":["oryx-name"],"processparticipant":["oryx-name"],"Lane":["oryx-name"],"DataObject":["oryx-name"],"DataStore":["oryx-name"],"Message":["oryx-name"],"StartNoneEvent":["oryx-name"],"StartMessageEvent":["oryx-name"],"StartTimerEvent":["oryx-name"],"StartEscalationEvent":["oryx-name"],"StartConditionalEvent":["oryx-name"],"StartErrorEvent":["oryx-name"],"StartCompensationEvent":["oryx-name"],"StartSignalEvent":["oryx-name"],"StartMultipleEvent":["oryx-name"],"StartParallelMultipleEvent":["oryx-name"],"IntermediateEvent":["oryx-name"],"IntermediateMessageEventCatching":["oryx-name"],"IntermediateTimerEvent":["oryx-name"],"IntermediateEscalationEvent":["oryx-name"],"IntermediateConditionalEvent":["oryx-name"],"IntermediateLinkEventCatching":["oryx-name"],"IntermediateErrorEvent":["oryx-name"],"IntermediateCancelEvent":["oryx-name"],"IntermediateCompensationEventCatching":["oryx-name"],"IntermediateSignalEventCatching":["oryx-name"],"IntermediateMultipleEventCatching":["oryx-name"],"IntermediateParallelMultipleEventCatching":["oryx-name"],"IntermediateMessageEventThrowing":["oryx-name"],"IntermediateEscalationEventThrowing":["oryx-name"],"IntermediateLinkEventThrowing":["oryx-name"],"IntermediateCompensationEventThrowing":["oryx-name"],"IntermediateSignalEventThrowing":["oryx-name"],"IntermediateMultipleEventThrowing":["oryx-name"],"EndNoneEvent":["oryx-name"],"EndMessageEvent":["oryx-name"],"EndEscalationEvent":["oryx-name"],"EndErrorEvent":["oryx-name"],"EndCancelEvent":["oryx-name"],"EndCompensationEvent":["oryx-name"],"EndSignalEvent":["oryx-name"],"EndMultipleEvent":["oryx-name"],"EndTerminateEvent":["oryx-name"],"SequenceFlow":["oryx-conditionexpression"],"MessageFlow":["oryx-name"],"ChoreographyTask":["oryx-name"],"ChoreographySubprocessCollapsed":["oryx-name"],"ChoreographySubprocessExpanded":["oryx-name"],"ChoreographyParticipant":["oryx-name"],"ITSystem":["oryx-name"],"processparticipant":["oryx-name"]},"http://b3mn.org/stencilset/bpmn2.0conversation#":{"Communication":["oryx-name"],"SubConversation":["oryx-name"],"Participant":["oryx-name"]},"http://www.signavio.com/stencilsets/organigram#":{"Manager":["oryx-title"],"freejob":["oryx-title"],"position":["oryx-title"],"HierarchicOrgUnit":["oryx-title"]},"http://b3mn.org/stencilset/epc#":{"Event":["oryx-title"],"Function":["oryx-title"],"ProcessInterface":["oryx-title"],"Organization":["oryx-title"],"Position":["oryx-title"],"Data":["oryx-title"],"System":["oryx-title"],"Entity":["oryx-title"],"Form":["oryx-title"],"Resource":["oryx-title"],"Letter":["oryx-title"],"Mail":["oryx-title"],"Phone":["oryx-title"],"Fax":["oryx-title"]}};var e={"all":{"category":"ACTIVITY"},"http://b3mn.org/stencilset/bpmn1.1#Pool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn1.1#CollapsedPool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn1.1#Lane":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn1.1#DataObject":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/jbpm4#Pool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/jbpm4#Lane":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/timjpdl3#Pool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/timjpdl3#Lane":{"category":"ORG_UNIT"},"http://www.signavio.com/stencilsets/organigram#Manager":{"category":"ORG_UNIT"},"http://www.signavio.com/stencilsets/organigram#freejob":{"category":"ORG_UNIT"},"http://www.signavio.com/stencilsets/organigram#position":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0#Pool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0#CollapsedPool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0#Lane":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0#VerticalPool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0#CollapsedVerticalPool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0#VerticalLane":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0#DataObject":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/bpmn2.0#DataStore":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/bpmn2.0#Message":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/bpmn2.0#ChoreographyParticipant":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0#ITSystem":{"category":"IT_SYSTEM"},"http://b3mn.org/stencilset/bpmn2.0#processparticipant":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0choreography#Pool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0choreography#CollapsedPool":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0choreography#Lane":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0choreography#CollapsedSubprocess":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0choreography#DataObject":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/bpmn2.0choreography#DataStore":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/bpmn2.0choreography#Message":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/bpmn2.0conversation#Participant":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/epc#Event":{"category":"STATE"},"http://b3mn.org/stencilset/epc#Organization":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/epc#Position":{"category":"ORG_UNIT"},"http://b3mn.org/stencilset/epc#System":{"category":"IT_SYSTEM"},"http://b3mn.org/stencilset/epc#Data":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/epc#Entity":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/epc#Form":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/epc#Resource":{"category":"IT_SYSTEM"},"http://b3mn.org/stencilset/epc#Letter":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/epc#Mail":{"category":"DOCUMENT"},"http://b3mn.org/stencilset/epc#Phone":{"category":"IT_SYSTEM"},"http://b3mn.org/stencilset/epc#Fax":{"category":"DOCUMENT"}};var a=Clazz.extend({construct:function(f,k,g,l,h){this.shape=f;this.property=k;this.glossary=g;this.text=l;this.isDirty=h||false;},toString:function(){return ORYX.Utils.getInGlossarySchema(this.glossary,this.text);}});var c=function(f){this.glossary=$H({});this.facade=f;};c.prototype.generateKey=function(f,g){if(typeof g=="string"){return f.resourceId+"-"+g;}return f.resourceId+"-"+g.prefix()+"-"+g.id();};c.prototype.set=function(g,n,f,p,q){if(!n){return;}var o=this.generateKey(g,n);if(!f&&!p){delete this.glossary[o];g.setHiddenProperty(n.prefix()+"-"+n.id()+ORYX.CONFIG.GLOSSARY_PROPERTY_DIRTY_SUFFIX);}else{var m=new a(g,n,f,p,q);var l=this.get(g,n,f);if(l){if(this.glossary[o] instanceof Array){this.glossary[o]=this.glossary[o].without(l);}else{delete this.glossary[o];}}if(this.glossary[o]&&n.isList()){if(!(this.glossary[o] instanceof Array)){this.glossary[o]=[this.glossary[o]];}this.glossary[o].push(m);}else{this.glossary[o]=m;}g.setHiddenProperty(n.prefix()+"-"+n.id()+ORYX.CONFIG.GLOSSARY_PROPERTY_DIRTY_SUFFIX,q||false);if(g instanceof ORYX.Core.Shape){var k=g.getLabels().find(function(r){return n.refToView().any(function(s){return r.id.endsWith(s);});});if(k){var h=k.getReferencedElementWidth();if(h){k.node.setAttribute("oryx:textWidth",h);}}}}};c.prototype.get=function(f,k,g){if(!f&&!k){return this.glossary.values().flatten();}if(!k){k=f.getStencil().properties().find(function(l){return this.has(f,l);}.bind(this));}var h=this.generateKey(f,k);if(g){return this.glossary[h] instanceof Array?this.glossary[h].find(function(l){return l.glossary===g;}):(this.glossary[h]&&this.glossary[h].glossary===g?this.glossary[h]:null);}else{return this.glossary[h];}};c.prototype.has=function(f,h,g){if(h){return !!this.get(f,h,g);}else{return f.getStencil().properties().any(function(k){return this.has(f,k,g);}.bind(this));}};Signavio.Plugins.GlossarySupport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,ICON_ADD:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/"+(Ext.isIPad?"24x24/":"")+"book_add.png",ICON_WARNING:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/"+(Ext.isIPad?"24x24/":"")+"book_error.png",ICON:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/"+(Ext.isIPad?"24x24/":"")+"book.png",construct:function(f){this.facade=f;this.overlays=$H({});this.modifyFacade();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.propertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.onSelectionChange.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_GLOSSARY_SHOW,this.handleOpenInfo.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_GLOSSARY_NEW,this.handleOpenNew.bind(this));this.categories=new Ext.data.Store({proxy:new Ext.data.HttpProxy({useAjax:true,method:"GET",headers:{accept:"application/json"},url:"/p/glossary?originId="+this.facade.getModelMetaData().parent}),reader:new Signavio.Helper.RecordReader({rels:["cat","priv"]})});this.categories.load();this.glossaryOffer={target:ORYX.Plugins.ShapeMenuPlugin,functionality:function(){var h=this.facade.getSelection().first();if(h){this.showNewWindow(h,this.getFirstSupportedProperty(h));}}.bind(this),icon:this.ICON_ADD,description:Signavio.I18N.Glossary_Support.tooltipCreate,align:ORYX.CONFIG.SHAPEMENU_BOTTOM,minShape:1,maxShape:1,offset:{x:-30}};this.facade.offer(this.glossaryOffer);var g=this;new function(){var h=ORYX.Core.AbstractShape.prototype.toJSON;ORYX.Core.AbstractShape.prototype.toJSON=function(){var k=h.call(this);if(g.facade.hasGlossaryExtension&&g.facade.hasGlossary(this)){this.getStencil().properties().each(function(m){var l=g.facade.getGlossary(this,m);if(l&&k.properties[m.id()]){if(l instanceof Array){k.properties[m.id()]=l.map(function(o,n){return g.facade.generateGlossaryURL(o.glossary,o.text);});}else{k.properties[m.id()]=g.facade.generateGlossaryURL(l.glossary,k.properties[m.id()]);}}}.bind(this));}return k;};}();var g=this;new function(){var h=ORYX.Core.AbstractShape.prototype.deserialize;ORYX.Core.AbstractShape.prototype.deserialize=function(){h.apply(this,arguments);if(g.facade.hasGlossaryExtension){this.getStencil().properties().each(function(o){var l=o.prefix()+"-"+o.id(),m=this.properties[l];if("string"==typeof m&&g.isGlossaryEntry(m)){var n=g.getGlossaryText(m),k=g.getGlossaryId(m);g.facade.setGlossary(this,o,k,n,false);this.properties[l]=n;}}.bind(this));}};}();new function(){var h=ORYX.Core.AbstractShape.prototype.serialize;ORYX.Core.AbstractShape.prototype.serialize=function(){if(g.facade.hasGlossaryExtension&&g.facade.hasGlossary(this)){var k=new Hash();this.getStencil().properties().each(function(n){var m=g.facade.getGlossary(this,n);if(m&&typeof this.properties[n.prefix()+"-"+n.id()]!=="undefined"){k[n.prefix()+"-"+n.id()]=this.properties[n.prefix()+"-"+n.id()];if(m instanceof Array){this.properties[n.prefix()+"-"+n.id()]=m.map(function(p,o){return g.facade.generateGlossaryURL(p.glossary,p.text);});}else{this.properties[n.prefix()+"-"+n.id()]=g.facade.generateGlossaryURL(m.glossary,this.properties[n.prefix()+"-"+n.id()]);}}}.bind(this));}var l=h.call(this);if(k){k.keys().each(function(m){this.properties[m]=k[m];}.bind(this));}return l;};}();},modifyFacade:function(){this.facade.hasGlossaryExtension=true;this.glossaryStore=new c(this.facade);this.facade.setGlossary=this.glossaryStore.set.bind(this.glossaryStore);this.facade.getGlossary=this.glossaryStore.get.bind(this.glossaryStore);this.facade.hasGlossary=this.glossaryStore.has.bind(this.glossaryStore);this.facade.generateGlossaryURL=this.getGlossaryURL.bind(this);this.facade.checkGlossaryIsDirty=this.checkGlossaryIsDirty.bind(this);this.facade.updateGlossaryUI=this.updateGlossaryUI.bind(this);this.facade.stencilHasGlossarySupport=this.stencilHasGlossarySupport.bind(this);},stencilHasGlossarySupport:function(f,g){if(f instanceof ORYX.Core.AbstractShape){f=f.getStencil();}return !(!d[f.namespace()]||!d[f.namespace()][f.idWithoutNs()]||(g&&!d[f.namespace()][f.idWithoutNs()].include(g)));},shapeHasGlossarySupportAndIsNotEmpty:function(f){if(!this.stencilHasGlossarySupport(f)){return undefined;}var h=f.getStencil();var g=d[h.namespace()][h.idWithoutNs()];return g.all(function(k){return !!(f.properties[k]||"").strip();});},getFirstSupportedProperty:function(f){if(!this.stencilHasGlossarySupport(f)){return false;}var g=f.getStencil();return d[g.namespace()][g.idWithoutNs()].first();},isGlossaryEntry:function(f){return f&&!!f.match(/\glossary\:\/\/.+\/[\w\W]+\;\;/g);},getGlossaryText:function(f){return(f||"").split(";;").invoke("replace",/\glossary\:\/\/.+\//g,"").first();},getGlossaryId:function(f){return(f||"").split(";;").invoke("replace",/\glossary\:\/\//g,"").invoke("replace",/\/[\w\W]+/g,"").first();},getGlossaryURL:function(f,g){return(new Ext.XTemplate("glossary://{id}/{text};;")).apply({id:f,text:g});},checkGlossaryIsDirty:function(g,f){if(!g||!f){return g!=f;}var k="([{\\^-$|]})?*+.";var o="[!\"#\\$%&'\\(\\)\\*\\+,\\-\\./:;<=>\\?@\\[\\\\\\]\\^_`\\{\\|\\}~]";var n="(^|\\s|(^|[^\\\\])\\\\[nfr\\x0B]|"+o+")";var h="(\\s|\\\\[nfr\\x0B]|-)*?";var m="($|\\s|[^\\\\]\\\\[nfr\\x0B]|"+o+")";var l=n+"(";f.toArray().each(function(p,q){if(k.include(p)){l+="\\"+p;}else{if(p!==" "){l+=p;}}if(q<f.length-1){l+=h;}});l+=")"+m;return !(g.match(l));},updateGlossaryUI:function(g){if(!(g instanceof Array)){g=[g];}var f=this.currentSelection;this.currentSelection=g;this.updateButton(g);this.currentSelection=f;},propertyChanged:function(h,g){if(!this.stencilHasGlossarySupport(g,h.name.replace(/_[a-z]+$/i,""))){return;}var n=h.name;var m=h.value;if(!n){return;}var q=this.isGlossaryEntry(m);var k=this.glossaryStore.has(g,n);if(!q&&!k){if(this.overlays["glossary.urlref_"+g.resourceId]!==undefined){}}if(false&&q){var o=this.getGlossaryText(m);var f=this.getGlossaryId(m);var p=!!g.hiddenProperties[n+ORYX.CONFIG.GLOSSARY_PROPERTY_DIRTY_SUFFIX];if(!k){this.glossaryStore.set(g,g.getStencil().property(n),f,o,p);}g.setProperty(n,o);this.facade.getCanvas().update();}else{if(!q&&k){var l=this.glossaryStore.get(g,n);if(l&&(this.overlays["glossary.urlref_"+g.resourceId]===undefined||this.overlays["glossary.urlref_"+g.resourceId]!==l.isDirty)){}}}this.updateButton([g]);},onSelectionChange:function(f){this.currentSelection=f.elements;this.updateButton(f.elements);},updateButton:function(f){if(f.length==1&&(this.currentSelection||[]).include(f[0])&&this.stencilHasGlossarySupport(f[0])){delete this.glossaryOffer.isEnabled;var l=f[0],k=this.getFirstSupportedProperty(l),g=k;if(ORYX.CONFIG.MULTI_LANGUAGES_ENABLED&&l.getStencil().property(g)&&l.getStencil().property(g).language()){var p=l.getStencil().property(k).origin();$H(ORYX.CONFIG.MULTI_LANGUAGES||{}).keys().any(function(r){var q=p.prefix()+"-"+p.id()+(r==ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT?"":"_"+r);if(this.glossaryStore.has(l,q)){g=q;return true;}return false;}.bind(this));}if(this.glossaryStore.has(l,g)){var o=this.glossaryStore.get(l,g);var h=o.isDirty;var n=o.text+" - "+Signavio.I18N.Glossary_Support[h?"tooltipInfoWarning":"tooltipInfo"];var m=h?this.ICON_WARNING:this.ICON;this.setGlossaryOffer(n,m,function(){this.openGlossaryInfo(o.glossary,l);}.bind(this));}else{this.setGlossaryOffer(Signavio.I18N.Glossary_Support.tooltipCreate,this.ICON_ADD,function(){this.showNewWindow(f[0],k+(this.facade.getCanvas().getLanguage()!=ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT?"_"+this.facade.getCanvas().getLanguage():""));}.bind(this));}}else{this.glossaryOffer.isEnabled=function(){return false;};}},setGlossaryOffer:function(h,g,f){if(!this.glossaryOffer||!this.glossaryOffer.button){return;}this.glossaryOffer.button.setCallback(f);this.glossaryOffer.button.setDescription(h);this.glossaryOffer.button.setIcon(g);},handleOpenInfo:function(f){this.openGlossaryInfo(f.glossary,f.shape);},handleOpenNew:function(f){this.showNewWindow(f.shape,f.property,f.callback,f.hasCategorySwitch);},extractParams:function(f){var g=this.getBaseParams()||{};f.each(function(h){if(h&&h.dataField&&(h.getValue()||h.getValue()!==h.originalValue)&&(!h.defaultValue||(h.defaultValue!==h.getValue()&&h.getValue()!==h.originalValue))){if(h.dataField.include(".")){var l=h.dataField.split(".");var k=g;l.slice(0,l.length-1).each(function(m){if(!k[m]){k[m]={};}k=k[m];});k[l.last()]=h.getValue();}else{g[h.dataField]=h.getValue();}}});return g;},getBaseParams:function(){return{language:"en",title:"",description:"",originId:this.facade.getModelMetaData().parent};},getCategoryStore:function(){var f=new Ext.data.SimpleStore({fields:["label","value"],data:this.categories.data.items.findAll(function(g){return g.get("rel")==="cat";}).map(function(h){var g=h.get("rep").type;return[Signavio.I18N.Glossary_Support[g]||g||"",g||""];})});return f;},getFieldItems:function(h,l,m,g,k){var f=[];f.push(new Ext.form.Label({text:(Signavio.I18N.Glossary_Support.create),style:"display:block;margin-bottom:5px;font-size:12px;margin-left:155px;"}));f.push(Ext.ux.form.FieldFactory.generate("MetaDataChoiceInfo",{dataField:"category",fieldLabel:Signavio.I18N.Glossary_Support.category,displayField:"label",valueField:"value",hideTrigger:k===false,disabled:k===false,value:l,store:this.getCategoryStore(),listeners:{change:function(n,o){if(g instanceof Function){g(o);}},select:function(n,o){if(g instanceof Function){g(o.get("value"));}}}}));f.push(Ext.ux.form.FieldFactory.generate("MetaDataGlossaryLink",{dataField:"title",itemCls:"x-no-margin",fieldLabel:Signavio.I18N.Glossary_Support.title,value:m.title||"",showEmptyItems:true,forceSelection:false,hiddenItems:h?[h.id]:[],getSearchQuery:function(){var o=" "+this.getRawValue().slice(0,this.getCursorPosition()).toLowerCase().replace(/\s+/g," ")+" ";var n=f[3].records||[];var p=n.map(function(s){return" "+s.get("rep").title.trim().split(/\s+/g).last().toLowerCase()+" ";}).uniq();var q=0;p.each(function(r){q=o.include(r)?Math.max(o.indexOf(r)+r.length,q):q;});return o.slice(q).trim();},getValue:function(){return this.getRawValue();},onNewRecord:function(n){f[3].onSelect(n);delete this.records;}}));f.push(Ext.ux.form.FieldFactory.generate("MetaDataGlossaryLinkList",{dataField:"glossaryLinks",hideInput:true,fieldLabel:"",records:m.glossaryLinks||[],updateView:function(){var n=this.records.length===0;this.container.parent().setDisplayed(!n);f[2].container.parent()[n?"removeClass":"addClass"]("x-no-margin");},getValue:function(){var o=(this.records||[]).map(function(p){return p.get("href")||p.get("rep");});var n=(f[2].getValue()||"").strip();return o.findAll(function(p){return typeof p==="string"||p.title!==n;});}}));f.push(Ext.ux.form.FieldFactory.generate("MetaDataStringInfo",{dataField:"description",fieldLabel:Signavio.I18N.Glossary_Support.description,lineWrap:true,value:m.description||""}));f.push(Ext.ux.form.FieldFactory.generate("MetaDataUrlList",{dataField:"attachments",fieldLabel:Signavio.I18N.Glossary_Support.attachments,lineWrap:true,data:(m.attachments||[]).map(function(n){return{url:n.get("rep").url,label:n.get("rep").label,href:n.get("href")};}),itemFieldTpl:new Ext.XTemplate('<ol><tpl for="."><li><a href="{[Signavio.Utils.escapeHTML(values.url)]}" target="_blank" tabindex="-1">{[Signavio.Utils.escapeHTML(values.label||values.url)]}</a> <span class="x-smaller">(<a href="#{[xindex-1]}" class="x-remove" tabindex="-1">{[(Ext.ux.getI18N("btnRemove"))]}</a>)</span></li></tpl></ol>'),getValue:function(){var n=Ext.ux.form.UrlLinkFieldList.prototype.getValue.call(this);n=n.map(function(o){return{url:o.url,label:o.label};});return n;}}));b.getMetaData(l).each(function(q){var n=q.rep;var o=n.type+(!!n.isList?"List":"");var p=(m.metaDataValues||{})[n.id]||n.defaultValue||"";if(p instanceof Array){p=p.clone();}else{if(p instanceof Object){p=Object.clone(p);}}f.push(Ext.ux.form.FieldFactory.generate(o,Ext.apply({},Ext.apply({},{id:undefined},n),{dataField:"metaDataValues."+n.id,fieldLabel:n.name,defaultValue:n.defaultValue!==(m.metaDataValues||{})[n.id]?(n.defaultValue||""):"",value:p})));});return f.clone();},getCurrentCategory:function(f){return((e[f.getStencil().id()]||e.all||{}).category)||this.categories.getAt(0).get("href");},createNewGlossaryEntry:function(k,h,f,m){if(!k||!(k.title||"").strip()){if(h instanceof Function){h(false);}return;}var g=ORYX.CONFIG.SERVER_GLOSSARY_HANDLER;k=k||{};$H(k).keys().each(function(n){k[n]=typeof k[n]=="object"?(k[n] instanceof Array?k[n].map(function(o){return typeof o=="object"?Object.toJSON(o):o;}):Object.toJSON(k[n])):k[n];});var l=function(){new Ajax.Request(g,{method:"POST",asynchronous:true,parameters:k,onSuccess:function(o){var n=o.responseText.evalJSON();if(h instanceof Function){h(Ext.ux.data.RecordCreator.create("gitem",n.href,Object.clone(n.rep)));}}.bind(this),on409:function(){var n=Signavio.Utils.escapeHTML(k.title);Ext.Msg.confirm(Signavio.I18N.Glossary_Support.newTitle+" '"+n+"'",new Ext.XTemplate(Signavio.I18N.Glossary_Support.newError).apply({title:n}),function(o,p){if(o==="yes"){k.force=true;l();}else{if(h instanceof Function){h(false);}}}.bind(this));}.bind(this),on403:function(){Ext.Msg.alert(Signavio.I18N.Glossary_Support.noWritePerm,Signavio.I18N.Glossary_Support.noWritePermDesc);}});}.bind(this);l();},extractInfo:function(f,h){var g={};if(f&&f.properties&&h){g.title=f.properties[h]||"";}if(f&&f.category){g.category=f.category;}return g;},hasWriteRight:function(){var f=this.categories.data.items.find(function(g){return g.get("rel")=="priv";});return !f||f.get("rep").any(function(g){return g.rep.privilege=="glossary.write";});},showNewWindow:function(l,f,r,h){if(!this.hasWriteRight()){if(r instanceof Function){r(false);}Ext.Msg.alert(Signavio.I18N.Glossary_Support.noRightTitle,Signavio.I18N.Glossary_Support.noRightDescription).setIcon(Ext.Msg.INFO).getDialog().syncSize();return;}var n=function(s){if(p.currentCategory===s){return;}p.currentCategory=s;p.body.fadeOut({duration:0.3,callback:function(){var v=this.extractParams(p.items);p.items.each(function(x){if(x instanceof Ext.ux.form.GlossaryField&&x.dataField&&x.records){v[x.dataField]=x.records;}});var t=this.getFieldItems(q,s,v,n);for(var u=p.items.items.length-1;u>=0;--u){p.remove(p.items.get(u));}delete p.items;p.body.update();p.add.apply(p,t);p.body.show();p.body.setOpacity(0.01);p.doLayout();p.updateSize();p.doLayout();p.body.fadeIn({duration:0.3});}.bind(this)});}.bind(this);var o=this;var q=undefined;var k=this.extractInfo(l,f);var g=(k.category||this.getCurrentCategory(l)||"").split("=").last();var m=this.getFieldItems(q,g,k,n,h);var p=new Ext.Window({currentCategory:g,title:Signavio.I18N.Glossary_Support.newTitle,modal:true,cls:"x-glossary-new",bodyStyle:"padding:10px;position:relative;overflow-x:hidden;overflow-y:auto;",width:Math.max((window.innerWidth||document.body.offsetWidth||0)*0.5,450),height:Math.max((window.innerHeight||document.body.offsetHeight||0)*0.8,450),minHeight:450,minWidth:450,layout:"form",labelWidth:150,onEsc:function(){},updateSize:function(){var u=this.getInnerWidth()-this.body.getPadding("lr")-this.labelWidth-25;this.items.items.invoke("setWidth",u);var s=this.getInnerHeight()-this.body.getPadding("tb")-20;var t=this.items.items.partition(function(v){return v instanceof Ext.form.TextArea;});if(t[0].length===0){return;}t[1].each(function(x){if(!x.rendered||!x.el){return;}var v=(x.container&&x.container!==this.body?x.container.parent():x.el);s-=v.getHeight()+v.getPadding("tb")+v.getMargins("tb");}.bind(this));t[0].invoke("setSize",u,Math.max(s/t[0].length,90));},defaults:{width:300,labelStyle:"text-align:right;width:150px;"},show:function(){Ext.Window.prototype.show.apply(this,arguments);this.updateSize();},listeners:{resize:function(){this.updateSize();},close:function(){if(r instanceof Function){r(false);}}},items:m,buttons:[{text:Signavio.I18N.Glossary_Support.createButton,handler:function(){p.buttons.each(function(u){u.disable();});var t=o.extractParams(p.items);var s=function(x){if(x){this.ownerCt.destroy();if(r instanceof Function){r(x);}else{if(l&&f){var v=l.properties[f];var u=x.get("rep").title;if(!v){v=u;}o.setProperty(l,f,v,{glossary:x.get("rep").id,isDirty:o.checkGlossaryIsDirty(v,u)});}}}else{this.ownerCt.buttons.each(function(y){y.enable();});}}.bind(this);o.createNewGlossaryEntry(t,s);}},{text:Signavio.I18N.Glossary_Support.cancel,handler:function(){this.ownerCt.close();}}]});p.show();p.syncSize();window.setTimeout(function(){p.items.get(2).focus();},10);},openGlossaryInfo:function(f,h){h=h instanceof ORYX.Core.Shape?h:undefined;var g;new Ajax.Request("/p/glossary/"+f,{method:"get",asynchronous:true,requestHeaders:{"Accept":"application/json"},parameters:{originId:this.facade.getModelMetaData().parent},onSuccess:function(m){var k=m.responseText.evalJSON();var l=k.find(function(n){return n.rel=="info";});g.add(new Ext.Panel({border:false,html:new Ext.XTemplate('<div class="x-glossary-title">','<img class="x-{[values.category.toLowerCase()]} x-image" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>'+'{[Signavio.Utils.escapeHTML(values.title||"")]} ',"<span>({[Signavio.I18N.Glossary_Support[values.category]||values.category]})</span>","</div>").apply(l.rep)}));g.add(new Ext.Panel({border:false,html:b.GlossaryItem.apply(b.generateData(k))}));g.remove(g.items.get(0));g.doLayout();g.syncSize();g.center();}.bind(this),onFailure:function(){if(!h){return;}Ext.Msg.confirm(Signavio.I18N.Glossary_Support.noGlossaryEntryTitle,Signavio.I18N.Glossary_Support.noGlossaryEntryDesc,function(m){if(m=="yes"){var k=this.facade.getGlossary(h);if(!k){return;}var l=k.property.prefix()+"-"+k.property.id();var n=h.properties[l];this.setProperty(h,l,n);this.updateGlossaryUI(h);}}.bind(this));g.close();}.bind(this)});g=new Ext.Window({title:Signavio.I18N.Glossary_Support.previewTitle,modal:false,cls:"x-glossary-preview",bodyStyle:"background:white;padding:10px;max-height:"+(Math.max((window.document.height||0)-300,200))+"px;overflow:hidden;",autoScroll:true,width:530,minHeight:200,minWidth:300,items:[new Ext.Panel({border:false,html:"<div class='x-msg-loading'>"+Signavio.I18N.Glossary_Support.waiting+"</div>"})],buttons:[h?new Ext.LinkButton({style:"color:white;display:block;font-size:11px;position:relative;",text:Signavio.I18N.Glossary_Support.removeLink,click:function(){Ext.Msg.confirm(Signavio.I18N.Glossary_Support.removeTitle,Signavio.I18N.Glossary_Support.removeDesc,function(m){if(m=="yes"){var k=this.facade.getGlossary(h);if(!k){return;}var l=k.property.prefix()+"-"+k.property.id();var n=h.properties[l];this.setProperty(h,l,n);this.updateGlossaryUI(h);g.close();}}.bind(this));}.bind(this)}):undefined,new Ext.LinkButton({style:"color:white;display:block;font-size:11px;position:relative;",text:Signavio.I18N.Glossary_Support.openGlossary,url:ORYX.CONFIG.SERVER_GLOSSARY_HANDLER+"?originId="+this.facade.getModelMetaData().parent+"#gitem="+f,click:function(){window.open(ORYX.CONFIG.SERVER_GLOSSARY_HANDLER+"?originId="+this.facade.getModelMetaData().parent+"#gitem="+f);g.close();}.bind(this)}),{text:Signavio.I18N.Glossary_Support.close,handler:function(){this.ownerCt.close();}}].compact()});g.show();},setProperty:function(g,h,l,f){var k=ORYX.Core.Command.extend({construct:function(m,n,p,o){this.selectedElements=o.getSelection();this.shape=m;this.key=n;this.prop=m.getStencil().property(n);this.oldValue=m.properties[n];this.value=p;this.facade=o;this.glossary=f;this.oldGlossary=this.facade.hasGlossaryExtension?this.facade.getGlossary(m,this.prop):null;},execute:function(){if(this.facade.hasGlossaryExtension){if(this.glossary){var n=this.glossary.glossary;var m=!!this.glossary.isDirty;this.facade.setGlossary(this.shape,this.prop,n,this.value,m);}else{this.facade.setGlossary(this.shape,this.prop);}}this.shape.setProperty(this.key,this.value);this.facade.setSelection(this.selectedElements);},rollback:function(){if(this.facade.hasGlossaryExtension){if(this.oldGlossary){var m=this.oldGlossary;this.facade.setGlossary(this.shape,this.prop,m.glossary,m.text,m.isDirty);}else{this.facade.setGlossary(this.shape,this.prop);}}this.shape.setProperty(this.key,this.oldValue);this.facade.setSelection(this.selectedElements);}});this.facade.executeCommands([new k(g,h,l,this.facade)]);}});var b={};b.Renderer={};b.ListSeparator=", ";b.Renderer.MetaDataStringInfo="{[Signavio.Utils.escapeHTML(values.value)]}";b.Renderer.MetaDataStringInfoList='<ol><tpl for="values.value"><li>{[Signavio.Utils.escapeHTML(values)]}</li></tpl></ol>';b.Renderer.MetaDataBoolean='<img src="/explorer/src/img/famfamfam/check_small.png" style="background:white;opacity:0.6;" />';b.Renderer.MetaDataUrl='<div class="x-inline">'+'<img class="x-image x-attachment" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>'+'<a href="{[unescape(values.url)]}" target="_blank">{[Signavio.Utils.escapeHTML((values.label||"").strip()||values.url)]}</a>'+"</div>";b.Renderer.MetaDataUrlList='<tpl for="values.value">'+'<div class="x-inline">'+'<img class="x-image x-attachment" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>'+'<a href="{[unescape(values.url)]}" target="_blank">{[Signavio.Utils.escapeHTML((values.label||"").strip()||values.url)]}</a>'+'<tpl if="xindex!==xcount">'+b.ListSeparator+"</tpl>"+"</div>"+"</tpl>";b.Renderer.MetaDataAttachmentList='<tpl for="values.value">'+'<div class="x-inline">'+'<img class="x-image x-attachment" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>'+'<a href="{[unescape(values.url)]}" target="_blank">{[Signavio.Utils.escapeHTML((values.value||"").strip()||values.url)]}</a>'+'<tpl if="xindex!==xcount">'+b.ListSeparator+"</tpl>"+"</div>"+"</tpl>";b.Renderer.MetaDataLinkInfoList='<tpl for="values.value">'+'<div class="x-inline">'+'<img class="x-image x-attachment" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>'+'<a href="{[unescape(values.url)]}" target="_blank">{[Signavio.Utils.escapeHTML((values.value||"").strip()||values.url)]}</a>'+'<tpl if="xindex!==xcount">'+b.ListSeparator+"</tpl>"+"</div>"+"</tpl>";b.Renderer.MetaDataLinkModelInfoList='<tpl for="values.value">'+'<div class="x-inline">'+'<img class="x-image x-model-link" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>'+'<a href="{url}" target="_blank">{[Signavio.Utils.escapeHTML(values.value||"").strip()||values.url]}</a>'+" <span>({type})</span>"+'<tpl if="xindex!==xcount">'+b.ListSeparator+" </tpl>"+"</div>"+"</tpl>";b.Renderer.MetaDataGlossaryLink='<div class="x-inline">'+'<img class="x-{[values.category.toLowerCase()]} x-image" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>'+'<a href="{[ORYX.CONFIG.SERVER_GLOSSARY_PREFIX]}{id}" target="_blank" class="x-glossary-link-a">{[Signavio.Utils.escapeHTML(values.title||"").strip()||values.id]}</a>'+"</div>";b.Renderer.MetaDataGlossaryLinkList='<tpl for="values.value">'+'<div class="x-inline">'+'<img class="x-{[values.category.toLowerCase()]} x-image" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>'+'<a href="{[ORYX.CONFIG.SERVER_GLOSSARY_PREFIX]}{id}" target="_blank" class="x-glossary-link-a">{[Signavio.Utils.escapeHTML(values.title||"").strip()||values.id]}</a>'+'<tpl if="xindex!==xcount">'+b.ListSeparator+"</tpl>"+"</div>"+"</tpl>";b.GlossaryItem=new Ext.XTemplate("<table>",'<tpl for=".">','<tr class="x-{type} {[values.cls||""]}">',"<th>","{labelName}:","</th>","<td>",'<tpl if="!values.type">',b.Renderer.MetaDataStringInfo,"</tpl>",$H(b.Renderer).keys().map(function(f){return"<tpl if=\"values.type == '"+f+"'\">"+(b.Renderer[f]||b.Renderer.MetaDataStringInfo)+"</tpl>";}).join(""),"</td>","</tr>","</tpl>",'<tpl if="values.length===0">','<tr class="x-no-data"><td><div>{[Signavio.I18N.Glossary_Support.noData]}</div></td></tr>',"</tpl>","</table>");b.getMetaData=function(f){if(!this.meta){new Ajax.Request("/p/meta",{method:"GET",asynchronous:false,onSuccess:function(g){this.meta=(g.responseText||"").evalJSON();}.bind(this)});}if(this.meta instanceof Array){return this.meta.findAll(function(g){return g&&g.rep&&g.rep.glossaryBindings instanceof Array&&g.rep.glossaryBindings.any(function(h){return h&&h.category&&h.category.endsWith(f);});}).sortBy(function(g){var h=(g.rep.glossaryBindings||[]).find(function(k){return k.category&&k.category.endsWith(f);});return h?h.order:0;});}else{return[];}};b.generateData=function(m){var g=m.find(function(t){return t.rel=="info";});var n=m.find(function(t){return t.rel=="att";});var o=m.find(function(t){return t.rel=="link";});var l=m.find(function(t){return t.rel=="glossarylink";});var s=window.location.search.replace("?id=","");var p=[];o.rep=o.rep.findAll(function(t){if(t.rep.model===s||p.include(t.rep.model)){return false;}else{p.push(t.rep.model);return true;}});var r=[];if(g&&g.rep.description){r.push({labelName:Signavio.I18N.Glossary_Support.description,type:"MetaDataStringInfo",value:g.rep.description});}if(n&&n.rep.length>0){r.push({labelName:Signavio.I18N.Glossary_Support.attachments,type:"MetaDataAttachmentList",value:n.rep.map(function(t){return{url:t.rep.url,value:t.rep.label};})});}if(l&&l.rep.length>0){var f=g.rep.title;r.push({labelName:Signavio.I18N.Glossary_Support.linkedGlossaryItems,type:"MetaDataGlossaryLinkList",value:l.rep.map(function(t){return{id:t.rep.id,title:t.rep.title,category:t.rep.category};}).sort(function(A,y){var C=(A.title||"").split(/\s+/g);var B=(y.title||"").split(/\s+/g);var u=f.indexOf(C.first())+1,t=f.indexOf(C.last())+1;var z=f.indexOf(B.first())+1,x=f.indexOf(B.last())+1;var v=Math.min.apply(Math,[u||null,t||null,z||null,x||null].compact());if(Number.POSITIVE_INFINITY===v){return -1;}else{if(v===u||v===t){return -1;}else{return 1;}}})});}if(g&&g.rep.metaDataValues){var k=g.rep.metaDataValues;var q=function(t){if(t===undefined||t===null){return true;}else{if(t instanceof Array){return t.length===0;}else{if(t instanceof Object){return $H(t).keys().length===0;}else{if(typeof t==="string"){return !(t.trim());}else{if(typeof t==="number"){return false;}else{if(!t){return true;}}}}}}};this.getMetaData(g.rep.category).each(function(t){if(!q(k[t.rep.id])||t.rep.defaultValue){r.push(Ext.apply({},typeof k[t.rep.id]=="object"?k[t.rep.id]:{},{labelName:t.rep.name,type:t.rep.type+(!!t.rep.isList?"List":"")||"MetaDataStringInfo",value:k[t.rep.id]!==undefined?k[t.rep.id]:t.rep.defaultValue,cls:k[t.rep.id]===undefined?"x-default":""}));}});}if(o&&o.rep.length>0){var h=[];r.push({labelName:Signavio.I18N.Glossary_Support.linkedModels,type:"MetaDataLinkModelInfoList",value:o.rep.map(function(t){return{url:ORYX.CONFIG.SERVER_PUBLISHER_HANDLER+"/"+t.rep.model,value:t.rep.name,type:t.rep.type};}).findAll(function(t){if(h.include(t.url)){return false;}else{h.push(t.url);return true;}})});}r.each(function(t){if(typeof t.value==="string"){t.value=t.value.gsub("\n","<br/>");}});return r;};}();if(!Signavio){var Signavio=new Object();}if(!Signavio.Plugins){Signavio.Plugins=new Object();}new function(){Signavio.Plugins.GlossaryRename=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.editorInitialized=false;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){this.editorInitialized=true;}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.propertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.onFinish.bind(this));},onFinish:function(){this.facade.getCanvas().getChildShapes(true).each(function(a){a.properties.each(function(b){this.propertyChanged({name:b.key,value:b.value},a,true);}.bind(this));}.bind(this));this.facade.getCanvas().update();},isGlossaryEntry:function(a){return a&&!!(a+"").match(/\glossary\:\/\/.+\/[\w\W]+\;\;/g);},getGlossaryText:function(a){return(a||"").replace(/;;$/,"").replace(/\glossary\:\/\/.+?\//g,"");},getGlossaryId:function(a){return(a||"").split(";;").invoke("replace",/\glossary\:\/\//g,"").invoke("replace",/\/[\w\W]+/g,"").first();},propertyChanged:function(c,e,d){var b=c.name;var f=c.value||"";if(!b||(typeof f!=="string"&&!(f instanceof Array))){return;}var a;if(f instanceof Array){a=f.map(function(g,h){return this.checkProperty(g,b,e,h===0);}.bind(this));if(f.length==0&&this.facade.hasGlossaryExtension){this.facade.setGlossary(e,e.getStencil().property(b));}}else{a=this.checkProperty(f,b,e,true);}if(a&&a!==f&&(!(a instanceof Array)||a.toJSON()!==f.toJSON())){e.setProperty(b,a,true);if(d!==true&&this.editorInitialized){this.facade.getCanvas().update();}}},checkProperty:function(e,b,c,g){if(this.isGlossaryEntry(e)){var f=this.getGlossaryText(e);var a=this.getGlossaryId(e);var d=!!c.hiddenProperties[b+ORYX.CONFIG.GLOSSARY_PROPERTY_DIRTY_SUFFIX];if(this.facade.hasGlossaryExtension&&g){this.facade.setGlossary(c,c.getStencil().property(b));}if(this.facade.hasGlossaryExtension){this.facade.setGlossary(c,c.getStencil().property(b),a,f,d);}return f;}else{if(this.facade.hasGlossaryExtension&&!e&&this.facade.hasGlossary(c,b)&&g){this.facade.setGlossary(c,c.getStencil().property(b));}}return e;}});}();if(!Signavio){var Signavio={};}if(!Signavio.Plugins){Signavio.Plugins={};}new function(){Signavio.Plugins.RichtextToolbar=ORYX.Plugins.AbstractPlugin.extend({_richtextButtons:$w("fontSizeBox boldButton italicButton colorButton"),_utilityButtons:$w("clearButton copyStyleButton"),facade:undefined,construct:function(a){this.facade=a;this.rotator=0;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.handleSelectionChanged.bind(this));this.buttons=this.getRichtextButtons();this.fontColorHint=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",undefined,this.getColorHint());this.borderColorHint=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",undefined,this.getColorHint());this.backgroundColorHint=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",undefined,this.getColorHint());this.richtextButton={name:Signavio.I18N.Richtext.richtext,description:Signavio.I18N.Richtext.richtextDesc,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/fugue/icons/"+(Ext.isIPad?"32x32/":"")+"edit.png",group:"richtext",cls:"x-btn-icon",menuConfig:{menuItems:$H(this.buttons).values(),cls:"y-horizontal-menu"+(Ext.isIPad?" y-horizontal-menu-ipad":""),enableButtons:function(){this.handleSelectionChanged();}.bind(this)},toggle:function(b){b=b===undefined?!this.pressed:b;if(b!=this.pressed){if(b){this.el.addClass("y-richtext-toolbar-button-expanded"+(Ext.isIPad?" y-richtext-toolbar-button-expanded-ipad":""));if(this.overlay){this.overlay.show();}this.pressed=true;this.fireEvent("toggle",this,true);}else{this.el.removeClass("y-richtext-toolbar-button-expanded"+(Ext.isIPad?" y-richtext-toolbar-button-expanded-ipad":""));if(this.overlay){this.overlay.hide();}this.pressed=false;this.fireEvent("toggle",this,false);}if(this.toggleHandler){this.toggleHandler.call(this.scope||this,this,b);}}if(!this.toolbar&&this.pressed){this.initToolbar(this,this.menuConfig);}else{if(this.toolbar&&this.pressed){this.toolbar.show();}else{if(this.toolbar){this.toolbar.hide();}}}}};this.facade.offer(this.richtextButton);},handleOneShapeSelected:function(a,c,h,g,f){if(!a){a=this.facade.getSelection();}if(!c){c=this.getNodes(a);}if(!h){h=this.getLabels(a);}if(!g){g=this.getBackgroundIds(a);}if(!f){f=this.getBorderIds(a);}this.setFontSizeDisplayText(a,h);var b=this.checkForBorderColorCapability(a,h,f);if(!b){this.removeBorderColorHint();}var e=this.checkForBackgroundCapability(a,c,h,g);if(!e){this.removeBackgroundColorHint();}var d=this.checkForRichtextCapability(a,c,h,g);if(!d){this.removeColorHint();}this.enableUtilityButtons();},handleMultipleShapesSelected:function(a,c,h,g,f){if(!a){a=this.facade.getSelection();}if(!c){c=this.getNodes(a);}if(!h){h=this.getLabels(a);}if(!g){g=this.getBackgroundIds(a);}if(!f){f=this.getBorderIds(a);}var b=this.checkForBorderColorCapability(a,h,f);if(!b){this.removeBorderColorHint();}var e=this.checkForBackgroundCapability(a,c,h,g);if(!e){this.removeBackgroundColorHint();}var d=this.checkForRichtextCapability(a,c,h,g);if(!d){this.removeColorHint();}this.hideValuesOfStyleButtons(a,h,false);if(c.length===0){this.disableButton("bgColorButton");}else{if(c.length===1){this.enableButton("bgColorButton");}}this.enableUtilityButtons();},checkForBackgroundCapability:function(a,c,e,d){if(!a){a=this.facade.getSelection();}if(!c){c=this.getNodes(a);}if(!e){e=this.getLabels(a);}if(!d){d=this.getBackgroundIds(a);}c=c.findAll(function(f){return f instanceof ORYX.Core.Node&&f.getStencil().properties().find(function(g){return g.isBackgroundColor()&&!g.readonly();});});if(c.length===0||c.length===1&&d[c[0].getId()]===undefined){this.disableButton("bgColorButton");return false;}else{var b=this.getColor(c[0],d);if(c.length>1&&c.without(c[0]).find(function(f){return b!==this.getColor(f,d);}.bind(this))){b=undefined;}this.enableButton("bgColorButton");if(b){this.setColorToHintBox(this.backgroundColorHint,b);if(!this.backgroundColorHint.parentNode){this.showBackgroundColorHint();}return true;}return false;}},checkForBorderColorCapability:function(a,d,c){if(!a){a=this.facade.getSelection();}if(!d){d=this.getLabels(a);}if(!c){c=this.getBorderIds(a);}a=a.findAll(function(e){return e.getStencil().properties().find(function(f){return f.isBorderColor()&&!f.readonly();});});if(a.length===0||a.length===1&&c[a[0].getId()]===undefined){this.disableButton("borderColorButton");return false;}else{var b=this.getColor(a[0],c);if(a.length>1&&a.without(a[0]).find(function(e){return b!==this.getColor(e,c);}.bind(this))){b=undefined;}this.enableButton("borderColorButton");if(b){this.setColorToHintBox(this.borderColorHint,b);if(!this.borderColorHint.parentNode){this.showBorderColorHint();}return true;}return false;}},checkForRichtextCapability:function(a,c,e,d){if(!a){a=this.facade.getSelection();}if(!c){c=this.getNodes(a);}if(!e){e=this.getLabels(a);}if(!d){d=this.getBackgroundIds(a);}if(e.length===0){this.disableRichtextButtons();return false;}else{var b=e[0].getFill();if(e.length>1&&e.without(e[0]).find(function(f){return b!==f.getFill();}.bind(this))){b=undefined;}this.enableRichtextButtons();if(b){this.setColorToHintBox(this.fontColorHint,b);if(!this.fontColorHint.parentNode){this.showColorHint();}this.setValuesOfStyleButtons(a,e);return true;}this.setValuesOfStyleButtons(a,e);return false;}},enableButton:function(a){if(a&&this.buttons[a]){this.buttons[a].buttonInstance.setPreventFromEnable(false);this.buttons[a].buttonInstance.enable();if(a==="colorButton"){this.setColorToHintBox(this.fontColorHint,"");this.showColorHint();}else{if(a==="bgColorButton"){this.setColorToHintBox(this.backgroundColorHint,"");this.showBackgroundColorHint();}else{if(a==="borderColorButton"){this.setColorToHintBox(this.borderColorHint,"");this.showBorderColorHint();}}}}},disableButton:function(a){if(a&&this.buttons[a]){this.buttons[a].buttonInstance.setPreventFromEnable(true);this.buttons[a].buttonInstance.disable();if(a==="colorButton"){this.removeColorHint();}else{if(a==="bgColorButton"){this.removeBackgroundColorHint();}}}},disableRichtextButtons:function(){this._richtextButtons.each(function(a){this.disableButton(a);}.bind(this));},enableRichtextButtons:function(){this._richtextButtons.each(function(a){this.enableButton(a);}.bind(this));},enableUtilityButtons:function(){this._utilityButtons.each(function(a){this.enableButton(a);}.bind(this));},resetComboBox:function(a){if(a){a.buttonInstance.collapse();a.buttonInstance.reset();}},setValuesOfStyleButtons:function(a,b){if(!b){var b=this.getLabels(a);}this.isChanging=true;if(b.length>0){this.setFontSizeDisplayText(a,b);this.buttons.boldButton.buttonInstance.toggle(b[0].getBold());this.buttons.italicButton.buttonInstance.toggle(b[0].getItalic());}else{this.buttons.fontSizeBox.buttonInstance.setValue(12);this.buttons.boldButton.buttonInstance.toggle(false);this.buttons.italicButton.buttonInstance.toggle(false);}delete this.isChanging;},hideValuesOfStyleButtons:function(a,c,b){if(this.isCopyingStyles){this.buttons.copyStyleButton.buttonInstance.setPreventFromDisable(true);}else{this.buttons.copyStyleButton.buttonInstance.setPreventFromDisable(false);}this.isChanging=true;this.setFontSizeDisplayText(a,c);if(b){this.buttons.boldButton.buttonInstance.toggle(false);this.buttons.italicButton.buttonInstance.toggle(false);}delete this.isChanging;},setFontSizeDisplayText:function(a,c){if(!c){var c=this.getLabels(a);}var b=" ";switch(a.length){case 0:break;case 1:if(c.length>0){b=c[0].getFontSize();}break;default:if(c.length>0){b=c[0].getFontSize();if(c.without(c[0]).find(function(d){return d.getFontSize()!==b;})){b=" ";}}break;}this.buttons.fontSizeBox.buttonInstance.setValue(b);},getFontSizeComboBox:function(){var a=new Ext.data.SimpleStore({fields:["value","displayName"],data:[["8",8],["9",9],["10",10],["11",11],["12",12],["14",14],["18",18],["20",20],["24",24],["36",36],["48",48],["72",72]]});return new Ext.ux.form.ComboBox({mode:"local",tooltip:Signavio.I18N.Richtext.fontSizeDesc,tooltipType:"title",store:a,displayField:"displayName",mode:"local",triggerAction:"all",emptyText:"12",editable:false,disableKeyFilter:true,forceSelection:true,width:40,height:18,listWidth:25,iconCls:"no-icon",cls:Ext.isChrome?"y-richtext-combobox-chrome":"y-richtext-combobox",ctCls:(Ext.isIE9?"y-richtext-combobox-ct-ie9":"y-richtext-combobox-ct")+" y-richtext-toolbar-button",listeners:{"select":function(c,b){this.changeFont(c,"FontSize",b.data.value);}.bind(this)}});},getFontComboBox:function(){var a=new Ext.data.SimpleStore({fields:["font","displayName"],data:[["Arial","Arial"],["Courier New","Courier New"],["Helvetica","Helvetica"],["Tahoma","Tahoma"],["Verdana","Verdana"]]});return new Ext.form.ComboBox({store:a,displayField:"displayName",mode:"local",triggerAction:"all",emptyText:Signavio.I18N.Richtext.selectFont,selectOnFocus:true,width:135,listWidth:120,iconCls:"no-icon",tpl:'<tpl for="."><div style="font-family:{font}" class="x-combo-list-item">{displayName}</div></tpl>',listeners:{"select":function(c,b){this.changeFont(c,"Font",b.data.font);}.bind(this)}});},getColorHint:function(){return["div",{"class":Ext.isIPad?"y-richtext-color-hint-ipad":Ext.isOpera?"y-richtext-color-hint-opera":"y-richtext-color-hint"}];},getColorBox:function(a){return["div",{"class":"y-richtext-color-box",style:"background: none repeat scroll 0 0 "+a+";"}];},hideColorHints:function(){this.removeColorHint();this.removeBackgroundColorHint();this.removeBorderColorHint();},showColorHint:function(){this.buttons.colorButton.buttonInstance.el.dom.parentNode.appendChild(this.fontColorHint);},removeColorHint:function(){if(this.fontColorHint.parentNode){this.buttons.colorButton.buttonInstance.el.dom.parentNode.removeChild(this.fontColorHint);}},showBackgroundColorHint:function(){this.buttons.bgColorButton.buttonInstance.el.dom.parentNode.appendChild(this.backgroundColorHint);},removeBackgroundColorHint:function(){if(this.backgroundColorHint.parentNode){this.buttons.bgColorButton.buttonInstance.el.dom.parentNode.removeChild(this.backgroundColorHint);}},showBorderColorHint:function(){this.buttons.borderColorButton.buttonInstance.el.dom.parentNode.appendChild(this.borderColorHint);},removeBorderColorHint:function(){if(this.borderColorHint.parentNode){this.buttons.borderColorButton.buttonInstance.el.dom.parentNode.removeChild(this.borderColorHint);}},setColorToHintBox:function(b,a){if(b&&b.style&&a){b.style.background="none repeat scroll 0% 0% "+a;}},changeFont:function(d,c,g,f,b){if(this.isChanging){return;}var a=this.facade.getSelection();var e=this.getLabels(a);if(e.length>0&&a.length>0&&!a.find(function(l){return l.editing;})){var h={},k={};e.each(function(l){var m=l.getStyle();h[l.id]=l["get"+c]();k[l.id]=(["bold","italic"].include(g)?b:g);}.bind(this));this.executeStyle(a,e,c,h,k,true);}if(c==="Fill"){this.setColorToHintBox(this.fontColorHint,g);}},getLabels:function(a){return a.map(function(c){var d=c.getLabels();var b=c.getStencil().properties().invoke("refToView").flatten();return d.findAll(function(e){return b.any(function(f){return e.id==c.id+f;});});}).flatten().compact();},getBackgroundIds:function(a){var b=[];a.each(function(c){var f=c.getId(),e;var d=c.getStencil().properties().find(function(g){return g.isBackgroundColor()&&!g.readonly();});if(d){e=d.id();}return b[f]=e;});return b;},getBorderIds:function(a){var b=[];a.each(function(d){var f=d.getId(),e;var c=d.getStencil().properties().find(function(g){return g.isBorderColor()&&!g.readonly();});if(c){e=c.id();}return b[f]=e;});return b;},getTexts:function(b){var a={};b.each(function(c){a[c.id]=c.text();});return a;},getNodes:function(a){return a.findAll(function(b){return b instanceof ORYX.Core.Node;});},executeStyle:function(d,g,e,k,m,c,h,a){if(k!==m){var l=this.facade;var b=ORYX.Core.Command.extend({construct:function(){this.force=c;this.facade=l;this.shapes=d;this.labels=g;this.attribute=e;this.oldValues=k;this.newValues=m;this.shapeChangeIds=h;this.shapeChanges=a;},execute:function(){if(this.labels){this.labels.each(function(n){n["set"+this.attribute](this.newValues[n.id]);n.update(this.force);}.bind(this));}if(this.shapeChanges&&this.shapes instanceof Array){this.shapes.each(function(n){var o=n.getId();if(this.newValues[o]&&this.newValues[o]!==undefined&&this.shapeChangeIds[o] instanceof Array){this.shapeChangeIds[o].each(function(p){n.setProperty("oryx-"+p,(this.newValues[n.id][p]==="none"?"":this.newValues[n.id][p]));}.bind(this));}}.bind(this));}if(this.executeAgain){this.facade.setSelection(d);this.facade.getCanvas().update();this.facade.updateSelection();}else{this.facade.getCanvas().update();}this.executeAgain=true;},rollback:function(){if(this.labels){this.labels.each(function(n){n["set"+this.attribute](this.oldValues[n.id]);n.update(this.force);}.bind(this));}if(this.shapeChanges&&this.shapes instanceof Array){this.shapes.each(function(n){var o=n.getId();if(k[o]&&k[o]!==undefined&&this.shapeChangeIds[o] instanceof Array){this.shapeChangeIds[o].each(function(p){n.setProperty("oryx-"+p,(this.oldValues[n.id][p]==="none"?"":this.oldValues[n.id][p]));}.bind(this));}}.bind(this));}this.facade.setSelection(d);this.facade.getCanvas().update();this.facade.updateSelection();}});var f=new b();this.facade.executeCommands([f]);}},_replaceStyle:function(b,a,c){return b.replace(new RegExp(""+a+":[^;]+;","gi"),a+":"+c+";");},changeColor:function(g,d,b,f){if(this.colorMenu){this.colorMenu.destroy();delete this.colorMenu;}if(f){var a=this.facade.getSelection();if(a.length>0){var e=(d==="BackgroundColor"?this.getDefaultBackgroundColor(a[0],(this.getBackgroundIds(a))||[]):d==="BorderColor"?this.getDefaultBorderColor(a[0],(this.getBorderIds(a))||[]):"#000000");var c=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",undefined,this.getColorBox(e));this.colorMenu=new Ext.menu.ColorMenu({cls:"y-richtext-color-menu",allowOtherMenus:false,items:[{text:Signavio.I18N.Richtext.defaultColor,cls:"y-richtext-color-menu-default-color-button",listeners:{"render":function(h,k){h.el.dom.appendChild(c);}.bind(this)}},"-"]});this.colorMenu.on("itemclick",function(k,h){g(k.component?"#"+k.component.value:e);delete this.colorMenu;}.bind(this));this.colorMenu.show(b.el,"tl-bl?");}}},setBackgroundColor:function(h,e,f){var b=this.facade.getSelection().findAll(function(k){return k instanceof ORYX.Core.Node&&k.getStencil().properties().find(function(l){return l.isBackgroundColor()&&!l.readonly();});});var g=this.getBackgroundIds(b);var a=[],c=[],d=[];b.each(function(k){var m=k.getId()||k.id;var l=g[m];a[m]=[];c[m]=[];a[m][l]=k.properties["oryx-"+l];c[m][l]=f;d[m]=[l];}.bind(this));this.setColorToHintBox(this.backgroundColorHint,f);this.executeStyle(b,[],e,a,c,true,d,true);},setBorderColor:function(f,b,g){var a=this.facade.getSelection().findAll(function(l){return l.getStencil instanceof Function&&l.getStencil().properties().find(function(m){return m.isBorderColor()&&!m.readonly();});});var d=a.findAll(function(l){return l.getStencil instanceof Function&&(l.getStencil().idWithoutNs()==="Pool"||l.getStencil().idWithoutNs()==="VerticalPool");});d.each(function(m){var l=this.getLanesRecursively(m).flatten().filter(function(n){if(!n){return;}var p=this.getBorderIds([n]);if(!p){return;}var r=(n.id instanceof Function&&n.id()||n.id);var o=p[r];var q=[m.properties["oryx-"+o],this.getDefaultBorderColor(n,p)];return q.include(n.properties["oryx-"+o]);}.bind(this)).compact();a=a.concat(l);}.bind(this));a=a.flatten().compact().uniq();var e=this.getBorderIds(a);var h=[],k=[],c=[];a.each(function(l){var n=l.getId()||l.id;var m=e[n];h[n]=[];k[n]=[];h[n][m]=l.properties["oryx-"+m];k[n][m]=g;c[n]=[m];}.bind(this));this.setColorToHintBox(this.borderColorHint,g);this.executeStyle(a,[],b,h,k,true,c,true);},copyStyle:function(g,d){if(d){var c=this.facade.getSelection();var b=this.getNodes(c);var h=this.getLabels(c),f,n;this.styles={};var a=this.getBackgroundIds(b);var k=this.getBorderIds(c);c.each(function(p){var o=this.getColor(p,k);var q=this.getDefaultBorderColor(p,k);if(o===q){o="default";}if(!f){f=o;}else{if(f===o){return;}else{if(f!==o){f=undefined;throw $break;}}}}.bind(this));if(f){this.bcolorToSet=f;}b.each(function(p){var o=this.getColor(p,a);var q=this.getDefaultBackgroundColor(p,a);if(o===q){o="default";}if(!n){n=o;}else{if(n===o){return;}else{if(n!==o){n=undefined;throw $break;}}}}.bind(this));if(n){this.bgcolorToSet=n;}this.prevSelection=c;var l=h.invoke("serialize");var m=$w("bold italic fill font size"),e=[];l.each(function(o){if(o&&o.styles){m.each(function(p){if(e.include(p)){return;}if(o.styles[p]&&this.styles[p]&&o.styles[p]!==this.styles[p]){e.push(p);delete this.styles[p];}else{if(o.styles[p]&&!this.styles[p]){this.styles[p]=o.styles[p];}}}.bind(this));}}.bind(this));this.isCopyingStyles=true;}else{this.buttons.copyStyleButton.buttonInstance.setPreventFromDisable(false);this.buttons.copyStyleButton.buttonInstance.disable();delete this.prevSelection;delete this.isCopyingStyles;delete this.bcolorToSet;delete this.bgcolorToSet;delete this.styles;}},clearFormat:function(){var b=this.facade.getSelection();var c=this.getNodes(b);var g=this.getLabels(b);var a=[],d=[];var e=this.getBorderIds(b);b.each(function(h){var k=h.getId()||h.id;d[k]=this.getDefaultBorderColor(h,e);}.bind(this));var f=this.getBackgroundIds(c);c.each(function(h){var k=h.getId()||h.id;a[k]=this.getDefaultBackgroundColor(h,f)||"none";}.bind(this));if(b.length>0&&c.length>0){this.setColorToHintBox(this.fontColorHint,"black");this.setColorToHintBox(this.backgroundColorHint,a[c[0].getId()]);}if(b.length>0){this.setColorToHintBox(this.borderColorHint,d[b[0].getId()]);}this.setNewStylesToSelection(b,c,g,e,f,d,a,{});},getColor:function(a,b){var c=a.getId()||a.id;if(c&&b[c]){return a.properties["oryx-"+b[c]];}else{return undefined;}},getDefaultBackgroundColor:function(a,b){var d=a.getId()||a.id;if(d&&b[d]){var c=a.getStencil().property("oryx-"+b[d]);return c?c.value():undefined;}return undefined;},getDefaultBorderColor:function(a,b){var d=a.getId()||a.id;if(d&&b[d]){var c=a.getStencil().property("oryx-"+b[d]);return c?c.value():undefined;}return undefined;},getRichtextButtons:function(){return{fontSizeBox:{name:Signavio.I18N.Richtext.fontSize,isComboBox:true,comboBox:this.getFontSizeComboBox.bind(this),ctCls:"y-horizontal-menu-button",keepFocus:true,group:"richtext",index:2,minShape:1},boldButton:{name:Signavio.I18N.Richtext.bold,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/fugue/icons"+(Ext.isIPad?"/24x24":"")+"/edit-bold.png",functionality:this.changeFont.bind(this,undefined,"Bold","bold"),toggle:true,ctCls:"y-horizontal-menu-button",group:"richtext",index:3,minShape:1,description:Signavio.I18N.Richtext.boldDesc},italicButton:{name:Signavio.I18N.Richtext.italic,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/fugue/icons"+(Ext.isIPad?"/24x24":"")+"/edit-italic.png",functionality:this.changeFont.bind(this,undefined,"Italic","italic"),toggle:true,ctCls:"y-horizontal-menu-button",group:"richtext",index:4,minShape:1,description:Signavio.I18N.Richtext.italicDesc},colorButton:{name:Signavio.I18N.Richtext.color,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img"+(Ext.isIPad?"/fugue/new/24x24/color.png":"/fugue/new/edit-color.png"),functionality:this.changeColor.bind(this,this.changeFont.bind(this,undefined,"Fill"),"Fill"),keepFocus:true,toggle:true,toggleGroup:"colorToggle",ctCls:"y-horizontal-menu-button",group:"richtext",index:5,minShape:1,description:Signavio.I18N.Richtext.colorDesc},borderColorButton:{name:Signavio.I18N.Richtext.bordercolor,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img"+(Ext.isIPad?"/famfamfam/24x24/pencil.png":"/fugue/new/pencil-color.png"),functionality:this.changeColor.bind(this,this.setBorderColor.bind(this,undefined,"BorderColor"),"BorderColor"),keepFocus:true,toggle:true,toggleGroup:"colorToggle",ctCls:"y-horizontal-menu-button",group:"richtext",index:6,minShape:1,description:Signavio.I18N.Richtext.borderColorDesc},bgColorButton:{name:Signavio.I18N.Richtext.bgcolor,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img"+(Ext.isIPad?"/famfamfam/24x24/paintcan.png":"/fugue/new/paint-can-color.png"),functionality:this.changeColor.bind(this,this.setBackgroundColor.bind(this,undefined,"BackgroundColor"),"BackgroundColor"),keepFocus:true,toggle:true,toggleGroup:"colorToggle",ctCls:"y-horizontal-menu-button",group:"richtext",index:7,minShape:1,description:Signavio.I18N.Richtext.bgcolorDesc},clearButton:{name:Signavio.I18N.Richtext.clear,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/fugue/icons"+(Ext.isIPad?"/24x24":"")+"/eraser.png",functionality:this.clearFormat.bind(this),keepFocus:true,ctCls:"y-horizontal-menu-button",group:"richtext",index:8,minShape:1,description:Signavio.I18N.Richtext.clearDesc},copyStyleButton:{name:Signavio.I18N.Richtext.copyStyle,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/fugue/icons"+(Ext.isIPad?"/24x24":"")+"/broom.png",functionality:this.copyStyle.bind(this),keepFocus:true,ctCls:"y-horizontal-menu-button",toggle:true,group:"richtext",index:9,minShape:1,description:Signavio.I18N.Richtext.copyStyleDesc}};},handleSelectionChanged:function(c){if(c){var a=c.elements;}else{var a=this.facade.getSelection();}var b=this.getNodes(a);var f=this.getLabels(a);var d=this.getBorderIds(a);var e=this.getBackgroundIds(a);if(this.colorMenu){this.colorMenu.destroy();delete this.colorMenu;this.buttons["colorButton"].buttonInstance.toggle(false);this.buttons["borderColorButton"].buttonInstance.toggle(false);this.buttons["bgColorButton"].buttonInstance.toggle(false);}if(this.richtextButton&&this.richtextButton.menuConfig.toolbar&&this.richtextButton.menuConfig.toolbar.rendered){if(this.buttons["fontSizeBox"].buttonInstance.isExpanded()){this.resetComboBox(this.buttons["fontSizeBox"]);}if(a.length===0){this.hideColorHints();this.hideValuesOfStyleButtons(a,f,true);}else{if(a.length===1&&!this.isCopyingStyles){this.handleOneShapeSelected(a,b,f,e);}else{if(a.length>1&&!this.isCopyingStyles){this.handleMultipleShapesSelected(a,b,f,e);}else{if(a.length>0&&this.isCopyingStyles){this.setNewStylesToSelection(a,b,f,d,e);}}}}}if(!$H(this.buttons).values()){return;}$H(this.buttons).values().each((function(g){if(!g.buttonInstance){return;}g.buttonInstance.enable();if(g.minShape&&g.minShape>a.length){g.buttonInstance.disable();}}).bind(this));},setNewStylesToSelection:function(c,b,e,h,a,d,g,k){if(!c){var c=this.handlePoolsAndLanes(this.facade.getSelection());}if(c.length===1&&c.findAll(function(o){return(this.prevSelection||[]).include(o);}.bind(this)).length===1){this.buttons.copyStyleButton.buttonInstance.toggle(false);delete this.prevSelection;delete this.isCopyingStyles;delete this.bcolorToSet;delete this.bgcolorToSet;delete this.styles;return;}if(!b){var b=this.getNodes(c);}var e=this.getLabels(c);var m=[],n=[],f=[];if(!a){var a=this.getBackgroundIds(b);}if(!h){var h=this.getBorderIds(c);}c.each(function(p){var t=p.getId()||p.id;var q=h[t],o=this.getColor(p,h);var s=a[t],r=this.getColor(p,a);m[t]=[];n[t]=[];if(q){m[t][q]=o;n[t][q]=d?d[t]:(this.bcolorToSet||this.getDefaultBorderColor(p,h));if(n[t][q]==="default"){n[t][q]=this.getDefaultBorderColor(p,h);}}if(s){m[t][s]=r;n[t][s]=g?g[t]:(this.bgcolorToSet||this.getDefaultBackgroundColor(p,a));if(n[t][s]==="default"){n[t][s]=this.getDefaultBackgroundColor(p,a);}}f[t]=[q,s].compact();}.bind(this));var l=!!c.find(function(o){return o.getStencil().id().endsWith("Pool");});e.each(function(q){var s={},t,p=false;var o=q.serialize();if(!k){if(l){t=b.find(function(u){return u.getLabels().include(q);});}if(t){p=t.getStencil().id().endsWith("Lane");}var r=$w("bold italic fill font size");r.each(function(u){if(l&&p&&o&&o.styles&&o.styles[u]){s[u]=o.styles[u];}else{if(this.styles[u]){s[u]=this.styles[u];}else{if(q.defaultStyles){s[u]=this.getDefaultValue(q,u);}else{if(o&&o.styles&&o.styles[u]){s[u]=o.styles[u];}}}}}.bind(this));}m[q.id]=Object.clone(o&&o.styles||{});n[q.id]=Object.clone(s);}.bind(this));this.executeStyle(c,e,"Style",m,n,true,f,true);this.buttons.copyStyleButton.buttonInstance.toggle(false);delete this.prevSelection;delete this.isCopyingStyles;delete this.bgcolorToSet;delete this.styles;},getDefaultValue:function(b,c){var e={size:"font-size",font:"font-family",bold:"font-weight",italic:"font-style",fill:"fill"};var a={normal:false,bold:true,italic:true};var d=b.defaultStyles[e[c]];if(!(a[d]==="undefined")){d=a[d];}else{if(typeof d==="Number"){d+="px";}}return d;},handlePoolsAndLanes:function(b){var a=[];b.each(function(c){if(b[0].getStencil().id().endsWith("Pool")){a=a.concat(this.getLanesRecursively(c).flatten().compact().uniq());}else{a.push(c);}}.bind(this));return a;},getLanesRecursively:function(a){if(typeof a.nodes==="object"&&a.nodes.length>0){return[a].concat(a.nodes.map(function(b){return this.getLanesRecursively(b);}.bind(this)));}else{if(a.getStencil instanceof Function&&["Lane","VerticalLane"].include(a.getStencil().idWithoutNs())){return[a];}else{return[];}}}});}();if(!ORYX){var ORYX={};}if(!ORYX.Plugins){ORYX.Plugins={};}if(!ORYX.CONFIG){ORYX.CONFIG={};}new function(){ORYX.Plugins.EnableRichtext2=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.init();},init:function(){if(ORYX.CONFIG){ORYX.CONFIG.RICHTEXT_2_ENABLED=true;}}});}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Toolbar=Clazz.extend({facade:undefined,plugs:[],construct:function(b,a){this.facade=b;this.groupIndex=new Hash();a.properties.each((function(c){if(c.group&&c.index!=undefined){this.groupIndex[c.group]=c.index;}}).bind(this));Ext.QuickTips.init();this.buttons=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BUTTON_UPDATE,this.onButtonUpdate.bind(this));},onButtonUpdate:function(b){var a=this.buttons.find(function(c){return c.id===b.id;});if(b.pressed!==undefined){a.buttonInstance.toggle(b.pressed);}},registryChanged:function(c){var b=c.sortBy((function(g){return((this.groupIndex[g.group]!=undefined?this.groupIndex[g.group]:"")+g.group+""+g.index).toLowerCase();}).bind(this));var a=$A(b).findAll(function(g){return !this.plugs.include(g)&&(!g.target||g.target===ORYX.Plugins.Toolbar);}.bind(this));if(a.length<1){return;}this.buttons=[];ORYX.Log.trace("Creating a toolbar.");if(!this.toolbar){this.toolbar=new Ext.ux.SlicedToolbar({height:24});var e=this.facade.addToRegion("north",this.toolbar,"Toolbar");}var f=this.plugs.last()?this.plugs.last().group:a[0].group;var d={};a.each((function(l,h){if(!l.name){return;}this.plugs.push(l);if(f!=l.group){if(!l.addFill&&(!a[h-1]||!a[h-1].addFill)){this.toolbar.add("-");}f=l.group;d={};}if(l.menuConfig){var g=new Ext.ux.Toolbar.HorizontalMenuButton(l);this.toolbar.add(g);return;}if(l.dropDownGroupIcon){var o=d[l.dropDownGroupIcon];if(o===undefined){o=d[l.dropDownGroupIcon]=new Ext.Toolbar.SplitButton({cls:"x-btn-icon",icon:Ext.isIPad?l.dropDownGroupIcon.replace("/famfamfam/","/famfamfam/32x32/"):l.dropDownGroupIcon,menu:new Ext.menu.Menu({items:[]}),listeners:{click:function(p,q){if(!p.menu.isVisible()&&!p.ignoreNextClick){p.showMenu();}else{p.hideMenu();}}}});this.toolbar.add(o);}var n={icon:l.icon,text:l.name,cls:"x-"+String(l.group.gsub("\\.","")).toLowerCase(),handler:l.toggle?undefined:l.functionality,checkHandler:l.toggle?l.functionality:undefined,splitButton:o,listeners:{render:function(p){if(l.description){new Ext.ToolTip({target:p.getEl(),title:l.description});}}}};if("string"===typeof l.style){n.style=l.style;}if("string"===typeof l.iconCls){n.iconCls=l.iconCls;}if(l.toggle){var g=new Ext.menu.CheckItem(n);}else{var g=new Ext.menu.Item(n);}if(l.separatedBefore){o.menu.addSeparator();}o.menu.add(g);if(l.separated){o.menu.addSeparator();}}else{if(l.addFill){this.toolbar.addFill();}else{if(l.isComboBox){var m=l.comboBox();this.toolbar.addField(m);}else{var k=l.icon.split("/").length===4?l.icon.replace("/editor/images/","/explorer/src/img/famfamfam/"):l.icon;if(Ext.isIPad){k=k.replace("/famfamfam/","/famfamfam/32x32/");}var g=new Ext.ux.Toolbar.Button({icon:k,cls:"x-btn-icon",itemId:l.id,tooltip:l.description,tooltipType:"title",handler:l.toggle?null:l.functionality,enableToggle:l.toggle,toggleHandler:l.toggle?l.functionality:null});this.toolbar.add(g);g.getEl().onclick=function(){this.blur();};}}}l["buttonInstance"]=l.isComboBox?m:g;this.buttons.push(l);}).bind(this));this.enableButtons([]);this.toolbar.calcSlices();window.addEventListener("resize",function(g){this.toolbar.calcSlices();}.bind(this),false);window.addEventListener("onresize",function(g){this.toolbar.calcSlices();}.bind(this),false);},onSelectionChanged:function(a){this.enableButtons(a.elements);},enableButtons:function(a){this.buttons.each((function(b){if(!b.buttonInstance){return;}b.buttonInstance.enable();if(b.minShape&&b.minShape>a.length){b.buttonInstance.disable();}if(b.maxShape&&b.maxShape<a.length){b.buttonInstance.disable();}if(b.isEnabled&&!b.isEnabled(b.buttonInstance)){b.buttonInstance.disable();}}).bind(this));}});Ext.ns("Ext.ux");Ext.ux.SlicedToolbar=Ext.extend(Ext.Toolbar,{currentSlice:0,iconStandardWidth:22,seperatorStandardWidth:2,toolbarStandardPadding:2,initComponent:function(){Ext.apply(this,{});Ext.ux.SlicedToolbar.superclass.initComponent.apply(this,arguments);},onRender:function(){Ext.ux.SlicedToolbar.superclass.onRender.apply(this,arguments);},onResize:function(){Ext.ux.SlicedToolbar.superclass.onResize.apply(this,arguments);},calcSlices:function(){var d=0;this.sliceMap={};var c=0;var a=this.getEl().getWidth();this.items.getRange().each(function(g,e){if(g.helperItem){g.destroy();return;}var h=g.getEl().getWidth();if(c+h+5*this.iconStandardWidth>a){var f=this.items.indexOf(g);this.insertSlicingButton("next",d,f);if(d!==0){this.insertSlicingButton("prev",d,f);}this.insertSlicingSeperator(d,f);d+=1;c=0;}this.sliceMap[g.id]=d;c+=h;}.bind(this));if(d>0){this.insertSlicingSeperator(d,this.items.getCount()+1);this.insertSlicingButton("prev",d,this.items.getCount()+1);var b=new Ext.Toolbar.Spacer();this.insertSlicedHelperButton(b,d,this.items.getCount()+1);Ext.get(b.id).setWidth(this.iconStandardWidth);}this.maxSlice=d;this.setCurrentSlice(this.currentSlice);},insertSlicedButton:function(b,c,a){this.insertButton(a,b);this.sliceMap[b.id]=c;},insertSlicedHelperButton:function(b,c,a){b.helperItem=true;this.insertSlicedButton(b,c,a);},insertSlicingSeperator:function(b,a){this.insertSlicedHelperButton(new Ext.Toolbar.Fill(),b,a);},insertSlicingButton:function(e,f,b){var d=function(){this.setCurrentSlice(this.currentSlice+1);}.bind(this);var a=function(){this.setCurrentSlice(this.currentSlice-1);}.bind(this);var c=new Ext.Toolbar.Button({cls:"x-btn-icon",icon:ORYX.CONFIG.ROOT_PATH+"images/toolbar_"+e+".png",handler:(e==="next")?d:a});this.insertSlicedHelperButton(c,f,b);},setCurrentSlice:function(a){if(a>this.maxSlice||a<0){return;}this.currentSlice=a;this.items.getRange().each(function(b){b.setVisible(a===this.sliceMap[b.id]);}.bind(this));}});if("undefined"==typeof ORYX){var ORYX={};}if("undefined"==typeof ORYX.Plugins){ORYX.Plugins={};}(function(){ORYX.Plugins.ShapeMenuPlugin={construct:function(c){this.facade=c;this.alignGroups=new Hash();var a=this.facade.getCanvas().getHTMLContainer();this.shapeMenu=new ORYX.Plugins.ShapeMenu(a);this.currentShapes=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDROP_START,this.hideShapeMenu.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDROP_END,this.showShapeMenu.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_START,(function(){this.hideShapeMenu();this.hideMorphMenu();}).bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_END,this.showShapeMenu.bind(this));var b=new ORYX.Core.DragZone(a.parentNode,this.facade);b.validBoundaries=["node"];b.afterValidDrop=this.afterDragging.bind(this);b.afterInvalidDrop=function(){this.showShapeMenu();}.bind(this);b.afterDragEnter=function(){if(this.shapeMenu.isVisible){this.hideShapeMenu();}}.bind(this);b.canAttach=function(){return false;};b.canContain=this.canContain.bind(this,b);b.canConnect=this.canConnect.bind(this,b);this.createdButtons={};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,(function(){this.registryChanged(this.pluginsData||[]);}).bind(this));this.timer=null;this.resetElements=true;},hideShapeMenu:function(a){window.clearTimeout(this.timer);this.timer=null;this.shapeMenu.hide();},showShapeMenu:function(a){if(!a||this.resetElements){window.clearTimeout(this.timer);this.timer=window.setTimeout(function(){this.shapeMenu.closeAllButtons();this.showMorphButton(this.currentShapes);this.showStencilButtons(this.currentShapes);this.showOfferButtons(this.currentShapes);this.shapeMenu.show(this.currentShapes);this.resetElements=false;}.bind(this),10);}else{window.clearTimeout(this.timer);this.timer=null;this.shapeMenu.show(this.currentShapes);}},registryChanged:function(a){this.pluginsData=(a||[]).findAll(function(d){return d&&d.target&&d.target===ORYX.Plugins.ShapeMenuPlugin;});this.shapeMenu.removeAllButtons();this.shapeMenu.setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_RIGHT,2);this.createdButtons={};this.createMorphMenu();this.createOfferButtons();this.baseMorphStencils=this.facade.getRules().baseMorphs();var b=this.facade.getRules().containsMorphingRules();var c=this.facade.getStencilSets();c.values().each((function(g){var f=g.nodes();var d=f.invoke("groups").flatten().uniq();f.sortBy(function(h){return d.indexOf(h.groups()[0]);}).each((function(l){if(l.hide()){return;}var k={type:l.id(),namespace:l.namespace(),connectingType:true};var h=new ORYX.Plugins.ShapeMenuButton({callback:this.newShape.bind(this,k),icon:l.icon(),align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:0,msg:l.title()+" - "+ORYX.I18N.ShapeMenuPlugin.clickDrag,cls:"x-"+(l.idWithoutNs()||"none")});this.shapeMenu.addButton(h);this.createdButtons[l.namespace()+l.type()+l.id()]=h;Ext.dd.Registry.register(h.node.lastChild,k);}).bind(this));var e=g.edges();e.each((function(l){if(l.hide()){return;}var k={type:l.id(),namespace:l.namespace()};var h=new ORYX.Plugins.ShapeMenuButton({callback:this.newShape.bind(this,k),icon:b?ORYX.PATH+"images/edges.png":l.icon(),align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:1,msg:(b?ORYX.I18N.Edge:l.title())+" - "+ORYX.I18N.ShapeMenuPlugin.drag,cls:"x-"+(l.idWithoutNs()||"none")+" x-edges"});this.shapeMenu.addButton(h);this.createdButtons[l.namespace()+l.type()+l.id()]=h;Ext.dd.Registry.register(h.node.lastChild,k);}).bind(this));}).bind(this));},createMorphMenu:function(){this.morphMenu=new Ext.menu.Menu({id:"Oryx_morph_menu",items:[],hide:function(){if(!this.showDelay){return Ext.menu.Menu.prototype.hide.apply(this,arguments);}}});this.morphMenu.on("mouseover",function(){this.morphMenuHovered=true;},this);this.morphMenu.on("mouseout",function(){this.morphMenuHovered=false;},this);var a=new ORYX.Plugins.ShapeMenuButton({hovercallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.showMorphMenu.bind(this):undefined),resetcallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.hideMorphMenu.bind(this):undefined),callback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?undefined:this.toggleMorphMenu.bind(this)),icon:ORYX.PATH+"images/wrench_orange.png",align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,msg:ORYX.I18N.ShapeMenuPlugin.morphMsg,cls:"x-morph-menu"});this.shapeMenu.setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_BOTTOM,(this.shapeMenu.numberOfButtonsPerLevel[ORYX.CONFIG.SHAPEMENU_BOTTOM]||0)+1);this.shapeMenu.addButton(a);this.morphMenu.getEl().appendTo(a.node);this.morphButton=a;},createOfferButtons:function(){var a=(this.pluginsData||[]).findAll(function(b){return b&&b.icon&&b.functionality;});a.sortBy(function(b){return b.index||0;}).each(function(c){var d=c.align||ORYX.CONFIG.SHAPEMENU_BOTTOM;var b=new ORYX.Plugins.ShapeMenuButton({callback:c.functionality,icon:c.icon,align:d,group:0,msg:c.description,offset:c.offset||undefined,cls:c.title||undefined});this.shapeMenu.addButton(b);this.shapeMenu.setNumberOfButtonsPerLevel(d,(this.shapeMenu.numberOfButtonsPerLevel[d]||0)+1);c.button=b;}.bind(this));},showMorphMenu:function(){this.morphMenu.show(this.morphButton.node);this.morphMenu.showDelay=true;window.setTimeout(function(){delete this.morphMenu.showDelay;}.bind(this),1000);this._morphMenuShown=true;},hideMorphMenu:function(){this.morphMenu.hide();this._morphMenuShown=false;},toggleMorphMenu:function(){if(this._morphMenuShown){this.hideMorphMenu();}else{this.showMorphMenu();}},onSelectionChanged:function(a){var b=a.elements;this.hideShapeMenu();this.hideMorphMenu();if(this.currentShapes.inspect()!==b.inspect()){this.currentShapes=b;this.resetElements=true;this.showShapeMenu();}else{this.showShapeMenu(true);}},showMorphButton:function(c){if(c.length!=1){return;}var a=this.facade.getRules().morphStencils({stencil:c[0].getStencil()});a=a.select(function(d){if(c[0].getStencil().type()==="node"&&!c[0].getStencil().hide()){return this.facade.getRules().canContain({containingShape:c[0].parent,containedStencil:d})&&c[0].getIncomingShapes().all(function(e){return this.facade.getRules().canConnect({sourceShape:e instanceof ORYX.Core.Edge?e.getSource():e,edgeShape:e,targetStencil:d});}.bind(this))&&c[0].getOutgoingShapes().all(function(e){return this.facade.getRules().canConnect({sourceStencil:d,edgeShape:e,targetShape:e instanceof ORYX.Core.Edge?e.getTarget():e});}.bind(this));}else{return this.facade.getRules().canConnect({sourceShape:c[0].dockers.first().getDockedShape(),edgeStencil:d,targetShape:c[0].dockers.last().getDockedShape()});}}.bind(this));if(a.size()<=1){return;}this.morphMenu.removeAll();var b=a.map((function(e){var d=new Ext.menu.Item({text:e.title(),icon:e.icon(),identifier:e.id(),disabled:e.id()==c[0].getStencil().id(),disabledClass:ORYX.CONFIG.MORPHITEM_DISABLED,handler:(function(){this.morphShape(c[0],e);}).bind(this)});this.morphMenu.add(d);return d;}).bind(this));this.facade.raiseEvent({type:"shapemenu.showMorphButton",selectedElements:c,buttons:b});this.morphButton.prepareToShow();},showStencilButtons:function(g){if(g.length!=1){return;}var f=this.facade.getStencilSets()[g[0].getStencil().namespace()];var c=this.facade.getRules().outgoingEdgeStencils({canvas:this.facade.getCanvas(),sourceShape:g[0]});var a=new Array();var d=new Array();var e=this.facade.getRules().containsMorphingRules();c.each((function(k){if(e){if(this.baseMorphStencils.include(k)){var l=true;}else{var h=this.facade.getRules().morphStencils({stencil:k});var l=!h.any((function(m){if(this.baseMorphStencils.include(m)&&c.include(m)){return true;}return d.include(m);}).bind(this));}}if(l||!e){if(this.createdButtons[k.namespace()+k.type()+k.id()]){this.createdButtons[k.namespace()+k.type()+k.id()].prepareToShow();}d.push(k);}a=a.concat(this.facade.getRules().targetStencils({canvas:this.facade.getCanvas(),sourceShape:g[0],edgeStencil:k}));}).bind(this));a.uniq();var b=new Array();a.each((function(l){if(e){if(l.type()==="edge"){return;}if(!this.facade.getRules().showInShapeMenu(l)){return;}if(!this.baseMorphStencils.include(l)){var h=this.facade.getRules().morphStencils({stencil:l});if(h.size()==0){return;}var k=h.any((function(m){if(this.baseMorphStencils.include(m)&&a.include(m)){return true;}return b.include(m);}).bind(this));if(k){return;}}}if(this.createdButtons[l.namespace()+l.type()+l.id()]){this.createdButtons[l.namespace()+l.type()+l.id()].prepareToShow();}b.push(l);}).bind(this));},showOfferButtons:function(b){var a=(b||[]).length;(this.pluginsData||[]).each(function(c){if(!c||!c.button){return;}if((c.minShape&&c.minShape>a)||(c.maxShape&&c.maxShape<a)||(c.isEnabled&&!c.isEnabled())){c.button.prepareToHide();}else{c.button.prepareToShow();}}.bind(this));},canContain:function(e,b,f){var d=b[0];var a=[].concat(f,this.facade.getRules().morphStencils({stencil:f}));for(var c=0;c<a.size();c++){canContain=this.facade.getRules().canContain({containingShape:d,containedStencil:a[c]});if(canContain){e.setOptions({type:a[c].id(),namespace:a[c].namespace()});break;}}return canContain;},canConnect:function(f,b,k){var l=b[0],g=b[0],c=b[0],a=this.currentShapes[0];var e=false;if(!a){return false;}if(a.isParent(l)){l=g=c=this.facade.getCanvas();}if(l===a){return false;}var h=this.facade.getRules().morphStencils({stencil:k});if(!h.include(k)){h.push(k);}var g=l;while(!e&&g&&!(g instanceof ORYX.Core.Canvas)){l=g;var d=0,m=h.size();for(d=0;d<m;d++){e=this.facade.getRules().canConnect({sourceShape:a,edgeStencil:h[d],targetShape:g});if(e){break;}}if(e){if(f.getOptions().connectingType){f.setOptions({connectingType:h[d].id(),namespace:h[d].namespace()});}else{f.setOptions({type:h[d].id(),namespace:h[d].namespace()});}}else{g=g.parent;}}f._lastOverElement=e?l:c;return e;},afterDragging:function(e,b,f){if(!this.currentShapes[0]){return;}e["connectedShape"]=this.currentShapes[0];if(e["connectingType"]){var a=this.facade.getStencilSets()[e.namespace];var d=a.stencil(e.type);var c={sourceShape:this.currentShapes[0],targetStencil:d};e["connectingType"]=this.facade.getRules().connectMorph(c);if(e["connectingType"]){e["connectingType"]=e["connectingType"].id();}else{delete e["connectingType"];}}if(ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE===true){delete e["connectingType"];}var g=new ORYX.Plugins.ShapeMenuPlugin.CreateCommand(Object.clone(e),b,e.position,this);this.facade.executeCommands([g]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE,source:this.currentShapes,destination:this.currentShapes});},newShape:function(e,f){var a=this.facade.getStencilSets()[e.namespace];var d=a.stencil(e.type);if(this.facade.getRules().canContain({containingShape:this.currentShapes.first().parent,containedStencil:d})){e["connectedShape"]=this.currentShapes[0];e["parent"]=this.currentShapes.first().parent;e["containedStencil"]=d;var b={sourceShape:this.currentShapes[0],targetStencil:d};var c=this.facade.getRules().connectMorph(b);if(!c){return;}e["connectingType"]=c.id();if(ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE===true){delete e["connectingType"];}var g=new ORYX.Plugins.ShapeMenuPlugin.CreateCommand(Object.clone(e),undefined,undefined,this);this.facade.executeCommands([g]);}},morphShape:function(b,d){var f=ORYX.Core.Command.extend({construct:function(g,k,h){this.shape=g;this.stencil=k;this.facade=h;this.removeEdge=[];this.reconnectedEdges=[];},execute:function(){var r=this.shape;var v=this.stencil;var q=r.resourceId;var x=null;var l=r.serialize();v.properties().each((function(y){if(y.readonly()){l=l.reject(function(z){return z.name==y.id();});}}).bind(this));if(this.newShape){x=this.newShape;this.facade.getCanvas().add(x);}else{x=this.facade.createShape({type:v.id(),namespace:v.namespace(),resourceId:q,dontUpdateSelection:true});x.setResourceId(q);}var p=l.find(function(y){return(y.prefix==="oryx"&&y.name==="bounds");});var s=null;if(!this.facade.getRules().preserveBounds(r.getStencil())){var g=p.value.split(",");if(parseInt(g[0],10)>parseInt(g[2],10)){var n=g[0];g[0]=g[2];g[2]=n;n=g[1];g[1]=g[3];g[3]=n;}g[2]=parseInt(g[0],10)+x.bounds.width();g[3]=parseInt(g[1],10)+x.bounds.height();p.value=g.join(",");}else{var u=r.bounds.height();var h=r.bounds.width();if(x.minimumSize){if(r.bounds.height()<x.minimumSize.height){u=x.minimumSize.height;}if(r.bounds.width()<x.minimumSize.width){h=x.minimumSize.width;}}if(x.maximumSize){if(r.bounds.height()>x.maximumSize.height){u=x.maximumSize.height;}if(r.bounds.width()>x.maximumSize.width){h=x.maximumSize.width;}}s={a:{x:r.bounds.a.x,y:r.bounds.a.y},b:{x:r.bounds.a.x+h,y:r.bounds.a.y+u}};}var t=r.bounds.center();if(s!==null){x.bounds.set(s);}this.setRelatedDockers(r,x);var o=r.node.parentNode;var k=r.node.nextSibling;var m=r.getChildNodes();this.facade.deleteShape(r);x.deserialize(l,r.toJSON());if(s!==null){x.bounds.set(s);}if(x.getStencil().type()==="edge"||(x.dockers.length==0||!x.dockers[0].getDockedShape())){x.bounds.centerMoveTo(t);}if(x.getStencil().type()==="node"&&(x.dockers.length==0||!x.dockers[0].getDockedShape())){this.setRelatedDockers(x,x);}this.resetAllChildShapes(m,x);if(k){o.insertBefore(x.node,k);}else{o.appendChild(x.node);}this.facade.setSelection([x]);this.facade.updateSelection();if(r instanceof ORYX.Core.Node&&x instanceof ORYX.Core.Node){this.handleDefaultBackgroundColorChange(r,x);}x.isChanged=true;this.newShape=x;},rollback:function(){if(!this.shape||!this.newShape||!this.newShape.parent){return;}this.newShape.parent.add(this.shape);this.newShape.getChildNodes().each(function(g){if(this.facade.getRules().canContain({containingShape:this.shape,containedShape:g})){this.shape.add(g);}}.bind(this));this.removeEdge.each(function(g){this.facade.getCanvas().add(g);}.bind(this));this.reconnectedEdges.each(function(g){g.docker.setDockedShape(g.shape);g.docker.setReferencePoint(g.point);}.bind(this));this.setRelatedDockers(this.newShape,this.shape);this.facade.deleteShape(this.newShape);this.facade.setSelection([this.shape]);},getValidChildren:function(h,g){return h.findAll(function(k){return this.facade.getRules().canContain({containingShape:g instanceof ORYX.Core.Shape?g:undefined,containingStencil:g instanceof ORYX.Core.StencilSet.Stencil?g:undefined,containedShape:k});}.bind(this));},resetAllChildShapes:function(m,l){var k=this.getValidChildren(m,l);var h=m.without.apply(m,k);var g=l.absoluteXY();this.reconnectedEdges=[];h.each(function(n){n.getAllDockedShapes().each(function(q){if(!(q instanceof ORYX.Core.Edge)||!q.parent){return;}var p=q.getSource()===n?q.getTarget():q.getSource();if(p&&!m.include(p)&&this.facade.getRules().canConnect({sourceShape:q.getSource()===n?n:p,edgeShape:q,targetShape:q.getTarget()===n?n:p})){var r=q.getSource()===n?q.dockers.first():q.dockers.last();var o=Object.clone(r.getAbsoluteReferencePoint());o.x-=g.x;o.y-=g.y;this.reconnectedEdges.push({shape:r.getDockedShape(),docker:r,point:Object.clone(r.referencePoint)});r.setDockedShape(l);r.setReferencePoint(o);}else{if(!this.removeEdge.include(q)){this.removeEdge.push(q);}q.parent.remove(q);}}.bind(this));}.bind(this));k.each(function(n){l.add(n);});},setRelatedDockers:function(g,h){if(g.getStencil().type()==="node"){(g.incoming||[]).concat(g.outgoing||[]).each(function(k){k.dockers.each(function(n){if(n.getDockedShape()==g){var m=Object.clone(n.referencePoint);var o={x:m.x*h.bounds.width()/g.bounds.width(),y:m.y*h.bounds.height()/g.bounds.height()};n.setDockedShape(h);n.setReferencePoint(o);if(k instanceof ORYX.Core.Edge){n.bounds.centerMoveTo(o);}else{var l=g.absoluteXY();n.bounds.centerMoveTo({x:o.x+l.x,y:o.y+l.y});}}});});if(g.dockers.length>0&&g.dockers.first().getDockedShape()){h.dockers.first().setDockedShape(g.dockers.first().getDockedShape());h.dockers.first().setReferencePoint(Object.clone(g.dockers.first().referencePoint));}}else{h.dockers.first().setDockedShape(g.dockers.first().getDockedShape());h.dockers.first().setReferencePoint(g.dockers.first().referencePoint);h.dockers.last().setDockedShape(g.dockers.last().getDockedShape());h.dockers.last().setReferencePoint(g.dockers.last().referencePoint);}},handleDefaultBackgroundColorChange:function(k,l){var g;var o=k.getStencil().properties().find(function(p){if(p.isBackgroundColor()||p.isBorderColor()){g=p.id();return true;}});if(!o){return;}o=o.value();var h;if(g){h=k.properties["oryx-"+g];}if(h&&o&&h===o){var n;var m=l.getStencil().properties().find(function(p){if(p.isBackgroundColor()||p.isBorderColor()){n=p.id();return true;}});if(!m){return;}m=m.value();l.setProperty("oryx-"+n,m,true);}}});var c=b.getChildNodes();var a=f.prototype.getValidChildren.call(this,c,d).length!==c.length;var e=function(){var g=new f(b,d,this.facade);this.facade.executeCommands([g]);}.bind(this);if(a){Ext.Msg.confirm(ORYX.I18N.ShapeMenuPlugin.morphWarningTitleMsg,ORYX.I18N.ShapeMenuPlugin.morphWarningMsg,function(g){if(g=="yes"){e();}});}else{e();}this.hideMorphMenu();}};ORYX.Plugins.ShapeMenuPlugin=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.ShapeMenuPlugin);ORYX.Plugins.ShapeMenu={construct:function(a){this.bounds=undefined;this.shapes=undefined;this.buttons=[];this.isVisible=false;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(a),["div",{id:ORYX.Editor.provideId(),"class":"Oryx_ShapeMenu"}]);this.alignContainers=new Hash();this.numberOfButtonsPerLevel=new Hash();},addButton:function(b){this.buttons.push(b);if(!this.alignContainers[b.align]){this.alignContainers[b.align]=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,["div",{"class":b.align}]);this.node.appendChild(this.alignContainers[b.align]);var a=false;}this.alignContainers[b.align].appendChild(b.node);},deleteButton:function(a){this.buttons=this.buttons.without(a);this.node.removeChild(a.node);},removeAllButtons:function(){var a=this;this.buttons.each(function(b){if(b.node&&b.node.parentNode){b.node.parentNode.removeChild(b.node);}});this.buttons=[];},closeAllButtons:function(){this.buttons.each(function(a){a.prepareToHide();});this.isVisible=false;},show:function(e){if(e.length<=0){return;}this.shapes=e;var g=undefined;var k=undefined;this.shapes.each(function(t){if(!t||!t.node||!t.node.parentNode){return;}var s=t.node.getScreenCTM();var u=t.absoluteXY();s.e=s.a*u.x;s.f=s.d*u.y;k=new ORYX.Core.Bounds(s.e,s.f,s.e+s.a*t.bounds.width(),s.f+s.d*t.bounds.height());if(!g){g=k;}else{g.include(k);}});if(!g){return;}this.bounds=g;var c=this.bounds;var o=this.bounds.upperLeft();var h=0,d=0;var m=0,n=0;var b=0,p;var q=0,f=0;var r=Ext.isIPad?30:22;var l=this.getWillShowButtons();l.sortBy(function(a){return a.group;});l.each(function(s){var t=this.getNumberOfButtonsPerLevel(s.align);if(s.align==ORYX.CONFIG.SHAPEMENU_LEFT){if(s.group!=d){h=0;d=s.group;}var a=Math.floor(h/t);var u=h%t;s.setLevel(a);s.setPosition(o.x-5-(a+1)*r,o.y+t*s.group*r+s.group*0.3*r+u*r);h++;}else{if(s.align==ORYX.CONFIG.SHAPEMENU_TOP){if(s.group!=n){m=0;n=s.group;}var a=m%t;var u=Math.floor(m/t);s.setLevel(u);s.setPosition(o.x+t*s.group*r+s.group*0.3*r+a*r,o.y-5-(u+1)*r);m++;}else{if(s.align==ORYX.CONFIG.SHAPEMENU_BOTTOM){if(s.group!=p){b=0;p=s.group;}var a=b%t;var u=Math.floor(b/t);if(s.option.offset){a=s.option.offset.x!==undefined?s.option.offset.x*(r/22)/r:a;u=s.option.offset.y!==undefined?s.option.offset.y*(r/22)/r:u;b--;}else{a-=6/r;}s.setLevel(u);s.setPosition(o.x+t*s.group*r+s.group*0.3*r+a*r,o.y+c.height()+5+u*r);b++;}else{if(s.group!=f){q=0;f=s.group;}var a=Math.floor(q/t);var u=q%t;s.setLevel(a);s.setPosition(o.x+c.width()+5+a*r,o.y+t*s.group*r+s.group*0.3*r+u*r-5);q++;}}}s.show();}.bind(this));this.isVisible=true;},hide:function(){this.buttons.each(function(a){a.hide();});this.isVisible=false;},hoverAlignContainer:function(b,a){this.buttons.each(function(c){if(c.align==b){c.showOpaque();}});},resetAlignContainer:function(b,a){this.buttons.each(function(c){if(c.align==b){c.showTransparent();}});},isHover:function(){return this.buttons.any(function(a){return a.isHover();});},getWillShowButtons:function(){return this.buttons.findAll(function(a){return a.willShow;});},getButtons:function(b,a){return this.getWillShowButtons().findAll(function(c){return c.align==b&&(a===undefined||c.group==a);});},setNumberOfButtonsPerLevel:function(b,a){this.numberOfButtonsPerLevel[b]=a;},getNumberOfButtonsPerLevel:function(a){if(this.numberOfButtonsPerLevel[a]){return Math.min(this.getButtons(a,0).length,this.numberOfButtonsPerLevel[a]);}else{return 1;}}};ORYX.Plugins.ShapeMenu=Clazz.extend(ORYX.Plugins.ShapeMenu);ORYX.Plugins.ShapeMenuButton={construct:function(b){if(b){this.option=b;if(!this.option.arguments){this.option.arguments=[];}}else{}this.parentId=this.option.id?this.option.id:null;var e=this.option.caption?"Oryx_button_with_caption":"Oryx_button";this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(this.parentId),["div",{"class":e}]);var c={src:"/v5designer/libs/ext-2.0.2/resources/images/default/s.gif","class":"x-shapemenu-icon "+(this.option.cls||"").toLowerCase(),style:this.getStyleAttribute(this.option.icon)};if(this.option.msg){c.title=this.option.msg;}if(this.option.icon){this.img=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,["img",c]);}if(this.option.caption){var d=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,["span"]);ORYX.Editor.graft("http://www.w3.org/1999/xhtml",d,this.option.caption);}var a=false;if(b.hovercallback||b.dragcallback||b.resetcallback){this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this.hover.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this.reset.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.activate.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.hover.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.move.bind(this),a);}this.node.addEventListener("click",this.trigger.bind(this),a);this.align=this.option.align?this.option.align:ORYX.CONFIG.SHAPEMENU_RIGHT;this.group=this.option.group?this.option.group:0;this.hide();this.dragStart=false;this.isVisible=false;this.willShow=false;this.resetTimer;},getStyleAttribute:function(a){return"background: url('"+a+"') transparent no-repeat center center;";},setIcon:function(a){if(a&&this.img){this.img.style.background="";this.img.setAttribute("src",a);}},setDescription:function(a){if(a&&this.img){this.img.setAttribute("title",a);}},setCallback:function(a){if(a instanceof Function){this.option.callback=a;}},hide:function(){this.node.style.display="none";this.isVisible=false;},remove:function(){this.node.parentNode.removeChild(this.node);},show:function(){this.node.style.display="";this.isVisible=true;},showOpaque:function(){},showTransparent:function(){},prepareToShow:function(){this.willShow=true;},prepareToHide:function(){this.willShow=false;this.hide();},setPosition:function(a,b){this.node.style.left=a+"px";this.node.style.top=b+"px";},setLevel:function(a){if(this.level!==a){this.node.className=this.node.className.replace(/x-opacity-[0-9]+/,"");if(a==0){this.node.className+=" x-opacity-50";}else{if(a==1){this.node.className+=" x-opacity-20";}else{this.node.className+=" x-opacity-0";}}this.level=a;}},setChildWidth:function(a){this.childNode.style.width=a+"px";},reset:function(a){window.clearTimeout(this.resetTimer);this.resetTimer=window.setTimeout(this.doReset.bind(this),100);if(this.option.resetcallback){this.option.arguments.push(a);var b=this.option.resetcallback.apply(this,this.option.arguments);this.option.arguments.remove(a);}},doReset:function(){if(this.node.hasClassName("Oryx_down")){this.node.removeClassName("Oryx_down");}if(this.node.hasClassName("Oryx_hover")){this.node.removeClassName("Oryx_hover");}},activate:function(a){this.node.addClassName("Oryx_down");this.dragStart=true;},isHover:function(){return this.node.hasClassName("Oryx_hover")?true:false;},hover:function(a){window.clearTimeout(this.resetTimer);this.resetTimer=null;this.node.addClassName("Oryx_hover");this.dragStart=false;if(this.option.hovercallback){this.option.arguments.push(a);var b=this.option.hovercallback.apply(this,this.option.arguments);this.option.arguments.remove(a);}},move:function(a){if(this.dragStart&&this.option.dragcallback){this.option.arguments.push(a);var b=this.option.dragcallback.apply(this,this.option.arguments);this.option.arguments.remove(a);}},trigger:function(a){if(this.option.callback){this.option.arguments.push(a);var b=this.option.callback.apply(this,this.option.arguments);this.option.arguments.remove(a);}this.dragStart=false;},toString:function(){return"HTML-Button "+this.id;}};ORYX.Plugins.ShapeMenuButton=Clazz.extend(ORYX.Plugins.ShapeMenuButton);ORYX.Plugins.ShapeMenuPlugin.CreateCommand=ORYX.Core.Command.extend({construct:function(c,b,a,d){this.option=c;this.currentReference=b;this.position=a;this.plugin=d;this.selection=d.facade.getSelection();this.shape;this.edge;this.targetRefPos;this.sourceRefPos;this.mousePosition=a;},execute:function(){var e=false;if(this.shape){if(this.shape instanceof ORYX.Core.Node){this.option.parent.add(this.shape);if(this.edge){this.plugin.facade.getCanvas().add(this.edge);this.edge.dockers.first().setDockedShape(this.option.connectedShape);this.edge.dockers.first().setReferencePoint(this.sourceRefPos);this.edge.dockers.last().setDockedShape(this.shape);this.edge.dockers.last().setReferencePoint(this.targetRefPos);}this.plugin.facade.setSelection([this.shape]);}else{if(this.shape instanceof ORYX.Core.Edge){this.plugin.facade.getCanvas().add(this.shape);this.shape.dockers.first().setDockedShape(this.option.connectedShape);if("undefined"!==typeof(this.newState)){var l=this.shape.dockers.first().getDockedShape();this.restoreDockerPos(l,this.shape,this.newState);}}}e=true;}else{this.shape=this.plugin.facade.createShape(Ext.apply(this.option,{dontUpdateSelection:true}));this.edge=(!(this.shape instanceof ORYX.Core.Edge))?this.shape.getIncomingShapes().first():undefined;if(this.shape instanceof ORYX.Core.Edge){var l=this.shape.dockers.first().getDockedShape();var d=l.getAllDockedShapes().without(this.shape);this.oldState=[];d.each(function(u){this.oldState[u.id]=[];u.dockers.each(function(x,v){this.oldState[u.id][v]=x.referencePoint||x.bounds.center();}.bind(this));}.bind(this));}}if(this.currentReference&&this.position){if(this.shape instanceof ORYX.Core.Edge){if(!(this.currentReference instanceof ORYX.Core.Canvas)){this.shape.dockers.last().setDockedShape(this.currentReference);if(this.shape.getStencil().keepState()!==true){var k=this.currentReference.getDefaultMagnet();if(k){k=this.currentReference.getDefaultMagnet().bounds.center();}else{k=this.currentReference.bounds.center();}this.shape.dockers.last().setReferencePoint(k);}}else{this.shape.dockers.last().bounds.centerMoveTo(this.position);}this.sourceRefPos=this.shape.dockers.first().referencePoint;this.targetRefPos=this.shape.dockers.last().referencePoint;}else{if(this.edge){this.sourceRefPos=this.edge.dockers.first().referencePoint;this.targetRefPos=this.edge.dockers.last().referencePoint;}}if(this.option.canConnectBetween&&this.currentReference instanceof ORYX.Core.Edge){var m=this.currentReference.getSource();var c=this.currentReference.getTarget();var g;if(this.edgeBetween){g=this.edgeBetween;this.plugin.facade.getCanvas().add(this.edgeBetween);}else{g=this.plugin.facade.createShape({namespace:this.currentReference.getStencil().namespace(),type:this.currentReference.getStencil().id(),dontUpdateSelection:true});}var r={x:this.shape.bounds.width()/2,y:this.shape.bounds.height()/2};if(this.shape.getDefaultMagnet()){r=this.shape.getDefaultMagnet().bounds.center();}var a=this.currentReference.getDockers().last().referencePoint;var b=this.currentReference.findSegment(this.shape.absoluteCenterXY());var s=this.currentReference.dockers.slice(this.currentReference.dockers.indexOf(b.toDocker),this.currentReference.dockers.length-1);this.currentReference.getDockers().last().setDockedShape(this.shape);this.currentReference.getDockers().last().setReferencePoint(r);g.getDockers().first().setDockedShape(this.shape);g.getDockers().first().setReferencePoint(r);g.getDockers().last().setDockedShape(c);g.getDockers().last().setReferencePoint(a);this.dockerPosition=this.currentReference.getDockers().map(function(u){return u.bounds.center();});s.each(function(u){this.currentReference.removeDocker(u);}.bind(this));this.plugin.doLayout(this.currentReference);this.plugin.doLayout(g);this.edgeBetween=g;if(this.option.connectedShape===m||this.option.connectedShape===c){this.plugin.facade.deleteShape(this.edge);delete this.edge;}}}else{var n=this.option.containedStencil;var p=this.option.connectedShape;var f=p.bounds;var q=this.shape.bounds;var o=n.defaultAlign(this.shape);var h=f.center();if(o==="north"){h.y-=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(q.height()/2);}else{if(o==="northeast"){h.x+=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(q.width()/2);h.y-=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(q.height()/2);}else{if(o==="southeast"){h.x+=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(q.width()/2);h.y+=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(q.height()/2);}else{if(o==="south"){h.y+=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(q.height()/2);}else{if(o==="southwest"){h.x-=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(q.width()/2);h.y+=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(q.height()/2);}else{if(o==="west"){h.x-=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(q.width()/2);}else{if(o==="northwest"){h.x-=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(q.width()/2);h.y-=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(q.height()/2);}else{h.x+=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(q.width()/2);}}}}}}}this.shape.bounds.centerMoveTo(h);if(this.shape instanceof ORYX.Core.Node){(this.shape.dockers||[]).each(function(u){u.bounds.centerMoveTo(h);});}this.position=h;if(this.edge){this.sourceRefPos=this.edge.dockers.first().referencePoint;this.targetRefPos=this.edge.dockers.last().referencePoint;}}this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();if(!e){if(this.edge){if(this.edge.getStencil().keepState()===true){var t=this.layoutEdges(this.edge,this.mousePosition);if(!t){this.plugin.doLayout(this.edge);}}else{this.plugin.doLayout(this.edge);}}else{if(this.shape instanceof ORYX.Core.Edge){if(this.shape.getStencil().keepState()===true){var t=this.layoutEdges(this.shape,this.mousePosition);if(!t){if(this.currentReference instanceof ORYX.Core.Node){var k=this.currentReference.getDefaultMagnet();if(k){k=this.currentReference.getDefaultMagnet().bounds.center();}else{k=this.currentReference.bounds.center();}this.shape.dockers.last().setReferencePoint(k);}this.plugin.doLayout(this.shape);}}else{this.plugin.doLayout(this.shape);}}}}if(this.shape instanceof ORYX.Core.Edge){var l=this.shape.dockers.first().getDockedShape();var d=l.getAllDockedShapes().without(this.shape);this.newState=[];d.each(function(u){this.newState[u.id]=[];u.dockers.each(function(x,v){this.newState[u.id][v]=x.referencePoint||x.bounds.center();}.bind(this));}.bind(this));}if(!(this.shape instanceof ORYX.Core.Edge)){this.plugin.facade.setSelection([this.shape]);}},rollback:function(){var a;if(this.shape instanceof ORYX.Core.Edge){a=this.shape.dockers.first().getDockedShape();}this.plugin.facade.deleteShape(this.shape);if(this.oldState&&this.shape&&this.shape instanceof ORYX.Core.Edge){this.restoreDockerPos(a,this.shape,this.oldState);}if(this.edge){this.plugin.facade.deleteShape(this.edge);}if(this.edgeBetween&&this.dockerPosition){this.removeAllDocker(this.currentReference);this.dockerPosition.each(function(d,b){if(b==0||b==this.dockerPosition.length-1){return;}var c=this.currentReference.createDocker(undefined,d);c.bounds.centerMoveTo(d);}.bind(this));this.currentReference.getDockers().last().setDockedShape(this.edgeBetween.getTarget());this.currentReference.getDockers().last().setReferencePoint(this.edgeBetween.dockers.last().referencePoint);this.plugin.facade.deleteShape(this.edgeBetween);}this.plugin.facade.setSelection([].concat(this.selection).compact());this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();},restoreDockerPos:function(b,a,c){edges=b.getAllDockedShapes().without(a);edges.each(function(d){if(d.dockers.length!==c[d.id].length){while(d.dockers.length<c[d.id].length){d.add(d.dockers[1].clone(),1);}while(d.dockers.length>c[d.id].length){d.remove(d.dockers[1]);}}d.dockers.each(function(f,e){if(f.isDocked()){f.setReferencePoint(c[d.id][e]);}else{f.bounds.centerMoveTo(c[d.id][e]);}}.bind(this));}.bind(this));},layoutEdges:function(h,v){var k=h.dockers.first();var s=h.dockers[1];var n=h.dockers.last();var r=k.getDockedShape();var g=r.absoluteBounds();var d=n.getDockedShape();var p=d.absoluteBounds();var f=200;var b=r.getOverlap(d);if(b){var a=Math.min(g.lowerRight().x,p.lowerRight().x)-Math.max(g.upperLeft().x,p.upperLeft().x);var o=Math.min(g.lowerRight().y,p.lowerRight().y)-Math.max(g.upperLeft().y,p.upperLeft().y);if(a>0&&!(g.width()<f||p.width()<f)||o>0&&!(g.height()<f||p.height()<f)){if(p.isIncluded({x:a>0?v.x:p.center().x,y:a>0?p.center().y:v.y})){k.setReferencePoint({x:a>0?v.x-g.upperLeft().x:k.referencePoint.x,y:a>0?k.referencePoint.y:v.y-g.upperLeft().y});n.setReferencePoint({x:a>0?v.x-p.upperLeft().x:n.referencePoint.x,y:a>0?n.referencePoint.y:v.y-p.upperLeft().y});return true;}}else{if(a>0&&(g.width()<f||p.width()<f)||o>0&&(g.height()<f||p.height()<f)){if(h.dockers.length===2){var c=g.getSide(k.bounds.center());var m=this.getRelevantEdges(r,g,c,h,true);var q=m.length;m.each(function(z,l){if(z.dockers[0].getDockedShape()===r){var A=z.dockers[0];var x=z.dockers[1];}else{var A=z.dockers[1];var x=z.dockers[0];}A.setReferencePoint({x:a>0?b.upperLeft().x-(g.upperLeft().x)+(l+1)/(q+1)*b.width():g.center().x-g.upperLeft().x,y:o>0?b.upperLeft().y-(g.upperLeft().y)+(l+1)/(q+1)*b.height():g.center().y-g.upperLeft().y});var y=A.getAbsoluteReferencePoint();if(x.isDocked()){x.setReferencePoint({x:["top","bottom"].include(c)?y.x-p.upperLeft().x:x.referencePoint.x,y:["left","right"].include(c)?y.y-p.upperLeft().y:x.referencePoint.y});}else{x.bounds.centerMoveTo({x:(["left","right"].include(c)?x.bounds.center().x:A.getAbsoluteReferencePoint().x),y:(["left","right"].include(c)?A.getAbsoluteReferencePoint().y:x.bounds.center().y)});}z._update(true);});}}}var u=[];var m=this.getRelevantEdges(r,g,c,h,false);m.each(function(l){u.push(l.dockers[0].getDockedShape()===r?l.dockers[0]:l.dockers[l.dockers.length-1]);}.bind(this));var t=[];var e=10;u.each(function(l){u.each(function(x){if(Math.abs(x.bounds.center().x-l.bounds.center().x)<e&&Math.abs(x.bounds.center().y-l.bounds.center().y)<e&&x!==l){if(!t.include(x.parent)&&x.parent.getStencil().keepState()){t.push(x.parent);}}});});t.each(function(x,l){if(x){k.setReferencePoint({x:a>0?(b.upperLeft().x-g.upperLeft().x)+(l+1)/(m.length+1)*b.width():k.referencePoint.x,y:o>0?(b.upperLeft().y-g.upperLeft().y)+(l+1)/(m.length+1)*b.height():k.referencePoint.y});if(s.isDocked()){s.setReferencePoint({x:a>0?(b.upperLeft().x-p.upperLeft().x)+(l+1)/(m.length+1)*b.width():s.referencePoint.x,y:o>0?(b.upperLeft().y-p.upperLeft().y)+(l+1)/(m.length+1)*b.height():s.referencePoint.y});}else{s.bounds.centerMoveTo({x:(["left","right"].include(c)?s.bounds.center().x:k.getAbsoluteReferencePoint().x),y:(["left","right"].include(c)?k.getAbsoluteReferencePoint().y:s.bounds.center().y)});}x._update(true);}}.bind(this));return true;}},getRelevantEdges:function(c,f,d,e,b){var g=e?[e.getSource(),e.getTarget()].compact():[];var a=c.getAllDockedShapes().findAll(function(k){if(k instanceof ORYX.Core.Node){return false;}if(k.dockers[0].getDockedShape()===c){var h=k.dockers[1];}else{var h=k.dockers[k.dockers.length-2];}if(b&&!(g.include(k.getSource())&&g.include(k.getTarget()))){return false;}return f.getSide(h.bounds.center())===d;}.bind(this));if(e instanceof ORYX.Core.Edge&&!a.include(e)){a.push(e);}return a.sort(function(k,h){if(k.dockers[0].getDockedShape()===c){var m=k.dockers[0];var l=k.dockers[1];}else{var m=k.dockers[k.dockers.length-1];var l=k.dockers[k.dockers.length-2];}if(h.dockers[0].getDockedShape()===c){var o=h.dockers[0];var n=h.dockers[1];}else{var o=h.dockers[h.dockers.length-1];var n=h.dockers[h.dockers.length-2];}m=m.bounds.center();l=l.bounds.center();o=o.bounds.center();n=n.bounds.center();return d==="top"||d==="bottom"?Math.round(m.x-o.x)<0?-1:(Math.round(m.x-o.x)>0?1:0):Math.round(m.y-o.y)<0?-1:(Math.round(m.y-o.y)>0?1:0);});},removeAllDocker:function(a){a.dockers.slice(1,a.dockers.length-1).each(function(b){a.removeDocker(b);});}});}());if(!ORYX){var ORYX={};}if(!ORYX.Plugins){ORYX.Plugins={};}(function(){ORYX.Plugins.SelectStencilSetPerspective=Clazz.extend({facade:undefined,extensions:undefined,perspectives:undefined,construct:function(d){this.facade=d;var c={cls:"selectssperspective",border:false,autoWidth:true};if(Ext.isIPad){c.anchor="100%";c.layout="anchor";}var a=new Ext.Panel(c);this.facade.addToRegion("west",a);var b=this.facade.getStencilSetExtensionDefinition();var f=this.facade.getStencilSets();var e=f.keys();this.extensions={};b.extensions.each(function(g){if(e.include(g["extends"])){this.extensions[g.namespace]=g;}}.bind(this));this.perspectives={};b.perspectives.each(function(g){if(e.include(g.stencilset)){this.perspectives[g.namespace]=g;}}.bind(this));f.values().each(function(h){var g=b.perspectives.findAll(function(m){return m.stencilset==h.namespace();});if(g.size()===1){var l=function(){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,l);this.loadPerspective(g.first().namespace);}.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,l);}else{if(g.size()>1){this.createPerspectivesCombobox(a,h,g);}else{var k=function(){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,k);this.loadPerspective();}.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,k);}}}.bind(this));},createPerspectivesCombobox:function(c,a,f){var g=ORYX.I18N.Language.split("_").first();var e=[];f.each(function(h){e.push([h.namespace,(h["title_"+g]||h.title).unescapeHTML(),h["description_"+g]||h.description]);});var d=new Ext.data.SimpleStore({fields:["namespace","title","tooltip"],data:e});var b=new Ext.form.ComboBox({anchor:"100%",store:d,displayField:"title",valueField:"namespace",forceSelection:true,typeAhead:true,mode:"local",allowBlank:false,autoWidth:true,triggerAction:"all",emptyText:"Select a perspective...",selectOnFocus:true,tpl:'<tpl for="."><div '+(Ext.isIE9?"title":"ext:qtip")+'="{tooltip}" class="x-combo-list-item">{[(values.title||"").escapeHTML()]}</div></tpl>',editable:false,readOnly:true});c.add(b);c.doLayout();b.on("beforeselect",this.onSelect,this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){this.facade.getStencilSets().values().each(function(h){var k=h.extensions().values();if(k.length>0){var l=f.find(function(m){return(m.extensions||[]).include(k[0].namespace)||(m.addExtensions||[]).any(function(n){return(n.ifIsLoaded===h.namespace()&&n.add==k[0].namespace)||(n.ifIsLoaded!==h.namespace()&&n["default"]===k[0].namespace);});});if(!l){l=f.find(function(m){return !(m.extensions instanceof Array)||m.extensions.length<=0;});}if(l){b.setValue(e[f.indexOf(l)][1]);this.loadPerspective(e[f.indexOf(l)][0]);throw $break;}}b.setValue(e[0][1]);this.loadPerspective(e[0][0]);}.bind(this));}.bind(this));},onSelect:function(b,a){if(b.getValue()===a.get("namespace")||b.getValue()===a.get("title")){return;}this.loadPerspective(a.json[0]);},loadPerspective:function(e){if(!e){this._loadExtensions([],[],true);return;}var d=this.facade.getStencilSets();var c=new Object();var f=this.perspectives[e];d.values().each(function(h){h.extensions().values().each(function(k){if(this.extensions[k.namespace]){c[k.namespace]=k;}}.bind(this));}.bind(this));var a=new Array();if(f.addExtensions||f.extensions){[].concat(this.perspectives[e].addExtensions||[]).concat(this.perspectives[e].extensions||[]).compact().each(function(h){if(!h.ifIsLoaded){a.push(this.extensions[h]);return;}if(c[h.ifIsLoaded]&&this.extensions[h.add]){a.push(this.extensions[h.add]);}else{if(h["default"]&&this.extensions[h["default"]]){a.push(this.extensions[h["default"]]);}}}.bind(this));}if(this.perspectives[e].removeAllExtensions){window.setTimeout(function(){this._loadExtensions(a,undefined,true);}.bind(this),10);return;}var g=new Array();if(f.removeExtensions){f.removeExtensions.each(function(h){if(c[h]){g.push(this.extensions[h]);}}.bind(this));}if(f.extensions&&!f.addExtensions&&!f.removeExtensions){var b=[].concat(a).concat(g).compact();$H(c).each(function(k){var h=k.key;if(!k.value.includeAlways&&!b.any(function(l){return l.namespace==h;})){g.push(this.extensions[h]);}}.bind(this));}window.setTimeout(function(){this._loadExtensions(a,g,false,e);}.bind(this),10);},_loadExtensions:function(a,e,d,c){var f=this.facade.getStencilSets();var h=false;f.values().each(function(k){var l=k.extensions().values().select(function(m){return a[m.namespace]==undefined;});if(d){l.each(function(m){if(!m.includeAlways){k.removeExtension(m.namespace);h=true;}});}else{l.each(function(n){var m=e.find(function(o){return n.namespace===o.namespace;});if(m){k.removeExtension(n.namespace);h=true;}});}});a.each(function(l){if(!l||!l["extends"]){return;}var k=f[l["extends"]];if(k){if((l.definition||"").startsWith("/")){k.addExtension(l.definition);}else{k.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+l.definition);}h=true;}}.bind(this));if(h){f.values().each(function(k){this.facade.getRules().initializeRules(k);}.bind(this));}var g={};if(c){[].concat(this.perspectives[c].addExtensions||[]).concat(this.perspectives[c].extensions||[]).compact().each(function(k){var l=undefined;f.values().any(function(m){l=m.extensions().values().find(function(n){return(n.namespace===k);}.bind(this));return l;}.bind(this));if(l){g[l.namespace]=l;}}.bind(this));}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,stencilsets:f,extensions:g});if(h){var b=this.facade.getSelection();this.facade.setSelection();if(!b||b.length==0){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SELECTION_CHANGED,elements:[],force:false});}else{this.facade.setSelection(b);}}}});})();if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.ShapeRepository={facade:undefined,construct:function(d){this.facade=d;this._currentParent;this._canContain=undefined;this._canAttach=undefined;this.shapeList=new Ext.tree.TreeNode({});var c={cls:"shaperepository",loader:new Ext.tree.TreeLoader(),root:this.shapeList,autoScroll:true,rootVisible:false,lines:false};if(Ext.isIPad){c.anchor="100% -20";}else{c.anchors="0, -30";}var a=new Ext.tree.TreePanel(c);var e=this.facade.addToRegion("west",a,ORYX.I18N.ShapeRepository.title);var b=new ORYX.Core.DragZone(this.shapeList.getUI().getEl(),this.facade);b.afterValidDrop=this.drop.bind(this);this.setStencilSets();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,this.setStencilSets.bind(this));},registryChanged:function(a){this.pluginsData=(a||[]).findAll(function(b){return b&&b.target&&b.target===ORYX.Plugins.ShapeRepository;});},setStencilSets:function(b){var c=this.shapeList.firstChild;while(c){this.shapeList.removeChild(c);c=this.shapeList.firstChild;}var a=[];if(b&&b.stencilsets&&b.extensions){b.stencilsets.values().each(function(d){d.extensions().values().each(function(e){if(!($H(b.extensions).keys().member(e.namespace))&&e.stencils){e.stencils.each(function(f){a.push(f.id);}.bind(this));}}.bind(this));}.bind(this));}this.facade.getStencilSets().values().each(function(o){var f;var n=o.title(),q="x-stencilset-"+String(o.namespace().split("/").last()).toLowerCase().replace(/[^a-z0-9]/g,"");var m=o.extensions();if(m&&m.size()>0){var k=m.values().find(function(s){return !s.includeAlways&&s.title;});n+=k?" / "+ORYX.Core.StencilSet.getTranslation(k,"title"):"";if(k){q+=" "+"x-stencilsetextension-"+String(k.namespace.split("/").last()).toLowerCase().replace(/[^a-z0-9]/g,"");}}this.shapeList.appendChild(f=new Ext.tree.TreeNode({text:Signavio.Utils.escapeHTML(n),allowDrag:false,allowDrop:false,iconCls:"headerShapeRepImg",cls:"headerShapeRep",singleClickExpand:true}));f.ui.render=function(){Ext.tree.TreeNodeUI.prototype.render.apply(this,arguments);this.wrap.className+=" "+q;};f.render();f.expand();var e=o.stencils(this.facade.getCanvas().getStencil(),this.facade.getRules());if(this.pluginsData){var l=[];this.pluginsData.each(function(s){var r=this.getOfferWrap(s,b);e.push(r);}.bind(this));}var h=e.invoke("groups").flatten().compact().uniq();e=e.findAll(function(r){return !r.hide();});var p=(e.length-a.length<=ORYX.CONFIG.MAX_NUM_SHAPES_NO_GROUP||h.length<=1);var g=new Hash();g["noGroup"]=[];h.each(function(r){g[r]=[];});e.sortBy(function(r){return("function"==typeof r.index?r.index():null)||0;}).each(function(s){var r=s.groups instanceof Function&&s.groups()||[];if(r.length===0){r=["noGroup"];}r.each(function(t){if("function"==typeof s.index&&"number"===typeof s.index()){g[t]=g[t].slice(0,s.index()).concat(s,g[t].slice(s.index()));}else{g[t].push(s);}}.bind(this));});if(p){(g.values().flatten()||[]).each(function(r){if(!(a&&a.member(r.id()))){if(r.onTreeAdd instanceof Function){r.onTreeAdd(this,f,l);}else{this.createStencilTreeNode(f,r);}}}.bind(this));}else{var d=new Hash();g.each(function(r){if(r.key==="noGroup"||r.value.length===0){return;}if(!d[r.key]){d[r.key]=new Ext.tree.TreeNode({text:r.key,allowDrag:false,allowDrop:false,iconCls:"headerShapeRepImg",cls:"headerShapeRepChild",singleClickExpand:true});d[r.key].ui.render=function(){Ext.tree.TreeNodeUI.prototype.render.apply(this,arguments);this.wrap.className+=" "+"x-stencil-group-"+r.key.toLowerCase();};f.appendChild(d[r.key]);d[r.key].render();}r.value.each(function(s){if(!(a&&a.member(s.id()))){if(s.onTreeAdd instanceof Function){s.onTreeAdd(this,d[r.key],l);}else{this.createStencilTreeNode(d[r.key],s);}}}.bind(this));}.bind(this));if(g["noGroups"]){g["noGroups"].each(function(r){if(!(a&&a.member(r.id()))){if(r.onTreeAdd instanceof Function){r.onTreeAdd(this,f,l);}else{this.createStencilTreeNode(f,r);}}}.bind(this));}}if(this.pluginsData){l.each(function(u){var r=u.element;var t=u.offer;var s=t.callbacks;var v=new ORYX.Core.DragZone(r.getUI().getEl(),this.facade);if(s){if(s.afterDragEnter){v.afterDragEnter=s.afterDragEnter;}if(s.afterDragOver){v.afterDragOver=s.afterDragOver;}if(s.afterDragOut){v.afterDragOut=s.afterDragOut;}if(s.afterDragDrop){v.afterDragDrop=s.afterDragDrop;}if(s.onValidDrop){v.onValidDrop=s.onValidDrop;}}}.bind(this));}if(this.shapeList.firstChild.firstChild){this.shapeList.firstChild.firstChild.expand(false,true);}}.bind(this));},createPluginTreeNode:function(a,b){var d=new Ext.tree.TreeNode({text:b.title(),icon:b.icon(),allowDrag:false,allowDrop:false,iconCls:"ShapeRepEntreeImg",cls:"ShapeRepEntree"});a.appendChild(d);d.render();var c=d.getUI();c.elNode.setAttributeNS(null,"title",b.description());Ext.dd.Registry.register(c.elNode,{node:c.node,handles:[c.elNode,c.textNode].concat($A(c.elNode.childNodes)),isHandle:false,type:b.id(),namespace:b.namespace()});return d;},createStencilTreeNode:function(a,b){var d=new Ext.tree.TreeNode({text:b.title(),icon:b.icon(),allowDrag:false,allowDrop:false,iconCls:"ShapeRepEntreeImg",cls:"ShapeRepEntree "+("x-stencil-"+b.idWithoutNs().toLowerCase())});a.appendChild(d);d.render();var c=d.getUI();c.elNode.setAttributeNS(null,"title",b.description());Ext.dd.Registry.register(c.elNode,{node:c.node,handles:[c.elNode,c.textNode].concat($A(c.elNode.childNodes)),isHandle:false,type:b.id(),namespace:b.namespace()});return d;},drop:function(b,a,c){var d=new ORYX.Core.CreateShapeCommand(b,a,b.position,this);this.facade.executeCommands([d]);this._currentParent=undefined;},getOfferWrap:function(b,a){return{title:function(){return b.title;},description:function(){return b.description;},icon:(b.icon instanceof Function?b.icon:function(){return b.icon;}),id:function(){return b.id;},idWithoutNs:function(){return b.id.replace(b.namespace,"");},groups:function(){return(b.groups instanceof Array?b.groups:[b.groups]);},namespace:function(){return b.namespace;},hide:function(){return(b.hide instanceof Function?b.hide(a):false);},callbacks:{afterDragEnter:b.afterDragEnterClb,afterDragOver:b.afterDragOverClb,afterDragOut:b.afterDragOutClb,afterDragDrop:b.afterDragDropClb,onValidDrop:b.onValidDropClb},onTreeAdd:function(e,d,c){if(!c){c=[];}c.push({element:e.createStencilTreeNode.apply(e,[d,this]),offer:this});},index:function(){return("function"==typeof b.index?b.index():b.index)||null;}};}};ORYX.Plugins.ShapeRepository=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.ShapeRepository);if(!ORYX){var ORYX={};}if(!ORYX.Plugins){ORYX.Plugins={};}(function(){ORYX.Plugins.PropertyWindow={facade:undefined,construct:function(facade){this.facade=facade;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW,this.init.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.selectDiagram.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW_DIALOG,this.handleShowDialog.bind(this));this.init();this.initStencilSetSpecifics();var cp=new Ext.state.CookieProvider({path:window.location.pathname,expires:new Date(new Date().getTime()+(1000*60*60*24*7))});Ext.state.Manager.setProvider(cp);this.expandedGroups=$H({meta:true,popular:true,tim:true,saperion:true});},handleShowDialog:function(event){var prop,col,row,editor,fn;if(!event.propertyKey){return;}prop=event.propertyKey;col=this.grid.getColumnModel().getIndexById("propertywindow_column_value");row=this.grid.store.findBy(function(r){return r.get("gridProperties").propId==prop;});this.grid.startEditing(row,col);editor=this.grid.getColumnModel().config[col].editor;editor.setValue(this.grid.store.getAt(row).get("value"));editor.field.onTriggerClick();fn=function(){editor.un("startedit",fn,this);this.grid.stopEditing();};editor.on("startedit",fn,this);},initStencilSetSpecifics:function(){},registryChanged:function(offers){this.pluginsData=(offers||[]).findAll(function(offer){return offer&&offer.target&&offer.target===ORYX.Plugins.PropertyWindow&&!(offer.getPanel instanceof Function);});var root=this.grid.view.scroller;(offers||[]).findAll(function(offer){return offer&&offer.target&&offer.target===ORYX.Plugins.PropertyWindow&&offer.getPanel instanceof Function;}).each(function(offer){var offerPanel=offer.getPanel();offerPanel.ownerCt=this.grid;offerPanel.render(root);}.bind(this));},init:function(){this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,["div"]);this.currentDateFormat;this.popularProperties=[];this.characteristicNrProperties=[];this.otherProperties=[];this.metaProperties=[];this.properties=[];this.shapeSelection=new Hash();this.shapeSelection.shapes=new Array();this.shapeSelection.commonProperties=new Array();this.shapeSelection.commonPropertiesValues=new Hash();this.updaterFlag=false;this.columnModel=new Ext.grid.ColumnModel([{header:ORYX.I18N.PropertyWindow.name,dataIndex:"name",width:90,sortable:true,editable:false,renderer:this.tooltipRenderer.bind(this)},{header:ORYX.I18N.PropertyWindow.value,dataIndex:"value",id:"propertywindow_column_value",width:110,editor:new Ext.form.TextField({allowBlank:false}),renderer:this.renderer.bind(this)},{header:"Category",dataIndex:"category",hidden:true,editable:false,sortable:true}]);this.dataSource=new Ext.data.GroupingStore({afterEdit:function(record){if(this.indexOf(record)==-1){var rr=this.data.items.find(function(r){return r.get("gridProperties").propId===record.get("gridProperties").propId;});if(!rr){return;}rr.isEditing=true;rr.set("value",record.get("value"));rr.isEditing=false;record=rr;}Ext.data.GroupingStore.prototype.afterEdit.apply(this,[record]);},proxy:new Ext.data.MemoryProxy(this.properties),reader:new Ext.data.ArrayReader({},[{name:"category"},{name:"name"},{name:"value"},{name:"icons"},{name:"gridProperties"}]),sortInfo:{field:"category",direction:"ASC"},sortData:function(f,direction){direction=direction||"ASC";var st=this.fields.get(f).sortType;var fn=function(r1,r2){var v1=st(r1.data[f]),v2=st(r2.data[f]);var p1=r1.data["category"],p2=r2.data["category"];if(p1==p2){return(v1>v2?1:(v1<v2?-1:0));}else{if(p1=="meta"){return -1;}else{if(p2=="meta"){return 1;}else{if(p1=="popular"){return -1;}else{if(p2=="popular"){return 1;}else{if(p1=="saperion"){return -1;}else{if(p2=="saperion"){return 1;}else{if(p1=="carestation"){return -1;}else{if(p2=="carestation"){return 1;}else{if(p1=="characteristicNr"){return -1;}else{if(p2=="characteristicNr"){return 1;}else{if(p1=="tim"){return -1;}else{if(p2=="tim"){return 1;}else{return 0;}}}}}}}}}}}}}};this.data.sort(direction,fn);if(this.snapshot&&this.snapshot!=this.data){this.snapshot.sort(direction,fn);}},groupField:"category"});this.dataSource.load();this.grid=new Ext.grid.EditorGridPanel({clicksToEdit:1,stripeRows:true,selModel:new Ext.grid.CellSelectionModel({listeners:{beforecellselect:function(foo,rowIndex,colIndex){return !this.columnModel.isHidden(colIndex)&&colIndex===1;}.bind(this)}}),anchor:"100% 100%",autoExpandColumn:"propertywindow_column_value",width:"auto",colModel:this.columnModel,enableHdMenu:false,enableColumnMove:false,view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{[ORYX.I18N.PropertyWindow.Category[(values.rs.first().data.category||"").toLowerCase()]||ORYX.I18N.PropertyWindow.Category.others]}',toggleGroup:function(group,expanded){this.grid.stopEditing();Ext.grid.GroupingView.prototype.toggleGroup.apply(this,arguments);}}),store:this.dataSource,listeners:{click:function(){this.facade.getCanvas().focus();}.bind(this),cellclick:function(grid,row,column){if(column===0){grid.fireEvent("cellclick",grid,row,1);}}}});this.region=this.facade.addToRegion("east",this.grid,ORYX.I18N.PropertyWindow.title);this.grid.on("beforeedit",this.beforeEdit,this,true);this.grid.on("afteredit",this.afterEdit,this,true);this.grid.view.on("refresh",this.onRefresh,this,true);this.grid.enableColumnMove=false;},selectDiagram:function(){this.shapeSelection.shapes=[this.facade.getCanvas()];this.setPropertyWindowTitle();this.identifyCommonProperties();this.createProperties();},specialKeyDown:function(field,event){if(field instanceof Ext.form.TextArea&&event.button==ORYX.CONFIG.KEY_Code_enter){return false;}},tooltipRenderer:function(value,p,record){var prop;if(record.data&&record.data.gridProperties&&record.data.gridProperties.tooltip){p.cellAttr='title="'+record.data.gridProperties.tooltip+'"';}if(!record.data.gridProperties){return;}prop=record.data.gridProperties.property;if(ORYX.CONFIG.MULTI_LANGUAGES_ENABLED&&prop&&prop.language()){var oprop=prop.origin();if(this.facade.getCanvas().getLanguage()!=prop.language()){p.css="x-cell-inactive";}else{if(prop.value()==record.get("value")&&$H(ORYX.CONFIG.MULTI_LANGUAGES||{}).keys().any(function(lang){var key=oprop.prefix()+"-"+oprop.id()+(lang==ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT?"":"_"+lang);return(this.shapeSelection.commonPropertiesValues[key]||"")!=oprop.value();}.bind(this))){p.css="x-cell-invalid";}}}return value;},stripEvilCharacters:function(value,remove){value=value.gsub("<",remove?"":"&lt;");value=value.gsub(">",remove?"":"&gt;");value=value.gsub("%",remove?"":"&#37;");value=value.gsub("&",remove?"":"&amp;");return value;},renderer:function(value,p,record){var type,optType;if(record.data.gridProperties&&record.data.gridProperties.type){type=record.data.gridProperties.type;}else{optType=record.fields.items.find(function(t){return t.name===p.id;});if(optType){type=optType.type;}}this.tooltipRenderer(value,p,record);if(typeof value==="boolean"){value=String(value).toLowerCase();}if(value instanceof Date){value=value.dateFormat(record.data.gridProperties.property.dateFormat()||ORYX.I18N.PropertyWindow.dateFormat);}else{if(typeof value=="string"&&!value.include("<a href='")){value=this.stripEvilCharacters(value);if(type===ORYX.CONFIG.TYPE_COLOR){if(value){value="<div class='prop-background-color' style='background-color:"+value+"' />";}}else{if(type===ORYX.CONFIG.TYPE_GLOSSARY_LINK){value=this.parseGlossaryValue(value,record.data.gridProperties.propId);}else{if(type===ORYX.CONFIG.TYPE_CHOICE){var item=record.get("gridProperties").property.item(value);value=item?this.stripEvilCharacters(item.title(),true):value;}else{if(type===ORYX.CONFIG.TYPE_COMPLEX){try{value=value.evalJSON().items.map(function(o){return $H(o).values().map(function(r){return(r&&typeof r=="string"?Signavio.Utils.escapeHTML(Signavio.Utils.unescapeHTML(r).truncate(10,"<small></small>")):"")||undefined;}).compact().join(", ");}).truncate(5).join("<br/>");}catch(e){}}else{if(type===ORYX.CONFIG.TYPE_BOOLEAN){value=value===true||value==="true"||value===1||value==="1"?"<img src='"+ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/check_small.png' style='left:6px;margin-left:-6px;position:relative;top:1px;'/>":"";}else{if(type===ORYX.CONFIG.TYPE_FLOAT){value=String(value).replace(".",",");}else{if(type===ORYX.CONFIG.TYPE_URL&&value.trim()){value='<a href="'+(value)+'" target="_blank" class="x-link" onclick="window.open(\''+(value)+"');return false;\">"+(value)+"</a>";}else{if(record.data.gridProperties&&record.data.gridProperties.editor&&record.data.gridProperties.editor.field&&record.data.gridProperties.editor.field.renderer instanceof Function){value=record.data.gridProperties.editor.field.renderer(value);}}}}}}}}if(record.data.icons instanceof Array){record.data.icons.each(function(each){if(each.name==value){if(each.icon){value="<img src='"+each.icon+"' /> "+value;}}});}}else{if(value instanceof Array){if(type===ORYX.CONFIG.TYPE_GLOSSARY_LINK){value=value.map(function(glossary){return this.parseGlossaryValue(glossary,record.data.gridProperties.propId);}.bind(this)).flatten().uniq();}else{if(type===ORYX.CONFIG.TYPE_URL){value=value.map(function(url){if(url&&url.url){return'<a href="'+(Signavio.Utils.escapeHTML(url.url))+'" target="_blank" class="x-link" onclick="window.open(\''+(Signavio.Utils.escapeHTML(url.url))+"');return false;\">"+(Signavio.Utils.escapeHTML(url.label||url.url||"-"))+"</a>";}else{return"";}}).compact();}}return value.truncate(5).join("<br/>");}else{if("number"==typeof value){value=String(value).replace(".",",");}else{if("object"==typeof value&&record.data.gridProperties&&record.data.gridProperties.editor&&record.data.gridProperties.editor.field&&record.data.gridProperties.editor.field.renderer instanceof Function){value=record.data.gridProperties.editor.field.renderer(value);}}}}}return value;},parseGlossaryValue:function(value,property){var shape=this.shapeSelection.shapes[0]||undefined;if(shape){var glossary;if(ORYX.Utils.isGlossaryEntry(value)){glossary={text:ORYX.Utils.glossaryTitle(value),glossary:ORYX.Utils.glossaryId(value)};}else{if(this.facade.hasGlossaryExtension){glossary=this.facade.getGlossary(shape,property);}}if(glossary){if(glossary instanceof Array){return glossary.map(function(g){return"<a href='"+ORYX.CONFIG.SERVER_GLOSSARY_PREFIX+g.glossary+"' class='x-show-glossary' target='_blank'>"+Signavio.Utils.escapeHTML(g.text)+"</a>";});}else{return"<a href='"+ORYX.CONFIG.SERVER_GLOSSARY_PREFIX+glossary.glossary+"' class='x-show-glossary' target='_blank'>"+Signavio.Utils.escapeHTML(glossary.text)+"</a>";}}}return value;},onRefresh:function(){this.grid.view.el.select("a.x-show-glossary").on("click",function(evt){Event.stop(evt);var gId=(evt.target.getAttribute("href")||"").replace(ORYX.CONFIG.SERVER_GLOSSARY_PREFIX,"");if(gId){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_GLOSSARY_SHOW,glossary:gId});}}.bind(this)).removeClass("x-show-glossary");},beforeEdit:function(option){var editorGrid=this.dataSource.getAt(option.row).data.gridProperties.editor;var editorRenderer=this.dataSource.getAt(option.row).data.gridProperties.renderer;var key=this.dataSource.getAt(option.row).data.gridProperties.propId;var prop=this.dataSource.getAt(option.row).data.gridProperties.property;if(editorGrid){if(!editorGrid.field.readOnly){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}option.grid.getColumnModel().setEditor(1,editorGrid);editorGrid.field.row=option.row;editorGrid.render(this.grid);editorGrid.setSize(option.grid.getColumnModel().getColumnWidth(1),editorGrid.height);}else{return false;}this.oldValues=new Hash();this.oldFormats=new Hash();if(key&&prop){this.shapeSelection.shapes.each(function(shape){var glossary=(this.facade.hasGlossaryExtension)?this.facade.getGlossary(shape,prop):undefined;if(glossary){this.oldValues[shape.getId()]=glossary instanceof Array?glossary.invoke("toString"):glossary.toString();}else{this.oldValues[shape.getId()]=shape.properties[key];this.oldFormats[shape.getId()]=shape.formats[key];}}.bind(this));}},afterEdit:function(option){option.grid.getStore().commitChanges();var key=option.record.data.gridProperties.propId;var selectedElements=this.shapeSelection.shapes.filter(function(shape){return shape.getStencil().property(key)!==undefined;});var oldValues=this.oldValues;var oldFormats=this.oldFormats;var newValue=option.value;var newFormat=option.format;var facade=this.facade;if(!oldValues.any(function(r){return r.value!==newValue;})&&!oldFormats.any(function(f){return f.value!==newFormat;})){return;}var commandClass=ORYX.Core.Command.extend({construct:function(){this.key=key;this.selectedElements=selectedElements;this.oldValues=oldValues;this.oldFormats=oldFormats;this.newValue=newValue;this.newFormat=newFormat;this.facade=facade;this.grid=option.grid;this.record=option.record;},execute:function(){var needsupdate=false;this.selectedElements.each(function(shape){if(!shape.getStencil().property(this.key).readonly()){shape.setFormat(this.key,this.newFormat);shape.setProperty(this.key,this.newValue);}needsupdate=needsupdate||shape.getStencil().property(this.key).dependentProperties().length>0;}.bind(this));if(needsupdate){this.facade.setSelection([]);}var me=this;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:me.selectedElements,key:me.key,value:me.newValue});this.facade.setSelection(this.selectedElements);this.record.set("value",this.newValue);this.grid.getStore().commitChanges();this.grid.view.refresh();},rollback:function(){var needsupdate=false;this.selectedElements.each(function(shape){shape.setFormat(this.key,this.oldFormats[shape.getId()]);shape.setProperty(this.key,this.oldValues[shape.getId()]);this.record.set("value",this.oldValues[shape.getId()]);needsupdate=needsupdate||shape.getStencil().property(this.key).dependentProperties().length>0;}.bind(this));if(needsupdate){this.facade.setSelection([]);}var me=this;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:me.selectedElements,key:me.key,values:me.oldValues});this.facade.setSelection(this.selectedElements);this.grid.getStore().commitChanges();this.grid.view.refresh();}});var command=new commandClass();this.facade.executeCommands([command]);},editDirectly:function(key,value){this.shapeSelection.shapes.each(function(shape){if(shape.getStencil().property(key)!==undefined&&!shape.getStencil().property(key).readonly()){shape.setProperty(key,value);}}.bind(this));var selectedElements=this.shapeSelection.shapes.filter(function(shape){return shape.getStencil().property(key)!==undefined;}.bind(this));this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:selectedElements,key:key,value:value});this.facade.getCanvas().update();},updateAfterInvalid:function(key){this.shapeSelection.shapes.each(function(shape){if(!shape.getStencil().property(key).readonly()){shape.setProperty(key,this.oldValues[shape.getId()]);shape.update();}}.bind(this));this.facade.getCanvas().update();},dialogClosed:function(data,format){var row=this.field?this.field.row:this.row;this.scope.afterEdit({grid:this.scope.grid,record:this.scope.grid.getStore().getAt(row),value:data,format:format});},setPropertyWindowTitle:function(){if(this.shapeSelection.shapes.length==1){this.region.setTitle(ORYX.I18N.PropertyWindow.title+" ("+this.shapeSelection.shapes.first().getStencil().title()+")");}else{this.region.setTitle(ORYX.I18N.PropertyWindow.title+" ("+this.shapeSelection.shapes.length+" "+ORYX.I18N.PropertyWindow.selected+")");}},setCommonPropertiesValues:function(){this.shapeSelection.commonPropertiesValues=new Hash();this.shapeSelection.commonProperties.each(function(property){var key=property.prefix()+"-"+property.id();var emptyValue=false;var firstShape=this.shapeSelection.shapes.first();var valueToCompareWith=firstShape.properties[key];if("undefined"==typeof valueToCompareWith){valueToCompareWith=property.value();}else{if(""===valueToCompareWith&&valueToCompareWith!==property.value()){valueToCompareWith=property.value();}}this.shapeSelection.shapes.each(function(shape){if(property.alwaysAppearInMultiselect()){if(valueToCompareWith===undefined&&shape.properties[key]!==undefined){valueToCompareWith=shape.properties[key];}else{if(valueToCompareWith!==undefined&&shape.properties[key]!==undefined&&valueToCompareWith!=shape.properties[key]){emptyValue=true;}}}else{if(valueToCompareWith!=shape.properties[key]&&"undefined"!=typeof shape.properties[key]&&""!==shape.properties[key]){emptyValue=true;}}}.bind(this));if(!emptyValue){this.shapeSelection.commonPropertiesValues[key]=valueToCompareWith;}}.bind(this));},getStencilSetOfSelection:function(){var stencils=new Hash();this.shapeSelection.shapes.each(function(shape){stencils[shape.getStencil().id()]=shape.getStencil();});return stencils;},identifyCommonProperties:function(){this.shapeSelection.commonProperties.clear();var stencils=this.getStencilSetOfSelection();var firstStencil=stencils.values().first();var comparingStencils=stencils.values().without(firstStencil);if(comparingStencils.length==0){this.shapeSelection.commonProperties=firstStencil.properties();}else{var properties=new Hash();var propertiesAlwaysToAppear=new Hash();firstStencil.properties().each(function(property){if(property.alwaysAppearInMultiselect()){propertiesAlwaysToAppear[property.namespace()+"-"+property.id()+"-"+property.type()]=property;}else{properties[property.namespace()+"-"+property.id()+"-"+property.type()]=property;}});comparingStencils.each(function(stencil){var intersection=new Hash();stencil.properties().each(function(property){if(property.alwaysAppearInMultiselect()){propertiesAlwaysToAppear[property.namespace()+"-"+property.id()+"-"+property.type()]=property;}else{if(properties[property.namespace()+"-"+property.id()+"-"+property.type()]){intersection[property.namespace()+"-"+property.id()+"-"+property.type()]=property;}}});properties=intersection;});propertiesAlwaysToAppear.each(function(pair){properties[pair.key]=pair.value;});this.shapeSelection.commonProperties=properties.values();if(this.shapeSelection.shapes.length>1){this.shapeSelection.commonProperties=this.shapeSelection.commonProperties.findAll(function(prop){return prop.type()!==ORYX.CONFIG.TYPE_DIAGRAM_LINK;});}}},isEqual:function(a,b){return(a===b||(a.length===b.length&&a.all(function(r){return b.include(r);})))&&(a.length==0||this.shapeSelection.commonProperties);},isDirty:function(a){return a.any(function(shape){return shape.isPropertyChanged();});},onSelectionChanged:function(event){if(this.shapeSelection&&this.isEqual(this.shapeSelection.shapes,event.elements)&&event.force){return;}var ar=this.grid.activeEditor;this.grid.stopEditing();if(ar){ar.destroy();}window.clearTimeout(this.timer);this.shapeSelection.shapes=event.elements;if(event.elements.length==0){this.shapeSelection.shapes=[this.facade.getCanvas()];}if(event.subSelection){this.shapeSelection.shapes=[event.subSelection];}this.timer=window.setTimeout(function(){this.setPropertyWindowTitle();this.identifyCommonProperties();this.setCommonPropertiesValues();this.createProperties();}.bind(this),1);},createProperties:function(){this.properties=[];this.popularProperties=[];this.metaProperties=[];this.characteristicNrProperties=[];this.otherProperties=[];if(this.shapeSelection.commonProperties){this.shapeSelection.commonProperties.each((function(pair,index){if(!pair.hasValidDependency(this.shapeSelection.commonPropertiesValues)){return;}if(!ORYX.CONFIG.MULTI_LANGUAGES_ENABLED&&pair.language()&&pair.language()!=this.facade.getCanvas().getLanguage()){return;}var key=pair.prefix()+"-"+pair.id();var name=pair.title()+(ORYX.CONFIG.MULTI_LANGUAGES_ENABLED&&pair.language()?" ("+Signavio.I18N.Multilanguage[pair.language().toUpperCase()+"_Short"]+")":"");var icons=[];var attribute=this.shapeSelection.commonPropertiesValues[key];var editorGrid=undefined;var editorRenderer=null;var me=this;var refToViewFlag=false;if(!pair.readonly()){switch(pair.type()){case ORYX.CONFIG.TYPE_STRING:var editor;if(pair.wrapLines()){editor=new Ext.form.TextArea({alignment:"tl-tl",allowBlank:pair.optional(),msgTarget:"title",maxLength:pair.length()});editor.on("keyup",function(textArea,event){this.editDirectly(key,textArea.getValue());}.bind(this));}else{if(pair.autocomplete()){var conf=pair.autocomplete();editor=new Ext.ux.form.ComboBox({hideTrigger:conf.trigger===false,forceSelection:conf.optional===false,typeAhead:conf.optional===false,url:conf.url,allowBlank:pair.optional()});}else{editor=new Ext.form.TextField({allowBlank:pair.optional(),msgTarget:"title",maxLength:pair.length()});editor.on("keyup",function(input,event){this.editDirectly(key,input.getValue());}.bind(this));editor.on("blur",function(input){if(!input.isValid(false)){this.updateAfterInvalid(key);}}.bind(this));editor.on("specialkey",function(input,e){if(!input.isValid(false)){this.updateAfterInvalid(key);}}.bind(this));}}editorGrid=new Ext.Editor(editor);break;case ORYX.CONFIG.TYPE_BOOLEAN:var editorCheckbox=new Ext.form.Checkbox();editorCheckbox.on("check",function(c,checked){this.editDirectly(key,checked);}.bind(this));editorCheckbox.on("render",function(){editorCheckbox.el.on("mousedown",function(evt){Event.stop(evt);});});editorGrid=new Ext.Editor(editorCheckbox);break;case ORYX.CONFIG.TYPE_INTEGER:var numberField=new Ext.form.NumberField({allowBlank:pair.optional(),allowDecimals:false,msgTarget:"title",minValue:pair.min(),maxValue:pair.max()});numberField.on("keyup",function(input,event){this.editDirectly(key,input.getValue());}.bind(this));editorGrid=new Ext.Editor(numberField);break;case ORYX.CONFIG.TYPE_FLOAT:var numberField=new Ext.form.NumberField({allowBlank:pair.optional(),allowDecimals:true,msgTarget:"title",minValue:pair.min(),maxValue:pair.max(),decimalPrecision:10,decimalSeparator:",",baseChars:"0123456789."});numberField.on("keyup",function(input,event){this.editDirectly(key,input.getValue());}.bind(this));editorGrid=new Ext.Editor(numberField);break;case ORYX.CONFIG.TYPE_COLOR:var editorPicker=new Ext.ux.ColorField({allowBlank:pair.optional(),msgTarget:"title"});editorPicker.on("select",function(picker){this.editDirectly(key,picker.getValue());}.bind(this));editorGrid=new Ext.Editor(editorPicker);break;case ORYX.CONFIG.TYPE_CHOICE:var items=pair.items();var options=[];items.each(function(value){if(value.value()==attribute){attribute=value.title();}if(value.refToView()[0]){refToViewFlag=true;}var title=value.title()||"";title=title.replace("<<","&lt;&lt;");title=title.replace(">>","&gt;&gt;");options.push([value.icon()||"",(title||"").unescapeHTML(),(value.value()||"").unescapeHTML()]);icons.push({name:value.title(),icon:value.icon()||""});});var store=new Ext.data.SimpleStore({fields:[{name:"icon"},{name:"title"},{name:"value"}],data:options});var editorCombo=new Ext.ux.form.ComboBox({tpl:'<tpl for="."><div class="x-combo-list-item">{[(values.icon) ? "<img src=\'" + values.icon + "\' />" : ""]} {[values.title.escapeHTML()]}</div></tpl>',store:store,displayField:"title",valueField:"value",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,editable:true,forceSelection:pair.allowCustomValue(),readOnly:false});editorCombo.on("select",function(combo,record,index){this.editDirectly(key,combo.getValue());}.bind(this));editorGrid=new Ext.Editor(editorCombo);break;case ORYX.CONFIG.TYPE_DATE:var format=pair.dateFormat();var altFormat="d/m/y|d.m.y|Y-m-d\\TH:i:s";if(!(attribute instanceof Date)){attribute=[].concat(format,altFormat.split("|")).map(function(form){return Date.parseDate(attribute,form)||null;}).compact().first()||attribute;}editorGrid=new Ext.Editor(new Ext.form.DateField({allowBlank:pair.optional(),format:format,altFormats:altFormat,msgTarget:"title"}));break;case ORYX.CONFIG.TYPE_TEXT:var cf=new Ext.form.ComplexTextField({allowBlank:pair.optional(),triggerClass:"x-trigger-other",dataSource:this.dataSource,cls:"x-gray-background",grid:this.grid,readOnly:true,row:index,facade:this.facade});cf.on("dialogClosed",this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_COMPLEX:var cf=new Ext.form.ComplexListField({allowBlank:pair.optional(),rendererFn:this.renderer.bind(this),readOnly:true},pair,key,this.facade);cf.on("dialogClosed",this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_EPC_FREQ:var cf=new Ext.form.EpcFrequencyTypeField({allowBlank:pair.optional(),dataSource:this.dataSource,grid:this.grid,row:index,facade:this.facade});cf.on("dialogClosed",this.dialogClosed,{scope:this,row:index,col:1,field:cf});editorGrid=new Ext.Editor(cf);break;case ORYX.CONFIG.TYPE_DIAGRAM_LINK:editorGrid=new Ext.Editor(new Ext.form.TriggerField({hideTrigger:false,triggerClass:"x-trigger-other",onTriggerClick:function(){this.facade.raiseEvent({type:"showlinkingwindow",shape:this.shapeSelection.shapes[0],property:key});}.bind(this)}));break;case ORYX.CONFIG.TYPE_GLOSSARY_LINK:editorGrid=new Ext.Editor(new Ext.ux.form.GlossaryField({linkableType:pair.linkableType(),loadingText:Signavio.I18N.Glossary_Support.renameLoading,emptyTextList:'<div class="x-no-entry">'+Signavio.I18N.Glossary_Support.renameEmpty+"</div>",zindex:8000,initValue:function(){if(this.value!==undefined&&ORYX.Utils.isGlossaryEntry(this.value)){this.records=[Ext.ux.data.RecordCreator.create("gitem","/glossary/"+ORYX.Utils.glossaryId(this.value),{title:ORYX.Utils.glossaryTitle(this.value)})];this.value=ORYX.Utils.glossaryTitle(this.value);}else{Ext.ux.form.GlossaryField.superclass.initValue.apply(this,arguments);}},setValue:function(value){if(value!==undefined&&ORYX.Utils.isGlossaryEntry(value)){value=ORYX.Utils.glossaryTitle(value);}Ext.ux.form.GlossaryField.superclass.setValue.apply(this,[value]);},getValue:function(){return(this.records||[]).map(function(rec){return rec.get("href")?ORYX.Utils.getInGlossarySchema(rec.get("href"),rec.get("rep").title):rec.get("rep");})[0]||"";},onCreateNew:function(record){if(!me.facade.hasGlossaryExtension){return true;}this.disableBlur();var sh={properties:{}};sh.properties[pair.id()]=record.get("rep").title;sh.category=record.get("rep").category;me.facade.raiseEvent({type:ORYX.CONFIG.EVENT_GLOSSARY_NEW,shape:sh,hasCategorySwitch:!this.linkableType,property:pair.id(),callback:function(record){if(record instanceof Ext.data.Record){this.onSelect(record);}else{this.collapse();this.selectedIndex=-1;}this.enableBlur();}.bind(this)});return false;},onNewRecord:function(record){this.records=[record];me.grid.stopEditing(false);}}));break;case ORYX.CONFIG.TYPE_URL:if(!pair.isList()){var editorInput=new Ext.form.TextField({allowBlank:pair.optional(),msgTarget:"title",maxLength:pair.length(),enableKeyEvents:true,prefixFileLocal:Ext.ux.form.UrlLinkFieldList.prototype.prefixFileLocal,prefixFileNetwork:Ext.ux.form.UrlLinkFieldList.prototype.prefixFileNetwork,prefixHTTP:Ext.ux.form.UrlLinkFieldList.prototype.prefixHTTP,getValue:function(){var url=Ext.form.TextField.prototype.getRawValue.call(this);if(Ext.ux.form.UrlLinkFieldList.prototype.isURL.call(this,url)){url=this.prefixHTTP+url;}return url;},listeners:{render:function(){editorInput.el.on("keyup",function(event){Ext.ux.form.UrlLinkFieldList.prototype.evaluateLokalURL.call(editorInput);this.editDirectly(key,editorInput.getRawValue());}.bind(this));}.bind(this)}});editorGrid=new Ext.Editor(editorInput);break;}default:var EditorClass=Ext.ux.propertyeditor.getEditor(pair.type());if(EditorClass){var field=new EditorClass(pair,this.facade);editorGrid=new Ext.Editor(field);field.editor=editorGrid;field.on("dialogClosed",function(field,value,oldValue){this.scope.grid.onEditComplete(editorGrid,value,oldValue);},{scope:this,editor:editorGrid});}if(!editorGrid){var editorInput=new Ext.form.TextField({allowBlank:pair.optional(),msgTarget:"title",maxLength:pair.length(),enableKeyEvents:true});editorInput.on("keyup",function(input,event){this.editDirectly(key,input.getValue());}.bind(this));editorGrid=new Ext.Editor(editorInput);}}if(pair.isList()){var cf=new Ext.form.ListView({allowBlank:pair.optional(),cls:"x-grey-background",readOnly:true},editorGrid,pair,this.facade);editorGrid=new Ext.Editor(cf);cf.on("dialogClosed",this.dialogClosed,{scope:this,row:index,col:1,field:cf});}editorGrid.on("beforehide",this.facade.enableEvent.bind(this,ORYX.CONFIG.EVENT_KEYDOWN));editorGrid.on("specialkey",this.specialKeyDown.bind(this));}else{if(pair.type()===ORYX.CONFIG.TYPE_URL||pair.type()===ORYX.CONFIG.TYPE_DIAGRAM_LINK){attribute=String(attribute).search("http")!==0?("http://"+attribute):attribute;attribute="<a href='"+attribute+"' target='_blank'>"+attribute.split("://")[1]+"</a>";}}if(pair.visible()){if(pair.category()=="popular"||pair.refToView()[0]&&!pair.category()||refToViewFlag&&!pair.category()){pair.setCategory("popular");}var option=[pair.category()||"others",name,attribute,icons,{editor:editorGrid,propId:key,type:pair.type(),property:pair,tooltip:pair.description(),renderer:editorRenderer,isList:pair.isList()}];if(editorGrid){editorGrid.on("render",function(editor){editor.el.setZIndex(7000);});}if(pair.category()=="popular"){this.popularProperties.push(option);}else{if(pair.category()=="characteristicNr"){this.characteristicNrProperties.push(option);}else{if(pair.category()=="meta"){this.metaProperties.push(option);}else{if(pair.category()){this.otherProperties.push(option);}else{this.properties.push(option);}}}}}}).bind(this));}this.setProperties();},setProperties:function(){var props=[].concat(this.otherProperties,this.metaProperties,this.popularProperties,this.characteristicNrProperties,this.properties);if(ORYX.CONFIG.SHOW_ID_IN_PROPERTYWINDOW&&this.shapeSelection.shapes.length===1&&this.shapeSelection.shapes[0] instanceof ORYX.Core.Shape){props.push(["others",Signavio.I18N.field.ID,this.shapeSelection.shapes[0].resourceId,[],{editor:new Ext.Editor(new Ext.form.TextField({readOnly:true}))}]);}if(this.pluginsData){this.pluginsData.each(function(propField){if(!(propField.enabled instanceof Function)||propField.enabled()){if(propField.value instanceof Function){var propValue=propField.value();}props.push([(propField.category||"other"),(propField.name||""),(propValue||propField.value||""),(propField.icons||[]),{editor:((propField.generateEditor instanceof Function&&propField.generateEditor())||new Ext.Editor(new Ext.form.TextField({readOnly:true})))}]);}}.bind(this));}this.dataSource.loadData(props);var view=this.grid.view;$A(view.getGroups()||[]).each(function(group){var id=group.id.split("-").last();if(view.state[group.id]||(view.state[group.id]===undefined&&this.expandedGroups[id])){view.toggleGroup(view.getGroupId(id),true);}else{view.toggleGroup(view.getGroupId(id),false);}}.bind(this));}};ORYX.Plugins.PropertyWindow=Clazz.extend(ORYX.Plugins.PropertyWindow);Ext.form.ListView=function(config,input,prop,facade){Ext.form.ListView.superclass.constructor.call(this,config);this.input=input;this.prop=prop;this.facade=facade;this.type=prop.type();};Ext.extend(Ext.form.ListView,Ext.form.TriggerField,{store:undefined,list:undefined,recordSchema:undefined,tpl:undefined,triggerClass:"x-trigger-other",initValue:function(){Ext.form.ListView.superclass.initValue.apply(this,arguments);this.updateRawValue();},setValue:function(){Ext.form.ListView.superclass.setValue.apply(this,arguments);this.updateRawValue();},parseListValue:function(value){if(typeof value==="string"&&ORYX.Utils.isGlossaryEntry(value)){return ORYX.Utils.glossaryTitle(value);}else{if(typeof value==="object"&&(value.label||value.url)){return(value.label||value.url);}else{return value;}}},updateRawValue:function(){if(this.value instanceof Array){this.setRawValue(this.value.map(this.parseListValue.bind(this)).join(", "));}else{try{this.setRawValue((this.value||"[]").evalJSON().map(this.parseListValue.bind(this)).join(", "));}catch(e){}}},getValue:function(){if(this.facade.hasGlossaryExtension&&this.type===ORYX.CONFIG.TYPE_GLOSSARY_LINK){var data=this.data||this.value;if(data instanceof Array){return data.map(this.getGlossaryValue.bind(this)).flatten().uniq();}else{return this.getGlossaryValue(data);}}else{return(this.data||this.value);}},getGlossaryValue:function(value){return([this.facade.getGlossary(this.facade.getSelection()[0]||this.facade.getCanvas(),this.prop)||value].flatten()).map(function(r){return typeof r=="object"?ORYX.Utils.getInGlossarySchema(r.glossary,r.text):r;});},onTriggerClick:function(){if(this.disabled){return;}var value=this.getValue();this.data=value;if(value instanceof Array){value=value.clone();}else{if(value instanceof Object){value=Object.clone(value);}}var option=Ext.apply({},this.input.field.initialConfig,{value:value});var field=FieldItemGenerator.generate(this.prop.type().capitalize()+"List",option);field.anchor="100%";this.dialog=new Ext.Window({autoCreate:true,title:ORYX.I18N.PropertyWindow.ListView.title+this.prop.title(),cls:"x-manage-list",minWidth:200,minHeight:200,height:300,width:440,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,layout:"anchor",bodyStyle:"padding:10px;background-color:#FFFFFF;",autoScroll:true,keys:[{key:27,fn:function(){this.dialog.hide;}.bind(this)}],items:[field],listeners:{show:function(t){this.fireEvent("blur");window.setTimeout(this.field.focus.bind(field),100);}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ListView.save,handler:this.saveEntry.bind(this)},{text:Signavio.I18N.Buttons.cancel,handler:function(){this.dialog.close();}.bind(this)}]});this.dialog.on(Ext.apply({},this.dialogListeners,{scope:this}));this.field=field;this.dialog.show();if(field instanceof Ext.form.ComboBox&&field.list){field.list.setZIndex((parseInt(this.dialog.el.getStyle("z-index"),10)||9000));}},saveEntry:function(){this.data=this.field.getValue();this.dialog.close();},keydownHandler:function(event){return false;},dialogListeners:{show:function(){this.onFocus();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);return;},hide:function(){var dl=this.dialogListeners;this.dialog.un("show",dl.show,this);this.dialog.un("hide",dl.hide,this);this.dialog.destroy(true);delete this.dialog;this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);this.fireEvent("dialogClosed",this.data);Ext.form.ListView.superclass.setValue.call(this,this.data);this.data=undefined;}}});var GlossaryInputField=function(attr){attr=attr||{};var params={select:"title",originId:attr.parentDir};if(attr.linkableType){params.category=attr.linkableType;}attr.store=new Ext.data.Store({baseParams:params,proxy:new Ext.data.HttpProxy({useAjax:true,method:"GET",headers:{accept:"application/json"},url:"/p/glossary"}),reader:new Signavio.Helper.RecordReader()});attr.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">','<img class="x-{[values.rep.category.toLowerCase()]} x-image" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>','<tpl if="values.href">','<tpl for="rep">{[Signavio.Utils.escapeHTML(values.title)]}</tpl>',"</tpl>",'<tpl if="!values.href">','<tpl for="rep">{emptyTitle}</tpl>',"</tpl>","</div></tpl>");attr.cls="x-glossary-support";GlossaryInputField.superclass.constructor.call(this,attr);};Ext.extend(GlossaryInputField,Ext.form.ComboBox,{lazyRender:false,lazyInit:false,listClass:"x-glossary-support",valueField:"value",typeAhead:false,loadingText:Signavio.I18N.Glossary_Support.renameLoading,emptyTextList:'<div class="x-no-entry">'+Signavio.I18N.Glossary_Support.renameEmpty+"</div>",queryDelay:100,minChars:2,preventScrollbars:true,queryParam:"q",hideTrigger:true,resizable:true,itemSelector:"div.search-item",loadingText:Signavio.I18N.Glossary_Support.renameLoading,emptyTextList:'<div class="x-no-entry">'+Signavio.I18N.Glossary_Support.renameEmpty+"</div>",initValue:function(){if(this.value!==undefined&&ORYX.Utils.isGlossaryEntry(this.value)){this.setRawValue(ORYX.Utils.glossaryTitle(this.value));}else{GlossaryInputField.superclass.initValue.apply(this,arguments);}},addNewRecord:function(record){},setValue:function(value){if(value!==undefined&&ORYX.Utils.isGlossaryEntry(value)){value=ORYX.Utils.glossaryTitle(value);}GlossaryInputField.superclass.setValue.apply(this,[value]);},onSelect:function(record,index){var title=record.get("rep").title||record.get("rep").name||"";var id=record.get("rep").id;this.value="glossary://"+id+"/"+title+";;";this.collapse();this.setRawValue(title);this.addNewRecord(record);this.fireEvent("select",this,record,index);},getCursorPosition:function(){var input=this.el.dom;if(input&&typeof input.selectionStart!=="undefined"){return input.selectionStart;}else{return input.value.length;}},initList:function(){GlossaryInputField.superclass.initList.apply(this,arguments);if(this.emptyTextList){this.view.emptyText=this.emptyTextList;}if(this.view){this.view.onMouseOut=function(e){if(this.lastItem){try{if(!e.within(this.lastItem,true)){Ext.fly(this.lastItem).removeClass(this.overClass);delete this.lastItem;}}catch(error){}}}.bind(this.view);}this.pageSize=10;},onDestroy:function(){if(this.textSizeEl){Ext.removeNode(this.textSizeEl);}if(this.view&&this.view.lastItem){delete this.view.lastItem;}GlossaryInputField.superclass.onDestroy.call(this);},getValue:function(){if(this.valueField){return typeof this.value!="undefined"&&this.el.getValue()?this.value:"";}else{return Ext.form.ComboBox.superclass.getValue.call(this);}},onBeforeLoad:function(){if(!this.hasFocus){return;}if(!this.innerList.child("div.loading-indicator")){if(this.store.getCount()>0){this.innerList.createChild({tag:"div",cls:"loading-indicator",html:this.loadingText});}else{this.innerList.update(this.loadingText?'<div class="loading-indicator">'+this.loadingText+"</div>":"");}}if(this.selectedIndex>=0){this.lastSelectedRecord=this.store.getAt(this.selectedIndex);}else{delete this.lastSelectedRecord;}this.restrictHeight();},initQuery:function(){if(this.list){var text=this.getRawValue();this.doQuery(text);}},doQuery:function(q,forceAll){if(!this.store){return;}if(q===undefined||q===null){q="";}var qe={query:q,forceAll:forceAll,combo:this,cancel:false};if(this.fireEvent("beforequery",qe)===false||qe.cancel){return false;}q=qe.query;forceAll=qe.forceAll;var qq=(q||"").split(/\s+/).findAll(function(r){return r.length>=this.minChars;}.bind(this));if(forceAll===true||qq.length>0){qq=qq.join(" ");if(this.lastQuery!==qq){this.lastQuery=qq;if(this.mode=="local"){this.selectedIndex=-1;if(forceAll){this.store.clearFilter();}else{this.store.filter(this.displayField,q);}this.onLoad();}else{this.store.baseParams[this.queryParam]=qq;this.store.load({params:this.getParams(qq)});this.expand();}}else{this.selectedIndex=-1;this.onLoad();}}},onLoad:function(){if(!this.hasFocus){return;}if(this.store.getCount()>0){this.expand();this.restrictHeight();if(this.lastQuery==this.allQuery){if(this.editable){this.el.dom.select();}}else{if(this.typeAhead&&this.lastKey!=Ext.EventObject.BACKSPACE&&this.lastKey!=Ext.EventObject.DELETE){this.taTask.delay(this.typeAheadDelay);}}var index=-1;if(this.lastSelectedRecord){index=this.store.find("href",this.lastSelectedRecord.get("href"));}this.select(index,true);}else{this.onEmptyResults();}},onEmptyResults:function(){this.restrictHeight();}});Ext.form.ComplexListField=function(config,property,key,facade){Ext.form.ComplexListField.superclass.constructor.call(this,config);this.property=property;this.items=property.complexItems();this.propertyTitle=property.title();this.key=key;this.facade=facade;};Ext.extend(Ext.form.ComplexListField,Ext.form.TriggerField,{triggerClass:"x-form-complex-trigger",readOnly:true,emptyText:ORYX.I18N.PropertyWindow.clickIcon,retrieveRadioButtonValue:function(){var me=this;var inputEls=this.grid.body.query("input.x-complexfield-radio-button[type=radio]");var store=this.grid.getStore();var row,col,value;if(inputEls instanceof Array){inputEls.each(function(i){if(!i.value){return;}value=i.value.split("_");if(value.size()!=4){return;}row=value[1];col=me.grid.getColumnModel().config[value[3]].dataIndex;if(store.getAt(row)&&store.getAt(row).data&&typeof(store.getAt(row).data[col])!=="undefined"){store.getAt(row).data[col]=!!i.checked;}});}},buildValue:function(){this.retrieveRadioButtonValue();var ds=this.grid.getStore();ds.commitChanges();if(ds.getCount()==0){return"";}var jsonString="[";for(var i=0;i<ds.getCount();i++){var data=ds.getAt(i);jsonString+="{";for(var j=0;j<this.items.length;j++){var key=this.items[j].id();jsonString+=key+":"+(""+Object.toJSON(data.get(key)));if(j<(this.items.length-1)){jsonString+=", ";}}jsonString+="}";if(i<(ds.getCount()-1)){jsonString+=", ";}}jsonString+="]";jsonString="{'totalCount':"+ds.getCount().toJSON()+", 'items':"+jsonString+"}";return Object.toJSON(jsonString.evalJSON());},getFieldKey:function(){return this.key;},getValue:function(){if(this.grid){return this.buildValue();}else{if(this.data==undefined){return"";}else{return this.data;}}},setValue:function(value){if(value.length>0){if(this.data==undefined){this.data=value;}}},keydownHandler:function(event){return false;},dialogListeners:{show:function(){this.onFocus();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);return;},hide:function(){var dl=this.dialogListeners;this.dialog.un("show",dl.show,this);this.dialog.un("hide",dl.hide,this);this.dialog.destroy(true);this.grid.destroy(true);delete this.grid;delete this.dialog;this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);this.fireEvent("dialogClosed",this.data);Ext.form.ComplexListField.superclass.setValue.call(this,this.data);}},buildInitial:function(recordType,items){var initial=new Hash();for(var i=0;i<items.length;i++){var id=items[i].id();if(items[i].value() instanceof Array){initial[id]=items[i].value().clone();}else{if(typeof(items[i].value())=="string"){initial[id]=""+items[i].value();}else{if(items[i].value() instanceof Object){initial[id]=Object.clone(items[i].value());}}}}var RecordTemplate=Ext.data.Record.create(recordType);return new RecordTemplate(initial);},buildColumnModel:function(parent){var cols=[];for(var i=0;i<this.items.length;i++){var renderer=undefined;var id=this.items[i].id();var header=this.items[i].name();var width=this.items[i].width();var type=this.items[i].type();var isList=this.items[i].isList();var optional=this.items[i].optional();var item=this.items[i];var editor=undefined;if(type==ORYX.CONFIG.TYPE_STRING){editor=new Ext.form.TextField({allowBlank:this.items[i].optional(),width:width});}else{if(type==ORYX.CONFIG.TYPE_TEXT){var triggerFn=function(){if(this.disabled){return;}var selection=(this.facade.getSelection().length>0?this.facade.getSelection()[0]:this.facade.getCanvas());var grid=new Ext.form.TextArea({anchor:"100% 100%",value:this.value,listeners:{focus:function(){if(this.facade){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}}.bind(this)}});var dialog=new Ext.Window({layout:"anchor",autoCreate:true,title:ORYX.I18N.PropertyWindow.text,height:500,width:500,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){dialog.hide();}.bind(this)}],items:[grid],listeners:{hide:function(){var formats;if(Ext.isGecko||Ext.isSafari||Ext.isIE||Ext.isChrome||Ext.isOpera){formats=[];}this.fireEvent("dialogClosed",this.value,formats);dialog.destroy();}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var value=grid.getValue();this.setValue(value);dialog.hide();}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);dialog.hide();}.bind(this)}]});dialog.show();grid.render();if(this.grid){this.grid.stopEditing();}grid.focus(false,100);};var ct=new Ext.form.TriggerField({allowBlank:optional,triggerClass:"x-trigger-other",width:width,facade:this.facade,onTriggerClick:triggerFn});editor=new Ext.grid.GridEditor(ct);ct.on("dialogClosed",function(editor,value){var rec=editor.record;var dIn=this.grid.getColumnModel().config[editor.col].dataIndex;rec.set(dIn,value);rec.commit();}.bind(this,editor));}else{if(type==ORYX.CONFIG.TYPE_CHOICE){var items=this.items[i].items();var select=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",parent,["select",{style:"display:none"}]);var optionTmpl=new Ext.Template('<option value="{value}">{value}</option>');items.each(function(value){optionTmpl.append(select,{value:value.value()});});editor=new Ext.ux.form.ComboBox({typeAhead:true,triggerAction:"all",transform:select,lazyRender:true,msgTarget:"title",mode:"local",width:width,editable:true,readOnly:false,emptyText:"",selectOnFocus:true,forceSelection:!this.items[i].allowCustomValue()});}else{if(type==ORYX.CONFIG.TYPE_BOOLEAN){editor=new Ext.form.Checkbox({width:width});}else{if(type==ORYX.CONFIG.TYPE_RADIOBUTTON){renderer=this.renderRadioButton.bind(this);}else{if(type==ORYX.CONFIG.TYPE_URL){if(!isList){var editorInput=new Ext.form.TextField({width:width,allowBlank:optional,msgTarget:"title",enableKeyEvents:true,prefixFileLocal:Ext.ux.form.UrlLinkFieldList.prototype.prefixFileLocal,prefixFileNetwork:Ext.ux.form.UrlLinkFieldList.prototype.prefixFileNetwork,prefixHTTP:Ext.ux.form.UrlLinkFieldList.prototype.prefixHTTP,getValue:function(){var url=Ext.form.TextField.prototype.getRawValue.call(this);if(Ext.ux.form.UrlLinkFieldList.prototype.isURL.call(this,url)){url=this.prefixHTTP+url;}return url;},listeners:{render:function(){editorInput.el.on("keyup",function(event){Ext.ux.form.UrlLinkFieldList.prototype.evaluateLokalURL.call(editorInput);}.bind(this));}.bind(this)}});editor=new Ext.Editor(editorInput);editor.on("dialogClosed",function(editor,value){var rec=editor.record;var dIn=this.grid.getColumnModel().config[editor.col].dataIndex;rec.set(dIn,value);rec.commit();}.bind(this,editor));}}}}}}}if(isList){if(!editor){var editorInput=new Ext.form.TextField({allowBlank:optional,msgTarget:"title",enableKeyEvents:true});editor=new Ext.Editor(editorInput);}var cf=new Ext.form.ListView({allowBlank:optional,cls:"x-grey-background",readOnly:true,width:width},editor,item,this.facade);editor=new Ext.Editor(cf);cf.on("dialogClosed",function(editor,value){var rec=editor.record;var dIn=this.grid.getColumnModel().config[editor.col].dataIndex;rec.set(dIn,value);rec.commit();}.bind(this,editor));}if(!(renderer instanceof Function)&&(this.rendererFn instanceof Function)){renderer=this.rendererFn;}else{if(!(this.rendererFn instanceof Function)){renderer=function(value){return Signavio.Utils.escapeHTML(value);};}}cols.push({id:id,header:header,dataIndex:id,resizable:true,editor:editor,width:width,renderer:renderer});}var cm=new Ext.grid.ColumnModel(cols),me=this;cm.isCellEditable=function(colIndex,rowIndex){if(Ext.grid.ColumnModel.prototype.isCellEditable.apply(this,arguments)){return me.isRowReadOnly(rowIndex);}return false;};return cm;},isRowReadOnly:function(rowIndex){if(this.property.defaultValueReadOnly()===true){var value=this.property.value()||"{'items':[]}";try{value=value.evalJSON();return value.items.length<=rowIndex;}catch(e){}}return true;},renderRadioButton:function(value,metadata,record,rowIndex,colIndex,store){var checked=(!!value?" checked='checked'":"");var button="<input value='row_"+rowIndex+"_col_"+colIndex+"' class='x-row-"+rowIndex+" x-complexfield-radio-button' type='radio'"+checked+" name='radio-"+(metadata.id||1)+"' onclick='if(!(!this.checked || !this.svenflag)) {this.checked=false; this.svenflag=false;} else {this.svenflag=true;}' />";return button;},afterEdit:function(option){option.grid.getStore().commitChanges();option.grid.view.refresh();},beforeEdit:function(option){var state=this.grid.getView().getScrollState();var col=option.column;var row=option.row;var editId=this.grid.getColumnModel().config[col].id;for(var i=0;i<this.items.length;i++){var item=this.items[i];var disables=item.disable();if(disables!=undefined){var value=this.grid.getStore().getAt(row).get(item.id());for(var j=0;j<disables.length;j++){var disable=disables[j];if(disable.value==value){for(var k=0;k<disable.items.length;k++){var disItem=disable.items[k];if(disItem==editId){this.grid.getColumnModel().getCellEditor(col,row).disable();return;}}}}}}this.grid.getColumnModel().getCellEditor(col,row).enable();},onTriggerClick:function(){if(this.disabled){return;}var dialogWidth=0;var recordType=[];for(var i=0;i<this.items.length;i++){var id=this.items[i].id();var width=this.items[i].width();var type=this.items[i].type();var convertFn=undefined;if(type==ORYX.CONFIG.TYPE_CHOICE){type=ORYX.CONFIG.TYPE_STRING;}else{if(type==ORYX.CONFIG.TYPE_TEXT){type=ORYX.CONFIG.TYPE_STRING;}else{if(type==ORYX.CONFIG.TYPE_URL){convertFn=function(v,rec){return rec.links;};}else{if(type==ORYX.CONFIG.TYPE_RADIOBUTTON){type=ORYX.CONFIG.TYPE_BOOLEAN;}}}}dialogWidth+=width;recordType[i]={name:id,type:type,convert:convertFn};}if(dialogWidth>800){dialogWidth=800;}dialogWidth+=22;var data=this.data;if(data==""){data="{}";}var ds=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(eval("("+data+")")),reader:new Ext.data.JsonReader({root:"items",totalProperty:"totalCount"},recordType)});ds.load();var cm=this.buildColumnModel();var toolbar=new Ext.Toolbar([{text:ORYX.I18N.PropertyWindow.add,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/add.png",iconCls:"x-dummy",handler:function(){var ds=this.grid.getStore();var index=ds.getCount();this.grid.stopEditing();var p=this.buildInitial(recordType,this.items);ds.insert(index,p);ds.commitChanges();this.grid.startEditing(index,0);}.bind(this)},{text:ORYX.I18N.PropertyWindow.rem,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/delete.png",iconCls:"x-dummy",disabled:true,handler:function(){var ds=this.grid.getStore();var selection=this.grid.getSelectionModel().getSelectedCell();if(selection==undefined){return;}this.grid.getSelectionModel().clearSelections();this.grid.stopEditing();var record=ds.getAt(selection[0]);ds.remove(record);ds.commitChanges();}.bind(this)}]);this.grid=new Ext.grid.EditorGridPanel({store:ds,cm:cm,stripeRows:true,clicksToEdit:1,autoScroll:true,stateId:"x-editor-complex-grid",anchor:"100% 100%",viewConfig:{forceFit:true},enableHdMenu:false,selModel:new Ext.grid.CellSelectionModel(),tbar:toolbar});this.grid.getSelectionModel().on("selectionchange",function(foo,selection){if(selection&&this.isRowReadOnly(selection.cell[0])){toolbar.items.get(1).enable();}else{toolbar.items.get(1).disable();}}.bind(this));this.dialog=new Ext.Window({autoCreate:true,layout:"anchor",stateful:true,stateId:"x-editor-complex-window",title:ORYX.I18N.PropertyWindow.complex_part1+this.propertyTitle+ORYX.I18N.PropertyWindow.complex_part2,height:350,width:dialogWidth,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){this.dialog.hide();}.bind(this)}],items:[this.grid],bodyStyle:"background-color:#FFFFFF",buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){this.grid.stopEditing();this.data=this.buildValue();this.dialog.hide();}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.dialog.hide();}.bind(this)}]});this.dialog.on(Ext.apply({},this.dialogListeners,{scope:this}));this.dialog.show();this.grid.on("beforeedit",this.beforeEdit,this,true);this.grid.on("afteredit",this.afterEdit,this,true);this.grid.render();}});Ext.form.ComplexTextField=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"textarea",rows:1,style:"height:16px;overflow:hidden;"},onTriggerClick:function(){if(this.disabled){return;}var buttons=[];if(this.dataSource){buttons=this.addLanguageButtons(buttons);}if(ORYX.CONFIG.RICHTEXT_2_ENABLED&&!Ext.isIPad){var grid=this.getRichtextEditor();}else{var grid=this.getSimpleEditor();}if(grid){var dialog=this.getEditorWindow(grid,buttons);}if(!dialog){return;}if(Ext.isIPad){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.Richtext.notAvailableTitle,msg:ORYX.I18N.PropertyWindow.Richtext.notAvailableWarning,buttons:Ext.MessageBox.OKCANCEL,fn:function(btn){if(btn=="ok"){dialog.show();grid.render();if(this.grid){this.grid.stopEditing();}grid.focus(false,100);}}.bind(this),icon:Ext.MessageBox.WARNING});}else{dialog.show();grid.render();if(ORYX.CONFIG.RICHTEXT_2_ENABLED){grid.getToolbar().add(this.getSimpleEditorButton(dialog));}if(this.grid){this.grid.stopEditing();}grid.focus(false,100);}},getEditorWindow:function(grid,buttons,disableRichtext){if(!disableRichtext&&ORYX.CONFIG.RICHTEXT_2_ENABLED&&!Ext.isIPad){var dialog=new Ext.Window({layout:"anchor",autoCreate:true,title:(this.dataSource?this.dataSource.getAt(this.row).get("gridProperties").property.title():ORYX.I18N.PropertyWindow.text),height:500,width:650,minWidth:400,modal:true,shadow:true,maximizable:true,keys:[{key:27,fn:function(){dialog.hide();}.bind(this)}],items:[grid],listeners:{hide:function(){dialog.destroy();}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var content=Ext.ux.Richtext.decode(grid.body);this.value=content.text;this.newFormat=content.format;this.setValue(this.value);if(this.dataSource){this.dataSource.getAt(this.row).set("value",this.value);this.dataSource.commitChanges();}this.fireEvent("dialogClosed",this.value,this.newFormat);dialog.hide();}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){dialog.hide();}.bind(this)}]});}else{var dialog=new Ext.Window({layout:"anchor",autoCreate:true,title:ORYX.I18N.PropertyWindow.text,height:500,width:500,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,maximizable:true,tbar:(buttons&&buttons.length>0)?buttons:undefined,keys:[{key:27,fn:function(){dialog.hide();}.bind(this)}],items:[grid],listeners:{hide:function(){var formats;if(Ext.isGecko||Ext.isSafari||Ext.isIE||Ext.isChrome||Ext.isOpera){formats=[];}this.fireEvent("dialogClosed",this.value,formats);dialog.destroy();}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var value=grid.getValue();if("number"==typeof grid.maxLength&&String(value).length>grid.maxLength){value=String(value).slice(0,grid.maxLength);}this.setValue(value);if(this.dataSource){this.dataSource.getAt(this.row).set("value",value);this.dataSource.commitChanges();}dialog.hide();}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);dialog.hide();}.bind(this)}]});}return dialog;},addLanguageButtons:function(buttons){var values=this.events.dialogclosed.listeners[0].scope.scope.shapeSelection.commonPropertiesValues;var property=this.dataSource.getAt(this.row).get("gridProperties").property;if(ORYX.CONFIG.MULTI_LANGUAGES_ENABLED&&property.language()){var oprop=property.origin();$H(ORYX.CONFIG.MULTI_LANGUAGES||{}).keys().any(function(lang){var key=oprop.prefix()+"-"+oprop.id()+(lang==ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT?"":"_"+lang);if(property.language()!=lang&&(values[key]||"")!=oprop.value()){buttons.push({icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/flags/"+ORYX.CONFIG.MULTI_LANGUAGES[lang],iconCls:"x-dummy",text:" <img src='"+ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/bullet_go.png' style='margin-bottom:-5px;margin-left:-13px;margin-right:-5px;position:relative;'/>",handler:function(){grid.setValue([grid.getValue()||"",Ext.ux.Richtext.encode(values[key],selection.getFormat(key))||undefined].compact().join("\n"));if("function"===typeof grid.logKeys){grid.logKeys();}}});}}.bind(this));}return buttons;},getSimpleEditorButton:function(dialog){return{icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/fugue/icons/selection-input.png",iconCls:"x-dummy",cls:"x-btn-icon y-horizontal-menu-button",tooltip:{title:ORYX.I18N.PropertyWindow.Richtext.simpleEditingModeTitle,text:ORYX.I18N.PropertyWindow.Richtext.simpleEditingModeDesc},handler:function(){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.Richtext.simpleEditingModeTitle,msg:ORYX.I18N.PropertyWindow.Richtext.simpleEditingModeWarning,buttons:Ext.MessageBox.OKCANCEL,fn:function(btn){if(btn==="ok"){var simpleEditor=this.getSimpleEditor();simpleEditor.setValue(Ext.ux.Richtext.decode(dialog.items.get(0).body).text);var simpleEditorWindow=this.getEditorWindow(simpleEditor,this.addLanguageButtons([]),true);var box=dialog.getBox();dialog.hide();simpleEditorWindow.show();simpleEditorWindow.updateBox(box);simpleEditor.render();if(this.grid){this.grid.stopEditing();}simpleEditor.focus(false,100);}}.bind(this),icon:Ext.MessageBox.WARNING});}.bind(this)};},getSimpleEditor:function(){var maxLength=Number.MAX_VALUE;if(this.dataSource){var property=this.dataSource.getAt(this.row).get("gridProperties").property;if(property&&property.length instanceof Function){maxLength=property.length();}}return new Ext.form.TextArea({anchor:"100% 100%",value:this.value,maxLength:maxLength,listeners:{focus:function(){if(this.facade){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}}.bind(this)}});},getRichtextEditor:function(buttons){var selection=(this.facade.getSelection().length>0?this.facade.getSelection()[0]:this.facade.getCanvas());var id=this.dataSource.getAt(this.row).data.gridProperties.propId;var json=(selection.getFormat(id)||[]);var richtextEditor=new Ext.ux.form.RichtextEditor({enableSourceEdit:false,anchor:"100% 100%",value:(this.value===""?"<br/>":Ext.ux.Richtext.encode(this.value,json)),modal:true,ctCls:"y-richtext-editor"+(Ext.isIE9?" y-richtext-editor-ie9":Ext.isChrome?" y-richtext-editor-chrome":""),listeners:{initialize:function(comp){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}.bind(this),destroy:function(){this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);}.bind(this)},tbar:(buttons&&buttons.length>0)?buttons:undefined});return richtextEditor;}});Ext.form.EpcFrequencyTypeField=Ext.extend(Ext.form.TriggerField,{triggerClass:"x-trigger-other",onTriggerClick:function(){if(this.disabled){return;}new Ajax.Request("epcregions",{method:"get",asynchronous:true,requestHeaders:{"Accept":"application/json"},encoding:"UTF-8",onSuccess:(function(transport){this.buildDialog(transport.responseText.evalJSON().rep.regions);}).bind(this),onFailure:(function(transport){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.error,msg:ORYX.I18N.PropertyWindow.retrieveError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}).bind(this)});},buildDialog:function(knownRegions){var added=[];var deleted=[];var input=this.getInputValue();var ds=new Ext.data.SimpleStore({fields:["regionName","freq"],data:[]});for(var i=0;i<knownRegions.length;i++){var region=knownRegions[i];var foundFreq="0";if(region!=""){for(var j=0;j<input.regions.length;j++){if(input.regions[j].regionName==region){foundFreq=input.regions[j].freq;break;}}ds.add(new Ext.data.Record({regionName:region,freq:foundFreq}));}}var freqPerYearField=new Ext.form.NumberField({fieldLabel:ORYX.I18N.PropertyWindow.freqPerYear,labelStyle:"width:120px;",name:"freq_per_year",allowBlank:true,width:100,value:input.freqPerYear,disabled:input.useRegions,allowDecimals:false});var formPanel=new Ext.Panel({layout:"form",border:false,items:[freqPerYearField]});var useRegionsBox=new Ext.form.Checkbox({boxLabel:ORYX.I18N.PropertyWindow.useRegions,labelStyle:"width:180px;",name:"store_pa",checked:input.useRegions,style:"margin-top:24px;margin-bottom:12px;"});var grid=new Ext.grid.EditorGridPanel({store:ds,cm:new Ext.grid.ColumnModel([{id:"regionName",header:ORYX.I18N.PropertyWindow.region,dataIndex:"regionName",editor:new Ext.form.TextField({width:150,disabled:true}),width:167},{id:"freq",header:ORYX.I18N.PropertyWindow.freqPerYear,dataIndex:"freq",editor:new Ext.form.NumberField({width:150,disabled:false}),width:167}]),stripeRows:true,clicksToEdit:1,height:160,selModel:new Ext.grid.CellSelectionModel(),disabled:!input.useRegions});grid.addListener("afteredit",function(){freqPerYearField.setValue(this.getSumOfFrequenciesInStore(ds.data.items));}.bind(this));var addButton=new Ext.Button({text:ORYX.I18N.PropertyWindow.buttonAdd,handler:function(){Ext.MessageBox.prompt(ORYX.I18N.PropertyWindow.addPromptTitle,ORYX.I18N.PropertyWindow.addPromptMsg,function(btn,newName){if(btn=="ok"){if(this.storeContainsRegionName(ds.data.items,newName)){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.addErrorTitle,msg:ORYX.I18N.PropertyWindow.addErrorMsg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}else{ds.add(new Ext.data.Record({regionName:newName,freq:"0"}));if(!(this.removeFromArray(deleted,newName))){added.push(newName);}}}}.bind(this));}.bind(this),style:"display:inline;margin:3px;"});var delButton=new Ext.Button({text:ORYX.I18N.PropertyWindow.buttonDelete,handler:function(){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.deletConfirmTitle,msg:ORYX.I18N.PropertyWindow.deletConfirmMsg,buttons:Ext.MessageBox.YESNO,fn:function(btn){if(btn=="yes"){var selection=grid.getSelectionModel().getSelectedCell();if(selection==undefined){return;}var record=ds.getAt(selection[0]);grid.getSelectionModel().clearSelections();ds.remove(record);if(!(this.removeFromArray(added,record.data.regionName))){deleted.push(record.data.regionName);}freqPerYearField.setValue(this.getSumOfFrequenciesInStore(ds.data.items));}}.bind(this),animEl:"mb4",icon:Ext.MessageBox.QUESTION});}.bind(this),style:"display:inline;margin:3px;"});var buttonPanel=new Ext.Panel({border:false,items:[addButton,delButton],disabled:!input.useRegions,style:"padding:3px 3px 0"});useRegionsBox.addListener("check",function(node,checked){if(checked){freqPerYearField.setDisabled(true);grid.setDisabled(false);buttonPanel.setDisabled(false);freqPerYearField.setValue(this.getSumOfFrequenciesInStore(ds.data.items));}else{freqPerYearField.setDisabled(false);grid.setDisabled(true);buttonPanel.setDisabled(true);}}.bind(this));var dialog=new Ext.Window({bodyStyle:"background-color:#ffffff;padding:15px 15px 0",layout:"anchor",title:ORYX.I18N.PropertyWindow.freqTitle,height:400,width:400,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){dialog.hide();}.bind(this)}],items:[formPanel,useRegionsBox,grid,buttonPanel],listeners:{hide:function(){this.fireEvent("dialogClosed",this.value);dialog.destroy();}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var value=this.buildValue(useRegionsBox.getValue(),freqPerYearField.getValue(),ds.data.items);this.setValue(value);this.dataSource.getAt(this.row).set("value",value);this.dataSource.commitChanges();if((added.length+deleted.length)>0){new Ajax.Request("epcregions",{method:"post",asynchronous:false,parameters:{added:added,deleted:deleted},onSuccess:(function(transport){try{if(transport.responseText.evalJSON().rep.result!="ok"){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.error,msg:ORYX.I18N.PropertyWindow.storeError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}}catch(e){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.error,msg:ORYX.I18N.PropertyWindow.storeError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}}).bind(this),onFailure:(function(transport){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.error,msg:ORYX.I18N.PropertyWindow.storeError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}).bind(this)});}dialog.hide();}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);dialog.hide();}.bind(this)}]});dialog.show();},buildValue:function(useRegions_,freqPerYear_,storeItems){if(!useRegions_&&freqPerYear_===""){return"";}var result={useRegions:useRegions_,freqPerYear:freqPerYear_,regions:[]};for(var i=0;i<storeItems.length;i++){result.regions.push({regionName:storeItems[i].data.regionName,freq:storeItems[i].data.freq});}return Object.toJSON(result);},getInputValue:function(){var input;try{input=this.value.evalJSON();if(typeof(input.useRegions)=="undefined"||typeof(input.freqPerYear)=="undefined"||typeof(input.regions)=="undefined"){if(typeof(input)=="number"){input={useRegions:false,freqPerYear:input,regions:[]};}else{input={useRegions:false,freqPerYear:0,regions:[]};}}}catch(e){input={useRegions:false,freqPerYear:0,regions:[]};}return input;},storeContainsRegionName:function(storeItems,newName){for(var i=0;i<storeItems.length;i++){if(storeItems[i].data.regionName==newName){return true;}}return false;},getSumOfFrequenciesInStore:function(storeItems){var sum=0;for(var i=0;i<storeItems.length;i++){sum+=parseInt(storeItems[i].data.freq);}return sum;},removeFromArray:function(array,value){for(var i=0;i<array.length;i++){if(array[i]==value){array.splice(i,1);return true;}}return false;}});Ext.form.EpcFrequencyTypeField=Ext.extend(Ext.form.TriggerField,{triggerClass:"x-trigger-other",onTriggerClick:function(){if(this.disabled){return;}new Ajax.Request("epcregions",{method:"get",asynchronous:true,requestHeaders:{"Accept":"application/json"},encoding:"UTF-8",onSuccess:(function(transport){this.buildDialog(transport.responseText.evalJSON().rep.regions);}).bind(this),onFailure:(function(transport){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.error,msg:ORYX.I18N.PropertyWindow.retrieveError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}).bind(this)});},buildDialog:function(knownRegions){var added=[];var deleted=[];var input=this.getInputValue();var ds=new Ext.data.SimpleStore({fields:["regionName","freq"],data:[]});for(var i=0;i<knownRegions.length;i++){var region=knownRegions[i];var foundFreq="0";if(region!=""){for(var j=0;j<input.regions.length;j++){if(input.regions[j].regionName==region){foundFreq=input.regions[j].freq;break;}}ds.add(new Ext.data.Record({regionName:region,freq:foundFreq}));}}var freqPerYearField=new Ext.form.NumberField({fieldLabel:ORYX.I18N.PropertyWindow.freqPerYear,labelStyle:"width:120px;",name:"freq_per_year",allowBlank:false,width:100,value:input.freqPerYear,disabled:input.useRegions,allowDecimals:false});var formPanel=new Ext.Panel({layout:"form",border:false,items:[freqPerYearField]});var useRegionsBox=new Ext.form.Checkbox({boxLabel:ORYX.I18N.PropertyWindow.useRegions,labelStyle:"width:180px;",name:"store_pa",checked:input.useRegions,style:"margin-top:24px;margin-bottom:12px;"});var grid=new Ext.grid.EditorGridPanel({store:ds,cm:new Ext.grid.ColumnModel([{id:"regionName",header:ORYX.I18N.PropertyWindow.region,dataIndex:"regionName",editor:new Ext.form.TextField({width:150,disabled:true}),width:167},{id:"freq",header:ORYX.I18N.PropertyWindow.freqPerYear,dataIndex:"freq",editor:new Ext.form.NumberField({width:150,disabled:false}),width:167}]),stripeRows:true,clicksToEdit:1,height:160,selModel:new Ext.grid.CellSelectionModel(),disabled:!input.useRegions});grid.addListener("afteredit",function(){freqPerYearField.setValue(this.getSumOfFrequenciesInStore(ds.data.items));}.bind(this));var addButton=new Ext.Button({text:ORYX.I18N.PropertyWindow.buttonAdd,handler:function(){Ext.MessageBox.prompt(ORYX.I18N.PropertyWindow.addPromptTitle,ORYX.I18N.PropertyWindow.addPromptMsg,function(btn,newName){if(btn=="ok"){if(this.storeContainsRegionName(ds.data.items,newName)){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.addErrorTitle,msg:ORYX.I18N.PropertyWindow.addErrorMsg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}else{ds.add(new Ext.data.Record({regionName:newName,freq:"0"}));if(!(this.removeFromArray(deleted,newName))){added.push(newName);}}}}.bind(this));}.bind(this),style:"display:inline;margin:3px;"});var delButton=new Ext.Button({text:ORYX.I18N.PropertyWindow.buttonDelete,handler:function(){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.deletConfirmTitle,msg:ORYX.I18N.PropertyWindow.deletConfirmMsg,buttons:Ext.MessageBox.YESNO,fn:function(btn){if(btn=="yes"){var selection=grid.getSelectionModel().getSelectedCell();if(selection==undefined){return;}var record=ds.getAt(selection[0]);grid.getSelectionModel().clearSelections();ds.remove(record);if(!(this.removeFromArray(added,record.data.regionName))){deleted.push(record.data.regionName);}}}.bind(this),animEl:"mb4",icon:Ext.MessageBox.QUESTION});}.bind(this),style:"display:inline;margin:3px;"});var buttonPanel=new Ext.Panel({border:false,items:[addButton,delButton],disabled:!input.useRegions,style:"padding:3px 3px 0"});useRegionsBox.addListener("check",function(node,checked){if(checked){freqPerYearField.setDisabled(true);grid.setDisabled(false);buttonPanel.setDisabled(false);freqPerYearField.setValue(this.getSumOfFrequenciesInStore(ds.data.items));}else{freqPerYearField.setDisabled(false);grid.setDisabled(true);buttonPanel.setDisabled(true);}}.bind(this));var dialog=new Ext.Window({bodyStyle:"background-color:#ffffff;padding:15px 15px 0",layout:"anchor",title:ORYX.I18N.PropertyWindow.freqTitle,height:400,width:400,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){dialog.hide();}.bind(this)}],items:[formPanel,useRegionsBox,grid,buttonPanel],listeners:{hide:function(){this.fireEvent("dialogClosed",this.value);dialog.destroy();}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var value=this.buildValue(useRegionsBox.getValue(),freqPerYearField.getValue(),ds.data.items);this.setValue(value);this.dataSource.getAt(this.row).set("value",value);this.dataSource.commitChanges();if((added.length+deleted.length)>0){new Ajax.Request("epcregions",{method:"post",asynchronous:false,parameters:{added:added,deleted:deleted},onSuccess:(function(transport){try{if(transport.responseText.evalJSON().rep.result!="ok"){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.error,msg:ORYX.I18N.PropertyWindow.storeError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}}catch(e){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.error,msg:ORYX.I18N.PropertyWindow.storeError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}}).bind(this),onFailure:(function(transport){Ext.MessageBox.show({title:ORYX.I18N.PropertyWindow.error,msg:ORYX.I18N.PropertyWindow.storeError,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}).bind(this)});}dialog.hide();}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);dialog.hide();}.bind(this)}]});dialog.show();},buildValue:function(useRegions_,freqPerYear_,storeItems){var result={useRegions:useRegions_,freqPerYear:freqPerYear_,regions:[]};for(var i=0;i<storeItems.length;i++){result.regions.push({regionName:storeItems[i].data.regionName,freq:storeItems[i].data.freq});}return Object.toJSON(result);},getInputValue:function(){var input;try{input=this.value.evalJSON();if(typeof(input.useRegions)=="undefined"||typeof(input.freqPerYear)=="undefined"||typeof(input.regions)=="undefined"){if(typeof(input)=="number"){input={useRegions:false,freqPerYear:input,regions:[]};}else{input={useRegions:false,freqPerYear:0,regions:[]};}}}catch(e){input={useRegions:false,freqPerYear:0,regions:[]};}return input;},storeContainsRegionName:function(storeItems,newName){for(var i=0;i<storeItems.length;i++){if(storeItems[i].data.regionName==newName){return true;}}return false;},getSumOfFrequenciesInStore:function(storeItems){var sum=0;for(var i=0;i<storeItems.length;i++){sum+=parseInt(storeItems[i].data.freq);}return sum;},removeFromArray:function(array,value){for(var i=0;i<array.length;i++){if(array[i]==value){array.splice(i,1);return true;}}return false;}});var GlossaryListItemTpl='<tpl for=".">'+'<div class="x-inline">'+'<tpl if="values.data.href">'+'<div class="x-glossary-title-list">'+"{[Signavio.Utils.escapeHTML(values.data.rep.title)]} "+"</div>"+'<span>(<a href="/p/glossary#gitem={[values.data.rep.id]}" class="x-open" target="_blank">{[ORYX.I18N.PropertyWindow.btnOpen]}</a>, <a href="#{[values.data.rep.id]}" class="x-remove">{[ORYX.I18N.PropertyWindow.btnRemove]}</a>)</span>'+"</tpl>"+'<tpl if="!values.data.href">'+'<div class="x-glossary-title-list">'+"{[Signavio.Utils.escapeHTML(values.data.rep.title)]} "+"</div>"+'<span>({[ORYX.I18N.PropertyWindow.createNew]}, <a href="#{[values.data.rep.id]}" class="x-remove">{[ORYX.I18N.PropertyWindow.btnRemove]}</a>)</span>'+"</tpl>"+'<tpl if="xindex!==xcount">, </tpl>'+"</div>"+"</tpl>";var FieldItemGenerator={generate:function(type,option){option=Object.clone(option);if(this["generate"+type] instanceof Function){return this["generate"+type](option||{});}else{return this.generateStringList(option||{});}},generateUrlList:function(option){return new Ext.ux.form.UrlLinkFieldList(Ext.apply({triggerClass:"x-form-add-trigger",emptyListText:ORYX.I18N.PropertyWindow.ListView.dataViewEmptyText},option));},generateStringList:function(option){return new Ext.form.TriggerField(Ext.apply({triggerClass:"x-form-add-trigger",data:[],onTriggerClick:function(){if(this.editing!==undefined){this.data[this.editing]=this.getRawValue();this.stopEdit();}else{this.data.push(this.getRawValue());}this.setRawValue("");this.updateView();},initValue:function(){if(typeof this.value=="string"){this.value=this.value?[this.value]:[];}if(this.value instanceof Array){this.data=this.value;this.value="";}Ext.form.TriggerField.prototype.initValue.apply(this,arguments);},startEdit:function(index){this.editing=index;var el=this.itemField.query("li")[index];Ext.fly(el).addClass("x-editing");this.setValue(this.data[index]);this.focus();},stopEdit:function(){if(this.editing===undefined){return;}var el=this.itemField.query("li")[this.editing];Ext.fly(el).removeClass("x-editing");delete this.editing;this.setRawValue("");},onRender:function(){Ext.form.TriggerField.prototype.onRender.apply(this,arguments);this.itemField=Ext.get(Ext.DomHelper.append(this.wrap,{tag:"div",style:"margin:1px 0px 4px 0px;display:none;"}));this.itemFieldTpl=new Ext.XTemplate('<tpl if="values.length===0"><span class="x-empty">{[ORYX.I18N.PropertyWindow.ListView.dataViewEmptyText]}</span></tpl>','<ol><tpl for="."><li>{.} ','<span class="x-smaller">',"(",'<tpl if="xindex != 1">','<a href="#{[xindex-1]}" class="x-move-up">{[ORYX.I18N.PropertyWindow.btnUp]}</a>, ',"</tpl>",'<tpl if="xindex != xcount">','<a href="#{[xindex-1]}" class="x-move-down">{[ORYX.I18N.PropertyWindow.btnDown]}</a>, ',"</tpl>",'<a href="#{[xindex-1]}" class="x-edit">{[ORYX.I18N.PropertyWindow.btnEdit]}</a>, ','<a href="#{[xindex-1]}" class="x-remove">{[ORYX.I18N.PropertyWindow.btnRemove]}</a>)</span>',"</li></tpl></ol>");this.updateView();},updateView:function(){this.itemFieldTpl.overwrite(this.itemField,this.data||[]);this.itemField.setDisplayed(true);this.updateEvents();if(this.ownerCt&&this.ownerCt.updateSize){this.ownerCt.updateSize();}},moveData:function(index,off){var a,b;a=this.data[index];this.data[index]=b=this.data[index+off];this.data[index+off]=a;},updateEvents:function(){this.itemField.select("a.x-move-up").on("click",function(e){Event.stop(e);var index=parseInt(e.target.getAttribute("href").slice(1));this.moveData(index,-1);this.updateView();}.bind(this));this.itemField.select("a.x-move-down").on("click",function(e){Event.stop(e);var index=parseInt(e.target.getAttribute("href").slice(1));this.moveData(index,1);this.updateView();}.bind(this));this.itemField.select("a.x-remove").on("click",function(e){Event.stop(e);var index=parseInt(e.target.getAttribute("href").slice(1));delete this.data[index];this.data=this.data.compact();this.updateView();}.bind(this));this.itemField.select("a.x-edit").on("click",function(e){Event.stop(e);var index=parseInt(e.target.getAttribute("href").slice(1));this.startEdit(index);}.bind(this));var lis=this.itemField.select("li");lis.addClassOnOver("x-hover");lis.on("mouseover",function(r,t){Ext.fly(t).addClass("x-hover");});lis.on("mouseout",function(r,t){Ext.fly(t).removeClass("x-hover");});},listeners:{specialkey:function(t,e){if(e.getKey()===e.ENTER){t.onTriggerClick();}else{if(e.getKey()===e.ESC){t.stopEdit();}}}},getValue:function(){return[].concat(this.getRawValue().trim()||undefined,this.data||[]).compact();}},option));},generateGlossarylinkList:function(option){return Ext.ux.form.FieldFactory.generateMetaDataGlossaryLinkList(Ext.apply({},{zindex:9015,valueTpl:new Ext.XTemplate(GlossaryListItemTpl),initValue:function(){if(this.value instanceof Array){this.records=this.value.map(function(rec){if(typeof rec==="string"){rec={id:ORYX.Utils.glossaryId(rec),title:ORYX.Utils.glossaryTitle(rec)};}if(!rec||!rec.id){return null;}return Signavio.Helper.createRecord("gitem","/glossary/"+rec.id,rec);}).compact();this.value="";}Ext.ux.form.GlossaryField.superclass.initValue.apply(this,arguments);},getValue:function(){return(this.records||[]).map(function(rec){return rec.get("href")?ORYX.Utils.getInGlossarySchema(rec.get("href"),rec.get("rep").title):rec.get("rep");});},setValue:function(){Ext.ux.form.GlossaryField.superclass.setValue.apply(this,arguments);},onNewRecord:function(record){this.updateValueList();this.setValue();}},option));}};}());if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Loading={construct:function(a){this.facade=a;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.facade.getCanvas().getHTMLContainer().parentNode.parentNode,["div",{"class":"LoadingIndicator"},""]);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_ENABLE,this.enableLoading.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_DISABLE,this.disableLoading.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,this.showStatus.bind(this));this.disableLoading();},enableLoading:function(a){if(a.text){this.node.innerHTML=a.text+"...";}else{this.node.innerHTML=ORYX.I18N.Loading.waiting;}this.node.removeClassName("StatusIndicator");this.node.addClassName("LoadingIndicator");this.node.style.display="block";var b=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode.parentNode;this.node.style.top=b.offsetTop+"px";this.node.style.left=b.offsetLeft+"px";},disableLoading:function(){this.node.style.display="none";},showStatus:function(a){if(a.text){this.node.innerHTML=a.text;this.node.addClassName("StatusIndicator");this.node.removeClassName("LoadingIndicator");this.node.style.display="block";var c=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode.parentNode;this.node.style.top=c.offsetTop+"px";this.node.style.left=c.offsetLeft+"px";var b=a.timeout?a.timeout:2000;window.setTimeout((function(){this.disableLoading();}).bind(this),b);}}};ORYX.Plugins.Loading=Clazz.extend(ORYX.Plugins.Loading);if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.CanvasResize=Clazz.extend({BLACKLIST:["http://www.signavio.com/stencilsets/processdoctemplate#"],construct:function(a){this.facade=a;var b=$H(this.facade.getStencilSets()).keys().first();if(!Ext.isIPad&&!this.BLACKLIST.include(b)){new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"N",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"W",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"E",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"S",this.resize.bind(this));}this.facade.registerOnEvent(ORYX.CONFIG.EVENT_CANVAS_RESIZE,this.handleResizeEvent.bind(this));},handleResizeEvent:function(a){if(!a||!a.position){return;}this.resize(a.position,a.shrink,a.size);},resize:function(a,e,d){var c=function(n,o,q){var h=q.getCanvas();var p=h.bounds;var l=q.getCanvas().getHTMLContainer().parentNode.parentNode;if(n=="E"||n=="W"){h.setSize({width:(p.width()+o)*h.zoomLevel,height:(p.height())*h.zoomLevel});}else{if(n=="S"||n=="N"){h.setSize({width:(p.width())*h.zoomLevel,height:(p.height()+o)*h.zoomLevel});}}if(n=="N"||n=="W"){var k=n=="N"?{x:0,y:o}:{x:o,y:0};h.getChildNodes(false,function(s){s.bounds.moveBy(k);});var m=h.getChildEdges();var r=m.collect(function(s){return s.dockers.findAll(function(t){return !t.getDockedShape();});}).flatten();r.each(function(s){s.bounds.moveBy(k);});}else{if(n=="S"){l.scrollTop+=o;}else{if(n=="E"){l.scrollLeft+=o;}}}h.update();q.updateSelection();};var b=ORYX.Core.Command.extend({construct:function(h,l,k){this.position=h;this.extentionSize=l;this.facade=k;},execute:function(){c(this.position,this.extentionSize,this.facade);},rollback:function(){c(this.position,-this.extentionSize,this.facade);},update:function(){}});var f=("number"===typeof d?d:ORYX.CONFIG.CANVAS_RESIZE_INTERVAL);if(e){f=-f;}var g=new b(a,f,this.facade);this.facade.executeCommands([g]);}});ORYX.Plugins.CanvasResizeButton=Clazz.extend({construct:function(c,h,n){this.canvas=c;var k=c.getHTMLContainer().parentNode.parentNode.parentNode;window.myParent=k;var d=k.firstChild;var b=d.firstChild.firstChild;var a=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",k,["div",{"class":"canvas_resize_indicator canvas_resize_indicator_grow"+" "+h,"title":ORYX.I18N.RESIZE.tipGrow+ORYX.I18N.RESIZE[h]}]);var e=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",k,["div",{"class":"canvas_resize_indicator canvas_resize_indicator_shrink"+" "+h,"title":ORYX.I18N.RESIZE.tipShrink+ORYX.I18N.RESIZE[h]}]);var f=60;var m=function(p){if(p.target!=k&&p.target!=d&&p.target!=d.firstChild&&p.target!=b&&p.target!=d){return false;}var s=p.layerX!==undefined?p.layerX:p.offsetX;var r=p.layerY!==undefined?p.layerY:p.offsetY;if((s-d.scrollLeft)<0||Ext.isSafari||Ext.isIE){s+=d.scrollLeft;}if((r-d.scrollTop)<0||Ext.isSafari||Ext.isIE){r+=d.scrollTop;}if(h=="N"){return r<f+d.firstChild.offsetTop;}else{if(h=="W"){return s<f+d.firstChild.offsetLeft;}else{if(h=="E"){var o=(d.offsetWidth-(d.firstChild.offsetLeft+d.firstChild.offsetWidth));if(o<0){o=0;}return s>d.scrollWidth-o-f;}else{if(h=="S"){var q=(d.offsetHeight-(d.firstChild.offsetTop+d.firstChild.offsetHeight));if(q<0){q=0;}return r>d.scrollHeight-q-f;}}}}return false;};var l=(function(){a.show();var p,v,o,u;try{var t=this.canvas.getRootNode().childNodes[1].getBBox();p=t.x;v=t.y;o=t.x+t.width;u=t.y+t.height;}catch(s){this.canvas.getChildShapes(true).each(function(z){var B=z.absoluteBounds();var A=B.upperLeft();var y=B.lowerRight();if(p==undefined){p=A.x;v=A.y;o=y.x;u=y.y;}else{p=Math.min(p,A.x);v=Math.min(v,A.y);o=Math.max(o,y.x);u=Math.max(u,y.y);}});}var x=c.bounds.width();var r=c.bounds.height();var q=c.getChildNodes().size()==0;if(h=="N"&&(v>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL||(q&&r>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL))){e.show();}else{if(h=="E"&&(x-o)>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL){e.show();}else{if(h=="S"&&(r-u)>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL){e.show();}else{if(h=="W"&&(p>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL||(q&&x>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL))){e.show();}else{e.hide();}}}}}).bind(this);var g=function(){a.hide();e.hide();};d.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,function(o){if(m(o)){l();}else{g();}},false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,function(o){l();},true);e.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,function(o){l();},true);k.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,function(o){g();},true);g();a.addEventListener("click",function(){n(h);l();},true);e.addEventListener("click",function(){n(h,true);l();},true);}});if(!ORYX){var ORYX=new Object();}if(!ORYX.Plugins){ORYX.Plugins=new Object();}if(!Signavio){var Signavio=new Object();}if(!Signavio.Helper){Signavio.Helper=new Object();}new function(){var b={};b.RENAME_SHAPES_DIRECTLY={"http://b3mn.org/stencilset/epc#":true,"http://www.signavio.com/stencilsets/organigram#":true,"http://www.signavio.com/stencilsets/processmap#":true,"Task":true,"CollapsedSubprocess":true,"Pool":true,"CollapsedPool":true,"VerticalPool":true,"CollapsedVerticalPool":true,"Lane":true,"VerticalLane":true,"DataObject":true,"TextAnnotation":true,"CollapsedEventSubprocess":true,"EventSubprocess":true,"ChoreographyTask":true,"ChoreographySubprocessCollapsed":true,"ChoreographySubprocessExpanded":true,"Participant":true};b.DONT_RENAME_SHAPES_DIRECTLY={"grect":true,"gdiamond":true,"gellipse":true};b.RENAME_SHAPES_CATEGORIES={"Pool":["IT_SYSTEM","ORG_UNIT"],"Lane":["IT_SYSTEM","ORG_UNIT"]};var d=["i","I","j","l"];var c=["a","b","d","e","f","J","k","n","o","r","s","t","u","v","y","z"];Signavio.Helper.TruncateByWidth=function(l,h,k){l=l||"";k=k||"&hellip;";var g=0;var f="";var e=l.toArray().all(function(m){g+=d.include(m)?3:(c.include(m)?5:9);if(g<=h){f+=m;return true;}return false;});return e?f:f.slice(0,f.length-1)+k;};ORYX.Plugins.RenameShapes=Clazz.extend({openRenameForProperties:["oryx-name","oryx-title","oryx-text"],enableRenameOnAdd:!Ext.isIPad,construct:function(e){this.facade=e;this.editorInitialized=false;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){this.editorInitialized=true;}.bind(this));if(this.enableRenameOnAdd){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,this.onAdd.bind(this));}this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DBLCLICK,this.actOnDBLClick.bind(this));this.facade.offer({keyCodes:[{keyCode:113,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.renamePerF2.bind(this)});$(this.facade.getCanvas().getHTMLContainer()).addClassName("x-glossary-support-container");var f=function(g){if(this.shownTextField&&(!g||!this.shownTextField.el||(g.target!==this.shownTextField.el.dom&&(!this.shownTextField.list||!this.shownTextField.list.contains(g.target))))&&!g.target.className.toString().include("x-combo-selected")){this.shownTextField.onBlur();}}.bind(this);if(!ORYX.Utils.isIPad()){Ext.getBody().on("click",f);}},onSelectionChanged:function(){if(this.shownTextField&&this.shownTextField.el&&!this.isOnSelecting){this.shownTextField.onBlur();}},renamePerF2:function(){var e=this.facade.getSelection();this.actOnDBLClick(undefined,e.first());},addedShapes:[],onAdd:function(e){var f=e.shape;if(!this.editorInitialized&&f instanceof ORYX.Core.Node){this.addedShapes.push(f.id);return;}if(f instanceof ORYX.Core.Node&&(b.RENAME_SHAPES_DIRECTLY[f.getStencil().namespace()]||b.RENAME_SHAPES_DIRECTLY[f.getStencil().idWithoutNs()])&&!b.DONT_RENAME_SHAPES_DIRECTLY[f.getStencil().idWithoutNs()]&&!this.addedShapes.include(f.id)){if(this.addTimeout){this.addedShapes.push(f.id);return;}var g,h;this.openRenameForProperties.each(function(k){var l=f.getStencil().property(k);if(l){if(l.refToView().any(function(m){g=f._labels[f.id+m];return !!g;})){h=k;throw $break;}}});this.addTimeout=window.setTimeout(function(){if(!f.properties[h]){this.showInputForLabel(f,g);}delete this.addTimeout;}.bind(this),150);this.addedShapes.push(f.id);}},actOnDBLClick:function(e,f){if(!(f instanceof ORYX.Core.Shape)){return;}var g=this.getNearestLabel(e,f);this.showInputForLabel(f,g);},getScale:function(){try{return this.facade.getCanvas().node.transform.baseVal.getItem(0).matrix.a;}catch(f){return 1;}},showInputForLabel:function(o,p){if(!o||!p){return;}o.editing=true;var f=this.getPropertyByLabel(o,p);if(f.type()!=ORYX.CONFIG.TYPE_STRING){return;}var h=f.prefix()+"-"+f.id();this.close();var q=f.wrapLines();var k=o.bounds.width();var r=o.bounds.height();var n=3;k-=n*2;r-=n*2;k=Math.max(90,Math.min(k,150));r=Math.max(70,Math.min(r,100));var e=this.getCenterPosition(p.node);e.x-=(k/2);e.y-=q?(r/2)+1:22/2;if(Ext.isSafari&&!Ext.isChrome){e.x+=1;e.y+=1;k-=2;r-=2;}else{if(Ext.isIE){e.y+=1;k+=1;}}e.x=Math.max(e.x,5);e.y=Math.max(e.y,5);var m=this.facade.getModelMetaData().parent;var l={renderTo:this.facade.getCanvas().getHTMLContainer().id,value:this.getPropertyValue(o,h),x:e.x,y:e.y,width:k,height:r,allowBlank:f.optional(),maxLength:f.length(),renderAsTextArea:q,growMin:r,grow:q,parentDir:m};var g=b.RENAME_SHAPES_CATEGORIES[$H(b.RENAME_SHAPES_CATEGORIES).keys().find(function(s){return o.getStencil().id().endsWith(s);})];if(g){l.categories=[].concat(g);}if(this.facade.hasGlossaryExtension&&this.facade.stencilHasGlossarySupport(o,h.replace(/_[a-z]+$/i,""))&&!this.hasGlossary(o,f)){this.shownTextField=new a(l);this.shownTextField.wrap.setStyle("position","absolute");}else{l.style="position:absolute;visibility:hidden;left:-10000px;";l.cls="x-plugin-rename-field";l.listeners={specialKey:function(t,s){if(s.keyCode===27){t.onBlur();}}};if(q){this.shownTextField=new Ext.form.TextArea(l);}else{delete l.height;this.shownTextField=new Ext.form.TextField(l);}}if(Ext.isChrome){this.shownTextField.el.on("keydown",function(t,s){if(t.getKey()===27){this.shownTextField.onBlur();}}.bind(this));}this.shownTextField.on("blur",function(s){if(!(this.lastClick&&(this.lastClick.className||"").toString().include("keep-focus"))){this.destroy();o.editing=false;}}.bind(this));this.shownTextField.on("change",this.onChange.bind(this,o,f));this.shownTextField.onSelect=this.onSelect.bind(this,o,f,p,this.shownTextField);window.setTimeout(function(){if(this.shownTextField&&this.shownTextField.el){if(this.shownTextField.autoSize instanceof Function){this.shownTextField.autoSize();}this.shownTextField.el.fadeIn({duration:0.2,callback:function(){if(this.shownTextField){this.shownTextField.focus();}}.bind(this)});}}.bind(this),10);o.textField=this.shownTextField;},getPropertyValue:function(e,f){return e.properties[f];},hasGlossary:function(e,f){if(ORYX.CONFIG.MULTI_LANGUAGES_ENABLED&&f.language()){f=f.origin();return $H(ORYX.CONFIG.MULTI_LANGUAGES||{}).keys().any(function(h){var g=f.prefix()+"-"+f.id()+(h==ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT?"":"_"+h);return this.facade.hasGlossary(e,e.getStencil().property(g));}.bind(this));}else{return this.facade.hasGlossary(e,f);}},onChange:function(f,k,g,h){if(this.facade.hasGlossaryExtension&&this.facade.hasGlossary(f,k)){if(!(h||"").strip()){Ext.Msg.confirm(Signavio.I18N.Glossary_Support.removeTitle,Signavio.I18N.Glossary_Support.removeDesc,function(l){if(l=="yes"){this.setProperty(f,k,h);}}.bind(this));}else{var e=function(l){if(l=="yes"){this.setProperty(f,k,h,false,true);}}.bind(this);if(this.facade.hasGlossaryExtension&&this.facade.checkGlossaryIsDirty(h,f.properties[k.prefix()+"-"+k.id()])){Ext.Msg.confirm(Signavio.I18N.Glossary_Support.changeTitle,Signavio.I18N.Glossary_Support.changeDesc,e);}else{e("yes");}}}else{this.setProperty(f,k,h);}},replaceCommonSubString:function(e,g,f){return Signavio.Utils.replaceCommonSubString(e,g,f);},onSelect:function(g,e,m,l,f){this.isOnSelecting=true;var n=Signavio.Utils.unescapeHTML(f.get("rep").title||"");if(l){var o=l.getValue();var k=this.getCursorPosition(l.el.dom);n=this.replaceCommonSubString(o,n,k);}if(this.facade.hasGlossaryExtension){this.setProperty(g,e,n,true,{glossary:f.get("rep").id,isDirty:this.facade.checkGlossaryIsDirty(n,Signavio.Utils.unescapeHTML(f.get("rep").title))});var h=m.getReferencedElementWidth();if(h){m.node.setAttribute("oryx:textWidth",h);}}if(l){l.setValue(n);l.collapse();l.list.remove();delete l.list;}delete this.isOnSelecting;},getCursorPosition:function(e){if(e&&typeof e.selectionStart!=="undefined"){return e.selectionStart;}else{return e.value.length;}},close:function(){this.destroy();},destroy:function(f){if(this.addTimeout){window.clearTimeout(this.addTimeout);delete this.addTimeout;}if(this.shownTextField){if(this.shownTextField.list){this.shownTextField.list.hide();}this.shownTextField.destroy();this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);delete this.shownTextField;}},setProperty:function(n,f,q,k,o){var g=f.prefix()+"-"+f.id();var e=n.properties[g];var h=q;var r=this.facade;var p=n.getLabel(f.id());if(e!=h||(this.facade.hasGlossaryExtension&&!this.facade.getGlossary(n,f)&&o instanceof Object)){var m=ORYX.Core.Command.extend({construct:function(){this.facade=r;this.el=n;this.propId=g;this.prop=f;this.oldValue=e;this.newValue=h;this.setGlossary=o;this.oldGlossary=this.facade.hasGlossaryExtension?this.facade.getGlossary(n,f):null;},execute:function(){if(this.facade.hasGlossaryExtension){if(this.setGlossary){var s,t;if(typeof this.setGlossary=="object"&&this.setGlossary.glossary){t=this.setGlossary.glossary;s=!!this.setGlossary.isDirty;}else{t=this.facade.getGlossary(this.el,this.prop).glossary;s=this.facade.checkGlossaryIsDirty(this.newValue,this.el.properties[this.prop.prefix()+"-"+this.prop.id()]);}this.facade.setGlossary(this.el,this.prop,t,this.newValue,s);}else{this.facade.setGlossary(this.el,this.prop);}}this.el.setProperty(this.propId,this.newValue,k);if(this.executeAgain){this.facade.setSelection([this.el]);this.facade.getCanvas().update();this.facade.updateSelection();}else{this.facade.getCanvas().update();}this.executeAgain=true;},rollback:function(){if(this.facade.hasGlossaryExtension){if(this.oldGlossary){var s=this.oldGlossary;this.facade.setGlossary(this.el,this.prop,s.glossary,s.text,s.isDirty);}else{this.facade.setGlossary(this.el,this.prop);}}this.el.setProperty(this.propId,this.oldValue,k);this.facade.setSelection([this.el]);this.facade.getCanvas().update();this.facade.updateSelection();}});var l=new m();this.facade.executeCommands([l]);}},getCenterPosition:function(m){if(!m){return{x:0,y:0};}var g={x:0,y:0};var p,l,h,f;var o=false;try{if(("hidden"===m.getAttributeNS(null,"visibility")&&m.childNodes.length>0)||m.childNodes.length===0){o=true;}var k=o?m.parentNode:m;p=k.getTransformToElement(this.facade.getCanvas().rootNode.lastChild);l=this.facade.getCanvas().rootNode.lastChild.getScreenCTM();h=k.getTransformToElement(k.parentNode);}catch(n){return{x:0,y:0};}g.x=p.e-h.e;g.y=p.f-h.f;try{f=Object.clone(m.getBBox());if(!o&&!(f.x<-1000)){f.y+=1;if(Ext.isGecko){f.x-=1;}}else{f={x:parseInt(m.getAttribute("x")),y:parseInt(m.getAttribute("y")),width:0,height:0};}}catch(n){f={x:parseInt(m.getAttribute("x")),y:parseInt(m.getAttribute("y")),width:0,height:0};}g.x+=f.x;g.y+=f.y;g.x+=f.width/2;g.y+=f.height/2;g.x*=l.a;g.y*=l.d;return g;},getNearestLabel:function(n,h){var e=this.facade.getCanvas().getLanguage();var k=h.getStencil().properties().findAll(function(q){return q.refToView()&&q.refToView().length>0;});k=k.findAll(function(q){return !q.readonly()&&q.type()==ORYX.CONFIG.TYPE_STRING&&(!q.directlyEditable||q.directlyEditable())&&(!q.language()||q.language()==e);});var l=k.collect(function(q){return q.refToView();}).flatten().compact();var f=h.getLabels().findAll(function(q){return l.any(function(r){return q.id.endsWith(r);});});if(f.length==0){return;}var g=f.length<=1?f[0]:null;if(!g){g=f.find(function(q){return !n||q.node==n.target||q.node==n.target.parentNode;});if(!g){var o=this.facade.eventCoordinates(n);var p=this.facade.getCanvas().rootNode.lastChild.getScreenCTM();o.x*=p.a;o.y*=p.d;var m=f.collect(function(s){var r=this.getCenterPosition(s.node);var q=Math.sqrt(Math.pow(r.x-o.x,2)+Math.pow(r.y-o.y,2));return{diff:q,label:s};}.bind(this));m.sort(function(r,q){return r.diff>q.diff?1:(r.diff==q.diff?-1:-1);});g=m[0].label;}}return g;},getPropertyByLabel:function(e,f){var h=this.facade.getCanvas().getLanguage();var g=e.getStencil().properties().findAll(function(k){return k.refToView()&&k.refToView().length>0&&(!k.language()||k.language()==h);});return g.find(function(k){return k.refToView().any(function(l){return f.id==e.id+l;});});}});var a=function(e){Ext.PagingToolbar.prototype.paramNames.start="offset";e=e||{};var f={select:"title",originId:e.parentDir,operator:"OR"};if(e.categories){f.category=e.categories;}e.store=new Ext.data.Store({baseParams:f,proxy:new Ext.data.HttpProxy({useAjax:true,method:"GET",headers:{accept:"application/json"},url:"/p/glossary"}),reader:new Signavio.Helper.RecordReader()});e.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">','<img class="x-{[(values.rep.category||"").toLowerCase()]} x-image" src="/v5designer/libs/ext-2.0.2/resources/images/default/s.gif"/>','<tpl for="rep">{[Signavio.Utils.escapeHTML(values.title||"")]}</tpl>',"</div></tpl>");e.style="";e.cls="x-glossary-support";this.defaultAutoCreate={tag:e.renderAsTextArea?"textarea":"input",autocomplete:"off",style:"visibility:hidden;"};this.renderAsTextArea=e.renderAsTextArea;a.superclass.constructor.call(this,e);};Ext.extend(a,Ext.form.ComboBox,{lazyRender:false,listClass:"x-glossary-support",listWidth:200,displayField:"href",typeAhead:false,loadingText:Signavio.I18N.Glossary_Support.renameLoading,emptyTextList:'<div class="x-no-entry">'+Signavio.I18N.Glossary_Support.renameEmpty+"</div>",pageSize:10,lazyInit:false,queryDelay:100,minChars:2,preventScrollbars:true,queryParam:"q",hideTrigger:true,resizable:true,itemSelector:"div.search-item",onSelect:function(e){},initList:function(){a.superclass.initList.apply(this,arguments);if(this.emptyTextList){this.view.emptyText=this.emptyTextList;}if(this.view){this.view.onMouseOut=function(n){if(this.lastItem){try{if(!n.within(this.lastItem,true)){Ext.fly(this.lastItem).removeClass(this.overClass);delete this.lastItem;}}catch(m){}}}.bind(this.view);}if(this.pageTb){var e=this.pageTb;this.pageTb.items.each(function(m){if(!(m==e.first||m==e.prev||m==e.next||m==e.last)){m.hide();}});var l=e.addText("");var f=2;e.tr.insertBefore(l.el.parentNode,e.tr.childNodes[f]);e.items.remove(l);e.items.insert(f,l);e.displayMsg="{0}/{1}";e.displayEl=Ext.fly(l.el).createChild({cls:"x-paging-info",style:{display:"inline",position:"relative",left:"0",top:"0"}});var k=e.addFill();e.tr.insertBefore(k.el.parentNode,e.tr.childNodes[++f]);e.items.remove(k);e.items.insert(f,k);var h=this.pageSize,g=this;e.updateInfo=function(){if(this.displayEl){var m=this.store.getTotalCount()<=h?"":String.format(this.displayMsg,Math.ceil((this.cursor+1)/h),Math.ceil(this.store.getTotalCount()/h));this.displayEl.update(m);if(!m){g.assetHeight-=!this.hidden?23:0;this.hide();}else{g.assetHeight+=this.hidden?23:0;this.show();}}};}},onRender:function(){a.superclass.onRender.apply(this,arguments);if(this.grow){this.textSizeEl=Ext.DomHelper.append(document.body,{tag:"pre",cls:"x-form-grow-sizer"});if(this.preventScrollbars){this.el.setStyle("overflow","hidden");}this.el.setHeight(this.growMin);}},onDestroy:function(){if(this.textSizeEl){Ext.removeNode(this.textSizeEl);}if(this.view&&this.view.lastItem){delete this.view.lastItem;}a.superclass.onDestroy.call(this);},growMin:60,growMax:1000,growAppend:"&#160;",growPad:0,onKeyUp:function(f){a.superclass.onKeyUp.apply(this,arguments);if(this.renderAsTextArea&&(f.getKey()==f.ENTER||f.getKey()==f.DELETE||f.getKey()==8||true)){this.autoSize();}},onBlur:function(e,g){if(Ext.isIE9&&g===this.el.dom){Event.stop(e.browserEvent);return;}this.beforeBlur();if(!Ext.isOpera&&this.focusClass){this.el.removeClass(this.focusClass);}this.hasFocus=false;if(this.validationEvent!==false&&this.validateOnBlur&&this.validationEvent!="blur"){this.validate();}var f=this.getValue();if(String(f)!==String(this.startValue)){this.fireEvent("change",this,f,this.startValue);}this.fireEvent("blur",this);},onBeforeLoad:function(){if(!this.hasFocus){return;}if(!this.innerList.child("div.loading-indicator")){if(this.store.getCount()>0){this.innerList.createChild({tag:"div",cls:"loading-indicator",html:this.loadingText});}else{this.innerList.update(this.loadingText?'<div class="loading-indicator">'+this.loadingText+"</div>":"");}}if(this.selectedIndex>=0){this.lastSelectedRecord=this.store.getAt(this.selectedIndex);}else{delete this.lastSelectedRecord;}this.restrictHeight();},initQuery:function(){if(this.list){this.doQuery(this.getRawValue());}},getParams:function(e){var f={};if(this.pageSize){f.offset=0;f.limit=this.pageSize;}return f;},doQuery:function(h,g){if(!this.store){return;}if(h===undefined||h===null){h="";}var f={query:h,forceAll:g,combo:this,cancel:false};if(this.fireEvent("beforequery",f)===false||f.cancel){return false;}h=f.query;g=f.forceAll;var e=(h||"").split(/\s+/).findAll(function(k){return k.length>=this.minChars;}.bind(this));if(g===true||e.length>0){e=e.join(" ");if(this.lastQuery!==e){this.lastQuery=e;if(this.mode=="local"){this.selectedIndex=-1;if(g){this.store.clearFilter();}else{this.store.filter(this.displayField,h);}this.onLoad();}else{this.store.baseParams[this.queryParam]=e;this.store.load({params:this.getParams(e)});this.expand();}}else{this.selectedIndex=-1;this.onLoad();}}},onLoad:function(){if(!this.hasFocus){return;}if(this.store.getCount()>0){this.expand();this.restrictHeight();if(this.lastQuery==this.allQuery){if(this.editable){this.el.dom.select();}}else{if(this.typeAhead&&this.lastKey!=Ext.EventObject.BACKSPACE&&this.lastKey!=Ext.EventObject.DELETE){this.taTask.delay(this.typeAheadDelay);}}var e=-1;if(this.lastSelectedRecord){e=this.store.find("href",this.lastSelectedRecord.get("href"));}this.select(e,true);}else{this.onEmptyResults();}},onEmptyResults:function(){this.restrictHeight();},initEvents:function(){Ext.form.ComboBox.superclass.initEvents.call(this);this.keyNav=new Ext.KeyNav(this.el,{"up":function(f){if(this.selectedIndex==0){this.select(-1);}else{if(this.selectedIndex>0){this.inKeyMode=true;this.selectPrev();}}},"down":function(f){if(this.store.getCount()>0){if(!this.isExpanded()){this.onTriggerClick();}else{this.inKeyMode=true;this.selectNext();}}},"enter":function(f){if(this.selectedIndex>=0&&this.isExpanded()){this.onViewClick();this.delayedCheck=true;this.unsetDelayCheck.defer(10,this);}if(f.ctrlKey){this.onBlur();}},"esc":function(f){if(this.isExpanded()){this.collapse();}else{this.onBlur();}},"tab":function(f){this.onViewClick(false);return true;},scope:this,doRelay:function(g,f,e){if(e=="down"&&this.scope.store.getCount()>0){return Ext.KeyNav.prototype.doRelay.apply(this,arguments);}else{if(e=="down"){return true;}}if(e=="up"&&this.scope.selectedIndex<0){return true;}if(e=="enter"&&this.scope.isExpanded()&&this.scope.selectedIndex>=0){return Ext.KeyNav.prototype.doRelay.apply(this,arguments);}if(e=="esc"){return Ext.KeyNav.prototype.doRelay.apply(this,arguments);}if(e!="enter"&&this.scope.isExpanded()){return Ext.KeyNav.prototype.doRelay.apply(this,arguments);}return true;},forceKeyDown:true});this.queryDelay=Math.max(this.queryDelay||10,this.mode=="local"?10:250);this.dqTask=new Ext.util.DelayedTask(this.initQuery,this);if(this.typeAhead){this.taTask=new Ext.util.DelayedTask(this.onTypeAhead,this);}if(this.editable!==false){this.el.on("keyup",this.onKeyUp,this);}if(this.forceSelection){this.on("blur",this.doForce,this);}this.list.dom.addEventListener("mousedown",function(f){Event.stop(f);},false);this.footer.dom.addEventListener("mousedown",function(f){Event.stop(f);},false);},autoSize:function(){if(!this.grow||!this.textSizeEl){return;}var k=this.el;var f=k.dom.value;var l=this.textSizeEl;if(!l||!k){return;}l.innerHTML="";l.appendChild(document.createTextNode(f));f=l.innerHTML;try{Ext.fly(l).setWidth(this.el.getWidth());}catch(m){}if(f.length<1){f="&#160;&#160;";}else{if(Ext.isIE){}f+=this.growAppend;}l.innerHTML=f;var g=Math.min(this.growMax,Math.max(l.offsetHeight,this.growMin)+this.growPad);if(g!=this.lastHeight){this.lastHeight=g;this.el.setHeight(g);this.fireEvent("autosize",this,g);if(this.list){this.list.alignTo(this.el,this.listAlign);}}}});}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.JSONSupport=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":ORYX.I18N.JSONSupport.exp.name,"functionality":this.exportJSON.bind(this),"group":ORYX.I18N.JSONSupport.exp.group,dropDownGroupIcon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/page_white_get.png","icon":ORYX.PATH+"images/page_white_javascript.png","description":ORYX.I18N.JSONSupport.exp.desc,"index":0,"minShape":0,"maxShape":0});this.facade.offer({"name":ORYX.I18N.JSONSupport.imp.name,"functionality":this.showImportDialog.bind(this),"group":ORYX.I18N.JSONSupport.imp.group,dropDownGroupIcon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/page_white_put.png","icon":ORYX.PATH+"images/page_white_javascript.png","description":ORYX.I18N.JSONSupport.imp.desc,"index":1,"minShape":0,"maxShape":0});},exportJSON:function(){var a=this.facade.getSerializedJSON();this.openDownloadWindow(window.document.title+".json",a);},showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.JSONSupport.imp.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.JSONSupport.imp.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.JSONSupport.imp.name,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.JSONSupport.imp.btnImp,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.JSONSupport.imp.progress});d.show();window.setTimeout(function(){var f=c.items.items[2].getValue();try{this.facade.importJSON(f,true);b.close();}catch(e){Ext.Msg.alert(ORYX.I18N.JSONSupport.imp.syntaxError,e.message);}finally{d.hide();}}.bind(this),100);}.bind(this)},{text:ORYX.I18N.JSONSupport.imp.btnClose,handler:function(){b.close();}.bind(this)}]});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsText("UTF-8");c.items.items[2].setValue(e);},true);}});if(!ORYX.Plugins){ORYX.Plugins={};}ORYX.Plugins.FeedbackPlugin=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":ORYX.I18N.Feedback.name,"functionality":this.showWindow.bind(this),"group":"Help","description":ORYX.I18N.Feedback.desc,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/email.png","index":0,"minShape":0,"maxShape":0});},showWindow:function(){var d=this.facade.getModelMetaData().mode;var b=this.facade.getSerializedJSON();var a=ORYX.CONFIG.SERVER_HANDLER_ROOT+"/support";var c=this.facade.getModelMetaData().supportMailAddress;new Ext.ux.view.FeedbackWindow(d,a,ORYX.CONFIG.EXPLORER_PATH,b,c);}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Undo=Clazz.extend({facade:undefined,undoStack:[],redoStack:[],construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Undo.undo,description:ORYX.I18N.Undo.undoDesc,icon:ORYX.PATH+"images/arrow_undo.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:90,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.doUndo.bind(this),group:ORYX.I18N.Undo.group,isEnabled:function(){return this.undoStack.length>0;}.bind(this),index:0});this.facade.offer({name:ORYX.I18N.Undo.redo,description:ORYX.I18N.Undo.redoDesc,icon:ORYX.PATH+"images/arrow_redo.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:89,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.doRedo.bind(this),group:ORYX.I18N.Undo.group,isEnabled:function(){return this.redoStack.length>0;}.bind(this),index:1});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,this.handleExecuteCommands.bind(this));},handleExecuteCommands:function(a){if(!a.commands){return;}this.undoStack.push(a.commands);this.redoStack=[];},doUndo:function(){var a=this.undoStack.pop();if(a){this.redoStack.push(a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_BEFORE_ROLLBACK,forceExecution:true,commands:a});for(var b=a.length-1;b>=0;--b){a[b].rollback();}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_ROLLBACK,commands:a});this.facade.getCanvas().update();this.facade.updateSelection();}},doRedo:function(){var a=this.redoStack.pop();if(a){this.undoStack.push(a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_BEFORE_EXECUTE,forceExecution:true,commands:a});a.each(function(b){b.execute();}.bind(this));this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_EXECUTE,commands:a});this.facade.getCanvas().update();this.facade.updateSelection();}}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.ProcessLink=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.propertyChanged.bind(this));},propertyChanged:function(a,b){if(a.name!=="oryx-refuri"||!b instanceof ORYX.Core.Node){return;}if(a.value&&a.value.length>0&&a.value!="undefined"){this.show(b,a.value);}else{this.hide(b);}},show:function(a,b){var d=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{},["a",{"target":"_blank"},["path",{"style":"fill:white;stroke:grey;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72","d":"M0 1.44 L0 15.05 L11.91 15.05 L11.91 5.98 L7.37 1.44 L0 1.44 Z"}],["path",{"style":"stroke:grey;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72;fill:#EEEEEE;","transform":"translate(7.5, -8.5)","d":"M0 10.51 L0 15.05 L4.54 15.05"}],["path",{"style":"fill:silver;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72","transform":"translate(-3, -1)","d":"M0 8.81 L0 13.06 L5.95 13.06 L5.95 15.05 A50.2313 50.2313 -175.57 0 0 10.77 11.08 A49.9128 49.9128 -1.28 0 0 5.95 6.54 L5.95 8.81 L0 8.81 Z"}]]]);var c=d.childNodes[0];c.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",b);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"arissupport.urlref_"+a.id,shapes:[a],node:d,nodePosition:"SE"});},hide:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"arissupport.urlref_"+a.id});}});Array.prototype.insertFrom=function(e,d){d=Math.max(0,d);e=Math.min(Math.max(0,e),this.length-1);var b=this[e];var a=this.without(b);var c=a.slice(0,d);c.push(b);if(a.length>d){c=c.concat(a.slice(d));}return c;};if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Arrangement=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.Arrangement.am,"functionality":this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_MIDDLE]),"group":ORYX.I18N.Arrangement.groupA,"icon":ORYX.PATH+"images/shape_align_middle.png","description":ORYX.I18N.Arrangement.amDesc,"index":1,"minShape":2});this.facade.offer({"name":ORYX.I18N.Arrangement.ac,"functionality":this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_CENTER]),"group":ORYX.I18N.Arrangement.groupA,"icon":ORYX.PATH+"images/shape_align_center.png","description":ORYX.I18N.Arrangement.acDesc,"index":2,"minShape":2});this.facade.offer({"name":ORYX.I18N.Arrangement.as,"functionality":this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_SIZE]),"group":ORYX.I18N.Arrangement.groupA,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/arrow_inout.png","description":ORYX.I18N.Arrangement.asDesc,"index":3,"minShape":2});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_TOP,this.setZLevel.bind(this,this.setToTop));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_BACK,this.setZLevel.bind(this,this.setToBack));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_FORWARD,this.setZLevel.bind(this,this.setForward));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_BACKWARD,this.setZLevel.bind(this,this.setBackward));},onSelectionChanged:function(a){var b=this.facade.getSelection();if(b.length===1&&b[0] instanceof ORYX.Core.Edge){this.setToTop(b);}},setZLevel:function(d,b){var a=ORYX.Core.Command.extend({construct:function(g,f,e){this.callback=g;this.elements=f;this.elAndIndex=f.map(function(h){return{el:h,previous:h.parent.children[h.parent.children.indexOf(h)-1]};});this.facade=e;},execute:function(){this.callback(this.elements);this.facade.setSelection(this.elements);},rollback:function(){var g=this.elAndIndex.sortBy(function(n){var o=n.el;var m=$A(o.node.parentNode.childNodes);return m.indexOf(o.node);});for(var f=0;f<g.length;f++){var h=g[f].el;var k=h.parent;var l=k.children.indexOf(h);var e=k.children.indexOf(g[f].previous);e=e||0;k.children=k.children.insertFrom(l,e);h.node.parentNode.insertBefore(h.node,h.node.parentNode.childNodes[e+1]);}this.facade.setSelection(this.elements);}});var c=new a(d,this.facade.getSelection(),this.facade);if(b.excludeCommand){c.execute();}else{this.facade.executeCommands([c]);}},setToTop:function(b){var a=b.sortBy(function(e,c){if(!e.node||!e.node.parentNode){return 0;}var d=$A(e.node.parentNode.childNodes);return d.indexOf(e.node);});a.each(function(c){if(!c.node||!c.node.parentNode){return;}var d=c.parent;if(d.children.last()===c){return;}d.children=d.children.without(c);d.children.push(c);c.node.parentNode.appendChild(c.node);});},setToBack:function(b){var a=b.sortBy(function(e,c){var d=$A(e.node.parentNode.childNodes);return d.indexOf(e.node);});a=a.reverse();a.each(function(c){var d=c.parent;d.children=d.children.without(c);d.children.unshift(c);c.node.parentNode.insertBefore(c.node,c.node.parentNode.firstChild);});},setBackward:function(c){var b=c.sortBy(function(f,d){var e=$A(f.node.parentNode.childNodes);return e.indexOf(f.node);});b=b.reverse();var a=b.findAll(function(d){return !b.some(function(e){return e.node==d.node.previousSibling;});});a.each(function(e){if(e.node.previousSibling===null){return;}var f=e.parent;var d=f.children.indexOf(e);f.children=f.children.insertFrom(d,d-1);e.node.parentNode.insertBefore(e.node,e.node.previousSibling);});},setForward:function(c){var b=c.sortBy(function(f,d){var e=$A(f.node.parentNode.childNodes);return e.indexOf(f.node);});var a=b.findAll(function(d){return !b.some(function(e){return e.node==d.node.nextSibling;});});a.each(function(f){var d=f.node.nextSibling;if(d===null){return;}var e=f.parent.children.indexOf(f);var g=f.parent;g.children=g.children.insertFrom(e,e+1);f.node.parentNode.insertBefore(d,f.node);});},alignShapes:function(b){var f=this.facade.getSelection();f=this.facade.getCanvas().getShapesWithSharedParent(f);f=f.findAll(function(h){return(h instanceof ORYX.Core.Node);});f=f.findAll(function(h){var k=h.getIncomingShapes();return k.length==0||!f.include(k[0]);});if(f.length<2){return;}var e=f[0].absoluteBounds().clone();f.each(function(h){e.include(h.absoluteBounds().clone());});var d=0;var c=0;f.each(function(h){d=Math.max(h.bounds.width(),d);c=Math.max(h.bounds.height(),c);});var a=ORYX.Core.Command.extend({construct:function(o,n,m,l,h,k){this.elements=o;this.bounds=n;this.maxHeight=m;this.maxWidth=l;this.way=h;this.facade=k.facade;this.plugin=k;this.orgPos=[];},setBounds:function(h,l){if(!l){l={width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE};}if(!h.bounds){throw"Bounds not definined.";}var k={a:{x:h.bounds.upperLeft().x-(this.maxWidth-h.bounds.width())/2,y:h.bounds.upperLeft().y-(this.maxHeight-h.bounds.height())/2},b:{x:h.bounds.lowerRight().x+(this.maxWidth-h.bounds.width())/2,y:h.bounds.lowerRight().y+(this.maxHeight-h.bounds.height())/2}};if(this.maxWidth>l.width){k.a.x=h.bounds.upperLeft().x-(l.width-h.bounds.width())/2;k.b.x=h.bounds.lowerRight().x+(l.width-h.bounds.width())/2;}if(this.maxHeight>l.height){k.a.y=h.bounds.upperLeft().y-(l.height-h.bounds.height())/2;k.b.y=h.bounds.lowerRight().y+(l.height-h.bounds.height())/2;}h.bounds.set(k);},execute:function(){this.elements.each(function(h,k){this.orgPos[k]=h.bounds.upperLeft();var l=this.bounds.clone();var o;if(h.parent&&!(h.parent instanceof ORYX.Core.Canvas)){var n=h.parent.absoluteBounds().upperLeft();l.moveBy(-n.x,-n.y);}switch(this.way){case ORYX.CONFIG.EDITOR_ALIGN_BOTTOM:o={x:h.bounds.upperLeft().x,y:l.b.y-h.bounds.height()};break;case ORYX.CONFIG.EDITOR_ALIGN_MIDDLE:o={x:h.bounds.upperLeft().x,y:(l.a.y+l.b.y-h.bounds.height())/2};break;case ORYX.CONFIG.EDITOR_ALIGN_TOP:o={x:h.bounds.upperLeft().x,y:l.a.y};break;case ORYX.CONFIG.EDITOR_ALIGN_LEFT:o={x:l.a.x,y:h.bounds.upperLeft().y};break;case ORYX.CONFIG.EDITOR_ALIGN_CENTER:o={x:(l.a.x+l.b.x-h.bounds.width())/2,y:h.bounds.upperLeft().y};break;case ORYX.CONFIG.EDITOR_ALIGN_RIGHT:o={x:l.b.x-h.bounds.width(),y:h.bounds.upperLeft().y};break;case ORYX.CONFIG.EDITOR_ALIGN_SIZE:if(h.isResizable){this.orgPos[k]={a:h.bounds.upperLeft(),b:h.bounds.lowerRight()};this.setBounds(h,h.maximumSize);}break;}if(o){var m={x:h.bounds.upperLeft().x-o.x,y:h.bounds.upperLeft().y-o.y};h.bounds.moveTo(o);this.plugin.layoutEdges(h,h.getAllDockedShapes(),m);}}.bind(this));},rollback:function(){this.elements.each(function(h,k){if(this.way==ORYX.CONFIG.EDITOR_ALIGN_SIZE){if(h.isResizable){h.bounds.set(this.orgPos[k]);}}else{h.bounds.moveTo(this.orgPos[k]);}}.bind(this));}});var g=new a(f,e,c,d,parseInt(b),this);this.facade.executeCommands([g]);}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Save=Clazz.extend({facade:undefined,processURI:undefined,changeSymbol:"*",construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.Save.save,"functionality":this.save.bind(this,false),"group":ORYX.I18N.Save.group,"icon":ORYX.PATH+"images/disk.png","description":ORYX.I18N.Save.saveDesc,"index":1,"minShape":0,"maxShape":0,keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:83,keyAction:ORYX.CONFIG.KEY_ACTION_UP}]});document.addEventListener("keydown",function(b){if(b.ctrlKey&&b.keyCode===83){Event.stop(b);}},false);this.facade.offer({"name":ORYX.I18N.Save.saveAs,"functionality":this.save.bind(this,true),"group":ORYX.I18N.Save.group,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/save_as.png","description":ORYX.I18N.Save.saveAsDesc,"index":2,"minShape":0,"maxShape":0});window.onbeforeunload=this.onUnLoad.bind(this);this.changeDifference=0;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_EXECUTE,function(){this.changeDifference++;this.updateTitle();}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,function(){this.changeDifference++;this.updateTitle();}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_ROLLBACK,function(){this.changeDifference--;this.updateTitle();}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.updateTitle.bind(this));},updateTitle:function(){var a=window.document.title||document.getElementsByTagName("title")[0].childNodes[0].nodeValue;if(this.changeDifference===0&&a.startsWith(this.changeSymbol)){window.document.title=a.slice(1);}else{if((this.isNewNonEmptyModel()||this.changeDifference!==0)&&!a.startsWith(this.changeSymbol)){window.document.title=this.changeSymbol+""+a;}}},isNewNonEmptyModel:function(){return this.facade.getModelMetaData()["new"]&&this.facade.getModelMetaData().model.childShapes;},onUnLoad:function(){if(this.changeDifference!==0||this.isNewNonEmptyModel()){return ORYX.I18N.Save.unsavedData;}},saveSynchronously_smartdot:function(c,e){var b="/v5designer/edit_smartdot.html?model=default&data";this.saving=false;var f=this.facade.getCanvas().getSVGRepresentation(true);var d=DataManager.serialize(f);this.serializedDOM=Ext.encode(this.facade.getJSON());var g={data:this.serializedDOM,svg:d,title:"default",summary:"",type:"http://b3mn.org/stencilset/smartdot#"};var a="/v5designer/save?new=/v5designer/index.html";new Ajax.Request(a,{method:"POST",asynchronous:false,parameters:g,onSuccess:(function(k){var h=k.getResponseHeader("location");if(h){this.processURI=h;}else{this.processURI=a;}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_MODEL_SAVED});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Save.saved});}).bind(this),onFailure:(function(h){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.failed);ORYX.log.warn("Saving failed: "+h.responseText);}).bind(this),on403:(function(h){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.noRights);ORYX.log.warn("Saving failed: "+h.responseText);}).bind(this)});},saveSynchronously:function(f,g){if(!g){return;}var c=this.facade.getModelMetaData();var d=c.modelHandler;if(location.pathname.include("edit_smartdot.html")){this.saveSynchronously_smartdot(f,g);return;}var k=this.facade.getStencilSets().values()[0];var h=k.title();var a=(c["new"]?c.name||ORYX.I18N.Save.newProcess:(c.name!==g.name?c.name:g.name));var b={title:Signavio.Utils.escapeHTML(a||"").replace(/["]/g,"&quot;"),summary:Signavio.Utils.escapeHTML(g.description||""),type:h,url:d,namespace:g.model.stencilset.namespace,comment:""};var e=new Ext.XTemplate('<form class="oryx_repository_edit_model" action="#" id="edit_model" onsubmit="return false;">',"<fieldset>",'<p class="description">'+ORYX.I18N.Save.dialogDesciption+"</p>",'<input type="hidden" name="namespace" value="{namespace}" />','<p><label for="edit_model_title">'+ORYX.I18N.Save.dialogLabelTitle+'</label><input type="text" class="text" name="title" value="{title}" id="edit_model_title" onfocus="this.className = \'text activated\'" onblur="this.className = \'text\'"/></p>','<p><label for="edit_model_summary">'+ORYX.I18N.Save.dialogLabelDesc+'</label><textarea rows="5" name="summary" id="edit_model_summary" onfocus="this.className = \'activated\'" onblur="this.className = \'\'">{summary}</textarea></p>',(c.versioning)?'<p><label for="edit_model_comment">'+ORYX.I18N.Save.dialogLabelComment+'</label><textarea rows="5" name="comment" id="edit_model_comment" onfocus="this.className = \'activated\'" onblur="this.className = \'\'">{comment}</textarea></p>':"",'<p><label for="edit_model_type">'+ORYX.I18N.Save.dialogLabelType+'</label><input type="text" name="type" class="text disabled" value="{type}" disabled="disabled" id="edit_model_type" /></p>',"</fieldset>","</form>");callback=function(o){var F=o.elements["title"].value.strip();F=F.length==0?b.title:F;var s=o.elements["summary"].value.strip();var x=o.elements["namespace"].value.strip();x=x.length==0?b.namespace:x;var m=o.elements["comment"].value.strip();m=m.length==0?b.comment:m;c.name=F;c.description=s;c.parent=g.parent;c.namespace=x;if(!f){window.document.title=this.changeSymbol+F+" | "+ORYX.CONFIG.APPNAME;}var B=this.facade.getJSON(),y=[];var r=this.facade.getCanvas().getShapeBounds(),D=this.facade.getCanvas().getShapeSize();if(r.upperLeft().x!==D.upperLeft().x||r.upperLeft().y!==D.upperLeft().y){B.offset={x:r.upperLeft().x-D.upperLeft().x,y:r.upperLeft().y-D.upperLeft().y};}if(this.facade.hasGlossaryExtension){Ext.apply(B,ORYX.Core.AbstractShape.JSONHelper);var z=B.getChildShapes(true);var n={};this.facade.getGlossary().each(function(G){if("undefined"==typeof n[G.shape.resourceId+"-"+G.property.prefix()+"-"+G.property.id()]){n[G.shape.resourceId+"-"+G.property.prefix()+"-"+G.property.id()]=0;}y.push({itemId:G.glossary,elementId:G.shape.resourceId,propertyId:G.property.prefix()+"-"+G.property.id(),order:n[G.shape.resourceId+"-"+G.property.prefix()+"-"+G.property.id()]++});if(G.property.refToView()&&G.property.refToView().length>0){G.property.refToView().each(function(I){var H=$(G.shape.id+""+I);if(H){H.setAttribute("oryx:glossaryIds",G.glossary+";");}});}}.bind(this));B=B.serialize();}else{B=Ext.encode(B);}y=Ext.encode(y);var E=this.facade.getSelection();this.facade.setSelection([]);var l=this.facade.getCanvas().getSVGRepresentation(true);this.facade.setSelection(E);if(this.facade.getCanvas().properties["oryx-showstripableelements"]!==true){var q=Element.getElementsByClassName(l,"stripable-element");for(var A=q.length-1;A>=0;A--){q[A].parentNode.removeChild(q[A]);}}var q=Element.getElementsByClassName(l,"stripable-element-force");for(var A=q.length-1;A>=0;A--){q[A].parentNode.removeChild(q[A]);}var p=DataManager.serialize(l);var C={json_xml:B,svg_xml:p,name:F,type:b.type,parent:c.parent,description:s,comment:m,glossary_xml:y,namespace:c.namespace,views:Ext.util.JSON.encode(c.views||[])};var t=false;var u=function(M){var L=M.getResponseHeader.location;if(!this.processURI&&L){this.processURI=L;}if(f){var K=M.responseText.evalJSON();var I=location.href.substring(0,location.href.indexOf(location.search))+"?id="+K.href.substring(7);var G=new Ext.Window({title:ORYX.I18N.Save.savedAs,bodyStyle:"background:white;padding:10px",width:"auto",height:"auto",html:"<div style='font-weight:bold;margin-bottom:10px'>"+ORYX.I18N.Save.savedDescription+":</div><span><a href='"+I+"' target='_blank'>"+I+"</a></span>",buttons:[{text:"Ok",handler:function(){G.destroy();}}]});G.show();window.open(I);}t=true;win.close();var K=M.responseText.evalJSON();if(K&&K instanceof Array){var H=[],J=K.find(function(N){return"views"==N.rel;});if(J&&J.rep.length>0){J.rep.each(function(N){H.push(N.rep.view);}.bind(this));c.views=H;}else{c.views=[];}}if(t){this.changeDifference=0;this.updateTitle();if(c["new"]){c["new"]=false;}}delete this.saving;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SAVED});if(c["isTestSystem"]){var K=M.responseText.evalJSON();if(K instanceof Array){K=K.find(function(N){return N.rel=="info";});}if(K&&K.rep&&K.rep.svgDiff){this.window=new Ext.Window({title:"SVG Renderer Difference!",html:"The SVG rendered by the server component differs significantly from the editor SVG!<br/>"+"An additional revision has automatically been created as the head revision. "+"Please compare the SVGs of the last (server SVG) and next to last (client SVG) revisions.<br/>"+"If there are any visible differences please report them to the developers!"+"<br/><br/>"+K.rep.svgDiffString,renderTo:document.body,height:600,width:800,bodyStyle:"overflow:auto;",buttons:[new Ext.Button({text:"close",handler:function(){this.window.close();}.bind(this)})]});this.window.show();}}}.bind(this);var v=function(G){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});win.close();if(G.status&&G.status===401){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.notAuthorized).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize();}else{if(G.status&&G.status===403){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.noRights).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize();}else{if(G.statusText==="transaction aborted"){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.transAborted).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize();}else{if(G.statusText==="communication failure"){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.comFailed).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize();}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.failed).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).center().syncSize();}}}}delete this.saving;}.bind(this);if(c["new"]){C.id=c.modelId;this.sendSaveRequest("POST",d,C,f,u,v);}else{if(f){this.sendSaveRequest("POST",d,C,f,u,v);}else{if(!d.include(c.modelId)){d+="/"+c.modelId;}C.id=c.modelId;this.sendSaveRequest("PUT",d,C,false,u,v);}}}.bind(this);win=new Ext.Window({id:"Propertie_Window",width:"auto",height:"auto",title:f?ORYX.I18N.Save.saveAsTitle:ORYX.I18N.Save.save,modal:true,resize:false,bodyStyle:"background:#FFFFFF",html:e.apply(b),defaultButton:0,buttons:[{text:ORYX.I18N.Save.saveBtn,handler:function(){win.body.mask(ORYX.I18N.Save.pleaseWait,"x-waiting-box");window.setTimeout(function(){callback($("edit_model"));}.bind(this),10);},listeners:{render:function(){this.focus();}}},{text:ORYX.I18N.Save.close,handler:function(){win.close();}.bind(this)}],listeners:{close:function(){win.destroy();delete this.saving;}.bind(this)}});win.show();},retrieveModelData:function(b){var a=function(){Ext.getBody().unmask();};new Ajax.Request(window.location.href.replace(/#.*/g,"").replace(ORYX.CONFIG.SERVER_EDITOR_HANDLER.replace("..",""),ORYX.CONFIG.SERVER_EDITOR_DATA_HANDLER.replace("..","")),{method:"get",asynchronous:true,requestHeaders:{"Accept":"application/json"},encoding:"UTF-8",onSuccess:(function(c){modelInfo=(c.responseText||"{}").evalJSON();a();b(modelInfo);}).bind(this),onException:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});delete this.saving;a();Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.exception).setIcon(Ext.Msg.ERROR).getDialog().setWidth(260).syncSize();}.bind(this),onFailure:(function(c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});delete this.saving;a();Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.failed).setIcon(Ext.Msg.ERROR).getDialog().setWidth(260).syncSize();}).bind(this),on401:(function(c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});delete this.saving;a();Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.notAuthorized).setIcon(Ext.Msg.WARNING).getDialog().setWidth(260).syncSize();}).bind(this),on403:(function(c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});delete this.saving;a();Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.noRights).setIcon(Ext.Msg.ERROR).getDialog().setWidth(260).syncSize();}).bind(this)});},sendSaveRequest:function(f,b,e,c,d,a){Ext.Ajax.request({url:b,method:f,timeout:1800000,disableCaching:true,headers:{"Accept":"application/json","Content-Type":"charset=UTF-8"},params:e,success:d,failure:a});},save:function(b,c){var a=this.facade.getJSON();a=a.serialize();console.log(a);if(this.saving){return;}this.saving=true;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_ABOUT_TO_SAVE});window.setTimeout((function(){var d=this.facade.getModelMetaData();if(!d["new"]){d["new"]=true;}if(d["new"]){this.saveSynchronously(b,d);}else{Ext.getBody().mask(ORYX.I18N.Save.retrieveData,"x-waiting-box");this.retrieveModelData(this.saveSynchronously.bind(this,b));}}).bind(this),10);return true;}});ORYX.Plugins.File=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.File.info,"functionality":this.info.bind(this),"group":ORYX.I18N.File.group,"icon":ORYX.PATH+"images/information.png","description":ORYX.I18N.File.infoDesc,"index":5,"minShape":0,"maxShape":0});},info:function(){var a='<iframe src="'+ORYX.CONFIG.LICENSE_URL+'" type="text/plain" '+'style="border:none;display:block;width:575px;height:480px;"/>';this.infoBox=Ext.Msg.show({title:ORYX.I18N.Oryx.title,msg:a,width:640,maxWidth:640,maxHeight:480,buttons:Ext.MessageBox.OK});return false;},exportPDF:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.File.genPDF});var c=location.href;var b=this.facade.getCanvas().getSVGRepresentation(true);var a=DataManager.serialize(b);new Ajax.Request(ORYX.CONFIG.PDF_EXPORT_URL,{method:"POST",parameters:{resource:c,data:a,format:"pdf"},onSuccess:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});window.open(d.responseText);}).bind(this),onFailure:(function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.File.genPDFFailed);}).bind(this)});},print:function(){Ext.Msg.show({title:ORYX.I18N.File.printTitle,msg:ORYX.I18N.File.printMsg,buttons:Ext.Msg.YESNO,icon:Ext.MessageBox.QUESTION,fn:function(c){if(c=="yes"){var e=$H({width:300,height:400,toolbar:"no",status:"no",menubar:"yes",dependent:"yes",resizable:"yes",scrollbars:"yes"});var f=window.open("","PrintWindow",e.invoke("join","=").join(","));var b=f.document.getElementsByTagName("head")[0];var d=document.createElement("style");d.innerHTML=" body {padding:0px; margin:0px} .svgcontainer { display:none; }";b.appendChild(d);f.document.getElementsByTagName("body")[0].appendChild(this.facade.getCanvas().getSVGRepresentation());var a=f.document.getElementsByTagName("body")[0].getElementsByTagName("svg")[0];a.setAttributeNS(null,"width",1100);a.setAttributeNS(null,"height",1400);a.lastChild.setAttributeNS(null,"transform","scale(0.47, 0.47) rotate(270, 1510, 1470)");var h=["marker-start","marker-mid","marker-end"];var g=$A(f.document.getElementsByTagName("path"));g.each(function(k){h.each(function(l){var m=k.getAttributeNS(null,l);if(!m){return;}m="url(about:blank#"+m.slice(5);k.setAttributeNS(null,l,m);});});f.print();return true;}}.bind(this)});}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.View={facade:undefined,construct:function(b,a){this.facade=b;this.zoomLevel=1;this.maxFitToScreenLevel=1.5;this.minZoomLevel=0.1;this.maxZoomLevel=2.5;this.diff=5;a.properties.each(function(c){if(c.zoomLevel){this.zoomLevel=Number(1);}if(c.maxFitToScreenLevel){this.maxFitToScreenLevel=Number(c.maxFitToScreenLevel);}if(c.minZoomLevel){this.minZoomLevel=Number(c.minZoomLevel);}if(c.maxZoomLevel){this.maxZoomLevel=Number(c.maxZoomLevel);}}.bind(this));this.facade.offer({"name":ORYX.I18N.View.zoomIn,"functionality":this.zoom.bind(this,[1+ORYX.CONFIG.ZOOM_OFFSET]),"group":ORYX.I18N.View.group,"icon":ORYX.PATH+"images/magnifier_zoom_in.png","description":ORYX.I18N.View.zoomInDesc,"index":1,"minShape":0,"maxShape":0,"isEnabled":function(){return this.zoomLevel<this.maxZoomLevel;}.bind(this),"keyCodes":[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:107,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}]});this.facade.offer({"name":ORYX.I18N.View.zoomOut,"functionality":this.zoom.bind(this,[1/(1+ORYX.CONFIG.ZOOM_OFFSET)]),"group":ORYX.I18N.View.group,"icon":ORYX.PATH+"images/magnifier_zoom_out.png","description":ORYX.I18N.View.zoomOutDesc,"index":2,"minShape":0,"maxShape":0,"isEnabled":function(){return this._checkSize();}.bind(this),"keyCodes":[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:109,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}]});this.facade.offer({"name":ORYX.I18N.View.zoomStandard,"functionality":this.setAFixZoomLevel.bind(this,1),"group":ORYX.I18N.View.group,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/zoom_layer.png","cls":"icon-large","description":ORYX.I18N.View.zoomStandardDesc,"index":3,"minShape":0,"maxShape":0,"isEnabled":function(){return this.zoomLevel!=1;}.bind(this),"keyCodes":[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:48,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}]});this.facade.offer({"name":ORYX.I18N.View.zoomFitToModel,"functionality":this.zoomFitToModel.bind(this),"group":ORYX.I18N.View.group,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/zoom_extend.png","description":ORYX.I18N.View.zoomFitToModelDesc,"index":4,"minShape":0,"maxShape":0});document.addEventListener(Ext.isGecko?"DOMMouseScroll":"mousewheel",function(c){if(c.ctrlKey){Event.stop(c);if(c.detail<0||(!c.detail&&c.wheelDelta>0)){this.zoom(1+ORYX.CONFIG.ZOOM_OFFSET,c);}else{this.zoom(1/(1+ORYX.CONFIG.ZOOM_OFFSET),c);}}}.bind(this),false);if(Ext.isIPad){this.facade.registerOnEvent("dblclick",function(d,c){if(d.touchCount!=2&&c instanceof ORYX.Core.Canvas){this.zoom(1+(ORYX.CONFIG.ZOOM_OFFSET*2),d);}}.bind(this));this.facade.registerOnEvent("dblclick",function(d,c){if(d.touchCount==2&&c instanceof ORYX.Core.Canvas){this.zoom(1/(1+ORYX.CONFIG.ZOOM_OFFSET),d);}}.bind(this));}},setAFixZoomLevel:function(a){this.zoomLevel=a;this._checkZoomLevelRange();this.zoom(1,true);},zoom:function(l,o){if(o&&o.event){Event.stop(o.event);}if((this.zoomLevel>this.maxZoomLevel&&l>1)||(!this._checkSize()&&l<1)||(l===1&&o!==true)){return;}this.zoomLevel*=l;var e=this.facade.getCanvas().getHTMLContainer().parentNode.parentNode;var d=this.facade.getCanvas();var g=d.getHTMLContainer().parentNode.getWidth()-8;var p=d.getHTMLContainer().parentNode.getHeight()-8;var k=d.bounds.width()*this.zoomLevel;var a=d.bounds.height()*this.zoomLevel;if(!Ext.isIPad){var c=(d.node.parentNode.parentNode.parentNode.offsetHeight-a)/2;c=c>20?c-20:0;d.node.parentNode.parentNode.style.marginTop=c+"px";c+=5;d.getHTMLContainer().style.top=c+"px";}else{d.getHTMLContainer().style.top="-1px";}var m=d.getScrollPosition();var h=function(){var s=Ext.fly(e),u=s.parent(),z=Ext.fly(d.rootNode.parentNode);if(o){var r=Event.pointerX(o);var v=Event.pointerY(o);r-=z.getMargins("l")+z.getBorderWidth("l")+z.getOffsetsTo(s)[0];v-=z.getMargins("t")+z.getBorderWidth("t");var t=o?u.translatePoints(r,v):undefined;if(t&&t.left>=0&&t.left<u.getWidth()&&t.top>=0&&t.top<u.getHeight()){return{x:t.left,y:t.top};}}return{x:e.getWidth()/2,y:e.getHeight()/2};};var f=function(r,s,t,u){return((r+(u))*(t/s))-(u);};var n=h();var b=f(m.top,p,a,n.y);var q=f(m.left,g,k,n.x);d.setSize({width:k,height:a},true);if(Ext.isIPad){d.setScrollPosition(q,b);}d.setZoom(this.zoomLevel);this.facade.updateSelection();d.setScrollPosition(q,b);d.zoomLevel=this.zoomLevel;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_ZOOM,zoom:this.zoomLevel});},zoomFitToModel:function(){var h=this.facade.getCanvas().getHTMLContainer().parentNode.parentNode;var b=h.getHeight()-30;var d=h.getWidth()-30;var c=this.facade.getCanvas().getChildShapes();if(!c||c.length<1){return false;}var g=c[0].absoluteBounds().clone();c.each(function(k){g.include(k.absoluteBounds().clone());});var f=d/g.width();var a=b/g.height();var e=a<f?a:f;if(e>this.maxFitToScreenLevel){e=this.maxFitToScreenLevel;}this.setAFixZoomLevel(e);this.facade.getCanvas().setScrollPosition(Math.round(g.upperLeft().x*this.zoomLevel)-5,Math.round(g.upperLeft().y*this.zoomLevel)-5);},_checkSize:function(){var a=this.facade.getCanvas().getHTMLContainer().parentNode;var b=Math.min((a.parentNode.getWidth()/a.getWidth()),(a.parentNode.getHeight()/a.getHeight()));return 1.05>b;},_checkZoomLevelRange:function(){if(this.zoomLevel<this.minZoomLevel){this.zoomLevel=this.minZoomLevel;}if(this.zoomLevel>this.maxZoomLevel){this.zoomLevel=this.maxZoomLevel;}}};ORYX.Plugins.View=Clazz.extend(ORYX.Plugins.View);if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.DragDropResize=ORYX.Plugins.AbstractPlugin.extend({construct:function(b){this.facade=b;this.currentShapes=[];this.pluginsData=[];this.toMoveShapes=[];this.isResizing=false;this.dragEnable=false;this.dragIntialized=false;this.edgesMovable=true;this.offSetPosition={x:0,y:0};this.faktorXY={x:1,y:1};this.containmentParentNode;this.isAddingAllowed=false;this.isAttachingAllowed=false;this.callbackMouseMove=this.handleMouseMove.bind(this);this.callbackMouseUp=this.handleMouseUp.bind(this);var a=this.facade.getCanvas().getSvgContainer();this.selectedRect=new ORYX.Core.SelectedRect(a);this.vLines=[];this.hLines=[];if(ORYX.CONFIG.SHOW_GRIDLINE){this.vLine=new ORYX.Core.GridLine(a,ORYX.Core.GridLine.DIR_VERTICAL);this.hLine=new ORYX.Core.GridLine(a,ORYX.Core.GridLine.DIR_HORIZONTAL);}a=this.facade.getCanvas().getHTMLContainer();this.scrollNode=this.facade.getCanvas().rootNode.parentNode.parentNode;this.snap=new ORYX.Core.SnapToGrid(this.facade);this.resizerSE=new ORYX.Plugins.Resizer(a,"southeast",this.facade,this.snap);this.resizerSE.registerOnResize(this.onResize.bind(this));this.resizerSE.registerOnResizeEnd(this.onResizeEnd.bind(this));this.resizerSE.registerOnResizeStart(this.onResizeStart.bind(this));this.resizerNW=new ORYX.Plugins.Resizer(a,"northwest",this.facade,this.snap);this.resizerNW.registerOnResize(this.onResize.bind(this));this.resizerNW.registerOnResizeEnd(this.onResizeEnd.bind(this));this.resizerNW.registerOnResizeStart(this.onResizeStart.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));},handleMouseDown:function(d,c){if(!this.dragBounds||!this.currentShapes.member(c)||!this.toMoveShapes.length){return;}this.dragEnable=true;this.dragIntialized=true;this.edgesMovable=true;var b=this.facade.getCanvas().node.getScreenCTM();this.faktorXY.x=b.a;this.faktorXY.y=b.d;var e=this.dragBounds.upperLeft();this.offSetPosition={x:Event.pointerX(d)-(e.x*this.faktorXY.x),y:Event.pointerY(d)-(e.y*this.faktorXY.y)};var e=this.dragBounds.upperLeft();this.startPosition={x:e.x*this.faktorXY.x,y:e.y*this.faktorXY.y};this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.callbackMouseMove,false);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.callbackMouseUp,true);return;},handleMouseUp:function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"});if(this.dragEnable){if(!this.dragIntialized){this.dragDrop(undefined,undefined,d);var b=this.facade.eventCoordinates(d);if(this.isAttachingAllowed&&this.toMoveShapes.length==1&&this.toMoveShapes[0] instanceof ORYX.Core.Node&&this.toMoveShapes[0].dockers.length>0){var e=this.toMoveShapes[0].dockers[0];var c=ORYX.Core.Command.extend({construct:function(k,f,h,g){this.docker=k;this.newPosition=f;this.newDockedShape=h;this.newParent=h.parent||g.getCanvas();this.oldPosition=k.parent.bounds.center();this.oldDockedShape=k.getDockedShape();this.oldParent=k.parent.parent||g.getCanvas();this.facade=g;if(this.oldDockedShape){this.oldPosition=k.parent.absoluteBounds().center();}},execute:function(){this.dock(this.newDockedShape,this.newParent,this.newPosition);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_ARRANGEMENT_TOP,excludeCommand:true});},rollback:function(){this.dock(this.oldDockedShape,this.oldParent,this.oldPosition);},dock:function(f,g,h){g.add(this.docker.parent);this.docker.setDockedShape(undefined);this.docker.bounds.centerMoveTo(h);this.docker.setDockedShape(f);this.facade.setSelection([this.docker.parent]);this.facade.getCanvas().update();this.facade.updateSelection();}});var a=[new c(e,b,this.containmentParentNode,this.facade)];this.facade.executeCommands(a);}else{if(this.isAddingAllowed||this.isConnectingAllowed){this.refreshSelectedShapes();}}this.facade.updateSelection();this.afterDragDrop();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_END});}if(this.vLine){this.vLine.hide();}if(this.hLine){this.hLine.hide();}this.vLines.concat(this.hLines).each(function(f){f.hide();});}this.dragEnable=false;document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.callbackMouseUp,true);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.callbackMouseMove,false);return;},handleMouseMove:function(b){if(!this.dragEnable){return;}var h=false;var e={x:Event.pointerX(b)-this.offSetPosition.x,y:Event.pointerY(b)-this.offSetPosition.y};e.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;e.y-=this.offsetScroll.y-this.scrollNode.scrollTop;if(this.dragIntialized){if(Math.abs(e.x-this.startPosition.x)<2&&Math.abs(e.y-this.startPosition.y)<2){return;}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_START});this.dragIntialized=false;h=true;this.resizerSE.hide();this.resizerNW.hide();this._onlyEdges=this.currentShapes.all(function(c){return(c instanceof ORYX.Core.Edge);});this.beforeDrag();this._currentUnderlyingNodes=[];}if(b.shiftKey){var d={x:e.x-this.startPosition.x,y:e.y-this.startPosition.y};if(Math.abs(d.y)>Math.abs(d.x)){e.x=this.startPosition.x;}else{e.y=this.startPosition.y;}}var k=b.altKey||b.ctrlKey;if(ORYX.CONFIG.GRID_ENABLED&&!k&&!h){e=this.snapToGrid(e);}else{if(this.vLine){this.vLine.hide();}if(this.hLine){this.hLine.hide();}this.vLines.concat(this.hLines).each(function(c){c.hide();});}e.x/=this.faktorXY.x;e.y/=this.faktorXY.y;e.x=Math.max(0,e.x);e.y=Math.max(0,e.y);var f=this.facade.getCanvas();e.x=Math.min(f.bounds.width()-this.dragBounds.width(),e.x);e.y=Math.min(f.bounds.height()-this.dragBounds.height(),e.y);this.dragBounds.moveTo(e);this.resizeRectangle(this.dragBounds);this.selectedRect.scrollIntoView(b,this.handleMouseMove.bind(this));this.isAttachingAllowed=false;var a={preventHighlights:false};this.dragOver(this.containmentParentNode,b,a);var l=$A(this.facade.getCanvas().getAbstractShapesAtPosition(this.facade.eventCoordinates(b)));var g=this.toMoveShapes.length==1&&this.toMoveShapes[0] instanceof ORYX.Core.Node&&(this.toMoveShapes[0].dockers.length>0||this.toMoveShapes[0].getStencil().idWithoutNs()==="Lane");g=g&&l.length!=1;if(!g&&l.length===this._currentUnderlyingNodes.length&&l.all(function(n,c){return this._currentUnderlyingNodes[c]===n;}.bind(this))){return;}else{if(this._onlyEdges){this.isAddingAllowed=true;this.containmentParentNode=this.facade.getCanvas();}else{var m={event:b,underlyingNodes:l,checkIfAttachable:g};this.checkRules(m);}}this._currentUnderlyingNodes=l.reverse();if(a.preventHighlights){return;}if(this.isAttachingAllowed){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.attached",elements:[this.containmentParentNode],style:ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,color:ORYX.CONFIG.SELECTION_VALID_COLOR});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"});}if(!this.isAttachingAllowed){if(this.isAddingAllowed||this.isConnectingAllowed){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.contain",elements:[this.containmentParentNode],color:ORYX.CONFIG.SELECTION_VALID_COLOR});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.contain",elements:[this.containmentParentNode],color:ORYX.CONFIG.SELECTION_INVALID_COLOR});}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"});}return;},checkRules:function(d){var g=d.event;var c=d.underlyingNodes;var f=d.checkIfAttachable;var b=d.noEdges;if(this.facade.getRules().isContainable(this.toMoveShapes[0])){this.containmentParentNode=c.reverse().find((function(h){return(h instanceof ORYX.Core.Canvas)||(((h instanceof ORYX.Core.Node)||((h instanceof ORYX.Core.Edge)&&!b))&&(!(this.currentShapes.member(h)||this.currentShapes.any(function(k){return(k.children.length>0&&k.getChildNodes(true).member(h));})))&&this.facade.getRules().isContainable(h));}).bind(this));}else{this.containmentParentNode=c.first();}if(!this.containmentParentNode){return;}if(f){this.isAttachingAllowed=this.facade.getRules().canConnect({sourceShape:this.containmentParentNode,edgeShape:this.toMoveShapes[0],targetShape:this.toMoveShapes[0]});if(this.isAttachingAllowed){var a=this.facade.eventCoordinates(g);this.isAttachingAllowed=this.containmentParentNode.isPointOverOffset(a.x,a.y);}}if(!this.isAttachingAllowed){this.isAddingAllowed=this.toMoveShapes.all((function(h){if(h instanceof ORYX.Core.Edge||h instanceof ORYX.Core.Controls.Docker||this.containmentParentNode===h.parent){return true;}else{if(this.containmentParentNode!==h){if(!(this.containmentParentNode instanceof ORYX.Core.Edge)||!b){if(this.facade.getRules().canContain({containingShape:this.containmentParentNode,containedShape:h})){return true;}}}}return false;}).bind(this));}if(!this.isAttachingAllowed&&!this.isAddingAllowed&&this.toMoveShapes.length===1&&(this.containmentParentNode instanceof ORYX.Core.Edge)&&!this.toMoveShapes[0].getAllDockedShapes().include(this.containmentParentNode)&&(![this.containmentParentNode.getTarget(),this.containmentParentNode.getSource()].compact().any(function(h){return h.isParent(this.toMoveShapes[0]);}.bind(this)))){var e=[this.containmentParentNode].concat(d.underlyingNodes).uniq();this.isConnectingAllowed=ORYX.Core.DragZone.prototype.canConnectBetween.call(this,e,this.toMoveShapes[0].getStencil());this.isConnectingAllowedParent=e[1];}else{delete this.isConnectingAllowed;}if(!this.isAttachingAllowed&&!this.isAddingAllowed&&!this.isConnectingAllowed&&(this.containmentParentNode instanceof ORYX.Core.Edge)){d.noEdges=true;d.underlyingNodes.reverse();this.checkRules(d);}},setAllowed:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"});this.isAttachingAllowed=true;},setNotAllowed:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"});this.isAttachingAllowed=false;},getScale:function(){return this.faktorXY;},refreshSelectedShapes:function(){if(!this.dragBounds){return;}var d=this.dragBounds.upperLeft();var b=this.oldDragBounds.upperLeft();var c={x:d.x-b.x,y:d.y-b.y};var a=[new ORYX.Core.Command.Move(this.toMoveShapes,c,this.containmentParentNode,this.currentShapes,this),new ORYX.Core.EnsureChildCommand(this.facade,this.toMoveShapes)];if(this._undockedEdgesCommand instanceof ORYX.Core.Command){a.unshift(this._undockedEdgesCommand);}this.facade.executeCommands(a);if(this.dragBounds){this.oldDragBounds=this.dragBounds.clone();}},onResize:function(a){if(!this.dragBounds){return;}this.dragBounds=a;this.isResizing=true;this.resizeRectangle(this.dragBounds);},onResizeStart:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_RESIZE_START});},onResizeEnd:function(e){if(!(this.currentShapes instanceof Array)||this.currentShapes.length<=0){return;}if(this.isResizing){var a=ORYX.Core.Command.extend({construct:function(h,l,m,k){this.shape=h;this.oldBounds=h.bounds.clone();this.newBounds=l;this.plugin=k;this.direction=m;},execute:function(){this.shape.bounds.set(this.newBounds);this.update(this.getOffset(this.oldBounds,this.newBounds));this.firstExcecution=true;},rollback:function(){this.shape.bounds.set(this.oldBounds);this.update(this.getOffset(this.newBounds,this.oldBounds));},getOffset:function(k,h){return{x:h.a.x-k.a.x,y:h.a.y-k.a.y,xs:h.width()/k.width(),ys:h.height()/k.height()};},update:function(k){this.shape.getLabels().each(function(l){l.changed();});if(this.direction=="northwest"){this.shape.getChildNodes().each(function(l){l.bounds.moveBy(-k.x,-k.y);});}if(!this.firstExcecution){var h=[].concat(this.shape.getIncomingShapes()).concat(this.shape.getOutgoingShapes()).findAll(function(l){return l instanceof ORYX.Core.Edge;}.bind(this));this.plugin.layoutEdges(this.shape,h,k);}this.plugin.facade.setSelection([this.shape]);this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();}});var d=this.dragBounds.clone();var b=this.currentShapes[0];if(b.parent){var g=b.parent.absoluteXY();d.moveBy(-g.x,-g.y);}var f=new a(b,d,e,this);var c=new ORYX.Core.EnsureChildCommand(this.facade,b,true);this.facade.executeCommands([f,c]);this.isResizing=false;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_RESIZE_END});}},beforeDrag:function(){var a=ORYX.Core.Command.extend({construct:function(b){this.dockers=b.collect(function(c){return c instanceof ORYX.Core.Controls.Docker?{docker:c,dockedShape:c.getDockedShape(),refPoint:c.referencePoint}:undefined;}).compact();},execute:function(){this.dockers.each(function(b){b.docker.setDockedShape(undefined);});},rollback:function(){this.dockers.each(function(b){b.docker.setDockedShape(b.dockedShape);b.docker.setReferencePoint(b.refPoint);});}});this._undockedEdgesCommand=new a(this.toMoveShapes);this._undockedEdgesCommand.execute();},hideAllLabels:function(a){a.getLabels().each(function(b){b.hide();});a.getAllDockedShapes().each(function(b){var c=b.getLabels();if(c.length>0){c.each(function(d){d.hide();});}});a.getChildren().each((function(b){if(b instanceof ORYX.Core.Shape){this.hideAllLabels(b);}}).bind(this));},beforeDrag:function(){(this.beforeDragStack||[]).each(function(a,b){b.apply(this,(a||[]));}.bind(this,arguments));},dragOver:function(){(this.dragOverStack||[]).each(function(a,b){b.apply(this,(a||[]));}.bind(this,arguments));},dragDrop:function(){(this.dragDropStack||[]).each(function(a,b){b.apply(this,(a||[]));}.bind(this,arguments));},afterDragDrop:function(){(this.afterDragDropStack||[]).each(function(a,b){b.apply(this,(a||[]));}.bind(this,arguments));},showAllLabels:function(a){for(var d=0;d<a.length;d++){var b=a[d];b.show();}var f=a.getAllDockedShapes();for(var d=0;d<f.length;d++){var c=f[d];var g=c.getLabels();if(g.length>0){g.each(function(h){h.show();});}}for(var d=0;d<a.children.length;d++){var e=a.children[d];if(e instanceof ORYX.Core.Shape){this.showAllLabels(e);}}},registryChanged:function(a){this.pluginsData=(a||[]).findAll(function(b){return b&&b.target&&b.target===ORYX.Plugins.DragDropResize;});if(this.pluginsData.length>0){this.pluginsData.each(function(b){if(b.beforeDragClb instanceof Function){if(!this.beforeDragStack){this.beforeDragStack=[];}this.beforeDragStack.push(b.beforeDragClb);}if(b.dragOverClb instanceof Function){if(!this.dragOverStack){this.dragOverStack=[];}this.dragOverStack.push(b.dragOverClb);}if(b.dragDropClb instanceof Function){if(!this.dragDropStack){this.dragDropStack=[];}this.dragDropStack.push(b.dragDropClb);}if(b.afterDragDropClb instanceof Function){if(!this.afterDragDropStack){this.afterDragDropStack=[];}this.afterDragDropStack.push(b.afterDragDropClb);}}.bind(this));}},onSelectionChanged:function(b){var d=b.elements;this.dragEnable=false;this.dragIntialized=false;this.resizerSE.hide();this.resizerNW.hide();if(!d||d.length==0){this.selectedRect.hide();this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined;this.oldDragBounds=undefined;}else{this.currentShapes=d;var e=this.facade.getCanvas().getShapesWithSharedParent(d);this.toMoveShapes=e;this.toMoveShapes=this.toMoveShapes.findAll(function(f){return f instanceof ORYX.Core.Node&&(f.dockers.length===0||!d.member(f.dockers.first().getDockedShape()));});d.each((function(f){if(!(f instanceof ORYX.Core.Edge)){return;}var h=f.getDockers();var k=d.member(h.first().getDockedShape());var g=d.member(h.last().getDockedShape());if(!k&&!g){var l=!h.first().getDockedShape()&&!h.last().getDockedShape();if(l){this.toMoveShapes=this.toMoveShapes.concat(h);}}if(f.dockers.length>2&&k&&g){}}).bind(this));var c=undefined;this.toMoveShapes.each(function(g){var f=g;if(g instanceof ORYX.Core.Controls.Docker){f=g.parent;}if(!c){c=f.absoluteBounds();}else{c.include(f.absoluteBounds());}}.bind(this));if(!c){d.each(function(f){if(!c){c=f.absoluteBounds();}else{c.include(f.absoluteBounds());}});}this.dragBounds=c;this.oldDragBounds=c.clone();this.resizeRectangle(c);this.selectedRect.show();if(d.length==1&&d[0].isResizable){var a=d[0].getStencil().fixedAspectRatio()?d[0].bounds.width()/d[0].bounds.height():undefined;this.resizerSE.setBounds(this.dragBounds,d[0].minimumSize,d[0].maximumSize,a,d[0]);this.resizerSE.show();this.resizerNW.setBounds(this.dragBounds,d[0].minimumSize,d[0].maximumSize,a,d[0]);this.resizerNW.show();}else{this.resizerSE.setBounds(undefined);this.resizerNW.setBounds(undefined);}if(ORYX.CONFIG.GRID_ENABLED){this.snap.setReferenceShapes();if(this.distPointTimeout){window.clearTimeout(this.distPointTimeout);}this.distPointTimeout=window.setTimeout(function(){var f=this.facade.getCanvas().getChildShapes(true).findAll(function(h){var g=h.parent;while(g){if(d.member(g)){return false;}g=g.parent;}return true;});this.snap.setReferenceShapes(f);}.bind(this),10);}}},snapToGrid:function(y){var e=16;this.vLines.concat(this.hLines).each(function(z){z.hide();});var b={width:this.facade.getCanvas().bounds.width(),height:this.facade.getCanvas().bounds.height()};var h=[];var x,u,v,t;var o=[];var s=[];var g=[];var l=[];this.toMoveShapes.each((function(B){var A=B;if(B instanceof ORYX.Core.Controls.Docker){A=B.parent;}var z=A.absoluteBounds();if(x!=undefined&&z.upperLeft().x<x){o=[];}x=(x==undefined)?z.upperLeft().x:((z.upperLeft().x<x)?z.upperLeft().x:x);if(x==z.upperLeft().x){o.push(z);}if(u!=undefined&&z.upperLeft().y<u){g=[];}u=(u==undefined)?z.upperLeft().y:((z.upperLeft().y<u)?z.upperLeft().y:u);if(u==z.upperLeft().y){g.push(z);}if(v!=undefined&&z.lowerRight().x>v){s=[];}v=(v==undefined)?z.lowerRight().x:((z.lowerRight().x>v)?z.lowerRight().x:v);if(v==z.lowerRight().x){s.push(z);}if(t!=undefined&&z.lowerRight().y>t){l=[];}t=(t==undefined)?z.lowerRight().y:((z.lowerRight().y>t)?z.lowerRight().y:t);if(t==z.lowerRight().y){l.push(z);}}).bind(this));h=o.concat(g,s,l).uniq();var k,f;var d=[];var a=[];var c={};this.snap.setScale(this.vLine?this.vLine.getScale():1);h.each((function(E){var z={x:(E.upperLeft().x*this.faktorXY.x)+y.x-this.startPosition.x,y:(E.upperLeft().y*this.faktorXY.y)+y.y-this.startPosition.y};var B,A;this.snap.setReferenceBounds(E);var H=this.snap.adjustPoint(z,function(I){A=I;},function(I){B=I;});if(B){var D=Math.abs(z.x-H.x);var G=H.x-(E.upperLeft().x*this.faktorXY.x)+this.startPosition.x;if((k==undefined||D<k)&&(G>=0&&(G+(this.dragBounds.width()*this.faktorXY.x))<=(b.width*this.faktorXY.x))){d=[];c.x=G;k=D;}if(c.x==G){d.push(B);}}if(A){var C=Math.abs(z.y-H.y);var F=H.y-(E.upperLeft().y*this.faktorXY.y)+this.startPosition.y;if((f==undefined||C<f)&&(F>=0&&(F+(this.dragBounds.height()*this.faktorXY.y))<=(b.height*this.faktorXY.y))){a=[];c.y=F;f=C;}if(c.y==F){a.push(A);}}}).bind(this));if(k==undefined){var r=(y.x-(y.x%(ORYX.CONFIG.GRID_DISTANCE/2)));c.x=r;}if(f==undefined){var q=(y.y-(y.y%(ORYX.CONFIG.GRID_DISTANCE/2)));c.y=q;}var n=Math.abs(this.startPosition.x-y.x);var m=Math.abs(this.startPosition.y-y.y);if((k!=undefined&&n<k)||(k==undefined&&n<e)){c.x=this.startPosition.x;d=[];}if((f!=undefined&&m<f)||(f==undefined&&m<e)){c.y=this.startPosition.y;a=[];}var p=0;d.each((function(z){if(this.vLines.length>p){var A=this.vLines[p];}else{var A=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_VERTICAL);this.vLines.push(A);}A.update(z);p++;}).bind(this));p=0;a.each((function(A){if(this.hLines.length>p){var z=this.hLines[p];}else{var z=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_HORIZONTAL);this.hLines.push(z);}z.update(A);p++;}).bind(this));return c;},showGridLine:function(){},resizeRectangle:function(a){this.selectedRect.resize(a);}});ORYX.Plugins.Resizer=Clazz.extend({construct:function(d,b,c,a){this.parentId=d;this.orientation=b;this.facade=c;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(this.parentId),["div",{"class":"resizer_"+this.orientation,style:"left:0px; top:0px;"}]);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this),true);this.handleMouseUpClb=this.handleMouseUp.bind(this);this.handleMouseMoveClb=this.handleMouseMove.bind(this);this.dragEnable=false;this.offSetPosition={x:0,y:0};this.offsetScroll={x:0,y:0};this.mousePosition={x:0,y:0};this.bounds=undefined;this.startBounds=undefined;this.canvasNode=this.facade.getCanvas().node;this.minSize=undefined;this.maxSize=undefined;this.aspectRatio=undefined;this.widing=false;this.resizeCallbacks=[];this.resizeStartCallbacks=[];this.resizeEndCallbacks=[];this.hide();this.snap=a;this.wGuides=new Hash();this.hGuides=new Hash();this.selectionWGuide=new ORYX.Core.SizeGuide(this.facade.getCanvas().getSvgContainer(),ORYX.Core.SizeGuide.DIR_HORIZONTAL);this.selectionHGuide=new ORYX.Core.SizeGuide(this.facade.getCanvas().getSvgContainer(),ORYX.Core.SizeGuide.DIR_VERTICAL);this.vLine=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_VERTICAL);this.hLine=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_HORIZONTAL);this.facade.registerOnEvent("key.event.down.shift.16",this.shiftDown.bind(this));this.facade.registerOnEvent("key.event.up.16",this.shiftUp.bind(this));this.facade.registerOnEvent("key.event.down.metactrl.17",this.ctrlDown.bind(this));this.facade.registerOnEvent("key.event.up.17",this.ctrlUp.bind(this));this.scrollNode=this.node.parentNode.parentNode.parentNode;},handleMouseDown:function(a){this.dragEnable=true;document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.handleMouseUpClb,true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.handleMouseMoveClb,false);this.startBounds=this.bounds.clone();this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};this.faktorXY=this.getFactorXY();this.mousePosition={x:Event.pointerX(a),y:Event.pointerY(a)};this.offSetPosition={x:this.mousePosition.x-this.position.x,y:this.mousePosition.y-this.position.y};this.resizeStartCallbacks.each((function(b){b(this.bounds);}).bind(this));this.isResizing=true;},getFactorXY:function(){var b=this.facade.getCanvas().node.getScreenCTM();return{x:b.a,y:b.d};},handleMouseUp:function(a){document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.handleMouseUpClb,true);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.handleMouseMoveClb,false);this.dragEnable=false;this.containmentParentNode=null;this.resizeEndCallbacks.each((function(b){b(this.orientation,this.bounds,this.widing);}).bind(this));this.wGuides.values().each(function(b){b.hide();b.needsUpdate=true;});this.hGuides.values().each(function(b){b.hide();b.needsUpdate=true;});this.vLine.hide();this.hLine.hide();this.selectionWGuide.hide();this.selectionHGuide.hide();this.isResizing=false;},handleMouseMove:function(b,d){if(!this.dragEnable){return;}if(!this.modifierKeyPressed&&b.altKey){this.wGuides.values().each(function(e){e.hide();e.needsUpdate=true;});this.hGuides.values().each(function(e){e.hide();e.needsUpdate=true;});this.vLine.hide();this.hLine.hide();this.selectionWGuide.hide();this.selectionHGuide.hide();}this.modifierKeyPressed=b.altKey;this.mousePosition={x:Event.pointerX(b),y:Event.pointerY(b)};if(b.shiftKey){this.aspectRatio=this.startBounds.width()/this.startBounds.height();}else{this.aspectRatio=undefined;}if(!!b.ctrlKey!==this.widing){this["ctrl"+(!!b.ctrlKey?"Down":"Up")]();}var a={x:this.mousePosition.x-this.offSetPosition.x,y:this.mousePosition.y-this.offSetPosition.y};var c=this.faktorXY||this.getFactorXY();a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;a.x=Math.min(a.x,this.facade.getCanvas().bounds.width()*c.x);a.y=Math.min(a.y,this.facade.getCanvas().bounds.height()*c.y);a.x/=c.x;a.y/=c.y;this.doResize(a);Event.stop(b);},doResize:function(a){if(!this.dragEnable){return;}var c={x:a.x-(this.position.x/this.faktorXY.x),y:a.y-(this.position.y/this.faktorXY.y)};if(this.widing){c.x=c.x*2;c.y=c.y*2;}if(this.orientation==="northwest"){c.x=-c.x;c.y=-c.y;}if(this.aspectRatio){c.x=this.aspectRatio*(this.bounds.height()+c.y)-this.bounds.width();}if(this.bounds.width()+c.x>this.maxSize.width){c.x=this.maxSize.width-this.bounds.width();if(this.aspectRatio){c.y=c.x/this.aspectRatio;}}if(this.bounds.width()+c.x<this.minSize.width){c.x=this.minSize.width-this.bounds.width();if(this.aspectRatio){c.y=c.x/this.aspectRatio;}}if(this.bounds.height()+c.y>this.maxSize.height){c.y=this.maxSize.height-this.bounds.height();if(this.aspectRatio){c.x=this.aspectRatio*c.y;}}if(this.bounds.height()+c.y<this.minSize.height){c.y=this.minSize.height-this.bounds.height();if(this.aspectRatio){c.x=this.aspectRatio*c.y;}}var b=this.bounds.clone();b.extend({x:c.x,y:c.y});if(this.widing){b.moveBy({x:-(c.x/2),y:-(c.y/2)});}else{if(this.orientation==="northwest"){b.moveBy({x:-(c.x),y:-(c.y)});}}if(ORYX.CONFIG.GRID_ENABLED&&!this.modifierKeyPressed){b=this.snapToGrid(b);}c={x:0,y:0};if(b.width()>this.maxSize.width){c.x=this.maxSize.width-b.width();if(this.aspectRatio){c.y=c.x/this.aspectRatio;}}if(b.width()<this.minSize.width){c.x=this.minSize.width-b.width();if(this.aspectRatio){c.y=c.x/this.aspectRatio;}}if(b.height()>this.maxSize.height){c.y=this.maxSize.height-b.height();if(this.aspectRatio){c.x=this.aspectRatio*c.y;}}if(b.height()<this.minSize.height){c.y=this.minSize.height-b.height();if(this.aspectRatio){c.x=this.aspectRatio*c.y;}}b.extend({x:c.x,y:c.y});if(this.widing){b.moveBy({x:-(c.x/2),y:-(c.y/2)});}else{if(this.orientation==="northwest"){b.moveBy({x:-(c.x),y:-(c.y)});}}this.bounds.set(b.upperLeft(),b.lowerRight());this.update();this.resizeCallbacks.each((function(d){d(this.bounds);}).bind(this));},snapToGrid:function(b){if(b.width()<this.minSize.width){b.extend({x:this.minSize.width-b.width(),y:0});}if(b.width()>this.maxSize.width){b.extend({x:this.maxSize.width-b.width(),y:0});}if(b.height()<this.minSize.height){b.extend({x:0,y:this.minSize.height-b.height()});}if(b.height()>this.maxSize.height){b.extend({x:0,y:this.maxSize.height-b.height()});}this.wGuides.values().each(function(d){d.hide();});this.hGuides.values().each(function(d){d.hide();});this.selectionWGuide.hide();this.selectionHGuide.hide();this.vLine.hide();this.hLine.hide();var c=function(f,e,d){if(f.width()<this.minSize.width||f.width()>this.maxSize.width){return;}if(f.upperLeft().x==this.startBounds.upperLeft().x&&f.lowerRight().x==this.startBounds.lowerRight().x){return;}if(ORYX.CONFIG.SHOW_SIZEGUIDES&&e){e.each(function(h){if(h==this.shape){return;}var g=this.wGuides[h];if(!g){g=this.wGuides[h]=new ORYX.Core.SizeGuide(this.facade.getCanvas().getSvgContainer(),ORYX.Core.SizeGuide.DIR_HORIZONTAL);g.update(h.absoluteBounds());}else{if(g.needsUpdate){g.update(h.absoluteBounds());delete g.needsUpdate;}else{g.show();}}}.bind(this));if(e.size()>1||e[0]!=this.shape){this.selectionWGuide.update(f);}}if(ORYX.CONFIG.SHOW_GRIDLINE&&d){this.vLine.update(d);}}.bind(this);var a=function(e,d,f){if(e.height()<this.minSize.height||e.height()>this.maxSize.height){return;}if(e.upperLeft().y==this.startBounds.upperLeft().y&&e.lowerRight().y==this.startBounds.lowerRight().y){return;}if(ORYX.CONFIG.SHOW_SIZEGUIDES&&d){d.each(function(g){if(g==this.shape){return;}var h=this.hGuides[g];if(!h){h=this.hGuides[g]=new ORYX.Core.SizeGuide(this.facade.getCanvas().getSvgContainer(),ORYX.Core.SizeGuide.DIR_VERTICAL);h.update(g.absoluteBounds());}else{if(h.needsUpdate){h.update(g.absoluteBounds());delete h.needsUpdate;}else{h.show();}}}.bind(this));if(d.size()>1||d[0]!=this.shape){this.selectionHGuide.update(e);}}if(ORYX.CONFIG.SHOW_GRIDLINE&&f){this.hLine.update(f);}}.bind(this);return this.snap.adjustBounds(b,this.orientation,this.aspectRatio,c,a,this.startBounds,this.widing);},shiftDown:function(){if(!this.startBounds){return;}this.aspectRatio=this.startBounds.width()/this.startBounds.height();var a=this.faktorXY||this.getFactorXY();this.doResize({x:this.position.x/a.x,y:this.position.y/a.y});},shiftUp:function(){this.aspectRatio=undefined;var a={x:this.mousePosition.x-this.offSetPosition.x,y:this.mousePosition.y-this.offSetPosition.y};var b=this.faktorXY||this.getFactorXY();a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;a.x=Math.min(a.x,this.facade.getCanvas().bounds.width()*b.x);a.y=Math.min(a.y,this.facade.getCanvas().bounds.height()*b.y);a.x/=b.x;a.y/=b.y;this.doResize(a,false);},ctrlDown:function(){if(this.widing){return;}this.widing=true;if(!this.bounds||!this.startBounds||!this.isResizing){return;}var c={x:this.bounds.width()-this.startBounds.width(),y:this.bounds.height()-this.startBounds.height()};this.bounds.extend(c);this.bounds.centerMoveTo(this.startBounds.center());var a={x:this.mousePosition.x-this.offSetPosition.x,y:this.mousePosition.y-this.offSetPosition.y};var b=this.faktorXY||this.getFactorXY();a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;a.x=Math.min(a.x,this.facade.getCanvas().bounds.width()*b.x);a.y=Math.min(a.y,this.facade.getCanvas().bounds.height()*b.y);a.x/=b.x;a.y/=b.y;this.doResize(a);},ctrlUp:function(){this.widing=false;if(!this.bounds||!this.startBounds||!this.isResizing){return;}if(this.orientation==="northwest"){this.bounds.set(this.bounds.upperLeft(),this.startBounds.lowerRight());}else{this.bounds.set(this.startBounds.upperLeft(),this.bounds.lowerRight());}this.update();var a={x:this.mousePosition.x-this.offSetPosition.x,y:this.mousePosition.y-this.offSetPosition.y};var b=this.faktorXY||this.getFactorXY();a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;a.x=Math.min(a.x,this.facade.getCanvas().bounds.width()*b.x);a.y=Math.min(a.y,this.facade.getCanvas().bounds.height()*b.y);a.x/=b.x;a.y/=b.y;this.doResize(a);},setSnapShapes:function(a){this.snap.setReferenceShapes(a);},registerOnResizeStart:function(a){if(!this.resizeStartCallbacks.member(a)){this.resizeStartCallbacks.push(a);}},unregisterOnResizeStart:function(a){if(this.resizeStartCallbacks.member(a)){this.resizeStartCallbacks=this.resizeStartCallbacks.without(a);}},registerOnResizeEnd:function(a){if(!this.resizeEndCallbacks.member(a)){this.resizeEndCallbacks.push(a);}},unregisterOnResizeEnd:function(a){if(this.resizeEndCallbacks.member(a)){this.resizeEndCallbacks=this.resizeEndCallbacks.without(a);}},registerOnResize:function(a){if(!this.resizeCallbacks.member(a)){this.resizeCallbacks.push(a);}},unregisterOnResize:function(a){if(this.resizeCallbacks.member(a)){this.resizeCallbacks=this.resizeCallbacks.without(a);}},hide:function(){this.node.style.display="none";},show:function(){if(this.bounds){this.node.style.display="";}},setBounds:function(e,c,a,d,b){this.bounds=e;if(this.bounds){this.startBounds=this.bounds.clone();}else{this.startBounds=undefined;}if(!c){c={width:ORYX.CONFIG.MINIMUM_SIZE,height:ORYX.CONFIG.MINIMUM_SIZE};}if(!a){a={width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE};}this.minSize=c;this.maxSize=a;this.aspectRatio=d;this.shape=b;this.update();},update:function(){if(!this.bounds){return;}var c=this.bounds.upperLeft();if(this.bounds.width()<this.minSize.width){this.bounds.set(c.x,c.y,c.x+this.minSize.width,c.y+this.bounds.height());}if(this.bounds.height()<this.minSize.height){this.bounds.set(c.x,c.y,c.x+this.bounds.width(),c.y+this.minSize.height);}if(this.bounds.width()>this.maxSize.width){this.bounds.set(c.x,c.y,c.x+this.maxSize.width,c.y+this.bounds.height());}if(this.bounds.height()>this.maxSize.height){this.bounds.set(c.x,c.y,c.x+this.bounds.width(),c.y+this.maxSize.height);}var b=this.canvasNode.getScreenCTM();c.x*=b.a;c.y*=b.d;if(this.orientation==="northwest"){c.x-=12;c.y-=26;}else{c.x+=(b.a*this.bounds.width())+0;c.y+=(b.d*this.bounds.height())-2;}this.position=c;this.node.style.left=this.position.x+"px";this.node.style.top=this.position.y+"px";}});ORYX.Core.Command.Move=ORYX.Core.Command.extend({construct:function(b,e,c,a,d){this.moveShapes=b;this.selectedShapes=a;this.offset=e;this.plugin=d;this.parent=c;this.newParents=b.collect(function(f){if(d.isConnectingAllowed){return d.isConnectingAllowedParent||f.parent;}else{return c||f.parent;}});this.oldParents=b.collect(function(f){return f.parent;});this.dockedNodes=b.findAll(function(f){return f instanceof ORYX.Core.Node&&f.dockers.length==1;}).collect(function(f){return{docker:f.dockers[0],dockedShape:f.dockers[0].getDockedShape(),refPoint:f.dockers[0].referencePoint};});},execute:function(){this.dockAllShapes();this.move(this.offset);this.addShapeToParent(this.newParents);if(this.plugin.isConnectingAllowed){this.connectTogether();}this.selectCurrentShapes();this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();this.firstExecution=true;},rollback:function(){var a={x:-this.offset.x,y:-this.offset.y};this.move(a);this.addShapeToParent(this.oldParents);this.dockAllShapes(true);this.rollbackConnectTogether();this.selectCurrentShapes();this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();},rollbackConnectTogether:function(){if(this.edge){this.removeAllDocker(this.parent);this.dockerPosition.each(function(c,a){if(a==0||a==this.dockerPosition.length-1){return;}var b=this.parent.createDocker(undefined,c);b.bounds.centerMoveTo(c);}.bind(this));this.parent.getDockers().last().setDockedShape(this.edge.getTarget());this.parent.getDockers().last().setReferencePoint(this.edge.dockers.last().referencePoint);this.plugin.facade.deleteShape(this.edge);}},connectTogether:function(){var c=this.moveShapes[0];var d=this.parent;var g=d.getSource();var h=d.getTarget();var a;if(this.edge){a=this.edge;this.plugin.facade.getCanvas().add(this.edge);}else{a=this.plugin.facade.createShape({namespace:d.getStencil().namespace(),type:d.getStencil().id()});}var b=false;d.getDockers().each(function(o){var n=o.getAbsoluteReferencePoint()||o.bounds.center();if(c.bounds.isIncluded(n)){b=true;throw $break;}}.bind(this));var k={x:c.bounds.width()/2,y:c.bounds.height()/2};var l=d.getDockers().last().referencePoint;var e=d.findSegment(c.absoluteCenterXY());var m=d.dockers.slice(d.dockers.indexOf(e.toDocker),d.dockers.length-1);d.getDockers().last().setDockedShape(c);d.getDockers().last().setReferencePoint(k);a.getDockers().first().setDockedShape(c);a.getDockers().first().setReferencePoint(k);a.getDockers().last().setDockedShape(h);a.getDockers().last().setReferencePoint(l);this.dockerPosition=d.getDockers().map(function(n){return n.bounds.center();});var f=0;m.each(function(n){d.removeDocker(n);if(!b&&!this.edge){a.createDocker(1+f,n.bounds.center());}f++;}.bind(this));if(b){this.plugin.doLayout(d);this.plugin.doLayout(a);}this.edge=a;},removeAllDocker:function(a){a.dockers.slice(1,a.dockers.length-1).each(function(b){a.removeDocker(b);});},move:function(d,a){for(var g=0;g<this.moveShapes.length;g++){var l=this.moveShapes[g];l.bounds.moveBy(d);if(l instanceof ORYX.Core.Node){(l.dockers||[]).each(function(k){k.bounds.moveBy(d);});if(!this.firstExecution){var e=[].concat(l.getIncomingShapes()).concat(l.getOutgoingShapes()).findAll(function(k){return k instanceof ORYX.Core.Edge&&!this.moveShapes.any(function(m){return m==k||(m instanceof ORYX.Core.Controls.Docker&&m.parent==k);});}.bind(this)).findAll(function(k){return(k.dockers.first().getDockedShape()==l||!this.moveShapes.include(k.dockers.first().getDockedShape()))&&(k.dockers.last().getDockedShape()==l||!this.moveShapes.include(k.dockers.last().getDockedShape()));}.bind(this));this.plugin.layoutEdges(l,e,d);}var h=[].concat(l.getIncomingShapes()).concat(l.getOutgoingShapes()).uniq().findAll(function(k){return k instanceof ORYX.Core.Edge&&k.dockers.first().isDocked()&&k.dockers.last().isDocked()&&!this.moveShapes.include(k)&&!this.moveShapes.any(function(m){return m==k||(m instanceof ORYX.Core.Controls.Docker&&m.parent==k);});}.bind(this)).findAll(function(k){return this.moveShapes.indexOf(k.dockers.first().getDockedShape())>g||this.moveShapes.indexOf(k.dockers.last().getDockedShape())>g;}.bind(this));for(var f=0;f<h.length;f++){for(var b=1;b<h[f].dockers.length-1;b++){var c=h[f].dockers[b];if(!c.getDockedShape()&&!this.moveShapes.include(c)&&!this.moveShapes.include(c.parent)){c.bounds.moveBy(d);}}}}}},dockAllShapes:function(a){for(var b=0;b<this.dockedNodes.length;b++){var c=this.dockedNodes[b].docker;c.setDockedShape(a?this.dockedNodes[b].dockedShape:undefined);if(c.getDockedShape()){c.setReferencePoint(this.dockedNodes[b].refPoint);}}},addShapeToParent:function(e){for(var f=0;f<this.moveShapes.length;f++){var d=this.moveShapes[f];if(d instanceof ORYX.Core.Node&&d.parent!==e[f]){var g=e[f].absoluteXY();var h=d.absoluteXY();var c=h.x-g.x;var k=h.y-g.y;e[f].add(d);d.getOutgoingShapes((function(b){if(b instanceof ORYX.Core.Node&&!this.moveShapes.member(b)){e[f].add(b);}}).bind(this));if(d instanceof ORYX.Core.Node&&d.dockers.length==1){var a=d.bounds;c+=a.width()/2;k+=a.height()/2;d.dockers.first().bounds.centerMoveTo(c,k);}else{d.bounds.moveTo(c,k);}}}},selectCurrentShapes:function(){this.plugin.facade.setSelection(this.selectedShapes);}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.ShapeHighlighting=Clazz.extend({construct:function(a){this.parentNode=a.getCanvas().getSvgContainer();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parentNode,["g"]);this.highlightNodes={};a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,this.setHighlight.bind(this));a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,this.hideHighlight.bind(this));},setHighlight:function(a){if(a&&a.highlightId){var b=this.highlightNodes[a.highlightId];if(!b){b=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"stroke-width":2,"fill":"none"}]);this.highlightNodes[a.highlightId]=b;}if(a.elements&&a.elements.length>0){this.setAttributesByStyle(b,a);this.show(b);}else{this.hide(b);}}},hideHighlight:function(a){if(a&&a.highlightId&&this.highlightNodes[a.highlightId]){this.hide(this.highlightNodes[a.highlightId]);}},hide:function(a){a.setAttributeNS(null,"display","none");},show:function(a){a.setAttributeNS(null,"display","");},setAttributesByStyle:function(b,a){if(a.style&&a.style==ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE){var d=a.elements[0].absoluteBounds();var c=a.strokewidth?a.strokewidth:ORYX.CONFIG.BORDER_OFFSET;b.setAttributeNS(null,"d",this.getPathRectangle(d.a,d.b,c));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);b.setAttributeNS(null,"stroke-width",c);}else{if(a.elements.length==1&&a.elements[0] instanceof ORYX.Core.Edge&&a.highlightId!="selection"){b.setAttributeNS(null,"d",this.getPathEdge(a.elements[0].dockers));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);b.setAttributeNS(null,"stroke-width",ORYX.CONFIG.OFFSET_EDGE_BOUNDS);}else{b.setAttributeNS(null,"d",this.getPathByElements(a.elements));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:1);b.setAttributeNS(null,"stroke-width",a.strokewidth?a.strokewidth:2);}}},getPathByElements:function(a){if(!a||a.length<=0){return undefined;}var c=ORYX.CONFIG.SELECTED_AREA_PADDING;var b="";a.each((function(f){if(!f){return;}var g=f.absoluteBounds();g.widen(c);var e=g.upperLeft();var d=g.lowerRight();b=b+this.getPath(e,d);}).bind(this));return b;},getPath:function(d,c){return this.getPathCorners(d,c);},getPathCorners:function(d,c){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";f=f+"M"+d.x+" "+(d.y+e)+" l0 -"+e+" l"+e+" 0 ";f=f+"M"+d.x+" "+(c.y-e)+" l0 "+e+" l"+e+" 0 ";f=f+"M"+c.x+" "+(c.y-e)+" l0 "+e+" l-"+e+" 0 ";f=f+"M"+c.x+" "+(d.y+e)+" l0 -"+e+" l-"+e+" 0 ";return f;},getPathRectangle:function(d,c,h){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";var g=h/2;f=f+"M"+(d.x+g)+" "+(d.y);f=f+" L"+(d.x+g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(d.y+g);f=f+" L"+(d.x+g)+" "+(d.y+g);return f;},getPathEdge:function(a){var b=a.length;var c="M"+a[0].bounds.center().x+" "+a[0].bounds.center().y;for(i=1;i<b;i++){var d=a[i].bounds.center();c=c+" L"+d.x+" "+d.y;}return c;}});ORYX.Plugins.HighlightingSelectedShapes=Clazz.extend({construct:function(a){this.facade=a;this.opacityFull=0.9;this.opacityLow=0.4;},onSelectionChanged:function(a){if(a.elements&&a.elements.length>1){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"selection",elements:a.elements.without(a.subSelection),color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:!a.subSelection?this.opacityFull:this.opacityLow});if(a.subSelection){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"subselection",elements:[a.subSelection],color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:this.opacityFull});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"});}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"selection"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"});}}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.DragDocker=Clazz.extend({construct:function(a){this.facade=a;this.VALIDCOLOR=ORYX.CONFIG.SELECTION_VALID_COLOR;this.INVALIDCOLOR=ORYX.CONFIG.SELECTION_INVALID_COLOR;this.shapeSelection=undefined;this.docker=undefined;this.dockerParent=undefined;this.dockerSource=undefined;this.dockerTarget=undefined;this.lastUIObj=undefined;this.isStartDocker=undefined;this.isEndDocker=undefined;this.undockTreshold=10;this.initialDockerPosition=undefined;this.outerDockerNotMoved=undefined;this.isValid=false;this.scrollRect=new ORYX.Core.SelectedRect(this.facade.getCanvas().getSvgContainer(),{});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DOCKERDRAG,this.handleDockerDrag.bind(this));if(!Ext.isIPad){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOVER,this.handleMouseOver.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOUT,this.handleMouseOut.bind(this));}this.selectedDockers=[];},onSelectionChanged:function(a){if(this.docker){return;}var b=this.facade.getSelection().map(function(c){return c instanceof ORYX.Core.Edge?c.dockers:[];}).flatten();this.selectedDockers.invoke("preventHiding",false);b.invoke("preventHiding",true);b.invoke("show");this.selectedDockers.invoke("hide");this.selectedDockers=b;},handleMouseOut:function(b,a){if(!this.docker&&a instanceof ORYX.Core.Controls.Docker){a.hide();}else{if(!this.docker&&a instanceof ORYX.Core.Edge){a.dockers.invoke("hide");}}},handleMouseOver:function(b,a){if(!this.docker&&a instanceof ORYX.Core.Controls.Docker){a.show();}else{if(!this.docker&&a instanceof ORYX.Core.Edge){a.dockers.each(function(c){c.show();});}}},handleDockerDrag:function(b,a){this.handleMouseDown(b.uiEvent,a);},handleMouseDown:function(d,c){if(c instanceof ORYX.Core.Controls.Docker&&c.isMovable){this.shapeSelection=this.facade.getSelection();this.facade.setSelection(this.shapeSelection.without(c.parent));this.docker=c;this.initialDockerPosition=this.docker.bounds.center();this.outerDockerNotMoved=false;this.dockerParent=c.parent;this._commandArg={docker:c,dockedShape:c.getDockedShape(),refPoint:c.referencePoint||c.bounds.center()};this.docker.show();if(c.parent instanceof ORYX.Core.Edge&&(c.parent.dockers.first()==c||c.parent.dockers.last()==c)){if(c.parent.dockers.first()==c&&c.parent.dockers.last().getDockedShape()){this.dockerTarget=c.parent.dockers.last().getDockedShape();}else{if(c.parent.dockers.last()==c&&c.parent.dockers.first().getDockedShape()){this.dockerSource=c.parent.dockers.first().getDockedShape();}}}else{this.dockerSource=undefined;this.dockerTarget=undefined;}this.isStartDocker=this.docker.parent.dockers.first()===this.docker;this.isEndDocker=this.docker.parent.dockers.last()===this.docker;this.facade.getCanvas().add(this.docker.parent);this.docker.parent.getLabels().each(function(e){e.hide();});if((!this.isStartDocker&&!this.isEndDocker)||!this.docker.isDocked()){this.docker.setDockedShape(undefined);var b=this.facade.eventCoordinates(d);this.docker.bounds.centerMoveTo(b);this.dockerParent._update();}else{this.outerDockerNotMoved=true;}var a={movedCallback:this.dockerMoved.bind(this,this.facade.getCanvas()),upCallback:this.dockerMovedFinished.bind(this)};ORYX.Core.UIEnableDrag(d,c,a);}},dockerMoved:function(f,D){this.outerDockerNotMoved=false;var p=undefined;if(!this.docker){return;}if(this.docker.parent){if(this.isStartDocker||this.isEndDocker){var u=this.facade.eventCoordinates(D);if(this.docker.isDocked()){var c=ORYX.Core.Math.getDistancePointToPoint(u,this.initialDockerPosition);if(c<this.undockTreshold){this.outerDockerNotMoved=true;return;}this.docker.setDockedShape(undefined);this.dockerParent._update();}var B=this.facade.getCanvas().getAbstractShapesAtPosition(u),s=this.facade.getRules();var A=B.pop();if(this.docker.parent===A){A=B.pop();}while(B.length>0&&(!s.isContainable(A)||(this.dockerSource!==A&&this.dockerSource&&this.dockerSource.isParent(A))||(this.dockerTarget!==A&&this.dockerTarget&&this.dockerTarget.isParent(A)))){A=B.pop();}if(this.lastUIObj==A){}else{if(A instanceof ORYX.Core.Shape){var C=this.docker.parent.getStencil().stencilSet();if(this.docker.parent instanceof ORYX.Core.Edge){var E=this.getHighestParentBeforeCanvas(A);if(E instanceof ORYX.Core.Edge&&this.docker.parent===E){this.isValid=false;this.dockerParent._update();return;}this.isValid=false;var a=A,d=A;while(!this.isValid&&a&&!(a instanceof ORYX.Core.Canvas)){A=a;this.isValid=this.facade.getRules().canConnect({sourceShape:this.dockerSource?this.dockerSource:(this.isStartDocker?A:undefined),edgeShape:this.docker.parent,targetShape:this.dockerTarget?this.dockerTarget:(this.isEndDocker?A:undefined)});a=a.parent;}if(!this.isValid){A=d;}}else{this.isValid=this.facade.getRules().canConnect({sourceShape:A,edgeShape:this.docker.parent,targetShape:this.docker.parent});}if(this.lastUIObj){this.hideMagnets(this.lastUIObj);}if(this.isValid){this.showMagnets(A);}this.showHighlight(A,this.isValid?this.VALIDCOLOR:this.INVALIDCOLOR);this.lastUIObj=A;}else{this.hideHighlight();this.lastUIObj?this.hideMagnets(this.lastUIObj):null;this.lastUIObj=undefined;this.isValid=false;}}if(this.lastUIObj&&this.isValid&&!(D.shiftKey||D.ctrlKey)){p=this.lastUIObj.magnets.find(function(x){return x.absoluteBounds().isIncluded(u);});if(p){this.docker.bounds.centerMoveTo(p.absoluteCenterXY());}}}}if(!(D.shiftKey||D.ctrlKey)&&!p){var t=ORYX.CONFIG.DOCKER_SNAP_OFFSET;var m=t+1;var k=t+1;var H=this.docker.bounds.center();if(this.docker.parent){this.docker.parent.dockers.each((function(y){if(this.docker==y){return;}var x=y.referencePoint?y.getAbsoluteReferencePoint():y.bounds.center();m=Math.abs(m)>Math.abs(x.x-H.x)?x.x-H.x:m;k=Math.abs(k)>Math.abs(x.y-H.y)?x.y-H.y:k;}).bind(this));if(Math.abs(m)<t||Math.abs(k)<t){m=Math.abs(m)<t?m:0;k=Math.abs(k)<t?k:0;this.docker.bounds.centerMoveTo(H.x+m,H.y+k);}else{var e=this.docker.parent.dockers[Math.max(this.docker.parent.dockers.indexOf(this.docker)-1,0)];var z=this.docker.parent.dockers[Math.min(this.docker.parent.dockers.indexOf(this.docker)+1,this.docker.parent.dockers.length-1)];if(e&&z&&e!==this.docker&&z!==this.docker){var h=e.bounds.center();var l=z.bounds.center();var v=this.docker.bounds.center();if(ORYX.Core.Math.isPointInLine(v.x,v.y,h.x,h.y,l.x,l.y,10)){var G=(Number(l.y)-Number(h.y))/(Number(l.x)-Number(h.x));var r=((h.y-(h.x*G))-(v.y-(v.x*(-Math.pow(G,-1)))))/((-Math.pow(G,-1))-G);var o=(h.y-(h.x*G))+(G*r);if(isNaN(r)||isNaN(o)){return;}this.docker.bounds.centerMoveTo(r,o);}}}}}var H=this.docker.bounds.center();var b=f.bounds.height();var F=f.bounds.width();var g=7,q=H.x,n=H.y;if(H.x<g||H.x>F-g){q=H.x<g?g:F-g;}if(H.y<g||H.y>b-g){n=H.y<g?g:b-g;}this.docker.bounds.centerMoveTo(q,n);this.dockerParent._update();this.scrollRect.scrollIntoView(D);},dockerMovedFinished:function(e){if(!this.dockerParent){return;}this.facade.setSelection(this.shapeSelection);this.hideHighlight();this.dockerParent.getLabels().each(function(g){g.show();});if(this.lastUIObj&&(this.isStartDocker||this.isEndDocker)){if(this.isValid){this.docker.setDockedShape(this.lastUIObj);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,docker:this.docker,parent:this.docker.parent,target:this.lastUIObj});}this.hideMagnets(this.lastUIObj);}if(!this.selectedDockers.include(this.docker)){this.docker.hide();}if(this.outerDockerNotMoved){var d=this.facade.eventCoordinates(e);var a=this.facade.getCanvas().getAbstractShapesAtPosition(d);var b=a.findAll(function(g){return g instanceof ORYX.Core.Node;});a=b.length?b:a;this.facade.setSelection([a.last()]);}else{var c=ORYX.Core.Command.extend({construct:function(n,h,g,m,l,k){this.docker=n;this.index=n.parent.dockers.indexOf(n);this.newPosition=h;this.newDockedShape=m;this.oldPosition=g;this.oldDockedShape=l;this.facade=k;this.index=n.parent.dockers.indexOf(n);this.shape=n.parent;},execute:function(){if(!this.docker.parent){this.docker=this.shape.dockers[this.index];}this.removedDockers=this.shape.removeUnusedDockers();this.dock(this.newDockedShape,this.newPosition);this.facade.updateSelection();},rollback:function(){(this.removedDockers||$H({})).each(function(g){this.shape.add(g.value,Number(g.key));this.shape._update(true);}.bind(this));this.dock(this.oldDockedShape,this.oldPosition);this.facade.updateSelection();},dock:function(g,h){this.docker.setDockedShape(undefined);if(g){this.docker.setDockedShape(g);this.docker.setReferencePoint(h);this.docker.bounds.centerMoveTo(h);this.shape._update(true);}else{this.docker.bounds.centerMoveTo(h);}}});if(this.docker.parent){var f=new c(this.docker,this.docker.getDockedShape()?this.docker.referencePoint:this.docker.bounds.center(),this._commandArg.refPoint,this.docker.getDockedShape(),this._commandArg.dockedShape,this.facade);this.facade.executeCommands([f]);}}this.docker=undefined;this.dockerParent=undefined;this.dockerSource=undefined;this.dockerTarget=undefined;this.lastUIObj=undefined;},hideHighlight:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"validDockedShape"});},showHighlight:function(b,a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"validDockedShape",elements:[b],color:a});},showMagnets:function(a){a.magnets.each(function(b){b.show();});},hideMagnets:function(a){a.magnets.each(function(b){b.hide();});},getHighestParentBeforeCanvas:function(a){if(!(a instanceof ORYX.Core.Shape)){return undefined;}var b=a.parent;while(b&&!(b.parent instanceof ORYX.Core.Canvas)){b=b.parent;}return b;}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.SelectionFrame=Clazz.extend({construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.handleMouseUp.bind(this),true);this.position={x:0,y:0};this.size={width:0,height:0};this.offsetPosition={x:0,y:0};this.scrollRect=new ORYX.Core.SelectedRect(this.facade.getCanvas().getSvgContainer(),{});this.moveCallback=undefined;this.offsetScroll={x:0,y:0};this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.facade.getCanvas().getHTMLContainer(),["div",{"class":"Oryx_SelectionFrame"}]);this.hide();},handleMouseDown:function(d,c){if(c instanceof ORYX.Core.Canvas){var e=c.rootNode.parentNode.parentNode;var b=this.facade.getCanvas().node.getScreenCTM();if(Ext.isIE9){var f=Ext.fly(this.facade.getCanvas().getScrollNode().firstChild);b.e=f.getLeft()+4;b.f=f.getTop()+4;}this.offsetPosition={x:b.e,y:b.f};this.setPos({x:Event.pointerX(d)-this.offsetPosition.x,y:Event.pointerY(d)-this.offsetPosition.y});this.resize({width:0,height:0});this.moveCallback=this.handleMouseMove.bind(this);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveCallback,false);this.offsetScroll={x:e.scrollLeft,y:e.scrollTop};this.show();}Event.stop(d);},handleMouseUp:function(f){if(this.moveCallback){this.hide();document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveCallback,false);this.moveCallback=undefined;var e=this.facade.getCanvas().node.getScreenCTM();var d={x:this.size.width>0?this.position.x:this.position.x+this.size.width,y:this.size.height>0?this.position.y:this.position.y+this.size.height};var c={x:d.x+Math.abs(this.size.width),y:d.y+Math.abs(this.size.height)};d.x/=e.a;d.y/=e.d;c.x/=e.a;c.y/=e.d;var g=this.facade.getCanvas().getChildShapes(true).findAll(function(b){var a=b.absoluteBounds();var k=a.upperLeft();var h=a.lowerRight();if(k.x>d.x&&k.y>d.y&&h.x<c.x&&h.y<c.y){return true;}return false;});this.facade.setSelection(g);}},handleMouseMove:function(b){var a={width:Event.pointerX(b)-this.position.x-this.offsetPosition.x,height:Event.pointerY(b)-this.position.y-this.offsetPosition.y};var c=this.facade.getCanvas().rootNode.parentNode.parentNode;a.width-=this.offsetScroll.x-c.scrollLeft;a.height-=this.offsetScroll.y-c.scrollTop;this.resize(a);this.scrollRect.scrollIntoView(b);Event.stop(b);},hide:function(){this.node.style.display="none";},show:function(){this.node.style.display="";},setPos:function(a){this.node.style.top=Math.max(a.y,0)+"px";this.node.style.left=Math.max(a.x,0)+"px";this.position=a;},resize:function(c){var e=this.position;this.setPos(Object.clone(e));this.size=Object.clone(c);if(c.width<0){e.x=e.x+c.width;this.node.style.left=e.x+"px";c.width=-c.width;}if(c.height<0){e.y=e.y+c.height;this.node.style.top=e.y+"px";c.height=-c.height;}var d=this.facade.getCanvas().rootNode.parentNode,a=d.offsetWidth,b=d.offsetHeight;this.node.style.width=Math.min(a-e.x,c.width)+"px";this.node.style.height=Math.min(b-e.y,c.height)+"px";}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.ShapeHighlighting=Clazz.extend({construct:function(a){this.parentNode=a.getCanvas().getSvgContainer();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parentNode,["g"]);this.highlightNodes={};a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,this.setHighlight.bind(this));a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,this.hideHighlight.bind(this));},setHighlight:function(a){if(a&&a.highlightId){var b=this.highlightNodes[a.highlightId];if(!b){b=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"stroke-width":2,"fill":"none"}]);this.highlightNodes[a.highlightId]=b;}if(a.elements&&a.elements.length>0){this.setAttributesByStyle(b,a);this.show(b);}else{this.hide(b);}}},hideHighlight:function(a){if(a&&a.highlightId&&this.highlightNodes[a.highlightId]){this.hide(this.highlightNodes[a.highlightId]);}},hide:function(a){a.setAttributeNS(null,"display","none");},show:function(a){a.setAttributeNS(null,"display","");},setAttributesByStyle:function(b,a){if(a.style&&a.style==ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE){var d=a.elements[0].absoluteBounds();var c=a.strokewidth?a.strokewidth:ORYX.CONFIG.BORDER_OFFSET;b.setAttributeNS(null,"d",this.getPathRectangle(d.a,d.b,c));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);b.setAttributeNS(null,"stroke-width",c);}else{if(a.elements.length==1&&a.elements[0] instanceof ORYX.Core.Edge&&a.highlightId!="selection"){b.setAttributeNS(null,"d",this.getPathEdge(a.elements[0].dockers));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);b.setAttributeNS(null,"stroke-width",ORYX.CONFIG.OFFSET_EDGE_BOUNDS);}else{b.setAttributeNS(null,"d",this.getPathByElements(a.elements));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:1);b.setAttributeNS(null,"stroke-width",a.strokewidth?a.strokewidth:2);}}},getPathByElements:function(a){if(!a||a.length<=0){return undefined;}var c=ORYX.CONFIG.SELECTED_AREA_PADDING;var b="";a.each((function(f){if(!f){return;}var g=f.absoluteBounds();g.widen(c);var e=g.upperLeft();var d=g.lowerRight();b=b+this.getPath(e,d);}).bind(this));return b;},getPath:function(d,c){return this.getPathCorners(d,c);},getPathCorners:function(d,c){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";f=f+"M"+d.x+" "+(d.y+e)+" l0 -"+e+" l"+e+" 0 ";f=f+"M"+d.x+" "+(c.y-e)+" l0 "+e+" l"+e+" 0 ";f=f+"M"+c.x+" "+(c.y-e)+" l0 "+e+" l-"+e+" 0 ";f=f+"M"+c.x+" "+(d.y+e)+" l0 -"+e+" l-"+e+" 0 ";return f;},getPathRectangle:function(d,c,h){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";var g=h/2;f=f+"M"+(d.x+g)+" "+(d.y);f=f+" L"+(d.x+g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(d.y+g);f=f+" L"+(d.x+g)+" "+(d.y+g);return f;},getPathEdge:function(a){var b=a.length;var c="M"+a[0].bounds.center().x+" "+a[0].bounds.center().y;for(i=1;i<b;i++){var d=a[i].bounds.center();c=c+" L"+d.x+" "+d.y;}return c;}});ORYX.Plugins.HighlightingSelectedShapes=Clazz.extend({construct:function(a){this.facade=a;this.opacityFull=0.9;this.opacityLow=0.4;},onSelectionChanged:function(a){if(a.elements&&a.elements.length>1){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"selection",elements:a.elements.without(a.subSelection),color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:!a.subSelection?this.opacityFull:this.opacityLow});if(a.subSelection){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"subselection",elements:[a.subSelection],color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:this.opacityFull});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"});}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"selection"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"});}}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Overlay=Clazz.extend({facade:undefined,styleNode:undefined,construct:function(a){this.facade=a;this.changes=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_OVERLAY_SHOW,this.show.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_OVERLAY_HIDE,this.hide.bind(this));this.styleNode=document.createElement("style");this.styleNode.setAttributeNS(null,"type","text/css");document.getElementsByTagName("head")[0].appendChild(this.styleNode);},show:function(a){if(!a||!a.shapes||!a.shapes instanceof Array||!a.id||!a.id instanceof String||a.id.length==0){return;}if(a.attributes){a.shapes.each(function(d){if(!d instanceof ORYX.Core.Shape){return;}this.setAttributes(d.node,a.attributes);}.bind(this));}var c=true;try{c=a.node&&a.node instanceof SVGElement;}catch(b){}if(a.node&&c){a["_temps"]=[];a.shapes.each(function(g,f){if(!g instanceof ORYX.Core.Shape){return;}var e={};e.svg=a.dontCloneNode?a.node:a.node.cloneNode(true);g.node.firstChild.appendChild(e.svg);if(g instanceof ORYX.Core.Edge&&!a.nodePosition){a["nodePosition"]="START";}if(a.nodePosition){var d=g.bounds;var h=a.nodePosition.toUpperCase();if(g instanceof ORYX.Core.Node&&h=="START"){h="NW";}else{if(g instanceof ORYX.Core.Node&&h=="END"){h="SE";}else{if(g instanceof ORYX.Core.Edge&&h=="START"){d=g.getDockers().first().bounds;}else{if(g instanceof ORYX.Core.Edge&&h=="END"){d=g.getDockers().last().bounds;}}}}e.callback=function(){var k=0;var m=0;if(h=="NW"){}else{if(h=="N"){k=d.width()/2;}else{if(h=="NE"){k=d.width();}else{if(h=="E"){k=d.width();m=d.height()/2;}else{if(h=="SE"){k=d.width();m=d.height();}else{if(h=="S"){k=d.width()/2;m=d.height();}else{if(h=="SW"){m=d.height();}else{if(h=="W"){m=d.height()/2;}else{if(h=="START"||h=="END"){k=d.width()/2;m=d.height()/2;}else{return;}}}}}}}}}if(g instanceof ORYX.Core.Edge){k+=d.upperLeft().x;m+=d.upperLeft().y;}if("object"===typeof a["adjustment"]){var l=a["adjustment"];k+=(l.x&&Number(l.x)?Number(l.x):0);m+=(l.y&&Number(l.y)?Number(l.y):0);}e.svg.setAttributeNS(null,"transform","translate("+k+", "+m+")");}.bind(this);e.element=g;e.callback();d.registerCallback(e.callback);}a._temps.push(e);}.bind(this));}if(!this.changes[a.id]){this.changes[a.id]=[];}this.changes[a.id].push(a);},hide:function(a){if(!a||!a.id||!a.id instanceof String||a.id.length==0||!this.changes[a.id]){return;}this.changes[a.id].each(function(b){b.shapes.each(function(d,c){if(!d instanceof ORYX.Core.Shape){return;}this.deleteAttributes(d.node);}.bind(this));if(b._temps){b._temps.each(function(c){if(c.svg&&c.svg.parentNode){c.svg.parentNode.removeChild(c.svg);}if(c.callback&&c.element){c.element.bounds.unregisterCallback(c.callback);}}.bind(this));}}.bind(this));this.changes[a.id]=null;},setAttributes:function(c,d){var h=this.getAllChilds(c.firstChild.firstChild);var a=[];h.each(function(m){a.push($A(m.attributes).findAll(function(n){return n.nodeValue.startsWith("url(#");}));});a=a.flatten().compact();a=a.collect(function(m){return m.nodeValue;}).uniq();a=a.collect(function(m){return m.slice(5,m.length-1);});a.unshift(c.id+" .me");var g=$H(d);var e=g.toJSON().gsub(",",";").gsub('"',"");var k=d.stroke?e.slice(0,e.length-1)+"; fill:"+d.stroke+";}":e;var f;if(d.fill){var b=Object.clone(d);b.fill="black";f=$H(b).toJSON().gsub(",",";").gsub('"',"");}csstags=a.collect(function(n,m){return"#"+n+" * "+(!m?e:k)+""+(f?" #"+n+" text * "+f:"");});var l=csstags.join(" ")+"\n";this.styleNode.appendChild(document.createTextNode(l));},deleteAttributes:function(b){var a=$A(this.styleNode.childNodes).findAll(function(c){return c.textContent.include("#"+b.id);});a.each(function(c){c.parentNode.removeChild(c);});},getAllChilds:function(a){var b=$A(a.childNodes);$A(a.childNodes).each(function(c){b.push(this.getAllChilds(c));}.bind(this));return b.flatten();}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Edit=Clazz.extend({construct:function(a){this.facade=a;this.clipboard=new ORYX.Plugins.Edit.ClipBoard(this.facade.getCanvas().getStencil().stencilSet().namespace());this.snap=new ORYX.Core.SnapToGrid(this.facade);this.snap.cThres=48;this.callbackMouseMove=this.handleMouseMove.bind(this);this.callbackMouseOut=this.handleMouseOut.bind(this);this.registerOnMouseEvents();this.lastMouseMoveEvent=undefined;this.currentMousePos=undefined;this.currentCopyBounds=undefined;this.canvasResizeFn=this.resizeCanvas.bind(this);this.facade.offer({name:ORYX.I18N.Edit.cut,description:ORYX.I18N.Edit.cutDesc,icon:ORYX.PATH+"images/cut.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:88,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editCut),group:ORYX.I18N.Edit.group,index:1,minShape:1});this.facade.offer({name:ORYX.I18N.Edit.copy,description:ORYX.I18N.Edit.copyDesc,icon:ORYX.PATH+"images/page_copy.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:67,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editCopy,[true,false]),group:ORYX.I18N.Edit.group,index:2,minShape:1});var b={name:ORYX.I18N.Edit.paste,description:ORYX.I18N.Edit.pasteDesc,icon:ORYX.PATH+"images/page_paste.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:86,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editPaste),isEnabled:this.clipboard.isOccupied.bind(this.clipboard),group:ORYX.I18N.Edit.group,index:3,minShape:0,maxShape:0};this.facade.offer(b);this.facade.offer({name:ORYX.I18N.Edit.del,description:ORYX.I18N.Edit.delDesc,icon:ORYX.PATH+"images/cross.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:8,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN},{keyCode:46,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editDelete),group:ORYX.I18N.Edit.group,index:4,minShape:1});this.clipboard.onChange(function(c){if(b&&b.buttonInstance&&c){b.buttonInstance.enable();}});},callEdit:function(b,a){window.setTimeout(function(){b.apply(this,(a instanceof Array?a:[]));}.bind(this),1);},handleMouseDown:function(a){if(this._controlPressed){this._controlPressed=false;this.editCopy();this.editPaste();a.forceExecution=true;this.facade.raiseEvent(a,this.clipboard.shapesAsJson);}},getAllShapesToConsider:function(b){var a=[];var c=[];b.each(function(e){isChildShapeOfAnother=b.any(function(g){return g.hasChildShape(e);});a.push(e);if(e instanceof ORYX.Core.Node){var f=e.getOutgoingNodes();f=f.findAll(function(g){return !b.include(g);});a=a.concat(f);}a=[].concat(a,e.getChildShapes(false).findAll(function(h){var g=ORYX.Plugins.Edit.DeleteCommand.prototype;return !g.findParent.call({facade:this.facade,findParent:g.findParent},h,e.parent)&&!a.include(h);}.bind(this)));}.bind(this));var d=this.facade.getCanvas().getChildEdges().select(function(e){if(a.include(e)){return false;}if(e.getAllDockedShapes().size()===0){return false;}return e.getAllDockedShapes().all(function(f){return false;});});a=[].concat(a,d).uniq();return a;},editCut:function(){if(this.facade.getSelection().length==0){return;}this.facade.getSelection();this.editCopy(false,true);this.editDelete(true);return false;},editCopy:function(d,a){var b=this.facade.getSelection();if(b.length==0){return;}try{this.clipboard.refresh(b,this.getAllShapesToConsider(b),a);}catch(c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:Signavio.I18N.CopyPaste.CopyFail,timeout:3000});}if(d){this.facade.updateSelection();}},editPaste:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:Signavio.I18N.CopyPaste.PasteWait});this.clipboard.getClip(function(a){this.doEditPaste(a);}.bind(this));},doEditPaste:function(b){if(!(this.facade.getCanvas().getStencil().namespace()===b.stencilset.namespace)){Ext.MessageBox.show({title:Signavio.I18N.CopyPaste.Note,msg:Signavio.I18N.CopyPaste.WrongNamespace,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});return;}if(b.childShapes.length==0){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});return;}var h=b.childShapes.findAll(function(l){return this.getTypeOfSerializedShape(l,b)&&!this.isStencilHidden(l);}.bind(this));var c=b.childShapes;if(h.length==0){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});return;}b.childShapes=h;Ext.apply(b,ORYX.Core.AbstractShape.JSONHelper);var g=b.getChildShapes(true).pluck("resourceId");var e={};var k=false;if(b.getChildShapes()){var f=this.getOffsetToMouse(b.getChildShapes(),b);var d=(f?f.offset:undefined);k=(f?true:false);}b.eachChild(function(l,m){l.outgoing=l.outgoing.select(function(n){return g.include(n.resourceId);});l.outgoing.each(function(n){if(!e[n.resourceId]){e[n.resourceId]=[];}e[n.resourceId].push(l);});return l;}.bind(this),true,true);b.eachChild(function(l,m){if((!l.targetId)||(l.targetId&&!(g.include(l.targetId)))){l.target=undefined;l.targetRemoved=true;}if(l.dockers&&((l.sourceId&&!g.include(l.sourceId))||(!l.sourceId))&&(l.dockers.length>1||(l.dockers.length==1&&this.getTypeOfSerializedShape(l,b)==="node"&&l.attachedTo&&!g.include(l.attachedTo)))){l.sourceRemoved=true;}return l;}.bind(this),true,true);var a=b.childShapes.findAll(function(m,q){var n=this.clipboard.useOffset;if(!this.isParentInShapesToJSON(m)){if(k){var l=this.getParentShapeFromList((f?f.shapesAtPosition:undefined),m,b);if(!l&&this.getTypeOfSerializedShape(m,b)==="node"){return false;}if(l&&m.oldParent){m.parent={resourceId:l.resourceId};}else{m.parent=undefined;}m.bounds={lowerRight:{x:m.absBounds.lowerRight.x+(d?d.x:(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0)),y:m.absBounds.lowerRight.y+(d?d.y:(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0))},upperLeft:{x:m.absBounds.upperLeft.x+(d?d.x:(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0)),y:m.absBounds.upperLeft.y+(d?d.y:(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0))}};if(f&&l){var p=l.absoluteBounds().upperLeft().x;var r=l.absoluteBounds().upperLeft().y;m.bounds.lowerRight.x-=p;m.bounds.lowerRight.y-=r;m.bounds.upperLeft.x-=p;m.bounds.upperLeft.y-=r;}}else{m.bounds={lowerRight:{x:m.relBounds.lowerRight.x+(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0),y:m.relBounds.lowerRight.y+(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0)},upperLeft:{x:m.relBounds.upperLeft.x+(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0),y:m.relBounds.upperLeft.y+(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0)}};}}this.facade.raiseEvent({type:SMARTDOT.CONFIG.EVENT_ON_PASTE_SHAPE,shape:m});var o=this.getTypeOfSerializedShape(m,b);if(m.dockers&&o==="edge"){m.dockers=m.oldDockers.map(function(t,s){if((m.targetRemoved===true&&s==m.dockers.length-1)||(m.sourceRemoved===true&&s==0)){t=m.absDockers[s];}if((s!=0||m.sourceRemoved===true)&&((s!=m.dockers.length-1)||m.targetRemoved===true)&&!this.isParentInShapesToJSON(m)){return{x:t.x+(d?d.x:(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0)),y:t.y+(d?d.y:(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0)),getDocker:t.getDocker};}else{return{x:t.x,y:t.y,getDocker:t.getDocker};}}.bind(this));}else{if(o==="node"&&m.dockers&&m.dockers.length==1&&!m.attachedTo){m.dockers=m.oldDockers.map(function(u,s){if((m.sourceRemoved===true&&s==0&&m.absDockers)){u=m.absDockers[0];return u;}var t=new ORYX.Core.Bounds(m.bounds.upperLeft,m.bounds.lowerRight);var v=t.center();return{x:v.x,y:v.y,getDocker:u.getDocker};}.bind(this));}}if(o==="edge"&&m.labels){m.labels.each(function(s){if(s.x&&s.y){s.x=s.x+(d?d.x:(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0));s.y=s.y+(d?d.y:(n?ORYX.CONFIG.COPY_MOVE_OFFSET:0));}});}return true;}.bind(this));if(a&&a.length==0&&b.childShapes.length>0){Ext.MessageBox.show({title:Signavio.I18N.CopyPaste.Note,msg:Signavio.I18N.CopyPaste.NotPastable,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO});}else{if(h.length!=b.childShapes.length){Ext.MessageBox.show({title:Signavio.I18N.CopyPaste.Note,msg:Signavio.I18N.CopyPaste.SkipedShapes,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO});}}b.childShapes=a;this.clipboard.useOffset=true;this.currentMousePos=(f?f.mousePosition:undefined);this.currentCopyBounds=(f?f.includingBounds:undefined);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAST_EXECUTE_COMMANDS,this.canvasResizeFn);this.facade.importJSON(b);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});},editDelete:function(){var a=this.facade.getSelection();var c=new ORYX.Plugins.Edit.ClipBoard();c.refresh(a,this.getAllShapesToConsider(a));var b={type:ORYX.CONFIG.EVENT_BEFORE_REMOVE,cancelled:false,elements:a};this.facade.raiseEvent(b);if(!b.cancelled){var d=new ORYX.Plugins.Edit.DeleteCommand(c,this.facade);this.facade.executeCommands([d]);}},isParentInShapesToJSON:function(a){var c=this;var b;if(!a||!a.parent){return false;}b=a.parent.resourceId;return this.clipboard.shapesAsJson.any(function(d){return d.resourceId===b&&!c.isStencilHidden.bind(c,a.parent);});},getTypeOfSerializedShape:function(b,a){var d=this.facade.getStencilSets()[a.stencilset.namespace];if(!d){return;}var c=d.stencil(a.stencilset.namespace+b.stencil.id);if(!c){return;}return c.type();},isStencilHidden:function(a){var b=this.clipboard.getStencilSet();var d=this.facade.getStencilSets()[b];if(!d){return true;}var c=d.stencil(b+a.stencil.id);return !c||c.hide();},calculateMousePositon:function(){if(!this.lastMouseMoveEvent){return null;}return this.facade.eventCoordinates(this.lastMouseMoveEvent);},handleMouseMove:function(a){this.lastMouseMoveEvent=a;},handleMouseOut:function(a){this.lastMouseMoveEvent=undefined;},snapToGrid:function(y,n,o){var f=this.snap.cThres;var e=this.facade.getCanvas().getZoom();var b={width:this.facade.getCanvas().bounds.width(),height:this.facade.getCanvas().bounds.height()};var k=[];var x,u,v,t;var p=[];var s=[];var h=[];var m=[];n.each((function(B){var A=B;var z=A.absBounds;if(x!=undefined&&z.upperLeft.x<x){p=[];}x=(x==undefined)?z.upperLeft.x:((z.upperLeft.x<x)?z.upperLeft.x:x);if(x==z.upperLeft.x){p.push(z);}if(u!=undefined&&z.upperLeft.y<u){h=[];}u=(u==undefined)?z.upperLeft.y:((z.upperLeft.y<u)?z.upperLeft.y:u);if(u==z.upperLeft.y){h.push(z);}if(v!=undefined&&z.lowerRight.x>v){s=[];}v=(v==undefined)?z.lowerRight.x:((z.lowerRight.x>v)?z.lowerRight.x:v);if(v==z.lowerRight.x){s.push(z);}if(t!=undefined&&z.lowerRight.y>t){m=[];}t=(t==undefined)?z.lowerRight.y:((z.lowerRight.y>t)?z.lowerRight.y:t);if(t==z.lowerRight.y){m.push(z);}}).bind(this));k=p.concat(h,s,m).uniq();var l,g;var d=[];var a=[];var c={};this.snap.setScale(e);k.each((function(G){var z=new ORYX.Core.Bounds();z.set(G.upperLeft,G.lowerRight);var K=o.width()/2-(z.upperLeft().x-o.upperLeft().x);var E=o.height()/2-(z.upperLeft().y-o.upperLeft().y);var A={x:y.x-K*e,y:y.y-E*e};var C,B;this.snap.setReferenceBounds(z);var J=this.snap.adjustPoint(A,function(L){B=L;},function(L){C=L;});if(C){var F=Math.abs(A.x-J.x);var I=J.x+(K*e);if((l==undefined||F<l)&&(I>=0&&(I+(o.width()*e))<=(b.width*e))){d=[];c.x=I;l=F;}if(c.x==I){d.push(C);}}if(B){var D=Math.abs(A.y-J.y);var H=J.y+(E*e);if((g==undefined||D<g)&&(H>=0&&(H+(o.height()/2*e))<=(b.height*e))){a=[];c.y=H;g=D;}if(c.y==H){a.push(B);}}}).bind(this));if(l==undefined){var r=(y.x-(y.x%(ORYX.CONFIG.GRID_DISTANCE/2)));c.x=r;}if(g==undefined){var q=(y.y-(y.y%(ORYX.CONFIG.GRID_DISTANCE/2)));c.y=q;}return c;},getOffsetToMouse:function(e,a){var f=this.calculateMousePositon();var c=this.calculateClipBoardIncludingBounds(e);if(!f||!c){return;}var d=new Object();d.shapesAtPosition=this.facade.getCanvas().getAbstractShapesAtPosition(f);this.calculateReferenceShapes(d.shapesAtPosition,e,a);var b=this.snapToGrid(f,e,c);f=b;d.includingBounds=c;d.mousePosition=f;d.offset=this.calculateMiddleOffsetToMousePointer(f,c);return d;},calculateClipBoardIncludingBounds:function(d){if(!d||d.size()<=0){return;}var a=new ORYX.Core.Bounds();var c=d.first().absBounds;a.set(c.upperLeft,c.lowerRight);d.each(function(b){if(!this.isParentInShapesToJSON(b)){c=b.absBounds;var e=new ORYX.Core.Bounds();e.set(c.upperLeft,c.lowerRight);a.include(e);}}.bind(this));return a;},calculateMiddleOffsetToMousePointer:function(d,a){if(!d||!a){return;}var b=a.center();var c={x:0,y:0};c.x=d.x-b.x;c.y=d.y-b.y;return c;},getParentShapeFromList:function(b,c,a){if(!b||!c||!a||b.length==0){return;}var g=b.clone();var f=this.facade.getStencilSets()[a.stencilset.namespace];var e=f.stencil(a.stencilset.namespace+c.stencil.id);var d=g.pop();while(d){if(this.facade.getRules().canContain({containingShape:d,containedStencil:e})&&c.resourceId!==d.resourceId){return d;}if(d instanceof ORYX.Core.Canvas){return false;}d=g.pop();}},registerOnMouseEvents:function(){var a=this.facade.getCanvas().getRootNode();a.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.callbackMouseMove.bind(this),true);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this.callbackMouseOut.bind(this),true);},calculateReferenceShapes:function(b,d,a){var c=d;if(ORYX.CONFIG.GRID_ENABLED){this.snap.setReferenceShapes();this.snap.setReferenceShapes(this.facade.getCanvas().getChildNodes(true),false,true);}},resizeCanvas:function(a){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_LAST_EXECUTE_COMMANDS,this.canvasResizeFn);var b=this.currentCopyBounds;var m=this.currentMousePos;if(!b||!m){return;}var h=this.facade.getCanvas().bounds;var l=0;var c=0;var k=0;var g=0;if(m.y-b.height()/2<0){l=m.y-b.height()/2;l*=-1;}if(m.y+b.height()/2>h.lowerRight().y){k=m.y+b.height()/2-h.lowerRight().y;}if(m.x-b.width()/2<0){g=m.x-b.width()/2;g*=-1;}if(m.x+b.width()/2>h.lowerRight().x){c=m.x+b.width()/2-h.lowerRight().x;}var f=function(v,t,o,s,x){var n=x.getCanvas();var u=n.bounds;var q=x.getCanvas().getHTMLContainer().parentNode.parentNode;n.setSize({width:(u.width()+o+s)*n.zoomLevel,height:(u.height()+v+t)*n.zoomLevel});if(v||s){var p={x:s,y:v};n.getChildNodes(false,function(z){z.bounds.moveBy(p);});var r=n.getChildEdges();var y=r.collect(function(z){return z.dockers.findAll(function(A){return !A.getDockedShape();});}).flatten();y.each(function(z){z.bounds.moveBy(p);});}};var e=ORYX.Core.Command.extend({construct:function(r,p,q,n,o){this.resN=r;this.resE=q;this.resS=p;this.resW=n;this.facade=o;},execute:function(){f(this.resN,this.resE,this.resS,this.resW,this.facade);},rollback:function(){f(-this.resN,-this.resE,-this.resS,-this.resW,this.facade);}});var d=new e(l,k,c,g,this.facade);this.facade.executeCommands([d]);}});ORYX.Plugins.Edit.ClipBoard=Clazz.extend({construct:function(b,a){this.shapesAsJson=[];this.selection=[];this.SSnamespace=b||"";this.useOffset=true;this.facade=a;},isOccupied:function(){return this.shapesAsJson.length>0;},getStencilSet:function(){return this.SSnamespace;},getClip:function(b){var a={childShapes:this.shapesAsJson,useOffset:this.useOffset,stencilset:{namespace:this.SSnamespace}};if(b instanceof Function){b(a);}return a;},refresh:function(c,b,a){this.selection=c;this.outgoings={};this.parents={};this.targets={};this.useOffset=a!==true;this.shapesAsJson=b.sort(function(e,d){var f=e.parent;while(!(f instanceof ORYX.Core.Canvas)){if(f===d){return 1;}f=f.parent;}f=d.parent;while(!(f instanceof ORYX.Core.Canvas)){if(f===e){return -1;}f=f.parent;}return 0;}).map(function(e){var f=e.toJSON();f.relBounds={};f.relBounds.upperLeft=e.bounds.upperLeft();f.relBounds.lowerRight=e.bounds.lowerRight();var g=e.absoluteBounds();f.absBounds={};f.absBounds.upperLeft=g.upperLeft();f.absBounds.lowerRight=g.lowerRight();if(e instanceof ORYX.Core.Edge){f.targetId=(e.getTarget()?e.getTarget().resourceId:null);f.sourceId=(e.getSource()?e.getSource().resourceId:null);}if(f.dockers){f.oldDockers=f.dockers.clone();var d=[];e.dockers.each(function(h){d.push(h.bounds.center());});f.absDockers=d;}if(f.dockers.length==1&&e instanceof ORYX.Core.Node&&e.getIncomingNodes().length==1){f.attachedTo=e.getIncomingNodes()[0].resourceId;}f.childShapes=[];f.oldParent={resourceId:e.getParentShape().resourceId};f.parent={resourceId:e.getParentShape().resourceId};f.parentIndex=e.getParentShape().getChildShapes().indexOf(e);return f;});}});ORYX.Plugins.Edit.AsyncClipBoard=ORYX.Plugins.Edit.ClipBoard.extend({events:["focus"],changeClb:[],transactionId:null,construct:function(){arguments.callee.$.construct.apply(this,arguments);this.events.each(function(a){Ext.getDoc().on(a,this.checkForChanges,this);}.bind(this));},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);Ext.Ajax.request({url:"/p/clipboard",method:"POST",timeout:300000,success:function(a){if(a.status===200){this.transactionId=(a.responseText||"{}").evalJSON().id;}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}.bind(this),failure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:Signavio.I18N.CopyPaste.CopyFail,timeout:3000});}.bind(this),params:{value_json:Object.toJSON(this.getClip()),namespace:this.SSnamespace}});},onChange:function(a){if(!this.changeClb.include(a)){this.changeClb.push(a);}},checkForChanges:function(b){var a,c;a=Ext.select("div.y-richtext-editor").elements;a.each(function(d){if(d.visible()){c=true;}});if(c){return;}this.hasChanges(function(d){if(d){this.changeClb.each(function(e){e(d);});}}.bind(this));},hasChanges:function(a){a=a||Ext.emptyFn;Ext.Ajax.request({url:"/p/clipboard",method:"GET",timeout:3000,success:function(b){var c=b.responseText.evalJSON();a(c&&c.id&&this.transactionId!==c.id&&c.namespace===this.SSnamespace,c.namespace);}.bind(this),failure:function(b){a(false);},params:{head:true}});},loadChanges:function(b,a){Ext.Ajax.request({url:"/p/clipboard",timeout:300000,success:function(c){var d=(c.responseText||"{}").evalJSON();if(d&&d.id&&d.value_json){d.value_json=d.value_json.evalJSON();if(d.value_json.stencilset.namespace===this.SSnamespace){Ext.apply(this,{transactionId:d.id,useOffset:d.value_json.useOffset,shapesAsJson:d.value_json.childShapes,SSnamespace:d.value_json.stencilset.namespace});}}var d={childShapes:this.shapesAsJson,useOffset:this.useOffset,stencilset:{namespace:(a?a:this.SSnamespace)}};b(d);}.bind(this),failure:function(c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:Signavio.I18N.CopyPaste.CopyFail,timeout:3000});var d={childShapes:this.shapesAsJson,useOffset:this.useOffset,stencilset:{namespace:this.SSnamespace}};b(d);},params:{}});},getClip:function(a){if(a instanceof Function){this.hasChanges(function(b,d){if(b){this.loadChanges(a,d);}else{var c={childShapes:this.shapesAsJson,useOffset:this.useOffset,stencilset:{namespace:(d?d:this.SSnamespace)}};a(c);}}.bind(this));}else{return arguments.callee.$.getClip.call(this);}}});ORYX.Plugins.Edit.DeleteCommand=ORYX.Plugins.AbstractPlugin.extend({construct:function(b,a){this.clipboard=b;this.shapesAsJson=b.shapesAsJson;this.facade=a;this.childBounds=[];this.edgesToDelete=[];this.newEdges=[];this.size=this.shapesAsJson.length;this.selection=this.facade.getSelection().pluck("id");this.dockers=this.findDockers().flatten();this.glossarProperties=[];},execute:function(){this.dockers=this.findDockers().flatten();this.childShapes={};this.shapesAsJson.each(function(e){var b=e.getShape();var d=this.searchForPossibleReconnect(b);this.deleteIncomings(b);this.deleteOutgoings(b);this.edgesToDelete.each(function(f){this.updateGlossaryEntries(f);this.facade.deleteShape(f);}.bind(this));if(d.isPossible&&this.size===1){d.connections.each(function(g){var f=this.facade.createShape({namespace:g.source.getStencil().namespace(),type:g.type});g.template.properties.each(function(h){f.setProperty(h[0],h[1]);});f.dockers.first().setDockedShape(g.source);f.dockers.last().setDockedShape(g.target);f.dockers.first().setReferencePoint(g.source.bounds.midPoint());f.dockers.last().setReferencePoint(g.target.bounds.midPoint());this.newEdges.push(f);this.doLayout(f);}.bind(this));}var c=b.getParentShape();var a=b.absoluteXY();this.updateGlossaryEntries(b);this.facade.deleteShape(b);if(b.parent){return;}if(this.facade.getRules().isContainer(b)){this.deleteContainer(b,c,a);}}.bind(this));this.facade.setSelection([]);},rollback:function(){this.shapesAsJson.each(function(c){var a=c.getShape();var b=this.facade.getCanvas().getChildShapeByResourceId(c.parent.resourceId)||this.facade.getCanvas();if(this.facade.getRules().isContainer(a)){this.restoreContainer(a);}this.rollbackGlossaryEntryUpdate(c.resourceId);b.add(a,c.parentIndex);}.bind(this));this.newEdges.each(function(a){this.facade.deleteShape(a);}.bind(this));this.dockers.each(function(a){if(a.dockedShape){a.object.setDockedShape(a.dockedShape);a.object.setReferencePoint(a.referencePoint);}}.bind(this));this.facade.setSelection(this.shapesAsJson.map(function(a){return a.getShape();}).findAll(function(a){return this.selection.include(a.id);}.bind(this)));},searchForPossibleReconnect:function(b){var a=[];var e=[];var d=[];b.getIncomingShapes().each(function(g){if(g instanceof ORYX.Core.Edge){var f=g.getStencil().id();if(d.indexOf(f)===-1){d.push(f);}if(a[f]){a[f].push(g);}else{a[f]=[g];}}});b.getOutgoingShapes().each(function(g){if(g instanceof ORYX.Core.Edge){var f=g.getStencil().id();if(d.indexOf(f)===-1){d.push(f);}if(e[f]){e[f].push(g);}else{e[f]=[g];}}});var c=[];d.each(function(l){if((a[l]||[]).length===1&&(e[l]||[]).length===1){if(!a[l][0].getSource()||!e[l][0].getTarget()){return;}var k=this.facade.getRules().canConnect({sourceShape:a[l][0].getSource(),targetShape:e[l][0].getTarget(),edgeStencil:a[l][0].getStencil()});var g=a[l][0].getSource();var f=e[l][0].getTarget();var h=g.getOutgoingShapes().every(function(n){if(n instanceof ORYX.Core.Edge){var m=n.getStencil().id();if(n.getTarget()===f&&l===m){return false;}}return true;});if(h&&k&&a[l][0].getSource()!==e[l][0].getTarget()){c.push({source:a[l][0].getSource(),target:e[l][0].getTarget(),type:l,template:a[l][0]});}}}.bind(this));return{isPossible:c.length>0,connections:c};},findDockers:function(){return this.shapesAsJson.map(function(e){var c=e.getShape();var d=c.getIncomingShapes().map(function(f){return[f.getDockers().first(),f.getDockers().last()];}).flatten();var b=c.getOutgoingShapes().map(function(f){return[f.getDockers().first(),f.getDockers().last()];}).flatten();var a=c.getDockers().concat(d,b).compact().map(function(f){return{object:f,referencePoint:f.referencePoint,dockedShape:f.getDockedShape()};});return a;});},restoreContainer:function(a){if(this.childShapes[a.resourceId]){this.childShapes[a.resourceId].each(function(c){var d=c.shape;var b=c.bounds;this.rollbackGlossaryEntryUpdate(d.resourceId);if(this.facade.getRules().isContainer(d)){this.restoreContainer(d);}d.bounds.set(b);a.add(d);}.bind(this));}},deleteOutgoings:function(a){if(!(a instanceof ORYX.Core.Edge)){a.getOutgoingShapes().each(function(c){if(c instanceof ORYX.Core.Node){this.deleteOutgoings(c);}var b=c.toJSON();b.parent={resourceId:c.getParentShape().resourceId};b.parentIndex=c.getParentShape().getChildShapes().indexOf(c);this.shapesAsJson.push(b);this.edgesToDelete.push(c);}.bind(this));}},deleteIncomings:function(a){if(a instanceof ORYX.Core.Edge){return;}a.getIncomingShapes().each(function(c){if(c instanceof ORYX.Core.Edge){var b=c.toJSON();b.parent={resourceId:c.getParentShape().resourceId};b.parentIndex=c.getParentShape().getChildShapes().indexOf(c);this.shapesAsJson.push(b);this.edgesToDelete.push(c);}}.bind(this));},deleteContainer:function(a,c,d){if(this.childShapes[a.resourceId]){return;}var b=a.getChildNodes();this.childShapes[a.resourceId]=[];b.each(function(k){var e={x:d.x+k.bounds.a.x,y:d.y+k.bounds.a.y};var h={a:{x:e.x-d.x,y:e.y-d.y},b:{x:e.x-d.x+k.bounds.width(),y:e.y-d.y+k.bounds.height()}};var g={shape:k,bounds:h};this.childShapes[a.resourceId].push(g);var f=this.findParent(k,c);if(f!==null){var h=this.computeBounds(k,f,e);k.bounds.set(h);f.add(k);}else{this.updateGlossaryEntries(k);this.facade.deleteShape(k);if(this.facade.getRules().isContainer(k)){this.deleteContainer(k,c,e);}}}.bind(this));},findParent:function(a,c){if(c){var b={containingStencil:c.getStencil(),containedStencil:a.getStencil(),containingShape:c,containedShape:a};if(this.facade.getRules().canContain(b)){return c;}else{if(c.parent){return this.findParent(a,c.getParentShape());}}}return null;},computeBounds:function(c,b,a){if(!(b instanceof ORYX.Core.Canvas)){var e=b.absoluteXY();var d={a:{x:a.x-e.x,y:a.y-e.y},b:{x:a.x-e.x+c.bounds.width(),y:a.y-e.y+c.bounds.height()}};}else{var d={a:{x:a.x,y:a.y},b:{x:a.x+c.bounds.width(),y:a.y+c.bounds.height()}};}return d;},updateGlossaryEntries:function(a){if(this.facade.hasGlossaryExtension&&this.facade.hasGlossary(a)){a.getStencil().properties().each(function(c){var b=this.facade.getGlossary(a,c);if(b){[].concat(b).each(function(e){var d={};d.prop=c;d.glossary=e.glossary;d.text=e.text;d.shape=e.shape;if(!this.glossarProperties[e.shape.resourceId]){this.glossarProperties[e.shape.resourceId]=[];}this.glossarProperties[e.shape.resourceId].push(d);this.facade.setGlossary(a,c);}.bind(this));}}.bind(this));}},rollbackGlossaryEntryUpdate:function(a){if(this.facade.hasGlossaryExtension&&this.glossarProperties[a]){this.glossarProperties[a].each(function(b){this.facade.setGlossary(b.shape,b.prop,b.glossary,b.text,false);}.bind(this));}}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.KeysMove=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.copyElements=[];this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:65,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.selectAll.bind(this)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_LEFT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_LEFT,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_LEFT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_LEFT,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_RIGHT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_RIGHT,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_RIGHT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_RIGHT,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_UP,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_UP,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_UP,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_UP,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_DOWN,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_DOWN,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_DOWN,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_DOWN,true)});},selectAll:function(a){Event.stop(a.event);this.facade.setSelection(this.facade.getCanvas().getChildShapes(true));},move:function(o,k,l){Event.stop(l.event);var b=k?20:1;var n=this.facade.getSelection();var g=this.facade.getSelection();var c={x:0,y:0};switch(o){case ORYX.CONFIG.KEY_CODE_LEFT:c.x=-1*b;break;case ORYX.CONFIG.KEY_CODE_RIGHT:c.x=b;break;case ORYX.CONFIG.KEY_CODE_UP:c.y=-1*b;break;case ORYX.CONFIG.KEY_CODE_DOWN:c.y=b;break;}var m=false;n=n.findAll(function(e){if(!(e instanceof ORYX.Core.Node)){return true;}else{if(e.getStencil().namespace()!=="http://b3mn.org/stencilset/bpmn2.0#"){return true;}else{if(!e.getStencil().idWithoutNs().endsWith("Lane")){return true;}}}return false;});n=n.findAll(function(q){if(q instanceof ORYX.Core.Node&&q.dockers.length==1&&q.dockers.first().getDockedShape()){return false;}var t=q.parent;do{if(n.include(t)){return false;}}while(t=t.parent);if(!(q.parent instanceof ORYX.Core.Canvas)){var p=q.parent.bounds;var v=p.upperLeft();var u=p.lowerRight();var r=q.bounds.upperLeft();var e=q.bounds.lowerRight();var x={ul:{x:r.x+c.x,y:r.y+c.y},lr:{x:e.x+c.x,y:e.y+c.y}};if(x.ul.x<0||x.lr.x>p.width()||x.ul.y<0||x.lr.y>p.height()){m=true;throw $break;}}return true;});if(m){return;}var f=true;var h=n.all(function(e){if(e instanceof ORYX.Core.Edge){if(e.isDocked()){f=false;}return true;}return false;});if(h&&!f){return;}n=n.map(function(p){if(p instanceof ORYX.Core.Node){return p;}else{if(p instanceof ORYX.Core.Edge){var e=p.dockers;if(n.include(p.dockers.first().getDockedShape())){e=e.without(p.dockers.first());}if(n.include(p.dockers.last().getDockedShape())){e=e.without(p.dockers.last());}return e;}else{return null;}}}).flatten().compact();if(n.size()>0){var a=[this.facade.getCanvas().bounds.lowerRight().x,this.facade.getCanvas().bounds.lowerRight().y,0,0];n.each(function(e){a[0]=Math.min(a[0],e.bounds.upperLeft().x);a[1]=Math.min(a[1],e.bounds.upperLeft().y);a[2]=Math.max(a[2],e.bounds.lowerRight().x);a[3]=Math.max(a[3],e.bounds.lowerRight().y);});if(a[0]+c.x<0){c.x=-a[0];}if(a[1]+c.y<0){c.y=-a[1];}if(a[2]+c.x>this.facade.getCanvas().bounds.lowerRight().x){c.x=this.facade.getCanvas().bounds.lowerRight().x-a[2];}if(a[3]+c.y>this.facade.getCanvas().bounds.lowerRight().y){c.y=this.facade.getCanvas().bounds.lowerRight().y-a[3];}if(c.x!=0||c.y!=0){var d=[new ORYX.Core.Command.Move(n,c,null,g,this)];this.facade.executeCommands(d);}}},getUndockedCommant:function(b){var a=ORYX.Core.Command.extend({construct:function(c){this.dockers=c.collect(function(d){return d instanceof ORYX.Core.Controls.Docker?{docker:d,dockedShape:d.getDockedShape(),refPoint:d.referencePoint}:undefined;}).compact();},execute:function(){this.dockers.each(function(c){c.docker.setDockedShape(undefined);});},rollback:function(){this.dockers.each(function(c){c.docker.setDockedShape(c.dockedShape);c.docker.setReferencePoint(c.refPoint);});}});command=new a(b);command.execute();return command;}});if(!ORYX.Plugins){ORYX.Plugins={};}if(!ORYX.Plugins.Layouter){ORYX.Plugins.Layouter={};}new function(){ORYX.Plugins.Layouter.EdgeLayouter=ORYX.Plugins.AbstractLayouter.extend({layouted:["http://b3mn.org/stencilset/bpmn1.1#SequenceFlow","http://b3mn.org/stencilset/bpmn1.1#MessageFlow","http://b3mn.org/stencilset/timjpdl3#SequenceFlow","http://b3mn.org/stencilset/jbpm4#SequenceFlow","http://b3mn.org/stencilset/bpmn2.0#MessageFlow","http://b3mn.org/stencilset/bpmn2.0#SequenceFlow","http://b3mn.org/stencilset/bpmn2.0choreography#MessageFlow","http://b3mn.org/stencilset/bpmn2.0choreography#SequenceFlow","http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink","http://b3mn.org/stencilset/epc#ControlFlow","http://www.signavio.com/stencilsets/processmap#ProcessLink","http://www.signavio.com/stencilsets/organigram#connection","http://b3mn.org/stencilset/UML2.2Class#"],layout:function(a){a.each(function(b){this.doLayout(b);}.bind(this));},doLayout:function(b){var d=b.getIncomingNodes()[0];var c=b.getOutgoingNodes()[0];if(!d||!c){return;}var a=this.getPositions(d,c,b);if(a.length>0){this.setDockers(b,a[0].a,a[0].b);}},getPositions:function(v,f,k){var z=v.absoluteBounds();var h=f.absoluteBounds();var A=z.center();var y=h.center();var t=z.midPoint();var e=h.midPoint();var x=k.getStencil().keepState();if(x&&k.dockers.length<=3){var d=v.getOverlap(f);if(d){var c=Math.round(Math.min(z.lowerRight().x,h.lowerRight().x)-Math.max(z.upperLeft().x,h.upperLeft().x));var r=Math.round(Math.min(z.lowerRight().y,h.lowerRight().y)-Math.max(z.upperLeft().y,h.upperLeft().y));var g=12;if(c>g||r>g){var C=k.dockers.first().getAbsoluteReferencePoint();var u=k.dockers.last().getAbsoluteReferencePoint();if(d.isIncluded({x:c>0?C.x:d.center().x,y:c>0?d.center().y:C.y})&&d.isIncluded({x:c>0?u.x:d.center().x,y:c>0?d.center().y:u.y})){return[];}}else{k.dockers.first().setReferencePoint(t);k.dockers.last().setReferencePoint(e);}}}var l=Object.clone(k.dockers.first().referencePoint);var p=Object.clone(k.dockers.last().referencePoint);var o=k.dockers.first().getAbsoluteReferencePoint();var q=k.dockers.last().getAbsoluteReferencePoint();if(Math.abs(o.x-q.x)<1||Math.abs(o.y-q.y)<1){return[];}var s={};s.x=A.x<y.x?(((y.x-h.width()/2)-(A.x+z.width()/2))/2)+(A.x+z.width()/2):(((A.x-z.width()/2)-(y.x+h.width()/2))/2)+(y.x+h.width()/2);s.y=A.y<y.y?(((y.y-h.height()/2)-(A.y+z.height()/2))/2)+(A.y+z.height()/2):(((A.y-z.height()/2)-(y.y+h.height()/2))/2)+(y.y+h.height()/2);z.widen(5);h.widen(20);var n=[];var B=this.getOffset.bind(this);if(!z.isIncluded(y.x,A.y)&&!h.isIncluded(y.x,A.y)){n.push({a:{x:y.x+B(p,e,"x"),y:A.y+B(l,t,"y")},z:this.getWeight(v,A.x<y.x?"r":"l",f,A.y<y.y?"t":"b",k)*(x?2:1)});}if(!z.isIncluded(A.x,y.y)&&!h.isIncluded(A.x,y.y)){n.push({a:{x:A.x+B(l,t,"x"),y:y.y+B(p,e,"y")},z:this.getWeight(v,A.y<y.y?"b":"t",f,A.x<y.x?"l":"r",k)*(x?2:1)});}if(!z.isIncluded(s.x,A.y)&&!h.isIncluded(s.x,y.y)){n.push({a:{x:s.x,y:A.y+B(l,t,"y")},b:{x:s.x,y:y.y+B(p,e,"y")},z:this.getWeight(v,"r",f,"l",k,A.x>y.x)});}if(!z.isIncluded(A.x,s.y)&&!h.isIncluded(y.x,s.y)){n.push({a:{x:A.x+B(l,t,"x"),y:s.y},b:{x:y.x+B(p,e,"x"),y:s.y},z:this.getWeight(v,"b",f,"t",k,A.y>y.y)});}return n.sort(function(D,m){return D.z<m.z?1:(D.z==m.z?0:-1);});},getOffset:function(c,b,a){return c[a]-b[a];},getWeight:function(n,b,o,a,d,h){b=(b||"").toLowerCase();a=(a||"").toLowerCase();if(!["t","r","b","l"].include(b)){b="r";}if(!["t","r","b","l"].include(a)){b="l";}if(h){b=b=="t"?"b":(b=="r"?"l":(b=="b"?"t":(b=="l"?"r":"r")));a=a=="t"?"b":(a=="r"?"l":(a=="b"?"t":(a=="l"?"r":"r")));}var g=0;var e=this.facade.getCanvas().getOrientation();var q=this.facade.getRules().getLayoutingRules(n,d,e)["out"];var p=this.facade.getRules().getLayoutingRules(o,d,e)["in"];var f=q[b];var c=p[a];var m=function(t,s,r){switch(t){case"t":return Math.abs(s.x-r.x)<2&&s.y<r.y;case"r":return s.x>r.x&&Math.abs(s.y-r.y)<2;case"b":return Math.abs(s.x-r.x)<2&&s.y>r.y;case"l":return s.x<r.x&&Math.abs(s.y-r.y)<2;default:return false;}};var l=n.getIncomingShapes().findAll(function(r){return r instanceof ORYX.Core.Edge;}).any(function(r){return m(b,r.dockers[r.dockers.length-2].bounds.center(),r.dockers.last().bounds.center());});var k=o.getOutgoingShapes().findAll(function(r){return r instanceof ORYX.Core.Edge;}).any(function(r){return m(a,r.dockers[1].bounds.center(),r.dockers.first().bounds.center());});return(l||k?0:f+c);},setDockers:function(e,d,c){if(!e){return;}e.dockers.each(function(a){e.removeDocker(a);});[d,c].compact().each(function(b){var a=e.createDocker(undefined,b);a.bounds.centerMoveTo(b);});e.dockers.each(function(a){a.update();});e._update(true);}});}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.SyntaxChecker=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.active=false;this.raisedEventIds=[];this.facade.offer({"name":ORYX.I18N.SyntaxChecker.name,"functionality":this.perform.bind(this),"group":ORYX.I18N.SyntaxChecker.group,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/chart_curve_error.png","description":ORYX.I18N.SyntaxChecker.desc,"index":0,"toggle":true,"minShape":0,"maxShape":0});this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,this.checkForErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT,this.resetErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,this.doShowErrors.bind(this));},perform:function(a,b){if(!b){this.resetErrors();}else{this.checkForErrors({onNoErrors:function(){this.setActivated(a,false);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.noErrors,timeout:10000});}.bind(this),onErrors:function(){this.enableDeactivationHandler(a);}.bind(this),onFailure:function(){this.setActivated(a,false);Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SyntaxChecker.invalid);}.bind(this)});}},enableDeactivationHandler:function(a){var b=function(){this.setActivated(a,false);this.resetErrors();this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b);};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b.bind(this));},setActivated:function(b,a){b.toggle(a);if(a===undefined){this.active=!this.active;}else{this.active=a;}},checkForErrors:function(b){Ext.applyIf(b||{},{showErrors:true,onErrors:Ext.emptyFn,onNoErrors:Ext.emptyFn,onFailure:Ext.emptyFn});Ext.Msg.wait(ORYX.I18N.SyntaxChecker.checkingMessage);var c=this.facade.getStencilSets();var d=null;var a=ORYX.CONFIG.SYNTAXCHECKER_URL;var e={resource:location.href,context:b.context,isJson:false};if(c.keys().include("http://b3mn.org/stencilset/bpmn2.0#")||c.keys().include("http://b3mn.org/stencilset/bpmn2.0choreography#")||c.keys().include("http://b3mn.org/stencilset/bpmn2.0conversation#")){e.data_json=this.facade.getSerializedJSON();e.ns="http://b3mn.org/stencilset/bpmn2.0#";e.isJson=true;}else{if(c.keys().include("http://b3mn.org/stencilset/epc#")){e.data_json=this.facade.getSerializedJSON();e.ns="http://b3mn.org/stencilset/epc#";e.isJson=true;}else{e.data=this.getRDFFromDOM();}}new Ajax.Request(a,{method:"POST",asynchronous:false,parameters:e,onSuccess:function(f){var g=(f&&f.responseText?f.responseText:"{}").evalJSON();Ext.Msg.hide();if(g instanceof Object){g=$H(g);if(g.size()>0){if(b.showErrors){this.showErrors(g);}b.onErrors();}else{b.onNoErrors();}}else{b.onFailure();}}.bind(this),onFailure:function(){Ext.Msg.hide();b.onFailure();}});},doShowErrors:function(b,a){this.showErrors(b.errors);},showErrors:function(a){if(!(a instanceof Hash)){a=new Hash(a);}a.keys().each(function(c){var b=this.facade.getCanvas().getChildShapeByResourceId(c);if(b){this.raiseOverlay(b,this.parseCodeToMsg(a[c]));}}.bind(this));this.active=!this.active;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.notice,timeout:10000});},parseCodeToMsg:function(e){var f=e.replace(/: /g,"<br />").replace(/, /g,"<br />");var a=f.split("<br />");for(var b=0;b<a.length;b++){var d=a[b];var c=this.parseSingleCodeToMsg(d);if(d!=c){f=f.replace(d,c);}}return f;},parseSingleCodeToMsg:function(a){return ORYX.I18N.SyntaxChecker[a]||a;},resetErrors:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));this.raisedEventIds=[];this.active=false;},raiseOverlay:function(a,b){var f="syntaxchecker."+this.raisedEventIds.length;var d=ORYX.Editor.provideId();var e=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"id":d,"title":"","stroke-width":5,"stroke":"red","d":"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:f,shapes:[a],node:e,nodePosition:a instanceof ORYX.Core.Edge?"START":"NW"});var c=new Ext.ToolTip({showDelay:50,html:b,target:d});this.raisedEventIds.push(f);return e;}});ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT="checkForErrors";ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT="resetErrors";ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT="showErrors";ORYX.Plugins.PetrinetSyntaxChecker=ORYX.Plugins.SyntaxChecker.extend({getRDFFromDOM:function(){return this.facade.getERDF();}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}new function(){var b=[];var c=["http://b3mn.org/stencilset/bpmn2.0#CollapsedPool","http://b3mn.org/stencilset/bpmn2.0#CollapsedVerticalPool"];var a=function(d,e){this.x=(arguments.length===1&&arguments[0].x!==undefined?arguments[0].x:arguments[0])||0;this.y=(arguments.length===1&&arguments[0].y!==undefined?arguments[0].y:arguments[1])||0;};a.prototype.moveBy=function(){return new a(this.x+(arguments.length===1&&arguments[0].x!==undefined?arguments[0].x:arguments[0])||0,this.y+(arguments.length===1&&arguments[0].y!==undefined?arguments[0].y:arguments[1])||0);};a.prototype.castToInts=function(){return new a(Math.round(this.x),Math.round(this.y));};ORYX.Plugins.Shorten=ORYX.Plugins.AbstractPlugin.extend({construct:function(d){this.facade=d;this.facade.offer({name:ORYX.I18N.Functionality.shortenTitle,description:ORYX.I18N.Functionality.shortenDescription,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/transform_selection.png",functionality:function(e,f){if(!f){this.disableShorten();}else{this.enableShorten();}if(e){this.toggleButton=e;}}.bind(this),group:ORYX.I18N.Arrangement.groupA,index:9,toggle:true,keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:77,keyAction:ORYX.CONFIG.KEY_ACTION_UP}]});Ext.getDoc().on("keyup",function(f){if(f.keyCode===27&&this.enabled){this.disableShorten();this.toggleButton.toggle(false);}}.bind(this));this.initLines();this.canvas=Ext.get(this.facade.getCanvas().node.parentNode.parentNode);},initLines:function(){this.vLine=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_VERTICAL);this.hLine=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_HORIZONTAL);this.dLine=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_VERTICAL);this.dLine.line.setAttributeNS(null,"stroke","black");},onSelectionChanged:function(){if(this.enabled&&this.facade.getSelection().length>0){this.facade.setSelection([]);}},enableShorten:function(){if(this.enabled){return;}Ext.getDoc().on("mousemove",this.handleMouseMove,this);Ext.getDoc().on("mouseup",this.deactivateShorten,this);this.canvas.on("mousedown",this.activateShorten,this);this.disableEditorEvents();this.facade.setSelection([]);this.enabled=true;this.canvas.setStyle({"cursor":"move"});},disableShorten:function(){if(!this.enabled){return;}this.deactivateShorten();delete this.enabled;delete this.lastEvent;this.vLine.hide();this.hLine.hide();this.dLine.hide();Ext.getDoc().un("mousemove",this.handleMouseMove);Ext.getDoc().un("mouseup",this.deactivateShorten);this.canvas.un("mousedown",this.activateShorten);this.enableEditorEvents();this.canvas.setStyle({"cursor":"default"});if(this.toggleButton){this.toggleButton.toggle(false);}},snapOffset:function(f){if(!this.elements||!this.elementsPositions){return f;}var d=8;var e=45;this.elements.each(function(k){var h=this.elementsPositions[k].abs;var l=h.moveBy(f);var g=this.cachedPositions[k];if(g){g.each(function(m){if(Math.abs(l.y-m.lo.y-e)<d){f.y=-(h.y-m.lo.y-e);}else{if(Math.abs((l.y+k.bounds.height()/2)-m.ce.y)<d){f.y=-((h.y+k.bounds.height()/2)-m.ce.y);}}if(Math.abs(l.x-m.lo.x-e)<d){f.x=-(h.x-m.lo.x-e);}else{if(Math.abs((l.x+k.bounds.width()/2)-m.ce.x)<d){f.x=-((h.x+k.bounds.width()/2)-m.ce.x);}}});}}.bind(this));f.x=Math.abs(f.x)<d?0:f.x;f.y=Math.abs(f.y)<d?0:f.y;return f;},getOffset:function(e){var d={x:0,y:0};if(this.activate===ORYX.Core.GridLine.DIR_VERTICAL){d.x=e.x-this.startPosition.x;}else{if(this.activate===ORYX.Core.GridLine.DIR_HORIZONTAL){d.y=e.y-this.startPosition.y;}}return this.snapOffset(d);},moveAbstractShape:function(g,k,f,e){var h=g.bounds.upperLeft();var d={x:f.x+k.x,y:f.y+k.y};if(h.x!==d.x||h.y!==d.y){g.bounds.moveTo(d);return true;}return false;},moveElements:function(f){if(!this.activate||!this.startPosition||!this.elements){return;}var e=this.facade.getCanvas().bounds.lowerRight();var d=false;this.elements.each(function(l){var m={x:this.elementsPositions[l].rel.x+f.x-l.bounds.upperLeft().x,y:this.elementsPositions[l].rel.y+f.y-l.bounds.upperLeft().y};if(l.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Lane"){if(m.y<0){var k=l.getParentShape();var n=(this.getPoolLaneMinSize(k).height-k.bounds.height());m.y=Math.max(n,m.y);}}else{if(l.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalLane"){if(m.x<0){var k=l.getParentShape();var g=(this.getPoolLaneMinSize(k).width-k.bounds.width());m.x=Math.max(g,m.x);}}}var h={x:m.x-this.elementsPositions[l].rel.x+l.bounds.upperLeft().x,y:m.y-this.elementsPositions[l].rel.y+l.bounds.upperLeft().y};if(this.moveAbstractShape(l,h,this.elementsPositions[l].rel,e)){l._update();d=true;}}.bind(this));},getPoolLaneMinSize:function(f){var e=f.getParentShape();if(e.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Pool"||e.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Lane"){var d=this.getAggregatedMinSize(f);var g=this.getAggregatedMinSize(e);return{width:g.width-f.bounds.upperLeft().x,height:d.height};}else{if(e.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalPool"||e.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalLane"){var d=this.getAggregatedMinSize(f);var g=this.getAggregatedMinSize(e);return{width:d.width,height:g.height-f.bounds.upperLeft().y};}else{return this.getAggregatedMinSize(f);}}},getAggregatedMinSize:function(e){var h=e.minimumSize||{width:ORYX.CONFIG.MINIMUM_SIZE,height:ORYX.CONFIG.MINIMUM_SIZE};var k=0;var g=0;var d=0;var f=0;e.getChildNodes(false).each((function(o){if(o.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Lane"){if(!this.containers.include(o)){g+=o.bounds.height();}else{var m=this.getAggregatedMinSize(o);g+=m.height;var n=o.bounds.upperLeft().x+m.width;if(n>d){d=n;}}}else{if(o.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalLane"){if(!this.containers.include(o)){k+=o.bounds.width();}else{var m=this.getAggregatedMinSize(o);k+=m.width;var l=o.bounds.upperLeft().y+m.height;if(l>f){f=l;}}}}}).bind(this));h.width=Math.max(d,k,h.width);h.height=Math.max(f,g,h.height);return h;},resizeContainers:function(d){if(!this.activate||!this.containers){return;}this.containers.each(function(f){var h=this.containersSizes[f];var g=f.minimumSize||{width:ORYX.CONFIG.MINIMUM_SIZE,height:ORYX.CONFIG.MINIMUM_SIZE};var l=f.maximumSize||{width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE};if(f.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Pool"||f.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Lane"||f.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalPool"||f.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalLane"){g=this.getPoolLaneMinSize(f);}var k={x:(h.width+d.x>l.width)?(l.width-h.width):((h.width+d.x<g.width)?(g.width-h.width):d.x),y:(h.height+d.y>l.height)?(l.height-h.height):((h.height+d.y<g.height)?(g.height-h.height):d.y)};var e={x:h.width+k.x-f.bounds.width(),y:h.height+k.y-f.bounds.height()};f.bounds.extend(e);this.moveContainersDockers(f,this.containersDockers,k,this.containersDockersPositions);f._update();f.outgoing.each(function(m){if(m instanceof ORYX.Core.Node){m._update();}});}.bind(this));},moveContainersDockers:function(e,h,g,f){var d=e.incoming.map(function(k){return k.dockers.last();}).concat(e.outgoing.map(function(k){return k.dockers.first();}));d.each(function(m){var l=f.find(function(n){return n.key==m;}).value;if(h.include(m)){var k={x:l.x+g.x,y:l.y+g.y};m.setDockedShape(e);m.setReferencePoint(k);}else{m.setDockedShape(e);m.setReferencePoint({x:l.x,y:l.y});if(m.referencePoint.x>e.bounds.width()){m.setReferencePoint({x:e.bounds.width(),y:m.referencePoint.y});}if(m.referencePoint.y>e.bounds.height()){m.setReferencePoint({x:m.referencePoint.x,y:e.bounds.height()});}}});},handleMouseMove:function(d){var f=this.getNormalizedXY(d);this.lastEvent=d;if(this.activate&&this.startPosition&&this.elements){var e=this.getOffset(f);this.moveElements(e);this.resizeContainers(e);if(this.activate!==true){if(this.activate===ORYX.Core.GridLine.DIR_VERTICAL){this.dLine.update(this.startPosition.x+e.x);}else{if(this.activate===ORYX.Core.GridLine.DIR_HORIZONTAL){this.dLine.update(this.startPosition.y+e.y);}}}}else{if(!this.activate||this.activate===ORYX.Core.GridLine.DIR_VERTICAL){this.vLine.update(f.x);}if(!this.activate||this.activate===ORYX.Core.GridLine.DIR_HORIZONTAL){this.hLine.update(f.y);}}},handleMouseMoveToDecideDirection:function(f){var k=this.getNormalizedXY(f);var h=5;var e=Math.abs(k.x-this.startPosition.x);var d=Math.abs(k.y-this.startPosition.y);var g=ORYX.Core.Math.getDistancePointToPoint(k,this.startPosition);if(g>h){if(e>=d){this.activateVerticalShorten();}else{this.activateHorizontalShorten();}this.beforeShorten();Ext.getDoc().un("mousemove",this.handleMouseMoveToDecideDirection);}},activateShorten:function(d){Event.stop(d);if(this.activate){return;}this.activate=true;this.startPosition=this.getNormalizedXY(d);Ext.getDoc().on("mousemove",this.handleMouseMoveToDecideDirection,this);},deactivateShorten:function(d){if(this.activate&&(d||this.lastEvent)){this.afterShorten(this.getNormalizedXY(d||this.lastEvent));}delete this.activate;delete this.elements;delete this.elementsPositions;delete this.cachedPositions;delete this.edges;delete this.dockersPositions;Ext.getDoc().un("mousemove",this.handleMouseMoveToDecideDirection);this.canvas.setStyle({"cursor":"move"});this.dLine.hide();if(d){this.handleMouseMove(d);}},beforeShorten:function(){if(this.edges){this.edges.invoke("hide");}if(this.elements){this.elements.each(function(d){d.hideLabels();d.setOpacity(0.4);});this.containers.each(function(d){d.hideLabels();d.setOpacity(0.4);d.outgoing.each(function(e){if(e instanceof ORYX.Core.Node){e.hideLabels();e.setOpacity(0.4);}});});}},afterShorten:function(f){var e=this.getOffset(f);if(this.edges){this.edges.each(function(g){g.show();g.dockers.invoke("hide");g.getChildShapes().each(function(h){h.magnets.invoke("hide");});});}if(this.elements){this.elements.each(function(g){g.showLabels();g.setOpacity();});this.containers.each(function(g){g.showLabels();g.setOpacity();g.outgoing.each(function(h){if(h instanceof ORYX.Core.Node){h.showLabels();h.setOpacity();}});});var d=ORYX.Core.Command.extend({construct:function(g,p,q,h,l,o,m,k,n){this.shapes=g;this.shapesOffsets={};g.each((function(s){var r=s.absoluteXY();this.shapesOffsets[s]={x:r.x-p[s].abs.x,y:r.y-p[s].abs.y};}).bind(this));this.dockers=q.pluck("key").map(function(s){return{edge:s.parent,index:s.parent.dockers.indexOf(s)};});this.edges=g.map(function(r){return r.getAllDockedShapes();}).flatten().findAll(function(s){return s instanceof ORYX.Core.Edge;}).uniq();this.containers=h;this.offset=l;this.containersSizes=o;this.containersDockers=m;this.containersDockersPositions=k;this.facade=n.facade;this.plugin=n;},execute:function(){if(this.executedOnce){this.shapes.each(function(g){g.bounds.moveBy(this.shapesOffsets[g]);}.bind(this));this.containers.each((function(g){var h=g.bounds;var k=g.minimumSize||{width:ORYX.CONFIG.MINIMUM_SIZE,height:ORYX.CONFIG.MINIMUM_SIZE};var m=g.maximumSize||{width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE};if(g.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Pool"||g.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Lane"||g.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalPool"||g.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalLane"){k=this.plugin.getPoolLaneMinSize(g);}var l={x:(h.width()+this.offset.x>m.width)?(m.width-h.width()):((h.width()+this.offset.x<k.width)?(k.width-h.width()):this.offset.x),y:(h.height()+this.offset.y>m.height)?(m.height-h.height()):((h.height()+this.offset.y<k.height)?(k.height-h.height()):this.offset.y)};h.extend(l);this.plugin.moveContainersDockers(g,this.containersDockers,l,this.containersDockersPositions);}).bind(this));this.facade.getCanvas().update();}this.dockers.each(function(g){if(!g.edge||!g.edge.dockers[g.index]){return;}g.edge.dockers[g.index].bounds.moveBy(this.offset.x,this.offset.y);}.bind(this));this.removeDockers=this.edges.map(function(g){return g.removeUnusedDockers();});this.facade.getCanvas().update();this.facade.updateSelection();this.executedOnce=true;},rollback:function(){this.shapes.each(function(g){var h=this.shapesOffsets[g];g.bounds.moveBy(-h.x,-h.y);}.bind(this));this.containers.each((function(g){var h=this.containersSizes[g];var k={x:h.width-g.bounds.width(),y:h.height-g.bounds.height()};g.bounds.extend(k);}).bind(this));this.removeDockers.each(function(h,g){h.each(function(k){this.edges[g].add(k.value,k.key);}.bind(this));}.bind(this));this.dockers.each(function(g){if(!g.edge||!g.edge.dockers[g.index]){return;}g.edge.dockers[g.index].bounds.moveBy(-this.offset.x,-this.offset.y);}.bind(this));this.containersDockersPositions.each(function(k){var h=k.key;var g=k.value;h.setDockedShape(h.getDockedShape());h.setReferencePoint({x:g.x,y:g.y});});this.facade.getCanvas().update();this.facade.updateSelection();}});this.facade.executeCommands([new d(this.elements,this.elementsPositions,this.dockersPositions,this.containers,e,this.containersSizes,this.containersDockers,this.containersDockersPositions,this),new ORYX.Core.EnsureChildCommand(this.facade,this.elements.concat(this.containers),true)]);}},isIncludedInShortenContainer:function(e){var d=e.getStencil().id();if(!this.facade.getRules().isContainer(e)&&!c.include(d)){return false;}if(b.include(d)){return false;}return true;},activateVerticalShorten:function(){this.activate=ORYX.Core.GridLine.DIR_VERTICAL;this.hLine.hide();this.dLine.direction=ORYX.Core.GridLine.DIR_VERTICAL;var d=this.startPosition.x;var g=this.facade.getCanvas().getChildNodes(true);var e=g.findAll(function(k){return k.absoluteXY().x>=d;});var f=g.findAll((function(l){if(!this.isIncludedInShortenContainer(l)){return false;}var k=l.absoluteBounds();return(k.upperLeft().x<=d)&&(k.lowerRight().x>=d);}).bind(this));this.excludeAttachedNodesFromMoving(e,f);this.selectLanesToBeResized(e,f);var h=[];f.each((function(l){this.fixReferencePoints(l,e);var k=l.incoming.map(function(m){return m.dockers.last();}).concat(l.outgoing.map(function(m){return m.dockers.first();}));k.each(function(n){var m=n.getAbsoluteReferencePoint();if(m.x>=d){h.push(n);}});}).bind(this));this.canvas.setStyle({"cursor":"e-resize"});this.setElements(e,f,h,g);},activateHorizontalShorten:function(){this.activate=ORYX.Core.GridLine.DIR_HORIZONTAL;this.vLine.hide();this.dLine.direction=ORYX.Core.GridLine.DIR_HORIZONTAL;var h=this.startPosition.y;var f=this.facade.getCanvas().getChildNodes(true);var d=f.findAll(function(k){return k.absoluteXY().y>=h;});var e=f.findAll((function(l){if(!this.isIncludedInShortenContainer(l)){return false;}var k=l.absoluteBounds();return(k.upperLeft().y<=h)&&(k.lowerRight().y>=h);}).bind(this));this.excludeAttachedNodesFromMoving(d,e);this.selectVerticalLanesToBeResized(d,e);var g=[];e.each((function(l){this.fixReferencePoints(l,d);var k=l.incoming.map(function(m){return m.dockers.last();}).concat(l.outgoing.map(function(m){return m.dockers.first();}));k.each(function(n){var m=n.getAbsoluteReferencePoint();if(m.y>=h){g.push(n);}});}).bind(this));this.canvas.setStyle({"cursor":"s-resize"});this.setElements(d,e,g,f);},selectLanesToBeResized:function(e,f){var d=f.clone();d.each(function(g){if(g.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Pool"||g.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#Lane"){g.getChildShapes(true).each(function(h){if(h.getStencil().id()!="http://b3mn.org/stencilset/bpmn2.0#Lane"){return;}if(e.include(h)){e.splice(e.indexOf(h),1);f.push(h);}});}});},selectVerticalLanesToBeResized:function(e,f){var d=f.clone();d.each(function(g){if(g.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalPool"||g.getStencil().id()=="http://b3mn.org/stencilset/bpmn2.0#VerticalLane"){g.getChildShapes(true).each(function(h){if(h.getStencil().id()!="http://b3mn.org/stencilset/bpmn2.0#VerticalLane"){return;}if(e.include(h)){e.splice(e.indexOf(h),1);f.push(h);}});}});},excludeAttachedNodesFromMoving:function(d,e){var f=this.facade.getCanvas().getChildNodes(true);f.each(function(g){if(d.include(g)){return;}if(e.include(g)){return;}g.outgoing.each(function(h){if(h instanceof ORYX.Core.Node){if(d.include(h)){d.splice(d.indexOf(h),1);}}});});return d;},fixReferencePoints:function(d,e){d.outgoing.each(function(g){var f=undefined;if(g instanceof ORYX.Core.Node){if(e.include(g)){e.splice(e.indexOf(g),1);}var h=g.dockers.first();var k=h.bounds.center();if(!f){f=d.bounds;}h.setReferencePoint({x:k.x-f.upperLeft().x,y:k.y-f.upperLeft().y});}});},setElements:function(e,l,m,g){this.elements=this.facade.getCanvas().getShapesWithSharedParent(e);this.containers=l;var f=this.elements.concat(this.containers);this.elementsPositions={};f.each(function(n){this.elementsPositions[n]={rel:new a(n.bounds.upperLeft()),abs:new a(n.absoluteXY())};}.bind(this));this.containersSizes={};this.containers.each((function(n){this.containersSizes[n]={width:n.bounds.width(),height:n.bounds.height()};}).bind(this));this.containersDockers=m;this.containersDockersPositions=[];var k=this.containers.map(function(n){return n.outgoing.map(function(o){return o.dockers.first();}).concat(n.incoming.map(function(o){return o.dockers.last();}));}).flatten();k.each(function(n){this.containersDockersPositions.push({key:n,value:{x:n.referencePoint.x,y:n.referencePoint.y}});}.bind(this));this.edges=f.map(function(n){return[].concat(n,n.getChildNodes(true)).map(function(o){return o.getAllDockedShapes();});}).flatten().uniq().findAll(function(n){return n instanceof ORYX.Core.Edge;});this.cachedPositions={};this.edges.each(function(q){var r=q.getSource();var t=q.getTarget();if(!r||!t){return;}var o=r&&f.include(r);var p=t&&f.include(t);if(!o||!p){var n=o?t:r;var s=n.absoluteXY();if(!this.cachedPositions[o?r:t]){this.cachedPositions[o?r:t]=[];}this.cachedPositions[o?r:t].push({up:s,lo:{x:s.x+n.bounds.width(),y:s.y+n.bounds.height()},ce:{x:s.x+(n.bounds.width()/2),y:s.y+(n.bounds.height()/2)}});}}.bind(this));this.dockersPositions=[];var d=this.activate==ORYX.Core.GridLine.DIR_VERTICAL;var h=this.startPosition;this.edges.each(function(n){var o=(n.getSource()&&n.getTarget())?n.dockers.slice(1,n.dockers.length-1):(n.getSource()?n.dockers.slice(1,n.dockers.length):n.dockers.slice(0,n.dockers.length-1));o.each(function(r){var q=false;var p=r.bounds.center();if(d&&p.x>=h.x){q=true;}else{if(!d&&p.y>=h.y){q=true;}}if(q){this.dockersPositions.push({key:r,value:r.bounds.upperLeft()});}}.bind(this));}.bind(this));},getNormalizedXY:function(e){var g=e.getXY();var m={x:g[0],y:g[1]};var d=this.facade.getCanvas().node.getScreenCTM();if(Ext.isIE9){var k=Ext.fly(this.facade.getCanvas().getScrollNode().firstChild);d.e=k.getLeft()+4;d.f=k.getTop()+4;}m.x-=d.e;m.y-=d.f;m.x/=d.a;m.y/=d.d;var h=this.vLine.getScale();var f={x:0,y:0};var l=this.facade.getCanvas();m.x=Math.min((l.bounds.width()-f.x),m.x);m.y=Math.min((l.bounds.height()-f.y),m.y);return m;},editorEvents:[ORYX.CONFIG.EVENT_MOUSEOVER,ORYX.CONFIG.EVENT_MOUSEOUT,ORYX.CONFIG.EVENT_MOUSEDOWN],disableEditorEvents:function(){this.editorEvents.each(function(d){this.facade.disableEvent(d);}.bind(this));},enableEditorEvents:function(){this.editorEvents.each(function(d){this.facade.enableEvent(d);}.bind(this));}});}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Help=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.Help.help,"functionality":this.help.bind(this),"group":ORYX.I18N.Help.group,"icon":ORYX.PATH+"images/book_open.png","description":ORYX.I18N.Help.helpDesc,"index":2,"minShape":0,"maxShape":0});},help:function(){var b=(ORYX.I18N.Language==="de_DE")?ORYX.CONFIG.HELP_START_URL_DE:ORYX.CONFIG.HELP_START_URL;if(Ext.isIPad){window.open(b);return;}var c="<iframe src='"+b+"' class='x-help-iframe'></iframe>";c+='<br/><a class="x-help-a" target="_blank" href="'+b+'">'+ORYX.I18N.Help.openUGNewWindow+"</a>";var a=new Ext.Panel({height:"100%",width:"100%","html":c});var d=new Ext.Window({cls:"x-help",modal:true,title:ORYX.I18N.Help.help,items:[a],resizable:false,header:true,shadow:false,draggable:false});d.show();}});if(!Signavio){var Signavio=new Object();}if(!Signavio.Plugins){Signavio.Plugins=new Object();}new function(){var a={};a.VALID_TARGET_STENCILSETS={"http://b3mn.org/stencilset/bpmn1.1#":["http://b3mn.org/stencilset/bpmn1.1#","http://b3mn.org/stencilset/bpmn2.0#","http://b3mn.org/stencilset/epc#","http://www.signavio.com/stencilsets/processmap#","http://b3mn.org/stencilset/jbpm4#"],"http://b3mn.org/stencilset/epc#":["http://b3mn.org/stencilset/epc#","http://b3mn.org/stencilset/bpmn1.1#","http://b3mn.org/stencilset/bpmn2.0#","http://www.signavio.com/stencilsets/processmap#"],"http://b3mn.org/stencilset/bpmn2.0#":["http://b3mn.org/stencilset/bpmn2.0#","http://b3mn.org/stencilset/bpmn1.1#","http://b3mn.org/stencilset/epc#","http://www.signavio.com/stencilsets/processmap#","http://b3mn.org/stencilset/jbpm4#"],"http://b3mn.org/stencilset/bpmn2.0conversation#":["http://b3mn.org/stencilset/bpmn2.0#","http://b3mn.org/stencilset/bpmn2.0choreography#","http://b3mn.org/stencilset/bpmn2.0conversation#","http://b3mn.org/stencilset/jbpm4#"],"http://b3mn.org/stencilset/bpmn2.0choreography#":["http://b3mn.org/stencilset/bpmn2.0#","http://b3mn.org/stencilset/bpmn2.0choreography#","http://b3mn.org/stencilset/bpmn2.0conversation#","http://b3mn.org/stencilset/jbpm4#"],"http://www.signavio.com/stencilsets/processmap#":["http://www.signavio.com/stencilsets/processmap#","http://b3mn.org/stencilset/bpmn1.1#","http://b3mn.org/stencilset/bpmn2.0#","http://b3mn.org/stencilset/bpmn2.0choreography#","http://b3mn.org/stencilset/bpmn2.0conversation#","http://b3mn.org/stencilset/epc#"],"http://www.signavio.com/stencilsets/organigram#":["http://www.signavio.com/stencilsets/organigram#"],"http://www.signavio.com/stencilsets/UMLUseCase#":["http://b3mn.org/stencilset/bpmn2.0#","http://www.signavio.com/stencilsets/processmap#","http://www.signavio.com/stencilsets/UMLUseCase#","http://b3mn.org/stencilset/UML2.2Class#"]};a.DUMMY_SVG='<svg xmlns="http://www.w3.org/2000/svg" xmlns:oryx="http://oryx-editor.org" '+'width="1" height="1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svg="http://www.w3.org/2000'+'/svg"><defs/><g stroke="black" font-family="Verdana, sans-serif" font-size-adjust="none" font-style="normal"'+' font-variant="normal" font-weight="normal" line-heigth="normal" font-size="12"><g class="stencils" transform'+'="translate(0)"><g class="me"/><g class="children"/><g class="edge"/></g></g></svg>';var c={};c.execute=function(g,n,k,m,h){var l=n instanceof Array?n[0]:n;var f=n instanceof Array?n[1]:undefined;new Ajax.Request(g,{method:m||"get",parameters:k,requestHeaders:{"Accept":"application/json","Content-Type":"charset=UTF-8"},asynchronous:h===true,onSuccess:function(q){var o;try{o=q.responseText.evalJSON();}catch(p){o=q.responseText;}if(l instanceof Function){l(o,q);}},onFailure:function(o){if(f instanceof Function){f(o);}}});};var b={};Signavio.Plugins.Linking={facade:undefined,construct:function(g){this.facade=g;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.onLoaded.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,this.initLinking.bind(this));this.facade.registerOnEvent("showlinkingwindow",function(h){this.showWindow(h.shape,h.shape.getStencil().property(h.property));}.bind(this));var f=this.getStencilSetNamespace();if(f==="http://b3mn.org/stencilset/epc#"||f==="http://b3mn.org/stencilset/bpmn2.0#"||f==="http://b3mn.org/stencilset/bpmn2.0choreography#"){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.propertyChanged.bind(this));}Ext.apply(Ext.QuickTips.getQuickTip(),{showDelay:500,dismissDelay:false});},onLoaded:function(){this.facade.getCanvas().getChildNodes(true).each(function(f){this.initLinking({shape:f});}.bind(this));},initLinking:function(g){var f=g.shape;if(!(f instanceof ORYX.Core.Node)){return;}if(b[f.resourceId]){return;}else{b[f.resourceId]=true;}f.getStencil().properties().each(function(k){if(k.type()===ORYX.CONFIG.TYPE_DIAGRAM_LINK){var h=$A(f.node.getElementsByTagNameNS("http://www.w3.org/2000/svg","a"));k.refToView().each(function(m){var l=h.find(function(n){return n.getAttributeNS(null,"id")===f.id+m;});if(f.getStencil().id().indexOf("LinkEvent")!==-1){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ABOUT_TO_SAVE,function(){try{var n=Element.getElementsByClassName($(f.node),"link")[0];var p=n.parentNode.getBBox();f.setHiddenProperty("oryx-processlink_bounds",p.x+","+p.y+" "+(p.x+p.width)+","+(p.y+p.height));}catch(o){}});}if(l){this.initEvents(l,f,k);}}.bind(this));throw $break;}}.bind(this));},initEvents:function(f,g,h){Element.observe(f,"click",function(k){Event.stop(k);this.showWindow(g,h);}.bind(this));},getValue:function(f,g){return f.properties[g.prefix()+"-"+g.id()]||"";},showWindow:function(g,l){var h=this.getValue(g,l).trim();var k,f=false;if(h){k=this.getPreviewDialog(g,h,l);}else{k=this.getNewDialog(g,l);}if(this.checkToShowTaskList(g)){f=this.showTaskListDialog();}if(!f){k.show();}},getI18NValueForProperty:function(g,f){var h=ORYX.I18N.Language.toLowerCase().split("_").first();return g[f+"_"+h]||g[f]||"";},getStencilSetNamespace:function(){try{return this.facade.getModelMetaData().model.stencilset.namespace;}catch(f){return this.facade.getStencilSets().keys()[0];}},selectCurrentFolder:function(f){var g=this.facade.getModelMetaData().parent;c.execute("/p"+g+"/parents",function(k){var l=[].concat(k.pluck("href").reverse(),g);var h=f.root;var m=function(n){var o=n.findChild("identifier",l.shift());if(o){o.expand(false,true,m.bind(this,o));}else{n.select();}};m(f.root);},{},false,true);},getNewDialog:function(g,n,m){var u=this.getStencilSetsDefinitions();var t=a.VALID_TARGET_STENCILSETS[this.getStencilSetNamespace()];if(t&&t instanceof Array){u=u.findAll(function(A){return t.include(A.namespace)&&A.visible!==false;});u=u.sort(function(B,A){return t.indexOf(B.namespace)<t.indexOf(A.namespace)?-1:(t.indexOf(B.namespace)>t.indexOf(A.namespace)?1:0);});}var z=new Ext.form.FormPanel({hideLabels:true,bodyStyle:"padding:0px 0px 10px 20px;",border:false,items:u.map(function(B,A){return new Ext.form.Radio({boxLabel:this.getI18NValueForProperty(B,"title"),stencilset:B,checked:A==0,name:"x-establish-link-new-model"});}.bind(this))});var h,k;var x=new Ext.tree.TreeNode({identifier:"/directory",text:"Root",leaf:false,cls:"folder",draggable:false,expanded:true,dontSort:true});var v=new Ext.Panel({bodyStyle:"padding:5px 0px 0px 20px;",border:false,anchor:"100%",disabled:true,layout:"column",items:[new Ext.tree.TreePanel({style:"margin-right:5px;",height:150,width:200,x:20,y:0,loader:new d(),root:x,animate:true,autoScroll:true,useArrows:true,rootVisible:false,columnWidth:0.5,listeners:{render:function(){this.getLoader().requestData(this.root);this.getSelectionModel().on("selectionchange",function(B,A){if(A&&A.attributes.data&&A.attributes.data.rel=="mod"){v.items.get(1).setImg(ORYX.CONFIG.SERVER_HANDLER_ROOT+A.attributes.data.href+"/svg",A.attributes.data.rep.name);k.buttons[0].enable();}else{v.items.get(1).setImg();k.buttons[0].disable();}});}}}),new e({width:200,height:150,columnWidth:0.5})]});var o=function(){return v.items.get(0).getSelectionModel().getSelectedNode()&&v.items.get(0).getSelectionModel().getSelectedNode().attributes.data.rel==="mod";};var s,p=!(g.properties["oryx-name"]||g.properties["oryx-title"]);var r=0;var q=[new Ext.form.Radio({boxLabel:Signavio.I18N.Editor.Linking.CreateDiagram+" "+"<input class='x-link-title x-form-text' style='margin:2px;padding:1px;height:14px;' value='"+Signavio.Utils.escapeHTML((g.properties["oryx-name"]||g.properties["oryx-title"]||ORYX.I18N.Save.newProcess).gsub("'",""))+"'/>",checked:!m,name:"x-establish-link",listeners:{check:function(A,B){z.setDisabled(!B);h.items.get(1+r).setDisabled(!B);},render:function(){s=this.wrap.query("input.x-link-title")[0];if(s){$(s).observe("click",function(A){Event.stop(A);h.items.get(0).setValue(false);h.items.get(0+r).setValue(true);h.items.get(3+r).setValue(false);h.items.get(6+r).setValue(false);});}}}}),new Ext.form.Checkbox({style:"margin-left:40px;margin-bottom:10px;",boxLabel:Signavio.I18N.Editor.Linking.UseName+' <img src="'+ORYX.CONFIG.EXPLORER_PATH+'/src/img/famfamfam/information.png" ext:qtip="'+new Ext.XTemplate(Signavio.I18N.Editor.Linking.UseNameHint).apply({type:g.getStencil().title()})+'"/>',checked:p,listeners:{disable:function(){this.wrap?this.wrap.addClass("x-item-disabled"):null;},enable:function(){this.wrap?this.wrap.removeClass("x-item-disabled"):null;}}}),z,new Ext.form.Radio({boxLabel:Signavio.I18N.Editor.Linking.UseDiagram,name:"x-establish-link",listeners:{check:function(A,B){v.setDisabled(!B);h.items.get(5+r).setDisabled(!B);k.buttons[0].setDisabled(B&&!o());if(B&&!v.firstSelected){this.selectCurrentFolder(v.items.get(0));v.firstSelected=true;}}.bind(this)}}),v,new Ext.form.Checkbox({style:"margin-bottom:15px;margin-left:20px;",checked:p,disabled:true,boxLabel:Signavio.I18N.Editor.Linking.UseName+' <img src="'+ORYX.CONFIG.EXPLORER_PATH+'/src/img/famfamfam/information.png" ext:qtip="'+new Ext.XTemplate(Signavio.I18N.Editor.Linking.UseNameHint).apply({type:g.getStencil().title()})+'"/>',listeners:{disable:function(){this.wrap?this.wrap.addClass("x-item-disabled"):null;},enable:function(){this.wrap?this.wrap.removeClass("x-item-disabled"):null;}}}),new Ext.form.Radio({boxLabel:Signavio.I18N.Editor.Linking.UseLink,name:"x-establish-link",checked:!!m,listeners:{check:function(A,B){h.items.get(7+r).setDisabled(!B);}}}),new Ext.form.TextField({emptyText:"URL",anchor:"-20",value:m?m:"",disabled:true,style:"margin-left:20px;width:398px;",enableKeyEvents:true,prefixFileLocal:Ext.ux.form.UrlLinkFieldList.prototype.prefixFileLocal,prefixFileNetwork:Ext.ux.form.UrlLinkFieldList.prototype.prefixFileNetwork,prefixHTTP:Ext.ux.form.UrlLinkFieldList.prototype.prefixHTTP,getValue:function(){var A=Ext.form.TextField.prototype.getRawValue.call(this);if(Ext.ux.form.UrlLinkFieldList.prototype.isURL.call(this,A)){A=this.prefixHTTP+A;}return A;},listeners:{render:function(A){A.el.on("keyup",function(B){Ext.ux.form.UrlLinkFieldList.prototype.evaluateLokalURL.call(this);}.bind(this));}}})];var l,y=this;if(this.isTimExtensionLoaded()){r=1;l=new Ext.form.Radio({boxLabel:Signavio.I18N.Editor.Linking.TimTaskList+": "+"<a class='x-link-opence x-item-disabled' href=''>"+Signavio.I18N.Editor.Linking.TimTaskListLink+"</a>",checked:false,name:"x-establish-link",listeners:{check:function(B,C){z.setDisabled(!C);h.items.get(2).setDisabled(!C);var A=this.wrap.query("a.x-link-opence")[0];if(A&&C){A.removeClassName("x-item-disabled");}else{if(A&&!C){A.addClassName("x-item-disabled");}}},render:function(){var A=this.wrap.query("a.x-link-opence")[0];if(A){$(A).observe("click",function(B){Event.stop(B);if(l.checked){y.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW_DIALOG,propertyKey:"oryx-tasks"});h.ownerCt.close();}});}}}});q=[l].concat(q);}h=new Ext.form.FormPanel({hideLabels:true,border:false,bodyStyle:"padding:10px;overflow-x:hidden;overflow-y:auto;",layout:"anchor",anchor:"100% 100%",items:q});var f=function(){if(!z||!z.body){return;}var C=k.el.getHeight();var B=r;while(B){h.items.get(B-1).setHeight(22);B--;}h.items.get(0+r).setHeight(22);var A=z.body.getHeight()+233;v.items.get(0).setHeight(Math.max(200,C-A));v.items.get(1).setHeight(Math.max(200,C-A));h.syncSize();};k=new Ext.Window({title:Signavio.I18N.Editor.Linking.CreateTitle,cls:"x-window-linking-establish",items:[h],width:Math.max((window.innerWidth||document.body.offsetWidth||0)*0.5,460),height:Math.max((window.innerHeight||document.body.offsetHeight||0)*0.85,420+50),minWidth:460,minHeight:420,layout:"anchor",modal:true,listeners:{resize:f,show:f},buttons:[{text:Signavio.I18N.Editor.Linking.ButtonLink,handler:function(A){A.disable();if(h.items.get(0+r).checked){var B=(h.items.get(2+r).items.items.find(function(C){return C.checked;})||{}).stencilset;if(B){this.createNewModelAndLink(g,n,B,(s||{}).value||"",h.items.get(1+r).checked);}}else{if(h.items.get(3+r).checked){if(!o()){Ext.Msg.alert(ORYX.I18N.Oryx.title,Signavio.I18N.Editor.Linking.AlertSelectModel);return;}this.createLinkWithAvailableModel(g,n,v.items.get(0).getSelectionModel().getSelectedNode().attributes.data,h.items.get(5+r).checked);}else{if(h.items.get(6+r).checked){this.setLink(g,n,h.items.get(7+r).getValue());}else{throw new Error("Something has to be selected");}}}A.ownerCt.close();}.bind(this)},{text:Signavio.I18N.Editor.Linking.Cancel,handler:function(){this.ownerCt.close();}}]});return k;},createNewModelAndLink:function(l,r,m,o,g){var h=m.stencilset||m.namespace;var n=m.extensions||[];var p=this.facade.getModelMetaData().parent;var f=ORYX.CONFIG.SERVER_EDITOR_CREATE_HANDLER+"?stencilset="+h.replace(/#/g,"%23")+"&directory="+p;var q;this.doRequest(f,function(u,t){q=t.getResponseHeader("Location").split("=").last();});if(!q){Ext.Msg.alert("Signavio","Request went wrong!");return;}var k={};k.name=(o||"").trim()||(l.properties["oryx-name"]||l.properties["oryx-title"]||"").trim()||ORYX.I18N.Save.newProcess;k.parent="/directory/"+p;k.svg_xml=a.DUMMY_SVG;k.json_xml='{"stencilset":{"namespace":"'+h+'"},"ssextensions":'+n.toJSON()+', "id":"canvas","resourceId":"canvas","properties":{}}';k.id=q;k.type=m.title;k.description="";k.comment="";k.namespace=h;this.doRequest(ORYX.CONFIG.SERVER_MODEL_HANDLER,function(){},k,"post");var s=window.location.protocol+"//"+window.location.host+"/"+ORYX.CONFIG.SERVER_MODEL_HANDLER.replace("../","")+"/"+q;this.setLink(l,r,s,g?k.name||undefined:undefined);window.setTimeout(function(){window.open(ORYX.CONFIG.SERVER_EDITOR_HANDLER+"?id="+q);},100);},createLinkWithAvailableModel:function(f,l,k,h){var g=window.location.protocol+"//"+window.location.host+"/"+ORYX.CONFIG.SERVER_HANDLER_ROOT.replace("../","")+k.href;this.setLink(f,l,g,h?Signavio.Utils.unescapeHTML(Signavio.Utils.escapeHTML(k.rep.name||k.rep.title||""))||undefined:undefined);},setLink:function(h,l,k,g){var f=ORYX.Core.Command.extend({construct:function(q,p,o,n,t,s,r){this.shape=n;this.newVal=q;this.oldVal=p;this.property=t;this.selection=s;this.facade=r;this.oldName=o!==undefined?this.shape.properties["oryx-name"]||this.shape.properties["oryx-title"]||"":undefined;this.newName=o;},execute:function(){this.shape.setProperty(l.prefix()+"-"+l.id(),this.newVal+"");if(this.newName){if(this.shape.getStencil().property("oryx-name")!==undefined){this.shape.setProperty("oryx-name",this.newName);}else{if(this.shape.getStencil().property("oryx-title")!==undefined){this.shape.setProperty("oryx-title",this.newName);}}}this.shape.setProperty(l.prefix()+"-"+l.id(),this.newVal+"");this.facade.setSelection(this.selection);},rollback:function(){this.shape.setProperty(l.prefix()+"-"+l.id(),this.oldVal+"");if(this.oldName!==undefined){if(this.shape.getStencil().property("oryx-name")!==undefined){this.shape.setProperty("oryx-name",this.oldName);}else{if(this.shape.getStencil().property("oryx-title")!==undefined){this.shape.setProperty("oryx-title",this.oldName);}}}this.facade.setSelection(this.selection);}});var m=new f(k,this.getValue(h,l),g,h,l,this.facade.getSelection(),this.facade);this.facade.executeCommands([m]);},getPreviewDialog:function(n,g,o){var p;var f;switch(this.evaluateLink(g)){case 1:var m;var l=200;this.doRequest(g,[function(s){m=s;},function(r){l=r.status;}]);var k=(m||[]).find(function(s){return s.rel==="info";});if(403===l){p=Signavio.I18N.Editor.Linking.LinkNoAccess+" (<a href='#' class='x-link-delete'>"+Signavio.I18N.Editor.Linking.RemoveLink+"</a>, <a href='#' class='x-link-edit'>"+Signavio.I18N.Editor.Linking.EditLink+"</a>)";}else{if(!m||!k){p=Signavio.I18N.Editor.Linking.LinkUnavailable+" (<a href='#' class='x-link-delete'>"+Signavio.I18N.Editor.Linking.RemoveLink+"</a>, <a href='#' class='x-link-edit'>"+Signavio.I18N.Editor.Linking.EditLink+"</a>)";}else{var h=k.href.split("/")[2];p=Signavio.Utils.escapeHTML(k.rep.name)+" <i><small>"+k.rep.type+"</small></i>"+" (<a href='"+ORYX.CONFIG.SERVER_EDITOR_HANDLER+"?id="+h+"' class='x-link-open' target='_blank'>"+Signavio.I18N.Editor.Linking.OpenLink+"</a>, <a href='#' class='x-link-delete'>"+Signavio.I18N.Editor.Linking.RemoveLink+"</a>, <a href='#' class='x-link-edit'>"+Signavio.I18N.Editor.Linking.EditLink+"</a>)";f=new e({style:"margin-top:10px;",src:g+"/svg",imgTitle:k.rep.name,anchor:"100% -25"});}}break;case 2:g=Signavio.Utils.escapeHTML(g);p=g+" (<a href='"+g+"' class='x-link-open' target='_blank'>"+Signavio.I18N.Editor.Linking.OpenLink+"</a>, <a href='#' class='x-link-delete'>"+Signavio.I18N.Editor.Linking.RemoveLink+"</a>, <a href='#' class='x-link-edit'>"+Signavio.I18N.Editor.Linking.EditLink+"</a>)";f=new Ext.Panel({border:false,style:"margin-top:10px;",html:"<iframe src='"+g+"' style='width:100%;height:100%;border:1px solid silver;'/>",anchor:"100% -25"});break;case 0:default:p=Signavio.I18N.Editor.Linking.BrokenLink=" (<a href='#' class='x-link-delete'>"+Signavio.I18N.Editor.Linking.RemoveLink+"</a>, <a href='#' class='x-link-edit'>"+Signavio.I18N.Editor.Linking.EditLink+"</a>)";break;}var q=this;return new Ext.Window({title:Signavio.I18N.Editor.Linking.PreviewTitle,cls:"x-window-linking-establish",bodyStyle:"padding:10px;background:white;",layout:"anchor",items:[new Ext.Panel({border:false,html:p,afterRender:function(r){Ext.Panel.prototype.afterRender.apply(this,arguments);$A(this.body.query("a.x-link-delete")).each(function(s){Element.observe(s,"click",function(t){Event.stop(t);q.setLink(n,o,"");this.ownerCt.close();}.bind(this));}.bind(this));$A(this.body.query("a.x-link-edit")).each(function(s){Element.observe(s,"click",function(t){Event.stop(t);this.ownerCt.close();q.getNewDialog(n,o,q.getValue(n,o)).show();}.bind(this));}.bind(this));}}),f].compact(),minWidth:460,width:460,height:!!f?400:undefined,minHeight:!!f?300:undefined,buttons:[{text:Signavio.I18N.Editor.Linking.Close,handler:function(){this.ownerCt.close();}}]});},evaluateLink:function(f){if(!(f||"").trim()){return 0;}else{if(f.include(ORYX.CONFIG.SERVER_HANDLER_ROOT.replace("../","/")+"/model/")){return 1;}else{return 2;}}},getStencilSetsDefinitions:function(){if(!this.stencilsetDefinitions){var f;this.doRequest(ORYX.CONFIG.STENCIL_SETS_URL,function(g){f=g;});this.stencilsetDefinitions=f;}return this.stencilsetDefinitions;},doRequest:function(f,k,g,h){c.execute(f,k,g,h);},propertyChanged:function(h,k){if(h.name!=="oryx-entry"||!k instanceof ORYX.Core.Node){return;}var g=this.getStencilSetNamespace();var f=this.facade.getStencilSets().keys().include(g);if(f&&(g==="http://b3mn.org/stencilset/bpmn2.0#"||g==="http://b3mn.org/stencilset/bpmn2.0choreography#")){this.adjustLinkColor(h.value,k);}if(f&&g==="http://b3mn.org/stencilset/epc#"){if(h.value&&h.value.length>0&&h.value!="undefined"){this.show(k,h.value,function(){this.showWindow(k,k.getStencil().property(h.name));}.bind(this));}else{this.hide(k);}}},adjustLinkColor:function(k,f){if(f.getStencil().id().indexOf("LinkEvent")!==-1){try{var g=Element.getElementsByClassName($(f.node),"link")[0];if(g){if(k){g.setAttribute("fill","#99FF00");}else{g.setAttribute("fill","#FFFFFF");}}}catch(h){}}},show:function(f,g,l){var k=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{},["a",{"target":"_blank"},["path",{"style":"fill:white;stroke:grey;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72","d":"M0 1.44 L0 15.05 L11.91 15.05 L11.91 5.98 L7.37 1.44 L0 1.44 Z"}],["path",{"style":"stroke:grey;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72;fill:#EEEEEE;","transform":"translate(7.5, -8.5)","d":"M0 10.51 L0 15.05 L4.54 15.05"}],["path",{"style":"fill:silver;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72","transform":"translate(-3, -1)","d":"M0 8.81 L0 13.06 L5.95 13.06 L5.95 15.05 A50.2313 50.2313 -175.57 0 0 10.77 11.08 A49.9128 49.9128 -1.28 0 0 5.95 6.54 L5.95 8.81 L0 8.81 Z"}]]]);var h=k.childNodes[0];h.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",g);h.addEventListener("click",function(m){if(l){Event.stop(m);l(f,g);}},true);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"arissupport.urlref_"+f.id,shapes:[f],node:k,dontCloneNode:true,nodePosition:"SE"});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ABOUT_TO_SAVE,function(){f.setHiddenProperty("oryx-processlink_bounds",f.bounds.width()+","+f.bounds.height()+" "+(f.bounds.width()+12)+","+(f.bounds.height()+13));});},hide:function(f){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"arissupport.urlref_"+f.id});},checkToShowTaskList:function(f){var g;if(!f){return false;}if(!this.isTimExtensionLoaded()){return false;}g=f.properties["oryx-tasks"];if(g&&g.length>0){try{g=g.evalJSON();if(g&&g.totalCount>0){return true;}}catch(h){return false;}}return false;},showTaskListDialog:function(){if(!this.isTimExtensionLoaded()){return false;}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW_DIALOG,propertyKey:"oryx-tasks",forceExecution:true});return true;},isTimExtensionLoaded:function(){return this.facade.getStencilSets()["http://b3mn.org/stencilset/bpmn2.0#"]&&this.facade.getStencilSets()["http://b3mn.org/stencilset/bpmn2.0#"].extensions().keys().include("http://oryx-editor.org/stencilsets/extensions/bpmn2.0tim#");}};Signavio.Plugins.Linking=ORYX.Plugins.AbstractPlugin.extend(Signavio.Plugins.Linking);var e=function(){e.superclass.constructor.apply(this,arguments);};Ext.extend(e,Ext.Panel,{src:undefined,cls:"x-img-panel",onRender:function(){e.superclass.onRender.apply(this,arguments);ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.body.dom,["div",{"class":"x-info-model",style:"position:relative;width:100%;height:100%;overflow:hidden;"},["img",{"class":"x-msg-loading",style:"display:none;",src:ORYX.CONFIG.LIBS_PATH+"/ext-2.0.2/resources/images/default/tree/s.gif"}]]);this.img=this.body.last();this.img.setWidth("100%");this.img.dom.style.position="relative";this.img.dom.style.overflow="auto";var f=function(g){return g&&g.dom.naturalWidth&&g.dom.naturalHeight&&g.dom.naturalWidth===g.dom.width&&g.dom.width<=g.dom.parentNode.offsetWidth&&g.dom.naturalHeight===g.dom.height&&g.dom.height<=g.dom.parentNode.offsetHeight;};this.img.waiting=this.img.last();this.img.imgs={};this.img.showImg=function(k){if(!this.img.imgs[k]){var h="inline&_dc="+parseInt(Math.random()*10000000);h+="&"+$H(Ext.Ajax.getSecurityParameter()).map(function(l){return l.key+"="+l.value;}).join("&");var g=Ext.get(ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.img,["iframe",{"src":k+"?"+h,style:"width:100%;height:100%;background:white;display:none;"}]));this.img.waiting.show(true);g.on("load",function(){var l=g.dom.contentDocument.childNodes[0].width.baseVal.value;var m=g.dom.contentDocument.childNodes[0].height.baseVal.value;g.dom.contentDocument.childNodes[0].setAttribute("viewBox","0 0 "+l+" "+m);g.dom.contentDocument.childNodes[0].setAttribute("preserveAspectRatio","xMidYMid");g.dom.contentDocument.childNodes[0].style.width=g.dom.contentDocument.childNodes[0].style.height="100%";this.img.hideImg();g.show(true);this.img.shownImg=g;this.img.waiting.hide({useDisplay:true});}.bind(this));g.setVisibilityMode(Ext.Element.DISPLAY);this.img.imgs[k]=g;}else{if(this.img.shownImg===this.img.imgs[k]){return;}else{this.img.hideImg();this.img.imgs[k].show(true);this.img.shownImg=this.img.imgs[k];this.img[f(this.img.shownImg)?"removeClass":"addClass"]("x-scrollenable");}}}.bind(this);this.img.hideImg=function(){if(this.img.shownImg){this.img.shownImg.hide(true);delete this.img.shownImg;}}.bind(this);this.img.on("click",function(){if(this.img.hasClass("x-scrollenable")){this.img.toggleClass("x-scrollable");}}.bind(this));if(this.src){this.setImg(this.src,this.imgTitle);}},setImg:function(g,f){if(g===undefined){this.img.hideImg();}else{this.img.showImg(g);}}});var d=function(){d.superclass.constructor.apply(this,arguments);};Ext.extend(d,Ext.tree.TreeLoader,{dataUrl:true,requestData:function(f,g){if(f.attributes.identifier){c.execute(ORYX.CONFIG.SERVER_HANDLER_ROOT+f.attributes.identifier,function(h){window.setTimeout(this.doResponse.bind(this,f,g,h),10);}.bind(this),{q:Math.random().toFixed(10)});}},generateNodeData:function(f,g){if(f.attributes.dontSort!==true){g=g.sort(Signavio.Helper.BusinessObjectSortingFunction);}return g.map(function(k){if((k.rel!=="mod"&&k.rel!=="dir")||(k.rel==="dir"&&(k.rep.type==="trash"||k.rep.type==="internal"))){return null;}var h=f.attributes;return{text:Signavio.Utils.escapeHTML(Signavio.I18N.Repository.Folder[k.rep.type]||k.rep.name||h.value),cls:k.rel==="mod"?"model":"folder",leaf:k.rel!=="dir",singleClickExpand:h.singleClickExpand||false,identifier:k.href,data:k};}).compact();},doResponse:function(h,l,k){var f=this.generateNodeData(h,k);if(h.childNodes.length>0&&h.childNodes.length===f.length&&h.childNodes.all(function(m){return f.any(function(n){return m.attributes.identifier===n.identifier&&m.attributes.text===n.text;});})){return;}h.collapse();var g=h.childNodes.length-1;for(;g>=0;g--){h.childNodes[g].remove();}h.beginUpdate();f.each(function(m){h.appendChild(this.createNode(m));}.bind(this));h.endUpdate();window.setTimeout(function(){h.expand();},500);this.fireEvent("update",this,f);this.fireEvent("load",this,h);if(typeof l=="function"){l(this,h);}}});}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}new function(){ORYX.Plugins.BPMN11={construct:function(b){this.facade=b;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent("layout.bpmn11.pool",this.handleLayoutPool.bind(this));this.facade.registerOnEvent("layout.bpmn11.subprocess",this.handleSubProcess.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEREMOVED,this.handleShapeRemove.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this));this.stencilsetNs=b.getStencilSets().entries()[0][0];},afterLoad:function(){this.facade.getCanvas().getChildNodes().each(function(b){if(b.getStencil().id().endsWith("Pool")){this.handleLayoutPool({shape:b});}}.bind(this));},onSelectionChanged:function(g){var e=g.elements;if(e&&e.length===1){var b=e[0];if(b.getStencil().idWithoutNs()==="Pool"){if(b.getChildNodes().length===0){var d={type:this.stencilsetNs+"Lane",position:{x:0,y:0},namespace:b.getStencil().namespace(),parent:b};this.facade.createShape(d);this.facade.getCanvas().update();this.facade.setSelection([b]);}}}if(e.any(function(k){return k instanceof ORYX.Core.Node&&k.getStencil().id().endsWith("Lane");})){var c=e.findAll(function(k){return k instanceof ORYX.Core.Node&&k.getStencil().id().endsWith("Lane");});var f=[];var h=[];c.each(function(k){f.push(this.getParentPool(k));}.bind(this));f=f.uniq().findAll(function(k){var l=this.getLanes(k,true);if(l.all(function(m){return c.include(m);})){h=h.concat(l);return true;}else{if(e.include(k)&&l.any(function(m){return c.include(m);})){h=h.concat(l);return true;}else{return false;}}}.bind(this));if(h.length>0&&f.length>0){e=e.without.apply(e,h);e=e.concat(f);this.facade.setSelection(e.uniq());}}},handleShapeRemove:function(e){var f=e.shape;var l=e.parent;if(f instanceof ORYX.Core.Node&&f.getStencil().idWithoutNs()==="Lane"&&this.facade.isExecutingCommands()){var g=this.getParentPool(l);if(g&&g.parent){var h=function(m){return !m.getChildNodes().any(function(n){return n.getStencil().idWithoutNs()==="Lane";});};var c=h(f);var k=l.getChildNodes().any(function(m){return m.getStencil().idWithoutNs()==="Lane";});if(c&&k){var d=new a(f,l,g,this);this.facade.executeCommands([d]);}else{if(!c&&!this.facade.getSelection().any(function(m){return m instanceof ORYX.Core.Node&&m.getStencil().idWithoutNs()==="Lane"&&m.isParent(f)&&h(m);})){var b=ORYX.Core.Command.extend({construct:function(m,n){this.children=m.getChildNodes(true);this.facade=n;},execute:function(){this.children.each(function(m){m.bounds.moveBy(30,0);});this.facade.getCanvas().update();},rollback:function(){this.children.each(function(m){m.bounds.moveBy(-30,0);});this.facade.getCanvas().update();}});this.facade.executeCommands([new b(f,this.facade)]);}else{if(c&&!k&&l==g){l.add(f);}}}}}},hashedSubProcesses:{},hashChildShapes:function(b){var c=b.getChildNodes();c.each(function(d){if(this.hashedSubProcesses[d.id]){this.hashedSubProcesses[d.id]=d.absoluteXY();this.hashedSubProcesses[d.id].width=d.bounds.width();this.hashedSubProcesses[d.id].height=d.bounds.height();this.hashChildShapes(d);}}.bind(this));},handleSubProcess:function(d){var c=d.shape;if(!this.hashedSubProcesses[c.id]){this.hashedSubProcesses[c.id]=c.absoluteXY();this.hashedSubProcesses[c.id].width=c.bounds.width();this.hashedSubProcesses[c.id].height=c.bounds.height();return;}var e=c.absoluteXY();e.x-=this.hashedSubProcesses[c.id].x;e.y-=this.hashedSubProcesses[c.id].y;var b=this.hashedSubProcesses[c.id].width!==c.bounds.width()||this.hashedSubProcesses[c.id].height!==c.bounds.height();this.hashedSubProcesses[c.id]=c.absoluteXY();this.hashedSubProcesses[c.id].width=c.bounds.width();this.hashedSubProcesses[c.id].height=c.bounds.height();this.hashChildShapes(c);if(this.facade.isExecutingCommands()&&!b){this.moveChildDockers(c,e);}},moveChildDockers:function(d,g){if(!g.x&&!g.y){return;}var e=d.getChildNodes(true);var c=e.map(function(h){return[].concat(h.getIncomingShapes()).concat(h.getOutgoingShapes());}).flatten().uniq().map(function(h){return h.dockers.length>2?h.dockers.slice(1,h.dockers.length-1):[];}).flatten();var b=d.absoluteBounds();b.moveBy(-g.x,-g.y);var f={};c.each(function(m){if(m.isChanged){return;}var k=Object.clone(g);if(!b.isIncluded(m.bounds.center())){var o=m.parent.dockers.indexOf(m);var s=m.parent.dockers.length;var q=m.parent.getSource();var r=m.parent.getTarget();var l=e.include(q)&&e.include(r);if(!l){var n=o!==0?b.isIncluded(m.parent.dockers[o-1].bounds.center()):false;var p=o!==s-1?b.isIncluded(m.parent.dockers[o+1].bounds.center()):false;if(!n&&!p){return;}var h=m.parent.dockers[n?o-1:o+1];if(Math.abs(-Math.abs(h.bounds.center().x-m.bounds.center().x))<2){k.y=0;}else{if(Math.abs(-Math.abs(h.bounds.center().y-m.bounds.center().y))<2){k.x=0;}else{return;}}}}f[m.getId()]={docker:m,offset:k};});this.facade.executeCommands([new ORYX.Core.MoveDockersCommand(f)]);},handleDockerDocked:function(d){var e=d.parent;var c=d.target;if(e.getStencil().id()===this.stencilsetNs+"SequenceFlow"){var b=c.getStencil().groups().find(function(f){if(f=="Gateways"){return f;}});if(!b&&(e.properties["oryx-conditiontype"]=="Expression")){e.setProperty("oryx-showdiamondmarker",true);}else{e.setProperty("oryx-showdiamondmarker",false);}this.facade.getCanvas().update();}},handlePropertyChanged:function(d){var c=d.elements;var e=d.key;var b=d.value;var f=false;c.each(function(h){if((h.getStencil().id()===this.stencilsetNs+"SequenceFlow")&&(e==="oryx-conditiontype")){if(b!="Expression"){h.setProperty("oryx-showdiamondmarker",false);}else{var k=h.getIncomingShapes();if(!k){h.setProperty("oryx-showdiamondmarker",true);}var g=k.find(function(l){var m=l.getStencil().groups().find(function(n){if(n=="Gateways"){return n;}});if(m){return m;}});if(!g){h.setProperty("oryx-showdiamondmarker",true);}else{h.setProperty("oryx-showdiamondmarker",false);}}f=true;}}.bind(this));if(f){this.facade.getCanvas().update();}},hashedPoolPositions:{},hashedLaneDepth:{},hashedBounds:{},handleLayoutPool:function(o){var k=o.shape;var z=this.facade.getSelection();var q=z.include(k)?k:z.first();if(q instanceof ORYX.Core.UIObject){q=q.isParent(k)?q:k;}else{q=k;}if(!(q.getStencil().id().endsWith("Pool")||q.getStencil().id().endsWith("Lane"))){return;}if(!this.hashedBounds[k.id]){this.hashedBounds[k.id]={};}this.currentPool=k;var s=this.getLanes(k);if(s.length<=0){return;}var r=this.getLanes(k,true);var d=r.clone();if(s.length===1&&this.getLanes(s.first()).length<=0){s.first().setProperty("oryx-showcaption",s.first().properties["oryx-name"].trim().length>0);}else{r.invoke("setProperty","oryx-showcaption",true);}var n=[];var h=[];var p=-1;while(++p<r.length){if(!this.hashedBounds[k.id][r[p].id]){h.push(r[p]);}}if(h.length>0){q=h.first();}var u=$H(this.hashedBounds[k.id]).keys();var p=-1;while(++p<u.length){if(!r.any(function(x){return x.id==u[p];})){n.push(this.hashedBounds[k.id][u[p]]);z=z.without(function(x){return x.id==u[p];});}}var l,m,g,f;if(n.length>0||h.length>0){if(h.length===1&&this.getLanes(h[0].parent).length===1){l=this.adjustHeight(s,h[0].parent);}else{l=this.updateHeight(k);}m=this.adjustWidth(s,k.bounds.width());k.update();}else{if(k==q){if(z.length===1&&this.isResized(k,this.hashedPoolPositions[k.id])){var t=this.hashedPoolPositions[k.id].upperLeft();var c=k.bounds.upperLeft();var v=0;if(this.shouldScale(k)){var b=this.hashedPoolPositions[k.id];v=b.height()/k.bounds.height();}this.adjustLanes(k,r,t.x-c.x,t.y-c.y,v);}l=this.adjustHeight(s,undefined,k.bounds.height());m=this.adjustWidth(s,k.bounds.width());}else{if(z.length===1&&this.isResized(q,this.hashedBounds[k.id][q.id])){var t=this.hashedBounds[k.id][q.id].upperLeft();var c=q.absoluteXY();g=t.x-c.x;f=t.y-c.y;if(g||f){d=d.without(q);this.adjustLanes(k,this.getAllExcludedLanes(k,q),g,0);}var e=this.getLanes(q,true);if(e.length>0){if(this.shouldScale(q)){var b=this.hashedBounds[k.id][q.id];var v=b.height()/q.bounds.height();this.adjustLanes(k,e,g,f,v);}else{this.adjustLanes(k,e,g,f,0);}}}l=this.adjustHeight(s,q);m=this.adjustWidth(s,q.bounds.width()+(this.getDepth(q,k)*30));}}this.setDimensions(k,m,l,g,f);if(this.facade.isExecutingCommands()&&(n.length===0||h.length!==0)){this.updateDockers(d,k);}this.hashedBounds[k.id]={};var p=-1;while(++p<r.length){this.hashedBounds[k.id][r[p].id]=r[p].absoluteBounds();this.hashChildShapes(r[p]);this.hashedLaneDepth[r[p].id]=this.getDepth(r[p],k);this.forceToUpdateLane(r[p]);}this.hashedPoolPositions[k.id]=k.bounds.clone();},shouldScale:function(b){var c=b.getChildNodes().findAll(function(d){return d.getStencil().id().endsWith("Lane");});return c.length>1||c.any(function(d){return this.shouldScale(d);}.bind(this));},isResized:function(b,d){if(!d||!b){return false;}var c=d;return Math.round(c.width()-b.bounds.width())!==0||Math.round(c.height()-b.bounds.height())!==0;},adjustLanes:function(d,c,b,f,e){e=e||0;c.each(function(g){g.getChildNodes().each(function(k){if(!k.getStencil().id().endsWith("Lane")){var h=e?k.bounds.center().y-(k.bounds.center().y/e):-f;k.bounds.moveBy((b||0),-h);if(e&&k.getStencil().id().endsWith("Subprocess")){this.moveChildDockers(k,{x:(0),y:-h});}}}.bind(this));this.hashedBounds[d.id][g.id].moveBy(-(b||0),!e?-f:0);if(e){g.isScaled=true;}}.bind(this));},getAllExcludedLanes:function(d,b){var c=[];d.getChildNodes().each(function(e){if((!b||e!==b)&&e.getStencil().id().endsWith("Lane")){c.push(e);c=c.concat(this.getAllExcludedLanes(e,b));}}.bind(this));return c;},forceToUpdateLane:function(b){if(b.bounds.height()!==b._svgShapes[0].height){b.isChanged=true;b.isResized=true;b._update();}},getDepth:function(d,c){var b=0;while(d&&d.parent&&d!==c){d=d.parent;++b;}return b;},updateDepth:function(c,b,d){var e=(b-d)*30;c.getChildNodes().each(function(f){f.bounds.moveBy(e,0);[].concat(children[j].getIncomingShapes()).concat(children[j].getOutgoingShapes());});},setDimensions:function(e,f,c,b,g){var d=e.getStencil().id().endsWith("Lane");e.bounds.set(d?30:(e.bounds.a.x-(b||0)),d?e.bounds.a.y:(e.bounds.a.y-(g||0)),f?e.bounds.a.x+f-(d?30:(b||0)):e.bounds.b.x,c?e.bounds.a.y+c-(d?0:(g||0)):e.bounds.b.y);},setLanePosition:function(b,c){b.bounds.moveTo(30,c);},adjustWidth:function(b,c){(b||[]).each(function(d){this.setDimensions(d,c);this.adjustWidth(this.getLanes(d),c-30);}.bind(this));return c;},adjustHeight:function(e,g,c){var h=0;if(!g&&c){var f=-1;while(++f<e.length){h+=e[f].bounds.height();}}var f=-1;var b=0;while(++f<e.length){if(e[f]===g){this.adjustHeight(this.getLanes(e[f]),undefined,e[f].bounds.height());e[f].bounds.set({x:30,y:b},{x:e[f].bounds.width()+30,y:e[f].bounds.height()+b});}else{if(!g&&c){var d=(e[f].bounds.height()*c)/h;this.adjustHeight(this.getLanes(e[f]),undefined,d);this.setDimensions(e[f],null,d);this.setLanePosition(e[f],b);}else{var d=this.adjustHeight(this.getLanes(e[f]),g,c);if(!d){d=e[f].bounds.height();}this.setDimensions(e[f],null,d);this.setLanePosition(e[f],b);}}b+=e[f].bounds.height();}return b;},updateHeight:function(c){var d=this.getLanes(c);if(d.length==0){return c.bounds.height();}var b=0;var e=-1;while(++e<d.length){this.setLanePosition(d[e],b);b+=this.updateHeight(d[e]);}this.setDimensions(c,null,b);return b;},getOffset:function(b,d,c){var f={x:0,y:0};var f=b.absoluteXY();var e=this.hashedBounds[c.id][b.id]||(d===true?this.hashedPoolPositions[b.id]:undefined);if(e){f.x-=e.upperLeft().x;f.y-=e.upperLeft().y;}else{return{x:0,y:0};}return f;},getNextLane:function(b){while(b&&!b.getStencil().id().endsWith("Lane")){if(b instanceof ORYX.Core.Canvas){return null;}b=b.parent;}return b;},getParentPool:function(b){while(b&&!b.getStencil().id().endsWith("Pool")){if(b instanceof ORYX.Core.Canvas){return null;}b=b.parent;}return b;},updateDockers:function(A,s){var q=s.absoluteBounds();var r=(this.hashedPoolPositions[s.id]||q).clone();var z=-1,y=-1,x=-1,u=-1,t;var B={};while(++z<A.length){if(!this.hashedBounds[s.id][A[z].id]){continue;}var d=A[z].isScaled;delete A[z].isScaled;var h=A[z].getChildNodes();var o=A[z].absoluteBounds();var e=(this.hashedBounds[s.id][A[z].id]||o);var m=this.getOffset(A[z],true,s);var f=0;var D=this.getDepth(A[z],s);if(this.hashedLaneDepth[A[z].id]!==undefined&&this.hashedLaneDepth[A[z].id]!==D){f=(this.hashedLaneDepth[A[z].id]-D)*30;m.x+=f;}y=-1;while(++y<h.length){if(f&&!h[y].getStencil().id().endsWith("Lane")){h[y].bounds.moveBy(f,0);}if(h[y].getStencil().id().endsWith("Subprocess")){this.moveChildDockers(h[y],m);}var c=[].concat(h[y].getIncomingShapes()).concat(h[y].getOutgoingShapes()).findAll(function(k){return k instanceof ORYX.Core.Edge;}).uniq();x=-1;while(++x<c.length){if(c[x].getStencil().id().endsWith("MessageFlow")){this.layoutEdges(h[y],[c[x]],m);continue;}u=-1;while(++u<c[x].dockers.length){t=c[x].dockers[u];if(t.getDockedShape()||t.isChanged){continue;}pos=t.bounds.center();var b=e.isIncluded(pos);var p=!r.isIncluded(pos);var g=u==0?b:e.isIncluded(c[x].dockers[u-1].bounds.center());var n=u==c[x].dockers.length-1?b:e.isIncluded(c[x].dockers[u+1].bounds.center());var C=Object.clone(m);if(d&&b&&this.isResized(A[z],this.hashedBounds[s.id][A[z].id])){var v=(pos.y-o.upperLeft().y+C.y);C.y-=(v-(v*(o.height()/e.height())));}if(b){B[t.id]={docker:t,offset:C};}}}}}this.facade.executeCommands([new ORYX.Core.MoveDockersCommand(B)]);},moveBy:function(c,b){c.x+=b.x;c.y+=b.y;return c;},getHashedBounds:function(b){return this.currentPool&&this.hashedBounds[this.currentPool.id][b.id]?this.hashedBounds[this.currentPool.id][b.id]:b.bounds.clone();},getLanes:function(b,d){var c=b.getChildNodes(d||false).findAll(function(e){return(e.getStencil().id()===this.stencilsetNs+"Lane");}.bind(this));c=c.sort(function(v,t){var u=Math.round(v.bounds.upperLeft().y);var o=Math.round(t.bounds.upperLeft().y);var r=Math.round(v.bounds.lowerRight().y);var l=Math.round(t.bounds.lowerRight().y);var g=this.getHashedBounds(v);var f=this.getHashedBounds(t);var n=Math.round(g.upperLeft().y);var y=Math.round(f.upperLeft().y);var k=Math.round(g.lowerRight().y);var x=Math.round(f.lowerRight().y);if(u==o&&r==l){u=n;o=y;r=k;l=x;}if(Math.round(v.bounds.height()-g.height())===0&&Math.round(t.bounds.height()-f.height())===0){return u<o?-1:(u>o?1:0);}var s=u<o&&r<l;var p=u>o&&r>l;var h=u<o&&r>=l&&k<x;var m=u>=o&&r<l&&n<y;var q=u>o&&r<=l&&k>x;var e=u<=o&&r>l&&n>y;return(s||h||m?-1:(p||q||e?1:0));}.bind(this));return c;}};var a=ORYX.Core.Command.extend({construct:function(b,d,c,e){this.facade=e.facade;this.plugin=e;this.shape=b;this.changes;this.pool=c;this.parent=d;this.shapeChildren=[];this.shape.getChildShapes().each(function(f){this.shapeChildren.push({shape:f,bounds:{a:{x:f.bounds.a.x,y:f.bounds.a.y},b:{x:f.bounds.b.x,y:f.bounds.b.y}}});}.bind(this));this.shapeUpperLeft=this.shape.absoluteXY();this.parentHeight=this.parent.bounds.height();},getLeafLanes:function(b){var c=this.plugin.getLanes(b).map(function(d){return this.getLeafLanes(d);}.bind(this)).flatten();return c.length>0?c:[b];},findNewLane:function(){var b=this.plugin.getLanes(this.parent);var c=this.getLeafLanes(this.parent);c=c.sort(function(e,d){var g=e.absoluteXY().y;var f=d.absoluteXY().y;return g<f?-1:(g>f?1:0);});this.lane=c.find(function(d,e){return e==c.length-1||d.absoluteXY().y>=this.shapeUpperLeft.y;}.bind(this));this.laneUppperLeft=this.lane.absoluteXY();},execute:function(){if(this.changes){this.executeAgain();return;}if(!this.lane){this.findNewLane();}if(this.lane){var f=this.laneUppperLeft;var d=this.shapeUpperLeft;var c=this.plugin.getDepth(this.lane,this.parent)-1;this.changes=$H({});if(f.y>d.y){this.lane.getChildShapes().each(function(g){if(!this.changes[g.getId()]){this.changes[g.getId()]=this.computeChanges(g,this.lane,this.lane,this.shape.bounds.height());}g.bounds.moveBy(0,this.shape.bounds.height());}.bind(this));this.plugin.hashChildShapes(this.lane);this.shapeChildren.each(function(g){g.shape.bounds.set(g.bounds);g.shape.bounds.moveBy((d.x-30)-(c*30),0);if(!this.changes[g.shape.getId()]){this.changes[g.shape.getId()]=this.computeChanges(g.shape,this.shape,this.lane,0);}this.lane.add(g.shape);}.bind(this));this.lane.bounds.moveBy(0,d.y-f.y);}else{if(d.y>f.y){this.shapeChildren.each(function(g){g.shape.bounds.set(g.bounds);g.shape.bounds.moveBy((d.x-30)-(c*30),this.lane.bounds.height());if(!this.changes[g.shape.getId()]){this.changes[g.shape.getId()]=this.computeChanges(g.shape,this.shape,this.lane,0);}this.lane.add(g.shape);}.bind(this));}}}var e=this.lane.bounds.height();var b=this.lane.length===1?this.parentHeight:this.lane.bounds.height()+this.shape.bounds.height();this.setHeight(b,e,this.parent,this.parentHeight,true);this.update();},setHeight:function(b,f,e,d,c){this.plugin.setDimensions(this.lane,this.lane.bounds.width(),b);this.plugin.hashedBounds[this.pool.id][this.lane.id]=this.lane.absoluteBounds();this.plugin.adjustHeight(this.plugin.getLanes(e),this.lane);if(c===true){this.changes[this.shape.getId()]=this.computeChanges(this.shape,e,e,0,f,b);}this.plugin.setDimensions(e,e.bounds.width(),d);if(e!==this.pool){this.plugin.setDimensions(this.pool,this.pool.bounds.width(),this.pool.bounds.height()+(b-f));}},update:function(){this.plugin.hashedBounds[this.pool.id]["REMOVED"]=true;this.facade.getCanvas().update();},rollback:function(){var c=this.laneUppperLeft;var b=this.shapeUpperLeft;this.changes.each(function(h){var g=h.value.oldParent;var e=h.value.shape;var f=h.value.parentHeight;var k=h.value.oldHeight;var d=h.value.newHeight;if(k){this.setHeight(k,d,g,g.bounds.height()+(k-d));if(c.y>b.y){this.lane.bounds.moveBy(0,this.shape.bounds.height());}}else{g.add(e);e.bounds.moveTo(h.value.oldPosition);}}.bind(this));},executeAgain:function(){this.changes.each(function(f){var d=f.value.newParent;var c=f.value.shape;var b=f.value.newHeight;var h=f.value.oldHeight;if(b){var g=this.laneUppperLeft.y;var e=this.shapeUpperLeft.y;if(g>e){this.lane.bounds.moveBy(0,e-g);}this.setHeight(b,h,d,d.bounds.height()+(b-h));}else{d.add(c);c.bounds.moveTo(f.value.newPosition);}}.bind(this));this.update();},computeChanges:function(d,l,k,c,m,b){l=this.changes[d.getId()]?this.changes[d.getId()].oldParent:l;var h=this.changes[d.getId()]?this.changes[d.getId()].oldPosition:d.bounds.upperLeft();var f=d.bounds.upperLeft();var e={x:f.x,y:f.y+c};var g={shape:d,parentHeight:l.bounds.height(),oldParent:l,oldPosition:h,oldHeight:m,newParent:k,newPosition:e,newHeight:b};return g;}});ORYX.Plugins.BPMN11=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN11);}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.PlausibilityChecker=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);var a=Signavio.I18N.PlausibilityChecker.desc;this.active=false;this.raisedEventIds=[];this.facade.offer({"name":Signavio.I18N.PlausibilityChecker.name,"functionality":this.perform.bind(this),"group":Signavio.I18N.PlausibilityChecker.group,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/book_error.png","description":a,"index":0,"toggle":true,"minShape":0,"maxShape":0,"isEnabled":this._isRequiredSSELoaded.bind(this)});this.facade.registerOnEvent(ORYX.Plugins.PlausibilityChecker.CHECK_FOR_ERRORS_EVENT,this.checkForErrors.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ABOUT_TO_SAVE,this.resetErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.PlausibilityChecker.RESET_ERRORS_EVENT,this.resetErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.PlausibilityChecker.SHOW_ERRORS_EVENT,this.doShowErrors.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this._checkEnabledState.bind(this));},_checkEnabledState:function(){this.facade.updateSelection();},_isRequiredSSELoaded:function(){var c=this.facade.getStencilSets().values()[0];for(var a=0;a<ORYX.CONFIG.PLAUSIBILITYCHECKER_REQ.length;a++){var b=ORYX.CONFIG.PLAUSIBILITYCHECKER_REQ[a];if(b.stencilSet==c.namespace()){if(b.requiredExtension&&!this.isStencilSetExtensionLoaded(b.requiredExtension)){return false;}}}return true;},perform:function(a,b){if(!b){this.resetErrors();}else{this.checkForErrors({onAbort:function(){this.setActivated(a,false);}.bind(this),onNoErrors:function(){this.setActivated(a,false);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:Signavio.I18N.PlausibilityChecker.noErrors,timeout:10000});}.bind(this),onErrors:function(){this.enableDeactivationHandler(a);}.bind(this),onFailure:function(){this.setActivated(a,false);Ext.Msg.alert(ORYX.I18N.Oryx.title,Signavio.I18N.PlausibilityChecker.invalid);}.bind(this)});}},enableDeactivationHandler:function(a){var b=function(){this.setActivated(a,false);this.resetErrors();this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b);};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b.bind(this));},setActivated:function(b,a){b.toggle(a);if(a===undefined){this.active=!this.active;}else{this.active=a;}},checkForErrors:function(b){Ext.applyIf(b||{},{showErrors:true,onAbort:Ext.emptyFn,onErrors:Ext.emptyFn,onNoErrors:Ext.emptyFn,onFailure:Ext.emptyFn});var c=new Ext.Button({text:"Abbruch",style:"margin-left:110px"});var a=new Ext.ProgressBar({style:"height:25px; width:160px; margin:12px",test:"test"});a.wait({interval:200,increment:15});w=new Ext.Window({title:Signavio.I18N.PlausibilityChecker.checkingMessage,background:"white",layout:"anchor",width:250,height:100,items:[a,new Ext.Button({text:"Abbruch",style:"margin-left:160px",handler:function(){w.close();}.bind(this)})]});w.show();new Ajax.Request(ORYX.CONFIG.PLAUSIBILITYCHECKER_URL,{method:"POST",asynchronous:true,parameters:{model_xml:Ext.encode(this.facade.getJSON()),id:this.facade.getModelMetaData().modelId},onSuccess:function(d){var e=d.responseText.evalJSON().rep;if(w.hidden){b.onAbort();return;}w.hide();if(e instanceof Object){errors=$H(e.errors);warnings=$H(e.warnings);if(errors.size()+warnings.size()>0){if(b.showErrors){this.showFeedback(errors,warnings);}b.onErrors();}else{b.onNoErrors();}}else{b.onFailure();}}.bind(this),onFailure:function(){Ext.Msg.hide();b.onFailure();}});},doShowErrors:function(b,a){this.showFeedback(b.errors,{});},showFeedback:function(b,a){if(!(b instanceof Hash)){b=new Hash(b);}if(!(a instanceof Hash)){a=new Hash(a);}b.keys().each(function(d){var c=this.facade.getCanvas().getChildShapeByResourceId(d);if(c){this.raiseErrorOverlay(c,this.parseCodeToMsg(b[d]));}else{if(d=="canvas"){this.raiseErrorOverlay(this.facade.getCanvas(),this.parseCodeToMsg(b[d]));}}}.bind(this));a.keys().each(function(d){var c=this.facade.getCanvas().getChildShapeByResourceId(d);if(c){this.raiseWarningOverlay(c,this.parseCodeToMsg(a[d]),b[d]);}else{if(d=="canvas"){this.raiseWarningOverlay(this.facade.getCanvas(),this.parseCodeToMsg(a[d]),b[d]);}}}.bind(this));this.active=!this.active;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:Signavio.I18N.PlausibilityChecker.notice,timeout:10000});},parseCodeToMsg:function(e){var f=e.replace(/: /g,"<br />").replace(/, /g,"<br />");var a=f.split("<br />");for(var b=0;b<a.length;b++){var d=a[b];var c=this.parseSingleCodeToMsg(d);if(d!=c){f=f.replace(d,c);}}return f;},parseSingleCodeToMsg:function(a){return Signavio.I18N.PlausibilityChecker[a]||ORYX.I18N.SyntaxChecker[a]||a;},resetErrors:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));this.raisedEventIds=[];this.active=false;},raiseErrorOverlay:function(b,c){var h="syntaxchecker."+this.raisedEventIds.length;var a=b.getStencil().id();var f="";if(a.endsWith("Lane")||a.endsWith("Pool")||a.endsWith("Diagram")){f="M20,20 L5,5 M5,20 L20,5";}else{f="M20,-5 L5,-20 M5,-5 L20,-20";}var e=ORYX.Editor.provideId();var g=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"id":e,"title":"","stroke-width":5,"stroke":"red","d":f,"line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:h,shapes:[b],node:g,nodePosition:b instanceof ORYX.Core.Edge?"START":"NW"});var d=new Ext.ToolTip({showDelay:50,html:c,target:e});this.raisedEventIds.push(h);return g;},raiseWarningOverlay:function(e,d,l){var a="syntaxchecker."+this.raisedEventIds.length;var b=e.getStencil().id();var m="";var h=10;var g=-7;if(l){if(b.endsWith("Lane")||b.endsWith("Pool")||b.endsWith("#BPMNDiagram")){m="M21 40 L12.5 25 L4 40 Z";g=38;}else{m="M41 -5 L32.5 -20 L24 -5 Z";h=30;}}else{if(b.endsWith("Lane")||b.endsWith("Pool")||b.endsWith("#BPMNDiagram")){m="M21 20 L12.5 5 L4 20 Z";g=18;}else{m="M21 -5 L12.5 -20 L4 -5 Z";}}var f=ORYX.Editor.provideId();var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{"id":f},["path",{"stroke-width":2,"stroke":"orange","fill":"yellow","d":m,"line-captions":"round"}],["text",{"x":h,"y":g,"stroke-width":0,"fill":"#666666","font-size":9,"font-weight":"bold","line-captions":"round"},"!"]]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:a,shapes:[e],node:c,nodePosition:e instanceof ORYX.Core.Edge?"START":"NW"});var k=new Ext.ToolTip({showDelay:50,html:d,target:f});this.raisedEventIds.push(a);return c;}});ORYX.Plugins.PlausibilityChecker.CHECK_FOR_ERRORS_EVENT="checkForErrors";ORYX.Plugins.PlausibilityChecker.RESET_ERRORS_EVENT="resetErrors";ORYX.Plugins.PlausibilityChecker.SHOW_ERRORS_EVENT="showErrors";if(!window.ORYX){window.ORYX={};}if(!ORYX.Plugins){ORYX.Plugins={};}(function(){var d={HORIZONTAL:"horizontal",VERTICAL:"vertical"};var e={LEFT_TO_RIGHT:"left-to-right",RIGHT_TO_LEFT:"right-to-left",BOTTOM_UP:"bottom-up",TOP_DOWN:"top-down",BLOCK:"block"};var c=18/56;var b=0.9;var a="http://www.signavio.com/stencilsets/processmap#";ORYX.Plugins.ProcessmapSupport=Clazz.extend({facade:undefined,construct:function(f){this.facade=f;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,this.onAdd.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.onPropertyChange.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.onFinish.bind(this));if(this.facade.getStencilSets().keys().include(a)){ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE=true;ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET=0;}},onFinish:function(){this.facade.getCanvas().getChildShapes(true).each(function(f){if(!(f instanceof ORYX.Core.Node)){return;}this.onAdd({shape:f});this.onPropertyChange({name:"oryx-orientation",value:f.properties["oryx-orientation"]},f);this.onPropertyChange({name:"oryx-textdirection",value:f.properties["oryx-textdirection"]||"0"},f);var h=f.getLabels();var g=h.find(function(l){var k=f.getStencil().properties().invoke("refToView").flatten();return k.any(function(m){return l.id==f.id+m;});});if(g){g.update(true);}}.bind(this));this.finished=true;},addedShapes:{},onAdd:function(h){var f=h.shape;if(f instanceof ORYX.Core.Node&&!this.addedShapes[f.id]&&(this.isProcess(f)||f.getStencil().id()===a+"TextNote")){var k=Element.getElementsByClassName(f.getMeContainer(),"front")[0];if(k){k.setAttribute("fill","url(#"+f.getId()+"gradient)");}$A(Element.getElementsByClassName(f.getMeContainer(),"shadow")).each(function(l){if(Ext.isGecko&&Signavio.Plugins.Utils.getFFVersion()>3){l.setAttribute("filter","url(#"+f.getId()+"filter)");}else{l.removeAttribute("filter");$H({"stroke-opacity":"0.2","fill-opacity":"0.5","stroke-width":"2","stroke-linejoin":"bevel","stroke":"grey","fill":"grey","transform":"translate(1.5, 3)"}).each(function(m){l.setAttribute(m.key,m.value);});}});f.bounds.registerCallback(this.onChange.bind(this,f));this.onChange(f);this.addedShapes[f.id]=true;if(this.finished){var g=this;f._labels.values().each(function(m){var l=function(){m.unregisterOnChange(l);window.setTimeout(function(){if(!m.isUpdating()){m.update(true);}},0);};m.registerOnChange(l);});}}},onChange:function(n){n.bounds.suspendChange=true;n._update();n.bounds.suspendChange=false;var s=n.bounds.height();var f=n.bounds.width();var k=15;var g=$(n.getMeContainer()).getElementsByTagName("filter")[0];if(g){g.setAttribute("filterRes",Math.max(100,Math.min(1000,parseInt(Math.max(s,f)/2))));}var l=$(n.getMeContainer()).getElementsByTagName("feGaussianBlur")[0]||$(n.getMeContainer()).getElementsByTagName("fegaussianblur")[0];if(l){l.setAttribute("stdDeviation",Math.max(1,Math.min(3,Math.max(s,f)/50)));}if(n.getStencil().id()===a+"TextNote"){this.updateSVG(n.getMeContainer(),"figure","0,0 "+(f-k)+",0 "+(f)+","+(k)+" "+(f)+","+(s)+" 0,"+(s)+" 0,0");return;}var o=Element.getElementsByClassName(n.getMeContainer(),"gradient")[0];if(o){o.setAttribute("x2",f);}var p=this.getMainArrow(n);if(!p){return;}var q=null;var r=this.parseShape(this.getPoints(p));r.minimumSize=n.minimumSize||null;this.moveLink(n,r);var m=s*c;var h=f*c;this.updateLabelPosition(n.getLabels(),f/2,s/2);if(r.orientation==e.LEFT_TO_RIGHT){if(f/s<b){m=m*f/s;this.updateLabelPosition(n.getLabels(),(f/2)+(m/2.5),s/2);}else{this.updateLabelPosition(n.getLabels(),(f/2)+(m/3),s/2);}q=this.orientLeftToRight(f,s,m);}else{if(r.orientation==e.RIGHT_TO_LEFT){if(f/s<b){m=m*f/s;this.updateLabelPosition(n.getLabels(),(f/2)-(m/2.5),s/2);}else{this.updateLabelPosition(n.getLabels(),(f/2)-(m/3),s/2);}q=this.orientRightToLeft(f,s,m);}else{if(r.orientation==e.TOP_DOWN){if(s/f<b){h=h*s/f;}q=this.orientTopDown(f,s,h);}else{if(r.orientation==e.BOTTOM_UP){if(s/f<b){h=h*s/f;}q=this.orientBottomUp(f,s,h);}else{return;}}}}this.updateSVG(n.getMeContainer(),"arrow",q);},updateLabelPosition:function(h,f,g){h.each(function(k){if(k.getPosition()){return;}var l=function(n,m,o){n.unregisterOnChange(l);n.setX(m);n.setY(o);window.setTimeout(n.update.bind(n,true),0);}.bind(this,k,f,g);if(k.isUpdating()){k.registerOnChange(l);}else{l();}});},getMainArrow:function(f){return $A(Element.getElementsByClassName(f.getMeContainer(),"arrow")).find(function(g){return g.getAttribute("class").include("front");});},moveLink:function(o,v){var q=Element.getElementsByClassName(o.getMeContainer(),"diagramLink")[0];var s=this.getMainArrow(o);if(q&&s){var t=this.getPoints(s);var k=parseInt(t[2].split(",")[0]);var g=parseInt(t[3].split(",")[0]);var n=k+(g-k)/2;var u=parseInt(t[2].split(",")[1]);var l=14;var r=Math.round((v.width/2)-(l/2));var p=u-l;if(v.orientation===e.TOP_DOWN){p=0;}else{if(v.orientation===e.LEFT_TO_RIGHT){r=n-4;}else{if(v.orientation===e.RIGHT_TO_LEFT){r=n-10;}}}for(var m=0;m<q.childNodes.length;m++){var h=q.childNodes[m];if(h.nodeName==="rect"){h.setAttribute("x",r);h.setAttribute("y",p);}else{if(h.nodeName==="path"){h.setAttribute("d","M"+(r+7)+","+(p+2)+"v10 M"+(r+2)+","+(p+7)+"h10");}}}var f=function(y,x){if(y.parentNode.parentNode.nearestViewportElement){var z=y.parentNode.getBBox();x.setHiddenProperty("oryx-processlink_bounds",z.x+","+z.y+" "+(z.x+z.width)+","+(z.y+z.height));}}.bind(this,q,o);window.setTimeout(f,10);}},isProcess:function(){var f=[a+"Process",a+"ProcessCollapsed"];return function(g){return f.include(g.getStencil().id());};}(),onPropertyChange:function(h,f){if(this.isProcess(f)&&h.name==="oryx-orientation"){var o={};var m=this.getMainArrow(f);if(!m){return;}var g;var o=this.parseShape(this.getPoints(m));o.minimumSize=f.minimumSize||null;if(h.value===e.BLOCK){o.offset=0;}else{o.offset=(o.offset||ORYX.CONFIG.PROCESSMAP_DEFAULT_ARROW_WIDTH);}if(h.value!==o.orientation){if(h.value===e.BLOCK){if(o.alignment===d.HORIZONTAL){g=this.rotateHorizontal(h.value,o,false);}else{g=this.rotateHorizontal(h.value,o,true);}}else{if(h.value==e.LEFT_TO_RIGHT||h.value==e.RIGHT_TO_LEFT){if(o.alignment===d.HORIZONTAL){g=this.rotateHorizontal(h.value,o,false);}else{g=this.rotateHorizontal(h.value,o,true);}}else{if(h.value===e.TOP_DOWN||h.value===e.BOTTOM_UP){if(o.alignment===d.VERTICAL){g=this.rotateVertical(h.value,o,false);}else{g=this.rotateVertical(h.value,o,true);}}}}if(g.resetBounds||g.linkMoved){var k={a:{x:f.bounds.a.x,y:f.bounds.a.y},b:{x:f.bounds.a.x+g.width,y:f.bounds.a.y+g.height}};f.bounds.set(k);var n=Element.getElementsByClassName(f.getMeContainer(),"gradient")[0];n.setAttribute("x2",g.width);this.facade.updateSelection();}this.updateSVG(f.getMeContainer(),"arrow",g.points);this.onChange(f);this.moveLink(f,g);}}if(this.isProcess(f)&&h.name==="oryx-textdirection"){var l=parseInt(h.value||"0");if([0,90,180,270].include(l)){f.getLabels().each(function(p){p.rotate(l);p.update();});}}},updateSVG:function(h,f,g){$A(Element.getElementsByClassName(h,f)).each(function(k){k.setAttribute("points",g);});},rotateHorizontal:function(h,n,k){var g={};var m=n.width;var f=n.height;if(k){if(n.minimumSize===null){n.minimumSize={width:48,height:48};}m=Math.max(n.height,n.minimumSize.width);f=Math.max(n.width,n.minimumSize.height);}var l=n.offset;g.width=m;g.height=f;g.alignment=d.HORIZONTAL;g.offset=l;if(!(g.resetBounds=k)){if(n.orientation===e.LEFT_TO_RIGHT||(n.orientation===e.BLOCK&&h===e.RIGHT_TO_LEFT)){g.points=this.orientRightToLeft(m,f,l);g.orientation=e.RIGHT_TO_LEFT;}else{g.points=this.orientLeftToRight(m,f,l);g.orientation=e.LEFT_TO_RIGHT;}}else{if(h===e.LEFT_TO_RIGHT){g.points=this.orientLeftToRight(m,f,l);g.orientation=e.LEFT_TO_RIGHT;}else{g.points=this.orientRightToLeft(m,f,l);g.orientation=e.RIGHT_TO_LEFT;}}return g;},orientRightToLeft:function(h,f,k){var g=k+",0 0,"+(f/2)+" "+k+","+f;g+=" "+h+","+f+" "+(h-k)+","+(f/2)+" "+h+",0";return g;},orientLeftToRight:function(h,f,k){var g="0,0 "+k+","+(f/2)+" 0,"+f;g+=" "+(h-k)+","+f+" "+h+","+(f/2)+" "+(h-k)+",0";return g;},rotateVertical:function(h,n,l){var g={};var k=n.width;var f=n.height;if(l){if(n.minimumSize===null){n.minimumSize={width:48,height:48};}k=Math.max(n.height,n.minimumSize.width);f=Math.max(n.width,n.minimumSize.height);}var m=n.offset;g.width=k;g.height=f;g.linkMoved=true;g.alignment=d.VERTICAL;g.offset=m;if(!(g.resetBounds=l)){if(n.orientation===e.TOP_DOWN||(n.orientation===e.BLOCK&&h===e.BOTTOM_UP)){g.points=this.orientBottomUp(k,f,m);g.orientation=e.BOTTOM_UP;}else{g.points=this.orientTopDown(k,f,m);g.orientation=e.TOP_DOWN;}}else{if(h===e.TOP_DOWN){g.points=this.orientTopDown(k,f,m);g.orientation=e.TOP_DOWN;}else{g.points=this.orientBottomUp(k,f,m);g.orientation=e.BOTTOM_UP;}}return g;},orientBottomUp:function(h,f,k){var g="0,"+k+" 0,"+f+" "+h+","+f;g+=" "+" "+h+","+k+" "+(h/2)+",0";return g;},orientTopDown:function(h,f,k){var g="0,0 0,"+(f-k)+" "+(h/2)+","+f;g+=" "+h+","+(f-k)+" "+h+",0";return g;},getPoints:function(g){var f=g.getAttribute("points").split(/\s+/g);if(!f.first().include(",")){f=f.inGroupsOf(2).invoke("join",",");}return f;},parseShape:function(o){var h={};var n=o[4].split(",");var m=o[3].split(",");var k=o[2].split(",");if(o.invoke("split",",").pluck("0").uniq().findAll(function(p){return !!p;}).length===2||o.invoke("split",",").pluck("1").uniq().findAll(function(p){return !!p;}).length===2){var g=o[3].split(",");var l=parseInt(g[0]);var f=parseInt(g[1]);h.alignment=(l>f?d.HORIZONTAL:d.VERTICAL);h.orientation=e.BLOCK;h.height=f;h.width=l;h.offset=0;return h;}if(n[0]==m[0]||m[0]==k[0]){h.alignment=d.VERTICAL;if(parseInt(m[0])!==parseInt(k[0])){h.orientation=e.TOP_DOWN;h.height=parseInt(k[1]);h.offset=h.height-parseInt(o[1].split(",")[1]);}else{h.orientation=e.BOTTOM_UP;h.height=parseInt(k[1]);h.offset=parseInt(o[0].split(",")[1]);}h.width=parseInt(m[0]);}else{h.alignment=d.HORIZONTAL;if(parseInt(n[0])>parseInt(m[0])){h.orientation=e.LEFT_TO_RIGHT;h.width=parseInt(n[0]);h.offset=parseInt(o[1].split(",")[0]);}else{h.orientation=e.RIGHT_TO_LEFT;h.width=parseInt(m[0]);h.offset=parseInt(o[0].split(",")[0]);}h.height=parseInt(m[1]);}return h;}});}());if(!Signavio){var Signavio={};}if(!Signavio.Plugins){Signavio.Plugins={};}new function(){Signavio.Plugins.RotateProcessMap=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;this.rotateMenuIsShown=false;this.button={target:ORYX.Plugins.ShapeMenuPlugin,functionality:function(){this.toggleRotateMenu();}.bind(this),icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/fugue/icons/arrow-circle.png",description:Signavio.I18N.RotateProcessmap.description,align:ORYX.CONFIG.SHAPEMENU_BOTTOM,minShape:1,maxShape:1,isEnabled:function(){if("undefined"!=typeof this.facade&&this.facade.getSelection().length==1){var b=this.facade.getSelection()[0].getStencil();if(b.id()==="http://www.signavio.com/stencilsets/processmap#Process"||b.id()==="http://www.signavio.com/stencilsets/processmap#ProcessCollapsed"){return true;}}return false;}.bind(this)};this.facade.offer(this.button);},createRotateMenuItems:function(){if("undefined"!=typeof this.facade&&this.facade.getSelection().length==1){var a=this.facade.getSelection()[0].getStencil();if(a.id()==="http://www.signavio.com/stencilsets/processmap#Process"||a.id()==="http://www.signavio.com/stencilsets/processmap#ProcessCollapsed"){var b=a.property("oryx-orientation").items();this.facade.getSelection()[0].properties.each(function(c){if(c.key=="oryx-orientation"){currentvalue=c.value;}}.bind(this));b.each(function(d){var c=new Ext.menu.Item({text:d.title(),icon:ORYX.CONFIG.ROOT_PATH+"/"+d.icon(),iconCls:"x-small-icon",handler:(function(){var e=this.orientationShape(currentvalue,d.value(),this.facade.getSelection()[0]);this.facade.executeCommands([e]);}).bind(this)});if(currentvalue==d.value()){c.disabled=true;}this.rotateMenu.addItem(c);}.bind(this));}}},orientationShape:function(c,a,b){var d=ORYX.Core.Command.extend({construct:function(g,e,f,h){this.shape=f;this.oldOrientation=g;this.newOrientation=e;this.facade=h;},execute:function(){this.shape.setProperty("oryx-orientation",a);this.updateSelection();},rollback:function(){this.shape.setProperty("oryx-orientation",c);this.updateSelection();},updateSelection:function(){var e=this.facade.getSelection();this.facade.setSelection([]);this.facade.setSelection(e);}});return new d(c,a,b,this.facade);},createRotateMenu:function(){this.rotateMenu=new Ext.menu.Menu();this.createRotateMenuItems();},showRotateMenu:function(){this.createRotateMenu();this.rotateMenuIsShown=true;this.rotateMenu.show(this.button.button.node);},onSelectionChanged:function(a){if(this.rotateMenu!=undefined&&this.rotateMenuIsShown==true){this.hideRotateMenu();}},hideRotateMenu:function(){this.rotateMenuIsShown=false;this.rotateMenu.destroy();},toggleRotateMenu:function(){if(this.rotateMenuIsShown==true){this.hideRotateMenu();}else{this.showRotateMenu();}}});}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.OrganigramSupport=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,this.onAdd.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.onPropertyChange.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.onFinish.bind(this));},onFinish:function(){this.facade.getCanvas().getChildShapes(true).each(function(a){this.onAdd({shape:a});this.onPropertyChange({name:"oryx-color",value:a.properties["oryx-color"]},a);}.bind(this));},addedShapes:{},onAdd:function(c){var a=c.shape;if(a instanceof ORYX.Core.Node&&!this.addedShapes[a.id]&&(a.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#Manager"||a.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#HierarchicOrgUnit"||a.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#position"||a.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#freejob"||a.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#TextNote")){var b=Element.getElementsByClassName(a.node,"front")[0];if(b){b.setAttribute("fill","url(#"+a.getId()+"gradient)");}$A(Element.getElementsByClassName(a.node,"shadow")).each(function(d){if(Ext.isGecko&&Signavio.Plugins.Utils.getFFVersion()>3){d.setAttribute("filter","url(#"+a.getId()+"filter)");}else{d.removeAttribute("filter");$H({"stroke-opacity":"0.2","fill-opacity":"0.5","stroke-width":"2","stroke-linejoin":"bevel","stroke":"grey","fill":"grey","transform":"translate(1.5, 3)"}).each(function(e){d.setAttribute(e.key,e.value);});}});a.bounds.registerCallback(this.onChange.bind(this,a));this.onChange(a);this.addedShapes[a.id]=true;}},onChange:function(b){b._update();var a=b.bounds.height();var d=b.bounds.width();var g=15;var c=$(b.node).getElementsByTagName("filter")[0];if(c){c.setAttribute("filterRes",Math.max(100,Math.min(1000,parseInt(Math.max(a,d)/2))));}if(b.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#TextNote"){$A(Element.getElementsByClassName(b.node,"figure")).each(function(h){h.setAttribute("points","0,0 "+(d-g)+",0 "+(d)+","+(g)+" "+(d)+","+(a)+" 0,"+(a)+" 0,0");});return;}var f=$(b.node).getElementsByTagName("feGaussianBlur")[0]||$(b.node).getElementsByTagName("fegaussianblur")[0];if(f){f.setAttribute("stdDeviation",Math.max(1,Math.min(3,Math.max(a,d)/50)));}var e=Element.getElementsByClassName(b.node,"gradient")[0];if(e){e.setAttribute("x2",d);}this.updateLabelPosition(b.getLabels());},updateLabelPosition:function(a){a.each(function(b){if(b.getPosition()){return;}var c=function(e,d,f){e.unregisterOnChange(c);window.setTimeout(e.update.bind(e,true),0);}.bind(this,b);if(b.isUpdating()){b.registerOnChange(c);}else{c();}});},onPropertyChange:function(b,a){if(b.name==="oryx-color"&&a instanceof ORYX.Core.Node&&(a.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#Manager"||a.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#HierarchicOrgUnit"||a.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#position"||a.getStencil().id()==="http://www.signavio.com/stencilsets/organigram#freejob")){try{var c=$(a.node).getElementsByTagName("stop")[1];if(c){c.setAttribute("style","stop-color: "+b.value+";");}$A(Element.getElementsByClassName(a.node,"stroke")).each(function(e){e.setAttribute("stroke",b.value);});}catch(d){}}}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}new function(){ORYX.Plugins.BPMN2_0={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BPMN20_HASHCHILD,this.handleHashChild.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.subprocess",this.handleSubProcess.bind(this));this.namespace=undefined;},hashedSubProcesses:{},handleHashChild:function(b){var a=b.shape;if(a){this.hashChildShapes(a);}},hashChildShapes:function(a){var b=a.getChildNodes();b.each(function(c){if(this.hashedSubProcesses[c.id]){this.hashedSubProcesses[c.id]=c.absoluteXY();this.hashedSubProcesses[c.id].width=c.bounds.width();this.hashedSubProcesses[c.id].height=c.bounds.height();this.hashChildShapes(c);}}.bind(this));},handleSubProcess:function(d){var c=d.shape;if(!this.hashedSubProcesses[c.id]){this.hashedSubProcesses[c.id]=c.absoluteXY();this.hashedSubProcesses[c.id].width=c.bounds.width();this.hashedSubProcesses[c.id].height=c.bounds.height();return;}var e=c.absoluteXY();e.x-=this.hashedSubProcesses[c.id].x;e.y-=this.hashedSubProcesses[c.id].y;var a=1;var b=Math.abs(this.hashedSubProcesses[c.id].width-c.bounds.width())>a||Math.abs(this.hashedSubProcesses[c.id].height!==c.bounds.height())>a;this.hashedSubProcesses[c.id]=c.absoluteXY();this.hashedSubProcesses[c.id].width=c.bounds.width();this.hashedSubProcesses[c.id].height=c.bounds.height();this.hashChildShapes(c);if(this.facade.isExecutingCommands()&&!b){this.moveChildDockers(c,e);}},moveChildDockers:function(c,f){if(!f.x&&!f.y){return;}var d=c.getChildNodes(true);var b=d.map(function(g){return[].concat(g.getIncomingShapes()).concat(g.getOutgoingShapes());}).flatten().uniq().map(function(g){return g.dockers.length>2?g.dockers.slice(1,g.dockers.length-1):[];}).flatten();var a=c.absoluteBounds();a.moveBy(-f.x,-f.y);var e={};b.each(function(l){if(l.isChanged){return;}var h=Object.clone(f);if(!a.isIncluded(l.bounds.center())){var n=l.parent.dockers.indexOf(l);var r=l.parent.dockers.length;var p=l.parent.getSource();var q=l.parent.getTarget();var k=d.include(p)&&d.include(q);if(!k){var m=n!==0?a.isIncluded(l.parent.dockers[n-1].bounds.center()):false;var o=n!==r-1?a.isIncluded(l.parent.dockers[n+1].bounds.center()):false;if(!m&&!o){return;}var g=l.parent.dockers[m?n-1:n+1];if(Math.abs(-Math.abs(g.bounds.center().x-l.bounds.center().x))<2){h.y=0;}else{if(Math.abs(-Math.abs(g.bounds.center().y-l.bounds.center().y))<2){h.x=0;}else{return;}}}}e[l.getId()]={docker:l,offset:h};});this.facade.executeCommands([new ORYX.Core.MoveDockersCommand(e)]);},getNamespace:function(){if(!this.namespace){var a=this.facade.getStencilSets();if(a.keys()){this.namespace=a.keys()[0];}else{return undefined;}}return this.namespace;},handleDockerDocked:function(c){var d=this.getNamespace();var e=c.parent;var b=c.target;if(e.getStencil().id()===d+"SequenceFlow"){var a=b.getStencil().groups().find(function(f){if(f=="Gateways"){return f;}});if(!a&&(e.properties["oryx-conditiontype"]=="Expression")){e.setProperty("oryx-showdiamondmarker",true);}else{e.setProperty("oryx-showdiamondmarker",false);}this.facade.getCanvas().update();}},handlePropertyChanged:function(e){var d=this.getNamespace();var c=e.elements;var f=e.key;var a=e.values||e.value;var b;var g=false;c.each(function(k){if((k.getStencil().id()===d+"SequenceFlow")&&(f==="oryx-conditiontype")){b=a[k.getId()]||a;if(b!="Expression"){k.setProperty("oryx-showdiamondmarker",false);}else{var l=k.getIncomingShapes();if(!l){k.setProperty("oryx-showdiamondmarker",true);}var h=l.find(function(m){var n=m.getStencil().groups().find(function(o){if(o=="Gateways"){return o;}});if(n){return n;}});if(!h){k.setProperty("oryx-showdiamondmarker",true);}else{k.setProperty("oryx-showdiamondmarker",false);}}}}.bind(this));}};ORYX.Plugins.BPMN2_0=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2_0);}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}new function(){ORYX.Plugins.BPMN2_0MessageFlow={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,this.handleShapeAdded.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDragDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDROP_END,this.handleDragDropEnd.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_BEFORE_EXECUTE,this.lockChecking.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_BEFORE_ROLLBACK,this.lockChecking.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_ROLLBACK,this.unlockChecking.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_EXECUTE,this.unlockChecking.bind(this));this.namespace=undefined;this.shape=undefined;this.stencil=undefined;this.removeEdge=[];this.reconnectedEdges=[];this.executeCheckingFn=this.executeChecking.bind(this);this.isLocked=false;this.shapeList=[];this.morphCommands=[];},lockChecking:function(a){this.isLocked=true;},unlockChecking:function(a){this.isLocked=false;},queueOnShapeList:function(a){if(this.isLocked||!a){return;}this.shapeList.push(a);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAST_EXECUTE_COMMANDS,this.executeCheckingFn);},executeChecking:function(a){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_LAST_EXECUTE_COMMANDS,this.executeCheckingFn);if(!this.shapeList){return;}var b=this.shapeList.flatten().uniq();b.each(this.processSelection.bind(this));if(this.morphCommands&&this.morphCommands.size()>0){this.facade.executeCommands(this.morphCommands);}this.morphCommands=[];this.shapeList=[];},handleLayoutMessageFlow:function(b){var a=b.shape;this.queueOnShapeList([a]);},handleLayoutSequenceFlow:function(b){var a=b.shape;this.queueOnShapeList([a]);},handleShapeAdded:function(b){var a=b.shape;this.queueOnShapeList([a]);},handleDragDockerDocked:function(a){if(this.isLocked){return;}if(a.parent instanceof ORYX.Core.Edge&&(a.parent.getStencil().idWithoutNs()==="SequenceFlow"||a.parent.getStencil().idWithoutNs()==="MessageFlow")){var b=a.parent.getSource();var c=a.parent.getTarget();this.ensureMessageFlowPoolConnectionRule(b,c,a.parent);}},handleDragDropEnd:function(b){var a=this.facade.getSelection();if(!a){return;}this.queueOnShapeList(a);},checkListOfShapes:function(a){if(!a){return;}a.each(function(c){if(c.getStencil().idWithoutNs()==="SequenceFlow"||c.getStencil().idWithoutNs()==="MessageFlow"){var d=c.getSource();var b=c.getTarget();this.ensureMessageFlowPoolConnectionRule(d,b,c);}}.bind(this));},processSelection:function(a){if(a instanceof ORYX.Core.Edge&&(a.getStencil().idWithoutNs()==="SequenceFlow"||a.getStencil().idWithoutNs()==="MessageFlow")){var c=a.getSource();var b=a.getTarget();this.ensureMessageFlowPoolConnectionRule(c,b,a);}else{if(a instanceof ORYX.Core.Node){this.checkListOfShapes(a.getIncomingShapes());this.checkListOfShapes(a.getOutgoingShapes());}}},isPoolOrLane:function(a){if(a.getStencil().idWithoutNs().endsWith("Pool")||a.getStencil().idWithoutNs().endsWith("Lane")){return true;}return false;},retrieveParentPool:function(a){if(!a){return;}var b=a;while(b.getParentShape()){b=b.getParentShape();if(!b instanceof ORYX.Core.Node||b instanceof ORYX.Core.Canvas){return;}if(b.getStencil().idWithoutNs()==="Pool"||b.getStencil().idWithoutNs()==="VerticalPool"||b.getStencil().idWithoutNs()==="CollapsedPool"){return b;}}},ensureMessageFlowPoolConnectionRule:function(c,b,a){if(!c||!b||!a||!c.parent||!b.parent||!a.parent||this.isPoolOrLane(b)||this.isPoolOrLane(c)){return;}if(a.getStencil().idWithoutNs()==="SequenceFlow"){var d=this.retrieveParentPool(c);var h=this.retrieveParentPool(b);var g=this.facade.getStencilSets();if(!g||(!d&&!h)||d==h){return;}var f=g["http://b3mn.org/stencilset/bpmn2.0#"].stencil("http://b3mn.org/stencilset/bpmn2.0#MessageFlow");if(!this.facade.getRules().canConnect({sourceShape:c,edgeStencil:f,targetShape:b})){return;}var k=this.morphShape(a,f);this.morphCommands.push(k);return;}else{if(a.getStencil().idWithoutNs()==="MessageFlow"){var d=this.retrieveParentPool(c);var h=this.retrieveParentPool(b);var g=this.facade.getStencilSets();if((c.parent instanceof ORYX.Core.Canvas&&b.parent instanceof ORYX.Core.Canvas)||((d||h)&&(!g||d!=h))){return;}var e=g["http://b3mn.org/stencilset/bpmn2.0#"].stencil("http://b3mn.org/stencilset/bpmn2.0#SequenceFlow");if(!this.facade.getRules().canConnect({sourceShape:c,edgeStencil:e,targetShape:b})){return;}var k=this.morphShape(a,e);this.morphCommands.push(k);return;}}},morphShape:function(b,d){var f=ORYX.Core.Command.extend({construct:function(g,k,h){this.shape=g;this.stencil=k;this.facade=h;this.removeEdge=[];this.reconnectedEdges=[];},execute:function(){var r=this.shape;if(!r.parent){return;}var v=this.stencil;var q=r.resourceId;r._update();var l=r.serialize();v.properties().each((function(x){if(x.readonly()){l=l.reject(function(y){return y.name==x.id();});}}).bind(this));if(this.newShape){newShape=this.newShape;this.facade.getCanvas().add(newShape);}else{newShape=this.facade.createShape({type:v.id(),namespace:v.namespace(),resourceId:q,dontUpdateSelection:true});}var p=l.find(function(x){return(x.prefix==="oryx"&&x.name==="bounds");});var s=null;if(!this.facade.getRules().preserveBounds(r.getStencil())){var g=p.value.split(",");if(parseInt(g[0],10)>parseInt(g[2],10)){var n=g[0];g[0]=g[2];g[2]=n;n=g[1];g[1]=g[3];g[3]=n;}g[2]=parseInt(g[0],10)+newShape.bounds.width();g[3]=parseInt(g[1],10)+newShape.bounds.height();p.value=g.join(",");}else{var u=r.bounds.height();var h=r.bounds.width();if(newShape.minimumSize){if(r.bounds.height()<newShape.minimumSize.height){u=newShape.minimumSize.height;}if(r.bounds.width()<newShape.minimumSize.width){h=newShape.minimumSize.width;}}if(newShape.maximumSize){if(r.bounds.height()>newShape.maximumSize.height){u=newShape.maximumSize.height;}if(r.bounds.width()>newShape.maximumSize.width){h=newShape.maximumSize.width;}}s={a:{x:r.bounds.a.x,y:r.bounds.a.y},b:{x:r.bounds.a.x+h,y:r.bounds.a.y+u}};}var t=r.bounds.center();if(s!==null){newShape.bounds.set(s);}this.setRelatedDockers(r,newShape);var o=r.node.parentNode;var k=r.node.nextSibling;var m=r.getChildNodes();this.facade.deleteShape(r);newShape.deserialize(l);if(s!==null){newShape.bounds.set(s);}if(newShape.getStencil().type()==="edge"||(newShape.dockers.length==0||!newShape.dockers[0].getDockedShape())){newShape.bounds.centerMoveTo(t);}if(newShape.getStencil().type()==="node"&&(newShape.dockers.length==0||!newShape.dockers[0].getDockedShape())){this.setRelatedDockers(newShape,newShape);}this.resetAllChildShapes(m,newShape);if(k){o.insertBefore(newShape.node,k);}else{o.appendChild(newShape.node);}this.facade.updateSelection();newShape.isChanged=true;this.newShape=newShape;newShape._update();},rollback:function(){if(!this.shape||!this.newShape||!this.newShape.parent){return;}this.newShape.parent.add(this.shape);this.newShape.getChildNodes().each(function(g){if(this.facade.getRules().canContain({containingShape:this.shape,containedShape:g})){this.shape.add(g);}}.bind(this));this.removeEdge.each(function(g){this.facade.getCanvas().add(g);}.bind(this));this.reconnectedEdges.each(function(g){g.docker.setDockedShape(g.shape);g.docker.setReferencePoint(g.point);}.bind(this));this.setRelatedDockers(this.newShape,this.shape);this.facade.deleteShape(this.newShape);this.shape._update();},getValidChildren:function(h,g){return h.findAll(function(k){return this.facade.getRules().canContain({containingShape:g instanceof ORYX.Core.Shape?g:undefined,containingStencil:g instanceof ORYX.Core.StencilSet.Stencil?g:undefined,containedShape:k});}.bind(this));},resetAllChildShapes:function(m,l){var k=this.getValidChildren(m,l);var h=m.without.apply(m,k);var g=l.absoluteXY();this.reconnectedEdges=[];h.each(function(n){n.getAllDockedShapes().each(function(q){if(!(q instanceof ORYX.Core.Edge)||!q.parent){return;}var p=q.getSource()===n?q.getTarget():q.getSource();if(p&&!m.include(p)&&this.facade.getRules().canConnect({sourceShape:q.getSource()===n?n:p,edgeShape:q,targetShape:q.getTarget()===n?n:p})){var r=q.getSource()===n?q.dockers.first():q.dockers.last();var o=Object.clone(r.getAbsoluteReferencePoint());o.x-=g.x;o.y-=g.y;this.reconnectedEdges.push({shape:r.getDockedShape(),docker:r,point:Object.clone(r.referencePoint)});r.setDockedShape(l);r.setReferencePoint(o);}else{if(!this.removeEdge.include(q)){this.removeEdge.push(q);}q.parent.remove(q);}}.bind(this));}.bind(this));k.each(function(n){l.add(n);});},setRelatedDockers:function(g,h){if(g.getStencil().type()==="node"){(g.incoming||[]).concat(g.outgoing||[]).each(function(k){k.dockers.each(function(n){if(n.getDockedShape()==g){var m=Object.clone(n.referencePoint);var o={x:m.x*h.bounds.width()/g.bounds.width(),y:m.y*h.bounds.height()/g.bounds.height()};n.setDockedShape(h);n.setReferencePoint(o);if(k instanceof ORYX.Core.Edge){n.bounds.centerMoveTo(o);}else{var l=g.absoluteXY();n.bounds.centerMoveTo({x:o.x+l.x,y:o.y+l.y});}}});});if(g.dockers.length>0&&g.dockers.first().getDockedShape()){h.dockers.first().setDockedShape(g.dockers.first().getDockedShape());h.dockers.first().setReferencePoint(Object.clone(g.dockers.first().referencePoint));}}else{h.dockers.first().setDockedShape(g.dockers.first().getDockedShape());h.dockers.first().setReferencePoint(g.dockers.first().referencePoint);h.dockers.last().setDockedShape(g.dockers.last().getDockedShape());h.dockers.last().setReferencePoint(g.dockers.last().referencePoint);}}});var c=b.getChildNodes();var a=f.prototype.getValidChildren.call(this,c,d).length!==c.length;var e=function(){var g=new f(b,d,this.facade);return g;}.bind(this);if(!a){return e();}}};ORYX.Plugins.BPMN2_0MessageFlow=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2_0MessageFlow);}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}new function(){ORYX.Plugins.BPMN2_0ProcessId={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,this.handleShapeAdded.bind(this));},handleShapeAdded:function(b){var a=b.shape;var d="";if(!this.isPool(a)){return;}if(this.facade.isExecutingCommands()){var c=ORYX.Core.Command.extend({construct:function(e){this.shape=e;this.oldProcessId=e.properties["oryx-processid"];this.processId=(this.oldProcessId?this.oldProcessId+"_":"")+ORYX.Editor.provideId();},execute:function(){this.shape.setProperty("oryx-processid",this.processId);},rollback:function(){this.shape.setProperty("oryx-processid",this.oldProcessId);}});this.facade.executeCommands([new c(a)]);}},isPool:function(a){var b=["http://b3mn.org/stencilset/bpmn2.0#Pool","http://b3mn.org/stencilset/bpmn2.0#VerticalPool"];return b.include(a.getStencil().id());}};ORYX.Plugins.BPMN2_0ProcessId=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2_0ProcessId);}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}new function(){ORYX.Plugins.BPMN2_0MoveLaneButtons=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){ORYX.CONFIG.BPMN20_ENABLE_LANE_MOVE_BUTTONS=true;}});}();new function(){ORYX.Plugins.BPMN2_0PoolLayout=ORYX.Plugins.AbstractPlugin.extend({construct:function(b){this.facade=b;this.facade.registerOnEvent("layout.bpmn2_0.pool",this.handleLayoutPool.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEREMOVED,this.handleShapeRemove.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BPMN20_DELETE_HASH,this.deleteHash.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BPMN20_ADJUST_LANES,this.handleAdjustLanesEvent.bind(this));this.namespace=undefined;},afterLoad:function(){this.facade.getCanvas().getChildNodes().each(function(b){if(b.getStencil().id().endsWith("Pool")){var c=b.getStencil().id();this.handleLayoutPool({shape:b,orientation:(c.endsWith("VerticalPool")?"vertical":"horizontal")});}}.bind(this));if(ORYX.CONFIG.BPMN20_ENABLE_LANE_MOVE_BUTTONS){this._createMoveButtons();}},deleteHash:function(b){var c=this.getPool(b.shape);if(this.hashedBounds[c.id]){if(this.hashedBounds[c.id][b.shape.id]){this.hashedBounds[c.id][b.shape.id]=b.shape.absoluteBounds();}if(this.hashedPoolPositions[c.id]){this.hashedPoolPositions[c.id]=c.bounds.clone();}}},handleAdjustLanesEvent:function(b){if(!b.shape||!b.offset){return;}var c=b.pool||this.getPool(b.shape);if(!c){return;}this.adjustLanes(c,[b.shape],b.offset.x,b.offset.y);},onSelectionChanged:function(h){var f=h.elements;if(ORYX.CONFIG.BPMN20_ENABLE_LANE_MOVE_BUTTONS&&f&&f.length!==1){this.hideMoveButtons();}if(f&&f.length===1){var e=this.getNamespace();var b=f[0];if(b.getStencil().idWithoutNs()==="Pool"){if(b.getChildNodes().length===0){var d={type:e+"Lane",position:{x:0,y:0},namespace:b.getStencil().namespace(),parent:b};this.facade.createShape(d);this.facade.getCanvas().update();this.facade.setSelection([b]);}}else{if(b.getStencil().idWithoutNs()==="VerticalPool"){if(b.getChildNodes().length===0){var d={type:e+"VerticalLane",position:{x:0,y:0},namespace:b.getStencil().namespace(),parent:b};this.facade.createShape(d);this.facade.getCanvas().update();this.facade.setSelection([b]);}}}if(ORYX.CONFIG.BPMN20_ENABLE_LANE_MOVE_BUTTONS){this.showMoveButtons(b);}}if(f.any(function(l){return l instanceof ORYX.Core.Node&&l.getStencil().id().endsWith("Lane");})){var c=f.findAll(function(l){return l instanceof ORYX.Core.Node&&l.getStencil().id().endsWith("Lane");});var g=[];var k=[];c.each(function(l){g.push(this.getParentPool(l));}.bind(this));g=g.uniq().compact().findAll(function(l){var m=this.getLanes(l,true);if(m.all(function(n){return c.include(n);})){k=k.concat(m);return true;}else{if(f.include(l)&&m.any(function(n){return c.include(n);})){k=k.concat(m);return true;}else{return false;}}}.bind(this));if(k.length>0&&g.length>0){f=f.without.apply(f,k);f=f.concat(g);this.facade.setSelection(f.uniq());}}},handleShapeRemove:function(e){var f=e.shape;var m=e.parent;if(f instanceof ORYX.Core.Node&&(f.getStencil().idWithoutNs()==="Lane"||f.getStencil().idWithoutNs()==="VerticalLane")&&this.facade.isExecutingCommands()){var l=f.getStencil().idWithoutNs();var g=this.getParentPool(m);if(g&&g.parent){var h=function(n){return !n.getChildNodes().any(function(o){return o.getStencil().idWithoutNs()===l;});};var c=h(f);var k=m.getChildNodes().any(function(n){return n.getStencil().idWithoutNs()===l;});if(c&&k){var d=new a(f,m,g,this);this.facade.executeCommands([d]);}else{if(!c&&!this.facade.getSelection().any(function(n){return n instanceof ORYX.Core.Node&&n.getStencil().idWithoutNs()===l&&n.isParent(f)&&h(n);})){var b=ORYX.Core.Command.extend({construct:function(n,p,o){this.children=n.getChildNodes(true);this.facade=p;if(o==="VerticalLane"){this.xOff=0;this.yOff=30;}else{this.xOff=30;this.yOff=0;}},execute:function(){this.children.each(function(n){n.bounds.moveBy(this.xOff,this.yOff);}.bind(this));},rollback:function(){this.children.each(function(n){n.bounds.moveBy(-this.xOff,-this.yOff);}.bind(this));}});this.facade.executeCommands([new b(f,this.facade,l)]);}else{if(c&&!k&&m==g){m.add(f);}}}}}},getParentPool:function(b){while(b&&!b.getStencil().id().endsWith("Pool")){if(b instanceof ORYX.Core.Canvas){return null;}b=b.parent;}return b;},hashedPoolPositions:{},hashedLaneDepth:{},hashedBounds:{},hashedPositions:{},handleLayoutPool:function(z){var r=z.shape;this.orientation=z.orientation;if(this.orientation==="horizontal"){var g="height";var v="width";}else{if(this.orientation==="vertical"){var g="width";var v="height";}else{return;}}var J=this.facade.getSelection();var B=J.include(r)?r:J.first();B=B||r;this.currentPool=r;if(!this.facade.isExecutingCommands()&&!B.isChanged){B=r;}if(!(B.getStencil().id().endsWith("Pool")||B.getStencil().id().endsWith("Lane"))){return;}if(!this.hashedBounds[r.id]){this.hashedBounds[r.id]={};}if(B!==r&&!B.isParent(r)&&!this.hashedBounds[r.id][B.id]){return;}var E=this.getLanes(r);if(E.length<=0){return;}var D=this.getLanes(r,true);var k=D.clone();var n=$H({});D.each(function(x){n[x.id]=x.bounds.upperLeft();});if(E.length===1&&this.getLanes(E.first()).length<=0){E.first().setProperty("oryx-showcaption",false);var c=E.first();var C=c.properties["oryx-name"];if(C.length>0&&this.facade.isExecutingCommands()){var m=this.removeLable(C,c);this.facade.executeCommands([m]);}var d=E.first().node.getElementsByTagName("rect");d[0].setAttributeNS(null,"display","none");}else{D.invoke("setProperty","oryx-showcaption",true);D.each(function(x){var y=x.node.getElementsByTagName("rect");y[0].removeAttributeNS(null,"display");});}var u=[];var q=[];var A=-1;while(++A<D.length){if(!this.hashedBounds[r.id][D[A].id]){q.push(D[A]);}}if(q.length>0){B=q.first();}var G=$H(this.hashedBounds[r.id]).keys();var A=-1;while(++A<G.length){if(!D.any(function(x){return x.id==G[A];})){u.push(this.hashedBounds[r.id][G[A]]);J=J.without(function(x){return x.id==G[A];});}}var f={},p,o;if(u.length>0||q.length>0){if(q.length===1&&this.getLanes(q[0].parent).length===1){f[g]=this.adjustShortEdge(E,q[0].parent);}else{f[g]=this.updateShortLength(r);}f[v]=this.adjustLongEdge(E,r.bounds[v]());}else{if(r==B){if(J.length===1&&this.isResized(r,this.hashedPoolPositions[r.id])){var F=this.hashedPoolPositions[r.id].upperLeft();var h=r.bounds.upperLeft();var I=0;if(this.shouldScale(r)){var b=this.hashedPoolPositions[r.id];I=b[g]()/r.bounds[g]();}this.adjustLanes(r,D,F.x-h.x,F.y-h.y,I);}f[g]=this.adjustShortEdge(E,undefined,r.bounds[g]());f[v]=this.adjustLongEdge(E,r.bounds[v]());}else{if(J.length===1&&this.isResized(B,this.hashedBounds[r.id][B.id])){var F=this.hashedBounds[r.id][B.id].upperLeft();var h=B.absoluteXY();p=F.x-h.x;o=F.y-h.y;if(p||o){k=k.without(B);this.adjustLanes(r,this.getAllExcludedLanes(r,B),p,0);}var l=this.getLanes(B,true);if(l.length>0){if(this.shouldScale(B)){var b=this.hashedBounds[r.id][B.id];var I=b[g]()/B.bounds[g]();this.adjustLanes(r,l,p,o,I);}else{this.adjustLanes(r,l,p,o,0);}}}var H=D.map(function(x){return{shape:x,bounds:x.bounds.clone()};});f[g]=this.adjustShortEdge(E,B);this.checkForChanges(D,H);f[v]=this.adjustLongEdge(E,B.bounds[v]()+(this.getDepth(B,r)*30));}}this.setDimensions(r,f["width"],f["height"],p,o);if(this.facade.isExecutingCommands()&&(u.length===0||q.length!==0)){this.updateDockers(k,r);if(this.hashedPositions[r.id]&&this.hashedPositions[r.id].keys().any(function(y,x){return(D[x]||{}).id!==y;})){var t=ORYX.Core.Command.extend({construct:function(L,K,y,M,x){this.originPosition=Object.clone(L);this.newPosition=Object.clone(K);this.lanes=y;this.plugin=M;this.pool=x;},execute:function(){if(!this.executed){this.executed=true;this.lanes.each(function(x){if(this.newPosition[x.id]){x.bounds.moveTo(this.newPosition[x.id]);}}.bind(this));this.plugin.hashedPositions[this.pool]=Object.clone(this.newPosition);}},rollback:function(){this.lanes.each(function(x){if(this.originPosition[x.id]){x.bounds.moveTo(this.originPosition[x.id]);}}.bind(this));this.plugin.hashedPositions[this.pool]=Object.clone(this.originPosition);}});var s=$H({});D.each(function(x){s[x.id]=x.bounds.upperLeft();});var e=new t(n,s,D,this,r.id);this.facade.executeCommands([e]);}}this.hashedBounds[r.id]={};this.hashedPositions[r.id]=n;var A=-1;while(++A<D.length){this.hashedBounds[r.id][D[A].id]=D[A].absoluteBounds();this.hashChildShapes(D[A]);this.hashedLaneDepth[D[A].id]=this.getDepth(D[A],r);this.forceToUpdateLane(D[A]);}this.hashedPoolPositions[r.id]=r.bounds.clone();},adjustShortEdge:function(b,n,l){var d=0;var e={};if(this.orientation==="horizontal"){var k="height";}else{if(this.orientation==="vertical"){var k="width";}else{return;}}if(!n&&l){var f=-1;while(++f<b.length){d+=b[f].bounds[k]();}}var f=-1;var c={};c["width"]=0;c["height"]=0;var m={};m["width"]=30;m["height"]=30;m[k]=0;while(++f<b.length){if(b[f]===n){this.adjustShortEdge(this.getLanes(b[f]),undefined,b[f].bounds[k]());var h={x:m["width"]+c["width"],y:m["height"]+c["height"]};var g={x:b[f].bounds.width()+m["width"]+c["width"],y:b[f].bounds.height()+m["height"]+c["height"]};b[f].bounds.set(h,g);}else{if(!n&&l){var o=(b[f].bounds[k]()*l)/d;this.adjustShortEdge(this.getLanes(b[f]),undefined,o);this.setDimensions(b[f],(k==="width"?o:null),(k==="height"?o:null));this.setLanePosition(b[f],c[k]);}else{var o=this.adjustShortEdge(this.getLanes(b[f]),n,l);if(!o){o=b[f].bounds[k]();}this.setDimensions(b[f],(k==="width"?o:null),(k==="height"?o:null));this.setLanePosition(b[f],c[k]);}}c[k]+=b[f].bounds[k]();}return c[k];},setDimensions:function(f,h,c,b,k){var d=f.getStencil().id().endsWith("Lane");if(this.orientation==="horizontal"){var g={x:d?30:(f.bounds.a.x-(b||0)),y:d?f.bounds.a.y:(f.bounds.a.y-(k||0))};var e={x:h?f.bounds.a.x+h-(d?30:(b||0)):f.bounds.b.x,y:c?f.bounds.a.y+c-(d?0:(k||0)):f.bounds.b.y};}else{if(this.orientation==="vertical"){var g={x:d?f.bounds.a.x:(f.bounds.a.x-(b||0)),y:d?30:(f.bounds.a.y-(k||0))};var e={x:h?f.bounds.a.x+h-(d?0:(b||0)):f.bounds.b.x,y:c?f.bounds.a.y+c-(d?30:(k||0)):f.bounds.b.y};}else{return;}}f.bounds.set(g,e);},setLanePosition:function(b,c){if(this.orientation==="horizontal"){b.bounds.moveTo(30,c);}else{if(this.orientation==="vertical"){b.bounds.moveTo(c,30);}}},adjustLongEdge:function(b,c){(b||[]).each(function(d){if(this.orientation==="horizontal"){this.setDimensions(d,c);this.adjustLongEdge(this.getLanes(d),c-30);}else{if(this.orientation==="vertical"){this.setDimensions(d,null,c);this.adjustLongEdge(this.getLanes(d),c-30);}}}.bind(this));return c;},isResized:function(b,d){if(!d||!b){return false;}var c=d;return Math.round(c.width()-b.bounds.width())!==0||Math.round(c.height()-b.bounds.height())!==0;},shouldScale:function(b){var c=b.getChildNodes().findAll(function(d){return d.getStencil().id().endsWith("Lane");});return c.length>1||c.any(function(d){return this.shouldScale(d);}.bind(this));},adjustLanes:function(d,c,b,f,e){e=e||0;if(this.orientation==="horizontal"){c.each(function(g){g.getChildNodes().each(function(k){if(!k.getStencil().id().endsWith("Lane")){var h=e?k.bounds.center().y-(k.bounds.center().y/e):-f;k.bounds.moveBy((b||0),-h);if(e&&k.getStencil().id().endsWith("Subprocess")){this.moveChildDockers(k,{x:(0),y:-h});}}}.bind(this));this.hashedBounds[d.id][g.id].moveBy(-(b||0),!e?-f:0);if(e){g.isScaled=true;}}.bind(this));}else{if(this.orientation==="vertical"){c.each(function(g){g.getChildNodes().each(function(k){if(!k.getStencil().id().endsWith("Lane")){var h=e?k.bounds.center().x-(k.bounds.center().x/e):-b;k.bounds.moveBy(-h,(f||0));if(e&&k.getStencil().id().endsWith("Subprocess")){this.moveChildDockers(k,{x:-h,y:0});}}}.bind(this));this.hashedBounds[d.id][g.id].moveBy(!e?-b:0,-(f||0));if(e){g.isScaled=true;}}.bind(this));}}},getAllExcludedLanes:function(d,b){var c=[];d.getChildNodes().each(function(e){if((!b||e!==b)&&e.getStencil().id().endsWith("Lane")){c.push(e);c=c.concat(this.getAllExcludedLanes(e,b));}}.bind(this));return c;},getDepth:function(d,c){var b=0;while(d&&d.parent&&d!==c){d=d.parent;++b;}return b;},updateDockers:function(E,u){var s=u.absoluteBounds(),x=[];var t=(this.hashedPoolPositions[u.id]||s).clone();var D=-1,C=-1,A=-1,y=-1,v;var F={};while(++D<E.length){if(!this.hashedBounds[u.id][E[D].id]){continue;}var d=E[D].isScaled;delete E[D].isScaled;var h=E[D].getChildNodes();var q=E[D].absoluteBounds();var e=(this.hashedBounds[u.id][E[D].id]||q);var m=this.getOffset(E[D],true,u);var f=0;var o=0;var H=this.getDepth(E[D],u);if(this.hashedLaneDepth[E[D].id]!==undefined&&this.hashedLaneDepth[E[D].id]!==H){if(this.orientation==="horizontal"){f=(this.hashedLaneDepth[E[D].id]-H)*30;m.x+=f;}else{if(this.orientation==="vertical"){o=(this.hashedLaneDepth[E[D].id]-H)*30;m.y+=o;}}}C=-1;while(++C<h.length){if((f||o)&&!h[C].getStencil().id().endsWith("Lane")){x.push({xOffsetDepth:f,yOffsetDepth:o,shape:h[C]});h[C].bounds.moveBy(f,o);}if(h[C].getStencil().id().endsWith("Subprocess")){this.moveChildDockers(h[C],m);}var c=[].concat(h[C].getIncomingShapes()).concat(h[C].getOutgoingShapes()).findAll(function(k){return k instanceof ORYX.Core.Edge;});A=-1;while(++A<c.length){if(c[A].getStencil().id().endsWith("MessageFlow")){this.layoutEdges(h[C],[c[A]],m);continue;}y=-1;while(++y<c[A].dockers.length){v=c[A].dockers[y];if(v.getDockedShape()||v.isChanged){continue;}pos=v.bounds.center();var b=e.isIncluded(pos);var r=!t.isIncluded(pos);var g=y==0?b:e.isIncluded(c[A].dockers[y-1].bounds.center());var n=y==c[A].dockers.length-1?b:e.isIncluded(c[A].dockers[y+1].bounds.center());var G=Object.clone(m);if(d&&b&&this.isResized(E[D],this.hashedBounds[u.id][E[D].id])){if(this.orientation==="horizontal"){var z=(pos.y-q.upperLeft().y+G.y);G.y-=(z-(z*(q.height()/e.height())));}else{if(this.orientation==="vertical"){var B=(pos.x-q.upperLeft().x+G.x);G.x-=(B-(B*(q.width()/e.width())));}}}if(b){F[v.id]={docker:v,offset:G};}}}}}var p=ORYX.Core.Command.extend({construct:function(k){this.state=k;},execute:function(){if(this.executed){this.state.each(function(k){k.shape.bounds.moveBy((k.xOffset||0),(k.yOffset||0));});}this.executed=true;},rollback:function(){this.state.each(function(k){k.shape.bounds.moveBy(-(k.xOffset||0),(-k.yOffset||0));});}});this.facade.executeCommands([new ORYX.Core.MoveDockersCommand(F),new p(x)]);},getOffset:function(b,d,c){var f={x:0,y:0};var f=b.absoluteXY();var e=this.hashedBounds[c.id][b.id]||(d===true?this.hashedPoolPositions[b.id]:undefined);if(e){f.x-=e.upperLeft().x;f.y-=e.upperLeft().y;}else{return{x:0,y:0};}return f;},moveChildDockers:function(d,g){if(!g.x&&!g.y){return;}var e=d.getChildNodes(true);var c=e.map(function(h){return[].concat(h.getIncomingShapes()).concat(h.getOutgoingShapes());}).flatten().uniq().map(function(h){return h.dockers.length>2?h.dockers.slice(1,h.dockers.length-1):[];}).flatten();var b=d.absoluteBounds();b.moveBy(-g.x,-g.y);var f={};c.each(function(m){if(m.isChanged){return;}var k=Object.clone(g);if(!b.isIncluded(m.bounds.center())){var o=m.parent.dockers.indexOf(m);var s=m.parent.dockers.length;var q=m.parent.getSource();var r=m.parent.getTarget();var l=e.include(q)&&e.include(r);if(!l){var n=o!==0?b.isIncluded(m.parent.dockers[o-1].bounds.center()):false;var p=o!==s-1?b.isIncluded(m.parent.dockers[o+1].bounds.center()):false;if(!n&&!p){return;}var h=m.parent.dockers[n?o-1:o+1];if(Math.abs(-Math.abs(h.bounds.center().x-m.bounds.center().x))<2){k.y=0;}else{if(Math.abs(-Math.abs(h.bounds.center().y-m.bounds.center().y))<2){k.x=0;}else{return;}}}}f[m.getId()]={docker:m,offset:k};});this.facade.executeCommands([new ORYX.Core.MoveDockersCommand(f)]);},showMoveButtons:function(c){this.hideMoveButtons();if(!(c instanceof ORYX.Core.Node)||!["VerticalLane","Lane"].include(c.getStencil().idWithoutNs())){return;}var m=c.parent;if(!m||m instanceof ORYX.Core.Canvas){return;}var t=this.getLanes(this.getPool(c),true);var x=t.indexOf(c);var q=this.getLanes(m);var e=q.indexOf(c);var o=q[e-1];var s=q[e+1];var p=this.facade.getCanvas().zoomLevel;var h=c.absoluteBounds();var n=h.upperLeft();var k=h.lowerRight();if(o){var l=this.moveButtons[(this.orientation==="horizontal"?"up":"left")];var v={x:(n.x*p),y:(n.y*p)};l.setDescription(ORYX.I18N.PoolLaneHandling.buttonSwitch);this.showButton(l,"pre",c,m,o,v);var b=this.getLanes(o);if((b||[]).length>0){var g=this.moveButtons[(this.orientation==="horizontal"?"right":"down")];var u=b.last();var d={x:(this.orientation==="horizontal"?v.x+20:v.x)*p,y:(this.orientation==="horizontal"?v.y:v.y+20)*p};g.setDescription(ORYX.I18N.PoolLaneHandling.buttonIndent);this.showButton(g,"pre",c,u.parent,undefined,d);}}else{if(!(m.parent instanceof ORYX.Core.Canvas)){var l=this.moveButtons[(this.orientation==="horizontal"?"left":"up")];var v={x:(this.orientation==="horizontal"?n.x:n.x)*p,y:(this.orientation==="horizontal"?n.y:n.y)*p};var r={x:(this.orientation==="horizontal"?0:-1),y:(this.orientation==="horizontal"?-1:0)};l.setDescription(ORYX.I18N.PoolLaneHandling.buttonOutdent);this.showButton(l,"pre",c,m.parent,undefined,v,r);}}if(s){var l=this.moveButtons[(this.orientation==="horizontal"?"down":"right")];var v={x:(this.orientation==="horizontal"?n.x:k.x-29)*p,y:(this.orientation==="horizontal"?k.y-29:n.y)*p};l.setDescription(ORYX.I18N.PoolLaneHandling.buttonSwitch);this.showButton(l,"post",c,m,s,v);var f=this.getLanes(s);if((f||[]).length>0){var g=this.moveButtons[(this.orientation==="horizontal"?"right":"down")];var u=f.first();var d={x:(this.orientation==="horizontal"?v.x+20:v.x)*p,y:(this.orientation==="horizontal"?v.y:v.y+20)*p};g.setDescription(ORYX.I18N.PoolLaneHandling.buttonIndent);this.showButton(g,"post",c,u.parent,undefined,d);}}else{if(!(m.parent instanceof ORYX.Core.Canvas)){var l=this.moveButtons[(this.orientation==="horizontal"?"left":"up")];var v={x:(this.orientation==="horizontal"?n.x:k.x-29)*p,y:(this.orientation==="horizontal"?k.y-29:n.y)*p};l.setDescription(ORYX.I18N.PoolLaneHandling.buttonOutdent);this.showButton(l,"post",c,m.parent,undefined,v);}}},showButton:function(d,h,g,f,c,e,b){if(!d||!e||!g){return;}d.clb=this.moveLane.bind(this,{moveShape:g,targetParent:f,targetShape:c,horizontal:this.orientation==="horizontal",adjustLane:b,direction:h});d.setPosition(e.x,e.y);d.setLevel(0);d.show();},moveLane:function(b){if(!b){return;}if(b.targetShape){var c;if(b.direction==="pre"){c=b.targetShape.bounds;}else{c=b.moveShape.bounds;}var e=(b.horizontal?c.height():c.width())+1;if(b.direction==="pre"){e*=-1;}}var d={x:(b.horizontal?0:(e||0)),y:(b.horizontal?(e||0):0)};if(b.adjustLane&&"number"===typeof b.adjustLane.x&&"number"===typeof b.adjustLane.y){d.x+=b.adjustLane.x;d.y+=b.adjustLane.y;}this.facade.executeCommands([new ORYX.Core.Command.Move([b.moveShape],d,b.targetParent,[b.moveShape],this),new ORYX.Core.EnsureChildCommand(this.facade,[b.targetParent])]);},hideMoveButtons:function(){if(this.moveButtons){$H(this.moveButtons).values().invoke("hide");}},checkForChanges:function(b,c){if(this.facade.isExecutingCommands()&&c.any(function(e){return e.shape.bounds.toString()!==e.bounds.toString();})){var d=ORYX.Core.Command.extend({construct:function(e){this.oldState=e;this.newState=e.map(function(f){return{shape:f.shape,bounds:f.bounds.clone()};});},execute:function(){if(this.executed){this.applyState(this.newState);}this.executed=true;},rollback:function(){this.applyState(this.oldState);},applyState:function(e){e.each(function(f){f.shape.bounds.set(f.bounds.upperLeft(),f.bounds.lowerRight());});}});this.facade.executeCommands([new d(c)]);}},forceToUpdateLane:function(b){if(this.orientation==="horizontal"){if(b.bounds.height()!==b._svgShapes[0].height){b.isChanged=true;b.isResized=true;b._update();}}else{if(this.orientation==="vertical"){if(b.bounds.width()!==b._svgShapes[0].width){b.isChanged=true;b.isResized=true;b._update();}}}},removeLable:function(c,b){var d=ORYX.Core.Command.extend({construct:function(f,e,g){this.lane=e;this.oldcaption=f;this.facade=g;},execute:function(){this.lane.setProperty("oryx-name","");},rollback:function(){this.lane.setProperty("oryx-name",this.oldcaption);}});return new d(c,b,this.facade);},getLanes:function(b,d){var f=this.getNamespace();if(this.orientation==="horizontal"){var h="y";var g="height";var e="Lane";}else{if(this.orientation==="vertical"){var h="x";var g="width";var e="VerticalLane";}}var c=b.getChildNodes(d||false).findAll(function(k){return(k.getStencil().id()===f+e);});c=c.sort(function(A,y){var z=Math.round(A.bounds.upperLeft()[h]);var s=Math.round(y.bounds.upperLeft()[h]);var v=Math.round(A.bounds.lowerRight()[h]);var p=Math.round(y.bounds.lowerRight()[h]);var m=this.getHashedBounds(A);var l=this.getHashedBounds(y);var r=Math.round(m.upperLeft()[h]);var C=Math.round(l.upperLeft()[h]);var o=Math.round(m.lowerRight()[h]);var B=Math.round(l.lowerRight()[h]);if(z==s&&v==p){z=r;s=C;v=o;p=B;}if(Math.round(A.bounds[g]()-m[g]())===0&&Math.round(y.bounds[g]()-l[g]())===0){return z<s?-1:(z>s?1:0);}var x=z<s&&v<p;var t=z>s&&v>p;var n=z<s&&v>=p&&o<B;var q=z>=s&&v<p&&r<C;var u=z>s&&v<=p&&o>B;var k=z<=s&&v>p&&r>C;return(x||n||q?-1:(t||u||k?1:0));}.bind(this));return c;},getNamespace:function(){if(!this.namespace){var b=this.facade.getStencilSets();if(b.keys()){this.namespace=b.keys()[0];}else{return undefined;}}return this.namespace;},getHashedBounds:function(b){return this.currentPool&&this.hashedBounds[this.currentPool.id][b.id]?this.hashedBounds[this.currentPool.id][b.id]:b.absoluteBounds();},getPool:function(b){if(!(b instanceof ORYX.Core.Node)||!b.parent){return;}if(["Pool","VerticalPool"].include(b.getStencil().idWithoutNs())){return b;}else{return this.getPool(b.parent);}},updateShortLength:function(b){if(this.orientation==="horizontal"){var e="height";}else{if(this.orientation==="vertical"){var e="width";}else{return;}}var c=this.getLanes(b);if(c.length==0){return b.bounds[e]();}var f={};f[e]=0;var d=-1;while(++d<c.length){this.setLanePosition(c[d],f[e]);f[e]+=this.updateShortLength(c[d]);}this.setDimensions(b,f["width"],f["height"]);return f[e];},hashChildShapes:function(b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_BPMN20_HASHCHILD,shape:b,forceExecution:true});},_createMoveButtons:function(){this.moveButtons={};["left","right","up","down"].each(function(b){this.moveButtons[b]=new ORYX.Plugins.ShapeMenuButton({id:"oryx_canvas_htmlContainer",msg:"",icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/signavio/arrow-move-"+b+".png",cls:"y-movebutton y-movebutton-"+(["left","up"].include(b)?"pre":"post")+"-"+(this.orientation||"horizontal"),callback:function(){if(this.clb instanceof Function){this.clb();}}});}.bind(this));}});var a=ORYX.Core.Command.extend({construct:function(b,d,c,e){this.facade=e.facade;this.plugin=e;this.shape=b;this.changes;this.pool=c;this.parent=d;this.shapeChildren=[];this.shape.getChildShapes().each(function(f){this.shapeChildren.push({shape:f,bounds:{a:{x:f.bounds.a.x,y:f.bounds.a.y},b:{x:f.bounds.b.x,y:f.bounds.b.y}}});}.bind(this));this.shapeUpperLeft=this.shape.bounds.upperLeft();if(this.plugin.orientation==="horizontal"){this.shortEdgeFN="height";this.longEdgeFN="width";this.coord="y";}else{if(this.plugin.orientation==="vertical"){this.shortEdgeFN="width";this.longEdgeFN="height";this.coord="x";}else{return;}}this.parentShortEdgeLength=this.parent.bounds[this.shortEdgeFN]();},getLeafLanes:function(b){var c=this.plugin.getLanes(b).map(function(d){return this.getLeafLanes(d);}.bind(this)).flatten();return c.length>0?c:[b];},findNewLane:function(){var b=this.plugin.getLanes(this.parent);var c=this.getLeafLanes(this.parent);this.lane=c.find(function(d){return d.bounds.upperLeft()[this.coord]>=this.shapeUpperLeft[this.coord];}.bind(this))||c.last();this.laneUpperLeft=this.lane.bounds.upperLeft();},execute:function(){if(this.changes){this.executeAgain();return;}if(!this.lane){this.findNewLane();}if(this.lane){var f=this.laneUpperLeft;var e=this.shapeUpperLeft;var c=this.plugin.getDepth(this.lane,this.parent)-1;this.changes=$H({});if(f[this.coord]>=e[this.coord]){this.lane.getChildShapes().each(function(g){if(!this.changes[g.getId()]){this.changes[g.getId()]=this.computeChanges(g,this.lane,this.lane,this.shape.bounds[this.shortEdgeFN]());}g.bounds.moveBy((this.coord==="x"?this.shape.bounds.width():0),(this.coord==="y"?this.shape.bounds.height():0));}.bind(this));this.plugin.hashChildShapes(this.lane);this.shapeChildren.each(function(g){g.shape.bounds.set(g.bounds);g.shape.bounds.moveBy((this.coord==="y"?(e.x-30)-(c*30):0),(this.coord==="x"?(e.y-30)-(c*30):0));if(!this.changes[g.shape.getId()]){this.changes[g.shape.getId()]=this.computeChanges(g.shape,this.shape,this.lane,0);}this.lane.add(g.shape);}.bind(this));this.lane.bounds.moveBy((this.coord==="x"?e.x-f.x:0),(this.coord==="y"?e.y-f.y:0));}else{if(e[this.coord]>f[this.coord]){this.shapeChildren.each(function(g){g.shape.bounds.set(g.bounds);var k=(this.coord==="y"?(e.x-30)-(c*30):this.lane.bounds.width());var h=(this.coord==="y"?this.lane.bounds.height():(e.y-30)-(c*30));g.shape.bounds.moveBy(k,h);if(!this.changes[g.shape.getId()]){this.changes[g.shape.getId()]=this.computeChanges(g.shape,this.shape,this.lane,0);}this.lane.add(g.shape);}.bind(this));}}}var b=this.lane.bounds[this.shortEdgeFN]();var d=this.lane.length===1?this.parentShortEdgeLength:this.lane.bounds[this.shortEdgeFN]()+this.shape.bounds[this.shortEdgeFN]();this.setShortEdgeLength(d,b,this.parent,this.parentShortEdgeLength,true);this.plugin.getLanes(this.parent).each(function(g){if(!this.changes[g.getId()]&&g!==this.lane&&g!==this.shape){this.changes[g.getId()]=this.computeChanges(g,this.parent,this.parent,0);}}.bind(this));this.update();},setShortEdgeLength:function(f,b,e,d,c){this.plugin.setDimensions(this.lane,this.lane.bounds[this.longEdgeFN](),f);this.plugin.hashedBounds[this.pool.id][this.lane.id]=this.lane.absoluteBounds();this.plugin.adjustShortEdge(this.plugin.getLanes(e),this.lane);if(c===true){this.changes[this.shape.getId()]=this.computeChanges(this.shape,e,e,0,b,f);}if(this.coord==="y"){this.plugin.setDimensions(e,e.bounds.width(),d);}else{this.plugin.setDimensions(e,d,e.bounds.height());}if(e!==this.pool){if(this.coord==="y"){this.plugin.setDimensions(this.pool,this.pool.bounds.width(),this.pool.bounds.height()+(f-b));}else{this.plugin.setDimensions(this.pool,this.pool.bounds.width()+(f-b),this.pool.bounds.height());}}},update:function(){this.plugin.hashedBounds[this.pool.id]["REMOVED"]=true;},rollback:function(){var c=this.laneUpperLeft;var b=this.shapeUpperLeft;this.changes.each(function(m){var h=m.value.oldParent;var e=m.value.shape;var f=m.value.parentShortLength;var d=m.value.oldShortLength;var l=m.value.newShortLength;if(e.getStencil().id().endsWith("Lane")){e.bounds.moveTo(m.value.oldPosition);}if(d){this.setShortEdgeLength(d,l,h,h.bounds[this.shortEdgeFN]()+(d-l));if(c[this.coord]>=b[this.coord]){var k=(this.coord==="y"?0:this.shape.bounds.width()-1);var g=(this.coord==="y"?this.shape.bounds.height()-1:0);this.lane.bounds.moveBy(k,g);}}else{h.add(e);e.bounds.moveTo(m.value.oldPosition);}}.bind(this));},executeAgain:function(){this.changes.each(function(g){var d=g.value.newParent;var c=g.value.shape;var f=g.value.newShortLength;var b=g.value.oldShortLength;if(f){var h=this.laneUpperLeft[this.coord];var e=this.shapeUpperLeft[this.coord];if(h>=e){this.lane.bounds.moveBy(0,e-h);}this.setShortEdgeLength(f,b,d,d.bounds[this.shortEdgeFN]()+(f-b));}else{d.add(c);c.bounds.moveTo(g.value.newPosition);}}.bind(this));this.update();},computeChanges:function(e,m,l,d,c,b){m=this.changes[e.getId()]?this.changes[e.getId()].oldParent:m;var k=this.changes[e.getId()]?this.changes[e.getId()].oldPosition:e.bounds.upperLeft();var g=e.bounds.upperLeft();var f={x:g.x+(this.coord==="x"?d:0),y:g.y+(this.coord==="y"?d:0)};var h={shape:e,parentShortLength:m.bounds[this.shortEdgeFN](),oldParent:m,oldPosition:k,oldShortLength:c,newParent:l,newPosition:f,newShortLength:b};return h;}});ORYX.Core.Command.AdjustLane=ORYX.Core.Command.extend({construct:function(b,c){this.oldState=b;this.newState=b.map(function(d){return{pool:d.pool,shape:d.shape,extension:d.extension,movement:d.movement};});this.plugin=c;},execute:function(){delete this.undo;this.applyState(this.newState);},rollback:function(){this.undo=true;this.applyState(this.oldState);},applyState:function(b){b.each(function(c){this.plugin.facade.raiseEvent({type:ORYX.CONFIG.EVENT_BPMN20_DELETE_HASH,shape:c.shape});this.plugin.facade.getCanvas().update();if(this.undo){if(c.movement){c.shape.bounds.moveBy(c.movement);}if(c.extension){c.shape.bounds.extend({x:-c.extension.x,y:-c.extension.y});}this.plugin.facade.raiseEvent({type:ORYX.CONFIG.EVENT_BPMN20_ADJUST_LANES,pool:c.pool,shape:c.shape,offset:c.extension});}else{if(c.extension){c.shape.bounds.extend({x:-c.extension.x,y:-c.extension.y});}if(c.movement){c.shape.bounds.moveBy({x:-c.movement.x,y:-c.movement.y});}}this.plugin.facade.getCanvas().update();}.bind(this));}});ORYX.Core.MoveLaneCommand=ORYX.Core.Command.extend({construct:function(b,f,c,e,d){this.lane=b;this.newCoordinates=f;this.newDirection=c;this.newParent=e;this.plugin=d;this.facade=d.facade;this.undoStack=[];this.redo=false;},execute:function(){if(this.newCoordinates){this.moveLaneInsideParent();return;}else{if(this.newDirection){var b=this.newDirection.level,g=this.newDirection.position;var h=this.plugin.getPool(this.lane);var d;if(["top","left"].include(g)){d=0;}var e={position:this.lane.bounds.upperLeft(),direction:this.newDirection};if(this.newParent){var l=[];var c=this.getSiblingLanes(this.lane.parent,l);if(!c&&l.length===0){e.movedChildren=l;l.each(function(m){this.lane.add(m);}.bind(this));var f=this.lane.parent;e.removedParent=f.serialize();e.removedParentId=f.resourceId;this.newParent.add(this.lane);if(g==="top"&&b==="outdent"){var k=this.plugin.getLaneAbove(f);if(k){this.lane.bounds.moveTo({x:0,y:k.bounds.upperLeft().y+1});}}if(g==="bottom"&&b==="outdent"){this.lane.bounds.moveTo({x:0,y:f.bounds.upperLeft().y+1});}this.plugin.adjustLanes(h,[this.lane],30,0);this.newParent.remove(f,true);}else{e.parent=this.lane.parent;this.newParent.add(this.lane,d);if(g==="top"&&b==="outdent"){var k=this.plugin.getLaneAbove(e.parent);if(k){this.lane.bounds.moveTo({x:0,y:k.bounds.upperLeft().y+1});}}if(g==="bottom"&&b==="outdent"){this.lane.bounds.moveTo({x:0,y:e.parent.bounds.upperLeft().y+1});}if(g==="top"&&b==="indent"){this.lane.bounds.moveTo({x:30,y:0});}this.facade.getCanvas().update();if(this.redo){this.plugin.adjustLanes(h,[this.lane],30,0);delete this.plugin.hashedBounds[h.id][this.lane.id];}else{this.lane.bounds.extend({x:(b==="outdent"?30:-30),y:0});}}}this.facade.setSelection([this.lane]);this.undoStack.push(e);return;}}},rollback:function(){this.facade.setSelection([this.lane]);var d=this.plugin.getPool(this.lane);var f=this.undoStack.pop(),e;var c={position:this.lane.bounds.upperLeft(),direction:f.direction};if(this.newCoordinates){this.lane.bounds.moveTo(c.position);this.redo=true;return;}var g;if(["top","left"].include(f.direction.position)){g=0;}if(f.removedParent){e=this.facade.createShape({serialize:f.removedParent});e.setResourceId(f.removedParentId);(f.movedChildren||[]).each(function(h){e.add(h);});}if(e||f.parent){c.parent=this.lane.parent;if(e){e.add(this.lane,g);}else{if(f.parent&&f.parent.parent){f.parent.add(this.lane,g);}else{e=this.facade.getCanvas().getChildShapeByResourceId(f.parent.resourceId);if(e){this.lane.parent.remove(this.lane);this.facade.setSelection([e]);this.facade.getCanvas().update();e.add(this.lane,g);this.facade.getCanvas().update();}}}var b=this.plugin.getLanes(this.lane,true);if(b.length>0){this.plugin.adjustLanes(d,b,-f.position.x,0);}else{this.plugin.adjustLanes(d,[this.lane],-f.position.x,0);}delete this.plugin.hashedBounds[d.id][this.lane.id];this.facade.setSelection([f.parent]);}if(b&&b.length>0){this.facade.setSelection([d]);}else{this.facade.setSelection([this.lane]);}this.redo=true;return;},getSiblingLanes:function(b,d){if(!(d instanceof Array)){d=[];}var c=false;d=b.children.without(this.lane).findAll(function(e){if(!(e instanceof ORYX.Core.Node)){return false;}if(["Lane","VerticalLane"].include(e.getStencil().idWithoutNs())){c=true;throw $break;}return true;});return c;},moveLaneInsideParent:function(){var b={position:this.lane.bounds.upperLeft()};this.lane.bounds.moveTo(this.newCoordinates);this.facade.setSelection([this.lane]);this.undoStack.push(b);}});}();if("undefined"===typeof ORYX){var ORYX={};}if("undefined"===typeof ORYX.Plugins){ORYX.Plugins={};}new function(){ORYX.Plugins.BPMN2_0PoolLaneCreation=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;ORYX.CONFIG.BPMN20_SHAPEREPOSITORY_HIDE_POOLS_LANES=true;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BPMN20_DIAGRAM_ORIENTATION_CHANGED,this.init.bind(this));this.orientation=this.facade.getCanvas().getOrientation();var b=this;this.namespace=this.facade.getStencilSets().keys()[0];this.facade.offer({target:ORYX.Plugins.ShapeRepository,title:ORYX.I18N.PoolLaneHandling.poolLane,description:ORYX.I18N.PoolLaneHandling.description,icon:function(){return"/v5designer/editor/stencilsets/bpmn2.0/icons/swimlane/"+(this.facade.getCanvas().getOrientation()==="horizontal"?"":"vertical.")+"lane.png";}.bind(this),hide:function(d){var c=this.facade.getStencilSets().values().first();return !c.stencils().invoke("idWithoutNs").include("Pool");}.bind(this),groups:[ORYX.I18N.PoolLaneHandling.group],index:-1,namespace:this.namespace,id:this.namespace+("Lane"),afterDragEnterClb:function(d,c,f){b.afterDragEnter(this,d,c,f);},afterDragOverClb:function(d,c,f){b.afterDragOver(this,d,c,f);},afterDragOutClb:function(d,c,f){b.afterDragOut(this,d,c,f);},afterDragDropClb:function(d,c,f){b.afterDragDrop(this,d,c,f);},onValidDropClb:function(d,c,e){b.onValidDrop(this,d,c,e);}});this._createOverlays();this._disableStencils();},init:function(){this.orientation=this.facade.getCanvas().getOrientation();this._setShapeRepositoryIcon();this._createOverlays();},_setShapeRepositoryIcon:function(){var b=document.body.getElementsByClassName("x-stencil-lane")[0];if(!(b instanceof HTMLElement)){return;}var a=b.getElementsByClassName("ShapeRepEntreeImg")[0];if(!(a instanceof HTMLElement)){return;}a.setAttributeNS(null,"src","/v5designer/editor/stencilsets/bpmn2.0/icons/swimlane/"+(this.orientation==="horizontal"?"":"vertical.")+"lane.png");},_disableStencils:function(){var a;a=this.facade.getStencilSets()[this.namespace];if(!a){return;}this._setStencilProperty(a,"Pool","hide",true);this._setStencilProperty(a,"Lane","hide",true);this._setStencilProperty(a,"VerticalPool","hide",true);this._setStencilProperty(a,"VerticalLane","hide",true);if(!this.facade.isExecutingCommands()){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});}},_setStencilProperty:function(d,a,e,c){var b=d.stencil(d.namespace()+a);if(!b){return;}b._jsonStencil[e]=c;},afterDragEnter:function(a,c,b,d){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEOVER);},afterDragOver:function(a,c,b,f){if(!a){return;}if(a.highlightShape instanceof Function){a.highlightShape();}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:f});}var d=this.getDropTarget(a._lastOverElements);if(!d){return;}if(this.isLane(d)){this.handleMouseOverLane(d,a,b);return;}if(this.isCanvas(d)){this.handleMouseOverCanvas(d,a,b);return;}this.prohibitLaneDrop(a);this.hideOverlays();if(a.rectangle&&!a.rectangle.hidden){a.rectangle.hide();}},afterDragOut:function(a,c,b,d){if(!a){return;}this.hideOverlays();},afterDragDrop:function(a,c,b,d){this.hideOverlays();if(a.hLine){a.hLine.hide();}if(a.vLine){a.vLine.hide();}if(a.rectangle&&!a.rectangle.hidden){a.rectangle.hide();}this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEOVER);},onValidDrop:function(b,d,a,e){if(b.hideProxy instanceof Function){b.hideProxy();}if(b.rectangle){b.rectangle.hide();}a=this.getDropTarget(b._lastOverElements);if(a instanceof ORYX.Core.Canvas){var c=this.getNearbyPool(e,true);if(c){a=c;}}this.createLane(b,d,a,e);},handleMouseOverCanvas:function(e,b,d){if(!b){return;}this.displayPoolDropHint(b);this.hideOverlays();var c=this.getNearbyPool(d,true);if(c){this.handleMouseOverLane(c,b,d);}else{var f=b.getScale();var a=this.facade.eventCoordinates(d.browserEvent);if(b.snapPosition instanceof Function){a=b.snapPosition(a);}if(!b.bounds||!b.rectangle){return;}b.bounds.set(this.genericPoolBounds);b.bounds.moveTo(a.x/f,a.y/f);b.rectangle.resize(b.bounds);b.rectangle.show();b.setAllowed();}},getNearbyPool:function(d,f){var e=this.facade.eventCoordinates(d.browserEvent);var c=this.facade.getCanvas().getChildShapes().findAll(function(g){return this.isPool(g);}.bind(this)).findAll(function(g){var h=g.bounds.clone();if(this.orientation==="horizontal"){h.moveBy({x:0,y:-30});h.extend({x:0,y:60});}else{h.moveBy({x:-30,y:0});h.extend({x:60,y:0});}return h.isIncluded(e);}.bind(this));if(c.length!==1){return;}if(!f){return c[0];}var b=this.getLanes(c[0]);var a=this.getDockingSide(c[0].bounds,e,false);if(a==="pre"){return b.first();}if(a==="post"){return b.last();}},getDropTarget:function(a){return(a||[]).find(function(b){return this.isCanvas(b)||this.isLane(b)||this.isPool(b);}.bind(this));},getLanes:function(a,c){if(this.orientation==="horizontal"){var f="y";var e="height";var d="Lane";}else{if(this.orientation==="vertical"){var f="x";var e="width";var d="VerticalLane";}}var b=a.getChildNodes(c||false).findAll(function(g){return(g.getStencil().id()===this.namespace+d);}.bind(this));b=b.sort(function(y,v){var x=Math.round(y.bounds.upperLeft()[f]);var q=Math.round(v.bounds.upperLeft()[f]);var t=Math.round(y.bounds.lowerRight()[f]);var n=Math.round(v.bounds.lowerRight()[f]);var k=y.absoluteBounds();var h=v.absoluteBounds();var p=Math.round(k.upperLeft()[f]);var A=Math.round(h.upperLeft()[f]);var m=Math.round(k.lowerRight()[f]);var z=Math.round(h.lowerRight()[f]);if(x==q&&t==n){x=p;q=A;t=m;n=z;}if(Math.round(y.bounds[e]()-k[e]())===0&&Math.round(v.bounds[e]()-h[e]())===0){return x<q?-1:(x>q?1:0);}var u=x<q&&t<n;var r=x>q&&t>n;var l=x<q&&t>=n&&m<z;var o=x>=q&&t<n&&p<A;var s=x>q&&t<=n&&m>z;var g=x<=q&&t>n&&p>A;return(u||l||o?-1:(r||s||g?1:0));}.bind(this));return b;},handleMouseOverLane:function(e,b,d){if(b.hLine){b.hLine.hide();}if(b.vLine){b.vLine.hide();}if(b.rectangle&&!b.rectangle.hidden){b.rectangle.hide();}var c=this.facade.eventCoordinates(d.browserEvent);var a=this.getDockingSide(e.absoluteBounds(),c,this.isSublaneAllowed(e));this.showOverlay(e,a);if(["pre","post"].include(a)){this.displayLaneDropHint(b,a);}else{if(a==="sub"){this.displaySublaneDropHint(b);}}},displayLaneDropHint:function(b,a){var c="";switch(a){case"pre":c=(this.orientation==="horizontal"?ORYX.I18N.PoolLaneHandling.above:ORYX.I18N.PoolLaneHandling.left);break;case"post":c=(this.orientation==="horizontal"?ORYX.I18N.PoolLaneHandling.below:ORYX.I18N.PoolLaneHandling.right);break;default:c="";}b.setAllowed();$A(b.getProxy().getGhost().dom.getElementsByTagName("img")).last().src="/stencilsets/bpmn2.0/icons/swimlane/"+(this.orientation==="horizontal"?"lane.png":"vertical.lane.png");$A(b.getProxy().getGhost().dom.getElementsByTagName("a")).last().textContent=String.format(ORYX.I18N.PoolLaneHandling.insertLane,c);b.getProxy().sync();},displaySublaneDropHint:function(a){a.setAllowed();if(a.getProxy instanceof Function){$A(a.getProxy().getGhost().dom.getElementsByTagName("img")).last().src="/stencilsets/bpmn2.0/icons/swimlane/"+(this.orientation==="horizontal"?"lane.png":"vertical.lane.png");$A(a.getProxy().getGhost().dom.getElementsByTagName("a")).last().textContent=ORYX.I18N.PoolLaneHandling.createSublane;a.getProxy().sync();}},prohibitLaneDrop:function(a){a.setNotAllowed();if(a.getProxy instanceof Function){$A(a.getProxy().getGhost().dom.getElementsByTagName("img")).last().src="/stencilsets/bpmn2.0/icons/swimlane/"+(this.orientation==="horizontal"?"lane.png":"vertical.lane.png");$A(a.getProxy().getGhost().dom.getElementsByTagName("a")).last().textContent=ORYX.I18N.PoolLaneHandling.cannotCreateRole;a.getProxy().sync();}},displayPoolDropHint:function(a){a.setAllowed();if(a.getProxy instanceof Function){$A(a.getProxy().getGhost().dom.getElementsByTagName("img")).last().src="/v5designer/editor/stencilsets/bpmn2.0/icons/swimlane/"+(this.orientation==="horizontal"?"pool.png":"vertical.pool.png");$A(a.getProxy().getGhost().dom.getElementsByTagName("a")).last().textContent=ORYX.I18N.PoolLaneHandling.createPool;a.getProxy().sync();}},showOverlay:function(c,a){if(!this.overlays){return;}var d=this.overlayIds[a];if(!d||!this.overlays[d]){return;}var b=this.overlays[d];this.setOverlayBounds(b,c,a);this.hideOverlays();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:d,node:b,shapes:[c],nodePosition:this.overlayPositions[a],adjustment:this.getOverlayAdjustment(a)});},isSublaneAllowed:function(a){if(this.isOverCompartment(a)){return false;}if(!(a.parent instanceof ORYX.Core.Canvas)&&this.isLane(a)){return a.parent.children.findAll(function(b){if(b instanceof ORYX.Core.Node){return this.isLane(b);}}.bind(this)).length>1;}},isOverCompartment:function(a){return this.isLane(a)&&a.children.any(function(b){return this.isLane(b);}.bind(this));},showSublaneOverlay:function(d){var e=this.overlays[this.overlayIds.sublane];var b=(this.orientation==="horizontal");if(e){var c=(b?d.bounds.width()/3:d.bounds.width()-(2*ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS));var a=(b?d.bounds.height()-(2*ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS):d.bounds.height()/3);e.setAttributeNS(null,"width",c);e.setAttributeNS(null,"height",a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:this.overlayIds.sub});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:this.overlayIds.sub,shapes:[d],node:e,nodePosition:"NE"});}},updateOverlayBounds:function(a){this.overlay.setAttributeNS(null,"width",(this.orientation==="horizontal"?mouseTarget.bounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS));this.overlay.setAttributeNS(null,"height",(this.orientation==="horizontal"?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:mouseTarget.bounds.height()));},createLane:function(l,e,k,b){if(!l||!e||!k||!b){return;}var a=ORYX.Core.Command.extend({construct:function(n,o,q,p){this.dragZone=n;this.facade=o;this.newState=q;this.event=p;},execute:function(){var o=this.newState;var p=this.facade.createShape({type:o.id,namespace:o.namespace});if(o.createdResourceIds&&o.createdResourceIds[0]){p.setResourceId(o.createdResourceIds[0]);}if(o.properties instanceof Hash){o.properties.each(function(q){p.setProperty(q.key,q.value);});}p.bounds.set(o.currentShape.bounds.clone());this.oldState={id:o.id,namespace:o.namespace,horizontal:o.horizontal,target:o.target,targetId:o.targetId,targetBounds:o.targetBounds.clone(),currentShape:o.currentShape,pool:o.pool,poolBounds:o.poolBounds.clone(),position:o.position};if(o.target&&!o.target.parent){o.target=this.facade.getCanvas().getChildShapeByResourceId(o.targetId);}if(["pre","post"].include(o.position)){o.target.add(p);if(o.position==="pre"){this.movePoolUp(p,o);}this.oldState.createdLanes=[p];}else{if(o.position==="sub"){var n=this.facade.createShape({type:o.id,namespace:o.namespace});if(o.createdResourceIds&&o.createdResourceIds[1]){n.setResourceId(o.createdResourceIds[1]);}if(o.properties instanceof Hash){o.properties.each(function(q){n.setProperty(q.key,q.value);});}n.bounds.set(o.currentShape.bounds.clone());o.target.add(p);o.target.add(n);this.oldState.createdLanes=[p,n];}}this.facade.setSelection(this.oldState.createdLanes);this.facade.getCanvas().update();if(!this.adjustChild){this.adjustChild=new ORYX.Core.EnsureChildCommand(this.facade,p);}this.adjustChild.execute();this.facade.updateSelection();delete this.redo;},movePoolUp:function(o,n){n.pool.bounds.moveBy({x:(n.horizontal?0:-o.bounds.width()),y:(n.horizontal?-o.bounds.height():0)});if(!this.redo&&(n.horizontal&&n.pool.bounds.upperLeft().y<0)||(!n.horizontal&&n.pool.bounds.upperLeft().x<0)){this.expandCanvas(o,n);}},expandCanvas:function(o,n){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_CANVAS_RESIZE,position:(n.horizontal?"N":"W"),shrink:false,size:(n.horizontal?o.bounds.height():o.bounds.width())});},rollback:function(){if(this.adjustChild){this.adjustChild.rollback();}var n=this.oldState;n.createdLanes.each(function(o,p){if(!this.newState.createdResourceIds){this.newState.createdResourceIds=new Array();}this.newState.createdResourceIds[p]=o.resourceId;this.facade.deleteShape(o);}.bind(this));n.target.bounds.set(n.targetBounds);n.pool.bounds.set(n.poolBounds);this.facade.getCanvas().update();this.facade.setSelection([n.target]);this.redo=true;}});if(k instanceof ORYX.Core.Canvas){h=k;e.type=this.namespace+(this.orientation==="horizontal"?"Pool":"VerticalPool");this.facade.executeCommands([new ORYX.Core.CreateShapeCommand(e,k,e.position,l)]);return;}else{if(this.isLane(k)){var m=k.getStencil();var f=this.getDockingSide(k.absoluteBounds(),this.facade.eventCoordinates(b.browserEvent||b),this.isSublaneAllowed(k));if(!f){return;}var h=this.getPool(k);var c=this.namespace+(this.orientation==="horizontal"?"Lane":"VerticalLane");var g=(f==="sub"?k:k.parent);var d={id:c,namespace:this.namespace,horizontal:(this.orientation==="horizontal"),target:g,targetId:g.resourceId,targetBounds:g.absoluteBounds().clone(),currentShape:k,pool:h,poolBounds:h.bounds.clone(),position:f,properties:{"oryx-bgcolor":k.properties["oryx-bgcolor"],"oryx-bordercolor":k.properties["oryx-bordercolor"]}};this.facade.executeCommands([new a(l,this.facade,d,b)]);}}},hideOverlays:function(){$H(this.overlayIds||{}).values().each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));},getDockingSide:function(a,h,f,m){if(!(a instanceof ORYX.Core.Bounds)){return;}var g=a.upperLeft();var e=a.lowerRight();var l=this.defaultOverlaySize;var c=a.width();var k=a.height();var b=(this.orientation==="horizontal");if(!m&&(b&&(h.y<g.y||h.y>e.y)||!b&&(h.x<g.x||h.x>e.x))){var d=a.clone();if(b){d.moveBy({x:0,y:-30});d.extend({x:0,y:60});}else{d.moveBy({x:-30,y:0});d.extend({x:60,y:0});}return this.getDockingSide(d,h,f,true);}if(a.isIncluded(h)){if(f){if(b&&h.y<g.y+k/3||!b&&h.x<g.x+c/3){return"pre";}if(b&&h.y<e.y-k/3||!b&&h.x<e.x-c/3){return"sub";}else{return"post";}}else{if(b&&h.y<g.y+k/2||!b&&h.x<g.x+c/2){return"pre";}else{return"post";}}}},getPool:function(a){if(a instanceof ORYX.Core.Node){return["Pool","VerticalPool"].include(a.getStencil().idWithoutNs())&&a||this.getPool(a.parent);}},_createOverlays:function(){var a=this.namespace+(this.orientation==="horizontal"?"Pool":"VerticalPool");this.genericPoolBounds=new ORYX.Core.Node({},this.facade.getStencilSets()[this.namespace].stencil(a)).bounds.clone();this.overlayIds={pre:"poollanecreation.preoverlay",post:"poollanecreation.postoverlay",sub:"poollanecreation.suboverlay"};this.overlayPositions={pre:(this.orientation==="horizontal"?"NW":"NW"),post:(this.orientation==="horizontal"?"SW":"NE"),sub:(this.orientation==="horizontal"?"W":"N")};this.overlays={};$H(this.overlayIds||{}).values().each(function(b){this.overlays[b]=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["rect",{fill:"#8dce6b",opacity:"0.4",stroke:"black","stroke-width":1,"stroke-dasharray":"2,2","pointer-events":"none","class":"y-docking-overlay"}]);}.bind(this));},getOverlayAdjustment:function(b){if(!this.genericPoolBounds){return;}var c=(this.orientation==="horizontal");var d=(c?this.genericPoolBounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);var a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:this.genericPoolBounds.height());switch(b){case"pre":return;case"post":return(c?{y:-ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS}:{x:-ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS});case"sub":return(c?{y:-ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS/2}:{x:-ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS});}},setOverlayBounds:function(d,f,b){if(!this.genericPoolBounds){return;}var c=(this.orientation==="horizontal");var e=(c?this.genericPoolBounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);var a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:this.genericPoolBounds.height());switch(b){case"pre":e=(c?f.bounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:f.bounds.height());break;case"post":e=(c?f.bounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:f.bounds.height());break;case"sub":e=(c?f.bounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:f.bounds.height());break;}d.setAttributeNS(null,"width",e);d.setAttributeNS(null,"height",a);},isLane:function(a){return a instanceof ORYX.Core.Node&&["VerticalLane","Lane"].include(a.getStencil().idWithoutNs());},isPool:function(a){return a instanceof ORYX.Core.Node&&["VerticalPool","Pool"].include(a.getStencil().idWithoutNs());},isCanvas:function(a){return a===this.facade.getCanvas();}});}();if("undefined"===typeof ORYX){var ORYX={};}if("undefined"===typeof ORYX.Plugins){ORYX.Plugins={};}new function(){ORYX.Plugins.BPMN2_0LaneDrag=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BPMN20_DIAGRAM_ORIENTATION_CHANGED,this._updateOverlays.bind(this));var b=this;this.namespace=this.facade.getStencilSets().keys()[0];this.facade.offer({target:ORYX.Plugins.DragDropResize,beforeDragClb:function(d,c,f){b.beforeDrag(this,d,c,f);},dragOverClb:function(f,d,c){b.dragOver(this,f,d,c);},dragDropClb:function(d,c,e){return b.dragDrop(this,d,c,e);},afterDragDropClb:function(d,c,f){b.afterDragDrop(this,d,c,f);}});this._updateOverlays();},_updateOverlays:function(){this.orientation=this.facade.getCanvas().getOrientation();this._createOverlays();},beforeDrag:function(a,c,b,d){if(a.toMoveShapes.length===1&&this.isLane(a.toMoveShapes[0])){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEOVER);}},dragOver:function(a,d,c,b){if(!a){return;}if(a.toMoveShapes.length===1&&this.isLane(a.toMoveShapes[0])){b.preventHighlights=true;(a.vLines||[]).concat(a.hLines||[]).invoke("hide");var f=this.facade.getCanvas().getAbstractShapesAtPosition(this.facade.eventCoordinates(c)).reverse().find(function(e){return this.isLane(e)||this.isPool(e)||this.isCanvas(e);}.bind(this));if(!f||f===a.toMoveShapes[0]){this.hideOverlays();return;}if(this.isLane(f)){this.handleMouseOverLane(f,a,c);return;}a.setNotAllowed();this.hideOverlays();}},dragDrop:function(b,c,a,d){if(b.toMoveShapes.length!==1||!this.isLane(b.toMoveShapes[0])){return;}b.containmentParentNode=this.facade.getCanvas().getAbstractShapesAtPosition(this.facade.eventCoordinates(d)).reverse().find(function(e){return this.isLane(e)||this.isPool(e)||this.isCanvas(e);}.bind(this));if(!b.containmentParentNode){return;}if(!b.isAddingAllowed||b.containmentParentNode instanceof ORYX.Core.Canvas){if(this.isCanvas(b.containmentParentNode)){b.isAddingAllowed=false;b.setNotAllowed();return;}}if(!(b.containmentParentNode.parent instanceof ORYX.Core.Canvas)){b.containmentParentNode=b.containmentParentNode.parent;}return;},afterDragDrop:function(a,c,b,d){if(a.toMoveShapes.length===1&&this.isLane(a.toMoveShapes[0])){this.hideOverlays();(a.vLines||[]).concat(a.hLines||[]).invoke("hide");this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEOVER);}},getNearbyPool:function(b){var c=this.facade.eventCoordinates(b);var a=this.facade.getCanvas().getChildShapes().findAll(function(d){return this.isPool(d);}.bind(this)).findAll(function(d){return d.bounds.isIncluded(c,30);});if(a.length!==1){return;}return a[0];},getDropTarget:function(a){return(a||[]).find(function(b){return this.isCanvas(b)||this.isLane(b)||this.isPool(b);}.bind(this));},handleMouseOverLane:function(e,b,d){var c=this.facade.eventCoordinates(d);var a=this.getDockingSide(e.absoluteBounds(),c,false);if(!a){this.hideOverlays();b.setNotAllowed();return;}this.showOverlay(e,a);b.setAllowed();},showOverlay:function(c,a){if(!this.overlays){return;}var d=this.overlayIds[a];if(!d||!this.overlays[d]){return;}var b=this.overlays[d];this.setOverlayBounds(b,c,a);this.hideOverlays();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:d,node:b,shapes:[c],nodePosition:this.overlayPositions[a],adjustment:this.getOverlayAdjustment(a)});},isSublaneAllowed:function(a){if(this.isOverCompartment(a)){return false;}if(!(a.parent instanceof ORYX.Core.Canvas)&&this.isLane(a)){return a.parent.children.findAll(function(b){if(b instanceof ORYX.Core.Node){return this.isLane(b);}}.bind(this)).length>1;}},isOverCompartment:function(a){return this.isLane(a)&&a.children.any(function(b){return this.isLane(b);}.bind(this));},showSublaneOverlay:function(d){var e=this.overlays[this.overlayIds.sublane];var b=(this.orientation==="horizontal");if(e){var c=(b?d.bounds.width()/3:d.bounds.width()-(2*this.defaultOverlaySize));var a=(b?d.bounds.height()-(2*this.defaultOverlaySize):d.bounds.height()/3);e.setAttributeNS(null,"width",c);e.setAttributeNS(null,"height",a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:this.overlayIds.sub});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:this.overlayIds.sub,shapes:[d],node:e,nodePosition:"NE"});}},updateOverlayBounds:function(a){this.overlay.setAttributeNS(null,"width",(this.orientation==="horizontal"?mouseTarget.bounds.width():this.defaultOverlaySize));this.overlay.setAttributeNS(null,"height",(this.orientation==="horizontal"?this.defaultOverlaySize:mouseTarget.bounds.height()));},hideOverlays:function(){$H(this.overlayIds||{}).values().each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));},getDockingSide:function(a,h,f,m){if(!(a instanceof ORYX.Core.Bounds)){return;}var g=a.upperLeft();var e=a.lowerRight();var l=this.defaultOverlaySize;var c=a.width();var k=a.height();var b=(this.orientation==="horizontal");if(!m&&(b&&(h.y<g.y||h.y>e.y)||!b&&(h.x<g.x||h.x>e.x))){var d=a.clone();if(b){d.moveBy({x:0,y:-this.defaultOverlaySize});d.extend({x:0,y:this.defaultOverlaySize*2});}else{d.moveBy({x:-this.defaultOverlaySize,y:0});d.extend({x:this.defaultOverlaySize*2,y:0});}return this.getDockingSide(d,h,f,true);}if(a.isIncluded(h)){if(f){if(b&&h.y<g.y+k/3||!b&&h.x<g.x+c/3){return"pre";}if(b&&h.y<e.y-k/3||!b&&h.x<e.x-c/3){return"sub";}else{return"post";}}else{if(b&&h.y<g.y+k/2||!b&&h.x<g.x+c/2){return"pre";}else{return"post";}}}},getPool:function(a){if(!a||!a.parent){return;}if(a.getStencil().id().endsWith("Pool")){return a;}else{return this.getPool(a.parent);}},getLanes:function(a,c){if(this.orientation==="horizontal"){var f="y";var e="height";var d="Lane";}else{if(this.orientation==="vertical"){var f="x";var e="width";var d="VerticalLane";}}var b=a.getChildNodes(c||false).findAll(function(g){return(g.getStencil().id()===this.namespace+d);}.bind(this));b=b.sort(function(y,v){var x=Math.round(y.bounds.upperLeft()[f]);var q=Math.round(v.bounds.upperLeft()[f]);var t=Math.round(y.bounds.lowerRight()[f]);var n=Math.round(v.bounds.lowerRight()[f]);var k=y.absoluteBounds();var h=v.absoluteBounds();var p=Math.round(k.upperLeft()[f]);var A=Math.round(h.upperLeft()[f]);var m=Math.round(k.lowerRight()[f]);var z=Math.round(h.lowerRight()[f]);if(x==q&&t==n){x=p;q=A;t=m;n=z;}if(Math.round(y.bounds[e]()-k[e]())===0&&Math.round(v.bounds[e]()-h[e]())===0){return x<q?-1:(x>q?1:0);}var u=x<q&&t<n;var r=x>q&&t>n;var l=x<q&&t>=n&&m<z;var o=x>=q&&t<n&&p<A;var s=x>q&&t<=n&&m>z;var g=x<=q&&t>n&&p>A;return(u||l||o?-1:(r||s||g?1:0));}.bind(this));return b;},_createOverlays:function(){this.defaultOverlaySize=20;var b=this.facade.getStencilSets()[this.namespace];var a=b.stencil(this.namespace+(this.orientation==="horizontal"?"Pool":"VerticalPool"));if(a){this.genericPoolBounds=new ORYX.Core.Node({},a).bounds.clone();}this.overlayIds={pre:"lanedrag.preoverlay",post:"lanedrag.postoverlay",sub:"lanedrag.suboverlay"};this.overlayPositions={pre:(this.orientation==="horizontal"?"NW":"NW"),post:(this.orientation==="horizontal"?"SW":"NE"),sub:(this.orientation==="horizontal"?"W":"N")};this.overlays={};$H(this.overlayIds||{}).values().each(function(c){this.overlays[c]=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["rect",{fill:"#8dce6b",opacity:"0.4",stroke:"black","stroke-width":1,"stroke-dasharray":"2,2","pointer-events":"none","class":"y-docking-overlay"}]);}.bind(this));},getOverlayAdjustment:function(b){if(!this.genericPoolBounds){return;}var c=(this.orientation==="horizontal");var d=(c?this.genericPoolBounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);var a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:this.genericPoolBounds.height());switch(b){case"pre":return;case"post":return(c?{y:-ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS}:{x:-ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS});case"sub":return(c?{y:-ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS/2}:{x:-ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS});}},setOverlayBounds:function(d,f,b){if(!this.genericPoolBounds){return;}var c=(this.orientation==="horizontal");var e=(c?this.genericPoolBounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);var a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:this.genericPoolBounds.height());switch(b){case"pre":e=(c?f.bounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:f.bounds.height());break;case"post":e=(c?f.bounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:f.bounds.height());break;case"sub":e=(c?f.bounds.width():ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS);a=(c?ORYX.CONFIG.BPMN20_DEFAULT_OVERLAY_THICKNESS:f.bounds.height());break;}d.setAttributeNS(null,"width",e);d.setAttributeNS(null,"height",a);},isLane:function(a){return a instanceof ORYX.Core.Node&&["VerticalLane","Lane"].include(a.getStencil().idWithoutNs());},isPool:function(a){return a instanceof ORYX.Core.Node&&["VerticalPool","Pool"].include(a.getStencil().idWithoutNs());},isCanvas:function(a){return a===this.facade.getCanvas();}});}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}new function(){ORYX.Plugins.BPMN2_0ModelingDirection={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.init.bind(this));this.orientation=this.facade.getCanvas().getOrientation();this.oFactor=0.7;this.commands=[];var b=this;this.facade.offer({target:ORYX.Plugins.PropertyWindow,category:"popular",name:Signavio.I18N.BPMN20pools.modelingDirectionSwitch,value:function(){var c=b.facade.getCanvas().getOrientation();return Signavio.I18N.BPMN20pools[c]||c;},icons:[],generateEditor:b.prepareEditor.bind(b),enabled:function(){return(b.facade.getSelection().length==0&&b.facade.getCanvas().getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#BPMNDiagram");}});},checkVisibleStencils:function(){if(this.orientation==="horizontal"){this.enableHorizontalSwimlanes();}else{if(this.orientation==="vertical"){this.enableVerticalSwimlanes();}}if(!this.facade.isExecutingCommands()){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});}},enableHorizontalSwimlanes:function(){var a;a=this.facade.getStencilSets()["http://b3mn.org/stencilset/bpmn2.0#"];if(!a){return;}if(!ORYX.CONFIG.BPMN20_SHAPEREPOSITORY_HIDE_POOLS_LANES){this._setStencilProperty(a,"Pool","hide",false);this._setStencilProperty(a,"Lane","hide",false);this._setStencilProperty(a,"VerticalPool","hide",true);this._setStencilProperty(a,"VerticalLane","hide",true);}this._setStencilProperty(a,"CollapsedPool","hide",false);this._setStencilProperty(a,"CollapsedVerticalPool","hide",true);},enableVerticalSwimlanes:function(){var a;a=this.facade.getStencilSets()["http://b3mn.org/stencilset/bpmn2.0#"];if(!a){return;}if(!ORYX.CONFIG.BPMN20_SHAPEREPOSITORY_HIDE_POOLS_LANES){this._setStencilProperty(a,"Pool","hide",true);this._setStencilProperty(a,"Lane","hide",true);this._setStencilProperty(a,"VerticalPool","hide",false);this._setStencilProperty(a,"VerticalLane","hide",false);}this._setStencilProperty(a,"CollapsedPool","hide",true);this._setStencilProperty(a,"CollapsedVerticalPool","hide",false);},_setStencilProperty:function(d,a,e,c){var b=d.stencil(d.namespace()+a);if(!b){return;}b._jsonStencil[e]=c;},prepareEditor:function(){var a=new Ext.data.SimpleStore({fields:[{name:"icon"},{name:"title"},{name:"value"}],data:[["/stencilsets/bpmn2.0/icons/swimlane/lane.png",Signavio.I18N.BPMN20pools["horizontal"],"horizontal"],["/stencilsets/bpmn2.0/icons/swimlane/vertical.lane.png",Signavio.I18N.BPMN20pools["vertical"],"vertical"]]});var c=this;var b=new Ext.ux.form.ComboBox({tpl:'<tpl for="."><div class="x-combo-list-item">{[(values.icon) ? "<img src=\'" + values.icon + "\' style=\'float: left; margin-right: 2px;\'/>" : ""]} {[values.title.escapeHTML()]}</div></tpl>',store:a,displayField:"title",valueField:"value",typeAhead:true,triggerAction:"all",mode:"local",selectOnFocus:false,forceSelection:true,editable:false,readOnly:false,listeners:{select:function(d,e){c.toggleDirection(e.data.value,d);}}});return new Ext.Editor(b);},init:function(){this.checkVisibleStencils();},toggleDirection:function(b,a){if(!b||(b!=="vertical"&&b!=="horizontal")||b===this.facade.getCanvas().getOrientation()){return;}var c=this;Ext.Msg.show({title:Signavio.I18N.BPMN20pools.warningBoxTitle,msg:Signavio.I18N.BPMN20pools.warningBoxMsg,buttons:Ext.Msg.YESNO,fn:function(d){if(d==="yes"){c.orientation=b;c.translateModel();}else{c.facade.updateSelection();}},icon:Ext.MessageBox.QUESTION});},setCanvasOrientation:function(a){var b=ORYX.Core.Command.extend({construct:function(c,d,e){this.facade=d;this.oldOrientation=this.facade.getCanvas().getOrientation();this.orientation=c;this.plugin=e;},execute:function(){this.facade.getCanvas().setOrientation(this.orientation);this.plugin.orientation=this.orientation;this.plugin.checkVisibleStencils();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_BPMN20_DIAGRAM_ORIENTATION_CHANGED});},rollback:function(){this.facade.getCanvas().setOrientation(this.oldOrientation);this.plugin.orientation=this.oldOrientation;this.plugin.checkVisibleStencils();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_BPMN20_DIAGRAM_ORIENTATION_CHANGED});}});this.commands.push(new b(a,this.facade,this));},resizeCanvas:function(){var a=ORYX.Core.Command.extend({construct:function(b,c,d){this.facade=c;this.oldBounds=c.getCanvas().bounds.clone();this.zoomFactor=c.getCanvas().getZoom();this.factor=d.oFactor||1;},execute:function(){var b=this.oldBounds.width()*this.factor*this.zoomFactor;var c=this.oldBounds.height()*(1/this.factor)*this.zoomFactor;this.facade.getCanvas().setSize({width:c,height:b});},rollback:function(){var b=this.oldBounds.width()*this.zoomFactor;var c=this.oldBounds.height()*this.zoomFactor;this.facade.getCanvas().setSize({width:b,height:c});}});this.commands.push(new a(this.orientation,this.facade,this));},translateModel:function(){this.commands=[];if(this.orientation==="vertical"){this.setCanvasOrientation(this.orientation);this.resizeCanvas();this.checkVisibleStencils();this.performTranslation();}else{if(this.orientation==="horizontal"){this.setCanvasOrientation(this.orientation);this.resizeCanvas();this.performTranslation();this.checkVisibleStencils();}}},performTranslation:function(){this.facade.getCanvas().getChildNodes().each(function(a){this.translateBounds(a);this.switchLaneOrientation(a);}.bind(this));this.facade.getCanvas().getChildEdges().each(function(a){this.translateBounds(a);}.bind(this));if(this.commands&&this.commands.length>0){this.facade.executeCommands(this.commands);}delete this.commands;},translateBounds:function(a){var b=ORYX.Core.Command.extend({construct:function(d,g,c,e,f){this.oldBounds=g.clone();this.bounds=g;this.stencilId=c;this.oldDockedBounds={};this.shape=d;this.newBounds=undefined;this.factor=f.oFactor||1;this.orientation=f.orientation;},execute:function(){var k=this.oldBounds.center();var e=this.oldBounds.upperLeft();var d=this.oldBounds.lowerRight();var c=this.oldBounds.width();var f=this.oldBounds.height();if((this.stencilId.endsWith("Pool")||this.stencilId.endsWith("Lane")||this.stencilId==="Subprocess"||this.stencilId==="EventSubprocess"||this.stencilId==="Group")){c*=this.factor;f*=(1/this.factor);if(this.stencilId.endsWith("Subprocess")){var g=this.getLaneDepth(this.shape);k.x+=(this.orientation==="vertical"?g*30:0);k.y+=(this.orientation==="horizontal"?g*30:0);k.x*=this.factor;k.y*=(1/this.factor);k.x-=(this.orientation==="vertical"?g*30:0);k.y-=(this.orientation==="horizontal"?g*30:0);}else{k.x*=this.factor;k.y*=(1/this.factor);}this.bounds.set(k.y-f/2,k.x-c/2,k.y+f/2,k.x+c/2);}else{if(this.shape instanceof ORYX.Core.Edge){this.convertEdgeDocker(this.shape);this.shape.getDockers().each(function(h){if(!h.getDockedShape()){var l=h.bounds.center();l.x*=this.factor;l.y*=(1/this.factor);h.bounds.centerMoveTo(l.y,l.x);}}.bind(this));}else{if((this.shape.getDockers()||[]).length==1&&this.shape.getDockers().first().getDockedShape()){this.convertDocker(this.factor,this.shape.getDockers().first().getDockedShape(),this.shape.getDockers().first());}else{var g=this.getLaneDepth(this.shape);k.x+=(this.orientation==="vertical"?g*30:0);k.y+=(this.orientation==="horizontal"?g*30:0);k.x*=this.factor;k.y*=(1/this.factor);k.x-=(this.orientation==="vertical"?g*30:0);k.y-=(this.orientation==="horizontal"?g*30:0);this.bounds.centerMoveTo(k.y,k.x);}}}},rollback:function(){if(this.shape instanceof ORYX.Core.Node){if((this.shape.getDockers()||[]).length==1&&this.shape.getDockers().first().getDockedShape()){this.convertDocker(this.factor,this.shape.getDockers().first().getDockedShape(),this.shape.getDockers().first(),true);}else{if(this.shape.getStencil().idWithoutNs().endsWith("Pool")){(a.getOutgoingShapes()||[]).invoke("getDockers").invoke("first").each(function(c){c._dockedShapeBounds=this.oldBounds.clone();}.bind(this));(a.getIncomingShapes()||[]).invoke("getDockers").invoke("last").each(function(c){c._dockedShapeBounds=this.oldBounds.clone();}.bind(this));}this.bounds.set(this.oldBounds.upperLeft(),this.oldBounds.lowerRight());}}else{if(this.shape instanceof ORYX.Core.Edge){this.convertEdgeDocker(this.shape,true);this.shape.getDockers().each(function(c){if(!c.getDockedShape()){var d=c.bounds.center();d.x*=this.factor;d.y*=(1/this.factor);c.bounds.centerMoveTo(d.y,d.x);}}.bind(this));}}},getLaneDepth:function(c,e){var d=c.parent;if(!d||!d.getStencil().id().endsWith("Lane")){return e||0;}return this.getLaneDepth(d,((e+1)||1));},_isScaledContainer:function(c){return c.getStencil().id().endsWith("Pool")||c.getStencil().id().endsWith("Lane")||c.getStencil().idWithoutNs()==="Subprocess"||c.getStencil().idWithoutNs()==="EventSubprocess"||c.getStencil().idWithoutNs()==="Group";},convertEdgeDocker:function(c,e){var d=this.factor;c.getDockers().each(function(g){var f=g.getDockedShape();if(f instanceof ORYX.Core.Node){this.convertDocker(d,f,g,e);}}.bind(this));},convertDocker:function(k,c,d,g){var n=this._isScaledContainer(c);var o=c.bounds.width();var e=c.bounds.height();var q=d.referencePoint.x;var p=d.referencePoint.y;var m=(n?o*p/(o*k):o*(p/e));var l=(n?e*q/(e*(1/k)):e*(q/o));if(g){d._dockedShapeBounds=this.oldDockedBounds[d.getId()]||d._dockedShapeBounds;d.referencePoint={x:m,y:l};}else{d.setReferencePoint({x:m,y:l});this.oldDockedBounds[d.getId()]=d._dockedShapeBounds;d._dockedShapeBounds=c.bounds.clone();}}});this.commands.push(new b(a,a.bounds,a.getStencil().idWithoutNs(),this.facade,this));a.getChildShapes().each(function(c){this.translateBounds(c);}.bind(this));},switchLaneOrientation:function(a){if(!a){return;}if(this.orientation==="horizontal"){if(a.getStencil().id().endsWith("http://b3mn.org/stencilset/bpmn2.0#VerticalPool")){this.performLaneMorphing(a,"Pool");}else{if(a.getStencil().id().endsWith("http://b3mn.org/stencilset/bpmn2.0#VerticalLane")){this.performLaneMorphing(a,"Lane");}else{if(a.getStencil().id().endsWith("http://b3mn.org/stencilset/bpmn2.0#CollapsedVerticalPool")){this.performLaneMorphing(a,"CollapsedPool");}}}}else{if(this.orientation==="vertical"){if(a.getStencil().id().endsWith("http://b3mn.org/stencilset/bpmn2.0#Pool")){this.performLaneMorphing(a,"VerticalPool");}else{if(a.getStencil().id().endsWith("http://b3mn.org/stencilset/bpmn2.0#Lane")){this.performLaneMorphing(a,"VerticalLane");}else{if(a.getStencil().id().endsWith("http://b3mn.org/stencilset/bpmn2.0#CollapsedPool")){this.performLaneMorphing(a,"CollapsedVerticalPool");}}}}}},performLaneMorphing:function(a,b){var c=this.morphShape(a,b);this.commands.push(c);},morphShape:function(b,a){var d=ORYX.Core.Command.extend({construct:function(l,g,f,e,h){this.poolShape=l;this.newPoolShape=undefined;this.objectsToSerialize=undefined;this.stencilId=g;this.facade=h;this.newShapes={};this.shapes={};this.childsOf={};this.orientation=f;this.checkVisibleStencilsCB=e;var k=this.facade.getStencilSets();if(k){this.vLStencil=k["http://b3mn.org/stencilset/bpmn2.0#"].stencil("http://b3mn.org/stencilset/bpmn2.0#VerticalLane");this.hLStencil=k["http://b3mn.org/stencilset/bpmn2.0#"].stencil("http://b3mn.org/stencilset/bpmn2.0#Lane");}},execute:function(){var e=this.poolShape;if(!e.parent){return;}this.facade.setSelection([]);this.checkVisibleStencilsCB();var g=this.facade.getStencilSets();if(!g){return;}var f=g["http://b3mn.org/stencilset/bpmn2.0#"].stencil("http://b3mn.org/stencilset/bpmn2.0#"+this.stencilId);this.newPoolShape=this.performMorphing(e,f);this.deserializeAttributes();},rollback:function(){var e=$H(this.newShapes);if(!this.poolShape||!(this.newShapes&&e.values().length>0)||!this.newPoolShape.parent){return;}this.facade.setSelection([]);this.checkVisibleStencilsCB();this.newPoolShape.parent.add(this.poolShape);e.values().each(function(f){f.getChildNodes().each(function(g){this.shapes[f.resourceId].add(g);}.bind(this));}.bind(this));this.setRelatedDockers(this.newPoolShape,this.poolShape);e.values().each(function(f){this.facade.deleteShape(f);}.bind(this));},addToSerializeList:function(e){if(!e.shape||!e.serialized){return;}if(!(this.objectsToSerialize instanceof Array)){this.objectsToSerialize=[];}this.objectsToSerialize.push(e);},deserializeAttributes:function(){if(this.objectsToSerialize instanceof Array){this.objectsToSerialize.each(function(f){var e=this.recordReferencePoints(f.shape);f.shape.deserialize(f.serialized);this.restoreReferencePoints(e);}.bind(this));}},recordReferencePoints:function(g){var f=g.getIncomingShapes().invoke("getDockers").invoke("last");var h=g.getOutgoingShapes().invoke("getDockers").invoke("first");var e=[];[].concat(f,h).each(function(k){e.push({docker:k,refPoint:k.referencePoint});});return e;},restoreReferencePoints:function(e){e.each(function(f){f.docker.referencePoint=f.refPoint;});},performMorphing:function(l,p,n){if(!l.parent&&!n){return;}this.shapes[l.resourceId]=l;var n=n||l.parent;var k=l.resourceId;var f=l.serialize();p.properties().each((function(r){if(r.readonly()){f=f.reject(function(s){return s.name==r.id();});}}).bind(this));if(this.newShapes[k]){var q=this.newShapes[k];this.facade.getCanvas().add(q);}else{var q=this.facade.createShape({type:p.id(),namespace:p.namespace(),resourceId:k,dontUpdateSelection:true});q.setResourceId(k);}var h=f.find(function(r){return(r.prefix==="oryx"&&r.name==="bounds");});var m=null;var o=l.bounds.height();var e=l.bounds.width();if(q.minimumSize){if(l.bounds.height()<q.minimumSize.height){o=q.minimumSize.height;}if(l.bounds.width()<q.minimumSize.width){e=q.minimumSize.width;}}if(q.maximumSize){if(l.bounds.height()>q.maximumSize.height){o=q.maximumSize.height;}if(l.bounds.width()>q.maximumSize.width){e=q.maximumSize.width;}}m={a:{x:l.bounds.a.x,y:l.bounds.a.y},b:{x:l.bounds.a.x+e,y:l.bounds.a.y+o}};var g=l.getChildNodes();this.setRelatedDockers(l,q);if(l.getStencil().id().endsWith("Pool")){this.facade.deleteShape(l);}this.addToSerializeList({shape:q,serialized:f});if(m!==null){q.bounds.set(m);}this.resetAllChildShapes(g,q);q.isChanged=true;this.newShapes[k]=q;g.each(function(r){if(this.orientation==="vertical"&&r.getStencil().id().endsWith("http://b3mn.org/stencilset/bpmn2.0#Lane")){this.performMorphing(r,this.vLStencil,q);}else{if(this.orientation==="horizontal"&&r.getStencil().id().endsWith("http://b3mn.org/stencilset/bpmn2.0#VerticalLane")){this.performMorphing(r,this.hLStencil,q);}}}.bind(this));if(n instanceof ORYX.Core.Shape){n.add(q);}return q;},resetAllChildShapes:function(g,f){var e=this.getValidChildren(g,f);e.each(function(h){f.add(h);});},getValidChildren:function(f,e){return f.findAll(function(g){return(!g.getStencil().id().endsWith("Pool")&&!g.getStencil().id().endsWith("Lane"));}.bind(this));},setRelatedDockers:function(e,f){if(e.getStencil().type()==="node"){(e.incoming||[]).concat(e.outgoing||[]).each(function(g){g.dockers.each(function(k){if(k.getDockedShape()==e){var h=Object.clone(k.referencePoint);k.setDockedShape(f);k.referencePoint=h;}});});}}});var c=new d(b,a,this.orientation,this.checkVisibleStencils.bind(this),this.facade);return c;}};ORYX.Plugins.BPMN2_0ModelingDirection=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2_0ModelingDirection);}();new function(){ORYX.Plugins.DefaultOrientationVertical={construct:function(b){var a=b.getModelMetaData()["new"];if(a&&!!b.getCanvas().getOrientation()){b.getCanvas().setOrientation("vertical");}}};ORYX.Plugins.DefaultOrientationVertical=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.DefaultOrientationVertical);}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.BPMN2CONVERSATION={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE,this.handleDragDrop.bind(this));},checkForMultiInstance:function(b){var c=b.getIncomingShapes();var d=b.getOutgoingShapes();var a=b.properties["oryx-multiinstance"];if(c){c.find(function(e){if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink"){if(a){e.setProperty("oryx-showforkend",true);}else{e.setProperty("oryx-showforkend",false);}}});}if(d){d.find(function(e){if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink"){if(a){e.setProperty("oryx-showforkstart",true);}else{e.setProperty("oryx-showforkstart",false);}}});}},handleDockerDocked:function(b){var c=b.parent;var a=b.target;if(c.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink"){if(a.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(a);this.facade.getCanvas().update();}}},handlePropertyChanged:function(b){var a=b.elements;var c=false;a.each(function(d){if(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(d);c=true;}}.bind(this));if(c){this.facade.getCanvas().update();}},handleDragDrop:function(b){var c=b.source;var a=b.destination;var d=false;c.each(function(e){if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(e);d=true;}}.bind(this));a.each(function(e){if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Communication"){var f=e.getOutgoingShapes();if(f){f.each(function(g){var h=g.getTarget();if(h){if(h.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(h);d=true;}}}.bind(this));}}if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(e);d=true;}}.bind(this));if(d){this.facade.getCanvas().update();}}};ORYX.Plugins.BPMN2CONVERSATION=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2CONVERSATION);if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Bpmn2_0Choreography={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,this.handleStencilSetLoaded.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){if(!this._eventsRegistered){this.handleStencilSetLoaded({});this.afterLoad();}}.bind(this));this.participantSize=20;this.extensionSizeForMarker=10;this.choreographyTasksMeta=new Hash();this._isLayoutEnabled=false;},handleStencilSetLoaded:function(a){if(a.lazyLoaded){this._isLayoutEnabled=true;}this.registerPluginOnEvents();},registerPluginOnEvents:function(){this._eventsRegistered=true;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.addParticipantsOnCreation.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.choreography.task",this.handleLayoutChoreographyTask.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.choreography.subprocess.expanded",this.handleLayoutChoreographySubprocessExpanded.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.choreography.subprocess.collapsed",this.handleLayoutChoreographySubprocessCollapsed.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this));},unregisterPluginOnEvents:function(){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this));},afterLoad:function(a){this._isLayoutEnabled=true;this.facade.getCanvas().getChildNodes(true).each(function(d){if(!(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyTask"||d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessCollapsed"||d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessExpanded")){return;}var h=new Array();var g=new Array();var k=this.addOrGetChoreographyTaskMeta(d);var f=d.getChildNodes(false).findAll(function(l){return l.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant";});f=f.sort(function(m,l){var n=Math.round(m.absoluteBounds().upperLeft().y);var o=Math.round(l.absoluteBounds().upperLeft().y);return n<o?-1:(n>o?1:0);});var c=0;var e=0;var b=0;f.each(function(m){m.isResizable=false;var l=(m.properties["oryx-multiple_instance"]===""?false:m.properties["oryx-multiple_instance"]);if(m.bounds.upperLeft().y==c){h.push(m);c=m.bounds.lowerRight().y;if(l){e++;}}else{g.push(m);if(l){b++;}}});k.numOfParticipantsOnTop=h.length;k.numOfParticipantsOnBottom=g.length;k.numOfParticipantsExtendedOnBottom=b;k.numOfParticipantsExtendedOnTop=e;k.bottomYStartValue=(g.first()?g.first().bounds.upperLeft().y:d.bounds.height());k.topYEndValue=(h.last()?h.last().bounds.lowerRight().y:0);k.center=k.topYEndValue+(k.bottomYStartValue-k.topYEndValue)/2;k.oldHeight=d.bounds.height();k.oldBounds=d.bounds.clone();k.topParticipants=h;k.bottomParticipants=g;d.isChanged=true;d.initialParticipantsAdded=true;}.bind(this));this.facade.getCanvas().update();},handleLayoutChoreographySubprocessExpanded:function(b){if(!this._isLayoutEnabled){return;}var e=b.shape;var f=this.addOrGetChoreographyTaskMeta(e);var d=e.bounds.height()/e._oldBounds.height();var a=e._labels[e.getId()+"text_name"];if(a){var c=f.topYEndValue+5;if(e.isResized&&d){a.y=c/d;}else{a.y=c;}}},handleLayoutChoreographySubprocessCollapsed:function(b){if(!this._isLayoutEnabled){return;}var d=b.shape;var e=this.addOrGetChoreographyTaskMeta(d);var a=d._svgShapes.find(function(f){return f.element.id==d.getId()+"plus_marker";});var c=d._svgShapes.find(function(f){return f.element.id==d.getId()+"plus_marker_border";});if(a&&c){a._isYLocked=true;a.y=e.bottomYStartValue-12;c._isYLocked=true;c.y=e.bottomYStartValue-14;}},addParticipantsOnCreation:function(a){if(!this._isLayoutEnabled){return;}var b=a.elements.findAll(function(c){return c._stencil&&!c.initialParticipantsAdded&&(c.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyTask"||c.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessCollapsed"||c.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessExpanded");});if(b.length===0){return;}this._isLayoutEnabled=false;b.each(function(d){d.initialParticipantsAdded=true;if(this.hasParticipants(d)){return;}var f={type:"http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant",position:{x:0,y:0},namespace:d.getStencil().namespace(),parent:d};var e=this.facade.createShape(f);e.setProperty("oryx-initiating",true);var g={elements:[e],key:"oryx-initiating",value:true};this.handlePropertyChanged(g);var c={type:"http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant",position:{x:0,y:d.bounds.lowerRight().y},namespace:d.getStencil().namespace(),parent:d};this.facade.createShape(c);}.bind(this));this._isLayoutEnabled=true;this.facade.getCanvas().update();this.facade.setSelection(b);},hasParticipants:function(a){return a.getChildNodes().any(function(b){return(b.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant");});},addOrGetChoreographyTaskMeta:function(a){if(!this.choreographyTasksMeta[a.getId()]){this.choreographyTasksMeta[a.getId()]=new Object();this.choreographyTasksMeta[a.getId()].numOfParticipantsOnTop=0;this.choreographyTasksMeta[a.getId()].numOfParticipantsOnBottom=0;this.choreographyTasksMeta[a.getId()].numOfParticipantsExtendedOnBottom=0;this.choreographyTasksMeta[a.getId()].numOfParticipantsExtendedOnTop=0;this.choreographyTasksMeta[a.getId()].bottomYStartValue=a.bounds.height();this.choreographyTasksMeta[a.getId()].topYEndValue=0;this.choreographyTasksMeta[a.getId()].center=a.bounds.height()/2;this.choreographyTasksMeta[a.getId()].oldHeight=a.bounds.height();this.choreographyTasksMeta[a.getId()].oldBounds=a.bounds.clone();this.choreographyTasksMeta[a.getId()].topParticipants=new Array();this.choreographyTasksMeta[a.getId()].bottomParticipants=new Array();}return this.choreographyTasksMeta[a.getId()];},handleResizingOfChoreographyTask:function(g,h){if(g.bounds.height()==h.oldHeight){return;}var c=h.numOfParticipantsOnTop*this.participantSize+h.numOfParticipantsExtendedOnTop*this.extensionSizeForMarker+h.numOfParticipantsOnBottom*this.participantSize+h.numOfParticipantsExtendedOnBottom*this.extensionSizeForMarker+40;if(c>g.bounds.height()){var e=g.bounds.upperLeft();var d=h.oldBounds.upperLeft();var b=g.bounds.lowerRight();var a=h.oldBounds.lowerRight();if(e.y!=d.y){g.bounds.set(e.x,b.y-c,b.x,b.y);}else{if(b.y!=a.y){g.bounds.set(e.x,e.y,b.x,e.y+c);}}}var f=h.oldHeight-g.bounds.height();h.bottomYStartValue-=f;return true;},handleLayoutChoreographyTask:function(event){if(!this._isLayoutEnabled){return;}var choreographyTask=event.shape;var isNew=!this.choreographyTasksMeta[choreographyTask.getId()];var choreographyTaskMeta=this.addOrGetChoreographyTaskMeta(choreographyTask);var isResized=this.handleResizingOfChoreographyTask(choreographyTask,choreographyTaskMeta);var oldCountTop=choreographyTaskMeta.numOfParticipantsOnTop;var oldCountBottom=choreographyTaskMeta.numOfParticipantsOnBottom;if(isResized){var participants=choreographyTaskMeta.topParticipants;}else{var participants=this.getParticipants(choreographyTask,true,false);if(!participants){return;}this.ensureParticipantsParent(choreographyTask,participants);}var numOfParticipantsExtended=0;participants.each(function(participant,i){participant.isResizable=false;participant.setProperty("oryx-corners","None");var isExtended=this.setBoundsOfParticipantDependOnProperties(participant,i,numOfParticipantsExtended,choreographyTask.bounds.width(),0);if(isExtended){numOfParticipantsExtended++;}if(i==0){participant.setProperty("oryx-corners","Top");}this.adjustTopBackground(participant);}.bind(this));var resizeFactor=participants.length-choreographyTaskMeta.numOfParticipantsOnTop;var resizeFactorExtended=numOfParticipantsExtended-choreographyTaskMeta.numOfParticipantsExtendedOnTop;var bounds=choreographyTask.bounds;var ul=bounds.upperLeft();var lr=bounds.lowerRight();if(!isNew){bounds.set(ul.x,ul.y-resizeFactor*this.participantSize-resizeFactorExtended*this.extensionSizeForMarker,lr.x,lr.y);}choreographyTaskMeta.topYEndValue=participants.length*this.participantSize+numOfParticipantsExtended*this.extensionSizeForMarker;choreographyTaskMeta.numOfParticipantsExtendedOnTop=numOfParticipantsExtended;choreographyTaskMeta.numOfParticipantsOnTop=participants.length;choreographyTaskMeta.topParticipants=participants;if(isResized){var participants=choreographyTaskMeta.bottomParticipants;}else{var participants=this.getParticipants(choreographyTask,false,true);if(!participants){return;}this.ensureParticipantsParent(choreographyTask,participants);}if(isNew){choreographyTaskMeta.bottomYStartValue=(bounds.height()-(participants.length!=0?eval(participants.map(function(p){return this.participantSize+(this.isExtended(p)?this.extensionSizeForMarker:0);}.bind(this)).join("+")):0));}else{choreographyTaskMeta.bottomYStartValue+=resizeFactor*this.participantSize+resizeFactorExtended*this.extensionSizeForMarker;}var bottomStartYValue=choreographyTaskMeta.bottomYStartValue;var numOfParticipantsExtended=0;participants.each(function(participant,i){participant.isResizable=false;participant.setProperty("oryx-corners","None");var isExtendedParticipant=this.setBoundsOfParticipantDependOnProperties(participant,i,numOfParticipantsExtended,choreographyTask.bounds.width(),bottomStartYValue);if(isExtendedParticipant){numOfParticipantsExtended++;}if(i==participants.length-1){participant.setProperty("oryx-corners","Bottom");}this.adjustTopBackground(participant);}.bind(this));var resizeFactor=participants.length-choreographyTaskMeta.numOfParticipantsOnBottom;var resizeFactorExtended=numOfParticipantsExtended-choreographyTaskMeta.numOfParticipantsExtendedOnBottom;var bounds=choreographyTask.bounds;var ul=bounds.upperLeft();var lr=bounds.lowerRight();if(!isNew){bounds.set(ul.x,ul.y,lr.x,lr.y+resizeFactor*this.participantSize+resizeFactorExtended*this.extensionSizeForMarker);}choreographyTaskMeta.numOfParticipantsExtendedOnBottom=numOfParticipantsExtended;choreographyTaskMeta.numOfParticipantsOnBottom=participants.length;choreographyTaskMeta.bottomParticipants=participants;var participantsHasChanged=oldCountTop!==choreographyTaskMeta.numOfParticipantsOnTop||oldCountBottom!==choreographyTaskMeta.numOfParticipantsOnBottom;this.ensureCenterPositionOfMagnets(choreographyTask,isResized,participantsHasChanged);this.adjustTextFieldAndMarkerPosition(choreographyTask);choreographyTaskMeta.oldHeight=bounds.height();choreographyTaskMeta.oldBounds=bounds.clone();choreographyTask.minimumSize={width:50,height:40+((choreographyTaskMeta.numOfParticipantsOnBottom+choreographyTaskMeta.numOfParticipantsOnTop)*this.participantSize)+((choreographyTaskMeta.numOfParticipantsExtendedOnBottom+choreographyTaskMeta.numOfParticipantsExtendedOnTop)*this.extensionSizeForMarker)};},isExtended:function(a){return(!a||a.properties["oryx-multiple_instance"]===""?false:!!a.properties["oryx-multiple_instance"]);},setBoundsOfParticipantDependOnProperties:function(b,d,g,e,f){var a=this.isExtended(b);var h=f+d*this.participantSize+g*this.extensionSizeForMarker;var c=f+this.participantSize+d*this.participantSize+(a?(g+1)*this.extensionSizeForMarker:g*this.extensionSizeForMarker);b.bounds.set(0,h,e,c);return a;},adjustTextFieldAndMarkerPosition:function(g){var h=this.addOrGetChoreographyTaskMeta(g);var f=g.bounds.height()/g._oldBounds.height();var d=g._labels[g.getId()+"text_name"];if(d){var a=h.topYEndValue+(h.bottomYStartValue-h.topYEndValue)/2;if(g.isResized&&f){d.y=a/f;}else{d.y=a;}}var c=g._svgShapes.find(function(k){return k.element.id==g.getId()+"loop_path";});if(c){c._isYLocked=true;c.y=h.bottomYStartValue-7;}var b=g._svgShapes.find(function(k){return k.element.id==g.getId()+"mi_path";});if(b){b._isYLocked=true;b.y=h.bottomYStartValue-11;}var e=g._svgShapes.find(function(k){return k.element.id==g.getId()+"mi_sequential_path";});if(e){e._isYLocked=true;e.y=h.bottomYStartValue-11;}},ensureCenterPositionOfMagnets:function(d,l,c){var f=this.addOrGetChoreographyTaskMeta(d);var a=f.topYEndValue+(f.bottomYStartValue-f.topYEndValue)/2;var b=a-f.center;var g=d.bounds.height()/f.oldBounds.height();if(!b&&!g){return;}var h=d.magnets.findAll(function(n){return(!n.anchorTop&&!n.anchorBottom);});h.each(function(o){var n=o.bounds.center().x;var p=(o.bounds.center().y+b)/g;o.bounds.centerMoveTo(n,p);});var e=d.absoluteBounds().upperLeft().y+f.topYEndValue;var k=d.absoluteBounds().upperLeft().y+f.bottomYStartValue;var m=new Array();d.incoming.each(function(n){if(!(n instanceof ORYX.Core.Edge)){return;}var o=n.dockers.last();if(e<=o.bounds.center().y&&o.bounds.center().y<=k){m.push(o);}});d.outgoing.each(function(n){if(!(n instanceof ORYX.Core.Edge)){return;}var o=n.dockers.first();if(e<=o.bounds.center().y&&o.bounds.center().y<=k){m.push(o);}});if(c&&d.initialParticipantsAdded){m.each(function(n){var o=n.referencePoint;n.setReferencePoint({x:o.x,y:(o.y+b)/g});});}f.center=a;},ensureParticipantsParent:function(a,b){if(!a||!b){return;}b.each(function(c){if(c.parent.getId()==a.getId()){return;}c.parent.remove(c);a.add(c);});},getParticipants:function(b,h,e){if(b.getStencil().id()!=="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyTask"&&b.getStencil().id()!=="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessCollapsed"&&b.getStencil().id()!=="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographySubprocessExpanded"){return null;}var g=this.addOrGetChoreographyTaskMeta(b);var a=b.absoluteBounds().upperLeft().y+g.topYEndValue+(g.bottomYStartValue-g.topYEndValue)/2;var f=b.getChildNodes(true).findAll(function(k){return(h&&k.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant"&&k.absoluteBounds().center().y<=a&&this.isParticipantOfShape(b,k));}.bind(this));var d=b.getChildNodes(true).findAll(function(k){return(e&&k.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant"&&k.absoluteBounds().center().y>a&&this.isParticipantOfShape(b,k));}.bind(this));var c=f.concat(d);c=c.sort(function(l,k){var m=Math.round(l.absoluteBounds().upperLeft().y);var n=Math.round(k.absoluteBounds().upperLeft().y);return m<n?-1:(m>n?1:0);});return c;},isParticipantOfShape:function(b,a){var c=a.parent;while(c.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant"){c=c.parent;}return c.getId()===b.getId();},adjustTopBackground:function(a){var d=a.properties["oryx-corners"];var b=$(a.getId()+"roundedBgRect");if(!b){return;}if(d==="Top"){b.setAttributeNS(null,"fill","url(#"+a.getId()+"background_top) white");}else{var c=a.properties["oryx-color"];b.setAttributeNS(null,"fill",c);}},handlePropertyChanged:function(c){var b=c.elements;var d=c.key||c.name;var a=c.value;var e=false;b.each(function(f){if(f.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0choreography#ChoreographyParticipant"&&d==="oryx-initiating"){if(!a||a==="false"){f.setProperty("oryx-color","#acacac");}else{f.setProperty("oryx-color","#ffffff");}e=true;}});if(e){this.facade.getCanvas().update();}}};ORYX.Plugins.Bpmn2_0Choreography=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.Bpmn2_0Choreography);if(!Signavio){var Signavio=new Object();}if(!Signavio.Plugins){Signavio.Plugins=new Object();}new function(){Signavio.Plugins.ViewsEditor=ORYX.Plugins.AbstractPlugin.extend({enabled:true,construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":Signavio.I18N.ViewsEditor.name,"functionality":this.showEditor.bind(this),"group":Signavio.I18N.ViewsEditor.group,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/application_double.png","index":0,"description":Signavio.I18N.ViewsEditor.description,"minShape":0,"maxShape":0});},getPools:function(){var a=[];this.facade.getCanvas().getChildShapes().each(function(b){if(b.getStencil().id().endsWith("Pool")){a.push(b);}}.bind(this));a.sort(function(d,c){return(d.bounds.a.y-c.bounds.a.y);});return a;},showEditor:function(){var a=function(){var d=this.body.getPadding("lr");var b=this.items.length;d+=b*210;var c=this.body.child(".x-column-inner");c.setWidth(d);};this.dialog=new Ext.Window({title:Signavio.I18N.ViewsEditor.description,height:450,width:654,autoScroll:true,modal:true,layout:"column",bodyStyle:"padding:10px 10px 10px 0px; background-color:#ffffff",cls:"x-view-window",tbar:[{text:Signavio.I18N.ViewsEditor.addView,icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/application_form_add.png",cls:"x-btn-text-icon",handler:function(){var b=this.generateColumn(undefined,undefined,this.dialog.items.length);this.dialog.add(b);this.dialog.doLayout(true);b.el.scrollIntoView(this.dialog.body);}.bind(this)}],items:[].concat(this.generateColumn(Signavio.I18N.ViewsEditor.defaultView,Signavio.I18N.ViewsEditor.defaultDescription,0,true),this.getViews()),buttons:[{text:Signavio.I18N.Buttons.save,handler:function(){var b=this.dialog.items.items;var d=b.map(function(e){return e.title;});var c=d.uniq();if(c.length!=d.length){Ext.Msg.alert(Signavio.I18N.ViewsEditor.duplicateTitles,Signavio.I18N.ViewsEditor.duplicateTitlesTxt);}else{this.saveViews(this.dialog);this.dialog.close();}}.bind(this)},{text:Signavio.I18N.Buttons.cancel,handler:function(){this.dialog.close();}.bind(this)}]});this.dialog.on("afterlayout",a);this.dialog.show();this.dialog.on("close",function(){delete this.dialog;}.bind(this));},saveViews:function(b){var a=[];b.items.each(function(h,e){if(e==0){return;}var l=[];var f=[];var d;var k;var g;h.items.each(function(m){if(m.colDescription){g=m.getValue();}if(m.dataIndex&&m.poolHide&&!m.getValue()){f.push(m.dataIndex);}if(m.dataIndex&&m.poolCollapse&&!m.getValue()){l.push(m.dataIndex);}if(m.poolData&&!m.getValue()){d=true;}if(m.poolComments&&!m.getValue()){k=true;}});a.push({name:h.title,description:g,definition:{collapse:l,hide:f,hideData:d,hideComments:k}});});var c=ORYX.Core.Command.extend({construct:function(e,d,f){this.facade=e;this.views=d;this.plugin=f;this.oldViews=this.facade.getModelMetaData().views;},execute:function(){this.facade.getModelMetaData().views=this.views;if(!this.plugin.dialog){this.plugin.showEditor();}this.facade.updateSelection();},rollback:function(){this.facade.getModelMetaData().views=this.oldViews;if(!this.plugin.dialog){this.plugin.showEditor();}this.facade.updateSelection();}});this.facade.executeCommands([new c(this.facade,a,this)]);},getViews:function(){var a=this.facade.getModelMetaData().views||[];var b=[];a.each(function(d,e){var l=d.definition.collapse;var c=d.definition.hideData;var k=d.definition.hideComments;var f=d.definition.hide;var h=d.description;var g=this.generateColumn(d.name,h,e);g.items.getRange().reverse().each(function(m){if(m.dataIndex&&m.poolHide&&f.include(m.dataIndex)){m.setValue(false);}if(m.dataIndex&&m.poolCollapse&&l.include(m.dataIndex)){m.setValue(false);}if(m.poolData&&c){m.setValue(false);}if(m.poolComments&&k){m.setValue(false);}});b.push(g);}.bind(this));return b;},generateColumn:function(h,k,g,f){var l=this.getPools();var a=new Ext.Panel({tools:[{id:"close",hidden:f,handler:function(o,n,m){Ext.Msg.confirm(Signavio.I18N.ViewsEditor.removeView,new Ext.XTemplate(Signavio.I18N.ViewsEditor.removeViewText).apply([h||Signavio.I18N.ViewsEditor.view+((g||0)+1)]),function(q){if(q=="yes"){var p=m.ownerCt;p.remove(m);p.doLayout();}});}}],title:h||Signavio.I18N.ViewsEditor.view+((g||0)+1),layout:"form",width:200,cls:"y-view-panel",style:"margin-left:10px;",bodyStyle:"padding:10px;"});var b=new Ext.form.TextField({hideLabel:true,disabled:f,width:"95%",value:a.title,allowBlank:true,emptyText:Signavio.I18N.ViewsEditor.blankTitle,listeners:{change:function(p,o){var n=this.ownerCt.ownerCt;var m=n.items.items;m.each(function(q){if(q.title==o){this.markInvalid("Dieser Name ist bereits vergeben.");}else{if(n.buttons[0].disabled){n.buttons[0].enable();}}}.bind(this));a.setTitle(o||Signavio.I18N.ViewsEditor.view+((g||0)+1));}}});var e=new Ext.form.TextArea({hideLabel:true,disabled:f,colDescription:true,width:"95%",value:k,emptyText:Signavio.I18N.ViewsEditor.blankDescription});a.add(b);a.add(e);l.each(function(p,n){var q,o;var m=p.getStencil().id().endsWith("CollapsedPool")||p.getStencil().id().endsWith("CollapsedVerticalPool");q=new Ext.form.Checkbox({boxLabel:p.properties["oryx-name"]?new Ext.XTemplate(Signavio.I18N.ViewsEditor.show).apply([(p.properties["oryx-name"]||"").escapeHTML()]):new Ext.XTemplate(Signavio.I18N.ViewsEditor.show).apply(["<i>Pool "+(n+1)+"</i>"]),dataIndex:p.resourceId,poolHide:true,hideLabel:true,listeners:{check:function(s,r){if(!r){o.setValue(false);o.disable(true);}else{if(r&&!f&&!m){o.enable(true);}}}},disabled:f,checked:true});o=new Ext.form.Checkbox({boxLabel:Signavio.I18N.ViewsEditor.expanded,dataIndex:p.resourceId,poolCollapse:true,hideLabel:true,style:"margin-left:20px;",disabled:m||f,checked:!m});a.add(q);a.add(o);}.bind(this));var d=new Ext.form.Checkbox({boxLabel:Signavio.I18N.ViewsEditor.allDataObjects,poolData:true,hideLabel:true,disabled:f,checked:true,listeners:{render:function(){this.el.parent(".x-form-item").setStyle({"border-top":"1px solid silver","padding-top":"5px","margin-top":"5px"});}}});var c=new Ext.form.Checkbox({boxLabel:Signavio.I18N.ViewsEditor.allComments,poolComments:true,hideLabel:true,disabled:f,checked:true});a.add(d);a.add(c);a.on("render",function(){a.header.setWidth(a.el.getWidth());});return a;}});}();if("undefined"===typeof ORYX){var ORYX={};}if("undefined"===typeof ORYX.Plugins){ORYX.Plugins={};}new function(){ORYX.Plugins.Watermark=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;this.facade.registerOnEvent("layout.bpmn2_0.pool",this.handleLayoutPool.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.handlePropertyChanges.bind(this));},handlePropertyChanges:function(d,c){if(!(c.getStencil().id().endsWith("#Pool")||c.getStencil().id().endsWith("#Lane"))){return;}var b=c.getLabels()[0];var a=function(){b.unregisterOnChange(a);this.handleLayoutPool(d,c);}.bind(this);b.registerOnChange(a);},getValue:function(a,b){var e=b.id.replace(b.shapeId,""),d=a.getStencil().properties().findAll(function(k){return k.type().toLowerCase()=="string"&&k.refToView().include(e);}),g=this.facade.getCanvas().getLanguage(),h=d.find(function(k){return k.language()==g;});if(!h){return"";}d=[].concat(h,d.without(h));var c=d.find(function(k){return(a.properties[k.prefix()+"-"+k.id()]||"").strip()||false;});var f=c&&c!==h?" ("+(Signavio.I18N.Multilanguage[String(c.language()).toUpperCase()+"_Short"]||c.language())+")":"";return(c&&(a.properties[c.prefix()+"-"+c.id()]).strip()+(f))||"";},handleLayoutPool:function(b,f){if(!f){f=b.shape;}if(b.type==="layout.bpmn2_0.pool"||b.type==="propertyChanged"&&String(b.name).startsWith("oryx-name")){var h,c,a,m,e,g,d,k=this;var l=[this.getDeepestLanes(f)].flatten();l.each(function(o){c=this.getAllParentLanes(o);h=this.getParentPool(o);a=h.bounds;m=a.height();e=a.width();g=[];if(!h){return;}c.each(function(s){g.push(k.getValue(s,s.getLabels()[0])||undefined);});g=g.compact();if(g.length===0){g.push(k.getValue(h,h.getLabels()[0]));}var p=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{"x":0,"y":0,"fill":"silver","stroke":"none","class":"y-node-watermark","font-size":"12","text-anchor":"middle","font-style":"italic"}].concat([["tspan",{"x":0,"y":0,"dy":0},g.map(function(s){return String(s).truncate(50);}).join(" - ")]]));var q=this.getParentNodes(o);q.each(function(s){$A(s.childNodes).each(function(t){if(t.tagName==="text"&&t.getAttributeNS(null,"class")==="y-node-watermark"){s.removeChild(t);}});});d=0;if(this.facade.getCanvas().getOrientation()==="vertical"){d=m;}else{if(this.facade.getCanvas().getOrientation()==="horizontal"){d=e;}}for(var r=1;r<d/750;r+=2){var n=p.cloneNode(true);if(this.facade.getCanvas().getOrientation()==="vertical"){n.setAttributeNS(null,"transform","translate("+(15)+", "+((650*r)-((c.length-1)*30))+") rotate(270)");}else{n.setAttributeNS(null,"transform","translate("+((650*r)-((c.length-1)*30))+", "+(15)+")");}o.getLabels()[0].node.parentNode.appendChild(n);}}.bind(this));}},getAllParentLanes:function(b){var a=[];while(b&&!(b instanceof ORYX.Core.Canvas)){if(b instanceof ORYX.Core.Node&&b.getStencil().id().endsWith("Lane")){a.push(b);}b=b.parent;}return a.reverse();},getParentPool:function(a){while(a&&!(a instanceof ORYX.Core.Canvas)){if(a instanceof ORYX.Core.Node&&a.getStencil().id().endsWith("Pool")){return a;}a=a.parent;}return undefined;},getParentNodes:function(a){if(!a){return[];}if(a.parent instanceof ORYX.Core.Canvas){return[a.getLabels()[0].node.parentNode];}else{return this.getParentNodes(a.parent).concat(a.getLabels()[0].node.parentNode);}},getDeepestLanes:function(b){if(!b){return[];}var a=b.children.findAll(function(c){if(c.getStencil instanceof Function&&c.getStencil().id().endsWith("Lane")){return true;}});if(a.length===0){return b;}else{return a.collect(function(d){return this.getDeepestLanes(d);}.bind(this));}}});}();if("undefined"===typeof Signavio){var Signavio={};}if("undefined"===typeof Signavio.Plugins){Signavio.Plugins={};}new function(){Signavio.Plugins.ViewsAttributeWindow=ORYX.Plugins.AbstractPlugin.extend({_comboboxStates:{opened:Signavio.I18N.ViewDefinition.comboboxStateOpened,closed:Signavio.I18N.ViewDefinition.comboboxStateClosed,collapse:Signavio.I18N.ViewDefinition.comboboxStateCollapse,onlyContent:Signavio.I18N.ViewDefinition.comboboxStateOnlyContent},construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:'<a style="color:blue;"> '+Signavio.I18N.ViewDefinition.createView+"</a>",icon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/add.png",icons:[ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/add.png"],index:0,target:ORYX.Plugins.PropertyWindow,category:"view",getPanel:function(){return this.getMainPanel();}.bind(this)});this.checkboxCollection=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,function(a,b){this.facadeSelectionChanged(a.elements);}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SAVED,function(){this.modelWasSaved();}.bind(this));},getMainPanel:function(){var a=new Ext.Panel({layout:"anchor",cls:"ak-views-general-header-attribute ak-views-expanded-header-attribute ak-views-views-mainpanel ak-views-attribute-header-span",border:true,title:Signavio.I18N.ViewDefinition.views,collapsible:true,collapsed:true,titleCollapse:true,odd:true,hideCollapseTool:true});a.on("collapse",function(b){b.removeClass("ak-views-expanded-header-attribute");b.addClass("ak-views-collapsed-header-attribute");});a.on("expand",function(b){b.removeClass("ak-views-collapsed-header-attribute");b.addClass("ak-views-expanded-header-attribute");b.doLayout();});a.on("render",function(){a.ownerCt.on("resize",function(b,c){a.setWidth(c-1);});a.setWidth(a.ownerCt.getInnerWidth()-1);});this.panelInPropertyWindow=a;return a;},getCreateViewPanel:function(){var c=this;var a=ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/add.png";var b='<img class="ak-views-image-add-button" src="'+a+'" style="padding-right:5px; cursor: pointer;"></img>';return new Ext.Panel({layout:"anchor",cls:"ak-views-subpanel ak-views-create-view-subpanel",anchor:"100% 100%",html:'<a href="#" class="linkToCreateViews ak-views-create-view-link">'+b+Signavio.I18N.ViewDefinition.createNewView+" </a>",afterRender:function(d){Ext.Panel.prototype.afterRender.apply(this,arguments);this.body.query("a.linkToCreateViews").each(function(e){Ext.get(e).on("click",function(f){Event.stop(f);c.showViewEditor();});});}});},renderViewsOfModel:function(){var c=this.panelInPropertyWindow;if(c.items){c.items.each(function(f){c.remove(f,true);}.bind(this));}var a=this.getAllViewsFromMeta();var e=new Ext.Panel({html:Signavio.I18N.ViewDefinition.descriptionCreateView,cls:"ak-views-view-title-subpanel ak-views-title-panels"});c.add(e);c.add(this.getCreateViewPanel());if(a&&a.length>0){var d='<img style="padding-left:5px;" '+(Ext.isChrome||Ext.isSafari?'title="':'ext:qtip="')+Signavio.I18N.ViewDefinition.visibleCheckboxesInfo+'" src="'+ORYX.CONFIG.EXPLORER_PATH+'/src/img/famfamfam/information.png" class="x-info-img"/>';var b=new Ext.Panel({layout:"fit",html:Signavio.I18N.ViewDefinition.descriptionViewCheckbox+d,cls:"ak-views-view-title-subpanel ak-views-title-panels"});c.add(b);this.renderGivenViews();}c.doLayout();},renderGivenViews:function(){var b=true;this.checkboxCollection=[];var a=this.getAllViewsFromMeta();a.each(function(c){this.addNewViewToPanel(this.panelInPropertyWindow,c,b);b=!b;}.bind(this));},addNewViewToPanel:function(b,h,l){var g=this;var c=h;var f=new Ext.Panel({html:'<a href="#" class="linkToCreateViews ak-views-create-view-link">'+h.name.escapeHTML()+"</a>",afterRender:function(m){Ext.Panel.prototype.afterRender.apply(this,arguments);this.body.query("a.linkToCreateViews").each(function(n){Ext.get(n).on("click",function(o){Event.stop(o);g.showViewEditor(h);});});}});var e=new Ext.form.Checkbox({cls:"ak-views-attribute-checkbox-margin"});var k=ORYX.CONFIG.EXPLORER_PATH+"/src/img/views/intermediate.gif";var d=document.createElement("img");d.src=k;e.on("render",function(m){m.container.dom.appendChild(m.triStateImage);Ext.fly(m.triStateImage).on("click",function(){Ext.fly(m.triStateImage).hide();var n=this.facade.getSelection();var o=this.getAllViewsFromMeta();var p=new Signavio.Plugins.ViewsAttributeWindow.CheckboxChangeCommand(n,h,o,m,false,this.facade,this);this.facade.executeCommands([p]);m.show();}.bind(this));Ext.fly(m.triStateImage).on("mouseover",function(){var n=ORYX.CONFIG.EXPLORER_PATH+"/src/img/views/intermediate_highlighted.gif";m.triStateImage.src=n;}.bind(this));Ext.fly(m.triStateImage).on("mouseout",function(){var n=ORYX.CONFIG.EXPLORER_PATH+"/src/img/views/intermediate.gif";m.triStateImage.src=n;}.bind(this));Ext.fly(m.triStateImage).hide();}.bind(this));e.triStateImage=d;e.view=h;e.on("check",function(n,m){this.viewCheckboxChanged(n,m);}.bind(this));this.checkboxCollection.push(e);var a=new Ext.Panel({cls:(l===true)?" ak-views-subpanel ak-views-odd-subpanel":"ak-views-subpanel",layout:"column",anchor:"100%",viewName:h.name,items:[{columnWidth:0.8,items:[f]},{columnWidth:0.2,items:[e]}]});b.add(a);},loadModelFromDefinition:function(c){this.viewWindow.containerFrameRightPanel.body.mask(Signavio.I18N.ViewDefinition.preview,"x-waiting-box");var d=Ext.fly("rightIFrame");if(d){d.fadeOut({duration:0.7,remove:false});}var b=this.getInitialJSOnFromCurrentModel();var a=this.getPreviewHtmlForIFrame(b,Object.toJSON(c));this.fillIFramePanelWithHTML(this.viewWindow.rightIFramePanel,a);},showViewEditor:function(b){var a=this.getWindow(b);this.hideElements=[];a.on("show",function(){if(b!==undefined){this.firstLoading=true;this.loadModelFromDefinition(b.definition);}else{this.refreshRightSide();}this.loadInitModelForLeftSide(b);}.bind(this));a.show();},getDocHeight:function(){var a=document;return Math.max(Math.max(a.body.scrollHeight,a.documentElement.scrollHeight),Math.max(a.body.offsetHeight,a.documentElement.offsetHeight),Math.max(a.body.clientHeight,a.documentElement.clientHeight));},getDocWidth:function(){var a=document;return Math.max(Math.max(a.body.scrollWidth,a.documentElement.scrollWidth),Math.max(a.body.offsetWidth,a.documentElement.offsetWidth),Math.max(a.body.clientWidth,a.documentElement.clientWidth));},getWindow:function(s){var p=this.getDocHeight()*0.9;var z=this.getDocWidth()*0.94;var m;var e=new Ext.form.Checkbox({boxLabel:Signavio.I18N.ViewDefinition.roles,types:["Pool","VerticalPool","CollapsedVerticalPool","CollapsedPool","processparticipant","Lane","VerticalLane"],idCheckbox:"Roles",cls:"ak-views-legend-checkbox",checked:(s==undefined)?true:!s.definition.hideRoles});e.on("check",function(D,C){this.legendCheckboxWasChecked(D,C);}.bind(this));var o=new Ext.form.Checkbox({boxLabel:Signavio.I18N.ViewDefinition.itsystems,types:["ITSystem"],idCheckbox:"ITSystem",cls:"ak-views-legend-checkbox",checked:(s==undefined)?true:!s.definition.hideITSystems});o.on("check",function(D,C){this.legendCheckboxWasChecked(D,C);}.bind(this));var d=new Ext.form.Checkbox({boxLabel:Signavio.I18N.ViewDefinition.dataobjects,types:["DataObject","DataStore","Message"],idCheckbox:"Dataobject",cls:"ak-views-legend-checkbox",checked:(s==undefined)?true:!s.definition.hideData});d.on("check",function(D,C){this.legendCheckboxWasChecked(D,C);}.bind(this));var k=new Ext.form.Checkbox({boxLabel:Signavio.I18N.ViewDefinition.comments,types:["TextAnnotation"],idCheckbox:"Comments",cls:"ak-views-legend-checkbox",checked:(s==undefined)?true:!s.definition.hideComments});k.on("check",function(D,C){this.legendCheckboxWasChecked(D,C);}.bind(this));var y=new Ext.Panel({anchor:"100% 100%",layout:"anchor",id:"leftIFramePanel",html:'<iframe id="leftIFrame" style="width:100%;height:100%;border:none;"></iframe>',border:false,style:"border-top-width:1px; border-top-style:solid;border-top-color:#000000;"});var a=new Ext.Panel({layout:"anchor",border:false,anchor:"100% 100%",items:[y]});var u=new Ext.Panel({title:Signavio.I18N.ViewDefinition.originalView,border:true,region:"center",layout:"anchor",cls:"ak-views-attribute-header ak-views-attribute-border-frame ak-views-attribute-white-box",bodyStyle:"background-color:#ffffff; border-right:none; border-left: none; border-bottom:none;",split:true,items:[a]});var t=new Ext.form.TextField({fieldLabel:Signavio.I18N.ViewDefinition.name,name:"viewName",allowBlank:true,cls:"ak-view-textbox-size",value:(s!==undefined)?s.name:""});var n=new Ext.Panel({defaultType:"textfield",layout:"form",border:false,itemCls:"ak-view-textbox-label",labelWidth:40,items:[t]});var B=new Ext.form.TextField({fieldLabel:Signavio.I18N.ViewDefinition.description,name:"viewName",allowBlank:true,value:(s!==undefined)?s.description:"",emptyText:Signavio.I18N.ViewDefinition.noDescription});var q=new Ext.Panel({defaultType:"textfield",layout:"form",border:false,labelWidth:73,itemCls:"ak-view-textbox-label",items:[B]});var A=new Ext.Panel({anchor:"100% 100%",layout:"anchor",id:"rightIFramePanel",html:'<iframe id="rightIFrame" style="width:100%;height:100%;border:none;"></iframe>',border:false,style:"border-top-width:1px; border-top-style:solid;border-top-color:#000000;"});var h=new Ext.Panel({layout:"anchor",border:false,anchor:"100% 100%",items:[A]});var v=new Ext.Panel({title:Signavio.I18N.ViewDefinition.previewTitle,region:"east",border:true,layout:"fit",cls:"ak-views-attribute-header ak-views-attribute-border-frame ak-views-attribute-white-box",bodyStyle:"background-color:#ffffff; border-right:none; border-left: none; border-bottom:none;",split:true,width:z/2,items:[h]});var l=new Ext.LinkButton({text:Signavio.I18N.ViewDefinition.cancel,style:"color: white; display: block; font-size: 11px; padding-bottom: 2px; padding-left: 5px;padding-right: 5px;padding-top: 2px; white-space: nowrap;",click:function(){m.close();}.bind(this)});var c=new Ext.Button({text:(s==undefined)?Signavio.I18N.ViewDefinition.save:Signavio.I18N.ViewDefinition.saveChanges,handler:function(){var F=this.getNewViewDefinition();if(this.isValidViewName(F.name)===false){Ext.Msg.alert(Signavio.I18N.ViewDefinition.warningName1,Signavio.I18N.ViewDefinition.warningName2);return;}var D=this.getAllViewsFromMeta();if(s!==undefined){var C=this.viewWindow.paramViewDefinition;var E=new Signavio.Plugins.ViewsAttributeWindow.ChangeCommand(F,C,D,this.facade,this);this.facade.executeCommands([E]);}else{var F=this.getNewViewDefinition();var D=this.getAllViewsFromMeta();var E=new Signavio.Plugins.ViewsAttributeWindow.CreateCommand(F,D,this.facade,this);this.facade.executeCommands([E]);}m.close();}.bind(this)});var r=new Ext.form.Checkbox({checked:true,itemCls:"ak-views-synchron-checkbox",labelStyle:"color: white !important;",boxLabel:Signavio.I18N.ViewDefinition.synchronScroll});r.on("check",function(D,C){this.viewWindow.isSynchronScrolling=C;}.bind(this));var f=[r,l,c];var b;if(!(s==undefined)){b=new Ext.Button({text:Signavio.I18N.ViewDefinition.deleteView,handler:function(){Ext.Msg.confirm(Signavio.I18N.ViewDefinition.attention,Signavio.I18N.ViewDefinition.attentionDescription,function(C){if(C=="yes"){var D=this.getAllViewsFromMeta();var E=new Signavio.Plugins.ViewsAttributeWindow.RemoveCommand(s,D,this.facade,this);this.facade.executeCommands([E]);m.close();}}.bind(this)).setIcon(Ext.MessageBox.QUESTION);}.bind(this)});dupButton=new Ext.Button({text:Signavio.I18N.ViewDefinition.saveDuplicateButton,handler:function(){this.duplicateView(m);}.bind(this)});f=[r,l,b,dupButton,c];}var x=new Ext.Panel({layout:"column",border:false,height:50,items:[{columnWidth:!Ext.isIPad?0.1:0.11,items:[k],bodyStyle:"padding-top:15px;padding-left:15px;white-space: nowrap;",border:false},{columnWidth:!Ext.isIPad?0.1:0.11,items:[d],bodyStyle:"padding-top:15px;padding-left:15px;white-space: nowrap;",border:false},{columnWidth:!Ext.isIPad?0.1:0.11,items:[o],bodyStyle:"padding-top:15px;padding-left:15px;white-space: nowrap;",border:false},{columnWidth:!Ext.isIPad?0.1:0.13,items:[e],bodyStyle:"padding-top:15px;padding-left:15px;white-space: nowrap;",border:false},{columnWidth:!Ext.isIPad?0.25:0.2,items:[n],bodyStyle:"padding-top:"+Ext.isIPad?"15":"13"+"px;padding-left:15px;white-space: nowrap;",border:false},{columnWidth:!Ext.isIPad?0.35:0.33,items:[q],bodyStyle:"padding-top:"+Ext.isIPad?"15":"13"+"px;padding-left:25px;white-space: nowrap;",border:false}]});x.on("afterlayout",function(D,H){if(D.getSize().width<1024){return;}if(x.rendered){var G=D.items;var M=40;var C=D.getSize().width;if(G){for(i=0;i<4;i++){var E=G.items[i];if(E.rendered&&E.items.items[0].rendered){var I=E.items.items[0].container.dom.childElements()[0].childElements()[1].getWidth();var L=E.items.items[0].getSize().width;var F=I+L+M;C-=F;E.setWidth(F);}}var E=G.items[4];if(E.rendered&&E.items.items[0].rendered){E.setWidth(300);C-=300;}var E=G.items[5];if(E.rendered&&E.items.items[0].rendered){E.setWidth(C);var K=E.items.items[0].el.dom.getElementsByTagName("label")[0];if(K){var I=Ext.fly(K).getSize().width;var J=E.items.items[0].items.items[0];if(J){J.setWidth(C-I-40);}}}}}}.bind(this));var g=new Ext.Panel({layout:"border",border:false,cls:"ak-views-container-panel",items:[u,v]});r.on("render",function(){this.el.parent().parent().addClass("ak-views-attribute-left-checkbox ak-views-attribute-left-checkbox-position");this.el.parent().parent().setWidth("100%");});g.on("render",function(){var C=this.viewWindow.getInnerHeight()-this.viewWindow.configPanel.el.getHeight();this.viewWindow.frameContainerPanel.body.setHeight(C);this.viewWindow.frameContainerPanel.syncSize();}.bind(this));m=new Ext.Window({height:p,layout:"anchor",anchor:"100% 100%",width:z,modal:true,maximizable:true,nameTextBox:t,nameBox:n,descriptionBox:q,leftContainer:u,rightContainer:v,rightIFramePanel:A,leftIFramePanel:y,checkBIT:o,checkBComments:k,checkBDataobjects:d,checkBRoles:e,containerFrameRightPanel:h,containerFrameLeftPanel:a,frameContainerPanel:g,configPanel:x,isSynchronScrolling:true,paramViewDefinition:s,legend:[o,k,d,e],title:Signavio.I18N.ViewDefinition.viewsConfig,items:[x,g],leftFrameFacade:undefined,rightFrameFacade:undefined,buttons:f,saveEditButton:c,cls:"ak-splitpanel",lastRightScroll:undefined,firstLoadingLeft:true,firstLoadingRight:true,minWidth:600});m.on("show",function(C){this.setHeightsOfFrames(C);}.bind(this));u.on("resize",function(E,D,F,G,C){this.setHeightsOfFrames(this.viewWindow);}.bind(this));v.on("resize",function(E,D,F,G,C){this.setHeightsOfFrames(this.viewWindow);}.bind(this));m.on("resize",function(E,F,D){this.adaptFramesSizeWhenResizing(E,F);var C=E.getInnerWidth();if(E.configPanel.rendered){E.configPanel.setWidth(C);}if(E.frameContainerPanel.rendered){E.frameContainerPanel.setWidth(C);}this.setHeightsOfFrames(E);}.bind(this));this.viewWindow=m;this.viewWindow.frameIsZooming="";return m;},adaptFramesSizeWhenResizing:function(b,d){if(b.frameContainerPanel&&b.frameContainerPanel.rendered&&b.leftContainer.rendered&&b.rightContainer.rendered){if(d===b.oldWidth){return;}b.oldWidth=d;var a=b.leftContainer.getInnerWidth()+b.rightContainer.getInnerWidth()+9;var c=Math.round((b.rightContainer.getInnerWidth()/a)*(d-12));b.rightContainer.setWidth(c-1);}},setHeightsOfFrames:function(b){if(b.frameContainerPanel&&b.frameContainerPanel.rendered&&b.leftContainer.rendered&&b.rightContainer.rendered){var a=b.getInnerHeight()-b.configPanel.el.getHeight();b.frameContainerPanel.body.setHeight(a);b.leftContainer.body.setHeight(a);b.rightContainer.body.setHeight(a);if(b.frameContainerPanel.layout.rendered){b.frameContainerPanel.doLayout();}}},getAllViewNames:function(){var a=this.getAllViewsFromMeta();var b=[];a.each(function(c){b.push(c.name);}.bind(this));return b;},duplicateView:function(a){Ext.Msg.prompt(Signavio.I18N.ViewDefinition.saveDuplicateButton,Signavio.I18N.ViewDefinition.nameOfView,function(c,f){if(c=="ok"){if(this.isValidViewName(f.trim())===false){Ext.Msg.alert(Signavio.I18N.ViewDefinition.warningName1,Signavio.I18N.ViewDefinition.warningName2,function(){this.duplicateView();}.bind(this));}else{var b=this.getNewViewDefinition();b.name=f;var d=this.getAllViewsFromMeta();var e=new Signavio.Plugins.ViewsAttributeWindow.CreateCommand(b,d,this.facade,this);this.facade.executeCommands([e]);this.panelInPropertyWindow.doLayout();a.close();}}}.bind(this));},isValidViewName:function(b){var a=this.getAllViewNames();var c=this.viewWindow.paramViewDefinition;if(b.trim()===""){return false;}if(c==undefined){if(a.indexOf(b)!==-1){return false;}else{return true;}}else{if(a.indexOf(b)===-1||b===c.name){return true;}else{return false;}}},getNewViewDefinition:function(){var d=this.getViewDefinition();var f=this.hideElements||[];var c=[];var b=[];var a=this.getAllCollapsedPools();a.each(function(h){c.push(h.resourceId);}.bind(this));var g=this.getAllOnlyContentPools();g.each(function(h){b.push(h.resourceId);}.bind(this));d.hide=f||[];d.collapse=c||[];d.hideSingleRole=b||[];var e={name:this.viewWindow.nameBox.items.items[0].getValue(),description:this.viewWindow.descriptionBox.items.items[0].getValue(),definition:d};return e;},loadInitModelForLeftSide:function(d){this.viewWindow.containerFrameLeftPanel.body.mask(Signavio.I18N.ViewDefinition.originalPreview,"x-waiting-box");var c={hideComments:false,hideData:false,hideITSystems:false,hideRoles:false};var b=this.getInitialJSOnFromCurrentModel();var a=this.getPreviewHtmlForIFrame(b,Object.toJSON(c));this.fillIFramePanelWithHTML(this.viewWindow.leftIFramePanel,a);},getViewDefinition:function(){return{hideComments:!this.viewWindow.checkBComments.checked,hideData:!this.viewWindow.checkBDataobjects.checked,hideITSystems:!this.viewWindow.checkBIT.checked,hideRoles:!this.viewWindow.checkBRoles.checked};},shapeHasTypeOf:function(a,b){return(b.indexOf(a.stencil.id)!==-1);},getAllOnlyContentPools:function(){var a=this.viewWindow.htmlElementToPairCollection;var f=[];for(var c in a){var e=a[c];if(e.shape!==undefined){if(e.isCombobox&&e.getPoolState()===this._comboboxStates.onlyContent){f.push(e.shape);var d=e.shape.childShapes;for(var c in d){var b=d[c];f.push(b);}}}}return f;},getAllCollapsedPools:function(){var b=this.viewWindow.htmlElementToPairCollection;var a=[];for(var c in b){var d=b[c];if(d.shape!==undefined){if(d.isCombobox&&d.getPoolState()===this._comboboxStates.collapse){a.push(d.shape);}}}return a;},setFocusedElement:function(){var a=this.viewWindow.focuesLeftElement;if(a){Ext.fly(a).focus();}},findAndSaveFocusedElement:function(){if(this.viewWindow.leftContext){this.viewWindow.focuesLeftElement=this.viewWindow.leftContext.document.activeElement;}},refreshRightSide:function(){var a=this.viewWindow.rightFrameFacade;this.findAndSaveFocusedElement();if(a){var c=a.getModelViewer().getScrollboxEl();this.viewWindow.lastRightScroll=c.lastScroll;this.viewWindow.lastRightWidth=a.getModelViewer().getImgWidth();this.viewWindow.lastRightHeight=a.getModelViewer().getImgHeight();if(a._view.zoomslider){this.viewWindow.lastRightZoomLevel=a.getModelViewer().getZoomLevel();this.viewWindow.lastRightMinZoomLevel=this.getMinZoomLevelOfModelViewer(a.getModelViewer());}}var b=Ext.fly("rightIFrame");if(b){b.fadeOut({duration:0.7,remove:false});}window.setTimeout(function(){this.viewWindow.containerFrameRightPanel.body.mask(Signavio.I18N.ViewDefinition.preview,"x-waiting-box");var f=this.getNewViewDefinition();var e=this.getInitialJSOnFromCurrentModel();var d=this.getPreviewHtmlForIFrame(e,Object.toJSON(f.definition));this.fillIFramePanelWithHTML(this.viewWindow.rightIFramePanel,d);}.bind(this),700);},getInitialJSOnFromCurrentModel:function(){return this.facade.getJSON();},getMinZoomLevelOfModelViewer:function(a){var b=(a.get("offsetWidth")-5)/a.getImgWidth();var c=(a.get("offsetHeight")-5)/a.getImgHeight();var d=(b<c)?b:c;if(d>1){d=1;}return d*100;},fillIFramePanelWithHTML:function(b,c){var a=b.initialConfig.html+"";b.body.update(a);var d=b.body.child("iframe");var f=undefined;f=d.dom.contentDocument;f.write(c);var e=this;f.close();f.addEventListener("load",function(){if(this.frameElement.id=="leftIFrame"){if(this.SignavioConfig!==undefined){this.SignavioConfig.callback=e.leftFrameCallback.bind(e,this);}}if(this.frameElement.id=="rightIFrame"){if(this.SignavioConfig!==undefined){this.SignavioConfig.callback=e.rightFrameCallback.bind(e,this);}}}.bind(d.dom.contentWindow),true);},modelViewerIsZooming:function(f,a){if(f==undefined||a==undefined){return;}var m;var k;if(f==this.viewWindow.leftModelViewer){m="left";k=this.viewWindow.rightFrameFacade._view.zoomslider;}else{m="right";k=this.viewWindow.leftFrameFacade._view.zoomslider;}if(m==this.viewWindow.frameIsZooming){if(this.viewWindow.isSynchronScrolling){var e=f.getZoomLevel();var c=this.getMinZoomLevelOfModelViewer(f);var b=this.getMinZoomLevelOfModelViewer(a);var q=100;var p=100;var o=q-c;var n=p-b;var d=e-c;var h=(100/o*d)/100;var g=n*h;var l=b+g;if(typeof(l)==="number"&&isNaN(l)===false){a.setZoomLevel(l);if(k){k.update();}}}}},modelViewerIsStartingZoom:function(d){if(this.viewWindow.frameIsZooming==""){this.viewWindow.frameIsZooming=d;if(d==="right"){var a=this.viewWindow.htmlElementToPairCollection;for(var b in a){var c=a[b];if(c.parentHtmlElement!==undefined){Ext.fly(c.parentHtmlElement).hide();}}}}},modelViewerIsEndingZoom:function(d){if(this.viewWindow.frameIsZooming==d){this.viewWindow.frameIsZooming="";if(d==="right"){var a=this.viewWindow.htmlElementToPairCollection;for(var b in a){var c=a[b];if(c.parentHtmlElement!==undefined){Ext.fly(c.parentHtmlElement).show();}}}}},scrollingModel:function(s,e){if(this.viewWindow.frameIsZooming==""){if(this.viewWindow.isSynchronScrolling){var l=s.getScrollboxEl();var m=e;var k=m.getScrollboxEl();if(l.scrolling||m._isDragging){return;}var p=l.get("scrollLeft"),d=l.get("scrollTop");var r=l.get("offsetHeight"),u=l.get("offsetWidth"),q=k.get("offsetHeight"),t=k.get("offsetWidth"),c=l.get("scrollHeight"),b=k.get("scrollHeight"),h=l.get("scrollWidth"),g=k.get("scrollWidth");if(!(r==c||r-17==c)){u=u-17;}if(!(u==h||u-17==h)){r=r-17;}if(!(q==b||q-17==b)){t=t-17;}if(!(t==g||t-17==g)){q=q-17;}p=Math.round((p)*((g-t)/(h-u)));d=Math.round((d)*((b-q)/(c-r)));var n=Math.abs(p-(k.lastScroll||{left:0}).left||0)>=2,o=Math.abs(d-(k.lastScroll||{top:0}).top||0)>=2;var a={};if(n){k.set("scrollLeft",p);}if(o){k.set("scrollTop",d);}if(n||o){k.scrolling=true;if(this.scrolling){this.scrolling=[a];}else{var f=function(v){this.scrolling=[];if(this.scrolling&&this.scrolling.length>0){f(this.scrolling.pop());}else{delete this.scrolling;delete k.scrolling;}}.bind(this);f(a);}}if(n||o){l.lastScroll={left:l.get("scrollLeft"),top:l.get("scrollTop")};k.lastScroll={left:k.get("scrollLeft"),top:k.get("scrollTop")};}}}},leftFrameCallback:function(f,a){var c=Ext.fly("leftIFrame");if(c){c.fadeOut({duration:0.1});}var e,d,b=Ext.isIE6||Ext.isIE7||Ext.isIE8;this.renderMarkersForShapesInLeftFrame(f,a);this.viewWindow.leftModelViewer=a.getModelViewer();this.viewWindow.leftFrameFacade=a;this.viewWindow.leftContext=f;this.viewWindow.leftModelViewer.onZoomLevelChange.subscribe(function(){this.modelViewerIsZooming(this.viewWindow.leftModelViewer,this.viewWindow.rightModelViewer);}.bind(this));this.viewWindow.leftModelViewer.onZoomLevelChangeStart.subscribe(function(){this.modelViewerIsStartingZoom("left");}.bind(this));this.viewWindow.leftModelViewer.onZoomLevelChangeEnd.subscribe(function(){this.modelViewerIsEndingZoom("left");}.bind(this));this.viewWindow.leftModelViewer.getScrollboxEl().get("element")[!b?"addEventListener":"attachEvent"](!b?"scroll":"onscroll",function(){this.scrollingModel(this.viewWindow.leftModelViewer,this.viewWindow.rightModelViewer);}.bind(this),true);window.setTimeout(function(){this.viewWindow.containerFrameLeftPanel.body.unmask();if(this.firstLoading===true&&this.viewWindow.paramViewDefinition){this.setViewDefinitionForModel();}else{window.setTimeout(function(){var g=Ext.fly("leftIFrame");if(g){g.fadeIn({duration:1});}}.bind(this),300);}if(this.viewWindow.firstLoadingLeft===true){this.setBestFitZoomLevelForModel(a);this.viewWindow.firstLoadingLeft===false;window.setTimeout(function(){this.viewWindow.nameTextBox.focus();}.bind(this),1300);}}.bind(this),500);},rightFrameCallback:function(d,a){var e,c,b=Ext.isIE6||Ext.isIE7||Ext.isIE8;this.viewWindow.rightModelViewer=a.getModelViewer();this.viewWindow.rightFrameFacade=a;this.viewWindow.rightContext=d;this.viewWindow.rightModelViewer.onZoomLevelChange.subscribe(function(){this.modelViewerIsZooming(this.viewWindow.rightModelViewer,this.viewWindow.leftModelViewer);}.bind(this));this.viewWindow.rightModelViewer.onZoomLevelChangeStart.subscribe(function(){this.modelViewerIsStartingZoom("right");}.bind(this));this.viewWindow.rightModelViewer.onZoomLevelChangeEnd.subscribe(function(){this.modelViewerIsEndingZoom("right");}.bind(this));this.viewWindow.rightModelViewer.getScrollboxEl().get("element")[!b?"addEventListener":"attachEvent"](!b?"scroll":"onscroll",function(){this.scrollingModel(this.viewWindow.rightModelViewer,this.viewWindow.leftModelViewer);}.bind(this),true);window.setTimeout(function(){this.viewWindow.containerFrameRightPanel.body.unmask();this.viewWindow.frameIsZooming="left";window.setTimeout(function(){var C=Ext.fly("rightIFrame");if(C){C.fadeIn({duration:1});}window.setTimeout(function(){if(this.viewWindow.firstLoadingRight===true){this.viewWindow.firstLoadingRight=false;this.viewWindow.nameTextBox.focus();}else{this.setFocusedElement();}}.bind(this),1300);}.bind(this),300);this.modelViewerIsZooming(this.viewWindow.leftModelViewer,this.viewWindow.rightModelViewer);this.viewWindow.frameIsZooming="";if(this.viewWindow.lastRightScroll!==undefined){var y=this.viewWindow.lastRightScroll.left;var B=this.viewWindow.lastRightScroll.top;var z=this.viewWindow.lastRightHeight;var f=this.viewWindow.lastRightWidth;var p=a.getModelViewer().getImgWidth();var x=a.getModelViewer().getImgHeight();var u=(y*p)/f;var m=(B*x)/z;var v=a.getModelViewer().getScrollboxEl();v.set("scrollLeft",u);v.set("scrollTop",m);v.lastScroll={left:v.get("scrollLeft"),top:v.get("scrollTop")};}if(this.viewWindow.firstLoadingLeft===true){this.setBestFitZoomLevelForModel(a);}else{if(!this.viewWindow.isSynchronScrolling){var s=this.viewWindow.lastRightZoomLevel;var h=this.viewWindow.lastRightMinZoomLevel;var g=this.getMinZoomLevelOfModelViewer(a.getModelViewer());var o=100;var n=100;var r=o-h;var q=n-g;var l=s-h;var t=(100/r*l)/100;var k=q*t;var A=g+k;if(typeof(A)==="number"&&isNaN(A)===false){a.getModelViewer().setZoomLevel(A);a._view.zoomslider.update();}}}}.bind(this),800);},setBestFitZoomLevelForModel:function(c){var b=this.facade.getCanvas().bounds.width();var d=this.facade.getCanvas().bounds.height();if(b>1800||d>2000){var a=c.getModelViewer();var f=this.getMinZoomLevelOfModelViewer(a);var e=50+f/2;if(typeof(e)==="number"&&isNaN(e)===false){a.setZoomLevel(e);c._view.zoomslider.update();}}},getHtmlElementShapePair:function(c){var a=this.viewWindow.htmlElementToPairCollection;for(var b in a){if(c==a[b].id){return a[b];}}},setValueAndStyleForACombobox:function(e,c,d,b,a){if(d){c.value=d;}this.setStyleOfCombobox(c,b,d||c.value);c.disabled=a;},hideElementsInViewAndSave:function(d,b){var a=this.getAllShapesToConsider(d);var c=b.definition.hide||[];a.each(function(e){if(e){c.push(e.resourceId);}}.bind(this));c=c.uniq();b.definition.hide=c;this.storeView(b);return b;},showElementsInViewAndSave:function(c,a){var b=a.definition.hide;c.each(function(e){if(e){var d=e.resourceId;if(b.indexOf(d)!==-1){b.remove(d);}}}.bind(this));b=b.uniq();a.definition.hide=b;this.storeView(a);return a;},modelWasSaved:function(){this.renderViewsOfModel();this.facadeSelectionChanged(this.facade.getSelection());},getAllViewsFromMeta:function(){var a=this.facade.getModelMetaData().views||[];return a;},setAllViewsFromMeta:function(a){this.facade.getModelMetaData().views=a;},viewCheckboxChanged:function(b,d){var a=this.facade.getSelection();if(a){var c=this.getAllViewsFromMeta();var e=new Signavio.Plugins.ViewsAttributeWindow.CheckboxChangeCommand(a,b.view,c,b,d,this.facade,this);this.facade.executeCommands([e]);}},storeView:function(a){var c=this.getAllViewsFromMeta();var b=[];c.each(function(d){if(a.name===d.name){b.push(a);}else{b.push(d);}}.bind(this));this.setAllViewsFromMeta(b);},disableAndUncheckAll:function(a){if(a){a.each(function(b){b.setValue(false);b.disable();b.show();if(b.triStateImage){Ext.fly(b.triStateImage).hide();}}.bind(this));}},enableAll:function(a){if(a){a.each(function(b){b.setValue(false);b.enable();}.bind(this));}},suspendEventsForAllCheckboxes:function(a){if(a){a.each(function(b){b.suspendEvents();}.bind(this));}},resumeEventsForAllCheckboxes:function(a){if(a){a.each(function(b){b.resumeEvents();}.bind(this));}},isShapeAnITSystem:function(a){var b=["ITSystem"];return(b.indexOf(a._stencil.idWithoutNs(a._stencil.idWithoutNs()))!==-1);},isShapeADataobject:function(a){var b=["DataObject","DataStore","Message"];return(b.indexOf(a._stencil.idWithoutNs(a._stencil.idWithoutNs()))!==-1);},isShapeARole:function(a){var b=["Pool","VerticalPool","CollapsedVerticalPool","CollapsedPool","processparticipant","Lane","VerticalLane"];return(b.indexOf(a._stencil.idWithoutNs(a._stencil.idWithoutNs()))!==-1);},isShapeAComment:function(a){var b=["TextAnnotation"];return(b.indexOf(a._stencil.idWithoutNs(a._stencil.idWithoutNs()))!==-1);},isShapeALane:function(a){var b=["Lane","VerticalLane"];return(b.indexOf(a.stencil.id)!==-1);},shapeIsPool:function(a){return(a._stencil.idWithoutNs()=="Pool"||a._stencil.idWithoutNs()=="VerticalPool");},isShapeVisibleInViewByLegend:function(b,a){return !((a.definition.hideRoles===true&&this.isShapeARole(b))||(a.definition.hideITSystems===true&&this.isShapeAnITSystem(b))||(a.definition.hideComments===true&&this.isShapeAComment(b))||(a.definition.hideData===true&&this.isShapeADataobject(b)));},isShapeVisibleInView:function(c,b){var g=false;var f=false;var d=false;var e=b.definition;var a=c.resourceId;if(a==="facade"||c.parent==undefined){return true;}if(e.hide&&e.hide.indexOf(a)!==-1){return false;}if(e.hideSingleRole&&e.hideSingleRole.indexOf(a)!==-1){return false;}if(this.isShapeVisibleInViewByLegend(c,b)===false){return false;}return this.isShapeVisibleInView(c.parent,b);},isShapeVisibleByParentAndLegend:function(c,b){var f=false;var e=false;var d=b.definition;var a=c.resourceId;if(a==="facade"||c.parent==undefined){return true;}if(this.isShapeVisibleInViewByLegend(c,b)===false){return false;}return this.isShapeVisibleInView(c.parent,b);},facadeSelectionChanged:function(a){var b=this.checkboxCollection;this.clearAllCheckboxes(b);if(a){this.suspendEventsForAllCheckboxes(b);if(a.length===0){this.disableAndUncheckAll(b);this.resumeEventsForAllCheckboxes(b);return;}else{this.enableAll(b);}b.each(function(g){var o=g.view;var d=o.definition.hide;var p=o.definition.hideSingleRole;var f=o.definition.collapse;var h=a.length;var m=false;var n=false;var l=a.length;a.each(function(r){var q=true;if(r){var s=this.isShapeVisibleInView(r,o);if(this.isShapeVisibleByParentAndLegend(r,o)===false){l--;}if(s===true){h--;}if(this.isShapeVisibleInView(r.parent,o)===false){m=true;}if(this.isShapeVisibleInViewByLegend(r,o)===false){n=true;}}}.bind(this));if(h===0){g.setValue(true);}if(h===a.length){g.setValue(false);}if(h>0&&h<a.length){g.hide();Ext.fly(g.triStateImage).show();var c=a.length-h;var e=h;var k=Signavio.I18N.ViewDefinition.viewToolTip4;k=k.replace("[verb1]",(c===1?Signavio.I18N.ViewDefinition.is:Signavio.I18N.ViewDefinition.are));k=k.replace("[count1]",c.toString());k=k.replace("[element1]",(c===1?Signavio.I18N.ViewDefinition.element:Signavio.I18N.ViewDefinition.elements));k=k.replace("[count2]",e.toString());k=k.replace("[element2]",(e===1?Signavio.I18N.ViewDefinition.element:Signavio.I18N.ViewDefinition.elements));new Ext.ToolTip({showDelay:50,html:k,target:g.triStateImage});Ext.QuickTips.init();}if(0===l){g.show();Ext.fly(g.triStateImage).hide();g.disable();this.addToolTipToCheckbox(g,m,n);}}.bind(this));}this.resumeEventsForAllCheckboxes(b);},clearAllCheckboxes:function(a){this.suspendEventsForAllCheckboxes(a);if(a){a.each(function(b){b.setValue(false);b.enable();if(b.imageLayer&&b.el){Ext.fly(b.el.id).parent().dom.removeChild(b.imageLayer);b.imageLayer=undefined;}if(b.triStateImage){Ext.fly(b.triStateImage).hide();}}.bind(this));}this.resumeEventsForAllCheckboxes(a);},addToolTipToCheckbox:function(e,d,c){if(!e||!e.el){return;}var a=document.createElement("img");a.src=Ext.BLANK_IMAGE_URL;a.setAttribute("class","ak-views-tooltip-layer");Ext.fly(e.el.id).parent().dom.appendChild(a);var b="";if(d===true&&c===false){b=Signavio.I18N.ViewDefinition.viewToolTip1;}if(d===false&&c===true){b=Signavio.I18N.ViewDefinition.viewToolTip2;}if(d===true&&c===true){b=Signavio.I18N.ViewDefinition.viewToolTip3;}if(b!==""){new Ext.ToolTip({showDelay:50,html:b,target:a});e.imageLayer=a;Ext.QuickTips.init();}},setViewDefinitionForModel:function(){var e=this.viewWindow.paramViewDefinition;var c=e.definition;var b=c.collapse||[];if(b){b.each(function(g){var f=this.getHtmlElementShapePair(g);if(f){this.setStyleOfCombobox(f.htmlElement,f.marker,this._comboboxStates.collapse);this.setStateForParentChilds(f.shape,false);}}.bind(this));}var a=c.hideSingleRole||[];if(a){a.each(function(f){var g=this.getHtmlElementShapePair(f);if(g){if(g.isCombobox===false){this.setStateOfCheckbox(g.htmlElement,g.marker,false,true,true,false);}else{this.setStyleOfCombobox(g.htmlElement,g.marker,this._comboboxStates.onlyContent);}}}.bind(this));}this.hideElements=c.hide||[];var d=c.hide||[];if(d){d.each(function(f){var k=this.getHtmlElementShapePair(f);if(k){if(k.isCombobox==false){var g=this.getParentPairForAPair(k);var h=this.getParentPoolForShape(k.shape);if(g===undefined&&h){g=this.getHtmlElementShapePair(h.resourceId);}if(g){if(g.isActive()){this.setStateOfCheckbox(k.htmlElement,k.marker,false,false,false,true);}else{this.setStateOfCheckbox(k.htmlElement,k.marker,false,true,true,true);}}else{this.setStateOfCheckbox(k.htmlElement,k.marker,false,false,false,true);}this.setStateForParentChilds(k.shape,false);}else{this.setStyleOfCombobox(k.htmlElement,k.marker,this._comboboxStates.closed);this.setStateForParentChilds(k.shape,false);}}}.bind(this));}if(c.hideComments===true){this.setStatusForShapesOfLegend(this.viewWindow.checkBComments,false);}if(c.hideITSystems===true){this.setStatusForShapesOfLegend(this.viewWindow.checkBIT,false);}if(c.hideData===true){this.setStatusForShapesOfLegend(this.viewWindow.checkBDataobjects,false);}if(c.hideRoles===true){this.setStatusForShapesOfLegend(this.viewWindow.checkBRoles,false);}this.viewWindow.containerFrameLeftPanel.body.unmask();window.setTimeout(function(){var f=Ext.fly("leftIFrame");if(f){f.fadeIn({duration:1});}}.bind(this),500);},setStateOfCheckbox:function(c,b,e,g,a,f){c.checked=e;c.disabled=a;var d=Ext.fly(Ext.fly(c).parent());if(e){d.removeClass("ak-checkbox-shadow-view-unchecked");d.addClass("ak-checkbox-shadow-view-checked");}else{d.removeClass("ak-checkbox-shadow-view-checked");d.addClass("ak-checkbox-shadow-view-unchecked");}if(f){b.setNodeClassName(["signavio-marker","ak-views-attribute-marker-transparent"].join(" "));}else{b.setNodeClassName(["signavio-marker"].join(" "));}if(g){d.addClass("ak-checkbox-shadow-view-checkbox-transparent");}else{d.removeClass("ak-checkbox-shadow-view-checkbox-transparent");}},setStyleOfCombobox:function(b,a,c){var d=Ext.fly(Ext.fly(b).parent());if(c===this._comboboxStates.opened){d.removeClass("ak-combox-shadow-view-inhalt-sichtbar");d.removeClass("ak-combox-shadow-view-unchecked");d.removeClass("ak-combox-shadow-view-zugeklappt");d.addClass("ak-combox-shadow-view-checked");a.setNodeClassName(["signavio-marker"].join(" "));b.value=this._comboboxStates.opened.toString();return;}if(c===this._comboboxStates.collapse){d.removeClass("ak-combox-shadow-view-inhalt-sichtbar");d.removeClass("ak-combox-shadow-view-unchecked");d.addClass("ak-combox-shadow-view-zugeklappt");d.removeClass("ak-combox-shadow-view-checked");a.setNodeClassName(["signavio-marker"].join(" "));b.value=this._comboboxStates.collapse.toString();return;}if(c===this._comboboxStates.onlyContent){Ext.fly(d).removeClass("ak-combox-shadow-view-unchecked");Ext.fly(d).removeClass("ak-combox-shadow-view-zugeklappt");Ext.fly(d).removeClass("ak-combox-shadow-view-checked");Ext.fly(d).addClass("ak-combox-shadow-view-inhalt-sichtbar");a.setNodeClassName(["signavio-marker"].join(" "));b.value=this._comboboxStates.onlyContent.toString();return;}if(c===this._comboboxStates.closed){Ext.fly(d).removeClass("ak-combox-shadow-view-inhalt-sichtbar");Ext.fly(d).addClass("ak-combox-shadow-view-unchecked");Ext.fly(d).removeClass("ak-combox-shadow-view-zugeklappt");Ext.fly(d).removeClass("ak-combox-shadow-view-checked");a.setNodeClassName(["signavio-marker","ak-views-attribute-marker-transparent"].join(" "));b.value=this._comboboxStates.closed.toString();return;}},getLegendCheckboxForAPair:function(c){var b=this.viewWindow.legend;var a=undefined;b.each(function(d){if(c.shape!==undefined){if(this.shapeHasTypeOf(c.shape,d.types)==true){a=d;throw $break;}}}.bind(this));return a;},getParentPoolForShape:function(b){var a=undefined;if(b.stencil.id=="Pool"||b.stencil.id=="VerticalPool"){return b;}if(b!==undefined){a=b.parentShape;if(a!==[]&&a!==undefined&&a!==null){if(a.stencil.id=="Pool"||a.stencil.id=="VerticalPool"){return a;}else{return this.getParentPoolForShape(a);}}}return a;},getParentPairForAPair:function(b){if(b!==undefined&&b.shape!==undefined){var a=b.shape.parentShape;if(a!==undefined){return this.getHtmlElementShapePair(a.resourceId);}return undefined;}return undefined;},setStatusForShapesOfLegend:function(g,f){var c=this.viewWindow.htmlElementToPairCollection;for(var e in c){var d=c[e];var m=this.getLegendCheckboxForAPair(d);var h=this.getParentPairForAPair(d);if(m!==undefined&&m.idCheckbox===g.idCheckbox){if(h!==undefined){var b=false;b=h.isActive();if(f&&b){if(this.isElementInHide(d.shape.resourceId)===true){this.setStateOfCheckbox(d.htmlElement,d.marker,false,false,false,true);this.setStateForParentChilds(d.shape,false);}else{this.setStateOfCheckbox(d.htmlElement,d.marker,true,false,false,false);this.setStateForParentChilds(d.shape,true);}}else{if(!b){if(f){if(h.shape.stencil.id.endsWith("Lane")){var k=this.getParentPoolForShape(h.shape);var l=this.getHtmlElementShapePair(k.resourceId);if(l){if(l.getPoolState()===this._comboboxStates.onlyContent){if(this.isElementInHide(d.shape.resourceId)===true){this.setStateOfCheckbox(d.htmlElement,d.marker,false,false,false,true);this.setStateForParentChilds(d.shape,false);}else{this.setStateOfCheckbox(d.htmlElement,d.marker,true,false,false,false);this.setStateForParentChilds(d.shape,true);}}else{this.setStateOfCheckbox(d.htmlElement,d.marker,false,true,true,true);}}else{this.setStateOfCheckbox(d.htmlElement,d.marker,false,true,true,true);}}else{this.setStateOfCheckbox(d.htmlElement,d.marker,false,true,true,true);}}else{this.setStateOfCheckbox(d.htmlElement,d.marker,false,true,true,true);}}else{this.setStateOfCheckbox(d.htmlElement,d.marker,false,true,true,true);}}}else{if(d.isCombobox===false){if(f){if(this.isElementInHide(d.shape.resourceId)===true){this.setStateOfCheckbox(d.htmlElement,d.marker,false,false,false,true);this.setStateForParentChilds(d.shape,false);}else{this.setStateOfCheckbox(d.htmlElement,d.marker,true,false,false,false);this.setStateForParentChilds(d.shape,true);}}else{this.setStateOfCheckbox(d.htmlElement,d.marker,f,!f,!f,!f);}}else{var a=this.getParentPoolForShape(d.shape);var l=this.getHtmlElementShapePair(a.resourceId);if(!f){d.htmlElement.oldValue=d.htmlElement.value;this.setValueAndStyleForACombobox(d.shape,d.htmlElement,this._comboboxStates.onlyContent,d.marker,true);}else{this.setValueAndStyleForACombobox(d.shape,d.htmlElement,d.htmlElement.oldValue,d.marker,!f);this.setStateForParentChilds(d.shape,true);}}}}}},setStateForParentChilds:function(c,e){var a=this.viewWindow.leftFrameFacade;var d=c.childShapes;for(var b in d){var h=a._findShape(d[b].resourceId);if(h){var f=this.getHtmlElementShapePair(h.resourceId);if(f){var g=this.getLegendCheckboxForAPair(f);if(g===undefined){if(e){this.setStateOfCheckbox(f.htmlElement,f.marker,true,false,false,false);if(this.isElementInHide(h.resourceId)===true){this.setStateOfCheckbox(f.htmlElement,f.marker,false,false,false,true);this.setStateForParentChilds(h,false);}else{this.setStateOfCheckbox(f.htmlElement,f.marker,true,false,false,false);this.setStateForParentChilds(h,true);}}else{this.setStateOfCheckbox(f.htmlElement,f.marker,false,true,true,true);this.setStateForParentChilds(h,false);}}else{if(e){if(g.getValue()==true){if(this.isElementInHide(h.resourceId)===true){this.setStateOfCheckbox(f.htmlElement,f.marker,false,false,false,true);this.setStateForParentChilds(h,false);}else{this.setStateOfCheckbox(f.htmlElement,f.marker,true,false,false,false);this.setStateForParentChilds(h,true);}}}else{this.setStateOfCheckbox(f.htmlElement,f.marker,false,true,true,true);this.setStateForParentChilds(h,false);}}}else{this.setStateForParentChilds(h,e);}}}},disableElementsByOnlyContent:function(d){var b=this.viewWindow.leftFrameFacade;var e=d.childShapes;for(var c in e){var h=b._findShape(e[c].resourceId);if(h){var f=this.getHtmlElementShapePair(h.resourceId);if(!f){this.disableElementsByOnlyContent(h);}else{if(f.shape.stencil.id=="Lane"||f.shape.stencil.id=="VerticalLane"){this.setStateOfCheckbox(f.htmlElement,f.marker,false,true,true,false);}else{if(this.isElementInHide(h.resourceId)===false){var g=this.getLegendCheckboxForAPair(f);if(g===undefined){var a=this.getParentPairForAPair(f);if(a){if(a.shape.stencil.id.endsWith("Lane")){if(this.isElementInHide(d.resourceId)===true){this.setStateOfCheckbox(f.htmlElement,f.marker,false,true,true,true);}else{this.setStateOfCheckbox(f.htmlElement,f.marker,true,false,false,false);}}else{if(a.isActive()===true){this.setStateOfCheckbox(f.htmlElement,f.marker,true,false,false,false);}else{this.setStateOfCheckbox(f.htmlElement,f.marker,false,true,true,false);}}}else{this.setStateOfCheckbox(f.htmlElement,f.marker,true,false,false,false);}}else{if(g.getValue()==true){var a=this.getParentPairForAPair(f);if(a){if(a.shape.stencil.id.endsWith("Lane")===false){if(a.isActive()===true){this.setStateOfCheckbox(f.htmlElement,f.marker,true,false,false,false);}else{this.setStateOfCheckbox(f.htmlElement,f.marker,false,true,true,false);}}else{this.setStateOfCheckbox(f.htmlElement,f.marker,true,false,false,false);}}else{this.setStateOfCheckbox(f.htmlElement,f.marker,true,false,false,false);}}else{this.setStateOfCheckbox(f.htmlElement,f.marker,false,true,true,false);}}}else{this.setStateOfCheckbox(f.htmlElement,f.marker,false,false,false,true);}}this.disableElementsByOnlyContent(f.shape);}}}},addElementToHide:function(a){this.hideElements.push(a);},isElementInHide:function(a){return(this.hideElements.indexOf(a)!==-1);},removeElementToHide:function(a){this.hideElements.remove(a);},shapeCheckboxClicked:function(d,b,a){if(d!==undefined&&b!==undefined&&a!==undefined){if(this.timeOutID!==undefined){window.clearTimeout(this.timeOutID);}var c=d.checked;if(c===true){this.removeElementToHide(b.resourceId);}else{this.addElementToHide(b.resourceId);}this.setStateOfCheckbox(d,a,c,false,false,!c);this.setStateForParentChilds(b,c);this.timeOutID=window.setTimeout(function(){this.timeOutID=undefined;this.refreshRightSide();}.bind(this),1200);}},shapeComboboxClicked:function(b,c,a){if(b!==undefined&&c!==undefined&&a!==undefined){if(this.timeOutID!==undefined){window.clearTimeout(this.timeOutID);}var d=Ext.fly(b).getValue();this.setStyleOfCombobox(b,a,d);var e=this.getHtmlElementShapePair(c.resourceId);if(e){if(d!==this._comboboxStates.onlyContent){this.setStateForParentChilds(c,e.isActive());}else{this.disableElementsByOnlyContent(c);}if(d===this._comboboxStates.onlyContent){this.removeElementToHide(c.resourceId);}if(d===this._comboboxStates.opened){this.removeElementToHide(c.resourceId);}if(d===this._comboboxStates.collapse){this.removeElementToHide(c.resourceId);}if(d===this._comboboxStates.closed){this.addElementToHide(c.resourceId);}}this.timeOutID=window.setTimeout(function(){this.timeOutID=undefined;this.refreshRightSide();}.bind(this),1500);}},legendCheckboxWasChecked:function(a,b){if(this.viewWindow.leftFrameFacade!==undefined){if(a.types!==undefined){if(this.timeOutID!==undefined){window.clearTimeout(this.timeOutID);}this.setStatusForShapesOfLegend(a,b);this.timeOutID=window.setTimeout(function(){this.timeOutID=undefined;this.refreshRightSide();}.bind(this),1100);}}},hasLaneSiblings:function(a){var d=a.parentShape;var b=0;var e=d.childShapes;for(var c in e){var f=e[c];if(f.stencil.id.endsWith("Lane")&&f.resourceId!==a.resourceId){return true;}}return false;},renderMarkersForShapesInLeftFrame:function(h,d){if(d!=undefined){var g=d._view.modelviewer.canvas.getNodes();var b=[];for(var e in g){var c=d._findShape(g[e].resourceId);if(c){b.push(c);}}var f=["signavio-marker"];var a=[];b.each(function(q){if(q!==undefined){var k;var l;var p=false;var n=false;if(q.stencil.id.endsWith("Lane")){n=!this.hasLaneSiblings(q);}if(!n){var o=new h.MOVI.util.Marker(q);o.setNodeClassName(f.join(" "));if(q.stencil.id!=="Pool"&&q.stencil.id!=="VerticalPool"){l=document.createElement("input");l.setAttribute("type","checkbox");l.setAttribute("class","ak-htmlElement-checkbox-margin-view");$(l).setStyle({margin:"0px !important"});l.checked=true;Ext.fly(l).on("click",function(){this.shapeCheckboxClicked(l,q,o);}.bind(this));if(q.stencil.id==="Lane"){k="northwest";}else{if(q.stencil.id==="TextAnnotation"){k="northwest";}else{k="northeast";}}}if(q.stencil.id==="Pool"||q.stencil.id==="VerticalPool"){l=document.createElement("select");var x=document.createElement("option");x.value=this._comboboxStates.opened;x.appendChild(document.createTextNode(this._comboboxStates.opened));l.appendChild(x);var v=document.createElement("option");v.value=this._comboboxStates.collapse;v.appendChild(document.createTextNode(this._comboboxStates.collapse));l.appendChild(v);var u=document.createElement("option");u.value=this._comboboxStates.onlyContent;u.appendChild(document.createTextNode(this._comboboxStates.onlyContent));l.appendChild(u);var t=document.createElement("option");t.value=this._comboboxStates.closed;t.appendChild(document.createTextNode(this._comboboxStates.closed));l.appendChild(t);$(l).setStyle({margin:"0px !important"});Ext.fly(l).on("change",function(){this.shapeComboboxClicked(l,q,o);}.bind(this));k="south";p=true;}var s=document.createElement("div");s.appendChild(l);o.addIcon(k,s);if(p){Ext.fly(s).addClass("ak-combox-shadow-view-checked");Ext.fly(s).addClass("ak-combobox-size-view-div");}else{Ext.fly(s).addClass("ak-checkbox-shadow-view-checked");Ext.fly(s).addClass("ak-checkbox-div-view");}if(q.stencil.id==="Lane"){Ext.fly(s).addClass("ak-checkbox-view-lane");}if(q.stencil.id==="VerticalLane"){Ext.fly(s).addClass("ak-checkbox-view-verticallane");}if(q.stencil.id==="TextAnnotation"){Ext.fly(s).addClass("ak-checkbox-view-textannotation");}var m={};m.isCombobox=p;m.shape=q;m.id=q.resourceId;m.htmlElement=l;m.marker=o;m.parentHtmlElement=s;var r=this;m.isActive=function(){if(this.isCombobox==false){return this.htmlElement.checked;}else{return(Ext.fly(this.htmlElement).getValue()===Signavio.I18N.ViewDefinition.comboboxStateOpened);}return false;};m.getPoolState=function(){if(this.isCombobox==false){return undefined;}else{return Ext.fly(this.htmlElement).getValue();}};a.push(m);}}}.bind(this));this.viewWindow.htmlElementToPairCollection=a;}},getBrowserVersionClass:function(){if(Ext.isGecko===true){return"view-gecko";}if(Ext.isChrome===true||Ext.isSafari2===true||Ext.isSafari===true){return"view-webkit";}if(Ext.isOpera===true){return"view-opera";}if(Ext.isIE9===true){return"view-IE9";}return"";},getPreviewHtmlForIFrame:function(c,f){var d=Ext.isIPad?"x-ipad":"";var b="body, .x-wrapper, .movi-scrollbox { width: 100%; height: 100% !important; padding: 0; margin: 0; } a {display: none !important;}"+this.getCssStyleForMashup();var a="<html><head><style>"+(b)+"</style><title></title>";a+='<script type="text/javascript">'+"\n";a+="var SignavioConfig = {"+"\n";a+="json: "+Object.toJSON(c)+",\n";a+="view:"+f+",\n";a+="element:'model'"+",\n";a+="zoomSlider: true"+",\n";a+="overflowX: 'fit' "+",\n";a+="overflowY: 'fit' "+"\n";a+="}"+"\n<\/script>";a+="</head>";a+='<body class="'+this.getBrowserVersionClass()+" ak-views-zoom-margin "+d+' ">';var e='<body class="'+this.getBrowserVersionClass()+" ak-views-zoom-margin "+d+' ">';a+='<script type="text/javascript" src="'+(this.getServer())+'/mashup/signavio.js"><\/script>'+"\n";a+='<div id="model" style="width: 100%; height: 100%">';a+="</div></body></html>";return a;},getCssStyleForMashup:function(){return".ak-views-attribute-marker-transparent {"+"background-color: white !important; "+"opacity: 0.55; "+"} "+".ak-checkbox-shadow-view-checkbox-transparent{ "+"	opacity: 0.55; "+"} "+".ak-checkbox-shadow-view-checked{ "+"	box-shadow: 0 0 4px 1px silver; "+"	-moz-box-shadow: 0 0 4px 1px silver;	"+"	-webkit-box-shadow: 0 0 4px 1px silver; "+"	border: 2px solid #8BC10D; "+"	border-radius: 2px;	 "+"	-webkit-border-radius: 2px;	"+"	-moz-border-radius: 2px; "+"}"+".ak-checkbox-shadow-view-unchecked{"+"	box-shadow: 0 0 4px 1px silver;"+"	-moz-box-shadow: 0 0 4px 1px silver;	"+"	-webkit-box-shadow: 0 0 4px 1px silver;"+"	border: 2px solid #EC0008;"+"	border-radius: 2px;	"+"	-webkit-border-radius: 2px;	"+"	-moz-border-radius: 2px;	"+"}"+".ak-combox-shadow-view-checked{"+"	box-shadow: 0 0 4px 1px silver;"+"	-moz-box-shadow: 0 0 4px 1px silver;	"+"	-webkit-box-shadow: 0 0 4px 1px silver;"+"	border: 2px solid #8BC10D;"+"	border-radius: 2px;	"+"	-webkit-border-radius: 2px;	"+"	-moz-border-radius: 2px;"+"}"+".ak-combox-shadow-view-zugeklappt{"+"	box-shadow: 0 0 4px 1px silver;"+"	-moz-box-shadow: 0 0 4px 1px silver;	"+"	-webkit-box-shadow: 0 0 4px 1px silver;"+"	border: 2px solid #FFAA00;"+"	border-radius: 2px;	"+"	-webkit-border-radius: 2px;	"+"	-moz-border-radius: 2px;"+"}"+".ak-combox-shadow-view-inhalt-sichtbar{ "+"	box-shadow: 0 0 4px 1px silver; "+"	-moz-box-shadow: 0 0 4px 1px silver; "+"	-webkit-box-shadow: 0 0 4px 1px silver; "+"	border: 2px solid rgb(245,177,201); "+"	border-radius: 2px;	"+"	-webkit-border-radius: 2px;	"+"	-moz-border-radius: 2px; "+"} "+".ak-checkbox-view-lane{ "+"	margin-top: 18px !important; "+"	margin-left: 18px !important;	"+"}"+" .view-IE9 div.ak-checkbox-view-lane{ "+"	margin-top: 18px !important; "+"	margin-left: 18px !important;	"+"}"+".ak-checkbox-view-verticallane{ "+"	margin-top: 18px !important; "+"	margin-left: -22px !important;	"+"}"+".ak-checkbox-view-textannotation{ "+"	margin-top: 0px !important; "+"	margin-left: 0px !important;	"+"}"+".ak-views-zoom-margin .signavio-zoom{ "+"	margin-top: 20px !important;	"+"}"+".ak.views-zoom-margin .movi-zoomslider-vertical{ "+"	cursor: n-resize !important;	"+"}"+".ak.views-zoom-margin .movi-zoomslider-thumb{ "+"	cursor: n-resize !important;	"+"}"+".ak-combox-shadow-view-unchecked{ "+"	box-shadow: 0 0 4px 1px silver; "+"	-moz-box-shadow: 0 0 4px 1px silver;	"+"	-webkit-box-shadow: 0 0 4px 1px silver; "+"	border: 2px solid #EC0008; "+"	border-radius: 2px;	 "+"	-webkit-border-radius: 2px;	"+"	-moz-border-radius: 2px;	"+"}"+".ak-combobox-div-view{ "+"	height: 13px; "+"	width: 13px;	"+"} "+".ak-htmlElement-checkbox-margin-view{"+"	margin: 0px !important;	"+"}"+".view-IE9 .ak-htmlElement-checkbox-margin-view{"+"	margin-top: -3px !important;	"+"	margin-left: -3px !important;	"+"	margin-right: -3px !important;	"+"	margin-bottom: -3px !important;	"+"}"+".ak-checkbox-div-view{"+"	height: 13px;"+"	width: 13px;	"+"}"+".x-ipad .ak-checkbox-div-view{"+"	height: 16px !important;"+"	width: 16px !important;"+"}"+".view-IE9 .ak-combobox-size-view-div{ "+"	height: 19px ; "+"} "+".ak-combobox-size-view-div{ "+"	height: 20px ; "+"} "+".view-IE9 .ak-checkbox-div-view{ "+"	margin: 0 0 0 0 !important; "+"	padding:0 0 0 0 !important; "+"} "+".view-webkit .ak-combobox-size-view-div{ "+"	margin: 0 0 0 0 !important; "+"	padding:0 0 0 0 !important; "+"} "+".view-opera .ak-combox-shadow-view-checked{ "+"	border:1px solid #8BC10D; "+"}"+".x-ipad .signavio-zoom {"+"background: none repeat scroll 0 0 transparent;"+"height: 45px;"+"left: 0px;"+"}"+".x-ipad .signavio-zoom-in {"+"background: url('/portal/src/img/slider-track-vert.png') no-repeat scroll 10px 10px transparent;"+"height: 32px;"+"left: 0;"+"position: absolute;"+"top: -10px;   "+" width: 42px;"+"}"+".x-ipad .signavio-zoomslider {"+"display: none;"+"}"+".x-ipad .movi-zoomslider-thumb {"+"background-image: url('/portal/src/img/s.gif') !important;"+"}"+".x-ipad .signavio-zoom-out {"+"background: url('/portal/src/img/slider-track-vert.png') no-repeat scroll 10px -123px transparent;"+"bottom: -10px;"+"height: 32px;"+"left: 0;"+"position: absolute;  "+"width: 42px;"+"}";},getServer:function(){return window.location.protocol+"//"+window.location.host;},getAllShapesToConsider:function(b){var a=[],f=b;var d=[];var c=this.facade.getCanvas(),g=this.facade.getRules();b.each(function(h){var l=b.any(function(m){return m.hasChildShape(h);});if(l){return;}a.push(h);if(h instanceof ORYX.Core.Node){var k=h.getOutgoingNodes();k=k.findAll(function(m){return !b.include(m);});a=a.concat(k);}}.bind(this));var e=this.facade.getCanvas().getChildEdges().select(function(h){if(a.include(h)){return false;}if(f.include(h)){return true;}if(h.getAllDockedShapes().size()===0){return false;}return h.getAllDockedShapes().all(function(k){return false;});});a=[].concat(a,e).uniq();return a;}});Signavio.Plugins.ViewsAttributeWindow.CheckboxChangeCommand=ORYX.Core.Command.extend({construct:function(d,b,h,f,g,c,e){this.selection=d;this.view=b;this.checkbox=f;this.newValue=g;var a=[];h=h||[];h.each(function(k){a.push(k);}.bind(this));this.oldViews=a;this.facade=c;this.me=e;},execute:function(){if(this.facade.getSelection()!==this.selection){this.facade.setSelection(this.selection);}if(this.newValue===false){this.checkbox.view=this.me.hideElementsInViewAndSave(this.selection,this.view);}else{this.checkbox.view=this.me.showElementsInViewAndSave(this.selection,this.view);}},rollback:function(){this.facade.setSelection(this.selection);if(this.newValue===true){this.checkbox.view=this.me.hideElementsInViewAndSave(this.selection,this.view);this.checkbox.show();}else{this.checkbox.view=this.me.showElementsInViewAndSave(this.selection,this.view);this.checkbox.show();}}});Signavio.Plugins.ViewsAttributeWindow.RemoveCommand=ORYX.Core.Command.extend({construct:function(a,d,b,c){this.viewToDelete=a;this.oldViews=d;this.facade=b;this.me=c;},execute:function(){var b=this.oldViews;var a=[];b.each(function(c){if(c.name!==this.viewToDelete.name){a.push(c);}}.bind(this));this.me.setAllViewsFromMeta(a);this.me.renderViewsOfModel();this.me.panelInPropertyWindow.doLayout();},rollback:function(){this.me.setAllViewsFromMeta(this.oldViews);this.me.renderViewsOfModel();this.me.panelInPropertyWindow.doLayout();}});Signavio.Plugins.ViewsAttributeWindow.CreateCommand=ORYX.Core.Command.extend({construct:function(d,c,a,b){this.newView=d;this.oldViews=c;this.facade=a;this.me=b;},execute:function(){var a=[];this.oldViews.each(function(b){a.push(b);}.bind(this));a.push(this.newView);this.me.setAllViewsFromMeta(a);this.me.renderViewsOfModel();this.me.panelInPropertyWindow.doLayout();},rollback:function(){this.me.setAllViewsFromMeta(this.oldViews);this.me.renderViewsOfModel();this.me.panelInPropertyWindow.doLayout();}});Signavio.Plugins.ViewsAttributeWindow.ChangeCommand=ORYX.Core.Command.extend({construct:function(e,a,d,b,c){this.newView=e;this.oldViews=d;this.oldView=a;this.facade=b;this.me=c;},execute:function(){var b=this.oldView;var d=this.newView;var c=this.oldViews;var a=[];c.each(function(e){if(b.name===e.name){a.push(d);}else{a.push(e);}}.bind(this));this.me.setAllViewsFromMeta(a);this.me.renderViewsOfModel();this.me.panelInPropertyWindow.doLayout();},rollback:function(){this.me.setAllViewsFromMeta(this.oldViews);this.me.renderViewsOfModel();this.me.panelInPropertyWindow.doLayout();}});}();if(!Signavio){var Signavio={};}if(!Signavio.Plugins){Signavio.Plugins={};}new function(){Signavio.Plugins.MapExportEnableSignavioBrandingOption=ORYX.Plugins.AbstractPlugin.extend({enabled:true,construct:function(){arguments.callee.$.construct.apply(this,arguments);ORYX.CONFIG.SIGNAVIO_BRANDING_CONFIGURABEL=true;}});Signavio.Plugins.PDFExport={enabled:true,construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":ORYX.I18N.File.print,"functionality":this.exportPDF.bind(this),"group":ORYX.I18N.File.group,"icon":ORYX.PATH+"images/printer.png","description":ORYX.I18N.File.printDesc,"index":4,"minShape":0,"maxShape":0});},exportPDF:function(){var c,b,g,e=undefined;this.facade.getCanvas().getChildShapes(true).each(function(l){var n=l.absoluteBounds();var m=n.upperLeft();var k=n.lowerRight();if(c==undefined){c=m.x;g=m.y;b=k.x;e=k.y;}else{c=Math.min(c,m.x);g=Math.min(g,m.y);b=Math.max(b,k.x);e=Math.max(e,k.y);}});var f=(b-c>=e-g);var a=new Ext.data.SimpleStore({data:[[Signavio.I18N.PDFExport.fitToPage,Signavio.I18N.PDFExport.portrait,ORYX.CONFIG.EXPLORER_PATH+"/src/img/map/1page.vertical.png","FitToPage",false,0],[Signavio.I18N.PDFExport.clipAllSides,Signavio.I18N.PDFExport.portrait,ORYX.CONFIG.EXPLORER_PATH+"/src/img/map/4pages.vertical.png","MapClip",false,0],[Signavio.I18N.PDFExport.clipBottom,Signavio.I18N.PDFExport.landscape,ORYX.CONFIG.EXPLORER_PATH+"/src/img/map/2pages.ns.horizontal.png","OneSideClipNS",true,0],[Signavio.I18N.PDFExport.clipBottom,Signavio.I18N.PDFExport.portrait,ORYX.CONFIG.EXPLORER_PATH+"/src/img/map/2pages.ns.vertical.png","OneSideClipNS",false,0],[Signavio.I18N.PDFExport.fitToPage,Signavio.I18N.PDFExport.landscape,ORYX.CONFIG.EXPLORER_PATH+"/src/img/map/1page.horizontal.png","FitToPage",true,1],[Signavio.I18N.PDFExport.clipAllSides,Signavio.I18N.PDFExport.landscape,ORYX.CONFIG.EXPLORER_PATH+"/src/img/map/4pages.horizontal.png","MapClip",true,1],[Signavio.I18N.PDFExport.clipRight,Signavio.I18N.PDFExport.portrait,ORYX.CONFIG.EXPLORER_PATH+"/src/img/map/2pages.ew.vertical.png","OneSideClipEW",false,1],[Signavio.I18N.PDFExport.clipRight,Signavio.I18N.PDFExport.landscape,ORYX.CONFIG.EXPLORER_PATH+"/src/img/map/2pages.ew.horizontal.png","OneSideClipEW",true,1]],fields:["name","format","img","pageMode","landscape","index"]});a.sort("index",f?"DESC":"ASC");var h=new Ext.DataView({tpl:'<tpl for=".">'+'<div class="thumb-wrap">'+'<span class="thumb-title">{name}</span>'+'<span class="thumb-format">{format}</span>'+'<div class="thumb"><img src="{img}" title="{name}" /></div>'+"</div>"+'</tpl><div class="x-clear"></div>',itemSelector:"div.thumb-wrap",overClass:"x-view-over",store:a,style:"overflow:auto; padding:0px;",cls:"x-plugin-map-view",singleSelect:true,width:332,height:230,doSingleSelection:function(l,k,m){this.select(k,false);},afterRender:function(){Ext.DataView.prototype.afterRender.apply(this,arguments);this.select(0);},listeners:{containerclick:function(k,l){return false;}}});var d=new Ext.Window({resizable:false,minimizable:false,modal:true,width:345,title:Signavio.I18N.PDFExport.optionWindowTitle,bodyStyle:"background-color:white;",items:[new Ext.form.Label({style:"display:block;padding-bottom:10px;padding-left:7px;padding-right:5px;padding-top:5px;width:320px;",text:Signavio.I18N.PDFExport.offerTitleDesc}),h,new Ext.Panel({layout:"form",style:"padding-left:7px",cls:"x-form-map-export-branding",border:false,items:[{xtype:"checkbox",hideLabel:true,name:"showSignavioBranding",checked:this.facade.getModelMetaData().mode==="Enterprise",disabled:!ORYX.CONFIG.SIGNAVIO_BRANDING_CONFIGURABEL,boxLabel:Signavio.I18N.PDFExport.branding+" "+((!ORYX.CONFIG.SIGNAVIO_BRANDING_CONFIGURABEL)?' <img ext:qtip="'+Signavio.I18N.PDFExport.premiumOnly+'" src="/v5designer/explorer/src/img/famfamfam/information.png" style="margin-left: 2px; margin-top: -3px; position: relative; top: 4px;"/>':"")},{xtype:"checkbox",hideLabel:true,checked:false,boxLabel:Signavio.I18N.PDFExport.blackWhite},this.facade.getModelMetaData().mode==="Academic"?{xtype:"checkbox",hideLabel:true,checked:false,name:"isSketchy",boxLabel:Signavio.I18N.PDFExport.sketchy,visible:this.facade.getModelMetaData().mode==="Academic"}:null].compact()})],buttons:[{text:Signavio.I18N.PDFExport.buttonTitle,handler:function(){var l=h.getSelectedRecords()[0];var p=this.facade.getCanvas().getSVGRepresentation(true);if(this.facade.getCanvas().properties["oryx-showstripableelements"]!==true){var o=Element.getElementsByClassName(p,"stripable-element");for(var m=o.length-1;m>=0;m--){o[m].parentNode.removeChild(o[m]);}}var o=Element.getElementsByClassName(p,"stripable-element-force");for(var m=o.length-1;m>=0;m--){o[m].parentNode.removeChild(o[m]);}var n=DataManager.serialize(p);var k=d.items.get(2);this.sendRequest({landscape:l.get("landscape"),pageMode:l.get("pageMode"),filename:this.facade.getModelMetaData().name||"",title:this.facade.getModelMetaData().name||"",svg_xml:n,showSignavioBranding:!k.items.get(0).getValue(),blackWhite:k.items.get(1)?k.items.get(1).getValue():false,isSketchy:k.items.get(2)?k.items.get(2).getValue():false,scale:1.4});d.close();}.bind(this)},{text:Signavio.I18N.PDFExport.closeTitle,handler:function(){d.close();}}]});d.show();},sendRequest:function(e,h){var c=/[\/\\\*><\|]/g;e.filename=e.filename.replace(c," ");Ext.apply(e,Ext.Ajax.getSecurityParameter());var d=window.location.protocol+"//"+window.location.host+window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/"))+ORYX.CONFIG.DIAGRAM_PRINTER_URL+"/"+encodeURI(e.filename)+".pdf";var b=window.open();var a=[];$H(e).each(function(k){if(k.value instanceof Array){k.value.each(function(l){a.push(["input",{type:"hidden",value:l,name:k.key}]);});}else{a.push(["input",{type:"hidden",value:k.value,name:k.key}]);}});var g=b.document;var f=g.createElement("form");f.setAttribute("action",d);f.setAttribute("method","POST");f.setAttribute("accept-charset","utf-8");f.setAttribute("enctype","application/x-www-form-urlencoded");$H(e).each(function(l){var k=g.createElement("input");k.setAttribute("type","hidden");k.setAttribute("name",l.key);k.setAttribute("value",l.value);f.appendChild(k);});b.document.body.appendChild(f);f.submit();}};Signavio.Plugins.PDFExport=ORYX.Plugins.AbstractPlugin.extend(Signavio.Plugins.PDFExport);}();if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.SimplePrint=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.File.print,"functionality":this.exportPDF.bind(this),"group":ORYX.I18N.File.group,"icon":ORYX.PATH+"images/printer.png","description":ORYX.I18N.File.printDesc,"index":4,"minShape":0,"maxShape":0});},exportPDF:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.File.genPDF});var g=location.href;var f=this.facade.getCanvas().getSVGRepresentation(true);var e=DataManager.serialize(f);var h=this.facade.getModelMetaData().name||"diagram";var b=window.open();var a=[];var c=window.location.protocol+"//"+window.location.host+ORYX.CONFIG.PDF_EXPORT_URL;a.push(["input",{type:"hidden",value:e,name:"data"}]);a.push(["input",{type:"hidden",value:h,name:"name"}]);$H(Ext.Ajax.getSecurityParameter()).each(function(k){if(k.value instanceof Array){k.value.each(function(l){a.push(["input",{type:"hidden",value:l,name:k.key}]);});}else{a.push(["input",{type:"hidden",value:k.value,name:k.key}]);}});var d=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",b.document.body,["form",{action:c,method:"POST"}].concat(a));d.submit();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}});if(!ORYX){var ORYX={};}if(!ORYX.Plugins){ORYX.Plugins={};}(function(){ORYX.Plugins.UML=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent("layout.uml.class",this.handleLayoutClass.bind(this));this.facade.registerOnEvent("layout.uml.complexClass",this.handleLayoutComplexClass.bind(this));this.facade.registerOnEvent("layout.uml.list",this.handleLayoutList.bind(this));this.facade.registerOnEvent("layout.uml.association",this.handleLayoutAssociation.bind(this));this.facade.registerOnEvent("layout.uml.qualified_association",this.handleLayoutQualifiedAssociation.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.addReadingDirectionOnLoad.bind(this));},addReadingDirectionOnLoad:function(a){this.facade.getCanvas().edges.each(function(b){if(b.properties["oryx-direction"]=="left"||b.properties["oryx-direction"]=="right"){this.addReadingDirection(b);}}.bind(this));},calculateLabelHeight:function(b,c){var d=b.getFontSize();var a=b.node.childNodes.length;try{return Math.max(b.node.getBBox().height,1*d+0.75);}catch(f){if(a){return a*d+0.75;}else{return 1*d+0.75;}}},calculateLabelWidth:function(a,b){try{return Math.max(a.node.getBBox().width+5,40);}catch(c){return 40;}},handlePropertyChanged:function(a){if(a.name=="oryx-name"||a.name=="oryx-direction"){this.addReadingDirection(a.elements[0]);}},setClassAbstract:function(a,c){c=(c===true||c==="true");var b=this.getLabel(a,"name");b.node.setAttribute("font-style",c?"italic":"normal");},handleLayoutClass:function(b){var a=b.shape;this.setClassAbstract(a,a.properties["oryx-abstract"]);},getLabel:function(a,b){return a.getLabels().find(function(c){return c.id===(a.id+b);});},getSVGElement:function(a,b){return a._svgShapes.find(function(c){return c.element.id===(a.id+b);}).element;},moveLine:function(a,b){a.setAttribute("y1",b);a.setAttribute("y2",b);},getClassLabels:function(a){return{name:this.getLabel(a,"name"),attributes:this.getLabel(a,"attributes"),stereotype:this.getLabel(a,"keyword"),methods:this.getLabel(a,"methods")};},getClassHeights:function(a,b){return{name:this.calculateLabelHeight(b.name,a.properties["oryx-name"]),attributes:this.calculateLabelHeight(b.attributes,a.properties["oryx-attributes"]),methods:this.calculateLabelHeight(b.methods,a.properties["oryx-methods"])};},handleLayoutComplexClass:function(b){var g=b.shape;this.setClassAbstract(g,g.properties["oryx-abstract"]);if(g.getLabels().any(function(n){return n.isUpdating();})){return;}var d=this.getClassLabels(g);var h=this.getClassHeights(g,d);if(g.properties["oryx-keyword"]){d.stereotype.text("<<"+g.properties["oryx-keyword"]+">>");d.stereotype.update();}var c=this.getSVGElement(g,"separator");var m=this.getSVGElement(g,"upperseparator");var l=14;var e=22;var f=44;var k=e+h.attributes+2;var a=k+h.methods+1;if(d.name.node.childNodes.length>1){l=h.name+7;e+=h.name;f+=h.name;k+=h.name;a+=h.name;}if(g.properties["oryx-keyword"]){l+=10;e+=10;f+=10;k+=10;a+=10;}d.name.setY(l);this.moveLine(m,e-2);this.moveLine(c,k);d.attributes.setY(e);d.methods.setY(k+3);if(g.bounds.height()!==a+5&&!this.updating){this.updating=true;g.bounds.set(g.bounds.upperLeft(),{x:g.bounds.b.x,y:g.bounds.a.y+a+5});this.facade.getCanvas().update();this.facade.updateSelection();delete this.updating;}},handleLayoutList:function(b){var h=b.shape;if(h.getLabels().any(function(n){return n.isUpdating();})){return;}var m=h.properties["oryx-name"];var d=h.properties["oryx-items"];var c=this.getLabel(h,"name");var k=this.getLabel(h,"items");var f=this.getSVGElement(h,"separator");var e=this.calculateLabelHeight(c,m);var l=this.calculateLabelHeight(k,d);var g=32;this.moveLine(f,30);if(c.node.childNodes.length>1){this.moveLine(f,14+e);g=16+e;}var a=g+l+3;k.setY(g+3);if(h.bounds.height()!==a+5){h.bounds.set(h.bounds.upperLeft(),{x:h.bounds.b.x,y:h.bounds.a.y+a+5});this.facade.getCanvas().update();this.facade.updateSelection();}},handleLayoutAssociation:function(a){this.addReadingDirection(a.shape);},addReadingDirection:function(b){var c=this.getLabel(b,"name");var a=b.properties["oryx-name"];if(c.text().split("< ").last()!=""||c.text().split(" >").first()!=""){switch(b.properties["oryx-direction"]){case"left":c.text("< "+a);break;case"right":c.text(a+" >");break;default:c.text(a);}}},handleLayoutQualifiedAssociation:function(e){var a=e.shape;var d=this.getLabel(a,"qualifier");var c=a.properties["oryx-qualifier"];var b=this.calculateLabelWidth(d,c);a._markers.values()[0].element.lastElementChild.setAttributeNS(null,"width",b);a._markers.values()[0].element.setAttributeNS(null,"markerWidth",b);this.facade.getCanvas().update();}});}());if("undefined"==typeof ORYX){var ORYX={};}if("undefined"==typeof ORYX.Plugins){ORYX.Plugins={};}new function(){ORYX.Plugins.UMLUseCase=Clazz.extend({construct:function(a){this.facade=a;this.facade.registerOnEvent("layout.uml.useCaseExtended",this.handleUseCaseExtendedLayout.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.handleDiagramOnLoad.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));},handleDiagramOnLoad:function(a){this.layoutAllSystems(this.facade.getCanvas());},layoutAllSystems:function(b){this.layoutAllUseCaseExtended(b);var a=b.getChildNodes().findAll(function(c){if(this.isSystemNode(c)){return c;}}.bind(this));a.each(function(c){this.layoutStereotype(c);this.layoutAllSystems(c);}.bind(this));},layoutAllUseCaseExtended:function(a){var b=a.getChildNodes().findAll(function(c){if(this.isUseCaseExtendedNode(c)){return c;}}.bind(this));b.each(function(c){this.layoutUseCaseExtended(c);}.bind(this));},handleUseCaseExtendedLayout:function(b){var a=b.shape;if(a.isResized){this.SelectionEventFunction=this.handleUseCaseExtendedSelection.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.SelectionEventFunction);}},handleUseCaseExtendedSelection:function(b){var a=b.elements.first();if(!this.isUseCaseExtendedNode(a)){return;}this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.SelectionEventFunction);this.layoutUseCaseExtended(a);},layoutUseCaseExtended:function(e){var d=e._svgShapes.find(function(f){return f.element.id==(e.id+"extension_point_text_frame");}).element;var c=e.getLabels().find(function(f){return f.id==(e.id+"extensions");});var b=e.getLabels().find(function(f){return f.id==(e.id+"extensionpoint");});var a=d.y.baseVal.value-b.y-16;d.y.baseVal.value=b.y+16;c.y=b.y+16;d.height.baseVal.value+=a;},handlePropertyChanged:function(b){var a=b.elements.first();if(!this.isSystemNode(a)){return;}if(!(this.isStereotypeKeyEvent(b)||this.isNameKeyEvent(b))){return;}this.layoutStereotype(a);},layoutStereotype:function(c){var a=c.getLabels().find(function(d){return d.id==(c.id+"stereotype");});var b=c.getLabels().find(function(d){return d.id==(c.id+"text");});if(a.text().empty()){b.y=a.y;a.hide();}else{b.y=a.y+14;a.show();a.text("aa"+c.properties["oryx-stereotype"]+"a?");}b.update();a.update();},isUseCaseExtendedNode:function(a){return"http://b3mn.org/stencilset/umlusecase#usecaseextended"==a.getStencil().id().toLowerCase();},isUseCaseNode:function(a){return"http://b3mn.org/stencilset/umlusecase#usecase"==a.getStencil().id().toLowerCase();},isSystemNode:function(a){return"http://b3mn.org/stencilset/umlusecase#system"==a.getStencil().id().toLowerCase();},isIncludeEdge:function(a){return"http://b3mn.org/stencilset/umlusecase#include"==a.getStencil().id().toLowerCase();},isExtendEdge:function(a){return"http://b3mn.org/stencilset/umlusecase#extend"==a.getStencil().id().toLowerCase();},isStereotypeKeyEvent:function(a){return a["key"]=="oryx-stereotype";},isNameKeyEvent:function(a){return a["key"]=="oryx-name";}});}();if(!Signavio){var Signavio=new Object();}if(!Signavio.Plugins){Signavio.Plugins=new Object();}(function(){var e={"http://b3mn.org/stencilset/bpmn2.0#":["gContainer","#Subprocess@name","#EventSubprocess@name","GatewaysMorph","Message","StartEventsMorph","IntermediateEventsMorph","EndEventsMorph","ITSystem","DataStore","Group","processparticipant","wmBorder"],"http://b3mn.org/stencilset/bpmn2.0choreography#":["ChoreographySubprocessExpanded","#Subprocess","GatewaysMorph","Message","StartEventsMorph","IntermediateEventsMorph","EndEventsMorph","ITSystem","wmBorder"],"http://b3mn.org/stencilset/epc#":["gContainer","@frequency","@time","wmBorder","Letter","Phone","Mail@title","Fax"],"http://b3mn.org/stencilset/bpmn2.0conversation#":["Communication","SubConversation"],"http://b3mn.org/stencilset/timjpdl3#":["GatewaysMorph","StartEventsMorph","EndEventsMorph","IntermediateEventMorph"],"http://www.signavio.com/stencilsets/processmap#":["gContainer","Group"],"http://www.signavio.com/stencilsets/organigram#":["gContainer"]};var c={"http://b3mn.org/stencilset/UML2.2Class#":["QualifiedAssociation@qualifier"]};var f=["Subprocess","EventSubprocess","ChoreographySubprocessExpanded","Group","wmBorder","gContainer"];var g={"GatewaysMorph":{x:14,y:16},"StartEventsMorph":{x:9,y:9},"IntermediateEventsMorph":{x:9,y:9},"EndEventsMorph":{x:9,y:9},"Event":{x:3,y:14},"Function":{x:3,y:9},"Communication":{x:8,y:12},"SubConversation":{x:8,y:12}};var b=function(h,k){this.x=(arguments.length===1&&arguments[0].x!==undefined?arguments[0].x:arguments[0])||0;this.y=(arguments.length===1&&arguments[0].y!==undefined?arguments[0].y:arguments[1])||0;};b.prototype.moveBy=function(){return new b(this.x+(arguments.length===1&&arguments[0].x!==undefined?arguments[0].x:arguments[0])||0,this.y+(arguments.length===1&&arguments[0].y!==undefined?arguments[0].y:arguments[1])||0);};b.prototype.castToInts=function(){return new b(Math.floor(this.x),Math.floor(this.y));};Signavio.Plugins.LabelPosition=ORYX.Plugins.AbstractPlugin.extend({construct:function(h){this.facade=h;this.frames=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOVER,this.onOver.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.onPropertyChanged.bind(this));}.bind(this));document.addEventListener("mousedown",function(){this.mouseDown=true;}.bind(this),true);document.addEventListener("mouseup",function(){delete this.mouseDown;}.bind(this),true);},onPropertyChanged:function(k){var h=(k.elements||[]).first();if(!(h instanceof ORYX.Core.Edge)){return;}window.setTimeout(function(){h.getLabels().each(function(l){if(!l.visible()){this.removeFrame(l);}else{this.addFrame(l,h);}}.bind(this));}.bind(this),200);},onOver:function(k,h){if(h instanceof ORYX.Core.Shape&&["text","tspan"].include(k.target.tagName.toLowerCase())&&!this.mouseDown){var l=k.target.tagName.toLowerCase()=="tspan"?k.target.parentNode:k.target;h.getLabels().each(function(m){if(m.node===l){var n=this.addFrame(m,h);if(n){n.onMouseOut=function(){if(!n.isDragging){this.removeFrames(this.selectedShape);}}.bind(this);}}}.bind(this));}},onSelectionChanged:function(){var k=this;if(this.facade.getSelection().length===1){if(this.facade.getSelection()[0]===this.selectedShape){return;}this.removeFrames(this.facade.getSelection()[0]);var h;this.selectedShape=h=this.facade.getSelection()[0];h.getLabels().each(function(l){k.addFrame(l,h);});}else{this.removeFrames();delete this.selectedShape;}},removeFrame:function(h){this.frames.each(function(k){if(h===k.label){k.destroy();throw $break;}});},removeFrames:function(h){this.frames=this.frames.findAll(function(k){if(!h||h!=k.shape){k.destroy();return false;}return true;});},addFrame:function(k,h){if(this.isBlacklisted(h,k)){return null;}if(k.visible()&&k.text()&&(h instanceof ORYX.Core.Edge||this.canReposition(k,h))){var l=this.frames.find(function(m){return m.label==k&&m.shape==h;});if(!l){l=new a(k,h,this.facade);this.frames.push(l);}return l;}return null;},isBlacklisted:function(k,l){var m=k.getStencil().namespace();var h=c[m];var n=false;(h||[]).each(function(o){var q=o.split("@")[0];var p=o.split("@")[1];q=m+q;p=p!==undefined?k.id+p:"";if(k.getStencil().id()===q){n=!p||p&&p===l.id;throw $break;}});return n;},canReposition:function(k,h){var l=h.getStencil().namespace();return(e[l]||[]).any(function(r){var q=h.getStencil().id().toLowerCase().endsWith(r.toLowerCase());var m=h.getStencil().roles().include(h.getStencil().namespace()+r);if(!q&&!m&&r.include("@")){var p=r.split("@")[0];var o=r.split("@")[1];if(p&&!h.getStencil().id().toLowerCase().endsWith(p.toLowerCase())){return false;}return h.getStencil().properties().any(function(n){return n.id()==o&&n.refToView().any(function(s){return h.getLabel(s)===k;});});}return q||m;});}});var d=Clazz.extend({construct:function(l,k,h){this.label=l;this.shape=k;this.position=h;this.calculate();},calculate:function(){var q=this.label,x=this.shape.dockers;var o,n;if(this.position.include("start")){o=x[0];n=x[1];}else{if(this.position.include("end")){o=x.last();n=x[x.length-2];}else{if(this.position.include("mid")){var r=Math.ceil(x.length/2)-1;o=x[r];n=x[r+1];}}}var l=o.bounds.center();var t=n.bounds.center();var k=ORYX.Core.Math.getIdentityVector(l,t);var m=ORYX.Core.Math.getOrthogonalIdentityVector(k);var h=this.shape._getAngle(o,n);if(!(h<=90||h>270)){m.x*=-1;m.y*=-1;}this.vector=k;this.orthogonalVector=m;var s=Object.clone(m);var u=q.getFontSize()-1;switch(this.position){case"midtop":if(x.length%2===0){var p=ORYX.Core.Math.getPointBetweenTwoPoints(l,t,0.5);s.x*=q.getOffsetTop()+(u/2);s.y*=q.getOffsetTop()+(u/2);s.x+=p.x;s.y+=p.y;break;}case"starttop":s.x*=q.getOffsetTop()+(u/2);s.y*=q.getOffsetTop()+(u/2);s.x+=k.x*q.getOffsetTop();s.y+=k.y*q.getOffsetTop();s.x+=l.x;s.y+=l.y;break;case"midbottom":if(x.length%2===0){var p=ORYX.Core.Math.getPointBetweenTwoPoints(l,t,0.5);s.x*=-q.getOffsetTop()-(u/2);s.y*=-q.getOffsetTop()-(u/2);s.x+=p.x;s.y+=p.y;break;}case"startbottom":s.x*=-q.getOffsetTop()-(u/2);s.y*=-q.getOffsetTop()-(u/2);s.x+=k.x*q.getOffsetTop();s.y+=k.y*q.getOffsetTop();s.x+=l.x;s.y+=l.y;break;case"endtop":s.x*=q.getOffsetTop()+(u/2);s.y*=q.getOffsetTop()+(u/2);s.x+=k.x*q.getOffsetTop();s.y+=k.y*q.getOffsetTop();s.x+=l.x;s.y+=l.y;break;case"endbottom":s.x*=-q.getOffsetTop()-(u/2);s.y*=-q.getOffsetTop()-(u/2);s.x+=k.x*q.getOffsetTop();s.y+=k.y*q.getOffsetTop();s.x+=l.x;s.y+=l.y;break;}this.firstdocker=o;this.seconddocker=n;this.angle=h;this.center=s;}});var a=Clazz.extend({offset:2,snapDistance:10,labelDistance:5,color_docked:"silver",color_snapped:"blue",color_undocked:"red",color_referenced:"green",onMouseOut:Ext.emptyFn,construct:function(k,h,l){this.label=k;this.shape=h;this.facade=l;this.nodes=[];this.init();},init:function(){this.initTimer=window.setTimeout(function(){if(this.label){this.setSize(this.label);}}.bind(this),1);this.getSVG().addEventListener("mousedown",this.startDragDrop.bind(this),true);this.updateLabelClb=this.onLabelUpdate.bind(this);this.label.registerOnChange(this.updateLabelClb);this.initOnMouseOut();},initOnMouseOut:function(){var k=this.label.node;var h=function(){this.onMouseTimer=window.setTimeout(function(){this.onMouseOut();}.bind(this),100);k.removeEventListener("mouseout",h,true);}.bind(this);k.addEventListener("mouseout",h,true);this.getSVG().addEventListener("mouseover",function(){window.clearTimeout(this.onMouseTimer);}.bind(this),true);this.getSVG().addEventListener("mouseout",function(){this.onMouseOut();}.bind(this),true);},getScale:function(){return this.facade.getCanvas().getZoom()||1;},getSVG:function(){if(!this.node){this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.label.node.parentNode,["g",{"pointer-events":"all","cursor":"move"}]);this.node.rect=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"d":"M 0 0","stroke-width":Math.max(0.2,(1/this.getScale())||1),"stroke-dasharray":"10, 2","shape-rendering":"crispEdges","stroke":this.color_docked,"stroke-opacity":"0.7","fill":"none"}]);this.nodes.push(this.node);if(this.shape instanceof ORYX.Core.Edge){this.generateEdgePositionReferencePoints();}}return this.node;},generateEdgePositionReferencePoints:function(){if(!this.node){return;}var m=$H({}),l=$H({}),k=this.label,h=this.shape;["starttop","startbottom","endtop","endbottom",k.getOriginEdgePosition()].uniq().each(function(n){l[n]=new d(k,h,n);});this.edgePositions=l;},onLabelUpdate:function(){window.clearTimeout(this.initTimer);this.setSize(this.label);this.labelOffset=this.positionToLabelPosition(new b(0,0));},getPathD:function(k,l){var m=4;return["M 0 0 L",k,"0 L",k,l-m,"L",k-m,l,"L 0",l,"Z"].join(" ");},setSize:function(){var q,o,k,s;switch(arguments.length){case 1:if(arguments[0] instanceof ORYX.Core.SVG.Label){var p=arguments[0];q=p.getX();o=p.getY();k=p.getWidth();s=p.getHeight();}break;case 4:q=arguments[0];o=arguments[1];k=arguments[2];s=arguments[3];break;}if(q===undefined||o===undefined||k===undefined||s===undefined){throw new Error("LabelFrame.setSize() in labelPosition.js invalid argument.");}var n=this.getSVG(),m="";if(this.label.getEdgePosition()){var u=this.label.getEdgePosition();var l=this.label.rotate();var t=this.shape.dockers,h;if(u.include("start")){h=t.first().bounds.center();}else{if(u.include("end")){h=t.last().bounds.center();}else{var r=Math.ceil(this.shape.dockers.length/2)-1;if(this.shape.dockers.length%2===0){h=ORYX.Core.Math.getPointBetweenTwoPoints(t[r].bounds.center(),t[r+1].bounds.center(),0.5);}else{h=t[r].bounds.center();}}}m=["rotate(",l,", ",h.x,", ",h.y,") "].join("");}q=q-this.offset-(k%2==0?1:0);o=o-this.offset;n.setAttribute("transform",[m,"translate(",Math.floor(q),", ",Math.floor(o),")"].join(""));k=Math.floor(k+(2*this.offset))+1;s=Math.floor(s+(2*this.offset));n.rect.setAttribute("d",this.getPathD(k,s));this.applyIndicator(this.label.position?0:(this.label.getReferencePoint()?3:1));this.setIntersectionPoint(this.label.getReferencePoint());},applyIndicator:function(h){return;},setIntersectionPoint:function(h){},setPositionOfNode:function(k,h){k.setAttributeNS(null,"x",Math.floor(h.x));k.setAttributeNS(null,"y",Math.floor(h.y));},positionToLabelPosition:function(k,l){if(!k){return null;}k=new b(k).moveBy(this.offset*2,this.offset*2);if(this.label){var h=0,m=0;switch(this.label[l?"getOriginHorizontalAlign":"horizontalAlign"]()){case"left":h-=this.offset;break;case"center":h+=Math.ceil(this.label.getWidth()/2)-(this.offset);break;case"right":h+=this.label.getWidth()-(this.offset);break;}switch(this.label[l?"getOriginVerticalAlign":"verticalAlign"]()){case"top":m-=this.offset;break;case"middle":m+=Math.ceil(this.label.getHeight()/2)-(this.offset);break;case"bottom":m+=this.label.getHeight()-(2*this.offset);break;}k=k.moveBy(h+(this.label.getWidth()%2==0?1:0),m);}return k.castToInts();},setLabelPosition:function(h){this.setPositionOfNode(this.label.node,h);for(var l=0,m=this.label.node.childNodes,k=m.length;l<k;++l){this.setPositionOfNode(m[l],h);}},startDragDrop:function(h){if(this.isDragging){return;}this.isDragging=true;ORYX.Core.SVGEnableDrag(h,this.getSVG(),{movedCallback:this.onDrag.bind(this),upCallback:this.onDragDrop.bind(this),adjustPosition:this.adjustPosition.bind(this)});this.labelOffset=this.positionToLabelPosition(new b(0,0));Ext.getBody().setStyle("cursor","move");this.initialState={position:this.label.getPosition(),edgePosition:this.label.getEdgePosition(),reference:this.label.getReferencePoint(),valign:this.label.verticalAlign(),halign:this.label.horizontalAlign()};this.initDragDrop=true;},getCornerDistance:function(h){if(!this.cornerDistance){var k=h.getStencil().roles().find(function(l){return g[l]||g[l.replace(h.getStencil().namespace(),"")];});this.cornerDistance=k?g[k]||g[k.replace(h.getStencil().namespace(),"")]:{x:0,y:0};}return this.cornerDistance;},adjustPositionAtNode:function(o,h){var q=this.labelOffset.moveBy(o);var m=this.positionToLabelPosition(o,true);var s=this.shape.bounds.midPoint();var t=this.shape.bounds.width();var n=this.shape.bounds.height();var l=this.label.getWidth()+(this.offset*2);var u=this.label.getHeight()+(this.offset*2);var k=this.getCornerDistance(this.shape);var p=this.shape;var v=f.any(function(x){return p.getStencil().id().toLowerCase().endsWith(x.toLowerCase())||p.getStencil().roles().include(p.getStencil().namespace()+x);});var r=!v;this.label.anchorLeft=this.label.anchorTop=false;this.label.anchorRight=this.label.anchorBottom=false;this.label.horizontalAlign("center");this.label.verticalAlign("middle");if(Math.abs(this.label.x-m.x)<this.snapDistance&&Math.abs(this.label.y-m.y)<this.snapDistance){o=new b(o).moveBy(this.label.x-m.x,this.label.y-m.y);this.applyIndicator(1);this.label.resetAnchorPosition();this.label.horizontalAlign(this.label.getOriginHorizontalAlign());this.label.verticalAlign(this.label.getOriginVerticalAlign());return o;}else{if(h.ctrlKey||h.metaKey){return o;}else{if(v&&Math.abs(o.x)<this.snapDistance&&Math.abs(o.y)<this.snapDistance){o={x:0,y:0};this.label.anchorLeft=this.label.anchorTop=true;this.label.horizontalAlign("left");this.label.verticalAlign("top");}else{if(v&&Math.abs(s.x-(o.x+(l/2)))<this.snapDistance&&Math.abs(o.y)<this.snapDistance){o={x:s.x-(l/2)-(2*this.offset)+1,y:0};this.label.anchorTop=true;this.label.horizontalAlign("center");this.label.verticalAlign("top");}else{if(v&&Math.abs(t-(o.x+(l)))<this.snapDistance&&Math.abs(o.y)<this.snapDistance){o={x:t-l-(4*this.offset)+1,y:0};this.label.anchorRight=this.label.anchorTop=true;this.label.horizontalAlign("right");this.label.verticalAlign("top");}else{if(v&&Math.abs(o.x)<this.snapDistance&&Math.abs(s.y-(o.y+(u/2)))<this.snapDistance){o={x:0,y:s.y-(u/2)-(2*this.offset)+1};this.label.anchorLeft=true;this.label.horizontalAlign("left");this.label.verticalAlign("middle");}else{if(v&&Math.abs(s.x-(o.x+(l/2)))<this.snapDistance&&Math.abs(s.y-(o.y+(u/2)))<this.snapDistance){o={x:s.x-(l/2)-(2*this.offset)+1,y:s.y-(u/2)-(2*this.offset)+1};this.label.horizontalAlign("center");this.label.verticalAlign("middle");}else{if(v&&Math.abs(t-(o.x+(l)))<this.snapDistance&&Math.abs(s.y-(o.y+(u/2)))<this.snapDistance){o={x:t-l-(4*this.offset)+1,y:s.y-(u/2)-(2*this.offset)+1};this.label.anchorRight=true;this.label.horizontalAlign("right");this.label.verticalAlign("middle");}else{if(v&&Math.abs(o.x)<this.snapDistance&&Math.abs(n-(o.y+u))<this.snapDistance){o={x:0,y:n-u-(4*this.offset)+1};this.label.anchorLeft=this.label.anchorBottom=true;this.label.horizontalAlign("left");this.label.verticalAlign("bottom");}else{if(v&&Math.abs(s.x-(o.x+(l/2)))<this.snapDistance&&Math.abs(n-(o.y+u))<this.snapDistance){o={x:s.x-(l/2)-(2*this.offset)+1,y:n-u-(4*this.offset)+1};this.label.anchorBottom=true;this.label.horizontalAlign("center");this.label.verticalAlign("bottom");}else{if(v&&Math.abs(t-(o.x+(l)))<this.snapDistance&&Math.abs(n-(o.y+u))<this.snapDistance){o={x:t-l-(4*this.offset)+1,y:n-u-(4*this.offset)+1};this.label.anchorRight=this.label.anchorBottom=true;this.label.horizontalAlign("right");this.label.verticalAlign("bottom");}else{if(r&&Math.abs(s.x-(o.x+(l/2)))<this.snapDistance&&Math.abs(o.y+u)<this.snapDistance){o={x:s.x-(l/2)-(2*this.offset)+1,y:-u-(2*this.offset)-3};this.label.anchorTop=true;this.label.horizontalAlign("center");this.label.verticalAlign("bottom");}else{if(r&&Math.abs(s.x-(o.x+(l/2)))<this.snapDistance&&Math.abs(n-(o.y))<this.snapDistance){o={x:s.x-(l/2)-(2*this.offset)+1,y:n};this.label.anchorBottom=true;this.label.horizontalAlign("center");this.label.verticalAlign("top");}else{if(r&&Math.abs(o.x+l)<this.snapDistance&&Math.abs(s.y-(o.y+(u/2)))<this.snapDistance){o={x:-l-(2*this.offset)-3,y:s.y-(u/2)-(2*this.offset)+1};this.label.anchorLeft=true;this.label.horizontalAlign("right");this.label.verticalAlign("middle");}else{if(r&&Math.abs(t-(o.x))<this.snapDistance&&Math.abs(s.y-(o.y+(u/2)))<this.snapDistance){o={x:t,y:s.y-(u/2)-(2*this.offset)+1};this.label.anchorRight=true;this.label.horizontalAlign("left");this.label.verticalAlign("middle");}else{if(r&&Math.abs(o.x+l-k.x)<this.snapDistance&&Math.abs(o.y+u-k.y)<this.snapDistance){o={x:-l-(2*this.offset)-3+k.x,y:-u-(2*this.offset)-3+k.y};this.label.anchorLeft=this.label.anchorTop=true;this.label.horizontalAlign("right");this.label.verticalAlign("bottom");}else{if(r&&Math.abs(t-o.x-k.x)<this.snapDistance&&Math.abs(o.y+u-k.y)<this.snapDistance){o={x:t-k.x,y:-u-(2*this.offset)-3+k.y};this.label.anchorRight=this.label.anchorTop=true;this.label.horizontalAlign("left");this.label.verticalAlign("bottom");}else{if(r&&Math.abs(o.x+l-k.x)<this.snapDistance&&Math.abs(n-(o.y)-k.y)<this.snapDistance){o={x:-l-(2*this.offset)-3+k.x,y:n-k.y};this.label.anchorLeft=this.label.anchorBottom=true;this.label.horizontalAlign("right");this.label.verticalAlign("top");}else{if(r&&Math.abs(t-(o.x)-k.x)<this.snapDistance&&Math.abs(n-(o.y)-k.y)<this.snapDistance){o={x:t-k.x,y:n-k.y};this.label.anchorRight=this.label.anchorBottom=true;this.label.horizontalAlign("left");this.label.verticalAlign("top");}else{this.applyIndicator(0);return o;}}}}}}}}}}}}}}}}}}}this.applyIndicator(2);return new b(o).moveBy(-this.offset,-this.offset).moveBy(this.labelDistance,this.labelDistance).castToInts();},adjustPositionAtEdge:function(p,k){var u=this.label,r=this.shape;var A=this.shape.dockers;if(u.isUpdating()){return false;}var m=this.snapDistance+5;var s=this.facade.eventCoordinates(k);if(this.edgePositions.values().any(function(h){if(ORYX.Core.Math.getDistancePointToPoint(h.center,s)<m){var x=h.firstdocker.bounds.center();u.setReferencePoint();if(u.getEdgePosition()!==h.position){u.setEdgePosition(h.position);r._update(true);}return true;}return false;}.bind(this))){this.setIntersectionPoint();this.applyIndicator(1);this.labelOffset=this.positionToLabelPosition(new b(0,0));return false;}if(u.getEdgePosition()){u.dirty=true;u.setEdgePosition();}if(k.ctrlKey||k.metaKey){return p;}var v=p.x+this.offset,t=p.y+this.offset,z=u.getWidth(),o=u.getHeight();if(this.shape.isBoundsIncluded(new ORYX.Core.Bounds(v,t,v+z,t+o-2))){return p;}var l=this.shape.dockers.pluck("bounds").invoke("center");var q=this.snapDistance,n=[];[["ul",new b(v,t)],["ur",new b(v+z,t)],["ll",new b(v,t+o-2)],["lr",new b(v+z,t+o-2)]].each(function(E){for(i=1,size=l.length;i<size;++i){var C=l[i-1],x=l[i];if(n[i]){continue;}var D=ORYX.Core.Math.distancePointLinie(C,x,E[1],true);D*=ORYX.Core.Math.pointIsLeftOfLine(C,x,E[1])?-1:1;var B=D>0?u.getOffsetTop():u.getOffsetBottom();if("number"==typeof D&&Math.abs(D)>2&&Math.abs(Math.abs(D)-B)<q&&this.isCorrectPosition(E[0],D,ORYX.Core.Math.getAngle(C,x))){var h=ORYX.Core.Math.getOrthogonalIdentityVector(C,x);var y=(D<0?-1:1)*(Math.abs(D)-B);p.x-=h.x*y;p.y-=h.y*y;n[i]=true;}}}.bind(this));return p;},getHorizontalAlignByOrientation:function(h){return["ul","ll"].include(h)?"left":(["ur","lr"].include(h)?"right":"center");},getVerticalAlignByOrientation:function(h){return["ul","ur"].include(h)?"top":(["ll","lr"].include(h)?"bottom":"middle");},adjustLabelPosition:function(l){var n=this.label.getReferencePoint();var k="center",m="middle";if(n){k=this.getHorizontalAlignByOrientation(n.orientation);m=this.getVerticalAlignByOrientation(n.orientation);if(Math.abs(n.segment.fromPosition.y-n.segment.toPosition.y)<1){k="left";}}var h=l.x+this.offset,o=l.y+this.offset;switch(k){case"left":h+=0;break;case"center":h+=(this.label.getWidth()/2);break;case"right":h+=this.label.getWidth();break;}switch(m){case"top":o+=0;break;case"middle":o+=this.label.getHeight()/2;break;case"bottom":o+=this.label.getHeight()-(this.offset);break;}this.label.horizontalAlign(k);this.label.verticalAlign(m);this.label.node.setAttributeNS(null,"text-anchor",k==="left"?"start":(k==="right"?"end":"middle"));this.label.node.setAttributeNS(null,"transform","rotate(0)");this.labelOffset=this.positionToLabelPosition(new b(0,0));this.label.setX(h+1);this.label.setY(o);this.label.node.setAttributeNS(null,"x",h+1);this.label.node.setAttributeNS(null,"y",o);this.label._positionText();},adjustPosition:function(h,k){if(!this.label){return h;}if(this.shape instanceof ORYX.Core.Node){return this.adjustPositionAtNode(h,k);}else{if(this.shape instanceof ORYX.Core.Edge){return this.adjustPositionAtEdge(h,k);}else{return h;}}},getCenter:function(){var k=this.getSVG().getBBox();var h=this.getSVG().getCTM();return{x:h.e+k.width/2,y:h.f+k.height/2};},isCorrectPosition:function(h,l,k){return((0<=k&&k<=90)&&((l>=0&&h=="lr")||(l<0&&h=="ul")))||((90<=k&&k<=180)&&((l>=0&&h=="ur")||(l<0&&h=="ll")))||((180<=k&&k<=270)&&((l>=0&&h=="ul")||(l<0&&h=="lr")))||(((270<=k&&k<=360)||k==0)&&((l>=0&&h=="ll")||(l<0&&h=="ur")))||h=="ce";},calculateEdgeReferencePoint:function(m){var l,q,o,k;if(m instanceof ORYX.Core.SVG.Label){l=m.getX();q=m.getY();o=m.getWidth();k=m.getHeight()-2;}else{if(arguments.length==4){l=arguments[0];q=arguments[1];o=arguments[2];k=arguments[3]-2;}else{return null;}}var h={x:l+(o/2),y:q+(k/2)};var n=this.shape.isBoundsIncluded(new ORYX.Core.Bounds(l,q,l+o,q+k));if(n){return this.calculateEdgeReferencePointForAPoint(h)||null;}else{var p;[["ul",new b(l,q)],["ll",new b(l,q+k)],["ur",new b(l+o,q)],["lr",new b(l+o,q+k)],["ce",h]].each(function(r){var s=this.calculateEdgeReferencePointForAPoint(r[1]);if(s){var t=ORYX.Core.Math.getAngle(s.segment.fromPosition,s.segment.toPosition);if(!(this.isCorrectPosition(r[0],s.distance,t))){return;}if("undefined"==typeof p||Math.abs(p.distance)>Math.abs(s.distance)){p=s;p.orientation=r[0];}}}.bind(this));return p||null;}},calculateEdgeReferencePointForAPoint:function(h){var k=this.shape.findSegment(h);if(!k){return null;}var l=ORYX.Core.Math.getPointOfIntersectionPointLine(k.fromDocker.bounds.center(),k.toDocker.bounds.center(),h,true);k.distance*=ORYX.Core.Math.pointIsLeftOfLine(k.fromDocker.bounds.center(),k.toDocker.bounds.center(),h)?-1:1;return{dirty:true,distance:k.distance,intersection:l,segment:{from:k.fromDocker,fromIndex:this.shape.dockers.indexOf(k.fromDocker),fromPosition:k.fromDocker.bounds.center(),to:k.toDocker,toIndex:this.shape.dockers.indexOf(k.toDocker),toPosition:k.toDocker.bounds.center()}};},onDrag:function(l,k){if(this.shape instanceof ORYX.Core.Edge&&!this.label.getEdgePosition()){var m=this.label;var o=this.calculateEdgeReferencePoint(m);var h="center",n="middle";if(o){h=this.getHorizontalAlignByOrientation(o.orientation);n=this.getVerticalAlignByOrientation(o.orientation);this.label.setReferencePoint(o);}else{this.label.setReferencePoint();}this.applyIndicator(o?3:2);if(m.horizontalAlign()!==h||m.verticalAlign()!==n||m.dirty){this.adjustLabelPosition(k);this.setIntersectionPoint(o);delete m.dirty;return;}else{this.setIntersectionPoint(o);}}this.setLabelPosition(this.labelOffset.moveBy(k));if(this.initDragDrop){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_START});delete this.initDragDrop;}},onDragDrop:function(k,h){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_END});if(!this.label){return;}if(h){h=this.positionToLabelPosition(h);if(this.shape instanceof ORYX.Core.Node){if(!h||(Math.abs(this.label.x-h.x)<3&&Math.abs(this.label.y-h.y)<3)){this.label.setPosition();}else{this.label.setPosition(h);}}else{if(this.shape instanceof ORYX.Core.Edge){if(!this.label.getEdgePosition()){var l=this.calculateEdgeReferencePoint(this.label);if(l){this.label.setReferencePoint(l);this.label.horizontalAlign(["ul","ll"].include(l.orientation)?"left":(["ur","lr"].include(l.orientation)?"right":"center"));this.label.verticalAlign(["ul","ur"].include(l.orientation)?"top":(["ll","lr"].include(l.orientation)?"bottom":"middle"));}else{this.label.setPosition(h);this.label.horizontalAlign(this.label.getOriginHorizontalAlign());this.label.verticalAlign(this.label.getOriginVerticalAlign());}}this.shape._update(true);}}var m=ORYX.Core.Command.extend({construct:function(p,n,q,o){this.oldState=o;this.label=p;this.shape=n;this.facade=q;},execute:function(){if(!this.newState){this.newState={position:this.label.getPosition(),edgePosition:this.label.getEdgePosition(),reference:this.label.getReferencePoint(),valign:this.label.verticalAlign(),halign:this.label.horizontalAlign()};}else{this.setState(this.newState);}},rollback:function(){this.setState(this.oldState);},setState:function(o){this.label.verticalAlign(o.valign);this.label.horizontalAlign(o.halign);this.label.setEdgePosition(o.edgePosition);this.label.setPosition(o.position);var n=o.reference;if(n){n.dirty=true;}this.label.setReferencePoint(n);this.shape._update(true);this.facade.updateSelection();}});this.facade.executeCommands([new m(this.label,this.shape,this.facade,this.initialState)]);}delete this.labelOffset;delete this.isDragging;Ext.getBody().setStyle("cursor","default");},destroy:function(){window.clearTimeout(this.initTimer);this.nodes.each(function(h){if(h.parentNode){h.parentNode.removeChild(h);}});if(this.updateLabelClb){this.label.unregisterOnChange(this.updateLabelClb);}delete this.label;delete this.node;delete this.updateLabelClb;}});}());if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.DockerCreation=Clazz.extend({construct:function(a){this.facade=a;this.circle=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{"pointer-events":"none"},["circle",{cx:"3",cy:"3",r:"3",fill:"red",opacity:"0.5"}]]);this.moveClb=this.handleMouseMove.bind(this);this.downClb=this.handleMouseDown.bind(this);this.outClb=this.handleMouseOut.bind(this);document.addEventListener("mousedown",function(){this.mouseDown=true;}.bind(this),true);document.addEventListener("mouseup",function(){delete this.mouseDown;delete this.activated;window.clearTimeout(this.timer);}.bind(this),true);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOVER,this.handleMouseOver.bind(this));},handleMouseOut:function(b,a){if(!this.activated){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveClb);this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.downClb);this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEOUT,this.outClb);this.hideOverlay();}else{this.handleMouseMove(b,a,true);}},handleMouseOver:function(b,a){if(!this.mouseDown&&a instanceof ORYX.Core.Edge&&a.containsNode(b.target)&&this.isEdgeDocked(a)){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveClb);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.downClb);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOUT,this.outClb);this.showOverlay(a);this.handleMouseMove(b,a);}},handleMouseDown:function(b,a){if(b.which==1&&a instanceof ORYX.Core.Edge&&this.isEdgeDocked(a)){this.activated=this.facade.eventCoordinates(b);}},handleMouseMove:function(c,b,d){if(b instanceof ORYX.Core.Edge&&this.isEdgeDocked(b)){var a=this.calculateOptimal(b,this.facade.eventCoordinates(c));this.circle.setAttributeNS(null,"transform","translate("+(a.x-3)+", "+(a.y-3)+")");if(this.activated&&(d===true||ORYX.Core.Math.getDistancePointToPoint(this.facade.eventCoordinates(c),this.activated)>3)){this.addDockerCommand({edge:b,event:c,position:a});delete this.activated;}}},isEdgeDocked:function(a){return !!(a.incoming.length||a.outgoing.length);},addDockerCommand:function(d){if(!d.edge){return;}var e=d.edge,f,c,b=0;d.docker=f=e.addDocker(d.position,d.docker);c=e.dockers.indexOf(f);var a=function(){if(b++<2){return;}this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,a);var g=ORYX.Core.Command.extend({construct:function(l,m,h,k){this.edge=l;this.docker=m;this.index=h;this.facade=k;this.pos=this.edge.dockers[h+1].bounds.center();},execute:function(){if(this.firstExecution){this.docker.parent=false;this.edge.add(this.docker,this.index);this.removedDockers=this.edge.removeUnusedDockers();}this.firstExecution=true;},rollback:function(){this.edge.removeDocker(this.docker);this.docker.parent=true;(this.removedDockers||$H({})).each(function(h){this.edge.add(h.value,Number(h.key));this.edge._update(true);}.bind(this));}});if(f&&c<e.dockers.length-1){this.facade.executeCommands([new g(e,f,c,this.facade)]);}}.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,a);this.facade.raiseEvent({uiEvent:d.event,type:ORYX.CONFIG.EVENT_DOCKERDRAG},d.docker);},showOverlay:function(a){if(this.circle&&a&&a.node&&!Ext.isIPad){a.node.firstChild.appendChild(this.circle);}},calculateOptimal:function(e,a){var g=a;var f=Infinity;for(var c=0,b=e.dockers.length;c<b-1;c++){var d=ORYX.Core.Math.getPointOfIntersectionPointLine(e.dockers[c].bounds.center(),e.dockers[c+1].bounds.center(),a,true);if(!d){continue;}var h=ORYX.Core.Math.getDistancePointToPoint(a,d);if(f>h){f=h;g=d;}}return g;},hideOverlay:function(){if(this.circle&&this.circle.parentNode){this.circle.parentNode.removeChild(this.circle);}}});if("undefined"==typeof ORYX){var ORYX={};}if(!ORYX.Plugins){ORYX.Plugins={};}new function(){ORYX.Plugins.MoveEdgeSegment=Clazz.extend({construct:function(a){this.facade=a;this.shapeSelection=undefined;this.activeSegment=undefined;this.hLine=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_HORIZONTAL);this.vLine=new ORYX.Core.GridLine(this.facade.getCanvas().getSvgContainer(),ORYX.Core.GridLine.DIR_VERTICAL);this.moverActive=false;this.mouseDown=false;this.movers=undefined;this.iPad=Ext.isIPad;this.rect=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{"pointer-events":"all","class":"mover"},["rect",{fill:"yellow",stroke:"black",opacity:Ext.isIPad?"0.3":"0.5"}],["rect",{fill:"none",stroke:"white",visibility:"hidden"}]]);document.addEventListener("mousedown",function(){this.mouseDown=true;}.bind(this),true);document.addEventListener("mouseup",function(){this.mouseDown=false;}.bind(this),true);if(this.iPad){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.showAllMover.bind(this));}else{this.rect.addEventListener("mousedown",this.moverMouseDown.bind(this),true);this.rect.addEventListener("mouseover",this.moverMouseOver.bind(this),true);this.rect.addEventListener("mouseout",this.moverMouseOut.bind(this),true);this.rect.addEventListener("click",this.onClick.bind(this),true);this.rect.addEventListener("dblclick",this.onDblClick.bind(this),true);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOVER,this.showMover.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOUT,this.hideMover.bind(this));}},onClick:function(d){if(this.activeSegment){var c=this.activeSegment.edge;var b=this.facade.getSelection();var a=b.include(c);if(d.ctrlKey){if(!a){this.facade.setSelection([].concat(b,c));}else{this.facade.setSelection(b.without(c));}}else{if(!a){this.facade.setSelection([c]);}}}},onDblClick:function(a){if(this.activeSegment){this.activeSegment.edge._delegateEvent(a);}},showAllMover:function(a){if(this.isDragging){this.hideOverlay(this.activeSegment);return;}else{this.hideOverlay();}if(this.facade.getSelection().length!==1&&!(this.facade.getSelection()[0] instanceof ORYX.Core.Edge)){return;}this.movers=[];var g=[],b=this.facade.getSelection()[0];for(var e=0,d=b.dockers.length-1;e<d;++e){var n=b.dockers[e].bounds.center();var k=b.dockers[e+1].bounds.center();var m=ORYX.Core.Math.midPoint(n,k);var f=Math.abs(n.x-k.x)<1;var o=Math.abs(n.y-k.y)<1;var h=o?"horizontal":(f?"vertical":false);if(!h||(Math.abs(n.x-k.x)<40&&Math.abs(n.y-k.y)<40)){continue;}var c=this.rect.cloneNode(true);g.push({fromDocker:b.dockers[e],toDocker:b.dockers[e+1],midPoint:m,edge:b,align:h,node:c});this.movers.push(c);c.addEventListener("mousedown",this.moverMouseDown.bind(this,g.last()),true);c.addEventListener("click",this.onClick.bind(this),true);c.addEventListener("dblclick",this.onDblClick.bind(this),true);}this.showMover(a,[b],g);},showMover:function(f,e,c){var b,d;if(this.iPad){if(e instanceof Array){e.each(function(h){if(h instanceof ORYX.Core.Edge&&this.isEdgeDocked(h)&&c!==undefined){var g;b=40;d=14;window.clearTimeout(this.overTimer);c.each(function(l,k){g=l.midPoint;if(l.align=="horizontal"){this.movers[k].firstChild.setAttributeNS(null,"x",-(b/2));this.movers[k].firstChild.setAttributeNS(null,"y",-(d/2));this.movers[k].firstChild.setAttributeNS(null,"width",b);this.movers[k].firstChild.setAttributeNS(null,"height",d);this.movers[k].childNodes[1].setAttributeNS(null,"x",-(b/2));this.movers[k].childNodes[1].setAttributeNS(null,"y",-((d+6)/2));this.movers[k].childNodes[1].setAttributeNS(null,"width",b);this.movers[k].childNodes[1].setAttributeNS(null,"height",d+6);this.movers[k].setAttributeNS(null,"style","cursor:n-resize;");}else{if(l.align=="vertical"){this.movers[k].firstChild.setAttributeNS(null,"x",-(d/2));this.movers[k].firstChild.setAttributeNS(null,"y",-(b/2));this.movers[k].firstChild.setAttributeNS(null,"width",d);this.movers[k].firstChild.setAttributeNS(null,"height",b);this.movers[k].childNodes[1].setAttributeNS(null,"x",-((d+6)/2));this.movers[k].childNodes[1].setAttributeNS(null,"y",-(b/2));this.movers[k].childNodes[1].setAttributeNS(null,"width",d+6);this.movers[k].childNodes[1].setAttributeNS(null,"height",b);this.movers[k].setAttributeNS(null,"style","cursor:w-resize;");}}this.movers[k].setAttributeNS(null,"transform","translate("+(g.x)+", "+(g.y)+")");}.bind(this));}this.showOverlay(h);this.mouseOver=true;}.bind(this));}}else{if(!this.mouseDown&&e instanceof ORYX.Core.Edge&&this.isEdgeDocked(e)){b=20;d=6;var a=this.calculateOptimal(e,this.facade.eventCoordinates(f));window.clearTimeout(this.overTimer);if(a){if(a.align=="horizontal"){this.rect.firstChild.setAttributeNS(null,"x",-(b/2));this.rect.firstChild.setAttributeNS(null,"y",-(d/2));this.rect.firstChild.setAttributeNS(null,"width",b);this.rect.firstChild.setAttributeNS(null,"height",d);this.rect.childNodes[1].setAttributeNS(null,"x",-(b/2));this.rect.childNodes[1].setAttributeNS(null,"y",-((d+6)/2));this.rect.childNodes[1].setAttributeNS(null,"width",b);this.rect.childNodes[1].setAttributeNS(null,"height",d+6);this.rect.setAttributeNS(null,"style","cursor:n-resize;");}else{if(a.align=="vertical"){this.rect.firstChild.setAttributeNS(null,"x",-(d/2));this.rect.firstChild.setAttributeNS(null,"y",-(b/2));this.rect.firstChild.setAttributeNS(null,"width",d);this.rect.firstChild.setAttributeNS(null,"height",b);this.rect.childNodes[1].setAttributeNS(null,"x",-((d+6)/2));this.rect.childNodes[1].setAttributeNS(null,"y",-(b/2));this.rect.childNodes[1].setAttributeNS(null,"width",d+6);this.rect.childNodes[1].setAttributeNS(null,"height",b);this.rect.setAttributeNS(null,"style","cursor:w-resize;");}}this.rect.setAttributeNS(null,"transform","translate("+(a.x)+", "+(a.y)+")");this.showOverlay(e);this.mouseOver=true;this.activeSegment=e.findSegment(a);this.activeSegment.align=a.align;this.activeSegment.edge=e;}}if(this.isDragging){this.activeSegment.edge.dockers.invoke("hide");}if(this.mouseDown&&this.activeSegment){}}},hideMover:function(a){if(this.mouseOver&&!this.moverActive){window.clearTimeout(this.overTimer);this.overTimer=window.setTimeout(function(){this.hideOverlay();delete this.mouseOver;delete this.activeSegment;}.bind(this),1);}},moverMouseOut:function(a){if(!this.iPad){this.hideMover(a);this.activeSegment.edge.dockers.invoke("hide");}},moverMouseDown:function(){var l,b;if(arguments.length===1){b=arguments[0];}else{if(arguments.length===2){l=arguments[0];b=arguments[1];}}this.moverActive=true;if(this.iPad){if(!this.movers){return;}if(!l){var p=this.facade.eventCoordinates(b);l=segments.find(function(d){var a=d.fromDocker.bounds.center();var t=d.toDocker.bounds.center();return ORYX.Core.Math.isPointInLine(p.x,p.y,a.x,a.y,t.x,t.y,10);});}this.activeSegment=l;}if((this.activeSegment&&!this.isDragging)){this.isDragging=true;this.isInitialized=true;if(!this.activeSegment.fromDocker||!this.activeSegment.toDocker){return;}var e=this.activeSegment.edge;var r=this.activeSegment.fromDocker;var o=this.activeSegment.toDocker;var c=this.activeSegment.align;var n=e.dockers;var q=undefined;if(n[0].isDocked()){var m=e.dockers[0].getDockedShape();var g=m.absoluteBounds();q={shape:m,center:g.center(),upperLeft:g.upperLeft(),lowerRight:g.lowerRight()};}var h=undefined;if(n[n.length-1].isDocked()){var m=e.dockers[n.length-1].getDockedShape();var g=m.absoluteBounds();h={shape:m,center:g.center(),upperLeft:g.upperLeft(),lowerRight:g.lowerRight()};}var f=c=="horizontal"?this.activeSegment.fromDocker.bounds.center().y:this.activeSegment.fromDocker.bounds.center().x;var k={fromShape:q,fromDocker:r,toShape:h,toDocker:o,edge:e,snapPoints:[],dockers:[],magnets:[],old:f,canvas:this.facade.getCanvas()};if(this.iPad){ORYX.Core.SVGEnableDrag(b,b.currentTarget,{movedCallback:this.onDrag.bind(this,k),upCallback:this.onDragDrop.bind(this,k),adjustPosition:this.adjustPosition.bind(this,k)});}else{ORYX.Core.SVGEnableDrag(b,this.rect,{movedCallback:this.onDrag.bind(this,k),upCallback:this.onDragDrop.bind(this,k),adjustPosition:this.adjustPosition.bind(this,k)});}var s=this.activeSegment.edge.dockers.collect(function(a){return{docker:a,pos:a.bounds.center(),ref:a.referencePoint};});this.initialState={fromDocker:r,fromPosition:r.bounds.center(),fromReference:r.referencePoint,toDocker:o,toPosition:o.bounds.center(),toReference:o.referencePoint,dockers:s,shape:e,fromShape:q,toShape:h};}},moverMouseOver:function(){window.clearTimeout(this.overTimer);if(this.activeSegment&&!this.moverActive){this.activeSegment.edge.dockers.invoke("show");}},onDrag:function(d,c,a){if(this.activeSegment){if(this.isInitialized&&this.isDragging){this.initDrag(d);delete this.isInitialized;}var g=this.activeSegment.fromDocker;var e=this.activeSegment.toDocker;var f=7;var b=this.activeSegment.align;if(b=="vertical"){g.bounds.centerMoveTo(a.x,g.bounds.center().y);if(g.referencePoint){g.setReferencePoint({x:a.x-d.fromShape.upperLeft.x,y:g.referencePoint.y});}e.bounds.centerMoveTo(a.x,e.bounds.center().y);if(e.referencePoint){e.setReferencePoint({x:a.x-d.toShape.upperLeft.x,y:e.referencePoint.y});}}else{if(b=="horizontal"){g.bounds.centerMoveTo(g.bounds.center().x,a.y);if(g.referencePoint){g.setReferencePoint({x:g.referencePoint.x,y:a.y-d.fromShape.upperLeft.y});}e.bounds.centerMoveTo(e.bounds.center().x,a.y);if(e.referencePoint){e.setReferencePoint({x:e.referencePoint.x,y:a.y-d.toShape.upperLeft.y});}}}this.activeSegment.edge._update(true);}},initDrag:function(f){if(!this.activeSegment||!this.isDragging||!this.activeSegment.fromDocker||!this.activeSegment.toDocker){return;}if(this.activeSegment.align=="horizontal"){Ext.getBody().setStyle("cursor","n-resize");}else{if(this.activeSegment.align=="vertical"){Ext.getBody().setStyle("cursor","w-resize");}}var b=this.activeSegment.edge;b.hideLabels();var a=this.activeSegment.align;var m=this.activeSegment.fromDocker;var g=this.activeSegment.toDocker;var c=b.dockers[b.dockers.indexOf(m)-1];var k=b.dockers[b.dockers.indexOf(g)+1];var e=f.toShape,h=f.fromShape;this.shapeSelection=this.facade.getSelection();this.facade.setSelection(this.shapeSelection.without(this.activeSegment.edge));this.activeSegment.edge.dockers.invoke("show");this.activeSegment.edge.dockers.without(m.isDocked()?this.activeSegment.edge.dockers.first():null).without((c&&c.isDocked())?this.activeSegment.edge.dockers.first():null).without(g.isDocked()?this.activeSegment.edge.dockers.last():null).without((k&&k.isDocked())?this.activeSegment.edge.dockers.last():null).invoke("preventHiding",true);this.activeSegment.edge.dockers.invoke("hide");var l=[];if(c&&c.isDocked()||m.isDocked()){l=l.concat(this.getRelevantMagnets(h,c||m,a));}if(k&&k.isDocked()||g.isDocked()){l=l.concat(this.getRelevantMagnets(e,c||m,a));}l.invoke("show");f.magnets=l;var d=[];var n=[];b.dockers.each(function(o){if(o.isDocked()){d.push(a=="horizontal"?o.referencePoint.y+o.getDockedShape().absoluteBounds().upperLeft().y:o.referencePoint.x+o.getDockedShape().absoluteBounds().upperLeft().x);}else{d.push(a=="horizontal"?o.bounds.center().y:o.bounds.center().x);}n.push({val:a=="horizontal"?o.bounds.center().y:o.bounds.center().x,id:o.id});});d.push(f.old);window.clearTimeout(this.dockerTimer);this.dockerTimer=window.setTimeout(function(){if(b.incoming[0]){if(b.incoming[0].outgoing.length>1){b.incoming[0].outgoing.without(b).each(function(o){o.dockers.each(function(p){if(p.isDocked()){d.push(a=="horizontal"?p.referencePoint.y+p.getDockedShape().absoluteBounds().upperLeft().y:p.referencePoint.x+p.getDockedShape().absoluteBounds().upperLeft().x);}else{d.push(a=="horizontal"?p.bounds.center().y:p.bounds.center().x);}});}.bind(this));}if(b.incoming[0].incoming.length>0){b.incoming[0].incoming.each(function(o){o.dockers.each(function(p){if(p.isDocked()){d.push(a=="horizontal"?p.referencePoint.y+p.getDockedShape().absoluteBounds().upperLeft().y:p.referencePoint.x+p.getDockedShape().absoluteBounds().upperLeft().x);}else{d.push(a=="horizontal"?p.bounds.center().y:p.bounds.center().x);}});});}}if(b.outgoing[0]){if(b.outgoing[0].incoming.length>1){b.outgoing[0].incoming.without(b).each(function(o){o.dockers.each(function(p){if(p.isDocked()){d.push(a=="horizontal"?p.referencePoint.y+p.getDockedShape().absoluteBounds().upperLeft().y:p.referencePoint.x+p.getDockedShape().absoluteBounds().upperLeft().x);}else{d.push(a=="horizontal"?p.bounds.center().y:p.bounds.center().x);}});});}if(b.outgoing[0].outgoing.length>0){b.outgoing[0].outgoing.each(function(p){p.dockers.each(function(o){if(o.isDocked()){d.push(a=="horizontal"?o.referencePoint.y+o.getDockedShape().absoluteBounds().upperLeft().y:o.referencePoint.x+o.getDockedShape().absoluteBounds().upperLeft().x);}else{d.push(a=="horizontal"?o.bounds.center().y:o.bounds.center().x);}});});}}}.bind(this),100);f.dockers=n;f.snapPoints=d;},onDragDrop:function(c){delete this.isDragging;Ext.getBody().setStyle("cursor","auto");this.hLine.hide();this.vLine.hide();this.moverActive=false;var a=this.activeSegment.edge;a.showLabels();if(this.isInitialized){delete this.isInitialized;return;}a.dockers.invoke("preventHiding",false);a.dockers.invoke("hide");if(this.iPad){this.hideOverlay();}c.magnets.invoke("hide");this.hideMover();if(this.initialState.fromPosition.x==this.initialState.fromDocker.bounds.center().x&&this.initialState.fromPosition.y==this.initialState.fromDocker.bounds.center().y&&this.initialState.toPosition.x==this.initialState.toDocker.bounds.center().x&&this.initialState.toPosition.y==this.initialState.toDocker.bounds.center().y){return;}var b=ORYX.Core.Command.extend({construct:function(e,d){this.oldState=d;this.shape=d.shape;this.dockers=d.dockers;this.facade=e;this.removedDockers=$H({});this.fromShape=d.fromShape;this.toShape=d.toShape;},execute:function(){if(!this.newState){if(!(this.fromShape&&this.toShape&&this.fromShape.shape==this.toShape.shape)){this.removedDockers=this.shape.removeUnusedDockers();}if(this.fromShape&&(!this.toShape||this.fromShape.shape!==this.toShape.shape)){if(this.fromShape.shape.isPointIncluded(this.shape.dockers[0].bounds.center().x,this.shape.dockers[0].bounds.center().y)&&this.fromShape.shape.isPointIncluded(this.shape.dockers[1].bounds.center().x,this.shape.dockers[1].bounds.center().y)){this.removedDockers[1]=this.shape.dockers[1];var e={x:this.shape.dockers[1].bounds.center().x-this.fromShape.upperLeft.x,y:this.shape.dockers[1].bounds.center().y-this.fromShape.upperLeft.y};this.shape.remove(this.shape.dockers[1]);this.shape.dockers[0].setReferencePoint(e);this.shape._update(true);}}if(this.toShape&&(!this.fromShape||this.fromShape.shape!==this.toShape.shape)){if(this.toShape.shape.isPointIncluded(this.shape.dockers[this.shape.dockers.length-1].bounds.center().x,this.shape.dockers[this.shape.dockers.length-1].bounds.center().y)&&this.toShape.shape.isPointIncluded(this.shape.dockers[this.shape.dockers.length-2].bounds.center().x,this.shape.dockers[this.shape.dockers.length-2].bounds.center().y)){this.removedDockers[this.shape.dockers.length-2]=this.shape.dockers[this.shape.dockers.length-2];var e={x:this.shape.dockers[this.shape.dockers.length-2].bounds.center().x-this.toShape.upperLeft.x,y:this.shape.dockers[this.shape.dockers.length-2].bounds.center().y-this.toShape.upperLeft.y};this.shape.remove(this.shape.dockers[this.shape.dockers.length-2]);this.shape.dockers[this.shape.dockers.length-1].setReferencePoint(e);this.shape._update(true);}}var d=this.shape.dockers.collect(function(f){return{docker:f,pos:f.bounds.center(),ref:f.referencePoint};});this.newState={shape:this.shape,dockers:d,fromShape:this.fromShape,toShape:this.toShape};this.facade.setSelection([this.shape]);this.shape._update(true);this.facade.updateSelection();}else{this.setState(this.newState);}},rollback:function(){(this.removedDockers||$H({})).each(function(e){if(e){this.shape.add(e.value,Number(e.key));}}.bind(this));this.setState(this.oldState);},setState:function(k){var d=k.dockers.pluck("docker");var e=this.shape.dockers;var g=k.fromShape;var h=k.toShape;for(var f=e.length-1;f>=0;--f){if(!d.include(e[f])){this.removedDockers[f]=e[f];this.shape.remove(e[f]);}}d.each(function(m,l){if(!e.include(m)){this.shape.add(m,l);}}.bind(this));k.dockers.each(function(l,m){if(l.docker.isDocked()){l.docker.setReferencePoint(l.ref);}l.docker.bounds.centerMoveTo(l.pos);}.bind(this));this.facade.setSelection([this.shape]);this.shape._update(true);this.facade.updateSelection();}});this.facade.executeCommands([new b(this.facade,this.initialState)]);},adjustPosition:function(g,k,b){if(this.activeSegment){k.x+=6;k.y+=6;var f=7;var d=this.activeSegment.align;var c=(d=="horizontal");var n=this.middle(this.activeSegment.fromDocker,this.activeSegment.toDocker,d);var e=g.edge;var m=e.dockers;var a=m.length;var h=c?(g.canvas.bounds.height()-f):(g.canvas.bounds.width()-f);if(c?(k.y<f||k.y>h):(k.x<f||k.x>h)){if(c){k.y=k.y<f?f:k.y>(h)?h:k.y;return{x:n,y:k.y};}else{k.x=k.x<f?f:k.x>(h)?h:k.x;return{x:k.x,y:n};}}if(m[0].isDocked()){this.dockSegment(this.activeSegment.fromDocker,g.fromShape,k,e,e.dockers,e.dockers.length,d,"from");}if(m[a-1].isDocked()){this.dockSegment(this.activeSegment.toDocker,g.toShape,k,e,e.dockers,e.dockers.length,d,"to");}var l=this.snap(k,g,b);return c?{x:n,y:l.y}:{x:l.x,y:n};}return k;},snap:function(h,d,a){this.hLine.hide();this.vLine.hide();if(a.ctrlKey){return h;}var e=5;var f=this.activeSegment.fromDocker;var g=this.activeSegment.toDocker;var k=d.dockers;var c=d.snapPoints;var b=this.activeSegment.align;if(k.length>=4){k.each(function(p,n){if(k[n-1]&&k[n+2]&&p.id==f.id){var o=Math.min(k[n-1].val,k[n+2].val);var l=Math.max(k[n-1].val,k[n+2].val);var m=o+(l-o)/2;if(b=="horizontal"){if((h.y<m+e)&&(h.y>m-e)&&l-o>20){h={x:h.x,y:m};}}else{if(b=="vertical"){if((h.x<m+e)&&(h.x>m-e)&&l-o>20){h={x:m,y:h.y};}}}}}.bind(this));}d.magnets.each(function(l){if(b=="horizontal"&&(l.y-e)<h.y&&(l.y+e)>h.y){h={x:h.x,y:l.y};}else{if(b=="vertical"&&(l.x-e)<h.x&&(l.x+e)>h.x){h={x:l.x,y:h.y};}}}.bind(this));c.each(function(l){if(b=="horizontal"&&(l-e)<h.y&&(l+e)>h.y){h={x:h.x,y:l};if(l!=d.old){this.hLine.update(h.y);}throw $break;}else{if(b=="vertical"&&(l-e)<h.x&&(l+e)>h.x){h={x:l,y:h.y};if(l!=d.old){this.vLine.update(h.x);}throw $break;}}}.bind(this));return h;},insideShape:function(b,f,c){var a=f.upperLeft.x;var h=f.upperLeft.y;var e=f.lowerRight.x;var d=f.lowerRight.y;var g=7;if(c=="horizontal"){return b.y>h+g&&b.y<d-g;}if(c=="vertical"){return b.x>a+g&&b.x<e-g;}},isEdgeDocked:function(a){return !!(a.dockers.length>2&&(a.incoming.length||a.outgoing.length)||(a.incoming.length&&a.outgoing.length));},middle:function(f,k,g){var e=g=="horizontal"?f.bounds.center().x:f.bounds.center().y;var d=g=="horizontal"?k.bounds.center().x:k.bounds.center().y;var h=Math.min(e,d);var c=Math.max(e,d);return h+(c-h)/2;},dockSegment:function(f,n,l,d,s,a,c,o){if(!n){return;}var b=(c=="horizontal");var p=(o=="from");var q=undefined,k=undefined;var m=n.upperLeft;var h=n.lowerRight;if(f.id==(p?s[0].id:s[a-1].id)){if(b?(l.y<m.y||l.y>h.y):(l.x<m.x||l.x>h.x)){if(p?q:k){d.addDocker.apply(d,p?[1,q]:[a-2,k]);if(p){this.activeSegment.fromDocker=s[1];this.activeSegment.fromDocker.preventHiding(true);this.activeSegment.fromDocker.show();q=undefined;}else{this.activeSegment.toDocker=s[a-2];this.activeSegment.toDocker.preventHiding(true);this.activeSegment.toDocker.show();k=undefined;}}else{if(p){var g=b?(f.referencePoint.x+m.x):(f.referencePoint.y+m.y);d.createDocker(1,b?({x:g,y:l.y}):({x:l.x,y:g}));this.activeSegment.fromDocker=s[1];this.activeSegment.fromDocker.preventHiding(true);this.activeSegment.fromDocker.show();s.first().setReferencePoint(b?({x:g-m.x,y:n.shape._defaultMagnet.bounds.center().y}):({x:n.shape._defaultMagnet.bounds.center().x,y:g-m.y}));}else{var e=b?(f.referencePoint.x+m.x):(f.referencePoint.y+m.y);d.createDocker(a-1,b?({x:e,y:l.y}):({x:l.x,y:e}));this.activeSegment.toDocker=s[a-1];this.activeSegment.toDocker.preventHiding(true);this.activeSegment.toDocker.show();s.last().setReferencePoint(b?({x:e-m.x,y:n.shape._defaultMagnet.bounds.center().y}):({x:n.shape._defaultMagnet.bounds.center().x,y:e-m.y}));}}var r=this.middle(this.activeSegment.fromDocker,this.activeSegment.toDocker,c);}}else{if(f.id==(p?(s[1].id):(s[a-2].id))){if(b?(l.y>=m.y&&l.y<=h.y):(l.x>=m.x&&l.x<=h.x)){if(p){q=s[1];d.remove(s[1]);this.activeSegment.fromDocker=s[0];}else{k=s[a-2];d.remove(s[a-2]);this.activeSegment.toDocker=s[a-1];}}}}},getRelevantMagnets:function(g,f,b){var e=g.shape.getMagnets();var a=(b=="horizontal");var d=[];if(e.length===1){d=e[0];}else{var c=this.getSide(g.center,f,b);d=g.shape.getMagnets().findAll(function(h){switch(c){case"left":return h.anchorLeft;case"right":return h.anchorRight;case"top":return h.anchorTop;case"bottom":return h.anchorBottom;}});}if(d.length>0){d.each(function(h){h.x=h.bounds.center().x+g.upperLeft.x;h.y=h.bounds.center().y+g.upperLeft.y;});}return d;},getSide:function(c,d,b){var a=(b=="horizontal");if(a){return(d.bounds.center().x<c.x)?"left":"right";}else{return(d.bounds.center().y<c.y)?"top":"bottom";}},calculateOptimal:function(b,k){var d;for(var e=0,c=b.dockers.length-1;e<c;++e){var h=b.dockers[e].bounds.center();var g=b.dockers[e+1].bounds.center();if(ORYX.Core.Math.isPointInLine(k.x,k.y,h.x,h.y,g.x,g.y,10)){var f=Math.abs(h.x-g.x)<1;var m=Math.abs(h.y-g.y)<1;if(f||m){var a=ORYX.Core.Math.distancePointLinie(h,g,k,true);if(a!==null&&(!d||d.distance>a)){d=ORYX.Core.Math.midPoint(h,g);d.align=m?"horizontal":(f?"vertical":false);d.distance=a;}}}}return d||null;},showOverlay:function(a){if(this.iPad){if(this.movers){this.movers.each(function(b){a.node.lastChild.appendChild(b);}.bind(this));}}else{a.node.lastChild.appendChild(this.rect);}},hideOverlay:function(a){if(this.iPad){if(this.movers){this.movers.each(function(b){if(b.parentNode&&(!a||b!==a.node)){b.parentNode.removeChild(b);}});}}else{if(this.rect.parentNode){this.rect.parentNode.removeChild(this.rect);}}}});}();if("undefined"===typeof Signavio){var Signavio={};}if("undefined"===typeof Signavio.Plugins){Signavio.Plugins={};}new function(){Signavio.Plugins.Multilanguage=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){ORYX.CONFIG.MULTI_LANGUAGES_ENABLED=true;this.facade=a;this.initButtons();},initButtons:function(){this.facade.offer({"group":"ZZZZZZZZZGroup.Multilanguage","name":true,"addFill":true,"index":1});var b=this.facade.getCanvas().getLanguage(),a=$H(ORYX.CONFIG.MULTI_LANGUAGES||{}),c=ORYX.CONFIG.EXPLORER_PATH+"/src/img/flags/"+(a[b]);a.each(function(g,e){var d=Signavio.I18N.Multilanguage[String(g.key).toUpperCase()]||g.key;var f={"name":d,"group":"ZZZZZZZZZZGroup.Multilanguage","index":e,"dropDownGroupIcon":c,"toggle":false,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/flags/"+g.value,"functionality":function(){this.changeLanguage(f.buttonInstance,g.key);}.bind(this),"index":2,"style":g.key==b?"font-weight:bold":undefined};this.facade.offer(f);this.initialButton=this.initialButton||f;}.bind(this));},changeLanguage:function(a,b){this.setButton(a);this.facade.getCanvas().setLanguage(b);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SELECTION_CHANGED,elements:this.facade.getSelection()});},setButton:function(b){var a=b.splitButton;a.icon=b.icon;a.el.child(a.buttonSelector).setStyle("background-image","url("+a.icon+")");b.parentMenu.items.each(function(c){c.el.setStyle("font-weight","");});b.el.setStyle("font-weight","bold");}});}();if("undefined"==typeof window.Signavio){var Signavio={};}if("undefined"==typeof Signavio.Plugins){Signavio.Plugins={};}(function(){Signavio.Plugins.Locking=ORYX.Plugins.AbstractPlugin.extend({pingInterval:30,construct:function(a){this.facade=a;this.setupPanel();this.doPing();Ext.getCmp(this.panel.parent("div.x-panel").id).on("resize",this.updatePanelPosition,this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ZOOM,this.updatePanelPosition.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SAVED,this.doPing.bind(this));ORYX.Editor.Cookie.onChange(function(b){window.clearTimeout(this.timer);if(!this.isLoggedIn()){this.onNotAuthorized();}else{this.doPing();}}.bind(this));},setupPanel:function(){this.tplUser=new Ext.XTemplate("<span>",Signavio.I18N.Locking.editing," </span>",'<tpl for=".">','<tpl for="rep">','<span class="x-user" title="{company}">{name}</span>{[xcount!=xindex?",":""]} ',"</tpl>","</tpl>");this.tplFail=new Ext.XTemplate("<span class='x-fail'>{message}</span>");this.panel=Ext.get(this.facade.getCanvas().getHTMLContainer().parentNode.parentNode.parentNode.appendChild(document.createElement("div")));this.panel.addClass("x-locking");},updatePanelPosition:function(){if(!this.scroll){this.scroll=this.facade.getCanvas().getScrollNode();}if(this.scroll.scrollWidth<=this.scroll.offsetWidth-17||this.scroll.scrollHeight==this.scroll.offsetHeight){this.panel.setBottom("2px");}else{this.panel.setBottom("");}if(this.scroll.scrollHeight<=this.scroll.offsetHeight-17||this.scroll.scrollWidth==this.scroll.offsetWidth){this.panel.setRight("2px");}else{this.panel.setRight("");}},onAbort:function(){this.tplFail.overwrite(this.panel,{message:Signavio.I18N.Locking.timeout});},onNotOnline:function(){this.tplFail.overwrite(this.panel,{message:Signavio.I18N.Locking.notOnline});},onNotAuthorized:function(){this.tplFail.overwrite(this.panel,{message:Signavio.I18N.Locking.notAuthorized});},isLoggedIn:function(){var a=((ORYX.Editor.Cookie.getParams()||{}).identifier||"").replace(/"/g,"");return a&&a!="public";},onNoRights:function(){this.tplFail.overwrite(this.panel,{message:Signavio.I18N.Locking.noRights});},onFailure:function(){this.tplFail.overwrite(this.panel,{message:Signavio.I18N.Locking.connectionProblem});window.setTimeout(function(){this.doWait();}.bind(this),5000);},getUser:function(b){if(!this.users){this.users={};}var a=this.users[b];if(!a){if(b.split("/").length==32){new Ajax.Request(ORYX.CONFIG.SERVER_HANDLER_ROOT+b+"/info",{method:"get",asynchronous:false,requestHeaders:{"Accept":"application/json"},encoding:"UTF-8",onSuccess:(function(c){a={rel:"user",href:b,rep:(c.responseText||"{}").evalJSON()};}).bind(this)});}else{a={rel:"user",href:b,rep:{name:"<i>System</i>",company:""}};}this.users[b]=a;}return a;},cacheUsers:function(a){if(!this.users){this.users={};}[].concat(a).each(function(b){if("user"==b.rel){this.users[b.href]=b;}}.bind(this));},onSuccess:function(c){this.cacheUsers(c);var f=unescape((ORYX.Editor.Cookie.getParams()||{}).login||"").toLowerCase();var b=c.findAll(function(g){return"user"==g.rel&&f&&g.rep.mail.toLowerCase()!==f;});if(b.length>0){this.panel.show();this.tplUser.overwrite(this.panel,b);}else{this.panel.update("");this.panel.hide();}var d=c.find(function(g){return"mod"==g.rel;});var a=this.facade.getModelMetaData();if(d&&a&&d.rep.rev!==a.revision){var e=this.getUser(d.rep.author);if(e&&f&&e.rep.mail!=f){this.panel.show();this.panel.insertHtml("afterBegin",(new Ext.Template(Signavio.I18N.Locking.remoteEdited+"<br/>")).apply(e.rep));}}},onComplete:function(){this.doWait();},doWait:function(){window.clearTimeout(this.timer);this.timer=window.setTimeout(function(){this.doPing();delete this.timer;}.bind(this),this.pingInterval*1000);},doPing:function(){if(!this.isLoggedIn()){return;}var a=this.facade.getModelMetaData();if(a["new"]){this.panel.hide();return;}Ext.Ajax.request({url:ORYX.CONFIG.SERVER_MODEL_HANDLER+"/"+(a.modelId)+"/ping",method:"POST",headers:{"Accept":"application/json","Content-Type":"charset=UTF-8"},params:{},success:function(b){this.onSuccess((b.responseText||"{}").evalJSON());this.onComplete();}.bind(this),failure:function(b){if(b.status&&b.status===401){this.onNotAuthorized();return;}else{if(b.status&&b.status===403){this.onNoRights();return;}else{if(b.statusText==="transaction aborted"){this.onAbort();}else{if(b.statusText==="communication failure"){this.onNotOnline();}else{this.onFailure();}}}}this.onComplete();}.bind(this)});}});}());if(!ORYX.Plugins){ORYX.Plugins={};}new function(){var a={};a.DUMMY_SVG='<svg xmlns="http://www.w3.org/2000/svg" xmlns:oryx="http://oryx-editor.org" '+'width="1" height="1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svg="http://www.w3.org/2000'+'/svg"><defs/><g stroke="black" font-family="Verdana, sans-serif" font-size-adjust="none" font-style="normal"'+' font-variant="normal" font-weight="normal" line-heigth="normal" font-size="12"><g class="stencils" transform'+'="translate(0)"><g class="me"/><g class="children"/><g class="edge"/></g></g></svg>';var b={};b.execute=function(d,h,e,g){var f=h instanceof Array?h[0]:h;var c=h instanceof Array?h[1]:undefined;new Ajax.Request(d,{method:g||"get",parameters:e,requestHeaders:{"Accept":"application/json","Content-Type":"charset=UTF-8"},asynchronous:false,onSuccess:function(m){var k;try{k=m.responseText.evalJSON();}catch(l){k=m.responseText;}if(f instanceof Function){f(k,m);}},onFailure:function(k){if(c instanceof Function){c(k);}}});};Signavio.Plugins.AutomaticCollapsedSubProcesses=ORYX.Plugins.AbstractPlugin.extend({construct:function(c){this.facade=c;this.pluginMenuIsShown=false;this.button={target:ORYX.Plugins.ShapeMenuPlugin,functionality:function(){this.togglePluginMenu();}.bind(this),icon:ORYX.PATH+"images/wrench_orange.png",description:ORYX.I18N.Subprocessing.PluginDescription,align:ORYX.CONFIG.SHAPEMENU_BOTTOM,minShape:2,isEnabled:function(){return("undefined"!=typeof this.facade&&(this.facade.getCanvas().getStencil().namespace()=="http://b3mn.org/stencilset/bpmn2.0#"));}.bind(this)};this.facade.offer(this.button);this.facade.registerOnEvent("shapemenu.showMorphButton",this.shapeMenuWasCreated.bind(this));},shapeMenuWasCreated:function(c){if(c.selectedElements.length!=1){return;}if(!c.selectedElements[0].getStencil().id().endsWith("Subprocess")){return;}var d=c.buttons.find(function(e){return(e.identifier.endsWith("CollapsedEventSubprocess")||e.identifier.endsWith("CollapsedSubprocess"));});if(!d){return;}if(c.selectedElements[0].getChildShapes().length>0){d.setHandler(function(){this.startSubProcessing([c.selectedElements[0]]);}.bind(this));}},createPluginMenuItems:function(){if("undefined"!=typeof this.facade&&this.facade.getSelection().length>1){var d=new Ext.menu.Item({text:ORYX.I18N.Subprocessing.SelectedItems,icon:"/stencilsets/bpmn2.0/icons/activity/event.subprocess.png",disabled:true});var c=new Ext.menu.Item({text:ORYX.I18N.Subprocessing.OpenedSubprocess,icon:"/stencilsets/bpmn2.0/icons/activity/subprocess.png",handler:function(){this.startSubProcessing(this.facade.getSelection());}.bind(this)});this.pluginMenu.addItem(d);this.pluginMenu.addItem(c);}},onSelectionChanged:function(c){if(this.pluginMenu!=undefined&&this.pluginMenuIsShown==true){this.hidePluginMenu();}},createPluginMenu:function(){this.pluginMenu=new Ext.menu.Menu();this.createPluginMenuItems();},togglePluginMenu:function(){if(this.pluginMenuIsShown==true){this.hidePluginMenu();}else{this.showPluginMenu();}},showPluginMenu:function(){this.createPluginMenu();this.pluginMenuIsShown=true;this.pluginMenu.show(this.button.button.node);},hidePluginMenu:function(){this.pluginMenuIsShown=false;this.pluginMenu.destroy();},startSubProcessing:function(d){var e=ORYX.Core.Command.extend({construct:function(g,f,h){this.selectedShapes=f;this.selection=f;this.facade=g;this.plugin=h;this.consideredShapes=this.getAllShapesToConsider(d);},execute:function(){var g=this.selectedShapes;if(g.length==0){return;}var f=this.getSingleCollapsedProcessName(g);var k=this.checkSelections(g);if(!k){Ext.Msg.confirm(ORYX.I18N.Subprocessing.Attention,ORYX.I18N.Subprocessing.AttentionDesc,function(l){if(l=="yes"){var m=this.getWindowForSubprocessing(g,f);m.show();}}.bind(this)).setIcon(Ext.MessageBox.WARNING);}else{var h=this.getWindowForSubprocessing(g,f);h.show();}},restoreNotAttachedNodes:function(){var f=this.shapesToAdd.nodes;f.each(function(h){if(h.isAttached==false){var g=this.facade.getCanvas().getChildShapeByResourceId(h.parent)||this.facade.getCanvas();g.add(h.node);}}.bind(this));},restoreAttachedNotes:function(){var f=this.shapesToAdd.nodes;f.each(function(k){if(k.isAttached==true){var h=this.facade.getCanvas().getChildShapeByResourceId(k.parent)||this.facade.getCanvas();h.add(k.node);var g=this.facade.getCanvas().getChildShapeByResourceId(k.dockerShape);if(g){k.node.getDockers().first().setDockedShape(g);k.node.getDockers().first().setReferencePoint(k.refPoint);}}}.bind(this));},restoreDeletedEdges:function(){var f=this.shapesToAdd.edges;f.each(function(k){var h=this.facade.getCanvas();var g=k.edge.getDockers();h.add(k.edge);if(k.hasFirstDockedShape){var l=h.getChildShapeByResourceId(k.source);if(g.first()){g.first().setDockedShape(l);g.first().setReferencePoint(k.sourceRefPoint);}}if(k.hasLastDockedShape){var m=h.getChildShapeByResourceId(k.target);if(g.last()){g.last().setDockedShape(m);g.last().setReferencePoint(k.targetRefPoint);}}}.bind(this));},restoreTargetSourceEdges:function(){var g=this.otherEdges.noSourceEdges;g.each(function(h){var k=this.facade.getCanvas().getChildShapeByResourceId(h.edge);var l=this.facade.getCanvas().getChildShapeByResourceId(h.source);if(k&&l){k.getDockers().last().setDockedShape(l);k.getDockers().last().setReferencePoint(h.refPoint);}}.bind(this));var f=this.otherEdges.noTargetEdges;f.each(function(l){var k=this.facade.getCanvas().getChildShapeByResourceId(l.edge);var h=this.facade.getCanvas().getChildShapeByResourceId(l.target);if(k&&h){k.getDockers().first().setDockedShape(h);k.getDockers().first().setReferencePoint(l.refPoint);}}.bind(this));},restoreDeletedMultipleEdges:function(){this.deletedEdges.each(function(h){var g=this.facade.getCanvas();var k=g.getChildShapeByResourceId(h.source);var l=g.getChildShapeByResourceId(h.target);var f=h.edge.getDockers();g.add(h.edge);if(f.first()){f.first().setDockedShape(k);f.first().setReferencePoint(h.sourceRefPoint);}if(f.last()){f.last().setDockedShape(l);f.last().setReferencePoint(h.targetRefPoint);}}.bind(this));},restoreLayoutedEdges:function(){this.layoutedEdgs.each(function(l){var k=this.facade.getCanvas();var m=k.getChildShapeByResourceId(l.source);var n=k.getChildShapeByResourceId(l.target);var h=k.getChildShapeByResourceId(l.id);var f=h.getDockers();if(f.first()){f.first().setDockedShape(m);f.first().setReferencePoint(l.sourceRefPoint);}if(f.last()){f.last().setDockedShape(n);f.last().setReferencePoint(l.targetRefPoint);}var g=h.dockers.findAll(function(o){return !o.isDocked();});g.each(function(o){h.removeDocker(o);});l.bendPoints.each(function(o){h.add(o);});}.bind(this));},restoreSubprocessTask:function(){var f=this.facade.getCanvas().getChildShapeByResourceId(this.openedSubprocessParent)||this.facade.getCanvas();f.add(this.openedSubprocess);if(this.attachedEvents){this.attachedEvents.each(function(g){this.openedSubprocess.add(g.shape);g.shape.getDockers().first().setDockedShape(this.openedSubprocess);g.shape.getDockers().first().setReferencePoint(g.refPoint);}.bind(this));}},rollback:function(){var f=new Ext.Template(ORYX.I18N.Subprocessing.Rollback).apply([this.subprocessName]);Ext.Msg.alert("Information",f,function(){this.deleteShapes(this.shapesToDelete);if(this.openedSubprocessWasDeleted){this.restoreSubprocessTask();}this.restoreNotAttachedNodes();this.restoreAttachedNotes();this.restoreDeletedEdges();this.restoreTargetSourceEdges();this.restoreDeletedMultipleEdges();this.restoreLayoutedEdges();this.facade.getCanvas().update();this.facade.setSelection(this.selectedShapes);}.bind(this)).setIcon(Ext.MessageBox.INFO);},getSingleCollapsedProcessName:function(g){var h=0;var k={};var f=this.getAllShapesToConsider(g);f.each(function(l){if(l instanceof ORYX.Core.Node&&l.getDockers().length==0){k=l;h++;}});if(h==1&&k.getStencil().id().endsWith("Subprocess")){return k.properties["oryx-name"];}return undefined;},getWindowForSubprocessing:function(m,l){var h=new Ext.form.TextField({width:175,style:"font-size:11px",value:(l!==undefined&&l.trim()!=="")?l:ORYX.I18N.Subprocessing.NewSubprocess});var k=new Ext.form.TextField({value:ORYX.I18N.Subprocessing.NewNameSubprocess,style:"background:transparent;opacity:1.0;width:100%;border:none;font-size:11px",readOnly:true,border:false});var f=new Ext.Panel({layout:"column",html:'<div style="padding-left: 12px; padding-right: 12px;padding-top:8px;padding-bottom:8px;" >'+ORYX.I18N.Subprocessing.Description+"</div>",bodyStyle:"background:none;border:none",items:[{width:165,items:[k],bodyStyle:"padding-top:10px;padding-left:8px;background:none;",border:false},{items:[h],bodyStyle:"padding-top:10px;background:none;",border:false}]});var o=new Ext.form.Checkbox({boxLabel:ORYX.I18N.Subprocessing.OpenSubprocess});var g=new Ext.Panel({items:[o],bodyStyle:"padding-top:10px;padding-left:12px;padding-bottom:10px",border:false});var n=new Ext.Window({width:370,modal:true,layout:"anchor",title:ORYX.I18N.Subprocessing.AutomaticSubprocess,items:[f,g],resizable:false,bodyStyle:"background-color:white",buttons:[{text:ORYX.I18N.Subprocessing.CreateSubprocess,handler:function(q){var p=h.getValue();if(p==undefined||p.trim()==""){p=ORYX.I18N.Subprocessing.NewSubprocess;}var r=o.getValue();this.subprocessName=p;n.body.mask(ORYX.I18N.Subprocessing.SubprocessCreated,"x-waiting-box");this.doSubprocessing(m,p,r);n.body.unmask();n.close();}.bind(this)},{text:ORYX.I18N.Subprocessing.Cancel,handler:function(p){n.close();}.bind(this)}]});return n;},checkSelections:function(h){var g=this.consideredShapes.findAll(function(p){return p instanceof ORYX.Core.Node;});var l=[];h.each(function(p){if(p instanceof ORYX.Core.Node){l=l.concat(p.getChildShapes(true));l.push(p);}});var f=this.getAdditionalEdges(g);var o=f.noSourceEdges;var k=f.noTargetEdges;if(o.length>1){return false;}if(k.length>1){return false;}if(o.length==1){var m=false;g.each(function(p){if(p.incoming.length<1){m=true;throw $break;}});if(m==true){return false;}}if(k.length==1){var m=false;g.each(function(p){if(p.outgoing.length<1){m=true;throw $break;}});if(m==true){return false;}}var n="";var m=false;g.each(function(p){var q=this.findParentPool(p);if(n==""){n=q;}else{if(n!=q){m=true;throw $break;}}}.bind(this));if(m==true){return false;}var m=false;l.each(function(p){var q=p.getStencil().id().split("#")[1];if(q=="Pool"||q=="Lane"||q=="VerticalPool"||q=="VerticalLane"){m=true;throw $break;}});if(m==true){return false;}return true;},findParentPool:function(f){if(f.parent){var g=f.parent;while(g&&!(g instanceof ORYX.Core.Canvas)){if(g.getStencil().id().endsWith("Pool")){return g.resourceId;}g=g.parent;}return g.resourceId;}},saveOtherEdges:function(h){var g=h.noTargetEdges;var f=h.noSourceEdges;this.otherEdges={};this.otherEdges.noSourceEdges=[];f.each(function(k){var l={};l.source=k.getDockers().last().getDockedShape().resourceId;l.edge=k.resourceId;l.refPoint=k.getDockers().last().referencePoint;this.otherEdges.noSourceEdges.push(l);}.bind(this));this.otherEdges.noTargetEdges=[];g.each(function(k){var l={};l.target=k.getDockers().first().getDockedShape().resourceId;l.edge=k.resourceId;l.refPoint=k.getDockers().first().referencePoint;this.otherEdges.noTargetEdges.push(l);}.bind(this));},saveShapesToDelete:function(f){this.shapesToDelete=[];this.shapesToDelete=this.shapesToDelete.concat(f);},saveShapesToAdd:function(f){this.shapesToAdd={};var h=f.findAll(function(k){return k instanceof ORYX.Core.Node;});var g=f.findAll(function(k){return k instanceof ORYX.Core.Edge;});this.shapesToAdd.nodes=[];h.each(function(k){var l={};l.node=k;l.parent=k.parent.resourceId;if(k.getDockers().length==0||(k.getDockers().length==1&&!k.getDockers().first().getDockedShape())){l.isAttached=false;}else{l.isAttached=true;l.dockerShape=k.getDockers().first().getDockedShape().resourceId;l.refPoint=k.getDockers().first().referencePoint;}this.shapesToAdd.nodes.push(l);}.bind(this));this.shapesToAdd.attEvents=[];this.shapesToAdd.edges=[];g.each(function(l){var n={};n.edge=l;var k=l.getDockers().first().getDockedShape();n.hasFirstDockedShape=(k!==undefined);if((k!==undefined)){n.source=l.getDockers().first().getDockedShape().resourceId;n.sourceRefPoint=l.getDockers().first().referencePoint;}var m=l.getDockers().last().getDockedShape();n.hasLastDockedShape=(m!==undefined);if(n.hasLastDockedShape){n.target=l.getDockers().last().getDockedShape().resourceId;n.targetRefPoint=l.getDockers().last().referencePoint;}this.shapesToAdd.edges.push(n);}.bind(this));},doSubprocessing:function(h,f,n){var m=this.getEdgesFromParent(this.consideredShapes);var l=this.consideredShapes;l=l.concat(m);var o=this.getAdditionalEdges(this.consideredShapes);this.deleteDuplicateEdges(o);l=l.concat(o.goodEdges);l=this.deleteEdges(l,o);l=l.uniq();var p=this.configureWhenOnlyOneSubProcess(l);l=p.shapes;var k=this.createNewModelWithShapes(l,f);if(n){this.showNewModelInTab(k);}var q=this.createCollapsedSubprocess(l,f,p.status,p.subprocessShape);this.saveShapesToDelete(q);var r=window.location.protocol+"//"+window.location.host+"/"+ORYX.CONFIG.SERVER_MODEL_HANDLER.replace("../","")+"/"+k;q.setProperty("oryx-entry",r);this.saveOtherEdges(o);var g=o.noSourceEdges.concat(o.noTargetEdges);this.saveLayoutedEdges(g);this.setOldEdges(q,o,p.existsAttachedEvents);this.saveShapesToAdd(l);if(p.existsAttachedEvents){this.saveAttachedEvents(p.attachedEvents);}this.deleteShapes(l);if(p.status){this.openedSubprocessWasDeleted=true;this.openedSubprocessParent=p.subprocessShape.parent.resourceId;this.openedSubprocess=p.subprocessShape;this.deleteShapes([p.subprocessShape]);if(p.existsAttachedEvents){this.setAttachedEvens(p,q);}}this.plugin.doLayout(g);this.facade.getCanvas().update();this.facade.setSelection(q);this.facade.updateSelection();},setAttachedEvens:function(g,f){g.attachedEvents.each(function(h){f.add(h.shape);h.shape.getDockers().first().setDockedShape(f);var l=(f.bounds.width()*h.refPoint.x)/g.subprocessShape.bounds.width();var k=(f.bounds.height()*h.refPoint.y)/g.subprocessShape.bounds.height();h.shape.getDockers().first().setReferencePoint({x:l,y:k});});},saveAttachedEvents:function(f){this.attachedEvents=[].concat(f);},configureWhenOnlyOneSubProcess:function(f){var h=0;var k={};f.each(function(n){if(n instanceof ORYX.Core.Node&&n.getDockers().length==0){k=n;h++;}});var m=[];if(h==1&&k.getStencil().id().endsWith("Subprocess")){var l=k.getChildShapes(true);f=f.without(k);f=[].concat(f,l);f=this.getAllShapesToConsider(f);var g=k.outgoing.findAll(function(n){return(n instanceof ORYX.Core.Node&&n.getDockers().length==1);});g.each(function(n){var o={};o.shape=n;o.parent=n.getDockers().first().getDockedShape().resourceId;o.refPoint=n.getDockers().first().referencePoint;m.push(o);f.remove(n);});}return{status:(h==1&&k.getStencil().id().endsWith("Subprocess")),subprocessShape:k,shapes:f,attachedEvents:m,existsAttachedEvents:(m.length!==0)};},saveLayoutedEdges:function(f){this.layoutedEdgs=[];f.each(function(h){var g={};g.id=h.resourceId;g.target=h.dockers.last().getDockedShape().resourceId;g.targetRefPoint=h.dockers.last().referencePoint;g.source=h.dockers.first().getDockedShape().resourceId;g.sourceRefPoint=h.dockers.first().referencePoint;g.bendPoints=h.dockers.findAll(function(k){return !k.isDocked();});this.layoutedEdgs.push(g);}.bind(this));},doRequest:function(f,k,g,h){b.execute(f,k,g,h);},shapesToJson:function(f){var g=f.map(function(l){return l.toJSON();});var h=f.map(function(l){return[].concat(l,l.getChildShapes(true)).pluck("resourceId");}).flatten();var k=function(l){(l||[]).each(function(m){if(m.outgoing){m.outgoing=m.outgoing.findAll(function(n){return h.include(n.resourceId);});}if(m.childShapes){k(m.childShapes);}});};k(g);return g;},deleteShapes:function(f){if(f){f.each(function(g){this.facade.deleteShape(g);}.bind(this));}},getCentralPointForShape:function(h,l){var g=(h.x+l.x)/2;var k=(h.y+l.y)/2;var f={};f.x=g;f.y=k;return f;},getCentralPointForShapes:function(k){var l=-1;var m=-1;var n=Number.MAX_VALUE;var g=Number.MAX_VALUE;k.each(function(o){var p=o.absoluteCenterXY();if(l<p.y){l=p.y;}if(m<p.x){m=p.x;}if(n>p.y){n=p.y;}if(g>p.x){g=p.x;}});var f={};f.x=g;f.y=n;var h={};h.x=m;h.y=l;return this.getCentralPointForShape(f,h);},getAllShapesToConsider:function(g){var f=[],m=g;var k=[];var h=this.facade.getCanvas(),n=this.facade.getRules();g=g.findAll(function(o){if(g.any(function(p){return p.hasChildShape(o);})){return true;}return n.canContain({containingShape:h,containedShape:o});});g.each(function(o){var q=g.any(function(r){return r.hasChildShape(o);});if(q){return;}f.push(o);if(o instanceof ORYX.Core.Node){var p=o.getOutgoingNodes();p=p.findAll(function(r){return !g.include(r);});f=f.concat(p);}}.bind(this));var l=this.facade.getCanvas().getChildEdges().select(function(o){if(f.include(o)){return false;}if(m.include(o)){return true;}if(o.getAllDockedShapes().size()===0){return false;}return o.getAllDockedShapes().all(function(p){return false;});});f=[].concat(f,l).uniq();return f;},getAdditionalEdges:function(g){var l=[];var f=[];g.each(function(y){if(y instanceof ORYX.Core.Edge){l.push(y.resourceId);}else{f.push(y.resourceId);y.incoming.each(function(z){if(z instanceof ORYX.Core.Edge){l.push(z.resourceId);}});y.outgoing.each(function(z){if(z instanceof ORYX.Core.Edge){l.push(z.resourceId);}});}}.bind(this));l=l.uniq();f=f.uniq();var v=[];var h=[];var o=[];var p=[];var k,s=false;var r,x,n,u,t,m={};l.each(function(y){u=this.facade.getCanvas().getChildShapeByResourceId(y);k=false;s=false;x=u.getDockers();firstDockerShape=x.first().getDockedShape();n=x.last().getDockedShape();if(firstDockerShape){t=x.first().getDockedShape().resourceId;if(t&&f.indexOf(t)>-1){s=true;}}else{s=true;}if(n){m=x.last().getDockedShape().resourceId;if(m&&f.indexOf(m)>-1){k=true;}}else{k=true;}if(s===true&&k===true){p.push(u);return;}if(s==false&&k==true){v.push(u);return;}if(s==true&&k==false){h.push(u);return;}o.push(u);}.bind(this));var q={};q.goodEdges=p.uniq();q.noSourceEdges=v.uniq();q.noTargetEdges=h.uniq();q.noTargetNoSourceEdges=o.uniq();return q;},deleteEdges:function(g,f){f.noSourceEdges.each(function(h){g.remove(h);});f.noTargetEdges.each(function(h){g.remove(h);});f.noTargetNoSourceEdges.each(function(h){g.remove(h);});return g;},deleteDuplicateEdges:function(f){this.deletedEdges=[];$H(f).each(function(m){var o=m.value;for(var h=0;h<o.length;h++){var n=[];for(var g=0;g<o.length;g++){if(h!==g){if(m.key=="noSourceEdges"){var l=o[h].dockers.first().getDockedShape().resourceId;var k=o[g].dockers.first().getDockedShape().resourceId;if(l&&k&&(l==k)){n.push(o[g]);}}if(m.key=="noTargetEdges"){var l=o[h].dockers.last().getDockedShape().resourceId;var k=o[g].dockers.last().getDockedShape().resourceId;if(l&&k&&(l==k)){n.push(o[g]);}}}}o=this.saveAndDeleteEdgesList(n,o);}}.bind(this));return f;},saveAndDeleteEdgesList:function(g,f){g.each(function(h){f.remove(h);var k={};k.source=h.dockers.first().getDockedShape().resourceId;k.target=h.dockers.last().getDockedShape().resourceId;k.sourceRefPoint=h.dockers.first().referencePoint;k.targetRefPoint=h.dockers.last().referencePoint;k.edge=h;this.deletedEdges.push(k);this.facade.deleteShape(h);}.bind(this));return f;},getEdgesFromParent:function(k){var f=k;var g=[];f.each(function(n){if(n instanceof ORYX.Core.Node){g=g.concat(n.getChildShapes(true));}});g=g.concat(f).uniq();var m=[];f.each(function(n){if(n instanceof ORYX.Core.Node){var o=n.outgoing.findAll(function(p){return(p instanceof ORYX.Core.Node);});o.each(function(p){m.push(p);});}});m=m.uniq();g=g.concat(m);var h=this.facade.getCanvas().getChildEdges();var l=[];h.each(function(p){if(p instanceof ORYX.Core.Edge){var o=p.dockers.first().getDockedShape();var n=p.dockers.last().getDockedShape();if(o&&n&&g.include(o)&&g.include(n)){l.push(p);}}});return l;},setOldEdges:function(g,h,f){h.noSourceEdges.each(function(k){if(!f){k.getDockers().last().setDockedShape(g);k.getDockers().last().setReferencePoint(g.bounds.midPoint());}else{if(k.getDockers().last().getDockedShape().getDockers().length!==1){k.getDockers().last().setDockedShape(g);k.getDockers().last().setReferencePoint(g.bounds.midPoint());}}});h.noTargetEdges.each(function(k){if(!f){k.getDockers().first().setDockedShape(g);k.getDockers().first().setReferencePoint(g.bounds.midPoint());}else{if(k.getDockers().first().getDockedShape().getDockers().length!==1){k.getDockers().first().setDockedShape(g);k.getDockers().first().setReferencePoint(g.bounds.midPoint());}}});},findUniqueParent:function(g){var h=this.getAllShapesToConsider(g);var l="FoundNoParent";var f=true;var k=undefined;h.each(function(m){if(m.parent){if(l=="FoundNoParent"){l=m.parent.resourceId;k=m.parent;}else{if(m.parent.resourceId!=l){f=false;}}}});if(l=="FoundNoParent"||f==false){return this.facade.getCanvas();}else{return k;}},getParentsDiff:function(g){var k=g.parent;var h=0;var f=0;while(k&&!(k instanceof ORYX.Core.Canvas)){var m=k.bounds.a;h+=m.x;f+=m.y;k=k.parent;}var l={};l.x=h;l.y=f;return l;},getAllowedParent:function(l,f,g,o){var m=[].concat(this.facade.getCanvas().getAbstractShapesAtPosition(f).reverse().findAll(function(s){return s instanceof ORYX.Core.Node&&!g.any(function(r){return s.isParent(r);});}),this.facade.getCanvas(),this.findUniqueParent(g)).uniq().compact();if(o){m.push(o);}var h=this.facade.getCanvas().getStencil().namespace(),n=this.facade.getStencilSets()[h],p=n.stencil(h+""+l);for(var k=0,q=m.length;k<q;++k){if(this.facade.getRules().canContain({containingShape:m[k],containedStencil:p})){return m[k];}}return undefined;},createCollapsedSubprocess:function(h,g,l,p){var q="CollapsedSubprocess";var f=this.getCentralPointForShapes(h);var o;if(l){if(p&&p.getStencil().id().endsWith("EventSubprocess")){q="CollapsedEventSubprocess";}if(p){o=this.getAllowedParent(q,f,[].concat(h,p),p.parent);}}if(!o){o=this.getAllowedParent(q,f,h);}if(!o){return undefined;}var m={type:this.facade.getCanvas().getStencil().namespace()+q,namespace:this.facade.getCanvas().getStencil().namespace(),parent:o};var n=this.facade.createShape(m);var k=this.getParentsDiff(n);n.bounds.centerMoveTo({x:f.x-k.x,y:f.y-k.y});n.setProperty("oryx-name",g);return n;},showNewModelInTab:function(g){var f=window.location.protocol+"//"+window.location.host+"/"+ORYX.CONFIG.SERVER_MODEL_HANDLER.replace("../","")+"/"+g;window.setTimeout(function(){window.open(ORYX.CONFIG.SERVER_EDITOR_HANDLER+"?id="+g);},100);},moveShapesToTop:function(g){var f=Number.MAX_VALUE;var l=Number.MAX_VALUE;var h={x:50,y:50};g.each(function(m){if(m instanceof ORYX.Core.Node){var n=m.bounds.upperLeft();if(f>n.x){f=n.x;}if(l>n.y){l=n.y;}}});if(f<h.x){f=h.x;}if(l<h.y){l=h.y;}f=f-h.x;l=l-h.y;g.each(function(n){if(n instanceof ORYX.Core.Node){if(n.getDockers().length==1){var o=n.bounds.center();n.getDockers().first().bounds.centerMoveTo({x:o.x-f,y:o.y-l});}else{var o=n.bounds.center();n.bounds.centerMoveTo({x:o.x-f,y:o.y-l});}}if(n instanceof ORYX.Core.Edge){var m=n.dockers.findAll(function(p){return !p.isDocked();});m.each(function(p){var q=p.bounds.center();p.bounds.centerMoveTo({x:q.x-f,y:q.y-l});});}});var k={};k.shapes=g;k.minY=l;k.minX=f;return k;},moveShapesBack:function(g,f,h){g.each(function(l){if(l instanceof ORYX.Core.Node){var m=l.bounds.center();l.bounds.centerMoveTo({x:m.x+f,y:m.y+h});}if(l instanceof ORYX.Core.Edge){var k=l.dockers.findAll(function(n){return !n.isDocked();});k.each(function(n){var o=n.bounds.center();n.bounds.centerMoveTo({x:o.x+f,y:o.y+h});});}});return g;},createNewModelWithShapes:function(g,n){var l=[];g.each(function(u){if(u instanceof ORYX.Core.Node){var t=u.absoluteBounds().center();var v=u.bounds.center();l.push(v);u.bounds.centerMoveTo(t);}});var p=this.moveShapesToTop(g);g=p.shapes;var r=this.facade.getStencilSets()[this.facade.getCanvas().getStencil().namespace()];var q=this.facade.getModelMetaData().parent;var o=this.facade.getModelMetaData().model.ssextensions||[];var f=ORYX.CONFIG.SERVER_EDITOR_CREATE_HANDLER+"?stencilset="+r.namespace().replace(/#/g,"%23")+"&directory="+q;var s;this.doRequest(f,function(u,t){s=t.getResponseHeader("Location").split("=").last();});var k={bounds:{upperLeft:{x:0,y:0},lowerRight:this.facade.getCanvas().bounds.lowerRight()},childShapes:this.shapesToJson(g),properties:{},resourceId:"canvas",ssextensions:o,stencil:{id:this.facade.getCanvas().getStencil().idWithoutNs()},stencilset:{url:r._source,namespace:r.namespace()}};var h={};h.name=n;h.parent=q;h.json_xml=Object.toJSON(k);h.id=s;h.type=r.title();h.description="";h.comment="";h.namespace=r.namespace();this.doRequest(ORYX.CONFIG.SERVER_MODEL_HANDLER,function(){},h,"post");g=this.moveShapesBack(g,p.minX,p.minY);var m=0;g.each(function(t){if(t instanceof ORYX.Core.Node){t.bounds.centerMoveTo(l[m]);m++;}});return s;}});var c=new e(this.facade,d,this);this.facade.executeCommands([c]);}});};if("undefined"===typeof Signavio){var Signavio={};}if("undefined"===typeof Signavio.Plugins){Signavio.Plugins={};}new function(){Signavio.Plugins.GoogleTranslate=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;var c=this.facade.getCanvas().getLanguage(),b=$H(ORYX.CONFIG.MULTI_LANGUAGES||{}),d=ORYX.CONFIG.EXPLORER_PATH+"/src/img/flags/"+(b[c]);this.facade.offer({"name":Signavio.I18N.GoogleTranslate.btnTitle,"group":"ZZZZZZZZZZGroup.Multilanguage","dropDownGroupIcon":d,"index":9,"toggle":false,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/bing.png","functionality":this.doTranslate.bind(this),"separatedBefore":true,"iconCls":"x-menu-item-google-translation"});},doTranslate:function(){var c=this.facade.getCanvas().getLanguage(),e=$A($H(ORYX.CONFIG.MULTI_LANGUAGES||{})).pluck("key").without(c);var a=this.facade.getSelection().length==0?this.facade.getCanvas().getChildShapes(true):this.facade.getSelection();var d={shapes:{},source:e.first(),target:c};a.each(function(f){var g=this.getOriginTranslate(f,c,e);if(g){d.shapes[f.resourceId]=g;}}.bind(this));var b=$H(d.shapes).keys().length;if(0===b){Ext.Msg.alert(Signavio.I18N.GoogleTranslate.btnTitle,Signavio.I18N.GoogleTranslate.labelNoElements).setIcon(Ext.Msg.INFO).getDialog().syncSize();}else{Ext.Msg.confirm(Signavio.I18N.GoogleTranslate.btnTitle,Signavio.I18N.GoogleTranslate.labelConfirm,function(f){if(f=="yes"){this.sendRequest(d,this.setTranslation.bind(this,a,d,c));}}.bind(this)).setIcon(Ext.Msg.INFO).getDialog().syncSize();}},setTranslation:function(b,a,c,e){var d=ORYX.Core.Command.extend({construct:function(f,h,g){this.shapes=f;this.translation=h;this.language=g;this.origin={shapes:{}};},execute:function(){this.setAttributes(this.translation,this.executedFirst===undefined);this.executedFirst=false;},rollback:function(){this.setAttributes(this.origin);},setAttributes:function(g,f){var h=g.shapes;this.shapes.each(function(k){var l=h[k.resourceId];if(l){$H(l).each(function(m){var n=m.key;if(this.language!==ORYX.CONFIG.MULTI_LANGUAGES_DEFAULT){n+="_"+c;}if(f){if(!this.origin.shapes[k.resourceId]){this.origin.shapes[k.resourceId]={};}this.origin.shapes[k.resourceId][m.key]=k.properties["oryx-"+n];}k.setProperty("oryx-"+n,m.value);}.bind(this));}}.bind(this));}});this.facade.executeCommands([new d(b,e,c)]);},getOriginTranslate:function(c,e,b){var a=undefined;var d=c.getStencil().properties();d.each(function(l){if(l.origin()===l&&l.language()&&l.refToView().length>0){var k=d.findAll(function(n){return n.origin()===l;});var m=k.find(function(n){return n.language()==e;});var f=k.find(function(n){return b.include(n.language());});if(!m||!f){return;}var h=c.properties[m.prefix()+"-"+m.id()];var g=c.properties[f.prefix()+"-"+f.id()];if(!h&&g){if(!a){a={};}a[l.id()]=g;}}});return a;},sendRequest:function(d,c){var e=Ext.Msg.wait(Signavio.I18N.GoogleTranslate.labelWaiting,Signavio.I18N.GoogleTranslate.btnTitle);var a=function(f){Ext.Msg.alert(Signavio.I18N.GoogleTranslate.btnTitle,f||Signavio.I18N.GoogleTranslate.labelFailure.replace("[supportMailAdresse]",this.facade.getModelMetaData().supportMailAddress)).setIcon(Ext.Msg.WARNING).getDialog().syncSize();};var b={};$H(d).each(function(f){if("object"==typeof f.value){b[f.key]=Object.toJSON(f.value);}else{b[f.key]=f.value;}});new Ajax.Request("/p/translate",{method:"post",parameters:b,requestHeaders:{"Accept":"application/json","Content-Type":"charset=UTF-8"},asynchronous:false,onSuccess:function(h){var f;try{f=h.responseText.evalJSON();}catch(g){a(Signavio.I18N.GoogleTranslate.labelFailure.replace("[supportMailAdresse]",this.facade.getModelMetaData().supportMailAddress),h);}if(f&&f.message!==undefined){a(f.message,h);}else{if(f&&c instanceof Function){c(f,h);window.setTimeout(function(){e.hide();},100);}}}.bind(this),onFailure:function(f){if(a instanceof Function){a(Signavio.I18N.GoogleTranslate.labelFailure.replace("[supportMailAdresse]",this.facade.getModelMetaData().supportMailAddress),f);}}.bind(this)});}});}();if("undefined"===typeof Signavio){var Signavio={};}if("undefined"===typeof Signavio.Plugins){Signavio.Plugins={};}(function(){Signavio.Plugins.CoMMed=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanges.bind(this));},handlePropertyChanges:function(e,d){var d=e.elements.first();if(!d||!(d.getStencil().id().endsWith("#Pool")||d.getStencil().id().endsWith("#Lane"))){return;}if(!this.facade.getStencilSets().values()[0].extensions()["http://oryx-editor.org/stencilsets/extensions/carestation#"]){return;}if(e.key!="oryx-type"){return;}if(!this.facade.isExecutingCommands()){return;}var b="oryx-name",a="Carestation",c=this;if(e.value!="system"){a=Ext.ux.propertyeditor.ComMedRoleMapping.prototype.renderer(d.properties["oryx-commedrolemapping"]);}var f=ORYX.Core.Command.extend({construct:function(){this.shape=d;this.key=b;this.value=a;this.oldValue=this.shape.properties[b];},execute:function(){this.shape.setProperty(this.key,this.value);this.update();},rollback:function(){this.shape.setProperty(this.key,this.oldValue);this.update();},update:function(){c.facade.setSelection([]);c.facade.setSelection(this.shape);}});this.facade.executeCommands([new f()]);}});}());if(!Signavio){var Signavio={};}if(!Signavio.Plugins){Signavio.Plugins={};}(function(){var l={};var h="http://www.signavio.com/stencilsets/processdoctemplate#";var d=h+"Header";var g=h+"Footer";var p=h+"MetaBlock";var m=h+"TOCPart";var q=[d,g,p,m];var b="global";var r="diagram";var k="process";var f="ListElements";var a="TableElements";var e="#808080";var o=function(s){if(!(s instanceof Array)){s=[s];}s=s.map(function(t){return h+t;});return function(t){return t&&s.include(t.getStencil().id());};};var c=[1000,900,500,400,100,90,50,40,10,9,5,4,1];var n=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"];Signavio.Plugins.ProcessdocTemplateSupport=Clazz.extend({facade:undefined,construct:function(s){this.rescueList=[];this.facade=s;this.facade.registerOnEvent("layout.processdoctemplate.template",this.handleLayoutTemplate.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.page.cover",this.handleLayoutCover.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.page.toc",this.handleLayoutTOC.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.page.following",this.handleLayoutPage.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.section",this.handleLayoutSection.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.table",this.handleLayoutTable.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.list",this.handleLayoutList.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.header_footer",this.handleLayoutHeaderFooter.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.column.attribute",this.handleColumnAttributeChange.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.row.attribute",this.handleRowAttributeChange.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.process.attribute",this.handleLayoutProcessAttribute.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.meta",this.handleLayoutMeta.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,this.handleShapeAdd.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEREMOVED,this.handleShapeRemove.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.handleEditorLoad.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_ENABLE,function(){this.cutCopyMode=true;}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_DISABLE,function(){this.cutCopyMode=false;}.bind(this));},handleShapeAdd:function(t){var s=t.shape;if(this.cutCopyMode&&s.parent===this.facade.getCanvas()){this.rescueList.push(s);}this.translate(s);if(this.isHeaderFooterAttribute(s)){s.getLabels().each(function(u){u.registerOnChange(this.handleLayoutAttribute.bind(this,s,u));}.bind(this));}else{if(this.isTOC(s)){this.handleTOCAdd(s);}else{if(this.isText(s)){s.getLabels().each(function(u){u.registerOnChange(this.layoutFreeTextLabels.bind(this,s,u));}.bind(this));}}}this.restoreFocus(s);},handleShapeRemove:function(t){var s=t.shape;if(this.isSection(s)){this.requestIndexRefresh(s,true);}},handlePropertyChanged:function(u){var s=u.elements.first();switch(u.name){case"oryx-text":if(this.isText(s)){this.handleTextChange(s,u);}break;case"oryx-includeintoc":if(!u.value){s.getChildShapes(false,function(v){if(this.isSection(v)&&v.getProperty("includeintoc")){v.setProperty("includeintoc",false);}}.bind(this));}else{var t=this.findElement(s.parent,this.isSection);if(t&&!t.getProperty("includeintoc")){s.setProperty("includeintoc",false);}}this.facade.getCanvas().update();break;case"oryx-preview":if(this.isTOC(s)){window.setTimeout(function(){s.setProperty("color","white");s.setProperty("color",e);},1);}break;}this.restoreFocus(this.facade.getSelection());},handleEditorLoad:function(u){this.enableTableLayouting();this.enableCustomContainment();this.enableHeaderFooterConstraints();this.enableHeaderFooterAutoCreate();this.enableTOCPreview();this.enableTableIteratorExtension();this.enableIteratorMorphing();var s=this.facade.getCanvas();var t=s.getChildShapes();if(t.size()===0){this.addElement(s,"CoverPage");this.addElement(s,"TableOfContents");this.addElement(s,"FollowingPage");s.update();this.updateTOC();}this.updateSectionNumbering();},handleStyleChange:function(t){var u=this.findElement(t,this.isPage);var x=u.getChildShapes().find(this.isHeader);var v=u.getChildShapes().find(this.isFooter);var s=function(y){y.getChildShapes().select(this.isPageNumber).each(function(z){if(z!==t){this.applyProperties(z,t.properties);}}.bind(this));}.bind(this);if(x){s(x);}if(v){s(v);}this.restoreFocus(this.facade.getSelection());},handleTOCAdd:function(s){var t=this.facade.getCanvas().getChildShapes().find(this.isTOC);if(t&&s!==t){this.removeSilently(s,t);}if(!t){t=s;}t.setProperty("color",e);},handleLayoutTemplate:function(s){var D=s.shape;var u=D.getChildShapes().select(this.isPage).sortBy(function(x){return x.bounds.upperLeft().y;});var v=this.facade.getCanvas().getZoom();var A=50;var B=50;var z=30;var C=0;u.each(function(x){x.bounds.moveTo(B,A);A+=x.bounds.height()+z;if(x.bounds.width()>C){C=x.bounds.width();}}.bind(this));var t=this.facade.getCanvas();t.setSize({width:(C+2*B)*v,height:(A+20)*v});},handleLayoutCover:function(t){var u=t.shape;var s=u.getChildShapes();var x=s.select(this.isMeta);var v=30;var y=u.getProperty("alignment");u._update(true);u.getLabels().each(function(z){if(y==="left"){z.setX(v+z.getWidth()/2);}else{if(y==="center"){z.setX(u.bounds.center().x-u.bounds.upperLeft().x);}else{if(y==="right"){z.setX(u.bounds.width()-z.getWidth()/2-v);}}}this.updateLabel(z);}.bind(this));this.layoutHeaderFooter(u);this.moveMetaBlocks(u,x);},handleLayoutTOC:function(s){var t=s.shape;this.layoutHeaderFooter(t);if(!t.getProperty("preview")){this.cleanTOC(t);t.setProperty("description",Signavio.I18N.ProcessTemplates.tocPreview);}},handleLayoutPage:function(u){var v=u.shape;var t=v.getChildShapes();t=t.select(function(y){return !q.include(y.getStencil().id());}).sortBy(function(y){return y.bounds.upperLeft().y;});var x=65;t.each(function(z){var y=30;z.bounds.moveTo((v.bounds.width()-z.bounds.width())/2,x);if(this.isIterator(z)&&z.getProperty("includeinnumbering")){y+=20;}x+=z.bounds.height()+y;}.bind(this));var s=v.bounds.upperLeft();v.bounds.set(s,{x:s.x+v.bounds.width(),y:s.y+Math.max(x+35,v.minimumSize.height)});this.layoutHeaderFooter(v);},handleLayoutSection:function(u){var v=u.shape;var t=v.getChildShapes().sortBy(function(y){return y.bounds.upperLeft().y;});var x=30;t.each(function(z){var y=30;z.bounds.moveTo((v.bounds.width()-z.bounds.width())/2,x);if(this.isIterator(z)&&z.getProperty("includeinnumbering")){y+=20;}x+=z.bounds.height()+y;}.bind(this));var s=v.bounds.upperLeft();v.bounds.set(s,{x:s.x+v.bounds.width(),y:s.y+Math.max(x,v.minimumSize.height)});this.facade.updateSelection();if(v.parent!==this.facade.getCanvas()){this.requestIndexRefresh(v);}},handleLayoutTable:function(s){var C=this.findElement(s.shape,this.isTable);if(!C){return;}var u=this.flattenElement(C);this.restoreVisibleOrder(C,u);var z=u.select(this.isColumn).sortBy(function(x){if(this.isIndexColumn(x)){return -1;}return x.bounds.upperLeft().x;}.bind(this));var D=u.select(this.isRow).sortBy(function(x){return x.bounds.upperLeft().y;});if(C.getProperty("showheader")&&D.first()){D.first().setProperty("bgcolor","none");}if(C.getProperty("showfooter")&&D.last()){D.last().setProperty("bgcolor","none");}var v=z.findAll(this.isIndexColumn);var t=this.computeColumnWidth(C,z,v);var B=0;var A=D.length>0?0:C.minimumSize.height;D.each(function(x){x.bounds.set({a:{x:0,y:A},b:{x:C.bounds.width(),y:A+x.bounds.height()}});A+=x.bounds.height();});z.each(function(y){var x=(v.include(y)?y.bounds.width():t);if(y.getProperty("width")>0){x=(C.bounds.width()*y.getProperty("width"))/100;}y.bounds.set({a:{x:B,y:0},b:{x:B+x,y:A}});B+=y.bounds.width();});this.resize(C,C.bounds.width(),A);this.updateTable(C,D,z);this.facade.getCanvas().update();},handleLayoutTablePlain:function(v){var u=this.findElement(v.shape,this.isTable);if(!u){return;}var s=this.flattenElement(u);var x=s.find(this.isRow);var t=s.find(this.isColumn);if(!x){this.addRows(u,1);}if(!t){this.addColumns(u,1);}this.handleLayoutTable(v);},handleTextChange:function(s,t){s.setProperty("hiddenText",t.value);s._update(true);},layoutFreeTextLabels:function(s,t){this.resize(s,s.bounds.width(),t.getHeight());this.facade.getCanvas().update();},handleLayoutList:function(s){var u=this.findElement(s.shape,this.isList);if(!u){return;}var x=30;var v=10;var t=this.flattenElement(u).sortBy(function(y){return y.bounds.upperLeft().y;});t.each(function(z,y){z.bounds.set(0,x,u.bounds.width(),x+z.bounds.height());x+=z.bounds.height()+v;}.bind(this));u.bounds.set(u.bounds.upperLeft(),{x:u.bounds.lowerRight().x,y:u.bounds.upperLeft().y+Math.max(75,x+60)});u._update();},updateLabel:function(s){s.suspendEvents(true);s.update(true);},handleLayoutHeaderFooter:function(v){var t=v.shape;var x=30;var s={left:[],center:[],right:[]};if(t.getProperty("style")!=="none"){t.getChildShapes().each(function(y){this.removeSilently(y,t);}.bind(this));return;}t.getChildShapes().each(function(z){var y=this.getDistances(t,z);if((y.left<y.center)&&(y.left<y.right)){s.left.push({el:z,x:x,position:"left"});}else{if((y.right<y.center)&&(y.right<y.left)){s.right.push({el:z,x:t.bounds.width()-x-z.bounds.width(),position:"right"});}else{s.center.push({el:z,x:t.bounds.center().x-z.bounds.width()/2,position:"center"});}}}.bind(this));var u={y:10,maxY:30,padding:20};this.placeInRows(s.left,u);this.placeInRows(s.center,u);this.placeInRows(s.right,u);},handleColumnAttributeChange:function(x){var v=x.shape;if(this.isMultiColumn(v)){this.handleMultiColumnAttributeChange(v);return;}var t=(v.getProperty("Attributes")||"{}").evalJSON(true);var s=(t.items||[]).map(function(z){return z.title;}).uniq();var y;if(s.size()===0){var u=t.config||{};if(u.selectName){y=Signavio.I18N.ProcessTemplates.name;}else{if(u.selectDescription){y=Signavio.I18N.ProcessTemplates.description;}else{y=Signavio.I18N.ProcessTemplates.processTableAttributeEmpty;}}}else{y=s.first();}v.setProperty("attribute",y);},handleMultiColumnAttributeChange:function(v){var t=(v.getProperty("Attributes")||"{}").evalJSON(true);var s=(t.items||[]).map(function(y){return y.title;}).uniq();var x;if(s.size()===0){var u=t.config||{};if(u.allAttributes){x=Signavio.I18N.ProcessTemplates.allAttributes;}else{if(u.ownAttributes){x=Signavio.I18N.ProcessTemplates.ownAttributes;}else{x=Signavio.I18N.ProcessTemplates.processTableAttributeEmpty;}}}else{x=Signavio.I18N.ProcessTemplates.customAttributes;}v.setProperty("title",v.getProperty("title")||x);},handleRowAttributeChange:function(s){var B=s.shape;var A;var v=(B.getProperty("Attributes")||"{}").evalJSON(true);var z=(v.items||[]).map(function(C){return C.title;}).uniq();var u=2;if(z.size()>u){var t=z.size()-u;z=z.slice(0,u);var x=new Template(Signavio.I18N.ProcessTemplates.andMore);A=z.join(", ")+" "+x.evaluate({times:t});}else{if(z.size()>0){A=z.join(", ");}else{var y=v.config||{};if(y.selectName){A=Signavio.I18N.ProcessTemplates.name;}else{if(y.selectDescription){A=Signavio.I18N.ProcessTemplates.description;}else{if(y.allAttributes){A=Signavio.I18N.ProcessTemplates.allAttributes;}else{if(y.ownAttributes){A=Signavio.I18N.ProcessTemplates.ownAttributes;}else{A=Signavio.I18N.ProcessTemplates.processTableAttributeEmpty;}}}}}}B.setProperty("row-title",A);B._update(true);},handleLayoutProcessAttribute:function(A){var u=A.shape;var t=(u.getProperty("Attributes")||"{}").evalJSON(true);var y=Signavio.I18N.ProcessTemplates.processAttributeEmpty;if(this.isMultiDiagramAttribute(u)){y=Signavio.I18N.ProcessTemplates.processAttributeMultiEmpty;}var z=10;var s=t.items||[];var x=t.config||{};if(s.size()>0){if(s.size()>=z){y=s.slice(0,z).map(function(B){return B.title;}).uniq().join(", ");var v=new Template(Signavio.I18N.ProcessTemplates.andMore);y+=" "+v.evaluate({times:(s.size()-z)});}else{y=s.map(function(B){return B.title;}).uniq().join(", ");}}else{if(x.allAttributes){y=Signavio.I18N.ProcessTemplates.allAttributes;}else{if(x.ownAttributes){y=Signavio.I18N.ProcessTemplates.ownAttributes;}else{if(x.selectName){y=Signavio.I18N.ProcessTemplates.name;}else{if(x.selectDescription){y=Signavio.I18N.ProcessTemplates.description;}}}}}u.setProperty("valueList",y);},enableHeaderFooterAutoCreate:function(){this.facade.getCanvas().getChildShapes(false,function(s){if(this.isPage(s)){s.extended=true;}}.bind(this));this.facade.registerOnEvent("layout.processdoctemplate.page.generic",function(s){this.createHeaderAndFooter(s.shape);}.bind(this));},enableIteratorMorphing:function(){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,function(x){var s=x.elements.first();if(x.name==="oryx-displayas"){if(((this.isTable(s)||this.isList(s)))&&this.isDiagramContent(s)){var z=this.isTable(s)?a:f;var y=this.isTable(s)?f:a;if(!this.restoreMap){this.restoreMap={};}if(s.parent){var t=this.morph(s,z,y,function(D,A,C){var B=C.bounds;A.bounds.set({a:{x:B.a.y,y:B.a.x},b:{x:B.b.x,y:B.a.x+this.isTable(D)?D.bounds.height():A.bounds.height()}});window.setTimeout(function(){if(this.isListRow(A)&&A.hasProperty("row-title")){this.handleRowAttributeChange({shape:A});}}.bind(this),200);}.bind(this));if(s.getProperty("showNumbering")){t.setProperty("showNumbering",false);t.setProperty("showNumbering",true);}else{t.setProperty("showNumbering",true);t.setProperty("showNumbering",false);}this.replace(s.parent,s,t);this.restoreMap[s.id]={oldShape:s,newShape:t};}else{if(this.restoreMap[s.id]){var v=this.restoreMap[s.id];var u=v.newShape.parent;this.replace(u,v.newShape,v.oldShape);delete this.restoreMap[s.id];}}}}}.bind(this));},replace:function(t,u,s){t.remove(u);t.add(s);this.facade.getCanvas().update();this.restoreFocus(s,true);},morph:function(u,y,x,v){v=v instanceof Function?v:Ext.emptyFn;var s=this.createElement(x);u.getChildShapes(false,function(C){var B=x+C.getStencil().id().replace(h+y,"");try{var z=this.addElement(s,B);this.copyProperties(C,z);v(s,z,C);}catch(A){}}.bind(this));this.copyProperties(u,s);var t=u.bounds.upperLeft();s.bounds.set(t,{x:t.x+s.bounds.width(),y:t.y+s.bounds.height()});return s;},copyProperties:function(t,s){var u=$H(t.properties).merge(t.overflowProps||{}).toJSON().evalJSON();var v=this.applyProperties(s,u);s.overflowProps=v;},addCorrectShape:function(s){var t=s.parent;if(this.isTable(t)){s.hide();if(!this.added){this.added=[];}if(this.added.include(s.id)){return;}this.added.push(s.id);var u=this.createMorphCommand(s,t);this.facade.executeCommands([new u(this.facade)]);}},createMorphCommand:function(s,t){var u=this;return ORYX.Core.Command.extend({construct:function(v){this.facade=v;this.newShape=u.morph(s,s.getStencil().idWithoutNs(),s.getStencil().idWithoutNs().replace(f,a));},execute:function(){window.setTimeout(function(){t.remove(s,true);var x=s.bounds.upperLeft();var v=this.newShape.bounds.lowerRight();this.newShape.bounds.set({x:x.x,y:0},{x:x.x+v.x,y:v.y});t.add(this.newShape,undefined,true);this.newShape._update(true);this.facade.getCanvas().update(true);u.restoreFocus(this.newShape);}.bind(this),1);},rollback:function(){t.remove(this.newShape,true);t.add(s,undefined,true);}});},enableTableIteratorExtension:function(){var s=function(t){return function(u){u.bounds.moveTo(t,0);};};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,function(u){var t=u.shape;if(this.isListRow(t)){this.addCorrectShape(t);}if(this.isTable(t)&&this.isDiagramContent(t)){if(t.getChildShapes().size()===0){this.addElement(t,"TableElementsRoles",s(2)),this.addElement(t,"TableElementsAttribute",function(v){s(1)(v);v.setProperty("attributes",$H({items:[],config:{selectName:true}}).toJSON());v.setProperty("title",Signavio.I18N.ProcessTemplates.activityName);});this.addElement(t,"TableElementsIndex",s(0));this.restoreFocus(t,true);}}}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,function(v){var t=v.elements.first();if(this.isTable(t)&&this.isDiagramContent(t)){if(v.name==="oryx-shownumbering"){if(v.value){this.addElement(t,"TableElementsIndex",s(-1));}else{var u=t.getChildShapes().find(this.isIndexColumn);if(u){t.remove(u);}}}}}.bind(this));},enableTOCPreview:function(){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,function(t){var s=t.shape;if(this.isTOC(s)){this.updateTOC(s);}}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,function(t){var s=t.elements.first();switch(t.name){case"oryx-title":if(this.isSection(s)){this.updateTOC(s);}break;case"oryx-preview":if(s.getProperty("preview")){this.updateTOC(s);}}}.bind(this));},enableHeaderFooterConstraints:function(){this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,function(t){var s=t.elements.first();if(this.isHeaderFooterAttribute(s)&&this.isPageNumber(s)){this.handleStyleChange(s);}}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,function(t){var s=t.shape;if(this.isHeader(s)||this.isFooter(s)){this.handleHeaderFooterAdd(s);}}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BEFORE_REMOVE,function(t){var s=t.elements.first();if(this.isFooter(s)||this.isHeader(s)){t.cancelled=true;}}.bind(this));},createFakeShape:function(t){if(t.containedShape){var s=t.containedShape;return{getStencil:s.getStencil.bind(s),getChildShapes:s.getChildShapes.bind(s),parent:t.containingShape};}return{getStencil:function(){return t.containedStencil;},parent:t.containingShape};},checkAll:function(t,u,s){if(t.getChildShapes instanceof Function){if(s(t)){var v=true;t.getChildShapes().each(function(x){v=v&&this.checkContainment(this.createFakeShape({containedShape:x,containingShape:u}));if(!v){throw $break;}v=v&&this.checkAll(x,u,s);}.bind(this));return v;}return false;}return s(t);},checkContainment:function(s){if(this.isSection(s)){return this.checkAll(s,s,this.sectionContainmentAllowed.bind(this));}else{if(this.isProcessContent(s)){return this.checkAll(s,s,this.processContainmentAllowed.bind(this));}else{if(this.isDiagramInformation(s)){return this.checkAll(s,s,this.diagramInformationContainmentAllowed.bind(this));}else{if(this.isHeaderFooterAttribute(s)){if(s.parent.getProperty("style")=="none"){return true;}return false;}else{if(this.isTOC(s)){return !this.shapeExists(this.facade.getCanvas(),this.isTOC);}else{if(this.isCoverPage(s)){return !this.shapeExists(this.facade.getCanvas(),this.isCoverPage);}}}}}}return true;},shapeExists:function(t,s){return !!t.getChildShapes().find(s);},enableCustomContainment:function(){var t=ORYX.Core.StencilSet.Rules.prototype.canContain;var s=this;ORYX.Core.StencilSet.Rules.prototype.canContain=function(v){if(t.call(this,v)){var u=s.createFakeShape(v);return s.checkContainment(u);}return false;};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEADDED,function(v){var u=v.shape;if(this.isProcessContent(u)){this.handleProcessContentAdd(u);}else{if(this.isDiagramInformation(u)){this.handleDiagramInformationAdd(u);}}}.bind(this));},enableTableLayouting:function(){this.facade.registerOnEvent("layout.processdoctemplate.table.plain",this.handleLayoutTablePlain.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,function(s){switch(s.name){case"oryx-rows":this.handleRowChange(s);break;case"oryx-columns":this.handleColumnChange(s);break;}}.bind(this));},handleHeaderFooterAdd:function(s){var u=s.parent;var t;if(this.isHeader(s)){t=u.getChildShapes().find(this.isHeader);}else{t=u.getChildShapes().find(this.isFooter);}if(t&&t!==s){this.removeSilently(s,t);}},handleDiagramInformationAdd:function(t){var s=function(u){if(this.isDiagramIterator(u)){t.setProperty("scope",r);return true;}else{if(u===this.facade.getCanvas()){t.setProperty("scope",b);}}};return this.containmentAllowed(t,s.bind(this));},diagramInformationContainmentAllowed:function(t){var s=function(u){if(this.isDiagramIterator(u)){return true;}else{if(this.facade.getCanvas()===u){throw l;}}};return this.containmentAllowed(t,s.bind(this));},handleProcessContentAdd:function(t){var s=Ext.emptyFn;if(this.isDiagramContent(t)){s=function(u){if(this.isProcessIterator(u)){if(t.hasProperty("scope")){t.setProperty("scope",k);}return true;}if(this.isDiagramIterator(u)){if(t.hasProperty("scope")){t.setProperty("scope",r);}return true;}else{if(u===this.facade.getCanvas()){throw l;}}};}else{s=function(u){if(this.isProcessIterator(u)){t.setProperty("scope",k);return true;}else{if(this.isDiagramIterator(u)){t.setProperty("scope",r);return true;}else{if(u===this.facade.getCanvas()){t.setProperty("scope",b);return true;}}}};}this.containmentAllowed(t,s.bind(this));},processContainmentAllowed:function(t){var s=Ext.emptyFn;if(this.isDiagramContent(t)){s=function(u){if(this.isProcessIterator(u)||this.isDiagramIterator(u)){return true;}else{if(u===this.facade.getCanvas()){throw l;}}};}else{s=function(u){if(this.isProcessIterator(u)||this.isDiagramIterator(u)||u===this.facade.getCanvas()){return true;}};}return this.containmentAllowed(t,s.bind(this));},sectionContainmentAllowed:function(t){var s=Ext.emptyFn;if(this.isFolderIterator(t)){s=function(u){if(this.isIterator(u)){throw l;}};}else{if(this.isDiagramIterator(t)){s=function(u){if(this.isIterator(u)&&!this.isFolderIterator(u)){throw l;}};}else{if(this.isProcessIterator(t)){s=function(u){if(this.isProcessIterator(u)){throw l;}return this.isDiagramIterator(u);};}}}return this.containmentAllowed(t,s.bind(this));},createHeaderAndFooter:function(v){if(v.extended){return;}v.extended=true;var y=v.getChildShapes().find(this.isHeader);var x=v.getChildShapes().find(this.isFooter);if(y||x){return;}var u=v.parent;var s=u.getChildShapes().sortBy(function(B){return B.bounds.upperLeft().y;});var t=s[s.indexOf(v)-1];if(t){var A=t.getChildShapes().find(this.isHeader);var z=t.getChildShapes().find(this.isFooter);if(A){this.copyElement(A,v);}if(z){this.copyElement(z,v);}}if(!A){this.addElement(v,"Header");}if(!z){this.addElement(v,"Footer");}this.handleLayoutPage({shape:v});},copyElement:function(t,s){this.addElement(s,t.getStencil().id(),function(u){this.applyProperties(u,t.properties);u.bounds.set(t.bounds);t.getChildShapes().each(function(v){this.copyElement(v,u);}.bind(this));}.bind(this));},restoreFocus:function(u,t){if(!(u instanceof Array)){u=[u];}var s=u.find(this.isTOCPart);if(t||(!s&&!this.restoring)){this.restoring=true;this.restoreFn=function(){this.facade.setSelection(u);this.restoring=false;}.bind(this);window.setTimeout(this.restoreFn,800);}},removeSilently:function(t,s){if(this.rescueList.include(t)){this.rescueList=this.rescueList.without(t);return;}t.hide();window.setTimeout(function(){t.parent.remove(t,true);if(s){this.restoreFocus(s);}}.bind(this),200);},containmentAllowed:function(s,t){t=t instanceof Function?t:Ext.emptyFn;if(!s.parent){return true;}try{if(t(s.parent)===true){return true;}}catch(u){if(u===l){return false;}throw u;}return this.containmentAllowed(s.parent,t);},handleLayoutMeta:function(t){var s=t.shape;var u=s.getLabels().sortBy(function(v){return v.id.endsWith("text_title")?-1:1;});u.each(function(v){v.registerOnChange(this.layoutLabels.bind(this,s,u));}.bind(this));this.layoutLabels(s,u);},layoutLabels:function(s,x){var u=10;var v=10;s._update(true);x.each(function(y){if(y.id.endsWith("text_title")){if(!y.text().endsWith(":")){y.text(y.text()+":");this.updateLabel(y);}if(s.getProperty("show_label")){y.setX(u);this.updateLabel(y);u+=y.getWidth()+v;}}else{if(!y.text().startsWith("<")){y.text("<"+y.text());}if(!y.text().endsWith(">")){y.text(y.text()+">");}y.setX(u);this.updateLabel(y);u+=y.getWidth()+v;}}.bind(this));var t=s.bounds.upperLeft();s.bounds.set(t,{x:t.x+Math.max(u,s.minimumSize.width),y:t.y+s.bounds.height()});this.facade.updateSelection();},layoutHeaderFooter:function(t){var s=t.getChildShapes();var v=s.find(this.isHeader);var u=s.find(this.isFooter);if(v){v.bounds.moveTo(0,0);}if(u){u.bounds.moveTo(0,t.bounds.height()-u.bounds.height());}},handleLayoutAttribute:function(s,t){this.resize(s,t.getWidth(),s.bounds.height());this.facade.getCanvas().update();this.facade.updateSelection();},moveMetaBlocks:function(u,x){x=x.sort(this.visualSort);var v=30;var s={left:[],center:[],right:[]};x.each(function(z){var y=this.getDistances(u,z);if(y.left<y.right&&y.left<y.center){s.left.push({el:z,x:v,position:"left"});}else{if(y.right<y.left&&y.right<y.center){s.right.push({el:z,x:u.bounds.width()-v-z.bounds.width(),position:"right"});}else{s.center.push({el:z,x:u.bounds.center().x-z.bounds.width()/2-u.bounds.upperLeft().x,position:"center"});}}}.bind(this));var t={y:400,maxY:500,padding:v};this.placeInRows(s.left,t);this.placeInRows(s.center,t);this.placeInRows(s.right,t);},getDistances:function(s,t){return{left:t.bounds.upperLeft().x,center:Math.abs(t.bounds.center().x-s.bounds.width()/2),right:s.bounds.width()-t.bounds.lowerRight().x};},requestIndexRefresh:function(s,t){if(this.refreshingIndex){window.clearTimeout(this.refreshingIndex);}this.refreshingIndex=window.setTimeout(function(){this.updateSectionNumbering(s.parent);this.updateTOC(s);this.facade.getCanvas().update();if(this.restoreFn){this.restoreFn();}}.bind(this),1);},createElement:function(s){if(!s.startsWith("http://www.signavio.com/stencilsets/processdoctemplate#")){s="http://www.signavio.com/stencilsets/processdoctemplate#"+s;}return this.facade.createShape({namespace:"http://www.signavio.com/stencilsets/processdoctemplate",type:s});},addElement:function(v,t,u,s){u=u instanceof Function?u:Ext.emptyFn;var x=this.createElement(t);v.add(x,undefined,s);u(x);return x;},flattenElement:function(t){if(!t){return[];}var s=[];t.getChildShapes(false,function(u){s.push(u);u.getChildShapes(true).each(function(v){u.remove(v);t.add(v);s.push(v);if(v.bounds.upperLeft().x>0){v.bounds.moveTo(u.bounds.upperLeft().x+1,0);}else{v.bounds.moveTo(u.bounds.upperLeft().x-1,0);}});});return s;},findElement:function(s,t){t=t instanceof Function?t:Ext.emptyFn;while(s&&!t(s)){s=s.parent;}return s;},handleRowChange:function(t){var s=this.findElement(t.elements.first(),this.isTable);this.addRows(s,t.value);},handleColumnChange:function(t){var s=this.findElement(t.elements.first(),this.isTable);this.addColumns(s,t.value);},removeChildren:function(t,u,v,s){s=s instanceof Function?s:Ext.emptyFn;t.getChildShapes().sort(u).select(v).each(function(x){s(x);t.remove(x);});},applyProperties:function(t,u){var s={};$H(u).keys().each(function(v){if(t.hasProperty(v)){t.properties[v]=u[v]!==undefined?u[v]:"";t.propertiesChanged[v]=u[v]!==undefined;}else{s[v]=u[v];}});t._changed();t._update();return s;},visualSort:function(t,s){var v=t.bounds.upperLeft();var u=t.bounds.upperLeft();return v.y<u.y?-1:v.y>u.y?1:v.x<u.x?-1:v.x>u.x?1:0;},addRows:function(t,s){this.createTableElements(t,"TableRow",this.isRow,s);},addColumns:function(u,t){var s=40;if(u.bounds.width()/t<s){t=Math.round(u.bounds.width()/s);}this.createTableElements(u,"TableColumn",this.isColumn,t);},createTableElements:function(v,s,x,u){var t=[];this.removeChildren(v,this.visualSort,x,function(y){t.push(y.properties);});t.reverse();u.times(function(){this.addElement(v,s,function(y){this.applyProperties(y,t.pop()||{});}.bind(this));}.bind(this));},computeColumnWidth:function(t,s,z){var v=100;var u=0;var y=25;var x=t.bounds.width();s.each(function(C,A){var B=C.getProperty("width");var D=(t.bounds.width()*B)/100;if(B>0&&D>y&&v-B>0&&x>y){v-=B;++u;}else{if(C.hasProperty("width")){C.setProperty("width",0);}}if(this.getEqualWidth(t,s,v,u,z)<=y){v+=B;u--;C.setProperty("width",0);}x=this.getEqualWidth(t,s,v,u,z);}.bind(this));return x;},getEqualWidth:function(x,v,z,y,A){if(z<=0){z=100;y=0;}var t=A.size();var u=v.length-y;var s=(x.bounds.width()*z)/100;return(s-t*((t>0)?A.first().bounds.width():0))/(u-t);},restoreVisibleOrder:function(t,s){if(!this.isStaticTable(t)){return;}s.sort(function(v,u){return this.isRow(v)&&!this.isRow(u)?-1:!this.isRow(v)&&this.isRow(u)?1:this.isRow(v)?(v.bounds.x<u.bounds.x?-1:v.bounds.x>u.bounds.x?1:0):this.isColumn(v)?(v.bounds.y<u.bounds.y?-1:v.bounds.y>u.bounds.y?1:0):0;}.bind(this)).each(function(u){t.remove(u);t.add(u);});},updateTable:function(t,u,s){if(t.hasProperty("rows")&&t.hasProperty("columns")){t.properties["oryx-rows"]=u.size();t.propertiesChanged["oryx-rows"]=true;t.properties["oryx-columns"]=s.size();t.propertiesChanged["oryx-columns"]=true;t._changed();}t._update();},placeInRows:function(u,s){var v=s.y;var t=s.maxY;u.sortBy(function(x){return x.el.bounds.upperLeft().y;}).each(function(y,x){y.el.bounds.moveTo(y.x,v);y.el.setProperty("position",y.position);y.el.setProperty("row",x);v=Math.min(v+s.padding,t);});},resize:function(t,v,s){var u=t.minimumSize.width;var x=t.minimumSize.height;t.bounds.set({a:{x:t.bounds.a.x,y:t.bounds.a.y},b:{x:t.bounds.a.x+(v>u?v:u),y:t.bounds.a.y+(s>x?s:x)}});},getSectionNumber:function(v,u,t){if(v.getProperty("numberstyle")==="roman"){var s="";c.each(function(y,x){while(t>=y){t=t-y;s=s+n[x];}});return u+s;}return u+t;},updateSectionNumbering:function(v){var y="";var x=this;if(v&&this.isSection(v)){if(v.getProperty("includeinnumbering")){var t=v.getProperty("indexnumber");y=t+".";}}var z=[];if(v){z=v.getChildShapes().select(this.isSection);}else{v=this.facade.getCanvas();var s=v.getChildShapes().select(this.isPage);s.each(function(A){z=z.concat(A.getChildShapes().select(x.isSection));});}var u=1;z.sortBy(function(A){return A.absoluteBounds().upperLeft().y;}).each((function(C){if(C.getProperty("includeinnumbering")){C.setProperty("indexnumber",y+u);C.setProperty("visibleindexnumber",x.getSectionNumber(C,y,u));var B=15;if(x.isIterator(C)){var A="";(2).times(function(){++u;A=A+x.getSectionNumber(C,y,u)+"...\n";});C.setProperty("followpages",A);}C.getLabels().each(function(D){if(D.id.endsWith("text_name")){D.setX(x.computeSectionTitlePadding(B,C.getProperty("visibleindexnumber")));x.updateLabel(D);}});++u;}else{if(x.isIterator(C)){C.setProperty("followpages","");}C.getLabels().each(function(D){if(D.id.endsWith("text_name")){D.setX(0);x.updateLabel(D);}});}x.updateSectionNumbering(C);}));},computeSectionTitlePadding:function(u,s){var t=s.split(".");var v=10;u=u*t.length;t.each(function(x){if(x.length>1){u=u+v;}});return u;},updateTOC:function(y){var v=this.facade.getCanvas().getChildShapes();var t=v.select(this.isPage);var u=v.find(this.isTOC);var C=[];var x=this;t.sortBy(function(D){return D.bounds.upperLeft().y;}).each(function(D){C=C.concat(D.getChildShapes().select(function(E){return x.isSection(E)&&x.inTOC(E);}).sortBy(function(E){return E.bounds.upperLeft().y;}));});if(u){this.cleanTOC(u,true);if(C.length>0&&u.getProperty("preview")){u.setProperty("description","");var z=115;var s=this.createTOCItems(u,C);var A=u.getChildShapes().find(this.isTOCPart);var B=z+(s*A.bounds.height())+75;this.resize(u,u.bounds.width(),B);}else{if(u.getProperty("preview")){u.setProperty("description",Signavio.I18N.ProcessTemplates.tocToolTip);}}u._update(true);}},cleanTOC:function(t,s){t.getChildShapes().reject(function(u){return this.isHeader(u)||this.isFooter(u);}.bind(this)).each(function(u){t.remove(u,s);});},inTOC:function(s){return s.getProperty("includeintoc");},getSectionTitle:function(t){var v=t.getProperty("includeinnumbering");var u=t.getProperty("title");var s=t.getProperty("visibleindexnumber");return(v?s+" ":"")+u;},createTOCItems:function(A,z,y,s){y=y===undefined?1:y;s=s===undefined?0:s;var x=20;var v=30;var t=115;var u=this;z.each(function(E){var G=u.getSectionTitle(E);u.addElement(A,"TOCPart",function(J){J.setProperty("title",G);J.bounds.set({a:{x:y*x,y:t+(s*v)},b:{x:(y*x)+J.bounds.width(),y:t+(s*v)+J.bounds.height()}});},true);var D=E.getChildShapes().select(u.isSection).select(u.inTOC).sortBy(function(J){return J.bounds.upperLeft().y;});s=u.createTOCItems(A,D,y+1,s+1);if(u.isIterator(E)){var B=E.getProperty("indexnumber");var I=E.getProperty("includeinnumbering");var H=B.split(".");var C=parseInt(H.last());var F="";if(I){F=B.slice(0,Math.max(B.lastIndexOf(H.last())-1,0));}(2).times(function(){C++;u.addElement(A,"TOCPart",function(J){J.setProperty("title",(I?F+(F?".":"")+u.getSectionNumber(E,"",C):"")+" ...");J.bounds.set({a:{x:y*x,y:t+(s*v)},b:{x:(y*x)+J.bounds.width(),y:t+(s*v)+J.bounds.height()}});},true);s++;});}});return s;},translate:function(){var s=ORYX.I18N.Language.split("_").first();return function(t){var u=t.getStencil();var v=false;u.properties().each(function(A){var y=A._jsonProp;if(y["value_"+s]){v=true;var x=A.prefix()+"-"+A.id();var z=y["value_"+s];if(!A.readonly()){z=t.properties[x]||z;}t.properties[x]=z;t.propertiesChanged[x]=true;}});if(v){t._changed();t._update();}};}(),isText:function(){return o("FreeText");}(),isMeta:function(){return o("MetaBlock");}(),isHeader:function(){return o("Header");}(),isHeaderFooterAttribute:function(){var s=["Version","FileName","Date","LastModified","HeaderFooterText","PageNumber"];return o(s);}(),isHeaderFooterFreeText:function(){return o("HeaderFooterText");}(),isPageNumber:function(){return o("PageNumber");}(),isFooter:function(){return o("Footer");}(),isCoverPage:function(){return o("CoverPage");}(),isTable:function(){var s=["TableActivities","TableElements","Table"];return o(s);}(),isStaticTable:function(){return o("Table");}(),isColumn:function(s){var t=["TableColumn","TableElementsIndex","TableElementsAttribute","TableElementsAttributeMulti","TableElementsElementType","TableElementsDataObjects","TableElementsITSystems","TableElementsRoles","TableElementsGlossary"];return o(t);}(),isRow:function(){return o("TableRow");}(),isListRow:function(){var s=["ListElementsAttribute","ListElementsAttributeMulti","ListElementsElementType","ListElementsDataObjects","ListElementsITSystems","ListElementsRoles","ListElementsGlossary"];return o(s);}(),isIndexColumn:function(){return o("TableElementsIndex");}(),isMultiColumn:function(){return o("TableElementsAttributeMulti");}(),isIterator:function(){var s=["SectionPerProcess","SectionPerDiagram","SectionPerFolder"];return o(s);}(),isSection:function(){var s=["Section","SectionPerProcess","SectionPerDiagram","SectionPerFolder"];return o(s);}(),isProcessContent:function(){var s=["DiagramAttribute","DiagramAttributeMulti","AttributeDescription","Participants","DataObjects","ITSystems","ProcessTriggers","ProcessResults","GlossaryEntries","TableElements","ListElements","DiagramImage"];return o(s);}(),isMultiDiagramAttribute:function(){return o("DiagramAttributeMulti");}(),isDiagramContent:function(){var s=["DiagramImage","DiagramAttribute","DiagramAttributeMulti","AttributeDescription","TableElements","ListElements"];return o(s);}(),isDiagramInformation:function(){var s=["TableOrigin","TableRevisions"];return o(s);}(),isPage:function(){var s=["CoverPage","TableOfContents","FollowingPage"];return o(s);}(),isTOC:function(){return o("TableOfContents");}(),isTOCPart:function(){return o("TOCPart");}(),isList:function(){var s=["ListElements","Participants","DataObjects","ITSystems","ProcessTriggers","ProcessResults","GlossaryEntries"];return o(s);}(),isDiagramIterator:function(){return o("SectionPerDiagram");}(),isProcessIterator:function(){return o("SectionPerProcess");}(),isFolderIterator:function(){return o("SectionPerFolder");}()});}());if(!Signavio){var Signavio={};}if(!Signavio.Plugins){Signavio.Plugins={};}(function(){Signavio.Plugins.SwissPostSupport=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;var b={id:"swissPost",title:"Swiss Post",title_de:"Swiss Post",value:"swissPost",refToView:"swiss-post"};this.createPropertyFor("Header",b);this.createPropertyFor("Footer",b);},createPropertyFor:function(b,f){var c="http://www.signavio.com/stencilsets/processdoctemplate#";var a=this.facade.getStencilSets()[c];var d=a.stencil(c+b);var e=d.property("oryx-style");e._items[f.id]=new ORYX.Core.StencilSet.PropertyItem(f,c,e);d.property("oryx-showswisspost")._jsonProp.value=true;}});}());if(!Signavio){var Signavio={};}if(!Signavio.Plugins){Signavio.Plugins={};}(function(){Signavio.Plugins.KaiserKraftSupport=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;var b={id:"kaiserKraft",title:"Kaiser Kraft",title_de:"Kaiser Kraft",value:"kaiserKraft",refToView:"kaiser-kraft"};this.createPropertyFor("Header",b);this.createPropertyFor("Footer",b);},createPropertyFor:function(b,f){var c="http://www.signavio.com/stencilsets/processdoctemplate#";var a=this.facade.getStencilSets()[c];var d=a.stencil(c+b);var e=d.property("oryx-style");e._items[f.id]=new ORYX.Core.StencilSet.PropertyItem(f,c,e);d.property("oryx-showkaiserkraft")._jsonProp.value=true;}});}());if(!window.Signavio){window.Signavio={};}if(!Signavio.Plugins){Signavio.Plugins={};}(function(){Signavio.Plugins.RemoveSignavioBranding=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;var b={id:"none",title:"Own",title_de:"Eigener",value:"none",refToView:"none"};this.createPropertyFor("Header",b);this.createPropertyFor("Footer",b);},createPropertyFor:function(b,f){var c="http://www.signavio.com/stencilsets/processdoctemplate#";var a=this.facade.getStencilSets()[c];var d=a.stencil(c+b);var e=d.property("oryx-style");e._items[f.id]=new ORYX.Core.StencilSet.PropertyItem(f,c,e);e._jsonProp.value=f.value;d.property("oryx-shownone")._jsonProp.value=true;}});}());if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.SyntaxChecker=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.active=false;this.raisedEventIds=[];this.facade.offer({"name":ORYX.I18N.SyntaxChecker.name,"functionality":this.perform.bind(this),"group":ORYX.I18N.SyntaxChecker.group,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/chart_curve_error.png","description":ORYX.I18N.SyntaxChecker.desc,"index":0,"toggle":true,"minShape":0,"maxShape":0});this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,this.checkForErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT,this.resetErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,this.doShowErrors.bind(this));},perform:function(a,b){if(!b){this.resetErrors();}else{this.checkForErrors({onNoErrors:function(){this.setActivated(a,false);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.noErrors,timeout:10000});}.bind(this),onErrors:function(){this.enableDeactivationHandler(a);}.bind(this),onFailure:function(){this.setActivated(a,false);Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SyntaxChecker.invalid);}.bind(this)});}},enableDeactivationHandler:function(a){var b=function(){this.setActivated(a,false);this.resetErrors();this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b);};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b.bind(this));},setActivated:function(b,a){b.toggle(a);if(a===undefined){this.active=!this.active;}else{this.active=a;}},checkForErrors:function(b){Ext.applyIf(b||{},{showErrors:true,onErrors:Ext.emptyFn,onNoErrors:Ext.emptyFn,onFailure:Ext.emptyFn});Ext.Msg.wait(ORYX.I18N.SyntaxChecker.checkingMessage);var c=this.facade.getStencilSets();var d=null;var a=ORYX.CONFIG.SYNTAXCHECKER_URL;var e={resource:location.href,context:b.context,isJson:false};if(c.keys().include("http://b3mn.org/stencilset/bpmn2.0#")||c.keys().include("http://b3mn.org/stencilset/bpmn2.0choreography#")||c.keys().include("http://b3mn.org/stencilset/bpmn2.0conversation#")){e.data_json=this.facade.getSerializedJSON();e.ns="http://b3mn.org/stencilset/bpmn2.0#";e.isJson=true;}else{if(c.keys().include("http://b3mn.org/stencilset/epc#")){e.data_json=this.facade.getSerializedJSON();e.ns="http://b3mn.org/stencilset/epc#";e.isJson=true;}else{e.data=this.getRDFFromDOM();}}new Ajax.Request(a,{method:"POST",asynchronous:false,parameters:e,onSuccess:function(f){var g=(f&&f.responseText?f.responseText:"{}").evalJSON();Ext.Msg.hide();if(g instanceof Object){g=$H(g);if(g.size()>0){if(b.showErrors){this.showErrors(g);}b.onErrors();}else{b.onNoErrors();}}else{b.onFailure();}}.bind(this),onFailure:function(){Ext.Msg.hide();b.onFailure();}});},doShowErrors:function(b,a){this.showErrors(b.errors);},showErrors:function(a){if(!(a instanceof Hash)){a=new Hash(a);}a.keys().each(function(c){var b=this.facade.getCanvas().getChildShapeByResourceId(c);if(b){this.raiseOverlay(b,this.parseCodeToMsg(a[c]));}}.bind(this));this.active=!this.active;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.notice,timeout:10000});},parseCodeToMsg:function(e){var f=e.replace(/: /g,"<br />").replace(/, /g,"<br />");var a=f.split("<br />");for(var b=0;b<a.length;b++){var d=a[b];var c=this.parseSingleCodeToMsg(d);if(d!=c){f=f.replace(d,c);}}return f;},parseSingleCodeToMsg:function(a){return ORYX.I18N.SyntaxChecker[a]||a;},resetErrors:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));this.raisedEventIds=[];this.active=false;},raiseOverlay:function(a,b){var f="syntaxchecker."+this.raisedEventIds.length;var d=ORYX.Editor.provideId();var e=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"id":d,"title":"","stroke-width":5,"stroke":"red","d":"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:f,shapes:[a],node:e,nodePosition:a instanceof ORYX.Core.Edge?"START":"NW"});var c=new Ext.ToolTip({showDelay:50,html:b,target:d});this.raisedEventIds.push(f);return e;}});ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT="checkForErrors";ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT="resetErrors";ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT="showErrors";ORYX.Plugins.PetrinetSyntaxChecker=ORYX.Plugins.SyntaxChecker.extend({getRDFFromDOM:function(){return this.facade.getERDF();}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.JPDLSupport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,stencilSetExtensionNamespace:"http://oryx-editor.org/stencilsets/extensions/jbpm#",stencilSetExtensionDefinition:"jbpm/jbpm.json",stencilSetNamespace:"http://b3mn.org/stencilset/bpmn1.1#",stencilSetUrlSuffix:"/bpmn1.1/bpmn1.1.json",construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.jPDLSupport.exp,"functionality":this.exportJPDL.bind(this),"group":ORYX.I18N.jPDLSupport.group,"icon":ORYX.PATH+"images/jpdl_export_icon.png","description":ORYX.I18N.jPDLSupport.expDesc,"index":1,"minShape":0,"maxShape":0,"maxShape":0,"isEnabled":this._isJpdlStencilSetExtensionLoaded.bind(this)});this.facade.offer({"name":ORYX.I18N.jPDLSupport.imp,"functionality":this.importJPDL.bind(this),"group":ORYX.I18N.jPDLSupport.group,"icon":ORYX.PATH+"images/jpdl_import_icon.png","description":ORYX.I18N.jPDLSupport.impDesc,"index":2,"minShape":0,"maxShape":0});},_isJpdlStencilSetExtensionLoaded:function(){return this.isStencilSetExtensionLoaded(this.stencilSetExtensionNamespace);},importJPDL:function(){this._showImportDialog();},exportJPDL:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this._doExport();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}).bind(this),10);return true;},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText);}}.bind(this),onFailure:function(g){if(a){a();}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedReq);ORYX.log.warn("Import jPDL failed: "+g.responseText);}}.bind(this)});return c;},_loadJSON:function(a){if(a){var b=a.evalJSON();if(b&&this._hasStencilset(b)){if(this._isJpdlStencilSetExtensionLoaded()){this.facade.importJSON(a);}else{Ext.MessageBox.confirm(ORYX.I18N.jPDLSupport.loadSseQuestionTitle,ORYX.I18N.jPDLSupport.loadSseQuestionBody,function(c){if(c=="yes"){if(this.loadStencilSetExtension(this.stencilSetNamespace,this.stencilSetExtensionDefinition)){this.facade.importJSON(a);}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedJson);}}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedJsonAbort);}},this);}}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedJson);}}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedJson);}},loadStencilSetExtension:function(c,b){var a=this.facade.getStencilSets()[c];if(a){a.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+b);this.facade.getRules().initializeRules(a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});return true;}return false;},_hasStencilset:function(a){return a.properties.ssextension==this.stencilSetExtensionNamespace&&a.stencilset.url.endsWith(this.stencilSetUrlSuffix);},_doExport:function(){var a=this.facade.getSerializedJSON();this._sendRequest(ORYX.CONFIG.JPDLEXPORTURL,"POST",{data:a},function(b){var d=new DOMParser();var c=d.parseFromString(b,"text/xml");if(c.firstChild.localName=="error"){this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.expFailedXml+c.firstChild.firstChild.data);}else{this.openXMLWindow(b);}}.bind(this),function(){this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.expFailedReq);}.bind(this));},_showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.jPDLSupport.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.jPDLSupport.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.jPDLSupport.impJPDL,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.jPDLSupport.impBtn,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.jPDLSupport.impProgress});d.show();window.setTimeout(function(){var e=c.items.items[2].getValue();this._sendRequest(ORYX.CONFIG.JPDLIMPORTURL,"POST",{"data":e},function(f){this._loadJSON(f);d.hide();b.hide();}.bind(this),function(){d.hide();b.hide();}.bind(this));}.bind(this),100);}.bind(this)},{text:ORYX.I18N.jPDLSupport.close,handler:function(){b.hide();}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b;});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsText("UTF-8");c.items.items[2].setValue(e);},true);},_showErrorMessageBox:function(b,a){Ext.MessageBox.show({title:b,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}});Ext.ns("Oryx.Plugins");ORYX.Plugins.PetriNetSoundnessChecker=ORYX.Plugins.AbstractPlugin.extend({hideOverlays:function(){if(!this.overlayIds){return;}Ext.each(this.overlayIds,function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));},getChildShapesByResourceIds:function(b){var a=[];Ext.each(b,function(c){a.push(this.facade.getCanvas().getChildShapeByResourceId(c));}.bind(this));return a;},showOverlay:function(a,b,e,c){if(!this.overlayIds){this.overlayIds=[];}if(!(a instanceof Array)){a=[a];}a=a.map(function(f){var g=f;if(typeof f=="string"){g=this.facade.getCanvas().getChildShapeByResourceId(f);g=g||this.facade.getCanvas().getChildById(f,true);}return g;}.bind(this)).compact();var d=this.type+ORYX.Editor.provideId();this.overlayIds.push(d);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:d,shapes:a,attributes:b,node:e,nodePosition:c||"NW"});},construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":"Check soundness","functionality":this.showCheckerWindow.bind(this),"group":"Verification","icon":ORYX.PATH+"images/checker_validation.png","description":"Checks current Petri net for different soundness criteria.","index":3,"minShape":0,"maxShape":0});},showCheckerWindow:function(){var d=this;var b=Ext.extend(Ext.tree.TreeNode,{constructor:function(g){if(!g.icon&&!this.icon){g.icon=b.UNKNOWN_STATUS;}b.superclass.constructor.apply(this,arguments);Ext.apply(this,g);if(this.clickHandler){this.on("click",this.clickHandler.bind(this));}},setIcon:function(g){this.ui.getIconEl().src=g;},getIcon:function(g){return this.ui.getIconEl().src;},reset:function(){d.hideOverlays();this.hideMarking();d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});},hideMarking:function(){if(!d.marking){return;}for(place in d.marking){var g=d.facade.getCanvas().getChildShapeByResourceId(place);if(g){g.setProperty("oryx-numberoftokens",0);}}d.facade.getCanvas().update();d.marking=undefined;},showMarking:function(h){d.marking=h;for(place in h){var g=d.facade.getCanvas().getChildShapeByResourceId(place);g.setProperty("oryx-numberoftokens",h[place]);}d.facade.getCanvas().update();},showErrors:function(g){Ext.each(this.childNodes,function(h){if(h&&h.itemCls==="error"){h.remove();}});Ext.each(this.childNodes,function(h){if(h.getIcon().search(b.LOADING_STATUS)>-1){h.setIcon(b.UNKNOWN_STATUS);}});Ext.each(g,function(h){this.insertBefore(new b({icon:b.ERROR_STATUS,text:h,itemCls:"error"}),this.childNodes[0]);}.bind(this));},showOverlayWithStep:function(g){Ext.each(g,function(k,h){d.showOverlay(d.facade.getCanvas().getChildShapeByResourceId(k),{fill:"#FB7E02"},ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{"style":"font-size: 16px; font-weight: bold;"},(h+1)+"."]),"SE");});},showOverlay:function(g){if(g.length===0){return;}if(!g[0] instanceof ORYX.Core.Node){g=d.getChildShapesByResourceIds(g);}d.showOverlay(g,{fill:"#FB7E02"});}});b.UNKNOWN_STATUS=ORYX.PATH+"images/soundness_checker/"+"asterisk_yellow.png";b.ERROR_STATUS=ORYX.PATH+"images/soundness_checker/"+"exclamation.png";b.OK_STATUS=ORYX.PATH+"images/soundness_checker/"+"accept.png";b.LOADING_STATUS=ORYX.PATH+"images/soundness_checker/"+"loading.gif";var c=Ext.extend(b,{constructor:function(g){g.qtip="<b>Termination Criteria</b>: Makes sure that any process instance that starts in the initial state will eventually reach the final state. If any dead locks are detected, click to show one counter example.";c.superclass.constructor.apply(this,arguments);},clickHandler:function(h){h.reset();if(this.deadLocks.length==0){return;}var g=h.deadLocks[0];this.showOverlayWithStep(g.path);this.showMarking(g.marking);},update:function(g){this.deadLocks=g;this.setIcon(this.deadLocks.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There is "+(this.deadLocks.length==0?"no":"a")+" path that leads to a deadlock.");}});var f=Ext.extend(b,{constructor:function(g){g.qtip="<b>Proper Termination Criteria</b>: The final state is the only state reachable from the initial state in which there is a token in the final place. If any improper terminating states are detected, click to show one counter example.";f.superclass.constructor.apply(this,arguments);},clickHandler:function(h){h.reset();if(h.improperTerminatings.length==0){return;}var g=h.improperTerminatings[0];this.showOverlayWithStep(g.path);this.showMarking(g.marking);},update:function(g){this.improperTerminatings=g;this.setIcon(this.improperTerminatings.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.improperTerminatings.length+" markings covering the final marking.");}});var a=Ext.extend(b,{constructor:function(g){g.qtip="<b>No Dead Transitions Criteria</b>: Each transition can contribute to at least one process instance. Click to see all dead transitions.";a.superclass.constructor.apply(this,arguments);},clickHandler:function(g){g.reset();this.showOverlay(this.deadTransitions);},update:function(g){this.deadTransitions=g;this.setIcon(this.deadTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.deadTransitions.length+" dead transitions.");}});var e=Ext.extend(b,{constructor:function(g){g.qtip="<b>Transition Participation Criteria</b>: Each transition participates in at least one process instance that starts in the initial state and reaches the final state. Click to see all transitions not participating in any process instance.";e.superclass.constructor.apply(this,arguments);},clickHandler:function(g){g.reset();this.showOverlay(this.notParticipatingTransitions);},update:function(g){this.notParticipatingTransitions=g;this.setIcon(this.notParticipatingTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.notParticipatingTransitions.length+" transitions that cannot participate in a properly terminating firing sequence.");}});this.checkerWindow=new Ext.Window({title:"Soundness Checker",autoScroll:true,width:"500",tbar:[{text:"Check",handler:function(){this.checkerWindow.check();}.bind(this)},{text:"Hide Errors",handler:function(){this.checkerWindow.getTree().getRootNode().reset();}.bind(this)},"->",{text:"Close",handler:function(){this.checkerWindow.close();}.bind(this)}],getTree:function(){return this.items.get(0);},check:function(g){this.prepareCheck(g);this.checkSyntax(this.checkSoundness.bind(this));},prepareCheck:function(h){var g=this.getTree().getRootNode();g.reset();Ext.each(g.childNodes,function(k){if(h){k.expand(true);}k.collapse(true);k.setIcon(b.LOADING_STATUS);});},checkSyntax:function(g){d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!");this.turnLoadingIntoUnknownStatus();}.bind(this),onNoErrors:function(){g();}});},turnLoadingIntoUnknownStatus:function(){Ext.each(this.getTree().getRootNode().childNodes,function(g){if(g.getIcon().search(b.LOADING_STATUS)>-1){g.setIcon(b.UNKNOWN_STATUS);}});},checkSoundness:function(){var g=this.getTree().getRootNode();if(!g.findChild("id","structuralSound").check()){this.turnLoadingIntoUnknownStatus();return;}Ext.Ajax.request({url:ORYX.CONFIG.PN_CHECKER,method:"POST",success:function(k){var h=Ext.decode(k.responseText);g.showErrors(h.errors);if(h.errors.length===0){g.findChild("id","sound").check(h);g.findChild("id","weakSound").check(h);g.findChild("id","relaxedSound").check(h);}},failure:function(){},params:{data:d.getSerializedDOM()}});},items:[new Ext.tree.TreePanel({useArrows:true,autoScroll:true,rootVisible:false,animate:true,containerScroll:true,root:new b({text:"Checks",id:"source",expanded:true}),listeners:{render:function(l){var h=new b({text:"Structural Sound (Workflow Net)",id:"structuralSound",check:function(){this.checkInitialNode.update();this.checkFinalNode.update();this.checkConnectedNode.update(this.checkInitialNode.initialNodes,this.checkFinalNode.finalNodes);if(this.checkInitialNode.hasErrors()||this.checkFinalNode.hasErrors()||this.checkConnectedNode.hasErrors()){this.setIcon(b.ERROR_STATUS);this.expand();return false;}else{this.setIcon(b.OK_STATUS);return true;}},checkInitialNode:new b({qtip:"There must be exactly one initial place, which is the only place without any incoming edges.",update:function(){this.initialNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(n){if(n.getIncomingShapes().length==0&&n.getStencil().id().search(/Place/)>-1){this.initialNodes.push(n);}}.bind(this));this.setText(this.initialNodes.length+" initial places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS);},clickHandler:function(n){n.reset();this.showOverlay(this.initialNodes);},hasErrors:function(){return this.initialNodes.length!==1;}}),checkFinalNode:new b({qtip:"There must be exactly one final place, which is the only place without any outgoing edges.",update:function(){this.finalNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(n){if(n.getOutgoingShapes().length==0&&n.getStencil().id().search(/Place/)>-1){this.finalNodes.push(n);}}.bind(this));this.setText(this.finalNodes.length+" final places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS);},clickHandler:function(n){n.reset();this.showOverlay(this.finalNodes);},hasErrors:function(){return this.finalNodes.length!==1;}}),checkConnectedNode:new b({qtip:"Each node in the process model is on the path from the initial node to the final node.",update:function(o,n){if(o.length!==1||n.length!==1){this.setText("There must be exactly one initial and final place to perform further checks!");this.setIcon(b.UNKNOWN_STATUS);return;}this.notParticipatingNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(p){if(p instanceof ORYX.Core.Node){this.notParticipatingNodes.push(p);}}.bind(this));this.passedNodes=[];this.findNotParticipatingNodes(o[0]);this.setText(this.notParticipatingNodes.length+" nodes that aren't on any path from beginning to end found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS);},clickHandler:function(n){n.reset();this.showOverlay(this.notParticipatingNodes);},findNotParticipatingNodes:function(n){this.passedNodes.push(n);this.notParticipatingNodes.remove(n);Ext.each(n.getOutgoingShapes(),function(o){if(!this.passedNodes.include(o)){this.findNotParticipatingNodes(o);}}.bind(this));},hasErrors:function(){return this.notParticipatingNodes.length!==0;}})});h.appendChild([h.checkInitialNode,h.checkFinalNode,h.checkConnectedNode]);var g=new b({text:"Sound",id:"sound",check:function(n){if(n.isSound){this.setIcon(b.OK_STATUS);}else{this.setIcon(b.ERROR_STATUS);this.expand();}this.deadTransitionsNode.update(n.deadTransitions);this.improperTerminatingsNode.update(n.improperTerminatings);this.deadLocksNode.update(n.deadLocks);},deadTransitionsNode:new a({}),improperTerminatingsNode:new f({}),deadLocksNode:new c({})});g.appendChild([g.deadTransitionsNode,g.improperTerminatingsNode,g.deadLocksNode]);var m=new b({text:"Weak Sound",id:"weakSound",check:function(n){if(n.isWeakSound){this.setIcon(b.OK_STATUS);}else{this.setIcon(b.ERROR_STATUS);this.expand();}this.improperTerminatingsNode.update(n.improperTerminatings);this.deadLocksNode.update(n.deadLocks);},deadTransitionsNode:new a({}),improperTerminatingsNode:new f({}),deadLocksNode:new c({})});m.appendChild([m.improperTerminatingsNode,m.deadLocksNode]);var k=new b({text:"Relaxed Sound",id:"relaxedSound",check:function(n){if(n.isRelaxedSound){this.setIcon(b.OK_STATUS);}else{this.setIcon(b.ERROR_STATUS);this.expand();}this.notParticipatingTransitionsNode.update(n.notParticipatingTransitions);},notParticipatingTransitionsNode:new e({})});k.appendChild([k.notParticipatingTransitionsNode]);l.getRootNode().appendChild([h,g,m,k]);}}})],listeners:{close:function(g){this.checkerWindow.getTree().getRootNode().reset();}.bind(this)}});this.checkerWindow.show();this.checkerWindow.check(true);}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.PetriNet={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));},handlePropertyChanged:function(c){var b=c.elements;var d=c.key;var a=c.value;var e=false;b.each(function(f){if((f.getStencil().id()==="http://b3mn.org/stencilset/petrinet#Place")&&(d==="oryx-numberoftokens")){if(a==0){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","0");}else{if(a==1){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","1");}else{if(a==2){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","2");}else{if(a==3){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","3");}else{if(a==4){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","4");}else{var g=parseInt(a,10);if(g&&g>0){f.setProperty("oryx-numberoftokens_text",""+g);f.setProperty("oryx-numberoftokens_drawing","0");}else{f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","0");}}}}}}e=true;}});if(e){this.facade.getCanvas().update();}}};ORYX.Plugins.PetriNet=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.PetriNet);Ext.namespace("ORYX.Plugins");ORYX.Plugins.AbstractStepThroughPlugin=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":ORYX.I18N.StepThroughPlugin.stepThrough,"functionality":this.load.bind(this),"group":ORYX.I18N.StepThroughPlugin.group,"icon":ORYX.PATH+"images/control_play.png","description":ORYX.I18N.StepThroughPlugin.stepThroughDesc,"index":1,"toggle":true,"minShape":0,"maxShape":0});this.facade.offer({"name":ORYX.I18N.StepThroughPlugin.undo,"functionality":this.undo.bind(this),"group":ORYX.I18N.StepThroughPlugin.group,"icon":ORYX.PATH+"images/control_rewind.png","description":ORYX.I18N.StepThroughPlugin.undoDesc,"index":2,"minShape":0,"maxShape":0});},showEnabled:function(a,b){if(!(a instanceof ORYX.Core.Shape)){return;}else{if(this.isOrSplit(a)){this.showEnabledOrSplit(a);return;}}this.showPlayOnShape(a);},showPlayOnShape:function(b){var a;if(b instanceof ORYX.Core.Edge){a={stroke:"green"};}else{a={fill:"green"};}var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"title":"Click the element to execute it!","stroke-width":2,"stroke":"black","d":"M0,-5 L5,0 L0,5 Z","line-captions":"round"}]);this.showOverlayOnShape(b,a,c);},showOverlayOnShape:function(b,a,c){this.hideOverlayOnShape(b);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:(c?c:null),nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"});},hideOverlayOnShape:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+a.resourceId});},hideOverlays:function(a){var b=this.facade.getCanvas().getChildShapes(true);var c;for(i=0;i<b.size();i++){c=b[i];if(!(a&&this.isStartNode(c))){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+c.resourceId});}}},load:function(a,b){this.initializeLoadButton(a,b);this.togglePlugin(b);},togglePlugin:function(a){if(a){this.initialMarking=[];if(this.getDiagramType()==="epc"){this.prepareInitialMarking();}else{this.startAndCheckSyntax();}}else{this.executionTrace="";this.rdf=undefined;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});this.onDeactivate();}if(this.active()){this.callback=this.doMouseUp.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback);}else{this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback);this.callback=undefined;}},onDeactivate:function(){this.hideOverlays();},initializeLoadButton:function(b,c){if(this.loadButton!==b){var a=function(d){if(d){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);}else{this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);}}.createDelegate(this);b.on("toggle",function(d,e){a(e);});a(b,c);}this.loadButton=b;},active:function(){return this.loadButton?this.loadButton.pressed:false;},onSelectionChanged:function(){if(this.active()&&this.facade.getSelection().length>0){this.facade.setSelection([]);}},getDiagramType:function(){switch(this.facade.getCanvas().getStencil().namespace()){case"http://b3mn.org/stencilset/epc#":return"epc";case"http://b3mn.org/stencilset/bpmn#":return"bpmn";default:return null;}},showUsed:function(b,c){if(!(b instanceof ORYX.Core.Shape)){return;}var a;if(b instanceof ORYX.Core.Edge){a={stroke:"mediumslateblue"};}else{a={fill:"mediumslateblue"};}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+b.resourceId});if(c!="-1"&&c!="1"){var d=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{"style":"font-size: 16px; font-weight: bold;"},c]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:d,nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a});}}});ORYX.Plugins.PetriNetStepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);},startAndCheckSyntax:function(){this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!");}.bind(this),onNoErrors:function(){if(this.initializeMarking()){this.firedTransitions=[];this.showEnabledTransition();}else{this.togglePlugin(false);}}.bind(this)});},initializeMarking:function(){var b=function(d,c){if(c==0){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0");}else{if(c==1){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","1");}else{if(c==2){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","2");}else{if(c==3){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","3");}else{if(c==4){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","4");}else{var e=parseInt(c,10);if(e&&e>0){d.setProperty("oryx-numberoftokens_text",""+e);d.setProperty("oryx-numberoftokens_drawing","0");}else{d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0");}}}}}}};this.getPlaces().each(function(c){if("undefined"==typeof(c._setProperty_monkey)){c._setProperty_monkey=c.setProperty;c.setProperty=function(e,d){if("oryx-numberoftokens"==e){b(c,d);}c._setProperty_monkey.apply(c,arguments);};}});var a=0;this.getPlaces().each(function(c){var d=parseInt(c.properties["oryx-numberoftokens"]);if(isNaN(d)){c.setProperty("oryx-numberoftokens",0);}else{if(d>0){a+=d;}}});if(0==a){this.getPlaces().each(function(c){if(c.getIncomingShapes().length==0){c.setProperty("oryx-numberoftokens",1);}});Ext.Msg.show({title:"No Tokens Found",msg:"Current marking of the Petri net doesn't contain any token. Tokens are added to the initial places of the net.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});}if(a>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});}return true;},doMouseUp:function(c,a){if(!(this.isTransition(a))){return;}var b=this.getIncomingNodes(a).all(function(d){return parseInt(d.properties["oryx-numberoftokens"])>0;});if(b){this.fireTransition(a);}this.showEnabledTransition();},onDeactivate:function(){this.hideOverlays();while(this.firedTransitions.length!==0){this.undoLastFiredTransition();}this.facade.getCanvas().update();this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});},fireTransition:function(a){this.firedTransitions.push(a);this.getIncomingNodes(a).each(function(b){this.removeToken(b);}.bind(this));this.getOutgoingNodes(a).each(function(b){this.addToken(b);}.bind(this));},undoLastFiredTransition:function(){var a=this.firedTransitions.pop();if(!a){return;}this.getIncomingNodes(a).each(function(b){this.addToken(b);}.bind(this));this.getOutgoingNodes(a).each(function(b){this.removeToken(b);}.bind(this));},removeToken:function(a){a.setProperty("oryx-numberoftokens",parseInt(a.properties["oryx-numberoftokens"])-1);},addToken:function(a){var b=parseInt(a.properties["oryx-numberoftokens"])+1;a.setProperty("oryx-numberoftokens",b);if(b>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});}},showEnabledTransition:function(){this.hideOverlays();this.firedTransitions.each(function(a){this.showUsed(a,"1");}.bind(this));this.getEnabledTransitions().each(function(a){this.showPlayOnShape(a);}.bind(this));this.facade.getCanvas().update();},getTransitions:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return this.isTransition(a);}.bind(this));},isTransition:function(a){return a instanceof ORYX.Core.Shape&&a.getStencil().id().search(/Transition/)>-1;},getPlaces:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return a.getStencil().id().search(/Place/)>-1;});},getIncomingNodes:function(a){return a.getIncomingShapes().collect(function(b){return b.getIncomingShapes();}).flatten();},getOutgoingNodes:function(a){return a.getOutgoingShapes().collect(function(b){return b.getOutgoingShapes();}).flatten();},getEnabledTransitions:function(){return this.getTransitions().select(function(a){return this.getIncomingNodes(a).all(function(b){return parseInt(b.properties["oryx-numberoftokens"])>0;});}.bind(this));},undo:function(){this.undoLastFiredTransition();this.showEnabledTransition();}});ORYX.Plugins.StepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(a){this.el=undefined;this.callback=undefined;this.executionTrace="";this.rdf=undefined;arguments.callee.$.construct.apply(this,arguments);},prepareInitialMarking:function(){this.startNodes=[];Ext.each(this.facade.getCanvas().getChildShapes(true),function(a){if(this.isStartNode(a)){this.startNodes.push(a);a.initialMarkingFired=false;this.showPlayOnShape(a);if(a.getOutgoingShapes().size()==1){this.showOverlayOnShape(a.getOutgoingShapes()[0],{stroke:"green"});a.getOutgoingShapes()[0].initialMarking=true;}}}.createDelegate(this));},isStartNode:function(a){return(a.getStencil().id().search(/#Event$/)>-1)&&a.getIncomingShapes().length==0&&a.getOutgoingShapes().length==1;},isStartArc:function(a){return this.isStartNode(a.getIncomingShapes()[0]);},isStartArcOrNode:function(a){return this.isStartNode(a)||this.isStartArc(a);},generateRDF:function(){try{var b=this.getRDFFromDOM();b=!b.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+b:b;}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a);}this.rdf=b;},getRDF:function(){if(this.rdf==undefined){this.generateRDF();}return this.rdf;},startAndCheckSyntax:function(){this.postExecutionTrace({checkSyntax:true,onlyChangedObjects:false,onSuccess:function(a){if(a.responseText.startsWith("{")){var b=Ext.decode(a.responseText).syntaxErrors;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,errors:b});}else{this.showObjectStates(a.responseText);}}.bind(this)});},fireObject:function(a){this.executionTrace+=a+";";if(this.isOrSplit(this.el)){this.executionTrace=this.executionTrace.substring(0,this.executionTrace.length-1);this.executionTrace+="#";var c=new Ext.util.MixedCollection();c.addAll(this.el.getOutgoingShapes());var b=[];c.filter("selectedForOrSplit","true").each(function(d){b.push(d.resourceId);}.createDelegate(this));c.each(function(d){d.selectedForOrSplit=false;this.hideOverlayOnShape(d);}.createDelegate(this));this.executionTrace+=b.join(",")+";";}this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:true,onSuccess:function(d){if(d.responseText!=""){this.showObjectStates(d.responseText);}else{this.removeLastFiredObject();}}.bind(this)});},doMouseUp:function(d,a){if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge&&this.isOrSplit(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromOrSplit(a);}else{if(a instanceof ORYX.Core.Edge&&this.getDiagramType()==="epc"&&this.isStartNode(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromStartNode(a);}else{if(this.getDiagramType()==="epc"&&this.isStartNode(a)){a.initialMarkingFired=true;var c=a.getOutgoingShapes()[0];this.hideOverlayOnShape(c);if(c.initialMarking){this.showUsed(a,"1");this.initialMarking.push(a.resourceId);}else{this.hideOverlayOnShape(a);}var b=true;Ext.each(this.startNodes,function(e){if(!e.initialMarkingFired){b=false;}});if(b){this.startAndCheckSyntax();}}else{this.el=a;this.fireObject(this.el.resourceId);}}}}},showObjectStates:function(d){var a=d.split(";");for(i=0;i<a.size();i++){var b=a[i].split(",");if(b.size()<3){continue;}var c=this.facade.getCanvas().getChildShapeByResourceId(b[0]);if(b[2]=="t"){this.showEnabled(c,b[1]);}else{if(b[1]!="0"){this.showUsed(c,b[1]);}else{this.hideOverlayOnShape(c);}}}},doMouseUpOnEdgeComingFromOrSplit:function(b){var a=b.getIncomingShapes()[0];if(b.selectedForOrSplit){this.showOverlayOnShape(b,{stroke:"orange"});var c=new Ext.util.MixedCollection();c.addAll(a.getOutgoingShapes());if(c.filter("selectedForOrSplit","true").length<=1){this.hideOverlayOnShape(a);}}else{this.showOverlayOnShape(b,{stroke:"green"});this.showPlayOnShape(a);}b.selectedForOrSplit=!b.selectedForOrSplit;},doMouseUpOnEdgeComingFromStartNode:function(a){a.initialMarking=!a.initialMarking;if(a.initialMarking){this.showOverlayOnShape(a,{stroke:"green"});}else{this.showOverlayOnShape(a,{stroke:"orange"});}},isOrSplit:function(a){return(a.getStencil().id().search(/#(OR_Gateway|OrConnector)$/)>-1)&&(a.getOutgoingShapes().length>1);},showEnabledOrSplit:function(a){Ext.each(a.getOutgoingShapes(),function(b){Ext.apply(b,{selectedForOrSplit:false});this.showOverlayOnShape(b,{stroke:"orange"});}.createDelegate(this));},removeLastFiredObject:function(){this.executionTrace=this.executionTrace.replace(/[^;]*;$/,"");},undo:function(){if(!this.active()){return;}if(this.executionTrace!==""){this.removeLastFiredObject();this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:false,onSuccess:function(a){this.hideOverlays(true);this.showObjectStates(a.responseText);}.bind(this)});}else{if(this.getDiagramType()==="epc"){this.hideOverlays();this.prepareInitialMarking();}}},postExecutionTrace:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.StepThroughPlugin.executing});new Ajax.Request(ORYX.CONFIG.STEP_THROUGH,{method:"POST",asynchronous:false,parameters:{rdf:this.getRDF(),checkSyntax:a.checkSyntax,fire:this.executionTrace,onlyChangedObjects:a.onlyChangedObjects,initialMarking:this.initialMarking.join(";")},onSuccess:function(b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});a.onSuccess(b);}.createDelegate(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}.createDelegate(this)});}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.BPMN2Migration=Clazz.extend({enabled:true,facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":Signavio.I18N.Migration.Title,"group":Signavio.I18N.Migration.group,"index":2,dropDownGroupIcon:ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/page_transform.png","toggle":false,"description":Signavio.I18N.Migration.Description,"icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/page_bpmn2.png","functionality":this.migrateBPMN.bind(this),"minShape":0,"maxShape":0});},migrateBPMN:function(){var a=this.facade.getSerializedJSON();new Ajax.Request(ORYX.CONFIG.BPMN2MIGRATION,{method:"POST",parameters:{data:a,path:"/stencilsets/bpmn2.0"},onSuccess:function(c){var b=c.responseText;new Ajax.Request(ORYX.CONFIG.SERVER_EDITOR_CREATE_HANDLER,{method:"POST",parameters:{json_xml:b,directory:this.facade.getModelMetaData().parent,stencilset:"http://b3mn.org/stencilset/bpmn2.0#"},onSuccess:function(d){var e=d.responseText;window.setTimeout(function(){window.open(ORYX.CONFIG.SERVER_EDITOR_HANDLER+"?id="+e);},100);},onFailure:function(){Ext.Msg.alert("Signavio",Signavio.I18N.Migration.NewModelCreationError);}});}.bind(this),onFailure:function(){Ext.Msg.alert("Signavio",Signavio.I18N.Migration.MigrationError);}});}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.BPMN2_0Serialization={bpmnSerializationHandlerUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2_0serialization",bpmnDeserializationHandlerUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2_0deserialization",bpmn2XpdlSerializationHandlerUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2xpdlserialization",construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.Bpmn2_0Serialization.show,"functionality":this.showBpmnXml.bind(this),"group":"Export",dropDownGroupIcon:ORYX.PATH+"images/export2.png","icon":ORYX.PATH+"images/source.png","description":ORYX.I18N.Bpmn2_0Serialization.showDesc,"index":0,"minShape":0,"maxShape":0});this.facade.offer({"name":ORYX.I18N.Bpmn2_0Serialization.download,"functionality":this.downloadBpmnXml.bind(this),"group":"Export",dropDownGroupIcon:ORYX.PATH+"images/export2.png","icon":ORYX.PATH+"images/source.png","description":ORYX.I18N.Bpmn2_0Serialization.downloadDesc,"index":0,"minShape":0,"maxShape":0});this.facade.offer({"name":ORYX.I18N.Bpmn2_0Serialization.xpdlShow,"functionality":this.showXpdl.bind(this),"group":"Export",dropDownGroupIcon:ORYX.PATH+"images/export2.png","icon":ORYX.PATH+"images/source.png","description":ORYX.I18N.Bpmn2_0Serialization.xpdlShowDesc,"index":0,"minShape":0,"maxShape":0});this.facade.offer({"name":ORYX.I18N.Bpmn2_0Serialization.download,"functionality":this.downloadXpdl.bind(this),"group":"Export",dropDownGroupIcon:ORYX.PATH+"images/export2.png","icon":ORYX.PATH+"images/source.png","description":ORYX.I18N.Bpmn2_0Serialization.xpdlDownloadDesc,"index":0,"minShape":0,"maxShape":0});this.facade.offer({"name":ORYX.I18N.Bpmn2_0Serialization["import"],"functionality":this.showImportDialog.bind(this),"group":"Export",dropDownGroupIcon:ORYX.PATH+"images/import.png","icon":ORYX.PATH+"images/source.png","description":ORYX.I18N.Bpmn2_0Serialization.importDesc,"index":0,"minShape":0,"maxShape":0});},showBpmnXml:function(){this.generateBpmnXml(function(a){var b=a.evalJSON();this.showSchemaValidationEvent(b.validationEvents);this.openXMLWindow(b.xml);}.bind(this),this.bpmnSerializationHandlerUrl);},downloadBpmnXml:function(){this.generateBpmnXml(function(a){var b=a.evalJSON();this.showSchemaValidationEvent(b.validationEvents);this.openDownloadWindow("model.bpmn",b.xml);}.bind(this),this.bpmnSerializationHandlerUrl);},showSchemaValidationEvent:function(a){if(a&&ORYX.CONFIG.BPMN20_SCHEMA_VALIDATION_ON){this._showErrorMessageBox("Validation",a);}},showXpdl:function(){this.generateBpmnXml(function(a){this.openXMLWindow(a);}.bind(this),this.bpmn2XpdlSerializationHandlerUrl);},downloadXpdl:function(){this.generateBpmnXml(function(a){this.openDownloadWindow("model.xpdl",a);}.bind(this),this.bpmn2XpdlSerializationHandlerUrl);},generateBpmnXml:function(c,d){var b=new Ext.LoadMask(Ext.getBody(),{msg:"Serialization of BPMN 2.0 model"});b.show();var a=this.facade.getSerializedJSON();this._sendRequest(d,"POST",{"data":a},function(e){c(e);b.hide();}.bind(this),function(e){b.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.Bpmn2_0Serialization.serialFailed);ORYX.log.warn("Serialization of BPMN 2.0 model failed: "+e.responseText);}.bind(this));},showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.Bpmn2_0Serialization.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.Bpmn2_0Serialization.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.Bpmn2_0Serialization.name,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.Bpmn2_0Serialization.btnImp,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.Bpmn2_0Serialization.progress});d.show();window.setTimeout(function(){var f=c.items.items[2].getValue();try{this._sendRequest(this.bpmnDeserializationHandlerUrl,"POST",{"data":f},function(g){this.facade.importJSON(g,true);b.close();}.bind(this),function(g){d.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.Bpmn2_0Serialization.serialFailed);ORYX.log.warn("Serialization of BPMN 2.0 model failed: "+g.responseText);}.bind(this));}catch(e){Ext.Msg.alert(ORYX.I18N.Bpmn2_0Serialization.error,e.message);}finally{d.hide();}}.bind(this),100);}.bind(this)},{text:ORYX.I18N.Bpmn2_0Serialization.btnClose,handler:function(){b.close();}.bind(this)}]});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsText("UTF-8");c.items.items[2].setValue(e);},true);},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText);}}.bind(this),onFailure:function(g){if(a){a(g);}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Bpmn2Bpel.transfFailed);ORYX.log.warn("Serialization of BPMN 2.0 model failed: "+g.responseText);}}.bind(this)});return c;},_showErrorMessageBox:function(b,a){Ext.MessageBox.show({title:b,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}};ORYX.Plugins.BPMN2_0Serialization=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2_0Serialization);if(!ORYX.Plugins){ORYX.Plugins=new Object();}function gup(b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return"";}else{return c[1];}}ORYX.Plugins.Pnmlexport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.Pnmlexport.name,"functionality":this.exportIt.bind(this),"group":ORYX.I18N.Pnmlexport.group,"icon":ORYX.PATH+"images/bpmn2pn_deploy.png","description":ORYX.I18N.Pnmlexport.desc,"index":2,"minShape":0,"maxShape":0});},exportIt:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}).bind(this),10);return true;},exportSynchronously:function(){var d=location.href;try{var b=this.getRDFFromDOM();var c=gup("resource");new Ajax.Request(ORYX.CONFIG.PNML_EXPORT_URL,{method:"POST",asynchronous:false,parameters:{resource:d,data:b,title:c},onSuccess:function(g){var k=g.responseText;if(k.indexOf("RDF to BPMN failed with Exception:")==0){alert(k);}else{var f="http://"+location.host+ORYX.CONFIG.ROOT_PATH+k;var e="<h2>Process: "+self.document.title+'</h2><a target="_blank" href="'+f;var h=new Ext.Window({width:320,height:240,resizable:false,minimizable:false,modal:true,autoScroll:true,title:"Deployment successful",html:e,buttons:[{text:"OK",handler:function(){h.hide();}}]});h.show();}}});}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});alert(a);}}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.EPC2BPMN=Clazz.extend({facade:undefined,EPC_NAMESPACE:"http://b3mn.org/stencilset/epc#",BPMN1_0_NAMESPACE:"http://b3mn.org/stencilset/bpmn#",BPMN1_1_NAMESPACE:"http://b3mn.org/stencilset/bpmn1.1#",construct:function(a){this.facade=a;Facade=a;this.isBPMN1_0=this.facade.getStencilSets().keys().include(this.BPMN1_0_NAMESPACE);this.isBPMN1_1=this.facade.getStencilSets().keys().include(this.BPMN1_1_NAMESPACE);if(!this.isBPMN1_0&&!this.isBPMN1_1){return;}this.facade.offer({"name":"EPC to BPMN transform","functionality":this.startTransform.bind(this),"group":"epc","icon":ORYX.PATH+"images/epc_export.png","description":"Import from EPC","index":1,"minShape":0,"maxShape":0});},startTransform:function(){this.showPanel(this.sendRequest.bind(this));},sendRequest:function(c){var a=new Ext.Window({id:"oryx-loading-panel_epc2bpmn",bodyStyle:"padding: 8px",title:"Oryx",width:230,height:55,modal:true,resizable:false,closable:false,frame:true,html:'<span style="font-size:11px;">Please wait while importing...</span>'});a.show();if(!c||!c.url){return;}var b="./engineproxy?url="+c.url;new Ajax.Request(b,{method:"GET",onSuccess:function(d){window.setTimeout((function(){try{this.doTransform(d.responseText,c);}catch(f){Ext.Msg.alert(ORYX.I18N.Oryx.title,"An Error is occured while importing!");}Ext.getCmp("oryx-loading-panel_epc2bpmn").close();if(c.autolayout){window.setTimeout((function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_AUTOLAYOUT_LAYOUT});}).bind(this),100);}}).bind(this),100);}.bind(this),onFailure:function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,"Request to server failed!");}.bind(this)});},doTransform:function(p,f){var s=this.parseToObject(p);var x=[];if(!s){return;}var r=function(I){return s.find(function(J){return J.id==I;});};var z=function(J){var I=x.find(function(K){return K.epc==J;});if(I){I.shape.parent.remove(I.shape);x=x.without(I);}};var v=f&&f.events_throw?f.events_throw.split(";").compact().without("").without(" ").collect(function(I){return I.toLowerCase();}):[];var q=f&&f.events_catch?f.events_catch.split(";").compact().without("").without(" ").collect(function(I){return I.toLowerCase();}):[];var o=function(I){return v.any(function(J){return J.split(" ").all(function(K){return I.toLowerCase().include(K);});});};var k=function(I){return q.any(function(J){return J.split(" ").all(function(K){return I.toLowerCase().include(K);});});};var u=s.findAll(function(I){return I.type.endsWith("Function");});u.each(function(J){var I=this.createElement("Task",J,true);I.setProperty("oryx-name",J.title);I.setProperty("oryx-documentation",J.description);x.push({shape:I,epc:J});}.bind(this));var b=s.findAll(function(I){return I.type.endsWith("Event");});var y=b.findAll(function(I){return !s.any(function(J){return J.outgoing&&J.outgoing.any(function(K){return K.slice(1)==I.id;});});});y.each(function(J){var K=k(J.title)?"StartMessageEvent":"StartEvent";var I=this.createElement(K,J,true);if(K=="StartMessageEvent"){I.setProperty("oryx-message",J.title);}else{I.setProperty("oryx-documentation",J.title+" - "+J.description);}x.push({shape:I,epc:J});}.bind(this));var e=b.findAll(function(I){return !I.outgoing;});e.each(function(J){var K=this.isBPMN1_1&&o(J.title)?"MessageEndEvent":"EndEvent";var I=this.createElement(K,J,true);if(K=="MessageEndEvent"){I.setProperty("oryx-message",J.title);}else{I.setProperty("oryx-documentation",J.title+" - "+J.description);}if(this.isBPMN1_0&&o(J.title)){I.setProperty("oryx-result","Message");I.setProperty("oryx-message",J.title);}x.push({shape:I,epc:J});}.bind(this));var D=[].without.apply(b,y.concat(e));intermediateEventsCatch=D.findAll(function(I){return k(I.title);});intermediateEventsCatch.each(function(K){var J=this.isBPMN1_1?"IntermediateMessageEventCatching":"IntermediateMessageEvent";var I=this.createElement(J,K,true);I.setProperty("oryx-message",K.title);x.push({shape:I,epc:K});}.bind(this));intermediateFunctionsThrow=u.findAll(function(I){return o(I.title);});intermediateFunctionsThrow.each(function(L){z(L);var K=this.isBPMN1_1?"IntermediateMessageEventThrowing":"IntermediateMessageEvent";var M=L.outgoing?r(L.outgoing[0].slice(1)):null;if(M&&M.outgoing){var I=r(M.outgoing[0].slice(1));if(I&&I.type.endsWith("Event")&&!I.outgoing&&o(I.title)){z(I);K=this.isBPMN1_1?"MessageEndEvent":"EndEvent";}}var J=this.createElement(K,L,true);J.setProperty("oryx-message",L.title);if(this.isBPMN1_0&&K=="EndEvent"){J.setProperty("oryx-result","Message");}x.push({shape:J,epc:L});}.bind(this));var A=s.findAll(function(I){return I.type.endsWith("Connector");});A.each(function(K){var J="Exclusive_Databased_Gateway";if(K.type.endsWith("AndConnector")){J="AND_Gateway";}else{if(K.type.endsWith("OrConnector")){J="OR_Gateway";}}if(J=="Exclusive_Databased_Gateway"&&K.outgoing&&K.outgoing.all(function(L){return intermediateEventsCatch.include(r(r(L.slice(1)).outgoing[0].slice(1)));})){J="Exclusive_Eventbased_Gateway";}var I=this.createElement(J,K,true);x.push({shape:I,epc:K});}.bind(this));A.each(function(I){if(I.outgoing&&I.outgoing.length>1&&!I.type.endsWith("AndConnector")){I.outgoing.each(function(J){var K=r(J.slice(1));if(K.type.endsWith("ControlFlow")&&K.outgoing){K.outgoing.each(function(M){var L=r(M.slice(1));if(L.type.endsWith("Event")){K["expression"]=L.title;}});}});}}.bind(this));var F=s.findAll(function(I){return I.type.endsWith("Data");});F.each(function(J){var I=this.createElement("DataObject",J,true);I.setProperty("oryx-name",J.title);I.setProperty("oryx-documentation",J.description);x.push({shape:I,epc:J});}.bind(this));var g=s.findAll(function(I){return I.type.endsWith("System");});g.each(function(J){var I=this.createElement("TextAnnotation",J,true);I.setProperty("oryx-text","Used System: "+J.title);x.push({shape:I,epc:J});}.bind(this));var n=s.findAll(function(I){return I.type.endsWith("ProcessInterface");});n.each(function(K){var J=this.isBPMN1_1?"collapsedSubprocess":"Subprocess";var I=this.createElement(J,K,true);I.setProperty("oryx-name",K.title);I.setProperty("oryx-documentation",K.description);I.setProperty("raziel-entry",K.refuri);x.push({shape:I,epc:K});}.bind(this));var d=f.organization?s.findAll(function(I){return I.type.endsWith("Organization")||I.type.endsWith("Position");}):[];var H=d.collect(function(I){return I.title;}).uniq().sort();d=H.collect(function(I){return d.findAll(function(J){return J.title==I;});});if(d.length>0){var t=this.createElement("Pool");var E=[];var m=[];d.each(function(J){var I=this.createElement("Lane");I.setProperty("oryx-name",J[0].title);t.add(I);E.push({shape:I,epc:J[0]});J.each(function(M){var L=M.outgoing?M.outgoing.collect(function(N){return r(N.slice(1)).outgoing[0].slice(1);}):[];var K=x.findAll(function(N){return N.epc.type.endsWith("Function")||N.epc.type.endsWith("ProcessInterface");});K=K.findAll(function(N){return L.include(N.epc.id)||(N.epc.outgoing&&N.epc.outgoing.any(function(O){return r(O.slice(1)).outgoing.first().slice(1)==M.id;}));});K.each(function(N){I.add(N.shape);m.push(N);});});}.bind(this));var h=[].without.apply(x,m);var B=h.findAll(function(I){return I.epc.type.endsWith("Function")||I.epc.type.endsWith("ProcessInterface");});if(B.length>0){var G=this.createElement("Lane");t.add(G);B.each(function(I){G.add(I.shape);m.push(I);});}var h=[].without.apply(x,m);var a=function(J){if(!J){return[];}var I=[];J.each(function(K){var L=x.find(function(M){return M.epc.id==K.slice(1);});if(L){if(m.indexOf(L)>=0){throw $break;}if(h.indexOf(L)>=0){I.push(L);}I=I.concat(a(L.epc.outgoing));}else{I=I.concat(a(r(K.slice(1)).outgoing));}});return I;};m.each(function(I){var J=a(I.epc.outgoing);J.each(function(K){I.shape.parent.add(K.shape);h=h.without(K);});});var l=function(J){if(!J){return[];}var I;J.each(function(K){var L=x.find(function(M){return M.epc.id==K.slice(1);});if(L){if(m.indexOf(L)>=0){I=L;throw $break;}I=l(L.epc.outgoing);}else{I=l(r(K.slice(1)).outgoing);}});return I;};h.each(function(I){var J=l(I.epc.outgoing);if(J){J.shape.parent.add(I.shape);m.push(I);}});}var C=function(J){if(!J||!J.outgoing){return null;}var I=J;var K;while(!K){I=s.find(function(L){return I.outgoing&&I.outgoing.any(function(M){return M.slice(1)==L.id;});});K=x.find(function(L){return L.epc===I;});if(!I||!I.outgoing){break;}}return K;};var c=[];x.each(function(I){if(I.epc.outgoing){I.epc.outgoing.each(function(J){var L=s.find(function(M){return(M.type.endsWith("ControlFlow")||M.type.endsWith("Relation"))&&M.id==J.slice(1);});var K=C(L);if(L&&K){c.push({from:I,edge:L,to:K});}});}});c.each(function(J){var I;if(J.edge.type.endsWith("Relation")){if(J.edge.informationflow.toLowerCase()=="true"){I=this.createElement("Association_Unidirectional",J.edge);}else{I=this.createElement("Association_Undirected",J.edge);}}else{I=this.createElement("SequenceFlow",J.edge);}var L=J.from.shape;var K=J.to.shape;I.dockers.first().setDockedShape(L);I.dockers.first().setReferencePoint({x:L.bounds.width()/2,y:L.bounds.height()/2});I.dockers.last().setDockedShape(K);I.dockers.last().setReferencePoint({x:K.bounds.width()/2,y:K.bounds.height()/2});if(J.edge.expression){I.setProperty("oryx-conditionexpression",J.edge.expression);}x.push({shape:I,epc:J.edge});}.bind(this));this.facade.getCanvas().update();},createElement:function(g,b,f,e){var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+g);if(!d&&e){d=ORYX.Core.StencilSet.stencil(a+e);}if(!d){return null;}var c=(d.type()=="node")?new ORYX.Core.Node({"eventHandlerCallback":this.facade.raiseEvent},d):new ORYX.Core.Edge({"eventHandlerCallback":this.facade.raiseEvent},d);this.facade.getCanvas().add(c);if(b&&b.bounds&&f){c.bounds.centerMoveTo(b.bounds.center);}return c;},parseToObject:function(d){var h=new DOMParser();var f=h.parseFromString(d,"text/xml");var c=function(k){return $A(f.getElementsByTagName("div")).find(function(l){return l.getAttribute("id")==k;});};var a=c("oryxcanvas");a=a?a:c("oryx-canvas123");var e=a?$A(a.childNodes).any(function(k){return k.nodeName.toLowerCase()=="a"&&k.getAttribute("rel")=="oryx-stencilset"&&k.getAttribute("href").endsWith("epc/epc.json");}):null;if(!e){this.throwErrorMessage("Imported model is not an EPC model!");return null;}var b=$A(a.childNodes).collect(function(k){return k.nodeName.toLowerCase()=="a"&&k.getAttribute("rel")=="oryx-render"?k.getAttribute("href").slice(1):null;}).compact();b=b.collect(function(k){return c(k);});var g=function(l){var k={};if(l.getAttribute("id")){k["id"]=l.getAttribute("id");}$A(l.childNodes).each(function(n){if(n.nodeName.toLowerCase()=="span"&&n.getAttribute("class")){var m=n.getAttribute("class").slice(5);k[m]=n.firstChild?n.firstChild.nodeValue:"";if(m=="bounds"){var o=$A(k[m].split(",")).collect(function(p){return Number(p);});k[m]={a:{x:o[0],y:o[1]},b:{x:o[2],y:o[3]},center:{x:o[0]+((o[2]-o[0])/2),y:o[1]+((o[3]-o[1])/2)}};}}else{if(n.nodeName.toLowerCase()=="a"&&n.getAttribute("rel")){var m=n.getAttribute("rel").split("-")[1];if(!k[m]){k[m]=[];}k[m].push(n.getAttribute("href"));}}});return k;};return b.collect(function(k){return g(k);});},throwErrorMessage:function(a){Ext.Msg.alert(ORYX.I18N.Oryx.title,a);},showPanel:function(e){Ext.QuickTips.init();var b=new Ext.form.FormPanel({id:"transform-epc-bpmn-id-main",labelWidth:40,defaultType:"textfield",bodyStyle:"padding:5px",defaults:{width:300,msgTarget:"side"},items:[{text:"For the import and transformation from EPC to BPMN please set the URL to the EPC model.",xtype:"label",style:"padding-bottom:10px;display:block",width:"100%"},{fieldLabel:"URL",name:"last",allowBlank:false}]});var d=new Ext.form.FormPanel({id:"transform-epc-bpmn-id-advance",collapsed:true,labelWidth:30,defaultType:"textfield",bodyStyle:"padding:15px",defaults:{width:300,msgTarget:"side",labelSeparator:""},items:[{text:"Event-Mapping",xtype:"label",cls:"transform-epc-bpmn-title"},{text:"If u like to transform indivual event from EPC to event in BPMN, please give keyword regarding to these (separated with a ';').",xtype:"label",width:"100%",style:"margin-bottom:10px;display:block;"},{labelStyle:"background:transparent url(stencilsets/bpmn/icons/intermediate-message.png) no-repeat scroll 0px -1px;width:30px;height:20px",name:"events_catch"},{labelStyle:!this.isBPMN1_0?"background:transparent url(stencilsets/bpmn/icons/intermediate-message.png) no-repeat scroll 0px -30px;width:30px;height:20px":"display:none",name:"events_throw",style:this.isBPMN1_0?"display:none;":""},{text:"Organization",xtype:"label",style:"margin-top:10px;display:block;",cls:"transform-epc-bpmn-title"},{text:"Should the organizational units and roles maped to a pool/lane? (Required Auto-Layout)",xtype:"label",width:"100%",style:"margin-bottom:10px;display:block;"},{boxLabel:"Organization",name:"autolayout",id:"transform-epc-bpmn-id-organization",xtype:"checkbox",labelStyle:"width:30px;height:20px"},{text:"Auto-Layout",xtype:"label",style:"margin-top:10px;display:block;",cls:"transform-epc-bpmn-title"},{text:"By enable the autolayout, the model will be auto layouted afterwards with the AutoLayout Plugin. (Needs a while)",xtype:"label",width:"100%",style:"margin-bottom:10px;display:block;"},{boxLabel:"Auto-Layout",name:"autolayout",id:"transform-epc-bpmn-id-autolayout",xtype:"checkbox",labelStyle:"width:30px;height:20px"}]});Ext.getCmp("transform-epc-bpmn-id-organization").on("check",function(g,f){if(f){Ext.getCmp("transform-epc-bpmn-id-autolayout").setValue(true);Ext.getCmp("transform-epc-bpmn-id-autolayout").disable();}else{Ext.getCmp("transform-epc-bpmn-id-autolayout").enable();}});var c={text:"Advanced Settings",xtype:"button",enableToggle:true,cls:"transform-epc-bpmn-group-button",handler:function(f){var f=Ext.getCmp("transform-epc-bpmn-id-advance");if(f.collapsed){f.expand();}else{f.collapse();}}};var a=new Ext.Window({title:ORYX.I18N.Oryx.title+" - Transform EPC to BPMN",width:400,id:"transform-epc-bpmn-id-panel",cls:"transform-epc-bpmn-window",items:new Ext.Panel({frame:true,autoHeight:true,items:[b,c,d]}),floating:true,shim:true,modal:true,resizable:false,autoHeight:true,buttons:[{text:"Import",handler:function(){var f={};var g=Ext.getCmp("transform-epc-bpmn-id-main").findByType("textfield")[0];if(g.validate()){f.url=g.getValue();}if(!Ext.getCmp("transform-epc-bpmn-id-advance").collapsed){f.events_catch=Ext.getCmp("transform-epc-bpmn-id-advance").findByType("textfield")[0].getValue();if(this.isBPMN1_1){f.events_throw=Ext.getCmp("transform-epc-bpmn-id-advance").findByType("textfield")[1].getValue();}f.organization=Ext.getCmp("transform-epc-bpmn-id-advance").findByType("checkbox")[0].getValue();f.autolayout=Ext.getCmp("transform-epc-bpmn-id-advance").findByType("checkbox")[1].getValue();}Ext.getCmp("transform-epc-bpmn-id-panel").close();e(f);}.bind(this)},{text:"Cancel",handler:function(){Ext.getCmp("transform-epc-bpmn-id-panel").close();}}]});a.show();}});var Facade=undefined;Ext.ns("Oryx.Plugins");ORYX.Plugins.LolaPetriNetSoundnessChecker=ORYX.Plugins.AbstractPlugin.extend({hideOverlays:function(){if(!this.overlayIds){return;}Ext.each(this.overlayIds,function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));},getChildShapesByResourceIds:function(b){var a=[];Ext.each(b,function(c){a.push(this.facade.getCanvas().getChildShapeByResourceId(c));}.bind(this));return a;},showOverlay:function(a,b,e,c){if(!this.overlayIds){this.overlayIds=[];}if(!(a instanceof Array)){a=[a];}a=a.map(function(f){var g=f;if(typeof f=="string"){g=this.facade.getCanvas().getChildShapeByResourceId(f);g=g||this.facade.getCanvas().getChildById(f,true);}return g;}.bind(this)).compact();var d=this.type+ORYX.Editor.provideId();this.overlayIds.push(d);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:d,shapes:a,attributes:b,node:e,nodePosition:c||"NW"});},construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":"Check soundness","functionality":this.showCheckerWindow.bind(this),"group":"Verification","icon":ORYX.PATH+"images/soundness_checker/accept.png","description":"Checks current Petri net for different soundness criteria with LoLA.","index":3,"minShape":0,"maxShape":0});},showCheckerWindow:function(){var d=this;var b=Ext.extend(Ext.tree.TreeNode,{constructor:function(h){if(!h.icon&&!this.icon){h.icon=b.UNKNOWN_STATUS;}b.superclass.constructor.apply(this,arguments);Ext.apply(this,h);if(this.clickHandler){this.on("click",this.clickHandler.bind(this));}},setIcon:function(h){this.ui.getIconEl().src=h;},getIcon:function(h){return this.ui.getIconEl().src;},reset:function(){d.hideOverlays();this.hideMarking();d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});},hideMarking:function(){if(!d.marking){return;}for(place in d.marking){var h=d.facade.getCanvas().getChildShapeByResourceId(place);if(h){h.setProperty("oryx-numberoftokens",0);}}d.facade.getCanvas().update();d.marking=undefined;},showMarking:function(k){d.marking=k;for(place in k){var h=d.facade.getCanvas().getChildShapeByResourceId(place);h.setProperty("oryx-numberoftokens",k[place]);}d.facade.getCanvas().update();},showErrors:function(h){Ext.each(this.childNodes,function(k){if(k&&k.itemCls==="error"){k.remove();}});Ext.each(this.childNodes,function(k){if(k.getIcon().search(b.LOADING_STATUS)>-1){k.setIcon(b.UNKNOWN_STATUS);}});Ext.each(h,function(k){this.insertBefore(new b({icon:b.ERROR_STATUS,text:k,itemCls:"error"}),this.childNodes[0]);}.bind(this));},showOverlayWithStep:function(h){Ext.each(h,function(l,k){d.showOverlay(d.facade.getCanvas().getChildShapeByResourceId(l),{fill:"#FB7E02"},ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{"style":"font-size: 16px; font-weight: bold;"},(k+1)+"."]),"SE");});},showOverlayMarking:function(h){Ext.each(h,function(m,k){var l=m.split(":");d.showOverlay(d.facade.getCanvas().getChildShapeByResourceId(l[0].trim()),{fill:"#FB7E02"},ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{"style":"font-size: 16px; font-weight: bold;"},(l[1])]),"SE");});},showOverlay:function(h){if(h.length===0){return;}if(!h[0] instanceof ORYX.Core.Node){h=d.getChildShapesByResourceIds(h);}d.showOverlay(h,{fill:"#FB7E02"});}});b.UNKNOWN_STATUS=ORYX.PATH+"images/soundness_checker/"+"asterisk_yellow.png";b.ERROR_STATUS=ORYX.PATH+"images/soundness_checker/"+"exclamation.png";b.OK_STATUS=ORYX.PATH+"images/soundness_checker/"+"accept.png";b.LOADING_STATUS=ORYX.PATH+"images/soundness_checker/"+"loading.gif";var f=Ext.extend(b,{constructor:function(h){h.qtip="<b>Weak Termination</b>: Makes sure that from any state, reachable from the initial state, the final state well eventually be reached.";f.superclass.constructor.apply(this,arguments);},clickHandler:function(h){h.reset();this.showOverlayMarking(this.marking);},update:function(h){this.marking=h.counter?h.counter.split(","):[];this.setIcon(h.liveness?b.OK_STATUS:b.ERROR_STATUS);this.setText("There is "+(h.liveness?"no":"a")+" marking from which one cannot reach the final state.");}});var g=Ext.extend(b,{constructor:function(h){h.qtip="<b>Boundedness Criteria</b>: There are not unbounded places in the net. If any unbounded places are detected, click to show one counter example.";g.superclass.constructor.apply(this,arguments);},clickHandler:function(h){h.reset();this.showOverlay(this.unboundedplaces);},update:function(h){this.unboundedplaces=h.unboundedplaces;if(h.boundedness){this.unboundedplaces=[];}this.setIcon(h.boundedness?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.unboundedplaces.length+" unbounded places.");}});var a=Ext.extend(b,{constructor:function(h){h.qtip="<b>No Dead Transitions Criteria</b>: Each transition can contribute to at least one process instance. Click to see all dead transitions.";a.superclass.constructor.apply(this,arguments);},clickHandler:function(h){h.reset();this.showOverlay(this.deadTransitions);},update:function(h){this.deadTransitions=h.deadtransitions;if(h.quasiliveness){this.deadTransitions=[];}this.setIcon(this.deadTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.deadTransitions.length+" dead transitions.");}});var e=Ext.extend(b,{constructor:function(h){h.qtip="<b>Transition Participation Criteria</b>: Each transition participates in at least one process instance that starts in the initial state and reaches the final state. Click to see all transitions not participating in any process instance.";e.superclass.constructor.apply(this,arguments);},clickHandler:function(h){h.reset();this.showOverlay(this.notParticipatingTransitions);},update:function(h){this.notParticipatingTransitions=h.uncoveredtransitions;this.setIcon(this.notParticipatingTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.notParticipatingTransitions.length+" transitions that cannot participate in a properly terminating firing sequence.");}});var c=new Object;c.html='<a href="http://www.service-technology.org/">'+'<img src="'+ORYX.CONFIG.ROOT_PATH+'/images/service_tech_site_banner.png" width="400" style="position: relative; left: 35px;"/></a>';this.checkerWindow=new Ext.Window({title:"Soundness Checker powered by service-technology.org",autoScroll:true,width:"500",tbar:[{text:"Check",handler:function(){this.checkerWindow.check();}.bind(this)},{text:"Hide Errors",handler:function(){this.checkerWindow.getTree().getRootNode().reset();}.bind(this)},"->",{text:"Close",handler:function(){this.checkerWindow.close();}.bind(this)}],getTree:function(){return this.items.get(0);},check:function(h){this.prepareCheck(h);this.checkSyntax(this.checkSoundness.bind(this),this.reRender.bind(this));},reRender:function(){window.setTimeout(function(){this.getResizeEl().beforeAction();this.getResizeEl().sync(true);}.bind(this),70);},prepareCheck:function(k){var h=this.getTree().getRootNode();h.reset();Ext.each(h.childNodes,function(l){if(k){l.expand(true);}l.collapse(true);l.setIcon(b.LOADING_STATUS);});},checkSyntax:function(k,h){d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!");this.turnLoadingIntoUnknownStatus();h();}.bind(this),onNoErrors:function(){k();h();}});},turnLoadingIntoUnknownStatus:function(){Ext.each(this.getTree().getRootNode().childNodes,function(h){if(h.getIcon().search(b.LOADING_STATUS)>-1){h.setIcon(b.UNKNOWN_STATUS);}});},checkSoundness:function(){var h=this.getTree().getRootNode();if(!h.findChild("id","structuralSound").check()){this.turnLoadingIntoUnknownStatus();return;}var k=d.getRDFFromDOM();if(!k.startsWith("<?xml")){k='<?xml version="1.0" encoding="UTF-8"?>'+k;}Ext.Ajax.request({url:ORYX.CONFIG.LOLA_PN_CHECKER,method:"POST",success:function(m){var l=Ext.decode(m.responseText);h.showErrors(l.errors);if(l.errors.length===0){h.findChild("id","sound").check(l);h.findChild("id","weakSound").check(l);h.findChild("id","relaxedSound").check(l);}}.bind(this),failure:function(){}.bind(this),params:{data:k}});},items:[new Ext.tree.TreePanel({useArrows:true,autoScroll:true,rootVisible:false,animate:true,containerScroll:true,root:new b({text:"Checks",id:"source",expanded:true}),listeners:{render:function(m){var k=new b({text:"Structural Sound (Workflow Net)",id:"structuralSound",check:function(){this.checkInitialNode.update();this.checkFinalNode.update();this.checkConnectedNode.update(this.checkInitialNode.initialNodes,this.checkFinalNode.finalNodes);if(this.checkInitialNode.hasErrors()||this.checkFinalNode.hasErrors()||this.checkConnectedNode.hasErrors()){this.setIcon(b.ERROR_STATUS);this.expand();return false;}else{this.setIcon(b.OK_STATUS);return true;}},checkInitialNode:new b({qtip:"There must be exactly one initial place, which is the only place without any incoming edges.",update:function(){this.initialNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(o){if(o.getIncomingShapes().length==0&&o.getStencil().id().search(/Place/)>-1){this.initialNodes.push(o);}}.bind(this));this.setText(this.initialNodes.length+" initial places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS);},clickHandler:function(o){o.reset();this.showOverlay(this.initialNodes);},hasErrors:function(){return this.initialNodes.length!==1;}}),checkFinalNode:new b({qtip:"There must be exactly one final place, which is the only place without any outgoing edges.",update:function(){this.finalNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(o){if(o.getOutgoingShapes().length==0&&o.getStencil().id().search(/Place/)>-1){this.finalNodes.push(o);}}.bind(this));this.setText(this.finalNodes.length+" final places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS);},clickHandler:function(o){o.reset();this.showOverlay(this.finalNodes);},hasErrors:function(){return this.finalNodes.length!==1;}}),checkConnectedNode:new b({qtip:"Each node in the process model is on the path from the initial node to the final node.",update:function(p,o){if(p.length!==1||o.length!==1){this.setText("There must be exactly one initial and final place to perform further checks!");this.setIcon(b.UNKNOWN_STATUS);return;}this.notParticipatingNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(q){if(q instanceof ORYX.Core.Node){this.notParticipatingNodes.push(q);}}.bind(this));this.passedNodes=[];this.findNotParticipatingNodes(p[0]);this.setText(this.notParticipatingNodes.length+" nodes that aren't on any path from beginning to end found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS);},clickHandler:function(o){o.reset();this.showOverlay(this.notParticipatingNodes);},findNotParticipatingNodes:function(o){this.passedNodes.push(o);this.notParticipatingNodes.remove(o);Ext.each(o.getOutgoingShapes(),function(p){if(!this.passedNodes.include(p)){this.findNotParticipatingNodes(p);}}.bind(this));},hasErrors:function(){return this.notParticipatingNodes.length!==0;}})});k.appendChild([k.checkInitialNode,k.checkFinalNode,k.checkConnectedNode]);var h=new b({text:"Sound",id:"sound",check:function(o){if(o.soundness){this.setIcon(b.OK_STATUS);}else{this.setIcon(b.ERROR_STATUS);this.expand();}this.deadTransitionsNode.update(o);this.boundednessNode.update(o);this.livenessNode.update(o);},deadTransitionsNode:new a({}),boundednessNode:new g({}),livenessNode:new f({})});h.appendChild([h.deadTransitionsNode,h.boundednessNode,h.livenessNode]);var n=new b({text:"Weak Sound",id:"weakSound",check:function(o){if(o.weaksoundness){this.setIcon(b.OK_STATUS);}else{this.setIcon(b.ERROR_STATUS);this.expand();}this.boundednessNode.update(o);this.livenessNode.update(o);},boundednessNode:new g({}),livenessNode:new f({})});n.appendChild([n.boundednessNode,n.livenessNode]);var l=new b({text:"Relaxed Sound",id:"relaxedSound",check:function(o){if(o.relaxedsoundness){this.setIcon(b.OK_STATUS);}else{this.setIcon(b.ERROR_STATUS);this.expand();}this.deadTransitionsNode.update(o);this.notParticipatingTransitionsNode.update(o);},deadTransitionsNode:new a({}),notParticipatingTransitionsNode:new e({})});l.appendChild([l.notParticipatingTransitionsNode,l.deadTransitionsNode]);m.getRootNode().appendChild([k,h,n,l]);}}}),c],listeners:{close:function(h){this.checkerWindow.getTree().getRootNode().reset();}.bind(this)}});this.checkerWindow.show();this.checkerWindow.check(true);}});Ext.ns("Oryx.Plugins");ORYX.Plugins.PetriNetSoundnessChecker=ORYX.Plugins.AbstractPlugin.extend({hideOverlays:function(){if(!this.overlayIds){return;}Ext.each(this.overlayIds,function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));},getChildShapesByResourceIds:function(b){var a=[];Ext.each(b,function(c){a.push(this.facade.getCanvas().getChildShapeByResourceId(c));}.bind(this));return a;},showOverlay:function(a,b,e,c){if(!this.overlayIds){this.overlayIds=[];}if(!(a instanceof Array)){a=[a];}a=a.map(function(f){var g=f;if(typeof f=="string"){g=this.facade.getCanvas().getChildShapeByResourceId(f);g=g||this.facade.getCanvas().getChildById(f,true);}return g;}.bind(this)).compact();var d=this.type+ORYX.Editor.provideId();this.overlayIds.push(d);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:d,shapes:a,attributes:b,node:e,nodePosition:c||"NW"});},construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":"Check soundness","functionality":this.showCheckerWindow.bind(this),"group":"Verification","icon":ORYX.PATH+"images/checker_validation.png","description":"Checks current Petri net for different soundness criteria.","index":3,"minShape":0,"maxShape":0});},showCheckerWindow:function(){var d=this;var b=Ext.extend(Ext.tree.TreeNode,{constructor:function(g){if(!g.icon&&!this.icon){g.icon=b.UNKNOWN_STATUS;}b.superclass.constructor.apply(this,arguments);Ext.apply(this,g);if(this.clickHandler){this.on("click",this.clickHandler.bind(this));}},setIcon:function(g){this.ui.getIconEl().src=g;},getIcon:function(g){return this.ui.getIconEl().src;},reset:function(){d.hideOverlays();this.hideMarking();d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});},hideMarking:function(){if(!d.marking){return;}for(place in d.marking){var g=d.facade.getCanvas().getChildShapeByResourceId(place);if(g){g.setProperty("oryx-numberoftokens",0);}}d.facade.getCanvas().update();d.marking=undefined;},showMarking:function(h){d.marking=h;for(place in h){var g=d.facade.getCanvas().getChildShapeByResourceId(place);g.setProperty("oryx-numberoftokens",h[place]);}d.facade.getCanvas().update();},showErrors:function(g){Ext.each(this.childNodes,function(h){if(h&&h.itemCls==="error"){h.remove();}});Ext.each(this.childNodes,function(h){if(h.getIcon().search(b.LOADING_STATUS)>-1){h.setIcon(b.UNKNOWN_STATUS);}});Ext.each(g,function(h){this.insertBefore(new b({icon:b.ERROR_STATUS,text:h,itemCls:"error"}),this.childNodes[0]);}.bind(this));},showOverlayWithStep:function(g){Ext.each(g,function(k,h){d.showOverlay(d.facade.getCanvas().getChildShapeByResourceId(k),{fill:"#FB7E02"},ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{"style":"font-size: 16px; font-weight: bold;"},(h+1)+"."]),"SE");});},showOverlay:function(g){if(g.length===0){return;}if(!g[0] instanceof ORYX.Core.Node){g=d.getChildShapesByResourceIds(g);}d.showOverlay(g,{fill:"#FB7E02"});}});b.UNKNOWN_STATUS=ORYX.PATH+"images/soundness_checker/"+"asterisk_yellow.png";b.ERROR_STATUS=ORYX.PATH+"images/soundness_checker/"+"exclamation.png";b.OK_STATUS=ORYX.PATH+"images/soundness_checker/"+"accept.png";b.LOADING_STATUS=ORYX.PATH+"images/soundness_checker/"+"loading.gif";var c=Ext.extend(b,{constructor:function(g){g.qtip="<b>Termination Criteria</b>: Makes sure that any process instance that starts in the initial state will eventually reach the final state. If any dead locks are detected, click to show one counter example.";c.superclass.constructor.apply(this,arguments);},clickHandler:function(h){h.reset();if(this.deadLocks.length==0){return;}var g=h.deadLocks[0];this.showOverlayWithStep(g.path);this.showMarking(g.marking);},update:function(g){this.deadLocks=g;this.setIcon(this.deadLocks.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There is "+(this.deadLocks.length==0?"no":"a")+" path that leads to a deadlock.");}});var f=Ext.extend(b,{constructor:function(g){g.qtip="<b>Proper Termination Criteria</b>: The final state is the only state reachable from the initial state in which there is a token in the final place. If any improper terminating states are detected, click to show one counter example.";f.superclass.constructor.apply(this,arguments);},clickHandler:function(h){h.reset();if(h.improperTerminatings.length==0){return;}var g=h.improperTerminatings[0];this.showOverlayWithStep(g.path);this.showMarking(g.marking);},update:function(g){this.improperTerminatings=g;this.setIcon(this.improperTerminatings.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.improperTerminatings.length+" markings covering the final marking.");}});var a=Ext.extend(b,{constructor:function(g){g.qtip="<b>No Dead Transitions Criteria</b>: Each transition can contribute to at least one process instance. Click to see all dead transitions.";a.superclass.constructor.apply(this,arguments);},clickHandler:function(g){g.reset();this.showOverlay(this.deadTransitions);},update:function(g){this.deadTransitions=g;this.setIcon(this.deadTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.deadTransitions.length+" dead transitions.");}});var e=Ext.extend(b,{constructor:function(g){g.qtip="<b>Transition Participation Criteria</b>: Each transition participates in at least one process instance that starts in the initial state and reaches the final state. Click to see all transitions not participating in any process instance.";e.superclass.constructor.apply(this,arguments);},clickHandler:function(g){g.reset();this.showOverlay(this.notParticipatingTransitions);},update:function(g){this.notParticipatingTransitions=g;this.setIcon(this.notParticipatingTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.notParticipatingTransitions.length+" transitions that cannot participate in a properly terminating firing sequence.");}});this.checkerWindow=new Ext.Window({title:"Soundness Checker",autoScroll:true,width:"500",tbar:[{text:"Check",handler:function(){this.checkerWindow.check();}.bind(this)},{text:"Hide Errors",handler:function(){this.checkerWindow.getTree().getRootNode().reset();}.bind(this)},"->",{text:"Close",handler:function(){this.checkerWindow.close();}.bind(this)}],getTree:function(){return this.items.get(0);},check:function(g){this.prepareCheck(g);this.checkSyntax(this.checkSoundness.bind(this));},prepareCheck:function(h){var g=this.getTree().getRootNode();g.reset();Ext.each(g.childNodes,function(k){if(h){k.expand(true);}k.collapse(true);k.setIcon(b.LOADING_STATUS);});},checkSyntax:function(g){d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!");this.turnLoadingIntoUnknownStatus();}.bind(this),onNoErrors:function(){g();}});},turnLoadingIntoUnknownStatus:function(){Ext.each(this.getTree().getRootNode().childNodes,function(g){if(g.getIcon().search(b.LOADING_STATUS)>-1){g.setIcon(b.UNKNOWN_STATUS);}});},checkSoundness:function(){var g=this.getTree().getRootNode();if(!g.findChild("id","structuralSound").check()){this.turnLoadingIntoUnknownStatus();return;}Ext.Ajax.request({url:ORYX.CONFIG.PN_CHECKER,method:"POST",success:function(k){var h=Ext.decode(k.responseText);g.showErrors(h.errors);if(h.errors.length===0){g.findChild("id","sound").check(h);g.findChild("id","weakSound").check(h);g.findChild("id","relaxedSound").check(h);}},failure:function(){},params:{data:d.getSerializedDOM()}});},items:[new Ext.tree.TreePanel({useArrows:true,autoScroll:true,rootVisible:false,animate:true,containerScroll:true,root:new b({text:"Checks",id:"source",expanded:true}),listeners:{render:function(l){var h=new b({text:"Structural Sound (Workflow Net)",id:"structuralSound",check:function(){this.checkInitialNode.update();this.checkFinalNode.update();this.checkConnectedNode.update(this.checkInitialNode.initialNodes,this.checkFinalNode.finalNodes);if(this.checkInitialNode.hasErrors()||this.checkFinalNode.hasErrors()||this.checkConnectedNode.hasErrors()){this.setIcon(b.ERROR_STATUS);this.expand();return false;}else{this.setIcon(b.OK_STATUS);return true;}},checkInitialNode:new b({qtip:"There must be exactly one initial place, which is the only place without any incoming edges.",update:function(){this.initialNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(n){if(n.getIncomingShapes().length==0&&n.getStencil().id().search(/Place/)>-1){this.initialNodes.push(n);}}.bind(this));this.setText(this.initialNodes.length+" initial places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS);},clickHandler:function(n){n.reset();this.showOverlay(this.initialNodes);},hasErrors:function(){return this.initialNodes.length!==1;}}),checkFinalNode:new b({qtip:"There must be exactly one final place, which is the only place without any outgoing edges.",update:function(){this.finalNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(n){if(n.getOutgoingShapes().length==0&&n.getStencil().id().search(/Place/)>-1){this.finalNodes.push(n);}}.bind(this));this.setText(this.finalNodes.length+" final places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS);},clickHandler:function(n){n.reset();this.showOverlay(this.finalNodes);},hasErrors:function(){return this.finalNodes.length!==1;}}),checkConnectedNode:new b({qtip:"Each node in the process model is on the path from the initial node to the final node.",update:function(o,n){if(o.length!==1||n.length!==1){this.setText("There must be exactly one initial and final place to perform further checks!");this.setIcon(b.UNKNOWN_STATUS);return;}this.notParticipatingNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(p){if(p instanceof ORYX.Core.Node){this.notParticipatingNodes.push(p);}}.bind(this));this.passedNodes=[];this.findNotParticipatingNodes(o[0]);this.setText(this.notParticipatingNodes.length+" nodes that aren't on any path from beginning to end found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS);},clickHandler:function(n){n.reset();this.showOverlay(this.notParticipatingNodes);},findNotParticipatingNodes:function(n){this.passedNodes.push(n);this.notParticipatingNodes.remove(n);Ext.each(n.getOutgoingShapes(),function(o){if(!this.passedNodes.include(o)){this.findNotParticipatingNodes(o);}}.bind(this));},hasErrors:function(){return this.notParticipatingNodes.length!==0;}})});h.appendChild([h.checkInitialNode,h.checkFinalNode,h.checkConnectedNode]);var g=new b({text:"Sound",id:"sound",check:function(n){if(n.isSound){this.setIcon(b.OK_STATUS);}else{this.setIcon(b.ERROR_STATUS);this.expand();}this.deadTransitionsNode.update(n.deadTransitions);this.improperTerminatingsNode.update(n.improperTerminatings);this.deadLocksNode.update(n.deadLocks);},deadTransitionsNode:new a({}),improperTerminatingsNode:new f({}),deadLocksNode:new c({})});g.appendChild([g.deadTransitionsNode,g.improperTerminatingsNode,g.deadLocksNode]);var m=new b({text:"Weak Sound",id:"weakSound",check:function(n){if(n.isWeakSound){this.setIcon(b.OK_STATUS);}else{this.setIcon(b.ERROR_STATUS);this.expand();}this.improperTerminatingsNode.update(n.improperTerminatings);this.deadLocksNode.update(n.deadLocks);},deadTransitionsNode:new a({}),improperTerminatingsNode:new f({}),deadLocksNode:new c({})});m.appendChild([m.improperTerminatingsNode,m.deadLocksNode]);var k=new b({text:"Relaxed Sound",id:"relaxedSound",check:function(n){if(n.isRelaxedSound){this.setIcon(b.OK_STATUS);}else{this.setIcon(b.ERROR_STATUS);this.expand();}this.notParticipatingTransitionsNode.update(n.notParticipatingTransitions);},notParticipatingTransitionsNode:new e({})});k.appendChild([k.notParticipatingTransitionsNode]);l.getRootNode().appendChild([h,g,m,k]);}}})],listeners:{close:function(g){this.checkerWindow.getTree().getRootNode().reset();}.bind(this)}});this.checkerWindow.show();this.checkerWindow.check(true);}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.SimplePnmlexport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.SimplePnmlexport.name,"functionality":this.exportIt.bind(this),"group":ORYX.I18N.SimplePnmlexport.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png","icon":ORYX.PATH+"images/page_white_gear.png","description":ORYX.I18N.SimplePnmlexport.desc,"index":1,"minShape":0,"maxShape":0});this.facade.offer({"name":"PNML For LOLA","functionality":this.exportIt.bind(this,true),"group":ORYX.I18N.SimplePnmlexport.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png","icon":ORYX.PATH+"images/page_white_gear.png","description":ORYX.I18N.SimplePnmlexport.desc,"index":1,"minShape":0,"maxShape":0});},exportIt:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously(a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}).bind(this),10);return true;},exportSynchronously:function(e){var d=location.href;var b="none";if(e){b="lola";}try{var c=this.getRDFFromDOM();if(!c.startsWith("<?xml")){c='<?xml version="1.0" encoding="UTF-8"?>'+c;}new Ajax.Request(ORYX.CONFIG.SIMPLE_PNML_EXPORT_URL,{method:"POST",asynchronous:false,parameters:{resource:d,data:c,tool:b},onSuccess:function(f){this.openDownloadWindow(window.document.title+".xml",f.responseText);}.bind(this)});}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a);}}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Validator=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.buttonId=ORYX.Editor.provideId();this.facade.offer({"name":ORYX.I18N.Validator.name,"id":this.buttonId,"functionality":this.load.bind(this),"group":"Verification","icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/cog_error.png","description":ORYX.I18N.Validator.description,"index":1,"toggle":true,"minShape":0,"maxShape":0});},load:function(a,b){if(!b){this.hideOverlays();this.active=!this.active;}else{this.validate(a);}},setActive:function(a){this.active=a;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_BUTTON_UPDATE,id:this.buttonId,pressed:a});},hideOverlays:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));this.raisedEventIds=[];},validate:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Validator.checking});new Ajax.Request(ORYX.CONFIG.VALIDATOR_URL,{method:"POST",asynchronous:false,parameters:{resource:location.href,data:this.getRDFFromDOM()},onSuccess:function(c){var b=Ext.decode(c.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});this.handleValidationResponse(b,a);}.bind(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Validator.error,ORYX.I18N.Validator.errorDesc);}.bind(this)});},showOverlay:function(b,c,a){var g="syntaxchecker."+this.raisedEventIds.length;var e=ORYX.Editor.provideId();var f=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"id":e,"title":"","stroke-width":5,"stroke":"red","d":"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:g,shapes:[b],node:f,nodePosition:b instanceof ORYX.Core.Edge?"START":"NW"});this.raisedEventIds.push(g);var d=new Ext.ToolTip({showDelay:50,title:a,html:c,target:e});return f;},enableDeactivationHandler:function(a){var b=function(){this.setActive(false);this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b);};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b.bind(this));}});ORYX.Plugins.BPMNValidator=Ext.extend(ORYX.Plugins.Validator,{handleValidationResponse:function(a,e){var f=a.conflictingNodes;var c=a.leadsToEnd;var b=a.unsafeNode;this.setActive(f.size()>0);if(f.size()>0){f.each(function(g){sh=this.facade.getCanvas().getChildShapeByResourceId(g.id);if(sh){this.showOverlay(sh,ORYX.I18N.Validator.bpmnDeadlock,ORYX.I18N.Validator.bpmnDeadlockTitle);}}.bind(this));}if(b){var d=this.facade.getCanvas().getChildShapeByResourceId(b);if(d){this.showOverlay(d,ORYX.I18N.Validator.bpmnUnsafe,ORYX.I18N.Validator.bpmnUnsafeTitle);}}if(c&&f.size()===0&&!b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Validator.noErrors,timeout:10000});}else{if(!c&&f.size()===0&&!b){Ext.Msg.alert(ORYX.I18N.Validator.bpmnLeadsToNoEndTitle,ORYX.I18N.Validator.bpmnLeadsToNoEnd);}else{this.enableDeactivationHandler(e);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.notice,timeout:10000});}}}});ORYX.Plugins.EPCValidator=Ext.extend(ORYX.Plugins.Validator,{getLabelOfShape:function(a){if(a.properties["oryx-title"]===""){return a.id;}else{return a.properties["oryx-title"];}},findShapeById:function(a){return this.facade.getCanvas().getChildShapeByResourceId(a);},handleValidationResponse:function(l,d){var g=l.isSound;var c=l.badStartArcs;var b=l.badEndArcs;var h=l.goodInitialMarkings;var e=l.goodFinalMarkings;var k="";if(g){k+=ORYX.I18N.Validator.epcIsSound;}else{k+=ORYX.I18N.Validator.epcNotSound;}k+="<hr />";var a=function(m,n){var o="<ul>";m.each(function(p){o+="<li> - ";p.each(function(q){o+='"'+n(q)+'" ';});o+="</li>";});o+="</ul>";return o;};var f=function(o,m){var n="<ul>";o.each(function(p){n+="<li> - "+m(p)+"</li>";});n+="</ul>";return n;};k+="<p>There are "+h.length+" initial markings which does not run into a deadlock.</p>";k+=a(h,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getIncomingShapes()[0]);}.createDelegate(this));k+="<p>The initial markings do not include "+c.length+" start nodes.</p>";k+=f(c,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getIncomingShapes()[0]);}.createDelegate(this));k+="<hr />";k+="<p>There are "+e.length+" final markings which can be reached from the initial markings.</p>";k+=a(e,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getOutgoingShapes()[0]);}.createDelegate(this));k+="<p>The final markings do not include "+b.length+" end nodes.</p>";k+=f(b,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getOutgoingShapes()[0]);}.createDelegate(this));k+="<hr />";k+="<p><i>Remark: Set titles of functions and events to get some nicer output (names instead of ids)</i></p>";Ext.Msg.alert("Validation Result",k);this.setActive(false);}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.Validator=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.buttonId=ORYX.Editor.provideId();this.facade.offer({"name":ORYX.I18N.Validator.name,"id":this.buttonId,"functionality":this.load.bind(this),"group":"Verification","icon":ORYX.CONFIG.EXPLORER_PATH+"/src/img/famfamfam/cog_error.png","description":ORYX.I18N.Validator.description,"index":1,"toggle":true,"minShape":0,"maxShape":0});},load:function(a,b){if(!b){this.hideOverlays();this.active=!this.active;}else{this.validate(a);}},setActive:function(a){this.active=a;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_BUTTON_UPDATE,id:this.buttonId,pressed:a});},hideOverlays:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a});}.bind(this));this.raisedEventIds=[];},validate:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Validator.checking});new Ajax.Request(ORYX.CONFIG.VALIDATOR_URL,{method:"POST",asynchronous:false,parameters:{resource:location.href,data:this.getRDFFromDOM()},onSuccess:function(c){var b=Ext.decode(c.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});this.handleValidationResponse(b,a);}.bind(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Validator.error,ORYX.I18N.Validator.errorDesc);}.bind(this)});},showOverlay:function(b,c,a){var g="syntaxchecker."+this.raisedEventIds.length;var e=ORYX.Editor.provideId();var f=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"id":e,"title":"","stroke-width":5,"stroke":"red","d":"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:g,shapes:[b],node:f,nodePosition:b instanceof ORYX.Core.Edge?"START":"NW"});this.raisedEventIds.push(g);var d=new Ext.ToolTip({showDelay:50,title:a,html:c,target:e});return f;},enableDeactivationHandler:function(a){var b=function(){this.setActive(false);this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b);};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b.bind(this));}});ORYX.Plugins.BPMNValidator=Ext.extend(ORYX.Plugins.Validator,{handleValidationResponse:function(a,e){var f=a.conflictingNodes;var c=a.leadsToEnd;var b=a.unsafeNode;this.setActive(f.size()>0);if(f.size()>0){f.each(function(g){sh=this.facade.getCanvas().getChildShapeByResourceId(g.id);if(sh){this.showOverlay(sh,ORYX.I18N.Validator.bpmnDeadlock,ORYX.I18N.Validator.bpmnDeadlockTitle);}}.bind(this));}if(b){var d=this.facade.getCanvas().getChildShapeByResourceId(b);if(d){this.showOverlay(d,ORYX.I18N.Validator.bpmnUnsafe,ORYX.I18N.Validator.bpmnUnsafeTitle);}}if(c&&f.size()===0&&!b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Validator.noErrors,timeout:10000});}else{if(!c&&f.size()===0&&!b){Ext.Msg.alert(ORYX.I18N.Validator.bpmnLeadsToNoEndTitle,ORYX.I18N.Validator.bpmnLeadsToNoEnd);}else{this.enableDeactivationHandler(e);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.notice,timeout:10000});}}}});ORYX.Plugins.EPCValidator=Ext.extend(ORYX.Plugins.Validator,{getLabelOfShape:function(a){if(a.properties["oryx-title"]===""){return a.id;}else{return a.properties["oryx-title"];}},findShapeById:function(a){return this.facade.getCanvas().getChildShapeByResourceId(a);},handleValidationResponse:function(l,d){var g=l.isSound;var c=l.badStartArcs;var b=l.badEndArcs;var h=l.goodInitialMarkings;var e=l.goodFinalMarkings;var k="";if(g){k+=ORYX.I18N.Validator.epcIsSound;}else{k+=ORYX.I18N.Validator.epcNotSound;}k+="<hr />";var a=function(m,n){var o="<ul>";m.each(function(p){o+="<li> - ";p.each(function(q){o+='"'+n(q)+'" ';});o+="</li>";});o+="</ul>";return o;};var f=function(o,m){var n="<ul>";o.each(function(p){n+="<li> - "+m(p)+"</li>";});n+="</ul>";return n;};k+="<p>There are "+h.length+" initial markings which does not run into a deadlock.</p>";k+=a(h,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getIncomingShapes()[0]);}.createDelegate(this));k+="<p>The initial markings do not include "+c.length+" start nodes.</p>";k+=f(c,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getIncomingShapes()[0]);}.createDelegate(this));k+="<hr />";k+="<p>There are "+e.length+" final markings which can be reached from the initial markings.</p>";k+=a(e,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getOutgoingShapes()[0]);}.createDelegate(this));k+="<p>The final markings do not include "+b.length+" end nodes.</p>";k+=f(b,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getOutgoingShapes()[0]);}.createDelegate(this));k+="<hr />";k+="<p><i>Remark: Set titles of functions and events to get some nicer output (names instead of ids)</i></p>";Ext.Msg.alert("Validation Result",k);this.setActive(false);}});if(!ORYX){ORYX=new Object();}if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.BpmnLayouter=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":"Layout-BPMN","description":"Layout BPMN Model","functionality":this.layout.bind(this),"group":"Layout","icon":ORYX.PATH+"images/auto_layout.png","index":1,"minShape":0,"maxShape":0});},layout:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Layouting.doing});new Ajax.Request(ORYX.CONFIG.BPMN_LAYOUTER,{method:"POST",asynchronous:false,parameters:{data:this.facade.getSerializedJSON(),output:"coordinatesonly"},onFailure:function(a){Ext.Msg.alert("Layouting Error","Error while layouting:!\n"+a.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});},onSuccess:function(b){var a=ORYX.Core.Command.extend({construct:function(f,e){this.layoutArray=f;this.plugin=e;this.oldLayoutArray=[];},execute:function(){this.layoutArray.each(function(h){var e=this.plugin.facade.getCanvas().getChildShapeByResourceId(h.id);var g={id:h.id,bounds:e.bounds.clone()};this.oldLayoutArray.push(g);var f=h.bounds.split(" ");e.bounds.set(f[0],f[1],f[2],f[3]);if(h.dockers!=null){this.plugin.setDockersBad(e,h.dockers);}e.update();}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();},rollback:function(){this.oldLayoutArray.each(function(f){var e=this.plugin.facade.getCanvas().getChildShapeByResourceId(f.id);e.bounds.set(f.bounds);e.update();}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();}});var d=b.responseText.evalJSON();if(d instanceof Array&&d.size()>0){var c=new a(d,this);this.facade.executeCommands([c]);}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}.bind(this)});},setDockersBad:function(c,a){var b="";a.each(function(d){b+=d.x+" "+d.y+" ";});b+=" # ";c.deserialize([{prefix:"oryx",name:"dockers",value:b}]);},setDockersGood:function(c,a){if(elem.dockers.length==1){}else{var a=c.getDockers().slice(1,-1);a.each(function(f){c.removeDocker(f);});var e=c.getDockers()[0];if(e.getDockedShape()){e.setReferencePoint(elem.dockers[0]);}else{e.bounds.moveTo(elem.dockers[0].x,elem.dockers[0].y);}e.refresh();var d=c.getDockers()[1];if(d.getDockedShape()){d.setReferencePoint(elem.dockers[elem.dockers.length-1]);}else{d.bounds.moveTo(elem.dockers[elem.dockers.length-1].x,elem.dockers[elem.dockers.length-1].y);}d.refresh();var b=elem.dockers.slice(1,-1);b.each(function(g){var f=c.createDocker(undefined,g);f.parent=c;f.bounds.centerMoveTo(g.x,g.y);f.update();});}}});Ext.namespace("ORYX.Plugins");ORYX.Plugins.AbstractStepThroughPlugin=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":ORYX.I18N.StepThroughPlugin.stepThrough,"functionality":this.load.bind(this),"group":ORYX.I18N.StepThroughPlugin.group,"icon":ORYX.PATH+"images/control_play.png","description":ORYX.I18N.StepThroughPlugin.stepThroughDesc,"index":1,"toggle":true,"minShape":0,"maxShape":0});this.facade.offer({"name":ORYX.I18N.StepThroughPlugin.undo,"functionality":this.undo.bind(this),"group":ORYX.I18N.StepThroughPlugin.group,"icon":ORYX.PATH+"images/control_rewind.png","description":ORYX.I18N.StepThroughPlugin.undoDesc,"index":2,"minShape":0,"maxShape":0});},showEnabled:function(a,b){if(!(a instanceof ORYX.Core.Shape)){return;}else{if(this.isOrSplit(a)){this.showEnabledOrSplit(a);return;}}this.showPlayOnShape(a);},showPlayOnShape:function(b){var a;if(b instanceof ORYX.Core.Edge){a={stroke:"green"};}else{a={fill:"green"};}var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"title":"Click the element to execute it!","stroke-width":2,"stroke":"black","d":"M0,-5 L5,0 L0,5 Z","line-captions":"round"}]);this.showOverlayOnShape(b,a,c);},showOverlayOnShape:function(b,a,c){this.hideOverlayOnShape(b);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:(c?c:null),nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"});},hideOverlayOnShape:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+a.resourceId});},hideOverlays:function(a){var b=this.facade.getCanvas().getChildShapes(true);var c;for(i=0;i<b.size();i++){c=b[i];if(!(a&&this.isStartNode(c))){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+c.resourceId});}}},load:function(a,b){this.initializeLoadButton(a,b);this.togglePlugin(b);},togglePlugin:function(a){if(a){this.initialMarking=[];if(this.getDiagramType()==="epc"){this.prepareInitialMarking();}else{this.startAndCheckSyntax();}}else{this.executionTrace="";this.rdf=undefined;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});this.onDeactivate();}if(this.active()){this.callback=this.doMouseUp.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback);}else{this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback);this.callback=undefined;}},onDeactivate:function(){this.hideOverlays();},initializeLoadButton:function(b,c){if(this.loadButton!==b){var a=function(d){if(d){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);}else{this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);}}.createDelegate(this);b.on("toggle",function(d,e){a(e);});a(b,c);}this.loadButton=b;},active:function(){return this.loadButton?this.loadButton.pressed:false;},onSelectionChanged:function(){if(this.active()&&this.facade.getSelection().length>0){this.facade.setSelection([]);}},getDiagramType:function(){switch(this.facade.getCanvas().getStencil().namespace()){case"http://b3mn.org/stencilset/epc#":return"epc";case"http://b3mn.org/stencilset/bpmn#":return"bpmn";default:return null;}},showUsed:function(b,c){if(!(b instanceof ORYX.Core.Shape)){return;}var a;if(b instanceof ORYX.Core.Edge){a={stroke:"mediumslateblue"};}else{a={fill:"mediumslateblue"};}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+b.resourceId});if(c!="-1"&&c!="1"){var d=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{"style":"font-size: 16px; font-weight: bold;"},c]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:d,nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a});}}});ORYX.Plugins.PetriNetStepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);},startAndCheckSyntax:function(){this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!");}.bind(this),onNoErrors:function(){if(this.initializeMarking()){this.firedTransitions=[];this.showEnabledTransition();}else{this.togglePlugin(false);}}.bind(this)});},initializeMarking:function(){var b=function(d,c){if(c==0){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0");}else{if(c==1){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","1");}else{if(c==2){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","2");}else{if(c==3){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","3");}else{if(c==4){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","4");}else{var e=parseInt(c,10);if(e&&e>0){d.setProperty("oryx-numberoftokens_text",""+e);d.setProperty("oryx-numberoftokens_drawing","0");}else{d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0");}}}}}}};this.getPlaces().each(function(c){if("undefined"==typeof(c._setProperty_monkey)){c._setProperty_monkey=c.setProperty;c.setProperty=function(e,d){if("oryx-numberoftokens"==e){b(c,d);}c._setProperty_monkey.apply(c,arguments);};}});var a=0;this.getPlaces().each(function(c){var d=parseInt(c.properties["oryx-numberoftokens"]);if(isNaN(d)){c.setProperty("oryx-numberoftokens",0);}else{if(d>0){a+=d;}}});if(0==a){this.getPlaces().each(function(c){if(c.getIncomingShapes().length==0){c.setProperty("oryx-numberoftokens",1);}});Ext.Msg.show({title:"No Tokens Found",msg:"Current marking of the Petri net doesn't contain any token. Tokens are added to the initial places of the net.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});}if(a>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});}return true;},doMouseUp:function(c,a){if(!(this.isTransition(a))){return;}var b=this.getIncomingNodes(a).all(function(d){return parseInt(d.properties["oryx-numberoftokens"])>0;});if(b){this.fireTransition(a);}this.showEnabledTransition();},onDeactivate:function(){this.hideOverlays();while(this.firedTransitions.length!==0){this.undoLastFiredTransition();}this.facade.getCanvas().update();this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});},fireTransition:function(a){this.firedTransitions.push(a);this.getIncomingNodes(a).each(function(b){this.removeToken(b);}.bind(this));this.getOutgoingNodes(a).each(function(b){this.addToken(b);}.bind(this));},undoLastFiredTransition:function(){var a=this.firedTransitions.pop();if(!a){return;}this.getIncomingNodes(a).each(function(b){this.addToken(b);}.bind(this));this.getOutgoingNodes(a).each(function(b){this.removeToken(b);}.bind(this));},removeToken:function(a){a.setProperty("oryx-numberoftokens",parseInt(a.properties["oryx-numberoftokens"])-1);},addToken:function(a){var b=parseInt(a.properties["oryx-numberoftokens"])+1;a.setProperty("oryx-numberoftokens",b);if(b>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});}},showEnabledTransition:function(){this.hideOverlays();this.firedTransitions.each(function(a){this.showUsed(a,"1");}.bind(this));this.getEnabledTransitions().each(function(a){this.showPlayOnShape(a);}.bind(this));this.facade.getCanvas().update();},getTransitions:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return this.isTransition(a);}.bind(this));},isTransition:function(a){return a instanceof ORYX.Core.Shape&&a.getStencil().id().search(/Transition/)>-1;},getPlaces:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return a.getStencil().id().search(/Place/)>-1;});},getIncomingNodes:function(a){return a.getIncomingShapes().collect(function(b){return b.getIncomingShapes();}).flatten();},getOutgoingNodes:function(a){return a.getOutgoingShapes().collect(function(b){return b.getOutgoingShapes();}).flatten();},getEnabledTransitions:function(){return this.getTransitions().select(function(a){return this.getIncomingNodes(a).all(function(b){return parseInt(b.properties["oryx-numberoftokens"])>0;});}.bind(this));},undo:function(){this.undoLastFiredTransition();this.showEnabledTransition();}});ORYX.Plugins.StepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(a){this.el=undefined;this.callback=undefined;this.executionTrace="";this.rdf=undefined;arguments.callee.$.construct.apply(this,arguments);},prepareInitialMarking:function(){this.startNodes=[];Ext.each(this.facade.getCanvas().getChildShapes(true),function(a){if(this.isStartNode(a)){this.startNodes.push(a);a.initialMarkingFired=false;this.showPlayOnShape(a);if(a.getOutgoingShapes().size()==1){this.showOverlayOnShape(a.getOutgoingShapes()[0],{stroke:"green"});a.getOutgoingShapes()[0].initialMarking=true;}}}.createDelegate(this));},isStartNode:function(a){return(a.getStencil().id().search(/#Event$/)>-1)&&a.getIncomingShapes().length==0&&a.getOutgoingShapes().length==1;},isStartArc:function(a){return this.isStartNode(a.getIncomingShapes()[0]);},isStartArcOrNode:function(a){return this.isStartNode(a)||this.isStartArc(a);},generateRDF:function(){try{var b=this.getRDFFromDOM();b=!b.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+b:b;}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a);}this.rdf=b;},getRDF:function(){if(this.rdf==undefined){this.generateRDF();}return this.rdf;},startAndCheckSyntax:function(){this.postExecutionTrace({checkSyntax:true,onlyChangedObjects:false,onSuccess:function(a){if(a.responseText.startsWith("{")){var b=Ext.decode(a.responseText).syntaxErrors;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,errors:b});}else{this.showObjectStates(a.responseText);}}.bind(this)});},fireObject:function(a){this.executionTrace+=a+";";if(this.isOrSplit(this.el)){this.executionTrace=this.executionTrace.substring(0,this.executionTrace.length-1);this.executionTrace+="#";var c=new Ext.util.MixedCollection();c.addAll(this.el.getOutgoingShapes());var b=[];c.filter("selectedForOrSplit","true").each(function(d){b.push(d.resourceId);}.createDelegate(this));c.each(function(d){d.selectedForOrSplit=false;this.hideOverlayOnShape(d);}.createDelegate(this));this.executionTrace+=b.join(",")+";";}this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:true,onSuccess:function(d){if(d.responseText!=""){this.showObjectStates(d.responseText);}else{this.removeLastFiredObject();}}.bind(this)});},doMouseUp:function(d,a){if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge&&this.isOrSplit(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromOrSplit(a);}else{if(a instanceof ORYX.Core.Edge&&this.getDiagramType()==="epc"&&this.isStartNode(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromStartNode(a);}else{if(this.getDiagramType()==="epc"&&this.isStartNode(a)){a.initialMarkingFired=true;var c=a.getOutgoingShapes()[0];this.hideOverlayOnShape(c);if(c.initialMarking){this.showUsed(a,"1");this.initialMarking.push(a.resourceId);}else{this.hideOverlayOnShape(a);}var b=true;Ext.each(this.startNodes,function(e){if(!e.initialMarkingFired){b=false;}});if(b){this.startAndCheckSyntax();}}else{this.el=a;this.fireObject(this.el.resourceId);}}}}},showObjectStates:function(d){var a=d.split(";");for(i=0;i<a.size();i++){var b=a[i].split(",");if(b.size()<3){continue;}var c=this.facade.getCanvas().getChildShapeByResourceId(b[0]);if(b[2]=="t"){this.showEnabled(c,b[1]);}else{if(b[1]!="0"){this.showUsed(c,b[1]);}else{this.hideOverlayOnShape(c);}}}},doMouseUpOnEdgeComingFromOrSplit:function(b){var a=b.getIncomingShapes()[0];if(b.selectedForOrSplit){this.showOverlayOnShape(b,{stroke:"orange"});var c=new Ext.util.MixedCollection();c.addAll(a.getOutgoingShapes());if(c.filter("selectedForOrSplit","true").length<=1){this.hideOverlayOnShape(a);}}else{this.showOverlayOnShape(b,{stroke:"green"});this.showPlayOnShape(a);}b.selectedForOrSplit=!b.selectedForOrSplit;},doMouseUpOnEdgeComingFromStartNode:function(a){a.initialMarking=!a.initialMarking;if(a.initialMarking){this.showOverlayOnShape(a,{stroke:"green"});}else{this.showOverlayOnShape(a,{stroke:"orange"});}},isOrSplit:function(a){return(a.getStencil().id().search(/#(OR_Gateway|OrConnector)$/)>-1)&&(a.getOutgoingShapes().length>1);},showEnabledOrSplit:function(a){Ext.each(a.getOutgoingShapes(),function(b){Ext.apply(b,{selectedForOrSplit:false});this.showOverlayOnShape(b,{stroke:"orange"});}.createDelegate(this));},removeLastFiredObject:function(){this.executionTrace=this.executionTrace.replace(/[^;]*;$/,"");},undo:function(){if(!this.active()){return;}if(this.executionTrace!==""){this.removeLastFiredObject();this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:false,onSuccess:function(a){this.hideOverlays(true);this.showObjectStates(a.responseText);}.bind(this)});}else{if(this.getDiagramType()==="epc"){this.hideOverlays();this.prepareInitialMarking();}}},postExecutionTrace:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.StepThroughPlugin.executing});new Ajax.Request(ORYX.CONFIG.STEP_THROUGH,{method:"POST",asynchronous:false,parameters:{rdf:this.getRDF(),checkSyntax:a.checkSyntax,fire:this.executionTrace,onlyChangedObjects:a.onlyChangedObjects,initialMarking:this.initialMarking.join(";")},onSuccess:function(b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});a.onSuccess(b);}.createDelegate(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}.createDelegate(this)});}});Ext.namespace("ORYX.Plugins");ORYX.Plugins.AbstractStepThroughPlugin=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({"name":ORYX.I18N.StepThroughPlugin.stepThrough,"functionality":this.load.bind(this),"group":ORYX.I18N.StepThroughPlugin.group,"icon":ORYX.PATH+"images/control_play.png","description":ORYX.I18N.StepThroughPlugin.stepThroughDesc,"index":1,"toggle":true,"minShape":0,"maxShape":0});this.facade.offer({"name":ORYX.I18N.StepThroughPlugin.undo,"functionality":this.undo.bind(this),"group":ORYX.I18N.StepThroughPlugin.group,"icon":ORYX.PATH+"images/control_rewind.png","description":ORYX.I18N.StepThroughPlugin.undoDesc,"index":2,"minShape":0,"maxShape":0});},showEnabled:function(a,b){if(!(a instanceof ORYX.Core.Shape)){return;}else{if(this.isOrSplit(a)){this.showEnabledOrSplit(a);return;}}this.showPlayOnShape(a);},showPlayOnShape:function(b){var a;if(b instanceof ORYX.Core.Edge){a={stroke:"green"};}else{a={fill:"green"};}var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"title":"Click the element to execute it!","stroke-width":2,"stroke":"black","d":"M0,-5 L5,0 L0,5 Z","line-captions":"round"}]);this.showOverlayOnShape(b,a,c);},showOverlayOnShape:function(b,a,c){this.hideOverlayOnShape(b);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:(c?c:null),nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"});},hideOverlayOnShape:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+a.resourceId});},hideOverlays:function(a){var b=this.facade.getCanvas().getChildShapes(true);var c;for(i=0;i<b.size();i++){c=b[i];if(!(a&&this.isStartNode(c))){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+c.resourceId});}}},load:function(a,b){this.initializeLoadButton(a,b);this.togglePlugin(b);},togglePlugin:function(a){if(a){this.initialMarking=[];if(this.getDiagramType()==="epc"){this.prepareInitialMarking();}else{this.startAndCheckSyntax();}}else{this.executionTrace="";this.rdf=undefined;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});this.onDeactivate();}if(this.active()){this.callback=this.doMouseUp.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback);}else{this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback);this.callback=undefined;}},onDeactivate:function(){this.hideOverlays();},initializeLoadButton:function(b,c){if(this.loadButton!==b){var a=function(d){if(d){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);}else{this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);}}.createDelegate(this);b.on("toggle",function(d,e){a(e);});a(b,c);}this.loadButton=b;},active:function(){return this.loadButton?this.loadButton.pressed:false;},onSelectionChanged:function(){if(this.active()&&this.facade.getSelection().length>0){this.facade.setSelection([]);}},getDiagramType:function(){switch(this.facade.getCanvas().getStencil().namespace()){case"http://b3mn.org/stencilset/epc#":return"epc";case"http://b3mn.org/stencilset/bpmn#":return"bpmn";default:return null;}},showUsed:function(b,c){if(!(b instanceof ORYX.Core.Shape)){return;}var a;if(b instanceof ORYX.Core.Edge){a={stroke:"mediumslateblue"};}else{a={fill:"mediumslateblue"};}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+b.resourceId});if(c!="-1"&&c!="1"){var d=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{"style":"font-size: 16px; font-weight: bold;"},c]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:d,nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"});}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a});}}});ORYX.Plugins.PetriNetStepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);},startAndCheckSyntax:function(){this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!");}.bind(this),onNoErrors:function(){if(this.initializeMarking()){this.firedTransitions=[];this.showEnabledTransition();}else{this.togglePlugin(false);}}.bind(this)});},initializeMarking:function(){var b=function(d,c){if(c==0){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0");}else{if(c==1){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","1");}else{if(c==2){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","2");}else{if(c==3){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","3");}else{if(c==4){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","4");}else{var e=parseInt(c,10);if(e&&e>0){d.setProperty("oryx-numberoftokens_text",""+e);d.setProperty("oryx-numberoftokens_drawing","0");}else{d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0");}}}}}}};this.getPlaces().each(function(c){if("undefined"==typeof(c._setProperty_monkey)){c._setProperty_monkey=c.setProperty;c.setProperty=function(e,d){if("oryx-numberoftokens"==e){b(c,d);}c._setProperty_monkey.apply(c,arguments);};}});var a=0;this.getPlaces().each(function(c){var d=parseInt(c.properties["oryx-numberoftokens"]);if(isNaN(d)){c.setProperty("oryx-numberoftokens",0);}else{if(d>0){a+=d;}}});if(0==a){this.getPlaces().each(function(c){if(c.getIncomingShapes().length==0){c.setProperty("oryx-numberoftokens",1);}});Ext.Msg.show({title:"No Tokens Found",msg:"Current marking of the Petri net doesn't contain any token. Tokens are added to the initial places of the net.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO});}if(a>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});}return true;},doMouseUp:function(c,a){if(!(this.isTransition(a))){return;}var b=this.getIncomingNodes(a).all(function(d){return parseInt(d.properties["oryx-numberoftokens"])>0;});if(b){this.fireTransition(a);}this.showEnabledTransition();},onDeactivate:function(){this.hideOverlays();while(this.firedTransitions.length!==0){this.undoLastFiredTransition();}this.facade.getCanvas().update();this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});},fireTransition:function(a){this.firedTransitions.push(a);this.getIncomingNodes(a).each(function(b){this.removeToken(b);}.bind(this));this.getOutgoingNodes(a).each(function(b){this.addToken(b);}.bind(this));},undoLastFiredTransition:function(){var a=this.firedTransitions.pop();if(!a){return;}this.getIncomingNodes(a).each(function(b){this.addToken(b);}.bind(this));this.getOutgoingNodes(a).each(function(b){this.removeToken(b);}.bind(this));},removeToken:function(a){a.setProperty("oryx-numberoftokens",parseInt(a.properties["oryx-numberoftokens"])-1);},addToken:function(a){var b=parseInt(a.properties["oryx-numberoftokens"])+1;a.setProperty("oryx-numberoftokens",b);if(b>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});}},showEnabledTransition:function(){this.hideOverlays();this.firedTransitions.each(function(a){this.showUsed(a,"1");}.bind(this));this.getEnabledTransitions().each(function(a){this.showPlayOnShape(a);}.bind(this));this.facade.getCanvas().update();},getTransitions:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return this.isTransition(a);}.bind(this));},isTransition:function(a){return a instanceof ORYX.Core.Shape&&a.getStencil().id().search(/Transition/)>-1;},getPlaces:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return a.getStencil().id().search(/Place/)>-1;});},getIncomingNodes:function(a){return a.getIncomingShapes().collect(function(b){return b.getIncomingShapes();}).flatten();},getOutgoingNodes:function(a){return a.getOutgoingShapes().collect(function(b){return b.getOutgoingShapes();}).flatten();},getEnabledTransitions:function(){return this.getTransitions().select(function(a){return this.getIncomingNodes(a).all(function(b){return parseInt(b.properties["oryx-numberoftokens"])>0;});}.bind(this));},undo:function(){this.undoLastFiredTransition();this.showEnabledTransition();}});ORYX.Plugins.StepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(a){this.el=undefined;this.callback=undefined;this.executionTrace="";this.rdf=undefined;arguments.callee.$.construct.apply(this,arguments);},prepareInitialMarking:function(){this.startNodes=[];Ext.each(this.facade.getCanvas().getChildShapes(true),function(a){if(this.isStartNode(a)){this.startNodes.push(a);a.initialMarkingFired=false;this.showPlayOnShape(a);if(a.getOutgoingShapes().size()==1){this.showOverlayOnShape(a.getOutgoingShapes()[0],{stroke:"green"});a.getOutgoingShapes()[0].initialMarking=true;}}}.createDelegate(this));},isStartNode:function(a){return(a.getStencil().id().search(/#Event$/)>-1)&&a.getIncomingShapes().length==0&&a.getOutgoingShapes().length==1;},isStartArc:function(a){return this.isStartNode(a.getIncomingShapes()[0]);},isStartArcOrNode:function(a){return this.isStartNode(a)||this.isStartArc(a);},generateRDF:function(){try{var b=this.getRDFFromDOM();b=!b.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+b:b;}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a);}this.rdf=b;},getRDF:function(){if(this.rdf==undefined){this.generateRDF();}return this.rdf;},startAndCheckSyntax:function(){this.postExecutionTrace({checkSyntax:true,onlyChangedObjects:false,onSuccess:function(a){if(a.responseText.startsWith("{")){var b=Ext.decode(a.responseText).syntaxErrors;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,errors:b});}else{this.showObjectStates(a.responseText);}}.bind(this)});},fireObject:function(a){this.executionTrace+=a+";";if(this.isOrSplit(this.el)){this.executionTrace=this.executionTrace.substring(0,this.executionTrace.length-1);this.executionTrace+="#";var c=new Ext.util.MixedCollection();c.addAll(this.el.getOutgoingShapes());var b=[];c.filter("selectedForOrSplit","true").each(function(d){b.push(d.resourceId);}.createDelegate(this));c.each(function(d){d.selectedForOrSplit=false;this.hideOverlayOnShape(d);}.createDelegate(this));this.executionTrace+=b.join(",")+";";}this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:true,onSuccess:function(d){if(d.responseText!=""){this.showObjectStates(d.responseText);}else{this.removeLastFiredObject();}}.bind(this)});},doMouseUp:function(d,a){if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge&&this.isOrSplit(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromOrSplit(a);}else{if(a instanceof ORYX.Core.Edge&&this.getDiagramType()==="epc"&&this.isStartNode(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromStartNode(a);}else{if(this.getDiagramType()==="epc"&&this.isStartNode(a)){a.initialMarkingFired=true;var c=a.getOutgoingShapes()[0];this.hideOverlayOnShape(c);if(c.initialMarking){this.showUsed(a,"1");this.initialMarking.push(a.resourceId);}else{this.hideOverlayOnShape(a);}var b=true;Ext.each(this.startNodes,function(e){if(!e.initialMarkingFired){b=false;}});if(b){this.startAndCheckSyntax();}}else{this.el=a;this.fireObject(this.el.resourceId);}}}}},showObjectStates:function(d){var a=d.split(";");for(i=0;i<a.size();i++){var b=a[i].split(",");if(b.size()<3){continue;}var c=this.facade.getCanvas().getChildShapeByResourceId(b[0]);if(b[2]=="t"){this.showEnabled(c,b[1]);}else{if(b[1]!="0"){this.showUsed(c,b[1]);}else{this.hideOverlayOnShape(c);}}}},doMouseUpOnEdgeComingFromOrSplit:function(b){var a=b.getIncomingShapes()[0];if(b.selectedForOrSplit){this.showOverlayOnShape(b,{stroke:"orange"});var c=new Ext.util.MixedCollection();c.addAll(a.getOutgoingShapes());if(c.filter("selectedForOrSplit","true").length<=1){this.hideOverlayOnShape(a);}}else{this.showOverlayOnShape(b,{stroke:"green"});this.showPlayOnShape(a);}b.selectedForOrSplit=!b.selectedForOrSplit;},doMouseUpOnEdgeComingFromStartNode:function(a){a.initialMarking=!a.initialMarking;if(a.initialMarking){this.showOverlayOnShape(a,{stroke:"green"});}else{this.showOverlayOnShape(a,{stroke:"orange"});}},isOrSplit:function(a){return(a.getStencil().id().search(/#(OR_Gateway|OrConnector)$/)>-1)&&(a.getOutgoingShapes().length>1);},showEnabledOrSplit:function(a){Ext.each(a.getOutgoingShapes(),function(b){Ext.apply(b,{selectedForOrSplit:false});this.showOverlayOnShape(b,{stroke:"orange"});}.createDelegate(this));},removeLastFiredObject:function(){this.executionTrace=this.executionTrace.replace(/[^;]*;$/,"");},undo:function(){if(!this.active()){return;}if(this.executionTrace!==""){this.removeLastFiredObject();this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:false,onSuccess:function(a){this.hideOverlays(true);this.showObjectStates(a.responseText);}.bind(this)});}else{if(this.getDiagramType()==="epc"){this.hideOverlays();this.prepareInitialMarking();}}},postExecutionTrace:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.StepThroughPlugin.executing});new Ajax.Request(ORYX.CONFIG.STEP_THROUGH,{method:"POST",asynchronous:false,parameters:{rdf:this.getRDF(),checkSyntax:a.checkSyntax,fire:this.executionTrace,onlyChangedObjects:a.onlyChangedObjects,initialMarking:this.initialMarking.join(";")},onSuccess:function(b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});a.onSuccess(b);}.createDelegate(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}.createDelegate(this)});}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.EPCSupport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.EPCSupport.exp,"functionality":this.exportEPC.bind(this),"group":ORYX.I18N.EPCSupport.group,"icon":ORYX.PATH+"images/epml_export_icon.png","description":ORYX.I18N.EPCSupport.expDesc,"index":1,"minShape":0,"maxShape":0});this.facade.offer({"name":ORYX.I18N.EPCSupport.imp,"functionality":this.importEPC.bind(this),"group":ORYX.I18N.EPCSupport.group,"icon":ORYX.PATH+"images/epml_import_icon.png","description":ORYX.I18N.EPCSupport.impDesc,"index":2,"minShape":0,"maxShape":0});},importEPC:function(){this.openUploadDialog();},exportEPC:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.EPCSupport.progressExp});var b=new XMLSerializer();var g="Oryx-EPC";var d=DataManager.serializeDOM(this.facade);d='<?xml version="1.0" encoding="utf-8"?>'+'<html xmlns="http://www.w3.org/1999/xhtml" '+'xmlns:b3mn="http://b3mn.org/2007/b3mn" '+'xmlns:ext="http://b3mn.org/2007/ext" '+'xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" '+'xmlns:atom="http://b3mn.org/2007/atom+xhtml">'+'<head profile="http://purl.org/NET/erdf/profile">'+'<link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" />'+'<link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " />'+'<link rel="schema.b3mn" href="http://b3mn.org" />'+'<link rel="schema.oryx" href="http://oryx-editor.org/" />'+'<link rel="schema.raziel" href="http://raziel.org/" />'+'<base href="'+location.href.split("?")[0]+'" />'+"</head><body>"+d+'<div id="generatedProcessInfos"><span class="oryx-id">'+g+"</span>"+'<span class="oryx-name">'+g+"</span></div>"+"</body></html>";var h=ORYX.PATH+"/lib/extract-rdf.xsl";var f;rdfResult=this.transformString(d,h,true);if(rdfResult instanceof String){f=rdfResult;rdfResult=null;}else{f=b.serializeToString(rdfResult);if(!f.startsWith("<?xml")){f='<?xml version="1.0" encoding="UTF-8"?>'+f;}}var c=ORYX.PATH+"/xslt/RDF2EPML.xslt";var e=this.transformDOM(rdfResult,c,true);var a;if(e instanceof String){a=e;e=null;}else{a=b.serializeToString(e);if(!a.startsWith("<?xml")){a='<?xml version="1.0" encoding="UTF-8"?>'+a;}}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});this.openDownloadWindow(g+".epml",a);},transformString:function(d,b,c){var e=new DOMParser();var a=e.parseFromString(d,"text/xml");return this.transformDOM(a,b,c);},transformDOM:function(k,a,d){if(k==null){return new String("Parse Error: \nThe given dom content is null.");}var b="";source=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(m){b=m.responseText;}.bind(this),onFailure:(function(m){ORYX.Log.error("XSL load failed"+m);}).bind(this)});var l;var g;var e=new XSLTProcessor();var h=new DOMParser();var c=h.parseFromString(b,"text/xml");e.importStylesheet(c);try{l=e.transformToFragment(k,document);}catch(f){return new String("Parse Error: "+f.name+"\n"+f.message);}if(d){return l;}g=(new XMLSerializer()).serializeToString(l);return g;},openUploadDialog:function(){var b=new Ext.form.FormPanel({frame:true,bodyStyle:"padding:5px;",defaultType:"textfield",labelAlign:"left",buttonAlign:"right",fileUpload:true,enctype:"multipart/form-data",items:[{text:ORYX.I18N.EPCSupport.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",xtype:"label"},{fieldLabel:ORYX.I18N.EPCSupport.file,inputType:"file",labelStyle:"width:50px;",itemCls:"ext_specific_window_overflow"}]});var a=new Ext.Window({autoCreate:true,title:ORYX.I18N.EPCSupport.impPanel,height:"auto",width:"auto",modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,resizable:false,items:[b],buttons:[{text:ORYX.I18N.EPCSupport.impBtn,handler:function(){var c=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.EPCSupport.progressImp});c.show();b.form.submit({url:ORYX.PATH+"/epc-upload",success:function(e,d){a.hide();var g=d.result;g=g.startsWith("<?xml")?g:'<?xml version="1.0" encoding="utf-8"?><div>'+g+"</div>";this.loadContent(g);c.hide();}.bind(this),failure:function(e,d){a.hide();c.hide();Ext.MessageBox.show({title:ORYX.I18N.EPCSupport.error,msg:d.response.responseText.substring(d.response.responseText.indexOf("content:'")+9,d.response.responseText.indexOf("'}")),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}});}.bind(this)},{text:ORYX.I18N.EPCSupport.close,handler:function(){a.hide();}.bind(this)}]});a.on("hide",function(){a.destroy(true);delete a;});a.show();},createHiddenElement:function(a,b){var c=document.createElement("input");c.name=a;c.type="hidden";c.value=b;return c;},getFileName:function(b){var a=b.length;if(a>5){if(b.substr(a-5,5)=="(AML)"){return b.substr(0,a-6);}}return b;},loadContent:function(a){var c=new DOMParser();var b=c.parseFromString(a,"text/xml");this.facade.importERDF(b);}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.XFormsExport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.XFormsSerialization.exportXForms,"functionality":this.exportXForms.bind(this),"group":ORYX.I18N.XFormsSerialization.group,"icon":ORYX.PATH+"images/xforms_export.png","description":ORYX.I18N.XFormsSerialization.exportXFormsDesc,"index":2,"minShape":0,"maxShape":0});},exportXForms:function(){this._showCssDialog();},exportIt:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously(a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}).bind(this),10);return true;},exportSynchronously:function(b){var d=location.href;try{var c=this.getRDFFromDOM();c=c.startsWith("<?xml")?c:'<?xml version="1.0" encoding="UTF-8"?>'+c;new Ajax.Request(ORYX.CONFIG.XFORMS_EXPORT_URL,{method:"POST",asynchronous:false,parameters:{resource:d,data:c,css:b},onSuccess:function(e){var f=window.open("data:text/xml,"+e.responseText,"_blank","resizable=yes,width=640,height=480,toolbar=0,scrollbars=yes");}});}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a);}},checkClientXFormsSupport:function(){if(!clientSupportsXForms){var a=ORYX.I18N.XFormsSerialization.noClientXFormsSupportDesc;var b=new Ext.Window({width:320,height:240,resizable:false,minimizable:false,modal:true,autoScroll:true,title:ORYX.I18N.XFormsSerialization.noClientXFormsSupport,html:a,buttons:[{text:ORYX.I18N.XFormsSerialization.ok,handler:function(){b.hide();}}]});b.show();}},_showCssDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.XFormsSerialization.selectCss,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -30"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.XFormsSerialization.expTitle,height:150,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.XFormsSerialization.ok,handler:function(){this.exportIt(c.items.items[1].getValue());b.hide();}.bind(this)},{text:ORYX.I18N.XFormsSerialization.close,handler:function(){b.hide();}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b;});b.show();}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.XFormsImport=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":ORYX.I18N.XFormsSerialization.importXForms,"functionality":this.importXForms.bind(this),"group":ORYX.I18N.XFormsSerialization.group,"icon":ORYX.PATH+"images/xforms_import.png","description":ORYX.I18N.XFormsSerialization.importXFormsDesc,"index":3,"minShape":0,"maxShape":0});},importXForms:function(){this._showImportDialog();},sendRequest:function(b,d,e,a){var c=false;new Ajax.Request(b,{method:"POST",asynchronous:false,parameters:d,onSuccess:function(f){c=true;if(e){e(f);}}.bind(this),onFailure:function(f){if(a){a();}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.XFormsSerialization.impFailed);ORYX.log.warn("Import XForms failed: "+transport.responseText);}}.bind(this)});return c;},throwWarning:function(a){Ext.MessageBox.show({title:ORYX.I18N.Oryx.title,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});},_showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.XFormsSerialization.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.XFormsSerialization.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.XFormsSerialization.impTitle,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.XFormsSerialization.impButton,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.XFormsSerialization.impProgress});d.show();window.setTimeout(function(){var f=c.items.items[2].getValue();var e={resource:location.href,data:f};this.sendRequest(ORYX.CONFIG.XFORMS_IMPORT_URL,e,function(g){this.facade.importJSON(g.responseText);d.hide();b.hide();}.bind(this));}.bind(this),100);}.bind(this)},{text:ORYX.I18N.XFormsSerialization.close,handler:function(){b.hide();}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b;});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsBinary();c.items.items[2].setValue(e);},true);}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.RowLayouting={construct:function(a){this.facade=a;this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined;this.offSetPosition={x:0,y:0};this.evCoord={x:0,y:0};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT_ROWS,this.handleLayoutRows.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));},onSelectionChanged:function(a){var c=a.elements;if(!c||c.length==0){this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined;}else{this.currentShapes=c;this.toMoveShapes=this.facade.getCanvas().getShapesWithSharedParent(c);this.toMoveShapes=this.toMoveShapes.findAll(function(d){return d instanceof ORYX.Core.Node&&(d.dockers.length===0||!c.member(d.dockers.first().getDockedShape()));});var b=undefined;c.each(function(d){if(!b){b=d.absoluteBounds();}else{b.include(d.absoluteBounds());}});this.dragBounds=b;}return;},handleMouseDown:function(c,b){if(!this.dragBounds||!this.toMoveShapes.member(b)){return;}var d=this.facade.eventCoordinates(c);var a=this.dragBounds.upperLeft();this.offSetPosition={x:d.x-a.x,y:d.y-a.y};return;},handleLayoutRows:function(p){var b=p.shape;var k=this.offSetPosition;var o=p.marginLeft;var d=p.marginTop;var r=p.spacingX;var q=p.spacingY;var l=p.shape.getChildShapes(false);var n=this.toMoveShapes;n.each(function(u){if(l.include(u)){u.bounds.moveBy(k);}});if(p.exclude){l=l.filter(function(u){return !p.exclude.some(function(v){return u.getStencil().id()==v;});});}var c=d;var s=d-q;if(p.horizontalLayout){l.each(function(v){var u=v.bounds.upperLeft();v.bounds.moveTo(u.x,c);});}else{if(p.verticalLayout){l.each(function(v){var u=v.bounds.upperLeft();v.bounds.moveTo(o,u.y);});}}l=l.sortBy(function(u){return u.bounds.upperLeft().y;});var e=0;var f=0;var m=false;l.each(function(z){var y=z.bounds.upperLeft();var u=z.bounds.lowerRight();var x=y.x;var v=y.y;var B=u.x;var A=u.y;if(n.include(z)){y.y-=f;if((y.y>s)||((z==l.first())&&y.y<d)){m=false;c=s+q;if(y.y<c){m=true;}}}else{y.y+=e;y.y-=f;if(y.y>c){m=false;c=s+q;}}y.y=c;u.y=y.y+z.bounds.height();if(u.y>s){if(m){e+=u.y-s;}else{if(n.include(z)){e+=u.y-s;}}s=u.y;}if((y.x!=x)||(y.y!=v)||(u.x!=B)||(u.y!=A)){if(!n.include(z)){if((v-y.y)>f){f=v-y.y;}}z.bounds.set(y.x,y.y,u.x,u.y);}});l=l.sortBy(function(u){return u.bounds.upperLeft().y*10000+u.bounds.upperLeft().x;});c=d;var a=o-r;var t=a;var h=0;l.each(function(z){var y=z.bounds.upperLeft();var u=z.bounds.lowerRight();var x=y.x;var v=y.y;var B=u.x;var A=u.y;if(y.y>c){c=y.y;a=o-r;}y.x=a+r;u.x=y.x+z.bounds.width();a=u.x;if(a>t){t=a;}if(u.y>h){h=u.y;}if((y.x!=x)||(y.y!=v)||(u.x!=B)||(u.y!=A)){z.bounds.set(y.x,y.y,u.x,u.y);}});if(p.shape!=this.facade.getCanvas()){var g=p.shape.bounds.upperLeft();if(t>o){p.shape.bounds.set(g.x,g.y,g.x+t+o,g.y+s+d);}}else{if(t>this.facade.getCanvas().bounds.width()){this.facade.getCanvas().setSize({width:(t+o),height:this.facade.getCanvas().bounds.height()});}if(h>this.facade.getCanvas().bounds.height()){this.facade.getCanvas().setSize({width:this.facade.getCanvas().bounds.width(),height:(s+d)});}}return;}};ORYX.Plugins.RowLayouting=Clazz.extend(ORYX.Plugins.RowLayouting);if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.XForms={construct:function(a){this.facade=a;this.facade.registerOnEvent("layout.xforms.label",this.handleLayoutLabel.bind(this));this.facade.registerOnEvent("layout.xforms.label.button",this.handleLayoutLabelButton.bind(this));this.facade.registerOnEvent("layout.xforms.label.item",this.handleLayoutLabelItem.bind(this));this.facade.registerOnEvent("layout.xforms.item",this.handleLayoutItem.bind(this));this.facade.registerOnEvent("layout.xforms.case",this.handleLayoutCase.bind(this));this.facade.registerOnEvent("layout.xforms.action",this.handleLayoutAction.bind(this));},handleLayoutLabel:function(d){var a=d.shape;var c=d.moveX;var b=d.moveY;var e=a.getChildNodes(false).findAll(function(f){return(f.getStencil().id()==="http://b3mn.org/stencilset/xforms#Label");});if(e.length>0){e.each(function(g){var h=g.bounds.upperLeft();var f=g.bounds.lowerRight();h.y=-g.bounds.height()+b;f.y=b;h.x=c;f.x=g.bounds.width()+c;g.bounds.set(h,f);});}},handleLayoutLabelButton:function(b){var a=b.shape;var c=a.getChildNodes(false).findAll(function(d){return(d.getStencil().id()==="http://b3mn.org/stencilset/xforms#Label");});if(c.length>0){c.each(function(e){var g=e.bounds.upperLeft();var d=e.bounds.lowerRight();g.y=2;d.y=2+e.bounds.height();if((a.bounds.width()-4)<e.bounds.width()){var h=a.bounds.upperLeft();var f=a.bounds.lowerRight();f.x=h.x+e.bounds.width()+4;a.bounds.set(h,f);}g.x=(a.bounds.width()-4-e.bounds.width())*0.5;d.x=g.x+e.bounds.width();e.bounds.set(g,d);});}},handleLayoutItem:function(e){var b=e.shape;var a=b.getChildNodes(false).findAll(function(h){return((h.getStencil().id()==="http://b3mn.org/stencilset/xforms#Item")||(h.getStencil().id()==="http://b3mn.org/stencilset/xforms#Choices")||(h.getStencil().id()==="http://b3mn.org/stencilset/xforms#Itemset"));});if(a.length>0){a=a.sortBy(function(h){return h.bounds.upperLeft().y;});var d=b.bounds.width();var c=0;a.each(function(l){var k=l.bounds.upperLeft();var h=l.bounds.lowerRight();if(l.getStencil().id()==="http://b3mn.org/stencilset/xforms#Choices"){k.y=c+25;c+=25;}else{k.y=c+5;c+=5;}h.y=k.y+l.bounds.height();c+=l.bounds.height();k.x=30;h.x=d;l.bounds.set(k,h);});var g=b.bounds.upperLeft();b.bounds.set(g.x,g.y,b.bounds.lowerRight().x,g.y+c+5);}var f=b.getChildNodes(false).findAll(function(h){return(h.getStencil().id()==="http://b3mn.org/stencilset/xforms#Label");});if(f.length>0){f.each(function(k){var l=k.bounds.upperLeft();var h=k.bounds.lowerRight();l.y=-k.bounds.height()-1;h.y=-1;l.x=0;h.x=k.bounds.width();k.bounds.set(l,h);});}},handleLayoutCase:function(e){var a=e.shape;var d=a.getChildNodes(false);var c=0;d.each(function(g){if(g.bounds.width()>c){c=g.bounds.width();}});if(d.length>0){d=d.sortBy(function(g){return g.bounds.upperLeft().y;});var b=5;d.each(function(k){var h=k.bounds.upperLeft();var g=k.bounds.lowerRight();h.y=b;g.y=h.y+k.bounds.height();b+=k.bounds.height()+5;h.x=0;g.x=c;k.bounds.set(h,g);});var f=a.bounds.upperLeft();a.bounds.set(f.x,f.y,f.x+c,f.y+b+20);}},handleLayoutLabelItem:function(b){var a=b.shape;var c=a.getChildNodes(false).findAll(function(d){return(d.getStencil().id()==="http://b3mn.org/stencilset/xforms#Label");});if(c.length>0){c.each(function(e){var f=e.bounds.upperLeft();var d=e.bounds.lowerRight();f.y=2;f.x=2;d.y=2+e.bounds.height();d.x=2+e.bounds.width();e.bounds.set(f,d);});}},handleLayoutAction:function(d){var a=d.shape;var e=a.getChildNodes(false);if(e.length>0){e=e.sortBy(function(g){return g.bounds.upperLeft().y;});var c=5;e.each(function(k){var h=k.bounds.upperLeft();var g=k.bounds.lowerRight();h.y=c;g.y=h.y+k.bounds.height();c+=k.bounds.height()+5;h.x=2;g.x=2+k.bounds.width();k.bounds.set(h,g);});var f=a.bounds.upperLeft();var b=a.bounds.lowerRight();a.bounds.set(f.x,f.y,b.x,f.y+c+15);}}};ORYX.Plugins.XForms=Clazz.extend(ORYX.Plugins.XForms);if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.XFormsExportOrbeon=ORYX.Plugins.AbstractPlugin.extend({CSS_URL:"/oryx/css/xforms_default.css",facade:undefined,construct:function(a){this.facade=a;this.facade.offer({"name":"Run XForm with Orbeon","functionality":this.exportIt.bind(this),"group":ORYX.I18N.XFormsSerialization.group,"icon":ORYX.PATH+"images/xforms_orbeon_export.png","description":"XForms export for Orbeon","index":1,"minShape":0,"maxShape":0});},exportIt:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});}).bind(this),10);return true;},exportSynchronously:function(){var c=location.href;try{var b=this.getRDFFromDOM();b=b.startsWith("<?xml")?b:'<?xml version="1.0" encoding="UTF-8"?>'+b;new Ajax.Request(ORYX.CONFIG.XFORMS_EXPORT_ORBEON_URL,{method:"POST",asynchronous:false,parameters:{resource:c,data:b,css:this.CSS_URL},onSuccess:function(d){var e=window.open("");e.document.write(d.responseText);},onFailure:function(d){var e=window.open("");e.document.write(d.responseText);}});}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a);}},checkClientXFormsSupport:function(){if(!clientSupportsXForms){var a=ORYX.I18N.XFormsSerialization.noClientXFormsSupportDesc;var b=new Ext.Window({width:320,height:240,resizable:false,minimizable:false,modal:true,autoScroll:true,title:ORYX.I18N.XFormsSerialization.noClientXFormsSupport,html:a,buttons:[{text:ORYX.I18N.XFormsSerialization.ok,handler:function(){b.hide();}}]});b.show();}}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.CpnSupport=Clazz.extend({construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_END,this.resetTokenPosition.bind(this));},resetTokenPosition:function(){var a=this.facade.getSelection().findAll(function(b){return(b.getStencil().id()==="http://b3mn.org/stencilset/coloredpetrinet#Place");});if(a.length>0){a.each(function(g){var e=g.absoluteBounds();var f=e.center();var b=f.y-e.upperLeft().y;var d=f.x-e.upperLeft().x;var k=Math.min(b,d);var l=k/2;var o=g.getChildNodes(false).findAll(function(c){return(c.getStencil().id()==="http://b3mn.org/stencilset/coloredpetrinet#Token");});if(o.length>0){var h=0;var n=0;var m=0;o.each(function(r){var t=r.absoluteBounds();var q=t.center();var p=f.x-q.x;var c=f.y-q.y;var s=p*p+c*c;if(k*k<=s){m=Math.round(Math.sin((Math.PI/6)*h)*l);n=Math.round(Math.cos((Math.PI/6)*h)*l);r.bounds.centerMoveTo(g.bounds.width()/2+n,g.bounds.height()/2+m);r.update();h=h+1;}});}});}this.facade.getCanvas().update();}});if(!ORYX.Plugins){ORYX.Plugins=new Object();}ORYX.Plugins.CPNToolsSupport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,stencilSetNamespace:"http://b3mn.org/stencilset/coloredpetrinet#",construct:function(a){this.facade=a;this.facade.offer({"name":"Export to CPN Tools","functionality":this.exportCPN.bind(this),"group":ORYX.I18N.cpntoolsSupport.group,"dropDownGroupIcon":ORYX.PATH+"images/export2.png","icon":ORYX.PATH+"images/cpn/cpn_export.png","description":ORYX.I18N.cpntoolsSupport.exportDescription,"index":0,"minShape":0,"maxShape":0,"maxShape":0});this.facade.offer({"name":"Import from CPN Tools","functionality":this.importCPN.bind(this),"group":ORYX.I18N.cpntoolsSupport.group,"dropDownGroupIcon":ORYX.PATH+"images/import.png","icon":ORYX.PATH+"images/cpn/cpn_import.png","description":ORYX.I18N.cpntoolsSupport.importDescription,"index":1,"minShape":0,"maxShape":0});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_END,this.resetTokenPosition.bind(this));},importCPN:function(){this._showImportDialog();},exportCPN:function(){var a=this.facade.getSerializedJSON();this._doExportToCPNTools(a);},resetTokenPosition:function(){var a=this.facade.getSelection().findAll(function(b){return(b.getStencil().id()==="http://b3mn.org/stencilset/coloredpetrinet#Place");});if(a.length>0){a.each(function(g){var e=g.absoluteBounds();var f=e.center();var b=f.y-e.upperLeft().y;var d=f.x-e.upperLeft().x;var k=Math.min(b,d);var l=k/2;var o=g.getChildNodes(false).findAll(function(c){return(c.getStencil().id()==="http://b3mn.org/stencilset/coloredpetrinet#Token");});if(o.length>0){var h=0;var n=0;var m=0;o.each(function(r){var t=r.absoluteBounds();var q=t.center();var p=f.x-q.x;var c=f.y-q.y;var s=p*p+c*c;if(k*k<=s){m=Math.round(Math.sin((Math.PI/6)*h)*l);n=Math.round(Math.cos((Math.PI/6)*h)*l);r.bounds.centerMoveTo(g.bounds.width()/2+n,g.bounds.height()/2+m);r.update();h=h+1;}});}});}this.facade.getCanvas().update();},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText);}}.bind(this),onFailure:function(g){if(a){a();}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.cpntoolsSupport.serverConnectionFailed);ORYX.log.warn("Communication failed: "+g.responseText);}}.bind(this)});return c;},_doExportToCPNTools:function(a){this._sendRequest(ORYX.CONFIG.CPNTOOLSEXPORTER,"POST",{data:a},function(b){if(b.startsWith("error:")){this._showErrorMessageBox(ORYX.I18N.Oryx.title,b);}else{this.openDownloadWindow(window.document.title+".cpn",b);}}.bind(this),function(){this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.cpntoolsSupport.serverConnectionFailed);}.bind(this));},_showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.cpntoolsSupport.importTask,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.cpntoolsSupport.File,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.cpntoolsSupport.cpn,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.cpntoolsSupport.importLable,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.jPDLSupport.impProgress});d.show();window.setTimeout(function(){var e=c.items.items[2].getValue();this._getAllPages(e,d);}.bind(this),100);b.hide();}.bind(this)},{text:ORYX.I18N.cpntoolsSupport.close,handler:function(){b.hide();}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b;});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsText("UTF-8");c.items.items[2].setValue(e);},true);},_getAllPages:function(c,e){var h=new DOMParser();var g=h.parseFromString(c,"text/xml");var b=g.getElementsByTagName("page");if(b.length==0){e.hide();this._showErrorMessageBox(ORYX.I18N.cpntoolsSupport.title,ORYX.I18N.cpntoolsSupport.wrongCPNFile);return;}if(b.length==1){pageAttr=b[0].children[0];a=pageAttr.attributes[0].nodeValue;this._sendRequest(ORYX.CONFIG.CPNTOOLSIMPORTER,"POST",{"pagesToImport":a,"data":c},function(k){if(k.startsWith("error:")){this._showErrorMessageBox(ORYX.I18N.Oryx.title,k);e.hide();}else{this.facade.importJSON(k);e.hide();}}.bind(this),function(){e.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.cpntoolsSupport.serverConnectionFailed);}.bind(this));return;}var d,a,f=[];for(d=0;d<b.length;d++){pageAttr=b[d].children[0];a=pageAttr.attributes[0].nodeValue;f.push([a]);}e.hide();this.showPageDialog(f,c);},_showErrorMessageBox:function(b,a){Ext.MessageBox.show({title:b,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});},showPageDialog:function(f,c){var a=new Ext.data.ArrayReader({},[{name:"name"}]);var g=new Ext.grid.CheckboxSelectionModel({singleSelect:true});var d=new Ext.grid.GridPanel({store:new Ext.data.Store({reader:a,data:f}),cm:new Ext.grid.ColumnModel([{id:"name",width:200,sortable:true,dataIndex:"name"},g]),sm:g,frame:true,hideHeaders:true,iconCls:"icon-grid",listeners:{render:function(){var h=[];this.grid.getStore().each(function(k){if(k.data.engaged){h.push(k);}}.bind(this));this.suspendEvents();this.selectRecords(h);this.resumeEvents();}.bind(g)}});var b=new Ext.Panel({items:[{xtype:"label",text:"CPNTools Page",style:"margin:10px;display:block"},d],frame:true});var e=new Ext.Window({id:"oryx_new_page_selection",autoWidth:true,title:ORYX.I18N.cpntoolsSupport.title,floating:true,shim:true,modal:true,resizable:true,autoHeight:true,items:[b],buttons:[{text:ORYX.I18N.cpntoolsSupport.importLable,handler:function(){var h="";g.getSelections().each(function(m){h=m.data.name;}.bind(this));var l=h.length;if(h.length==0){alert(ORYX.I18N.cpntoolsSupport.noPageSelection);return;}var k=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.cpntoolsSupport.importProgress});k.show();e.hide();pageName=h;this._sendRequest(ORYX.CONFIG.CPNTOOLSIMPORTER,"POST",{"pagesToImport":pageName,"data":c},function(m){if(m.startsWith("error:")){this._showErrorMessageBox(ORYX.I18N.Oryx.title,m);k.hide();}else{this.facade.importJSON(m);k.hide();}}.bind(this),function(){k.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.cpntoolsSupport.serverConnectionFailed);}.bind(this));}.bind(this)},{text:ORYX.I18N.cpntoolsSupport.close,handler:function(){e.hide();}.bind(this)}]});e.show();}});